<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1、ClickHouse概述 | 个人博客 | JiiiiG</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="自是年少，韶华倾负">
    
    <link rel="preload" href="/assets/css/0.styles.420b7c1f.css" as="style"><link rel="preload" href="/assets/js/app.fdd7a502.js" as="script"><link rel="preload" href="/assets/js/16.375b747e.js" as="script"><link rel="preload" href="/assets/js/33.c489bc81.js" as="script"><link rel="prefetch" href="/assets/js/10.bbd38b9e.js"><link rel="prefetch" href="/assets/js/11.f49fc7d3.js"><link rel="prefetch" href="/assets/js/12.c5d97aa1.js"><link rel="prefetch" href="/assets/js/13.426d0224.js"><link rel="prefetch" href="/assets/js/14.1f257a58.js"><link rel="prefetch" href="/assets/js/15.be29bb6a.js"><link rel="prefetch" href="/assets/js/17.d02cdd8b.js"><link rel="prefetch" href="/assets/js/18.5d2371a4.js"><link rel="prefetch" href="/assets/js/19.038919a3.js"><link rel="prefetch" href="/assets/js/2.d6257727.js"><link rel="prefetch" href="/assets/js/20.b3582e09.js"><link rel="prefetch" href="/assets/js/21.0c1e826b.js"><link rel="prefetch" href="/assets/js/22.91bff1a5.js"><link rel="prefetch" href="/assets/js/23.faacea60.js"><link rel="prefetch" href="/assets/js/24.69816497.js"><link rel="prefetch" href="/assets/js/25.c9fcaa62.js"><link rel="prefetch" href="/assets/js/26.d28c3abe.js"><link rel="prefetch" href="/assets/js/27.1518da7d.js"><link rel="prefetch" href="/assets/js/28.748a5581.js"><link rel="prefetch" href="/assets/js/29.775019f1.js"><link rel="prefetch" href="/assets/js/3.141002a4.js"><link rel="prefetch" href="/assets/js/30.74e7c570.js"><link rel="prefetch" href="/assets/js/31.190b11f2.js"><link rel="prefetch" href="/assets/js/32.d8f4f116.js"><link rel="prefetch" href="/assets/js/34.db609d51.js"><link rel="prefetch" href="/assets/js/35.ad3402e6.js"><link rel="prefetch" href="/assets/js/36.45f11923.js"><link rel="prefetch" href="/assets/js/37.b47e0576.js"><link rel="prefetch" href="/assets/js/38.58b934a2.js"><link rel="prefetch" href="/assets/js/39.e4d6bcdf.js"><link rel="prefetch" href="/assets/js/4.e9b44388.js"><link rel="prefetch" href="/assets/js/40.555106bc.js"><link rel="prefetch" href="/assets/js/41.4387ceb1.js"><link rel="prefetch" href="/assets/js/42.9bd4aea0.js"><link rel="prefetch" href="/assets/js/43.587e7966.js"><link rel="prefetch" href="/assets/js/44.80285763.js"><link rel="prefetch" href="/assets/js/45.f978da77.js"><link rel="prefetch" href="/assets/js/46.d93e3f2e.js"><link rel="prefetch" href="/assets/js/47.c15bd2aa.js"><link rel="prefetch" href="/assets/js/48.cb55fa72.js"><link rel="prefetch" href="/assets/js/49.d0f4e454.js"><link rel="prefetch" href="/assets/js/5.b90b80cb.js"><link rel="prefetch" href="/assets/js/50.112e8260.js"><link rel="prefetch" href="/assets/js/51.a66bcd03.js"><link rel="prefetch" href="/assets/js/52.0c7cbfb1.js"><link rel="prefetch" href="/assets/js/53.67ef240b.js"><link rel="prefetch" href="/assets/js/54.2c2d082d.js"><link rel="prefetch" href="/assets/js/55.88f19a20.js"><link rel="prefetch" href="/assets/js/56.c726e920.js"><link rel="prefetch" href="/assets/js/57.eaee47c5.js"><link rel="prefetch" href="/assets/js/58.ac15a3ac.js"><link rel="prefetch" href="/assets/js/59.64bdc849.js"><link rel="prefetch" href="/assets/js/6.7eea74ff.js"><link rel="prefetch" href="/assets/js/7.a1370e98.js"><link rel="prefetch" href="/assets/js/8.2e898240.js"><link rel="prefetch" href="/assets/js/9.a2439994.js">
    <link rel="stylesheet" href="/assets/css/0.styles.420b7c1f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">个人博客 | JiiiiG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/linux/linux常用命令/01linux常用命令01.html" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/hadoop/01hadoop环境搭建/01搭建hadoop集群.html" class="nav-link">
  hadoop
</a></li><li class="dropdown-item"><!----> <a href="/hbase/hbase.html" class="nav-link">
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/flink/flink.html" class="nav-link">
  flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clickhouse/.html" class="nav-link">
  java
</a></li></ul></div></div> <a href="https://github.com/MaLunan/press" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/linux/linux常用命令/01linux常用命令01.html" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/hadoop/01hadoop环境搭建/01搭建hadoop集群.html" class="nav-link">
  hadoop
</a></li><li class="dropdown-item"><!----> <a href="/hbase/hbase.html" class="nav-link">
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/flink/flink.html" class="nav-link">
  flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clickhouse/.html" class="nav-link">
  java
</a></li></ul></div></div> <a href="https://github.com/MaLunan/press" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1、clickhouse概述"><a href="#_1、clickhouse概述" class="header-anchor">#</a> 1、ClickHouse概述</h2> <h3 id="_1、clickhouse基本简介"><a href="#_1、clickhouse基本简介" class="header-anchor">#</a> 1、ClickHouse基本简介</h3> <p>ClickHouse是俄罗斯的Yandex于2016年开源的<strong>列式存储****数据库管理系统</strong>(DBMS:Database Management System)，简称CK。</p> <p>主要**用于在线分析处理查询（**OLAP:Online Analytical Processing）</p> <p>能够使用SQL查询实时生成分析数据报表</p> <p>ClickHouse官方文档：https://clickhouse.tech/docs/en/</p> <h3 id="_2、clickhouse的特性"><a href="#_2、clickhouse的特性" class="header-anchor">#</a> 2、ClickHouse的特性</h3> <ul><li>² 真正的面向列的DBMS</li> <li>² 数据压缩</li> <li>² 磁盘存储的数据</li> <li>² 多核并行处理</li> <li>² 多个服务器上分布式处理</li> <li>² SQL支持</li> <li>² 向量化引擎</li> <li>² 实时数据更新</li> <li>² 索引</li> <li>² 支持在线查询</li> <li>² 支持近似计算</li> <li>² 数据复制和对数据完整性的支持</li></ul> <p>ClickHouse的不完美</p> <ul><li>u 没有完整的事务支持</li> <li>u  缺少高频率，低延迟的修改或删除已存在数据的能力。仅能用于批量修改或删除数据</li> <li>u 稀疏索引使得clickhouse不适合通过其键检索单行的点查询</li></ul> <h3 id="_3、clickhouse的应用场景"><a href="#_3、clickhouse的应用场景" class="header-anchor">#</a> 3、clickhouse的应用场景</h3> <p>Ø OLAP场景关键特征：</p> <ul><li>l 大多数是读请求</li> <li>l 数据总是以相当大的批(&gt; 1000 rows)进行写入</li> <li>l 不修改已添加的数据</li> <li>l 每次查询都从数据库中读取大量的行，但是同时又仅需要少量的列</li> <li>l 宽表，即每个表包含着大量的列</li> <li>l 较少的查询(通常每台服务器每秒数百个查询或更少)</li> <li>l 对于简单查询，允许延迟大约50毫秒</li> <li>l 列中的数据相对较小： 数字和短字符串(例如，每个UR60个字节)</li> <li>l 处理单个查询时需要高吞吐量（每个服务器每秒高达数十亿行）</li> <li>l 事务不是必须的</li> <li>l 对数据一致性要求低</li> <li>l 每一个查询除了一个大表外都很小</li> <li>l 查询结果明显小于源数据，换句话说，数据被过滤或聚合后能够被盛放在单台服务器的内存中</li></ul> <p>Ø <strong>应用场景：</strong></p> <p>l 用于结构良好清晰且不可变的事件或日志流分析。</p> <p>Ø <strong>不适合的场景：</strong></p> <p>l 事务性工作(OLTP)，高请求率的键值访问，低延迟的修改或删除已存在数据，Blob或文档存储，超标准化数据。</p> <h2 id="_2、clickhouse的安装部署"><a href="#_2、clickhouse的安装部署" class="header-anchor">#</a> 2、ClickHouse的安装部署</h2> <p>​    clickhouse官网并没有提供二进制或rpm安装包，但是Altinity公司提供了对应的rpm安装包，可以通过rpm方式去安装。</p> <h3 id="第一步-下载rpm包"><a href="#第一步-下载rpm包" class="header-anchor">#</a> 第一步：下载rpm包</h3> <p>下载地址：https://packagecloud.io/Altinity/clickhouse</p> <p><img src="/assets/img/clip_image002.e2ba6bbc.png" alt="img"></p> <h3 id="第二步-上传rpm包"><a href="#第二步-上传rpm包" class="header-anchor">#</a> 第二步：上传rpm包</h3> <p>上传rpm包到服务器node01、node02、node03服务器上的/kkb/soft路径下</p> <h3 id="第三步-安装rpm包"><a href="#第三步-安装rpm包" class="header-anchor">#</a> 第三步：安装rpm包</h3> <p>每台节点安装下面的2个依赖</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> yum <span class="token function">install</span> -y libtool
<span class="token function">sudo</span> yum <span class="token function">install</span> -y *unixODBC*
</code></pre></div><p>每台节点安装ck服务</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/soft/
<span class="token function">sudo</span> <span class="token function">rpm</span> -ivh *rpm
</code></pre></div><p><img src="/assets/img/clip_image004.9cd7f02e.png" alt="img"></p> <h3 id="第四步-修改配置文件"><a href="#第四步-修改配置文件" class="header-anchor">#</a> 第四步：修改配置文件</h3> <h4 id="修改config-xml"><a href="#修改config-xml" class="header-anchor">#</a> 修改config.xml</h4> <p>三台机器都修改配置文件</p> <p>node01执行以下命令修改config.xml</p> <div class="language- extra-class"><pre class="language-text"><code>sudo vim /etc/clickhouse-server/config.xml
</code></pre></div><p>将这一行注释文件给打开</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;listen_host&gt;::&lt;/listen_host&gt;
</code></pre></div><p>将配置文件拷贝到其他机器上面去</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">scp</span>  /etc/clickhouse-server/config.xml  node02:/etc/clickhouse-server/
<span class="token function">sudo</span> <span class="token function">scp</span>  /etc/clickhouse-server/config.xml  node03:/etc/clickhouse-server/
</code></pre></div><h4 id="创建metrika-xml"><a href="#创建metrika-xml" class="header-anchor">#</a> 创建metrika.xml</h4> <h5 id="node01服务器创建metrika-xml"><a href="#node01服务器创建metrika-xml" class="header-anchor">#</a> node01服务器创建metrika.xml</h5> <p>node01服务器的/etc 目录下新建metrika.xml文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">vim</span> /etc/metrika.xml
</code></pre></div><div class="language-xml extra-class"><pre class="language-xml"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>yandex</span><span class="token punctuation">&gt;</span></span>
 <span class="token comment">&lt;!-- 集群配置 --&gt;</span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>clickhouse_remote_servers</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bip_ck_cluster</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>internal_replication</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>internal_replication</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>internal_replication</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>internal_replication</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node02<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">&gt;</span></span>        
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>internal_replication</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>internal_replication</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node03<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bip_ck_cluster</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>clickhouse_remote_servers</span><span class="token punctuation">&gt;</span></span>
 
 <span class="token comment">&lt;!-- 本节点副本，不同的机器配置不同 --&gt;</span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>macros</span><span class="token punctuation">&gt;</span></span>  
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>node01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>  
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>macros</span><span class="token punctuation">&gt;</span></span>  
 
 <span class="token comment">&lt;!-- ZK --&gt;</span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>zookeeper-servers</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
   
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node02<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
   
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node03<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>zookeeper-servers</span><span class="token punctuation">&gt;</span></span>
 
     <span class="token comment">&lt;!-- 监听网络 --&gt;</span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>networks</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ip</span><span class="token punctuation">&gt;</span></span>::/0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ip</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>networks</span><span class="token punctuation">&gt;</span></span>
 
 
 <span class="token comment">&lt;!-- 数据压缩算法 --&gt;</span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>clickhouse_compression</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>case</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>min_part_size</span><span class="token punctuation">&gt;</span></span>10000000000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>min_part_size</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>min_part_size_ratio</span><span class="token punctuation">&gt;</span></span>0.01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>min_part_size_ratio</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>method</span><span class="token punctuation">&gt;</span></span>lz4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>method</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>case</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>clickhouse_compression</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>yandex</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h5 id="node02服务器创建metrika-xml"><a href="#node02服务器创建metrika-xml" class="header-anchor">#</a> node02服务器创建metrika.xml</h5> <p>node02服务器的/etc 目录下新建metrika.xml文件</p> <div class="language- extra-class"><pre class="language-text"><code>sudo vim /etc/metrika.xml
</code></pre></div><div class="language-xml extra-class"><pre class="language-xml"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>yandex</span><span class="token punctuation">&gt;</span></span>
 <span class="token comment">&lt;!-- 集群配置 --&gt;</span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>clickhouse_remote_servers</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bip_ck_cluster</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>internal_replication</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>internal_replication</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>internal_replication</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>internal_replication</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node02<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">&gt;</span></span>        
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>internal_replication</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>internal_replication</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node03<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bip_ck_cluster</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>clickhouse_remote_servers</span><span class="token punctuation">&gt;</span></span>
 
 <span class="token comment">&lt;!-- 本节点副本，不同的机器配置不同 --&gt;</span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>macros</span><span class="token punctuation">&gt;</span></span>  
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>node02<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>  
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>macros</span><span class="token punctuation">&gt;</span></span>  
 
 <span class="token comment">&lt;!-- ZK --&gt;</span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>zookeeper-servers</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
   
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node02<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
   
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node03<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>zookeeper-servers</span><span class="token punctuation">&gt;</span></span>
 
     <span class="token comment">&lt;!-- 监听网络 --&gt;</span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>networks</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ip</span><span class="token punctuation">&gt;</span></span>::/0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ip</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>networks</span><span class="token punctuation">&gt;</span></span>
 
 
 <span class="token comment">&lt;!-- 数据压缩算法 --&gt;</span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>clickhouse_compression</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>case</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>min_part_size</span><span class="token punctuation">&gt;</span></span>10000000000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>min_part_size</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>min_part_size_ratio</span><span class="token punctuation">&gt;</span></span>0.01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>min_part_size_ratio</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>method</span><span class="token punctuation">&gt;</span></span>lz4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>method</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>case</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>clickhouse_compression</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>yandex</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h5 id="node03服务器创建metrika-xml"><a href="#node03服务器创建metrika-xml" class="header-anchor">#</a> node03服务器创建metrika.xml</h5> <p>node03服务器的/etc 目录下新建metrika.xml文件</p> <div class="language- extra-class"><pre class="language-text"><code>sudo vim /etc/metrika.xml
</code></pre></div><div class="language-xml extra-class"><pre class="language-xml"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>yandex</span><span class="token punctuation">&gt;</span></span>
 <span class="token comment">&lt;!-- 集群配置 --&gt;</span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>clickhouse_remote_servers</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bip_ck_cluster</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>internal_replication</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>internal_replication</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>internal_replication</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>internal_replication</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node02<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">&gt;</span></span>        
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>shard</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>internal_replication</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>internal_replication</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node03<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>shard</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bip_ck_cluster</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>clickhouse_remote_servers</span><span class="token punctuation">&gt;</span></span>
 
 <span class="token comment">&lt;!-- 本节点副本，不同的机器配置不同 --&gt;</span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>macros</span><span class="token punctuation">&gt;</span></span>  
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replica</span><span class="token punctuation">&gt;</span></span>node03<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replica</span><span class="token punctuation">&gt;</span></span>  
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>macros</span><span class="token punctuation">&gt;</span></span>  
 
 <span class="token comment">&lt;!-- ZK --&gt;</span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>zookeeper-servers</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
   
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node02<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
   
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>node03<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>zookeeper-servers</span><span class="token punctuation">&gt;</span></span>
 
     <span class="token comment">&lt;!-- 监听网络 --&gt;</span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>networks</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ip</span><span class="token punctuation">&gt;</span></span>::/0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ip</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>networks</span><span class="token punctuation">&gt;</span></span>
 
 
 <span class="token comment">&lt;!-- 数据压缩算法 --&gt;</span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>clickhouse_compression</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>case</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>min_part_size</span><span class="token punctuation">&gt;</span></span>10000000000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>min_part_size</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>min_part_size_ratio</span><span class="token punctuation">&gt;</span></span>0.01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>min_part_size_ratio</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>method</span><span class="token punctuation">&gt;</span></span>lz4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>method</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>case</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>clickhouse_compression</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>yandex</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="给予权限"><a href="#给予权限" class="header-anchor">#</a> 给予权限</h4> <p>给每台机器的目录授权（避免后面操作异常）,如果报错说不存在文件，此步可以省略不做。</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span>  <span class="token function">chmod</span> -R <span class="token number">777</span> /var/lib/clickhouse/data
<span class="token function">sudo</span> <span class="token function">chmod</span> -R <span class="token number">777</span> /var/lib/clickhouse/metadata
</code></pre></div><p>搭建clickhouse过程中会生成对应的目录</p> <div class="language-sh extra-class"><pre class="language-sh"><code> 配置文件路径：/etc/clickhouse-server/config.xml
 日志文件路径：/var/log/clickhouse-server/
 建表信息路径：/data/clickhouse/metadata/
 分区数据路径：/data/clickhouse/data/
</code></pre></div><h2 id="_3、clickhouse的启动与停止"><a href="#_3、clickhouse的启动与停止" class="header-anchor">#</a> 3、clickHouse的启动与停止</h2> <h3 id="clickhouse的启动"><a href="#clickhouse的启动" class="header-anchor">#</a> ClickHouse的启动</h3> <p>首先需要在三台机器上面<strong>启动zookeeper服务</strong>，然后通过以下命令来启动clickHouse服务</p> <div class="language- extra-class"><pre class="language-text"><code>sudo service clickhouse-server start
</code></pre></div><p>可以通过 ps -ef | grep clickhouse 命令查看ck是否启动成功</p> <div class="language- extra-class"><pre class="language-text"><code>ps -ef | grep clickhouse
</code></pre></div><p>连接客户端</p> <div class="language- extra-class"><pre class="language-text"><code>[hadoop@node01 bin]$ clickhouse-client
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token punctuation">[</span>hadoop<span class="token variable">@node01</span> <span class="token operator">~</span><span class="token punctuation">]</span>$ clickhouse<span class="token operator">-</span>client
ClickHouse client version <span class="token number">19.16</span><span class="token number">.10</span><span class="token number">.44</span><span class="token punctuation">.</span>
Connecting <span class="token keyword">to</span> localhost:<span class="token number">9000</span> <span class="token keyword">as</span> <span class="token keyword">user</span> <span class="token keyword">default</span><span class="token punctuation">.</span>
Connected <span class="token keyword">to</span> ClickHouse server version <span class="token number">19.16</span><span class="token number">.10</span> revision <span class="token number">54427.</span>

node01 :<span class="token punctuation">)</span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span>

<span class="token keyword">SHOW</span> <span class="token keyword">DATABASES</span>

┌─name────┐
│ <span class="token keyword">default</span> │
│ system  │
└─────────┘

<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">.</span> Elapsed: <span class="token number">0.002</span> sec<span class="token punctuation">.</span> 
</code></pre></div><p>ClickHouse的服务停止，三台节点上执行命令</p> <div class="language- extra-class"><pre class="language-text"><code>sudo service clickhouse-server stop
</code></pre></div><h2 id="_4-命令行客户端连接clickhouse"><a href="#_4-命令行客户端连接clickhouse" class="header-anchor">#</a> 4. 命令行客户端连接ClickHouse</h2> <p>通过命令行来访问 ClickHouse，您可以使用 <code>clickhouse-client</code></p> <p>语法格式示例</p> <div class="language-sh extra-class"><pre class="language-sh"><code> clickhouse-client -m -u <span class="token punctuation">[</span>username<span class="token punctuation">]</span> -h <span class="token punctuation">[</span>ip<span class="token punctuation">]</span> --password <span class="token punctuation">[</span>password<span class="token punctuation">]</span> --port <span class="token punctuation">[</span>port<span class="token punctuation">]</span>  
--user `<span class="token variable"><span class="token variable">`</span>或者<span class="token variable">`</span></span>` -u
</code></pre></div><p>用户名。 默认值： default。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>--password
</code></pre></div><p>密码。 默认值：空字符串。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>--host `<span class="token variable"><span class="token variable">`</span>或者<span class="token variable">`</span></span>` -h
</code></pre></div><p>服务端的 host 名称, 默认是 'localhost'</p> <div class="language-sh extra-class"><pre class="language-sh"><code>--port
</code></pre></div><p>连接的端口，默认值： 9000。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>--multiline `<span class="token variable"><span class="token variable">`</span>或者<span class="token variable">`</span></span>` -m
</code></pre></div><p>如果指定，允许<strong>多行语句查询</strong>（Enter 仅代表换行，不代表查询语句完结）。</p> <p>演示：开启多行查询</p> <div class="language-sh extra-class"><pre class="language-sh"><code>clickhouse-client -m 或者 clickhouse-client -multiline
</code></pre></div><h2 id="_5-数据类型"><a href="#_5-数据类型" class="header-anchor">#</a> 5. 数据类型</h2> <h3 id="_5-1-整型"><a href="#_5-1-整型" class="header-anchor">#</a> 5.1 整型</h3> <p>固定长度的整型，包括有符号整型或无符号整型</p> <p>·    整型范围</p> <div class="language-sh extra-class"><pre class="language-sh"><code> Int8 ：<span class="token punctuation">[</span>-128 <span class="token builtin class-name">:</span> <span class="token number">127</span><span class="token punctuation">]</span>
 Int16：<span class="token punctuation">[</span>-32768 <span class="token builtin class-name">:</span> <span class="token number">32767</span><span class="token punctuation">]</span>
 Int32：<span class="token punctuation">[</span>-2147483648 <span class="token builtin class-name">:</span> <span class="token number">2147483647</span><span class="token punctuation">]</span>
 Int64：<span class="token punctuation">[</span>-9223372036854775808 <span class="token builtin class-name">:</span> <span class="token number">9223372036854775807</span><span class="token punctuation">]</span>
</code></pre></div><p>·    无符号整型范围</p> <div class="language-sh extra-class"><pre class="language-sh"><code> UInt8 <span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token builtin class-name">:</span> <span class="token number">255</span><span class="token punctuation">]</span>
 UInt16: <span class="token punctuation">[</span><span class="token number">0</span> <span class="token builtin class-name">:</span> <span class="token number">65535</span><span class="token punctuation">]</span>
 UInt32: <span class="token punctuation">[</span><span class="token number">0</span> <span class="token builtin class-name">:</span> <span class="token number">4294967295</span><span class="token punctuation">]</span>
 UInt64: <span class="token punctuation">[</span><span class="token number">0</span> <span class="token builtin class-name">:</span> <span class="token number">18446744073709551615</span><span class="token punctuation">]</span>
</code></pre></div><h3 id="_5-2-浮点型"><a href="#_5-2-浮点型" class="header-anchor">#</a> 5.2 浮点型</h3> <p>·    Float32: float</p> <p>·    Float64: double</p> <div class="language-sql extra-class"><pre class="language-sql"><code> 建议尽可能以整数形式存储数据。
 例如，将固定精度的数字转换为整数值，如时间用毫秒为单位表示，因为浮点型进行计算时可能引起四舍五入的误差。
 
 node01 :<span class="token punctuation">)</span>  <span class="token keyword">select</span> <span class="token number">1</span><span class="token operator">-</span><span class="token number">0.9</span>
 <span class="token keyword">SELECT</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">0.9</span>
 ┌───────minus<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span>─┐
 │ <span class="token number">0.09999999999999998</span> │
 └─────────────────────┘
</code></pre></div><p>·    与标准SQL相比，ClickHouse 支持以下类别的浮点数：</p> <p>o  inf 正无穷</p> <div class="language-sql extra-class"><pre class="language-sql"><code> node01 :<span class="token punctuation">)</span>  <span class="token keyword">select</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span>
 <span class="token keyword">SELECT</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span>
 ┌─divide<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>─┐
 │         inf │
 └──────────────┘
</code></pre></div><p>o  -inf 负无穷</p> <div class="language-sql extra-class"><pre class="language-sql"><code> node01 :<span class="token punctuation">)</span>  <span class="token keyword">select</span> <span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span> 
 <span class="token keyword">SELECT</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span>
 ┌─divide<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>─┐
 │         <span class="token operator">-</span>inf │
 └───────────────┘
</code></pre></div><p>o  NaN 非数字</p> <div class="language-sql extra-class"><pre class="language-sql"><code> node01 :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span>
 <span class="token keyword">SELECT</span> <span class="token number">0</span> <span class="token operator">/</span> <span class="token number">0</span>
 ┌─divide<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>─┐
 │         nan │
 └──────────────┘
</code></pre></div><h3 id="_5-3-布尔型"><a href="#_5-3-布尔型" class="header-anchor">#</a> 5.3 布尔型</h3> <p>·    没有单独的类型来存储布尔值。可以使<strong>用 UInt8 类型，取值限制为 0 或 1。</strong></p> <h3 id="_5-4-字符串"><a href="#_5-4-字符串" class="header-anchor">#</a> 5.4 字符串</h3> <p>String：字符串可以任意长度的。它可以包含任意的字节集，包含空字节。</p> <p>FixedString(N)：固定长度 N 的字符串，N 必须是严格的正自然数。当向ClickHouse中插入数据时：</p> <ol><li>如果字符串包含的字节数少于<code>N</code>, 将对字符串末尾进行空字节填充。</li> <li>如果字符串包含的字节数大于<code>N</code>, 将抛出<code>Too large value for FixedString(N)</code>异常。</li></ol> <p>与String相比，<strong>极少会使用FixedString</strong>，因为使用起来不是很方便。</p> <h3 id="_5-5-枚举类型"><a href="#_5-5-枚举类型" class="header-anchor">#</a> 5.5 枚举类型</h3> <p>包括 <strong>Enum8</strong> 和 <strong>Enum16</strong> 类型。Enum 保存 'string'= integer 的对应关系。</p> <ul><li><strong>Enum8</strong> 用 'String'= Int8 对描述。</li> <li><strong>Enum16</strong> 用 'String'= Int16 对描述。</li></ul> <p>用法演示</p> <ul><li>创建一个带有一个枚举 <code>Enum8('hello' = 1, 'world' = 2)</code> 类型的列：</li></ul> <div class="language- extra-class"><pre class="language-text"><code> clickhouse-client --multiline
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> enum_table<span class="token punctuation">(</span>
 x Enum8<span class="token punctuation">(</span><span class="token string">'hello'</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'world'</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
 <span class="token punctuation">)</span><span class="token keyword">ENGINE</span> <span class="token operator">=</span> TinyLog<span class="token punctuation">;</span>
</code></pre></div><p>o  这个 <code>x</code> 列只能存储类型定义中列出的值：<code>'hello'</code>或<code>'world'</code>。如果您尝试保存任何其他值，ClickHouse 抛出异常。</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token comment">--插入数据</span>
 node01 :<span class="token punctuation">)</span> <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> enum_table <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'world'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 
 <span class="token comment">--插入非'hello'或者'world'的数据</span>
 node01 :<span class="token punctuation">)</span> <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> enum_table <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          
 <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> enum_table <span class="token keyword">VALUES</span>
 Exception <span class="token keyword">on</span> client:
 Code: <span class="token number">49.</span> DB::Exception: Unknown element <span class="token string">'a'</span> <span class="token keyword">for</span> <span class="token keyword">type</span> Enum8<span class="token punctuation">(</span><span class="token string">'hello'</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'world'</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
 
</code></pre></div><p>o  从表中查询数据时，ClickHouse 从 <code>Enum</code> 中输出字符串值</p> <div class="language-sql extra-class"><pre class="language-sql"><code> node01 :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> enum_table<span class="token punctuation">;</span>
 
 <span class="token keyword">SELECT</span> <span class="token operator">*</span>
 <span class="token keyword">FROM</span> enum_table 
 
 ┌─────x─┐
 │ hello │
 │ world │
 │ hello │
 └───────┘
</code></pre></div><p>o  如果需要看到对应行的数值，则必须将 <code>Enum</code> 值转换为整数类型。</p> <div class="language-sql extra-class"><pre class="language-sql"><code> node01 :<span class="token punctuation">)</span> <span class="token keyword">SELECT</span> CAST<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">'Int8'</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> enum_table <span class="token punctuation">;</span>
 
 <span class="token keyword">SELECT</span> CAST<span class="token punctuation">(</span>x <span class="token keyword">AS</span> Int8<span class="token punctuation">)</span>
 <span class="token keyword">FROM</span> enum_table 
 
 ┌─CAST<span class="token punctuation">(</span>x<span class="token punctuation">,</span> \'Int8\'<span class="token punctuation">)</span>─┐
 │                 <span class="token number">1</span> │
 │                 <span class="token number">2</span> │
 │                 <span class="token number">1</span> │
 └───────────────────┘
</code></pre></div><h3 id="_5-6-数组"><a href="#_5-6-数组" class="header-anchor">#</a> 5.6 数组</h3> <p>Array(T)：由 <code>T</code> 类型元素组成的数组。</p> <p><code>T</code> <strong>可以是任意类型</strong>，包含数组类型。 但不推荐使用多维数组，ClickHouse 对多维数组的支持有限。例如，不能存储在 <code>MergeTree</code> 表中存储多维数组。</p> <p>创建数组</p> <ol><li>可以使用array函数来创建数组：array[T]</li> <li>也可以使用方括号 []</li></ol> <p>案例</p> <div class="language-sql extra-class"><pre class="language-sql"><code> node01 :<span class="token punctuation">)</span> <span class="token keyword">SELECT</span> array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> x<span class="token punctuation">,</span> toTypeName<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">;</span>
 
 <span class="token keyword">SELECT</span> 
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">AS</span> x<span class="token punctuation">,</span> 
    toTypeName<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
 
 ┌─x─────┬─toTypeName<span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>─┐
 │ <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span> │ Array<span class="token punctuation">(</span>UInt8<span class="token punctuation">)</span>           │
 └───────┴─────────────────────────┘
 
 
 
 node01 :<span class="token punctuation">)</span>  <span class="token keyword">SELECT</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">2.2</span><span class="token punctuation">]</span> <span class="token keyword">AS</span> x<span class="token punctuation">,</span> toTypeName<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">SELECT</span> 
    <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">2.2</span><span class="token punctuation">]</span> <span class="token keyword">AS</span> x<span class="token punctuation">,</span> 
    toTypeName<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
 
 ┌─x─────────┬─toTypeName<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">2.2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>─┐
 │ <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2.2</span><span class="token punctuation">]</span> │ Array<span class="token punctuation">(</span>Float64<span class="token punctuation">)</span>         │
 └───────────┴────────────────────────┘
 
</code></pre></div><h3 id="_5-7-元组"><a href="#_5-7-元组" class="header-anchor">#</a> 5.7 元组</h3> <p>Tuple(T1, T2, ...)：元组，其中<strong>每个元素都有单独的类型</strong>。</p> <p>创建元组，可以使用函数来创建元组</p> <div class="language- extra-class"><pre class="language-text"><code> tuple(T1, T2, ...)
</code></pre></div><p>·    案例</p> <div class="language-sql extra-class"><pre class="language-sql"><code> node01 :<span class="token punctuation">)</span>  <span class="token keyword">SELECT</span> tuple<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> x<span class="token punctuation">,</span> toTypeName<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">SELECT</span> 
    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> x<span class="token punctuation">,</span> 
    toTypeName<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
 
 ┌─x───────┬─toTypeName<span class="token punctuation">(</span>tuple<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> \'a\'<span class="token punctuation">)</span><span class="token punctuation">)</span>─┐
 │ <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span> │ Tuple<span class="token punctuation">(</span>UInt8<span class="token punctuation">,</span> String<span class="token punctuation">)</span>       │
 └─────────┴─────────────────────────────┘
</code></pre></div><h3 id="_5-8-date日期"><a href="#_5-8-date日期" class="header-anchor">#</a> 5.8 Date日期</h3> <p><strong>日期类型</strong>，用两个字节存储，表示从 1970-01-01 (无符号) 到当前的日期值</p> <h3 id="_5-9-datetime时间戳"><a href="#_5-9-datetime时间戳" class="header-anchor">#</a> 5.9 DateTime时间戳</h3> <p><strong>时间戳类型</strong>。用四个字节（无符号的）存储 Unix 时间戳）。</p> <p>允许存储与日期类型相同的范围内的值。最小值为 0000-00-00 00:00:00。时间戳类型值精确到秒</p> <p>还有很多数据结构，可以参考官方文档：https://clickhouse.yandex/docs/zh/data_types/</p> <h2 id="_6-表引擎"><a href="#_6-表引擎" class="header-anchor">#</a> 6. 表引擎</h2> <p><strong>表引擎（即表的类型）决定了：</strong></p> <p>o   数据的存储方式和位置，写到哪里以及从哪里读取数据</p> <p>o   支持哪些查询以及如何支持。</p> <p>o   并发数据访问。</p> <p>o   索引的使用（如果存在）。</p> <p>o   是否可以执行多线程请求。</p> <p>o   数据复制参数。</p> <div class="language- extra-class"><pre class="language-text"><code> ClickHouse的表引擎有很多，下面介绍其中几种，对其他引擎有兴趣的可以去查阅官方文档：https://clickhouse.yandex/docs/zh/operations/table_engines/
</code></pre></div><h3 id="_6-1-tinylog"><a href="#_6-1-tinylog" class="header-anchor">#</a> 6.1 TinyLog</h3> <p>最简单的表引擎，用于<strong>将数据存储在磁盘上。每列都存储在单独的压缩文件中</strong>。写入时，数据将附加到文件末尾。</p> <p><strong>该引擎没有并发控制</strong></p> <ol><li>如果同时从表中读取和写入数据，则读取操作将抛出异常；</li> <li>如果同时写入多个查询中的表，则数据将被破坏。</li></ol> <div class="language- extra-class"><pre class="language-text"><code>  这种表引擎的典型用法是 write-once：首先只写入一次数据，然后根据需要多次读取。此引擎适用于相对较小的表（建议最多1,000,000行）。如果有许多小表，则使用此表引擎是适合的，因为它比Log引擎更简单（需要打开的文件更少）。当您拥有大量小表时，可能会导致性能低下，不支持索引。
</code></pre></div><p>案例：创建一个TinyLog引擎的表并插入一条数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">create</span> <span class="token keyword">table</span> f1 <span class="token punctuation">(</span>a UInt16<span class="token punctuation">,</span> b String<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span>TinyLog<span class="token punctuation">;</span>
 
 <span class="token keyword">insert</span> <span class="token keyword">into</span> f1 <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>o  此时我们到保存数据的目录/var/lib/clickhouse/data/default/f1中可以看到如下目录结构：</p> <div class="language-sh extra-class"><pre class="language-sh"><code> <span class="token punctuation">[</span>root@node01 f1<span class="token punctuation">]</span><span class="token comment">## ll</span>
 -rw-rw-rw- <span class="token number">1</span> clickhouse clickhouse <span class="token number">28</span> Feb <span class="token number">18</span> <span class="token number">21</span>:58 a.bin
 -rw-rw-rw- <span class="token number">1</span> clickhouse clickhouse <span class="token number">30</span> Feb <span class="token number">18</span> <span class="token number">21</span>:58 b.bin
 -rw-rw-rw- <span class="token number">1</span> clickhouse clickhouse <span class="token number">60</span> Feb <span class="token number">18</span> <span class="token number">21</span>:58 sizes.json
 
 其中a.bin 和 b.bin 是压缩过的对应的列的数据，
 sizes.json 中记录了每个 *.bin 文件的大小
 
 <span class="token punctuation">[</span>root@node01 f1<span class="token punctuation">]</span><span class="token comment">## cat sizes.json </span>
 <span class="token punctuation">{</span><span class="token string">&quot;yandex&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;a%2Ebin&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;28&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;b%2Ebin&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;size&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;30&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><p>注意：<strong>使用这种引擎，在机器A中创建的表，在机器B中是看不到这个表的</strong>，这个就是tinylog单表引擎，一般很少用。</p> <h3 id="_6-2-memory"><a href="#_6-2-memory" class="header-anchor">#</a> 6.2 Memory</h3> <p>内存引擎，数据以未压缩的原始形式直接<strong>保存在内存当中</strong>，服务器重启数据就会消失。<strong>读写操作不会相互阻塞，不支持索引</strong>。简单查询下有<strong>非常非常高的性能表现（超过10G/s）。</strong></p> <p>一般用到它的地方不多，除了用来测试，就是在<strong>需要非常高的性能，同时数据量又不太大（上限大概 1 亿行）的场景。</strong></p> <h3 id="_6-3-merge"><a href="#_6-3-merge" class="header-anchor">#</a> 6.3 Merge</h3> <p><strong>Merge 引擎 (不要跟 MergeTree 引擎混淆</strong>) <strong>本身不存储数据</strong>，但可用于同时从任意多个其他的表中读取数据。 读是自动并行的，不支持写入。读取时，那些被真正读取到数据的表的索引（如果有的话）会被使用。</p> <p>Merge 引擎的参数：一个数据库名和一个用于匹配表名的正则表达式。</p> <p>案例</p> <p>先在node01建立t1，t2，t3三个表，然后用 Merge 引擎的 tt 表再把它们链接起来</p> <p>创建表</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> t1 <span class="token punctuation">(</span>id UInt16<span class="token punctuation">,</span> name String<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span>TinyLog<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> t2 <span class="token punctuation">(</span>id UInt16<span class="token punctuation">,</span> name String<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span>TinyLog<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> t3 <span class="token punctuation">(</span>id UInt16<span class="token punctuation">,</span> name String<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span>TinyLog<span class="token punctuation">;</span>
</code></pre></div><p>​向表中插入数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> t1<span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'first'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t2<span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'second'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t3<span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'three'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>​创建t表 ，把defalut数据库中所有以t开头的表连接起来</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> t<span class="token punctuation">(</span>id UInt16<span class="token punctuation">,</span> name String<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">Merge</span><span class="token punctuation">(</span>currentDatabase<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'^t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code> node01 :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t<span class="token punctuation">;</span>
 
 <span class="token keyword">SELECT</span> <span class="token operator">*</span>
 <span class="token keyword">FROM</span> t
 ┌─id─┬─name──┐
 │  <span class="token number">1</span> │ <span class="token keyword">first</span> │
 └────┴───────┘
 ┌─id─┬─name───┐
 │  <span class="token number">2</span> │ <span class="token keyword">second</span> │
 └────┴────────┘
 ┌─id─┬─name──┐
 │  <span class="token number">3</span> │ three │
 └────┴───────┘
</code></pre></div><h3 id="_6-4-mergetree-使用最多"><a href="#_6-4-mergetree-使用最多" class="header-anchor">#</a> 6.4 MergeTree(使用最多)</h3> <p>Clickhouse 中最强大的表引擎当属 <code>MergeTree</code> （合并树）引擎及该系列（<code>*MergeTree</code>）中的其他引擎。</p> <p><code>MergeTree</code> 引擎系列的基本理念如下。当你有巨量数据要插入到表中，你要高效地一批批写入数据片段，并希望这些数据片段在后台按照一定规则合并。相比在插入时不断修改（重写）数据进存储，这种策略会高效很多。</p> <p>语法</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>db<span class="token punctuation">.</span><span class="token punctuation">]</span>table_name <span class="token punctuation">[</span><span class="token keyword">ON</span> CLUSTER cluster<span class="token punctuation">]</span>
 <span class="token punctuation">(</span>
    name1 <span class="token punctuation">[</span>type1<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span><span class="token operator">|</span>MATERIALIZED<span class="token operator">|</span>ALIAS expr1<span class="token punctuation">]</span><span class="token punctuation">,</span>
    name2 <span class="token punctuation">[</span>type2<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span><span class="token operator">|</span>MATERIALIZED<span class="token operator">|</span>ALIAS expr2<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span> MergeTree<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token operator">-</span><span class="token keyword">column</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> sampling_expression<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">primary</span><span class="token punctuation">,</span> <span class="token keyword">key</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index_granularity<span class="token punctuation">)</span>
</code></pre></div><ul><li>date-column：类型为 Date 的列名。ClickHouse 会自动依据这个列创建分区。</li> <li>sampling_expression ：采样表达式。</li> <li>(primary, key) ：联合主键。类型为Tuple()，主键可以是任意表达式构成的元组（通常是列名称的元组）.</li> <li>index_granularity ：索引粒度。即索引中相邻”标记”间的数据行数。设为 8192 可以适用大部分场景。</li></ul> <p>案例：</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token comment">--创建基于MergeTree的引擎表</span>
 <span class="token keyword">create</span> <span class="token keyword">table</span> mt_table <span class="token punctuation">(</span><span class="token keyword">date</span>  <span class="token keyword">Date</span><span class="token punctuation">,</span> id UInt8<span class="token punctuation">,</span> name String<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span>MergeTree<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">--插入数据</span>
 <span class="token keyword">insert</span> <span class="token keyword">into</span> mt_table <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2019-05-01'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'zhangsan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">insert</span> <span class="token keyword">into</span> mt_table <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2019-06-01'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'lisi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">insert</span> <span class="token keyword">into</span> mt_table <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2019-05-03'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'wangwu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 
 <span class="token comment">--查询表</span>
 node01 :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mt_table<span class="token punctuation">;</span>
 
 <span class="token keyword">SELECT</span> <span class="token operator">*</span>
 <span class="token keyword">FROM</span> mt_table 
 
 ┌───────<span class="token keyword">date</span>─┬─id─┬─name───┐
 │ <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">03</span> │  <span class="token number">3</span> │ wangwu │
 └────────────┴────┴────────┘
 ┌───────<span class="token keyword">date</span>─┬─id─┬─name─────┐
 │ <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">01</span> │  <span class="token number">1</span> │ zhangsan │
 └────────────┴────┴──────────┘
 ┌───────<span class="token keyword">date</span>─┬─id─┬─name─┐
 │ <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">01</span> │  <span class="token number">2</span> │ lisi │
 └────────────┴────┴──────┘
</code></pre></div><p>o  在/var/lib/clickhouse/data/default/mt_table目录下可以看到信息</p> <div class="language-sh extra-class"><pre class="language-sh"><code> <span class="token punctuation">[</span>root@node01 mt_table<span class="token punctuation">]</span><span class="token comment">## ll</span>
 drwxrwxrwx <span class="token number">2</span> clickhouse clickhouse <span class="token number">157</span> Feb <span class="token number">19</span> <span class="token number">12</span>:51 20190501_20190501_2_2_0
 drwxrwxrwx <span class="token number">2</span> clickhouse clickhouse <span class="token number">157</span> Feb <span class="token number">19</span> <span class="token number">12</span>:51 20190503_20190503_6_6_0
 drwxrwxrwx <span class="token number">2</span> clickhouse clickhouse <span class="token number">157</span> Feb <span class="token number">19</span> <span class="token number">12</span>:51 20190601_20190601_4_4_0
 drwxrwxrwx <span class="token number">2</span> clickhouse clickhouse   <span class="token number">6</span> Feb <span class="token number">19</span> <span class="token number">12</span>:51 detached
</code></pre></div><p>o  进入到20190501_20190501_2_2_0目录中</p> <div class="language-sh extra-class"><pre class="language-sh"><code> <span class="token punctuation">[</span>root@node01 20190501_20190501_2_2_0<span class="token punctuation">]</span><span class="token comment">## ll</span>
 -rw-rw-rw- <span class="token number">1</span> clickhouse clickhouse <span class="token number">255</span> Feb <span class="token number">19</span> <span class="token number">12</span>:51 checksums.txt
 -rw-rw-rw- <span class="token number">1</span> clickhouse clickhouse  <span class="token number">74</span> Feb <span class="token number">19</span> <span class="token number">12</span>:51 columns.txt
 -rw-rw-rw- <span class="token number">1</span> clickhouse clickhouse  <span class="token number">28</span> Feb <span class="token number">19</span> <span class="token number">12</span>:51 date.bin
 -rw-rw-rw- <span class="token number">1</span> clickhouse clickhouse  <span class="token number">16</span> Feb <span class="token number">19</span> <span class="token number">12</span>:51 date.mrk
 -rw-rw-rw- <span class="token number">1</span> clickhouse clickhouse  <span class="token number">27</span> Feb <span class="token number">19</span> <span class="token number">12</span>:51 id.bin
 -rw-rw-rw- <span class="token number">1</span> clickhouse clickhouse  <span class="token number">16</span> Feb <span class="token number">19</span> <span class="token number">12</span>:51 id.mrk
 -rw-rw-rw- <span class="token number">1</span> clickhouse clickhouse  <span class="token number">35</span> Feb <span class="token number">19</span> <span class="token number">12</span>:51 name.bin
 -rw-rw-rw- <span class="token number">1</span> clickhouse clickhouse  <span class="token number">16</span> Feb <span class="token number">19</span> <span class="token number">12</span>:51 name.mrk
 -rw-rw-rw- <span class="token number">1</span> clickhouse clickhouse  <span class="token number">10</span> Feb <span class="token number">19</span> <span class="token number">12</span>:51 primary.idx
 
 <span class="token comment">##其中</span>
 *.bin是按列保存数据的文件
 *.mrk保存块偏移量
 primary.idx保存主键索引
</code></pre></div><h3 id="_6-5-replacingmergetree"><a href="#_6-5-replacingmergetree" class="header-anchor">#</a> 6.5 ReplacingMergeTree</h3> <p>这个引擎是在 MergeTree 的基础上，添加了**“处理重复数据”<strong>的功能，该引擎和MergeTree的不同之处在于</strong>它会删除具有相同主键的重复项。**</p> <p>数据的去重只会在合并的过程中出现。合并会在未知的时间在后台进行，所以你无法预先作出计划。有一些数据可能仍未被处理。因此，<strong>ReplacingMergeTree 适用于在后台清除重复的数据以节省空间，但是它不保证没有重复的数据出现。</strong></p> <p>语法</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>db<span class="token punctuation">.</span><span class="token punctuation">]</span>table_name <span class="token punctuation">[</span><span class="token keyword">ON</span> CLUSTER cluster<span class="token punctuation">]</span>
 <span class="token punctuation">(</span>
    name1 <span class="token punctuation">[</span>type1<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span><span class="token operator">|</span>MATERIALIZED<span class="token operator">|</span>ALIAS expr1<span class="token punctuation">]</span><span class="token punctuation">,</span>
    name2 <span class="token punctuation">[</span>type2<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span><span class="token operator">|</span>MATERIALIZED<span class="token operator">|</span>ALIAS expr2<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span> ReplacingMergeTree<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token operator">-</span><span class="token keyword">column</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> sampling_expression<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">primary</span><span class="token punctuation">,</span> <span class="token keyword">key</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index_granularity<span class="token punctuation">,</span> <span class="token punctuation">[</span>ver<span class="token punctuation">]</span><span class="token punctuation">)</span>
 
 
 <span class="token comment">--可以看出他比MergeTree只多了一个ver</span>
 <span class="token comment">--这个ver指代版本列，它和时间一起配置用来区分哪条数据是最新的。</span>
</code></pre></div><p>案例</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token comment">--创建一个基于ReplacingMergeTree引擎的表</span>
 <span class="token keyword">create</span> <span class="token keyword">table</span> rmt_table <span class="token punctuation">(</span><span class="token keyword">date</span>  <span class="token keyword">Date</span><span class="token punctuation">,</span> id UInt8<span class="token punctuation">,</span> name String<span class="token punctuation">,</span><span class="token keyword">point</span> UInt8<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span> ReplacingMergeTree<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8192</span><span class="token punctuation">,</span><span class="token keyword">point</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 　
 <span class="token comment">--插入数据</span>
 <span class="token keyword">insert</span> <span class="token keyword">into</span> rmt_table <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2019-07-10'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">insert</span> <span class="token keyword">into</span> rmt_table <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2019-07-10'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">insert</span> <span class="token keyword">into</span> rmt_table <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2019-07-11'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">insert</span> <span class="token keyword">into</span> rmt_table <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2019-07-11'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">insert</span> <span class="token keyword">into</span> rmt_table <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2019-07-11'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">--等待一段时间或者使用 optimize table rmt_table 命令手动触发merge</span>
 <span class="token comment">--查询数据（返回去重之后最新的数据）</span>
 node01 :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> rmt_table<span class="token punctuation">;</span>
 
 <span class="token keyword">SELECT</span> <span class="token operator">*</span>
 <span class="token keyword">FROM</span> rmt_table 
 
 ┌───────<span class="token keyword">date</span>─┬─id─┬─name─┬─<span class="token keyword">point</span>─┐
 │ <span class="token number">2019</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">11</span> │  <span class="token number">1</span> │ a   │    <span class="token number">30</span> │
 └────────────┴────┴──────┴───────┘
</code></pre></div><h3 id="_6-6-summingmergetree"><a href="#_6-6-summingmergetree" class="header-anchor">#</a> 6.6 SummingMergeTree</h3> <p>该引擎继承自 MergeTree。</p> <p>区别在于: 当合并 SummingMergeTree 表的数据片段时，<strong>ClickHouse 会把所有具有相同主键的行合并为一行</strong>，该行包含了被合并的行中具有数值数据类型的列的<strong>汇总值</strong>。</p> <p>在 merge 时，主键相同的行，被指定列的值会相加，没有被指定的列会取最先出现的值</p> <p>语法：</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>db<span class="token punctuation">.</span><span class="token punctuation">]</span>table_name <span class="token punctuation">[</span><span class="token keyword">ON</span> CLUSTER cluster<span class="token punctuation">]</span>
 <span class="token punctuation">(</span>
    name1 <span class="token punctuation">[</span>type1<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span><span class="token operator">|</span>MATERIALIZED<span class="token operator">|</span>ALIAS expr1<span class="token punctuation">]</span><span class="token punctuation">,</span>
    name2 <span class="token punctuation">[</span>type2<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span><span class="token operator">|</span>MATERIALIZED<span class="token operator">|</span>ALIAS expr2<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span> SummingMergeTree<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token operator">-</span><span class="token keyword">column</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> sampling_expression<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">primary</span><span class="token punctuation">,</span> <span class="token keyword">key</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index_granularity<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">columns</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>columns ：包含<strong>将要被汇总的列的列名的元组</strong></p> <p>案例</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token comment">----创建一个基于SummingMergeTree引擎的表</span>
 <span class="token keyword">create</span> <span class="token keyword">table</span> smt_table <span class="token punctuation">(</span><span class="token keyword">date</span> <span class="token keyword">Date</span><span class="token punctuation">,</span> name String<span class="token punctuation">,</span> a UInt16<span class="token punctuation">,</span> b UInt16<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span>SummingMergeTree<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8192</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">--插入数据</span>
 <span class="token keyword">insert</span> <span class="token keyword">into</span> smt_table <span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2019-07-10'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">insert</span> <span class="token keyword">into</span> smt_table <span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2019-07-10'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">insert</span> <span class="token keyword">into</span> smt_table <span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2019-07-11'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">insert</span> <span class="token keyword">into</span> smt_table <span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2019-07-11'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">insert</span> <span class="token keyword">into</span> smt_table <span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2019-07-11'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">insert</span> <span class="token keyword">into</span> smt_table <span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2019-07-12'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">----等待一段时间或者使用 optimize table smt_table 命令手动触发merge</span>
 <span class="token comment">--查询数据</span>
 
 node01 :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> smt_table<span class="token punctuation">;</span> 
 
 <span class="token keyword">SELECT</span> <span class="token operator">*</span>
 <span class="token keyword">FROM</span> smt_table 
 

┌───────<span class="token keyword">date</span>─┬─name─┬─a─┬─b─┐
│ <span class="token number">2019</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">10</span> │ a    │ <span class="token number">1</span> │ <span class="token number">2</span> │
│ <span class="token number">2019</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">10</span> │ b    │ <span class="token number">2</span> │ <span class="token number">1</span> │
│ <span class="token number">2019</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">11</span> │ a    │ <span class="token number">3</span> │ <span class="token number">1</span> │
│ <span class="token number">2019</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">11</span> │ b    │ <span class="token number">6</span> │ <span class="token number">8</span> │
└────────────┴──────┴───┴───┘
┌───────<span class="token keyword">date</span>─┬─name─┬─a─┬─b─┐
│ <span class="token number">2019</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">12</span> │ c    │ <span class="token number">1</span> │ <span class="token number">3</span> │
└────────────┴──────┴───┴───┘
 
 <span class="token comment">--发现2019-07-11，b的a列合并相加了，b列取了8（因为b列为8的数据最先插入）</span>
</code></pre></div><h3 id="_6-7-distributed"><a href="#_6-7-distributed" class="header-anchor">#</a> 6.7 Distributed</h3> <p>分布式引擎，<strong>本身不存储数据</strong>, 但<strong>可以在多个服务器上进行分布式查询</strong>。 读是自动并行的。读取时，远程服务器表的索引（如果有的话）会被使用。</p> <p>语法</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>db<span class="token punctuation">.</span><span class="token punctuation">]</span>table_name <span class="token punctuation">[</span><span class="token keyword">ON</span> CLUSTER cluster<span class="token punctuation">]</span>
 <span class="token punctuation">(</span>
    name1 <span class="token punctuation">[</span>type1<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span><span class="token operator">|</span>MATERIALIZED<span class="token operator">|</span>ALIAS expr1<span class="token punctuation">]</span><span class="token punctuation">,</span>
    name2 <span class="token punctuation">[</span>type2<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span><span class="token operator">|</span>MATERIALIZED<span class="token operator">|</span>ALIAS expr2<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span> <span class="token keyword">Distributed</span><span class="token punctuation">(</span>cluster_name<span class="token punctuation">,</span> <span class="token keyword">database</span><span class="token punctuation">,</span> <span class="token keyword">table</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> sharding_key<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>参数解析：</p> <ul><li>cluster_name ：服务器配置文件中的集群名,在/etc/metrika.xml中配置的</li> <li>database ：数据库名</li> <li>table ：表名</li> <li>sharding_key ：数据分片键</li></ul> <p>案例：</p> <p>（1）在node01，node02，node03上分别创建一个表 kaikeba</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">create</span> <span class="token keyword">table</span> kaikeba<span class="token punctuation">(</span>id UInt16<span class="token punctuation">,</span> name String<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span>TinyLog<span class="token punctuation">;</span>
</code></pre></div><p>（2）在三台机器的 kaikeba 表中插入一些数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">insert</span> <span class="token keyword">into</span> kaikeba <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'zhangsan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">insert</span> <span class="token keyword">into</span> kaikeba <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'lisi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>（3）在 node01上创建分布式表</p> <div class="language-sql extra-class"><pre class="language-sql"><code> node01 :<span class="token punctuation">)</span> <span class="token keyword">create</span> <span class="token keyword">table</span> distributed_table<span class="token punctuation">(</span>id UInt16<span class="token punctuation">,</span> name String<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">Distributed</span><span class="token punctuation">(</span>bip_ck_cluster<span class="token punctuation">,</span> <span class="token keyword">default</span><span class="token punctuation">,</span> kaikeba<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>（4）查询 distributed_table 表的数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code> node01 :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> distributed_table<span class="token punctuation">;</span>
 
 <span class="token keyword">SELECT</span> <span class="token operator">*</span>
 <span class="token keyword">FROM</span> distributed_table 
 

┌─id─┬─name─────┐
│  <span class="token number">1</span> │ zhangsan │
│  <span class="token number">2</span> │ lisi     │
└────┴──────────┘
┌─id─┬─name─────┐
│  <span class="token number">1</span> │ zhangsan │
│  <span class="token number">2</span> │ lisi     │
└────┴──────────┘
┌─id─┬─name─────┐
│  <span class="token number">1</span> │ zhangsan │
│  <span class="token number">2</span> │ lisi     │
└────┴──────────┘
</code></pre></div><p>（5）向distributed_table插入数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">insert</span> <span class="token keyword">into</span> distributed_table <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> kaikeba<span class="token punctuation">;</span>
 
 node01 :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> distributed_table<span class="token punctuation">;</span>
 
 <span class="token keyword">SELECT</span> <span class="token operator">*</span>
 <span class="token keyword">FROM</span> distributed_table 
 
 ┌─id─┬─name─────┐
 │  <span class="token number">2</span> │ lisi     │
 │  <span class="token number">1</span> │ zhangsan │
 └────┴──────────┘
 ┌─id─┬─name─────┐
 │  <span class="token number">1</span> │ zhangsan │
 │  <span class="token number">2</span> │ lisi     │
 │  <span class="token number">2</span> │ lisi     │
 └────┴──────────┘
 ┌─id─┬─name─────┐
 │  <span class="token number">1</span> │ zhangsan │
 │  <span class="token number">2</span> │ lisi     │
 │  <span class="token number">1</span> │ zhangsan │
 └────┴──────────┘
 
 
 <span class="token comment">--可以看到每个节点分布的数据差不多</span>
</code></pre></div><p>总结</p> <div class="language- extra-class"><pre class="language-text"><code> 分布式表实际上是Clickhouse集群本地表的一种“视图”。对分布式表的SELECT查询，会利用集群所有分片资源进行执行。你可以配置多个集群，并创建多个分布式表，给不同的集群提供视图
</code></pre></div><p>更多表引擎可以参考官方文档：https://clickhouse.tech/docs/zh/operations/table_engines/</p> <p>更多表引擎可以参考官方文档：https://clickhouse.tech/docs/zh/operations/table_engines/</p> <h2 id="_7-sql语法"><a href="#_7-sql语法" class="header-anchor">#</a> 7. SQL语法</h2> <h3 id="_7-1-create"><a href="#_7-1-create" class="header-anchor">#</a> 7.1 create</h3> <h4 id="_7-1-1-create-database"><a href="#_7-1-1-create-database" class="header-anchor">#</a> 7.1.1 create database</h4> <p>·    用于创建指定名称的数据库，语法如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> db_name
</code></pre></div><p>·    演示</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> test<span class="token punctuation">;</span>
</code></pre></div><h4 id="_7-1-2-create-table"><a href="#_7-1-2-create-table" class="header-anchor">#</a> 7.1.2 create table</h4> <p>·    对于创建表，语法如下</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>db<span class="token punctuation">.</span><span class="token punctuation">]</span>table_name <span class="token punctuation">[</span><span class="token keyword">ON</span> CLUSTER cluster<span class="token punctuation">]</span>
 <span class="token punctuation">(</span>
    name1 <span class="token punctuation">[</span>type1<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span><span class="token operator">|</span>MATERIALIZED<span class="token operator">|</span>ALIAS expr1<span class="token punctuation">]</span><span class="token punctuation">,</span>
    name2 <span class="token punctuation">[</span>type2<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">DEFAULT</span><span class="token operator">|</span>MATERIALIZED<span class="token operator">|</span>ALIAS expr2<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">engine</span>
 
 
 <span class="token comment">--DEFAULT expr ： 默认值，用法与SQL类似。</span>
 <span class="token comment">--MATERIALIZED expr ：物化表达式，被该表达式指定的列不能被INSERT，因为它总是被计算出来的。 对于INSERT而言，不需要考虑这些列。 另外，在SELECT查询中如果包含星号，此列不会被查询。</span>
 <span class="token comment">--ALIAS expr ：别名。</span>
</code></pre></div><p>创建表的三种方式</p> <p>（1）直接创建</p> <div class="language-sql extra-class"><pre class="language-sql"><code> node01 :<span class="token punctuation">)</span> <span class="token keyword">create</span> <span class="token keyword">table</span> t_demo1<span class="token punctuation">(</span>id UInt16<span class="token punctuation">,</span>name String<span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span>TinyLog<span class="token punctuation">;</span>
</code></pre></div><p>（2）创建一个与其他表具有相同结构的表</p> <p>语法</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>db<span class="token punctuation">.</span><span class="token punctuation">]</span>table_name <span class="token keyword">AS</span> <span class="token punctuation">[</span>db2<span class="token punctuation">.</span><span class="token punctuation">]</span>name2 <span class="token punctuation">[</span><span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">engine</span><span class="token punctuation">]</span>
</code></pre></div><p>演示</p> <div class="language-sql extra-class"><pre class="language-sql"><code> node01 :<span class="token punctuation">)</span> <span class="token keyword">create</span> <span class="token keyword">table</span> t_demo2 <span class="token keyword">as</span> t_demo1 <span class="token keyword">engine</span><span class="token operator">=</span>Memory<span class="token punctuation">;</span>
 
 node01 :<span class="token punctuation">)</span> <span class="token keyword">desc</span> t_demo2<span class="token punctuation">;</span>
 
 <span class="token keyword">DESCRIBE</span> <span class="token keyword">TABLE</span> t_demo2
 
 ┌─name─┬─<span class="token keyword">type</span>───┬─default_type─┬─default_expression─┐
 │ id   │ UInt16 │             │                   │
 │ name │ String │             │                   │
 └──────┴────────┴──────────────┴────────────────────┘
</code></pre></div><p>（3）使用指定的引擎创建一个与SELECT子句的结果具有相同结构的表，并使用SELECT子句的结果填充它。</p> <p>语法</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>db<span class="token punctuation">.</span><span class="token punctuation">]</span>table_name <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">engine</span> <span class="token keyword">AS</span> <span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>演示</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token comment">--向t_demo1表中添加数据</span>
 
  <span class="token keyword">insert</span> <span class="token keyword">into</span> t_demo1 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'zhangsan'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'lisi'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'wangwu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">create</span> <span class="token keyword">table</span> t_demo3 <span class="token keyword">engine</span><span class="token operator">=</span>TinyLog <span class="token keyword">as</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_demo1<span class="token punctuation">;</span>
 
 <span class="token comment">--查询表数据</span>
 node01 :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_demo3<span class="token punctuation">;</span>
 
 <span class="token keyword">SELECT</span> <span class="token operator">*</span>
 <span class="token keyword">FROM</span> t_demo3 
 
 ┌─id─┬─name─────┐
 │  <span class="token number">1</span> │ zhangsan │
 │  <span class="token number">2</span> │ lisi     │
 │  <span class="token number">3</span> │ wangwu   │
 └────┴──────────┘
</code></pre></div><h3 id="_7-2-insert-into"><a href="#_7-2-insert-into" class="header-anchor">#</a> 7.2 insert into</h3> <p>insert主要用于向系统中添加数据.</p> <p>语法：</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">[</span>db<span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token keyword">table</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>v11<span class="token punctuation">,</span> v12<span class="token punctuation">,</span> v13<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>v21<span class="token punctuation">,</span> v22<span class="token punctuation">,</span> v23<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>演示</p> <div class="language-sql extra-class"><pre class="language-sql"><code>  <span class="token keyword">create</span> <span class="token keyword">table</span> t_demo4<span class="token punctuation">(</span>id UInt16<span class="token punctuation">,</span>name String<span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span>TinyLog<span class="token punctuation">;</span>
  <span class="token keyword">insert</span> <span class="token keyword">into</span> t_demo4 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'zhangsan'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'lisi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">--查询</span>
 node01 :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_demo4<span class="token punctuation">;</span>
 
 <span class="token keyword">SELECT</span> <span class="token operator">*</span>
 <span class="token keyword">FROM</span> t_demo4 
 
 ┌─id─┬─name─────┐
 │  <span class="token number">1</span> │ zhangsan │
 │  <span class="token number">2</span> │ lisi     │
 └────┴──────────┘
</code></pre></div><p>注意</p> <div class="language-sql extra-class"><pre class="language-sql"><code> clickhouse不支持的其他用于修改数据的查询：<span class="token keyword">UPDATE</span><span class="token punctuation">,</span> <span class="token keyword">DELETE</span><span class="token punctuation">,</span> <span class="token keyword">REPLACE</span><span class="token punctuation">,</span> <span class="token keyword">MERGE</span><span class="token punctuation">,</span> UPSERT<span class="token punctuation">,</span> <span class="token keyword">INSERT</span> <span class="token keyword">UPDATE</span>。 但是可以使用 <span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">DROP</span> <span class="token keyword">PARTITION</span>查询来删除一些旧的数据。
</code></pre></div><h3 id="_7-3-alter"><a href="#_7-3-alter" class="header-anchor">#</a> 7.3 alter</h3> <p><strong>ALTER只支持MergeTree系列，Merge和Distributed引擎的表</strong></p> <p>语法</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span>db<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token punctuation">[</span><span class="token keyword">ON</span> CLUSTER cluster<span class="token punctuation">]</span> <span class="token keyword">ADD</span><span class="token operator">|</span><span class="token keyword">DROP</span><span class="token operator">|</span><span class="token keyword">MODIFY</span> <span class="token keyword">COLUMN</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>参数解析</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> 向表中添加新列
 <span class="token keyword">DROP</span> <span class="token keyword">COLUMN</span>     在表中删除列
 <span class="token keyword">MODIFY</span> <span class="token keyword">COLUMN</span>   更改列的类型
</code></pre></div><p>演示</p> <p>（1）创建一个MergerTree引擎的表</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">create</span> <span class="token keyword">table</span> mt_table_demo1 <span class="token punctuation">(</span><span class="token keyword">date</span>  <span class="token keyword">Date</span><span class="token punctuation">,</span> id UInt8<span class="token punctuation">,</span> name String<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span>MergeTree<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>（2）向表中插入数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">insert</span> <span class="token keyword">into</span> mt_table_demo1 <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2019-05-01'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'zhangsan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">insert</span> <span class="token keyword">into</span> mt_table_demo1 <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2019-06-01'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'lisi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">insert</span> <span class="token keyword">into</span> mt_table_demo1 <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'2019-05-03'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'wangwu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>（3）新增age列</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token comment">--添加age列</span>
 node01 :<span class="token punctuation">)</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> mt_table_demo1 <span class="token keyword">add</span> <span class="token keyword">column</span> age UInt8<span class="token punctuation">;</span>
 
 <span class="token comment">--查看表结构</span>
 node01 :<span class="token punctuation">)</span> <span class="token keyword">desc</span> mt_table_demo1<span class="token punctuation">;</span>
 
 <span class="token keyword">DESCRIBE</span> <span class="token keyword">TABLE</span> mt_table_demo1
 
 ┌─name─┬─<span class="token keyword">type</span>───┬─default_type─┬─default_expression─┐
 │ <span class="token keyword">date</span> │ <span class="token keyword">Date</span>   │             │                   │
 │ id   │ UInt8 │             │                   │
 │ name │ String │             │                   │
 │ age │ UInt8 │             │                   │
 └──────┴────────┴──────────────┴────────────────────┘
 
 <span class="token comment">--查询表数据</span>
 node01 :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mt_table_demo1<span class="token punctuation">;</span>
 
 <span class="token keyword">SELECT</span> <span class="token operator">*</span>
 <span class="token keyword">FROM</span> mt_table_demo1 
 
 ┌───────<span class="token keyword">date</span>─┬─id─┬─name───┬─age─┐
 │ <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">03</span> │  <span class="token number">3</span> │ wangwu │   <span class="token number">0</span> │
 └────────────┴────┴────────┴─────┘
 ┌───────<span class="token keyword">date</span>─┬─id─┬─name─────┬─age─┐
 │ <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">01</span> │  <span class="token number">1</span> │ zhangsan │   <span class="token number">0</span> │
 └────────────┴────┴──────────┴─────┘
 ┌───────<span class="token keyword">date</span>─┬─id─┬─name─┬─age─┐
 │ <span class="token number">2019</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">01</span> │  <span class="token number">2</span> │ lisi │   <span class="token number">0</span> │
 └────────────┴────┴──────┴─────┘
</code></pre></div><p>（4）更改age列的类型</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token comment">--更改age列的类型为UInt16</span>
 node01 :<span class="token punctuation">)</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> mt_table_demo1 <span class="token keyword">modify</span> <span class="token keyword">column</span> age UInt16
 
 <span class="token comment">--查看表结构</span>
 node01 :<span class="token punctuation">)</span> <span class="token keyword">desc</span> mt_table_demo1<span class="token punctuation">;</span>
 
 <span class="token keyword">DESCRIBE</span> <span class="token keyword">TABLE</span> mt_table_demo1
 
 ┌─name─┬─<span class="token keyword">type</span>───┬─default_type─┬─default_expression─┐
 │ <span class="token keyword">date</span> │ <span class="token keyword">Date</span>   │             │                   │
 │ id   │ UInt8 │             │                   │
 │ name │ String │             │                   │
 │ age │ UInt16 │             │                   │
 └──────┴────────┴──────────────┴────────────────────┘
 
</code></pre></div><p>（5）删除age列</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token comment">--删除age列</span>
 node01 :<span class="token punctuation">)</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> mt_table_demo1 <span class="token keyword">drop</span> <span class="token keyword">column</span> age<span class="token punctuation">;</span>
 
 
 <span class="token comment">--查看表结构</span>
 node01 :<span class="token punctuation">)</span> <span class="token keyword">desc</span> mt_table_demo1<span class="token punctuation">;</span>               
 <span class="token keyword">DESCRIBE</span> <span class="token keyword">TABLE</span> mt_table_demo1
 
 ┌─name─┬─<span class="token keyword">type</span>───┬─default_type─┬─default_expression─┐
 │ <span class="token keyword">date</span> │ <span class="token keyword">Date</span>   │             │                   │
 │ id   │ UInt8 │             │                   │
 │ name │ String │             │                   │
 └──────┴────────┴──────────────┴────────────────────┘
</code></pre></div><h3 id="_7-4-check-table"><a href="#_7-4-check-table" class="header-anchor">#</a> 7.4 check table</h3> <p>检查表中的数据是否损坏，它会返回两种结果：</p> <p>0：表数据已损坏</p> <p>1：表数据完整</p> <p>该命令只支持Log、TinyLog和StripeLog引擎</p> <p>演示</p> <div class="language-sql extra-class"><pre class="language-sql"><code> node01 :<span class="token punctuation">)</span> <span class="token keyword">check</span> t1<span class="token punctuation">;</span>
 
 <span class="token keyword">CHECK</span> <span class="token keyword">TABLE</span> t1
 
 ┌─result─┐
 │      <span class="token number">1</span> │
 └────────┘
 
</code></pre></div><h2 id="_8-clickhouse集成外部存储系统"><a href="#_8-clickhouse集成外部存储系统" class="header-anchor">#</a> 8. clickhouse集成外部存储系统</h2> <h3 id="_8-1-kafka"><a href="#_8-1-kafka" class="header-anchor">#</a> 8.1 kafka</h3> <p>把消息从kafka集群中实时写入到clickhouse中</p> <h4 id="_8-1-1-创建一个topic"><a href="#_8-1-1-创建一个topic" class="header-anchor">#</a> 8.1.1 创建一个topic</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/kafka_2.11-1.1.0 
kafka-topics.sh --create --partitions <span class="token number">3</span> --replication-factor <span class="token number">2</span> --topic ck --zookeeper node01:2181,node02:2181,node03:2181
</code></pre></div><h4 id="_8-1-2-创建表"><a href="#_8-1-2-创建表" class="header-anchor">#</a> 8.1.2 创建表</h4> <p>在node01上启动 clickhouse-client -m 客户端，执行sql语句</p> <div class="language-sql extra-class"><pre class="language-sql"><code>  <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> queue <span class="token punctuation">(</span>
     <span class="token keyword">timestamp</span> UInt64<span class="token punctuation">,</span>
    <span class="token keyword">level</span> String<span class="token punctuation">,</span>
    message String
 <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> Kafka SETTINGS kafka_broker_list <span class="token operator">=</span><span class="token string">'node01:9092,node02:9092,node03:9092'</span><span class="token punctuation">,</span>
                            kafka_topic_list <span class="token operator">=</span> <span class="token string">'ck'</span><span class="token punctuation">,</span>
                            kafka_group_name <span class="token operator">=</span> <span class="token string">'consumer_ck'</span><span class="token punctuation">,</span>
                            kafka_format <span class="token operator">=</span> <span class="token string">'JSONEachRow'</span><span class="token punctuation">,</span>
                            kafka_num_consumers <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
                                                    
</code></pre></div><p>kafka_broker_list：指定kafka集群地址</p> <p>kafka_topic_list：topic 列表</p> <p>kafka_group_name：Kafka 消费组名称</p> <p>kafka_format：消息体格式，使用与 SQL 部分的 <code>FORMAT</code> 函数相同表示方法，例如 <code>JSONEachRow</code></p> <p>kafka_num_consumers：消费者线程数</p> <h4 id="_8-1-3-向topic写入数据"><a href="#_8-1-3-向topic写入数据" class="header-anchor">#</a> 8.1.3 向topic写入数据</h4> <p>利用脚本写数据到ck主题中</p> <div class="language-sh extra-class"><pre class="language-sh"><code>bin/kafka-console-producer.sh --broker-list node01:9092,node02:9092,node03:9092 --topic ck
<span class="token comment">##发送一条数据</span>
 <span class="token punctuation">{</span><span class="token string">&quot;timestamp&quot;</span>:153000000,<span class="token string">&quot;level&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1&quot;</span>,<span class="token string">&quot;message&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;hello ck&quot;</span><span class="token punctuation">}</span>
</code></pre></div><h4 id="_8-1-4-查询数据"><a href="#_8-1-4-查询数据" class="header-anchor">#</a> 8.1.4 查询数据</h4> <div class="language-sql extra-class"><pre class="language-sql"><code> node01 :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> queue<span class="token punctuation">;</span>
 
 <span class="token keyword">SELECT</span> <span class="token operator">*</span>
 <span class="token keyword">FROM</span> queue
 
 ┌─<span class="token keyword">timestamp</span>─┬─<span class="token keyword">level</span>─┬─message──┐
 │ <span class="token number">153000000</span> │ <span class="token number">1</span>     │ hello ck │
 └───────────┴───────┴──────────┘
</code></pre></div><p>笔记：</p> <div class="language- extra-class"><pre class="language-text"><code>clickhouse查询kafka当中的数据，查询一次之后，数据就没了？？？每次都是消费一批kafka当中的数据，消费完了，就没了

可以使用clickhouse去查询一批次的数据：最近五分钟的消费金额总和？？？
使用clickhouse每隔五分钟去查询一次kafak当中的数据即可
</code></pre></div><p>注意</p> <div class="language-sql extra-class"><pre class="language-sql"><code> 
 <span class="token comment">--这里使用select查询每条数据数据只能够读取一次。可以使用物化视图创建实时线程更实用。</span>
 <span class="token comment">--实现步骤：</span>
 <span class="token comment">--（1）使用引擎创建一个 Kafka 消费者并作为一条数据流。</span>
 <span class="token comment">--（2）创建一个结构表。</span>
 <span class="token comment">--（3）创建物化视图，改视图会在后台转换引擎中的数据并将其放入之前创建的表中。</span>
  <span class="token comment">--当 MATERIALIZED VIEW 添加至引擎，它将会在后台收集数据。可以持续不断地从 Kafka 收---集数据并通过 SELECT 将数据转换为所需要的格式。</span>
  
 <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> daily <span class="token punctuation">(</span>
    <span class="token keyword">day</span> <span class="token keyword">Date</span><span class="token punctuation">,</span>
    <span class="token keyword">level</span> String<span class="token punctuation">,</span>
    total UInt64
  <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> SummingMergeTree<span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span> <span class="token keyword">level</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
   <span class="token keyword">CREATE</span> MATERIALIZED <span class="token keyword">VIEW</span> consumer <span class="token keyword">TO</span> daily
     <span class="token keyword">AS</span> <span class="token keyword">SELECT</span> toDate<span class="token punctuation">(</span>toDateTime<span class="token punctuation">(</span><span class="token keyword">timestamp</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">day</span><span class="token punctuation">,</span> <span class="token keyword">level</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> total
     <span class="token keyword">FROM</span> queue <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">day</span><span class="token punctuation">,</span> <span class="token keyword">level</span><span class="token punctuation">;</span>
 
   <span class="token keyword">SELECT</span> <span class="token keyword">level</span><span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span> <span class="token keyword">FROM</span> daily <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">level</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_8-2-hdfs"><a href="#_8-2-hdfs" class="header-anchor">#</a> 8.2 HDFS</h3> <p>该引擎允许通过ClickHouse 管理HDFS上的数据，从而与Apache Hadoop生态系统集成。</p> <h4 id="_8-2-1-创建一张表"><a href="#_8-2-1-创建一张表" class="header-anchor">#</a> 8.2.1 创建一张表</h4> <p>格式：</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> HDFS<span class="token punctuation">(</span>URI<span class="token punctuation">,</span> format<span class="token punctuation">)</span>
 
 <span class="token comment">--URI:指定hdfs文件目录</span>
 <span class="token comment">--format:指定数据的格式</span>
</code></pre></div><p>演示：</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> hdfs_engine_table <span class="token punctuation">(</span>id Int32<span class="token punctuation">,</span> name String<span class="token punctuation">,</span> age Int32<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span>HDFS<span class="token punctuation">(</span><span class="token string">'hdfs://node01:8020/other_storage/*'</span><span class="token punctuation">,</span> <span class="token string">'CSV'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
 <span class="token comment">--数据来自于hdfs上other_storage目录下的所有文件</span>
 <span class="token comment">--文件的格式是CSV(字段之前的分隔符是逗号)</span>
</code></pre></div><p>支持的数据格式 ：</p> <p>https://clickhouse.tech/docs/zh/interfaces/formats/#formats</p> <h4 id="_8-2-2-准备数据"><a href="#_8-2-2-准备数据" class="header-anchor">#</a> 8.2.2 准备数据</h4> <p>node01执行以下命令创建文件，然后上传到hdfs对应文件夹</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install

<span class="token function">vim</span> file1.txt
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token number">1</span>,zhangsan,20
<span class="token number">2</span>,lisi,29
<span class="token number">3</span>,wangwu,25
<span class="token number">4</span>,zhaoliu,35
<span class="token number">5</span>,tianqi,35
<span class="token number">6</span>,kobe,40
</code></pre></div><p>上传文件到hdfs上对应的目录</p> <div class="language-sh extra-class"><pre class="language-sh"><code>hdfs  dfs -mkdir -p /other_storage 
hdfs dfs -put file1 /other_storage
</code></pre></div><h4 id="_8-2-3-查看表数据"><a href="#_8-2-3-查看表数据" class="header-anchor">#</a> 8.2.3 查看表数据</h4> <div class="language-sql extra-class"><pre class="language-sql"><code> node01 :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> hdfs_engine_table<span class="token punctuation">;</span>
 
 <span class="token keyword">SELECT</span> <span class="token operator">*</span>
 <span class="token keyword">FROM</span> hdfs_engine_table
 
 ┌─id─┬─name─────┬─age─┐
 │  <span class="token number">1</span> │ zhangsan │  <span class="token number">20</span> │
 │  <span class="token number">2</span> │ lisi     │  <span class="token number">29</span> │
 │  <span class="token number">3</span> │ wangwu   │  <span class="token number">25</span> │
 │  <span class="token number">4</span> │ zhaoliu │  <span class="token number">35</span> │
 │  <span class="token number">5</span> │ tianqi   │  <span class="token number">35</span> │
 │  <span class="token number">6</span> │ kobe     │  <span class="token number">40</span> │
 └────┴──────────┴─────┘
</code></pre></div><h2 id="_9-实战"><a href="#_9-实战" class="header-anchor">#</a> 9. 实战</h2> <p>需求：基于clickhouse对航班飞行数据进行分析处理</p> <h3 id="_9-1-准备数据"><a href="#_9-1-准备数据" class="header-anchor">#</a> 9.1 准备数据</h3> <p>node01服务器执行以下命令，创建shell脚本</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> yum -y <span class="token function">install</span> <span class="token function">wget</span>

<span class="token builtin class-name">cd</span> /kkb/install/

<span class="token function">vim</span> down_data.sh
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token shebang important">#!/bin/bash</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">s</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">seq</span> <span class="token number">1987</span> <span class="token number">2018</span><span class="token variable">`</span></span>
<span class="token keyword">do</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">m</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">seq</span> <span class="token number">1</span> <span class="token number">12</span><span class="token variable">`</span></span>
<span class="token keyword">do</span>
 <span class="token function">wget</span> https://transtats.bts.gov/PREZIP/On_Time_Reporting_Carrier_On_Time_Performance_1987_present_<span class="token variable">${s}</span>
_<span class="token variable">${m}</span>.zip
<span class="token keyword">done</span>
<span class="token keyword">done</span>
</code></pre></div><p>该脚本主要是为了下载从1987年到 2018年航班飞行数据，由于数据量比较大，这里只使用1988年和1989年的飞行数据</p> <p><img src="/assets/img/clip_image006.7d3e6c11.jpg" alt="img"></p> <h3 id="_9-2-创建表"><a href="#_9-2-创建表" class="header-anchor">#</a> 9.2 创建表</h3> <p>node01服务器进入clickhouse的客户端，然后准备创建表</p> <p>click-</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>ontime<span class="token punctuation">`</span> <span class="token punctuation">(</span>
   <span class="token punctuation">`</span><span class="token keyword">Year</span><span class="token punctuation">`</span> UInt16<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Quarter<span class="token punctuation">`</span> UInt8<span class="token punctuation">,</span>
   <span class="token punctuation">`</span><span class="token keyword">Month</span><span class="token punctuation">`</span> UInt8<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DayofMonth<span class="token punctuation">`</span> UInt8<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DayOfWeek<span class="token punctuation">`</span> UInt8<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>FlightDate<span class="token punctuation">`</span> <span class="token keyword">Date</span><span class="token punctuation">,</span>
   <span class="token punctuation">`</span>UniqueCarrier<span class="token punctuation">`</span> FixedString<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token punctuation">`</span>AirlineID<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Carrier<span class="token punctuation">`</span> FixedString<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token punctuation">`</span>TailNum<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>FlightNum<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>OriginAirportID<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>OriginAirportSeqID<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>OriginCityMarketID<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Origin<span class="token punctuation">`</span> FixedString<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token punctuation">`</span>OriginCityName<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>OriginState<span class="token punctuation">`</span> FixedString<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token punctuation">`</span>OriginStateFips<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>OriginStateName<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>OriginWac<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DestAirportID<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DestAirportSeqID<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DestCityMarketID<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Dest<span class="token punctuation">`</span> FixedString<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DestCityName<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DestState<span class="token punctuation">`</span> FixedString<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DestStateFips<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DestStateName<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DestWac<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>CRSDepTime<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DepTime<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DepDelay<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DepDelayMinutes<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DepDel15<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DepartureDelayGroups<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DepTimeBlk<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>TaxiOut<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>WheelsOff<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>WheelsOn<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>TaxiIn<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>CRSArrTime<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>ArrTime<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>ArrDelay<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>ArrDelayMinutes<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>ArrDel15<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>ArrivalDelayGroups<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>ArrTimeBlk<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Cancelled<span class="token punctuation">`</span> UInt8<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>CancellationCode<span class="token punctuation">`</span> FixedString<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Diverted<span class="token punctuation">`</span> UInt8<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>CRSElapsedTime<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>ActualElapsedTime<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>AirTime<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Flights<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Distance<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DistanceGroup<span class="token punctuation">`</span> UInt8<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>CarrierDelay<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>WeatherDelay<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>NASDelay<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>SecurityDelay<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>LateAircraftDelay<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>FirstDepTime<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>TotalAddGTime<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>LongestAddGTime<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DivAirportLandings<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DivReachedDest<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DivActualElapsedTime<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DivArrDelay<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>DivDistance<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div1Airport<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div1AirportID<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div1AirportSeqID<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div1WheelsOn<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div1TotalGTime<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div1LongestGTime<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div1WheelsOff<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div1TailNum<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div2Airport<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div2AirportID<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div2AirportSeqID<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div2WheelsOn<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div2TotalGTime<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div2LongestGTime<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div2WheelsOff<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div2TailNum<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div3Airport<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div3AirportID<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div3AirportSeqID<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div3WheelsOn<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div3TotalGTime<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div3LongestGTime<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div3WheelsOff<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div3TailNum<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div4Airport<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div4AirportID<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div4AirportSeqID<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div4WheelsOn<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div4TotalGTime<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div4LongestGTime<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div4WheelsOff<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div4TailNum<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div5Airport<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div5AirportID<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div5AirportSeqID<span class="token punctuation">`</span> Int32<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div5WheelsOn<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div5TotalGTime<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div5LongestGTime<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div5WheelsOff<span class="token punctuation">`</span> String<span class="token punctuation">,</span>
   <span class="token punctuation">`</span>Div5TailNum<span class="token punctuation">`</span> String
 <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span>FlightDate<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">Year</span><span class="token punctuation">,</span> FlightDate<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_9-3-加载数据到表中"><a href="#_9-3-加载数据到表中" class="header-anchor">#</a> 9.3 加载数据到表中</h3> <p>在数据所在的目录执行下面命令</p> <p>将所有的数据上传到node01服务器的/kkb/soft/flydatas路径下</p> <p>然后执行以下命令加载数据</p> <div class="language- extra-class"><pre class="language-text"><code>sudo yum -y install unzip
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> *.zip<span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token variable">$i</span><span class="token punctuation">;</span> <span class="token function">unzip</span> -cq <span class="token variable">$i</span> <span class="token string">'*.csv'</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/\.00//g'</span> <span class="token operator">|</span> clickhouse-client  --query<span class="token operator">=</span><span class="token string">&quot;INSERT INTO ontime FORMAT CSVWithNames&quot;</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre></div><p>·    加载成功后，查看表数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code> node01 :<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> ontime<span class="token punctuation">;</span> 
 
 <span class="token keyword">SELECT</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
 <span class="token keyword">FROM</span> ontime 
 
 ┌──<span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>─┐
 │ <span class="token number">10243296</span> │
 └──────────┘
 
 <span class="token number">1</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">.</span> Elapsed: <span class="token number">0.005</span> sec<span class="token punctuation">.</span> Processed <span class="token number">10.24</span> million <span class="token keyword">rows</span><span class="token punctuation">,</span> <span class="token number">10.24</span> MB <span class="token punctuation">(</span><span class="token number">2.26</span> billion <span class="token keyword">rows</span><span class="token operator">/</span>s<span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">2.26</span> GB<span class="token operator">/</span>s<span class="token punctuation">.</span><span class="token punctuation">)</span> 
</code></pre></div><h3 id="_9-4-需求指标分析"><a href="#_9-4-需求指标分析" class="header-anchor">#</a> 9.4 需求指标分析</h3> <h4 id="_9-4-1-查询所有月份中航班数的最大值、最小值、平均值"><a href="#_9-4-1-查询所有月份中航班数的最大值、最小值、平均值" class="header-anchor">#</a> 9.4.1 查询所有月份中航班数的最大值、最小值、平均值</h4> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">SELECT</span> <span class="token function">max</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">min</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span>
  <span class="token keyword">FROM</span>
 <span class="token punctuation">(</span>
     <span class="token keyword">SELECT</span> <span class="token keyword">Year</span><span class="token punctuation">,</span> <span class="token keyword">Month</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> c1
      <span class="token keyword">FROM</span> ontime
      <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">Year</span><span class="token punctuation">,</span> <span class="token keyword">Month</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 ┌─<span class="token function">max</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span>─┬─<span class="token function">min</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span>─┬─<span class="token function">avg</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span>─┐
 │  <span class="token number">446769</span> │  <span class="token number">395176</span> │  <span class="token number">426804</span> │
 └─────────┴─────────┴─────────┘
</code></pre></div><h4 id="_9-4-2-查询从1988年到1989年中周内的航班数"><a href="#_9-4-2-查询从1988年到1989年中周内的航班数" class="header-anchor">#</a> 9.4.2 查询从1988年到1989年中周内的航班数</h4> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">SELECT</span> DayOfWeek<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> c
 <span class="token keyword">FROM</span> ontime
 <span class="token keyword">WHERE</span> <span class="token keyword">Year</span><span class="token operator">&gt;=</span><span class="token number">1988</span> <span class="token operator">AND</span> <span class="token keyword">Year</span><span class="token operator">&lt;=</span><span class="token number">1989</span>
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> DayOfWeek
 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> c <span class="token keyword">desc</span><span class="token punctuation">;</span>
 
 ┌─DayOfWeek─┬───────c─┐
 │         <span class="token number">5</span> │ <span class="token number">1497912</span> │
 │         <span class="token number">3</span> │ <span class="token number">1493143</span> │
 │         <span class="token number">2</span> │ <span class="token number">1492544</span> │
 │         <span class="token number">1</span> │ <span class="token number">1489357</span> │
 │         <span class="token number">4</span> │ <span class="token number">1484423</span> │
 │         <span class="token number">7</span> │ <span class="token number">1420042</span> │
 │         <span class="token number">6</span> │ <span class="token number">1365875</span> │
 └───────────┴─────────┘
</code></pre></div><h4 id="_9-4-3-查询从1988年到1989年中周内延误超过10分钟的航班数。"><a href="#_9-4-3-查询从1988年到1989年中周内延误超过10分钟的航班数。" class="header-anchor">#</a> 9.4.3 查询从1988年到1989年中周内延误超过10分钟的航班数。</h4> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">SELECT</span> DayOfWeek<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> c
 <span class="token keyword">FROM</span> ontime
 <span class="token keyword">WHERE</span> DepDelay<span class="token operator">&gt;</span><span class="token number">10</span> <span class="token operator">AND</span> <span class="token keyword">Year</span><span class="token operator">&gt;=</span><span class="token number">1988</span> <span class="token operator">AND</span> <span class="token keyword">Year</span><span class="token operator">&lt;=</span><span class="token number">1989</span>
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> DayOfWeek
 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> c <span class="token keyword">DESC</span><span class="token punctuation">;</span>
 
 ┌─DayOfWeek─┬──────c─┐
 │         <span class="token number">4</span> │ <span class="token number">307762</span> │
 │         <span class="token number">5</span> │ <span class="token number">304375</span> │
 │         <span class="token number">3</span> │ <span class="token number">290879</span> │
 │         <span class="token number">2</span> │ <span class="token number">270656</span> │
 │         <span class="token number">1</span> │ <span class="token number">243052</span> │
 │         <span class="token number">7</span> │ <span class="token number">234229</span> │
 │         <span class="token number">6</span> │ <span class="token number">219208</span> │
 └───────────┴────────┘
</code></pre></div><h4 id="_9-4-4-查询1988年到1989年每个机场延误超过10分钟以上的次数"><a href="#_9-4-4-查询1988年到1989年每个机场延误超过10分钟以上的次数" class="header-anchor">#</a> 9.4.4 查询1988年到1989年每个机场延误超过10分钟以上的次数</h4> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">SELECT</span> Origin<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> c
 <span class="token keyword">FROM</span> ontime
 <span class="token keyword">WHERE</span> DepDelay<span class="token operator">&gt;</span><span class="token number">10</span> <span class="token operator">AND</span> <span class="token keyword">Year</span><span class="token operator">&gt;=</span><span class="token number">1988</span> <span class="token operator">AND</span> <span class="token keyword">Year</span><span class="token operator">&lt;=</span><span class="token number">1989</span>
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> Origin
 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> c <span class="token keyword">DESC</span>
 <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>
 
 
 ┌─Origin──┬──────c─┐
 │ ORD\<span class="token number">0</span>\<span class="token number">0</span> │ <span class="token number">138100</span> │
 │ DFW\<span class="token number">0</span>\<span class="token number">0</span> │  <span class="token number">80991</span> │
 │ ATL\<span class="token number">0</span>\<span class="token number">0</span> │  <span class="token number">80184</span> │
 │ CLT\<span class="token number">0</span>\<span class="token number">0</span> │  <span class="token number">68363</span> │
 │ PIT\<span class="token number">0</span>\<span class="token number">0</span> │  <span class="token number">67484</span> │
 │ LAX\<span class="token number">0</span>\<span class="token number">0</span> │  <span class="token number">63626</span> │
 │ DEN\<span class="token number">0</span>\<span class="token number">0</span> │  <span class="token number">60269</span> │
 │ SFO\<span class="token number">0</span>\<span class="token number">0</span> │  <span class="token number">58458</span> │
 │ EWR\<span class="token number">0</span>\<span class="token number">0</span> │  <span class="token number">55438</span> │
 │ STL\<span class="token number">0</span>\<span class="token number">0</span> │  <span class="token number">53238</span> │
 └─────────┴────────┘
</code></pre></div><h4 id="_9-4-5-查询1988年各航空公司延误超过10分钟以上的次数"><a href="#_9-4-5-查询1988年各航空公司延误超过10分钟以上的次数" class="header-anchor">#</a> 9.4.5 查询1988年各航空公司延误超过10分钟以上的次数</h4> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">SELECT</span> Carrier<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> num
 <span class="token keyword">FROM</span> ontime
 <span class="token keyword">WHERE</span> DepDelay<span class="token operator">&gt;</span><span class="token number">10</span> <span class="token operator">AND</span> <span class="token keyword">Year</span><span class="token operator">=</span><span class="token number">1988</span>
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> Carrier
 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> num <span class="token keyword">DESC</span><span class="token punctuation">;</span>
 
 
 ┌─Carrier─┬────num─┐
 │ UA     │ <span class="token number">113208</span> │
 │ AA     │  <span class="token number">96946</span> │
 │ DL     │  <span class="token number">96443</span> │
 │ PI     │  <span class="token number">94642</span> │
 │ CO     │  <span class="token number">80925</span> │
 │ AL     │  <span class="token number">78368</span> │
 │ EA     │  <span class="token number">66918</span> │
 │ NW     │  <span class="token number">64962</span> │
 │ TW     │  <span class="token number">51121</span> │
 │ WN     │  <span class="token number">44572</span> │
 │ US     │  <span class="token number">26604</span> │
 │ HP     │  <span class="token number">21175</span> │
 │ <span class="token keyword">AS</span>     │  <span class="token number">13352</span> │
 │ PA     │  <span class="token number">10181</span> │
 │ PS     │   <span class="token number">5020</span> │
 └─────────┴────────┘
</code></pre></div><h4 id="_9-4-6-查询1988年各航空公司延误超过10分钟以上的百分比"><a href="#_9-4-6-查询1988年各航空公司延误超过10分钟以上的百分比" class="header-anchor">#</a> 9.4.6 查询1988年各航空公司延误超过10分钟以上的百分比</h4> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">SELECT</span> Carrier<span class="token punctuation">,</span> c<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span>c2 <span class="token keyword">as</span> c3
 <span class="token keyword">FROM</span>
 <span class="token punctuation">(</span>
     <span class="token keyword">SELECT</span>
        Carrier<span class="token punctuation">,</span>
         <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> c
     <span class="token keyword">FROM</span> ontime
     <span class="token keyword">WHERE</span> DepDelay<span class="token operator">&gt;</span><span class="token number">10</span>
         <span class="token operator">AND</span> <span class="token keyword">Year</span><span class="token operator">=</span><span class="token number">1988</span>
     <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> Carrier
 <span class="token punctuation">)</span>
 <span class="token keyword">ANY</span> <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span>
 <span class="token punctuation">(</span>
     <span class="token keyword">SELECT</span>
        Carrier<span class="token punctuation">,</span>
         <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> c2
     <span class="token keyword">FROM</span> ontime
     <span class="token keyword">WHERE</span> <span class="token keyword">Year</span><span class="token operator">=</span><span class="token number">1988</span>
     <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> Carrier
 <span class="token punctuation">)</span> <span class="token keyword">USING</span> Carrier
 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> c3 <span class="token keyword">DESC</span><span class="token punctuation">;</span>
 
 <span class="token comment">---更好的查询版本</span>
 <span class="token keyword">SELECT</span> Carrier<span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>DepDelay<span class="token operator">&gt;</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span> <span class="token keyword">AS</span> c3
 <span class="token keyword">FROM</span> ontime
 <span class="token keyword">WHERE</span> <span class="token keyword">Year</span><span class="token operator">=</span><span class="token number">1988</span>
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> Carrier
 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> Carrier
 
 
 ┌─Carrier─┬──────c─┬─────c2─┬─────────────────c3─┐
 │ AL     │  <span class="token number">78368</span> │ <span class="token number">361059</span> │ <span class="token number">21.705039896526607</span> │
 │ PI     │  <span class="token number">94642</span> │ <span class="token number">470957</span> │ <span class="token number">20.095677524699706</span> │
 │ US     │  <span class="token number">26604</span> │ <span class="token number">133324</span> │ <span class="token number">19.954396807776543</span> │
 │ UA     │ <span class="token number">113208</span> │ <span class="token number">587144</span> │ <span class="token number">19.281130353030942</span> │
 │ TW     │  <span class="token number">51121</span> │ <span class="token number">275819</span> │ <span class="token number">18.534256160743094</span> │
 │ CO     │  <span class="token number">80925</span> │ <span class="token number">457031</span> │  <span class="token number">17.70667635236997</span> │
 │ EA     │  <span class="token number">66918</span> │ <span class="token number">389292</span> │  <span class="token number">17.18966739619617</span> │
 │ WN     │  <span class="token number">44572</span> │ <span class="token number">262422</span> │ <span class="token number">16.984856452584005</span> │
 │ NW     │  <span class="token number">64962</span> │ <span class="token number">431440</span> │ <span class="token number">15.057018357129612</span> │
 │ <span class="token keyword">AS</span>     │  <span class="token number">13352</span> │  <span class="token number">89822</span> │ <span class="token number">14.864955133486228</span> │
 │ PA     │  <span class="token number">10181</span> │  <span class="token number">72264</span> │ <span class="token number">14.088619506254844</span> │
 │ AA     │  <span class="token number">96946</span> │ <span class="token number">694757</span> │ <span class="token number">13.953943609060435</span> │
 │ DL     │  <span class="token number">96443</span> │ <span class="token number">753983</span> │ <span class="token number">12.791137200706117</span> │
 │ PS     │   <span class="token number">5020</span> │  <span class="token number">41911</span> │   <span class="token number">11.9777624012789</span> │
 │ HP     │  <span class="token number">21175</span> │ <span class="token number">180871</span> │ <span class="token number">11.707238860845575</span> │
 └─────────┴────────┴────────┴────────────────────┘
</code></pre></div><h4 id="_9-4-7-同上一个查询一致-只是查询范围扩大到1988年到1989年"><a href="#_9-4-7-同上一个查询一致-只是查询范围扩大到1988年到1989年" class="header-anchor">#</a> 9.4.7 同上一个查询一致,只是查询范围扩大到1988年到1989年</h4> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">SELECT</span> Carrier<span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>DepDelay<span class="token operator">&gt;</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span> <span class="token keyword">AS</span> c3
 <span class="token keyword">FROM</span> ontime
 <span class="token keyword">WHERE</span>  <span class="token keyword">Year</span><span class="token operator">&gt;=</span><span class="token number">1988</span> <span class="token operator">AND</span> <span class="token keyword">Year</span><span class="token operator">&lt;=</span><span class="token number">1989</span>
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> Carrier
 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> Carrier<span class="token punctuation">;</span>
 ┌─Carrier─┬─────────────────c3─┐
 │ AA     │ <span class="token number">14.973459265773348</span> │
 │ AL     │ <span class="token number">21.705039896526607</span> │
 │ <span class="token keyword">AS</span>     │ <span class="token number">14.402829935622318</span> │
 │ CO     │  <span class="token number">16.96160617418744</span> │
 │ DL     │ <span class="token number">14.788366379301934</span> │
 │ EA     │ <span class="token number">16.675253490185977</span> │
 │ HP     │ <span class="token number">13.738282256500709</span> │
 │ NW     │ <span class="token number">14.799160318481144</span> │
 │ PA     │  <span class="token number">15.59199720311088</span> │
 │ PI     │ <span class="token number">24.084359219776232</span> │
 │ PS     │   <span class="token number">11.9777624012789</span> │
 │ TW     │ <span class="token number">18.715348820366113</span> │
 │ UA     │  <span class="token number">22.14408797247073</span> │
 │ US     │ <span class="token number">25.955873831985677</span> │
 │ WN     │ <span class="token number">20.385723408269595</span> │
 └─────────┴────────────────────┘
</code></pre></div><h4 id="_9-4-8-每年航班延误超过10分钟的百分比"><a href="#_9-4-8-每年航班延误超过10分钟的百分比" class="header-anchor">#</a> 9.4.8 每年航班延误超过10分钟的百分比</h4> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">SELECT</span> <span class="token keyword">Year</span><span class="token punctuation">,</span> c1<span class="token operator">/</span>c2
 <span class="token keyword">FROM</span>
 <span class="token punctuation">(</span>
     <span class="token keyword">select</span>
         <span class="token keyword">Year</span><span class="token punctuation">,</span>
         <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span> <span class="token keyword">as</span> c1
     <span class="token keyword">from</span> ontime
     <span class="token keyword">WHERE</span> DepDelay<span class="token operator">&gt;</span><span class="token number">10</span>
     <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">Year</span>
 <span class="token punctuation">)</span>
 <span class="token keyword">ANY</span> <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span>
 <span class="token punctuation">(</span>
     <span class="token keyword">select</span>
         <span class="token keyword">Year</span><span class="token punctuation">,</span>
         <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> c2
     <span class="token keyword">from</span> ontime
     <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">Year</span>
 <span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token punctuation">(</span><span class="token keyword">Year</span><span class="token punctuation">)</span>
 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">Year</span><span class="token punctuation">;</span>
 
 <span class="token comment">---更好的查询版本</span>
 <span class="token keyword">SELECT</span> <span class="token keyword">Year</span><span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>DepDelay<span class="token operator">&gt;</span><span class="token number">10</span><span class="token punctuation">)</span>
 <span class="token keyword">FROM</span> ontime
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">Year</span>
 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">Year</span><span class="token punctuation">;</span>
 
 ┌─<span class="token keyword">Year</span>─┬─────divide<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span>─┐
 │ <span class="token number">1988</span> │  <span class="token number">16.61709049583091</span> │
 │ <span class="token number">1989</span> │ <span class="token number">19.950091248115527</span> │
 └──────┴────────────────────┘
</code></pre></div><h4 id="_9-4-9-每年更受人们喜爱的目的地"><a href="#_9-4-9-每年更受人们喜爱的目的地" class="header-anchor">#</a> 9.4.9 每年更受人们喜爱的目的地</h4> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">SELECT</span> DestCityName<span class="token punctuation">,</span> uniqExact<span class="token punctuation">(</span>OriginCityName<span class="token punctuation">)</span> <span class="token keyword">AS</span> u
 <span class="token keyword">FROM</span> ontime
 <span class="token keyword">WHERE</span> <span class="token keyword">Year</span> <span class="token operator">&gt;=</span> <span class="token number">1988</span> <span class="token operator">and</span> <span class="token keyword">Year</span> <span class="token operator">&lt;=</span> <span class="token number">1989</span>
 <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> DestCityName
 <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> u <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>
 
 <span class="token comment">--uniqExact去重</span>
 
 ┌─DestCityName──────────┬───u─┐
 │ Chicago<span class="token punctuation">,</span> IL           │ <span class="token number">111</span> │
 │ Atlanta<span class="token punctuation">,</span> GA           │  <span class="token number">92</span> │
 │ Dallas<span class="token operator">/</span>Fort Worth<span class="token punctuation">,</span> TX │  <span class="token number">89</span> │
 │ Denver<span class="token punctuation">,</span> CO           │  <span class="token number">86</span> │
 │ Pittsburgh<span class="token punctuation">,</span> PA       │  <span class="token number">79</span> │
 │ St<span class="token punctuation">.</span> Louis<span class="token punctuation">,</span> MO         │  <span class="token number">78</span> │
 │ Minneapolis<span class="token punctuation">,</span> MN       │  <span class="token number">75</span> │
 │ Charlotte<span class="token punctuation">,</span> NC         │  <span class="token number">69</span> │
 │ Detroit<span class="token punctuation">,</span> MI           │  <span class="token number">69</span> │
 │ Phoenix<span class="token punctuation">,</span> AZ           │  <span class="token number">67</span> │
 └───────────────────────┴─────┘
</code></pre></div><h2 id="_10、hive表迁移到clickhouse"><a href="#_10、hive表迁移到clickhouse" class="header-anchor">#</a> 10、hive表迁移到clickHouse</h2> <p>由于历史原因，很多公司的历史数仓都是基于hive构建，数据表都是存储在hive当中，如何实现hive表数据迁移到clickHouse就至关重要了，接下来我们来一起看看如何将hive表数据全部平滑的迁移到clickHouse里面来</p> <p>由于我们hive的数据全部都是存储在hdfs上面的，所以我们<strong>直接将hdfs的数据加载到clickhouse里面创建的表里面来即可</strong>，我们可以<strong>通过第三方插件例如datax或者waterdrop等数据传输工具，将hdfs的数据全部采集到clickhouse里面来即可</strong></p> <p>需求：<strong>将hive数据仓库当中的game_center这个库的ods_user_login表数据迁移到clickHouse表里面来</strong></p> <p>这里涉及到数据的迁移，将hive当中的表数据迁移到clickHouse里面来，数据迁移的工具很多，例如sqoop，datax，waterdrop等，其中有一个比较优秀的插件叫做waterdrop的，可以非常方便的实现我们各种数据的迁移，官网链接如下：</p> <p>https://interestinglab.github.io/waterdrop/#/</p> <p>通过简单的配置即可，我们就可以通过waterdrop将各个地方的数据进行抽取到各个目的地去</p> <h3 id="_1、waterdrop的基本介绍"><a href="#_1、waterdrop的基本介绍" class="header-anchor">#</a> 1、waterdrop的基本介绍</h3> <p>官网链接如下：</p> <p>https://interestinglab.github.io/waterdrop/#/</p> <p>通过简单的配置即可，我们就可以通过waterdrop将各个地方的数据进行抽取到各个目的地去</p> <p><img src="/assets/img/clip_image008.584dbb3f.jpg" alt="img"></p> <p><img src="/assets/img/clip_image010.d9cecb93.png" alt="img"></p> <h3 id="_2、waterdrop的安装与使用"><a href="#_2、waterdrop的安装与使用" class="header-anchor">#</a> 2、waterdrop的安装与使用</h3> <p>waterdrop使用<strong>spark的引擎</strong>来实现数据的抽取和传输到目的地，所以<strong>使用waterdrop之前需要我们先安装好spark的环境，</strong></p> <p>运行环境要求：</p> <p>java运行环境，java &gt;= 8</p> <p>如果您要在集群环境中运行Waterdrop，那么需要以下Spark集群环境的任意一种：</p> <ul><li><p>Spark on Yarn</p></li> <li><p>Spark Standalone</p></li> <li><p>Spark on Mesos</p></li></ul> <p>如果您的数据量较小或者只是做功能验证，也可以仅使用local模式启动，无需集群环境，Waterdrop支持单机运行。</p> <p>waterdrop不支持spark1.x的各种版本，<strong>最低需要安装spark2.x的版本</strong>，如果使用spark2.3.x的版本，那么waterdrop需要1.4.x及以上的版本</p> <h4 id="第一步-安装spark集群"><a href="#第一步-安装spark集群" class="header-anchor">#</a> 第一步：安装spark集群</h4> <p>我们这里已经安装成功，不用再进行安装，并且我们使用的spark集群版本是2.3.x版本</p> <h4 id="第二步-集成spark与hive"><a href="#第二步-集成spark与hive" class="header-anchor">#</a> 第二步：集成spark与hive</h4> <p>由于我们需要将hive表当中的数据，导入到clickhouse当中去，而waterdrop又是借助于spark来进行数据抽取的，所以我们<strong>需要整合spark与hive</strong></p> <p>node03执行以下命令，拷贝hive-site.xml</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/hive-1.1.0-cdh5.14.2/conf
<span class="token function">scp</span> hive-site.xml  node01:/kkb/install/spark/conf/
<span class="token function">scp</span> hive-site.xml  node02:/kkb/install/spark/conf/
<span class="token function">scp</span> hive-site.xml  node03:/kkb/install/spark/conf/
</code></pre></div><h4 id="第三步-启动hive的metastore以及hiveserver2服务"><a href="#第三步-启动hive的metastore以及hiveserver2服务" class="header-anchor">#</a> 第三步：启动hive的metastore以及hiveserver2服务</h4> <p>使用spark作为引擎，读取hive表数据，我们<strong>需要启动hive的metastore服务</strong>，node03执行以下命令启动hivedemetastore服务即可</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/hive-1.1.0-cdh5.14.2/
bin/hive --service metastore  <span class="token comment">#若配置了环境变量，则 hive --service metastore</span>
bin/hive --service hiveserver2 
</code></pre></div><h4 id="第四步-下载安装waterdrop-node02上"><a href="#第四步-下载安装waterdrop-node02上" class="header-anchor">#</a> 第四步：下载安装waterdrop（node02上）</h4> <p>我们这里使用waterdrop1.4.2的这个版本，waterdrop的下载地址如下：</p> <p>https://github.com/InterestingLab/waterdrop/releases/download/v1.4.2/waterdrop-1.4.2.zip</p> <p><strong>node02</strong>执行以下命令下载waterdrop</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/soft/
<span class="token function">sudo</span> yum -y <span class="token function">install</span> <span class="token function">wget</span>
<span class="token function">wget</span> https://github.com/InterestingLab/waterdrop/releases/download/v1.4.2/waterdrop-1.4.2.zip
</code></pre></div><p>node02执行以下命令进行解压</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> yum -y <span class="token function">install</span> <span class="token function">unzip</span>

<span class="token function">unzip</span> waterdrop-1.4.2.zip -d /kkb/install/
</code></pre></div><h4 id="第五步-修改waterdrop的配置文件"><a href="#第五步-修改waterdrop的配置文件" class="header-anchor">#</a> 第五步：修改waterdrop的配置文件</h4> <p>node02服务器执行以下命令，修改配置文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/waterdrop-1.4.2/config
<span class="token function">vim</span> waterdrop-env.sh
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">SPARK_HOME</span><span class="token operator">=</span>/kkb/install/spark
</code></pre></div><h4 id="第六步-创建clickhouse数据库以及数据库表"><a href="#第六步-创建clickhouse数据库以及数据库表" class="header-anchor">#</a> 第六步：创建clickhouse数据库以及数据库表</h4> <p><strong>node02服务器</strong>进入到clickHouse客户端，然后创建数据库以及数据库表</p> <div class="language-sh extra-class"><pre class="language-sh"><code>clickhouse-client -m
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code>node02 :<span class="token punctuation">)</span> <span class="token keyword">create</span> <span class="token keyword">database</span> game_center<span class="token punctuation">;</span>
node02 :<span class="token punctuation">)</span> <span class="token keyword">use</span> game_center<span class="token punctuation">;</span>
</code></pre></div><p>创建clickHouse表</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> game_center<span class="token punctuation">.</span>ods_user_login
<span class="token punctuation">(</span>
    plat_id                 String  <span class="token punctuation">,</span>
    server_id               Int32     <span class="token punctuation">,</span>
    channel_id              String  <span class="token punctuation">,</span>
    user_id                 String  <span class="token punctuation">,</span>
    role_id                 String  <span class="token punctuation">,</span>
    role_name               String  <span class="token punctuation">,</span>
    client_ip               String  <span class="token punctuation">,</span>
    event_time              Int32     <span class="token punctuation">,</span>
    op_type                 String  <span class="token punctuation">,</span>
  online_time             Int32     <span class="token punctuation">,</span>
  operating_system        String  <span class="token punctuation">,</span>
  operating_version       String  <span class="token punctuation">,</span>
  device_brand            String  <span class="token punctuation">,</span>
  device_type             String  <span class="token punctuation">,</span>
  part_date               <span class="token keyword">date</span> 
  
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> MergeTree <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> part_date <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>part_date<span class="token punctuation">)</span> SETTINGS index_granularity <span class="token operator">=</span> <span class="token number">16384</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="第七步-开发clickhouse数据处理配置文件"><a href="#第七步-开发clickhouse数据处理配置文件" class="header-anchor">#</a> 第七步：开发clickHouse数据处理配置文件</h4> <p>node02执行以下命令开发waterdrop的配置文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/waterdrop-1.4.2/config
<span class="token function">vim</span> batch.conf
</code></pre></div><p>配置文件内容如下</p> <div class="language-sql extra-class"><pre class="language-sql"><code>spark {
  spark<span class="token punctuation">.</span>app<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Waterdrop&quot;</span>
  spark<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>instances <span class="token operator">=</span> <span class="token number">2</span>
  spark<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>cores <span class="token operator">=</span> <span class="token number">1</span>
  spark<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>memory <span class="token operator">=</span> <span class="token string">&quot;1g&quot;</span>
  spark<span class="token punctuation">.</span><span class="token keyword">sql</span><span class="token punctuation">.</span>catalogImplementation <span class="token operator">=</span> <span class="token string">&quot;hive&quot;</span>
}

input {
   hive {
        pre_sql <span class="token operator">=</span> <span class="token string">&quot;select * from game_center.ods_user_login&quot;</span>
        result_table_name <span class="token operator">=</span> <span class="token string">&quot;ods_user_login2&quot;</span>
        table_name <span class="token operator">=</span> <span class="token string">&quot;ods_user_login2&quot;</span>
    }

 }
filter {
  <span class="token comment">## split data by specific delimiter</span>
  }

output {
   clickhouse {
        host <span class="token operator">=</span> <span class="token string">&quot;node02:8123&quot;</span>
        <span class="token keyword">database</span> <span class="token operator">=</span> <span class="token string">&quot;game_center&quot;</span>
        <span class="token keyword">table</span> <span class="token operator">=</span> <span class="token string">&quot;ods_user_login&quot;</span>
        <span class="token keyword">fields</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;plat_id&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;server_id&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;channel_id&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;role_id&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;role_name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;client_ip&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;event_time&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;op_type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;online_time&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;operating_system&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;operating_version&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;device_brand&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;device_type&quot;</span><span class="token punctuation">]</span>
        username <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
        password <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
    }
}
</code></pre></div><h4 id="第八步-启动waterdrop导入数据到clickhouse表当中去"><a href="#第八步-启动waterdrop导入数据到clickhouse表当中去" class="header-anchor">#</a> 第八步：启动waterdrop导入数据到clickhouse表当中去</h4> <p>node02执行以下命令，启动waterdrop开始导入数据</p> <p>使用spark的local模式进行运行</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/waterdrop-1.4.2/  
bin/start-waterdrop.sh --config config/batch.conf -e client -m <span class="token string">'local[2]'</span>
</code></pre></div><p>如果想要使用spark的standAlone模式进行运行，通过以下方式进行提交(<strong>必须确保spark已开启，而且--master对应的master是alive状态，batch.conf是上面那个自己创建的配置文件</strong>)</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/waterdrop-1.4.2/  
<span class="token comment">## client 模式</span>
./bin/start-waterdrop.sh --master spark://node01:7077 --deploy-mode client --config ./config/batch.conf

<span class="token comment">## cluster 模式</span>
./bin/start-waterdrop.sh --master spark://node01:7077 --deploy-mode cluster --config ./config/batch.conf
</code></pre></div><p>如果想要使用spark on yarn模式进行提交，那么通过以下方式进行提交</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## client 模式</span>
./bin/start-waterdrop.sh --master <span class="token function">yarn</span> --deploy-mode client --config ./config/batch.conf

<span class="token comment">## cluster 模式</span>
./bin/start-waterdrop.sh --master <span class="token function">yarn</span> --deploy-mode cluster --config ./config/batch.conf
</code></pre></div><h4 id="第九步-查询clickhouse数据-验证数据进入clickhouse"><a href="#第九步-查询clickhouse数据-验证数据进入clickhouse" class="header-anchor">#</a> 第九步：查询clickhouse数据，验证数据进入clickhouse</h4> <p>node02执行以下命令，查询clickhouse当中的数据</p> <div class="language-sh extra-class"><pre class="language-sh"><code>clickhouse-client  -m
node02.kaikeba.com <span class="token builtin class-name">:</span><span class="token punctuation">)</span> use game_center<span class="token punctuation">;</span>
node02.kaikeba.com <span class="token builtin class-name">:</span><span class="token punctuation">)</span> <span class="token keyword">select</span> count<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> from ods_user_login<span class="token punctuation">;</span>
</code></pre></div><img src="clickhouse.assets/image-20200521155555435.png" alt="image-20200521155555435" style="zoom:80%;"></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MaLunan/press/edit/dev-mln/docs/clickhouse/clickhouse.md" target="_blank" rel="noopener noreferrer">在GitHub 上编辑此页！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">1/19/2021, 1:41:59 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fdd7a502.js" defer></script><script src="/assets/js/16.375b747e.js" defer></script><script src="/assets/js/33.c489bc81.js" defer></script>
  </body>
</html>
