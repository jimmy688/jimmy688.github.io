<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>zookeeper安装部署 | 个人博客 | JiiiiG</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="自是年少，韶华倾负">
    
    <link rel="preload" href="/assets/css/0.styles.420b7c1f.css" as="style"><link rel="preload" href="/assets/js/app.fdd7a502.js" as="script"><link rel="preload" href="/assets/js/16.375b747e.js" as="script"><link rel="preload" href="/assets/js/15.be29bb6a.js" as="script"><link rel="prefetch" href="/assets/js/10.bbd38b9e.js"><link rel="prefetch" href="/assets/js/11.f49fc7d3.js"><link rel="prefetch" href="/assets/js/12.c5d97aa1.js"><link rel="prefetch" href="/assets/js/13.426d0224.js"><link rel="prefetch" href="/assets/js/14.1f257a58.js"><link rel="prefetch" href="/assets/js/17.d02cdd8b.js"><link rel="prefetch" href="/assets/js/18.5d2371a4.js"><link rel="prefetch" href="/assets/js/19.038919a3.js"><link rel="prefetch" href="/assets/js/2.d6257727.js"><link rel="prefetch" href="/assets/js/20.b3582e09.js"><link rel="prefetch" href="/assets/js/21.0c1e826b.js"><link rel="prefetch" href="/assets/js/22.91bff1a5.js"><link rel="prefetch" href="/assets/js/23.faacea60.js"><link rel="prefetch" href="/assets/js/24.69816497.js"><link rel="prefetch" href="/assets/js/25.c9fcaa62.js"><link rel="prefetch" href="/assets/js/26.d28c3abe.js"><link rel="prefetch" href="/assets/js/27.1518da7d.js"><link rel="prefetch" href="/assets/js/28.748a5581.js"><link rel="prefetch" href="/assets/js/29.775019f1.js"><link rel="prefetch" href="/assets/js/3.141002a4.js"><link rel="prefetch" href="/assets/js/30.74e7c570.js"><link rel="prefetch" href="/assets/js/31.190b11f2.js"><link rel="prefetch" href="/assets/js/32.d8f4f116.js"><link rel="prefetch" href="/assets/js/33.c489bc81.js"><link rel="prefetch" href="/assets/js/34.db609d51.js"><link rel="prefetch" href="/assets/js/35.ad3402e6.js"><link rel="prefetch" href="/assets/js/36.45f11923.js"><link rel="prefetch" href="/assets/js/37.b47e0576.js"><link rel="prefetch" href="/assets/js/38.58b934a2.js"><link rel="prefetch" href="/assets/js/39.e4d6bcdf.js"><link rel="prefetch" href="/assets/js/4.e9b44388.js"><link rel="prefetch" href="/assets/js/40.555106bc.js"><link rel="prefetch" href="/assets/js/41.4387ceb1.js"><link rel="prefetch" href="/assets/js/42.9bd4aea0.js"><link rel="prefetch" href="/assets/js/43.587e7966.js"><link rel="prefetch" href="/assets/js/44.80285763.js"><link rel="prefetch" href="/assets/js/45.f978da77.js"><link rel="prefetch" href="/assets/js/46.d93e3f2e.js"><link rel="prefetch" href="/assets/js/47.c15bd2aa.js"><link rel="prefetch" href="/assets/js/48.cb55fa72.js"><link rel="prefetch" href="/assets/js/49.d0f4e454.js"><link rel="prefetch" href="/assets/js/5.b90b80cb.js"><link rel="prefetch" href="/assets/js/50.112e8260.js"><link rel="prefetch" href="/assets/js/51.a66bcd03.js"><link rel="prefetch" href="/assets/js/52.0c7cbfb1.js"><link rel="prefetch" href="/assets/js/53.67ef240b.js"><link rel="prefetch" href="/assets/js/54.2c2d082d.js"><link rel="prefetch" href="/assets/js/55.88f19a20.js"><link rel="prefetch" href="/assets/js/56.c726e920.js"><link rel="prefetch" href="/assets/js/57.eaee47c5.js"><link rel="prefetch" href="/assets/js/58.ac15a3ac.js"><link rel="prefetch" href="/assets/js/59.64bdc849.js"><link rel="prefetch" href="/assets/js/6.7eea74ff.js"><link rel="prefetch" href="/assets/js/7.a1370e98.js"><link rel="prefetch" href="/assets/js/8.2e898240.js"><link rel="prefetch" href="/assets/js/9.a2439994.js">
    <link rel="stylesheet" href="/assets/css/0.styles.420b7c1f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">个人博客 | JiiiiG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/linux/linux常用命令/01linux常用命令01.html" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/hadoop/01hadoop环境搭建/01搭建hadoop集群.html" class="nav-link">
  hadoop
</a></li><li class="dropdown-item"><!----> <a href="/hbase/hbase.html" class="nav-link">
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/flink/flink.html" class="nav-link">
  flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zookeeper/.html" class="nav-link">
  java
</a></li></ul></div></div> <a href="https://github.com/MaLunan/press" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/linux/linux常用命令/01linux常用命令01.html" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/hadoop/01hadoop环境搭建/01搭建hadoop集群.html" class="nav-link">
  hadoop
</a></li><li class="dropdown-item"><!----> <a href="/hbase/hbase.html" class="nav-link">
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/flink/flink.html" class="nav-link">
  flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zookeeper/.html" class="nav-link">
  java
</a></li></ul></div></div> <a href="https://github.com/MaLunan/press" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="zookeeper安装部署"><a href="#zookeeper安装部署" class="header-anchor">#</a> zookeeper安装部署</h2> <p>注意事项：<strong>三台机器一定要保证时钟同步</strong></p> <h4 id="_1-1-下载zookeeeper的压缩包-下载网址如下"><a href="#_1-1-下载zookeeeper的压缩包-下载网址如下" class="header-anchor">#</a> 1.1 下载zookeeeper的压缩包，下载网址如下</h4> <ul><li><p>http://archive.cloudera.com/cdh5/cdh/5/</p></li> <li><p>我们在这个网址下载我们使用的zk版本为<a href="http://archive.cloudera.com/cdh5/cdh/5/zookeeper-3.4.5-cdh5.14.2.tar.gz" target="_blank" rel="noopener noreferrer">zookeeper-3.4.5-cdh5.14.2.tar.gz<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>下载完成之后，上传到我们的<code>node01</code>的<code>/kkb/soft</code>路径下准备进行安装</p></li></ul> <h4 id="_1-2-解压"><a href="#_1-2-解压" class="header-anchor">#</a> 1.2 解压</h4> <ul><li><code>node01</code>执行以下命令解压<code>zookeeper</code>的压缩包到<code>node01</code>服务器的<code>/kkb/install</code>路径下去，然后准备进行安装</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /kkb/soft

<span class="token function">tar</span> -zxvf zookeeper-3.4.5-cdh5.14.2.tar.gz  -C /kkb/install/
</code></pre></div><h4 id="_1-3-修改配置文件"><a href="#_1-3-修改配置文件" class="header-anchor">#</a> 1.3 修改配置文件</h4> <ul><li>第一台机器修改配置文件</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /kkb/install/zookeeper-3.4.5-cdh5.14.2/conf

<span class="token function">cp</span> zoo_sample.cfg zoo.cfg

<span class="token function">mkdir</span> -p /kkb/install/zookeeper-3.4.5-cdh5.14.2/zkdatas
</code></pre></div><ul><li>用<code>vim zoo.cfg</code>修改文件，修改如下属性值</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/kkb/install/zookeeper-3.4.5-cdh5.14.2/zkdatas

autopurge.snapRetainCount<span class="token operator">=</span><span class="token number">3</span>

autopurge.purgeInterval<span class="token operator">=</span><span class="token number">1</span>

<span class="token comment">#文件末尾增加如下三行</span>
server.1<span class="token operator">=</span>node01:2888:3888
server.2<span class="token operator">=</span>node02:2888:3888
server.3<span class="token operator">=</span>node03:2888:3888
</code></pre></div><h4 id="_1-4-添加myid配置"><a href="#_1-4-添加myid配置" class="header-anchor">#</a> 1.4 添加myid配置</h4> <ul><li>在第一台机器的/kkb/install/zookeeper-3.4.5-cdh5.14.2/zkdatas/这个路径下创建一个文件，文件名为myid ,文件内容为1</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">&gt;</span>  /kkb/install/zookeeper-3.4.5-cdh5.14.2/zkdatas/myid
</code></pre></div><h4 id="_1-5-安装包分发并修改myid的值"><a href="#_1-5-安装包分发并修改myid的值" class="header-anchor">#</a> 1.5 安装包分发并修改myid的值</h4> <ul><li>第一台机器上面执行以下两个命令</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">scp</span> -r /kkb/install/zookeeper-3.4.5-cdh5.14.2/ node02:/kkb/install/

<span class="token function">scp</span> -r /kkb/install/zookeeper-3.4.5-cdh5.14.2/ node03:/kkb/install/
</code></pre></div><ul><li>第二台机器上修改myid的值为2；直接在第二台机器任意路径执行以下命令</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">echo</span> <span class="token number">2</span> <span class="token operator">&gt;</span> /kkb/install/zookeeper-3.4.5-cdh5.14.2/zkdatas/myid
</code></pre></div><ul><li>第三台机器上修改myid的值为3；直接在第三台机器任意路径执行以下命令</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">echo</span> <span class="token number">3</span> <span class="token operator">&gt;</span> /kkb/install/zookeeper-3.4.5-cdh5.14.2/zkdatas/myid
</code></pre></div><h4 id="_1-6-配置环境变量"><a href="#_1-6-配置环境变量" class="header-anchor">#</a> 1.6 配置环境变量</h4> <ul><li>三台节点都配置/etc/profile文件</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">ZK_HOME</span><span class="token operator">=</span>/kkb/install/zookeeper-3.4.5-cdh5.14.2
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$ZK_HOME</span>/bin
</code></pre></div><ul><li>三台节点，让新添环境变量生效（hadoop用户下执行）</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">source</span> /etc/profile
</code></pre></div><h4 id="_1-7-三台机器启动zookeeper服务"><a href="#_1-7-三台机器启动zookeeper服务" class="header-anchor">#</a> 1.7 三台机器启动zookeeper服务</h4> <ul><li>三台机器启动zookeeper服务；这个命令三台机器都要执行</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>zkServer.sh start
</code></pre></div><ul><li>查看启动状态</li></ul> <div class="language- extra-class"><pre class="language-text"><code>zkServer.sh status
</code></pre></div><blockquote><p>一个zkServer的状态要么是follower，要么是leader</p> <p>三个节点中，一个节点为leader，另外两个为follower，类似下图</p></blockquote> <p><img src="/assets/img/Image201910221141.7f003e19.png" alt=""></p> <p>![](zookeeper.assets/Image201910221141 (2).png)</p> <ul><li>jps每个服务器上有一个<strong>QuorumPeerMain</strong>进程</li></ul> <p><img src="data:image/png;base64,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" alt=""></p> <h4 id="_1-8-如何关闭zookeeper集群"><a href="#_1-8-如何关闭zookeeper集群" class="header-anchor">#</a> 1.8 如何关闭zookeeper集群</h4> <ul><li>三个节点运行</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>zkServer.sh stop
</code></pre></div><blockquote><p>**注意：**关闭虚拟机前，要在每个zookeeper服务器中使用zkServer.sh stop命令，关闭zookeeper服务器</p> <p>否则，可能集群出问题</p></blockquote> <h2 id="ha集群搭建-todo"><a href="#ha集群搭建-todo" class="header-anchor">#</a> HA集群搭建（TODO）</h2> <h4 id="集群规划"><a href="#集群规划" class="header-anchor">#</a> 集群规划</h4> <blockquote><p>说明：</p> <ul><li><p>集群共5个节点，主机名分别是node01、node02、node03、node04、node05</p></li> <li><p>初始启动集群</p> <ul><li>node01上运行active namenode即主namenode；node02上运行standby namenode即从namenode</li> <li>node04上运行主resourcemanager；node05上运行从resourcemanager</li></ul></li></ul></blockquote> <ul><li>每个节点运行的进程如下表</li></ul> <p>| 机器名 | 运行进程                                                    |
| ------ | =====================---------------- |
| node01 | NameNode/zkfc/Zookeeper/Journalnode/DataNode/NodeManager    |
| node02 | NameNode/zkfc/Zookeeper/Journalnode/DataNode/NodeManager    |
| node03 | Zookeeper/Journalnode/DataNode/NodeManager/JobHistoryServer |
| node04 | ResourceManager                                             |
| node05 | ResourceManager                                             |</p> <h4 id="虚拟机环境准备"><a href="#虚拟机环境准备" class="header-anchor">#</a> 虚拟机环境准备</h4> <ul><li>准备<strong>5台</strong>虚拟机</li> <li>在做五节点<code>hadoop HA</code>集群搭建之前，要求先完成<strong>每台</strong>虚拟机的<strong>基本环境准备</strong> <ul><li>每个节点都要做好“在<code>node01</code>上开始解压<code>hadoop</code>的<code>tar.gz</code>包之前的环境配置”</li> <li>主要包括如下步骤（<strong>三节点Hadoop集群搭建时已讲解过，不再赘述</strong>）
<ul><li>windows|mac安装VMWare虚拟化软件</li> <li>VMWare下安装CenoOS7</li> <li>虚拟机关闭防火墙</li> <li>禁用selinux</li> <li>配置虚拟网卡</li> <li>配置虚拟机网络</li> <li>安装JDK</li> <li>配置时间同步</li> <li>修改主机名</li> <li>修改ip地址</li> <li>修改/etc/hosts</li> <li>各节点免密钥登陆</li> <li>重启虚拟机</li></ul></li></ul></li></ul> <h4 id="安装zookeeper集群"><a href="#安装zookeeper集群" class="header-anchor">#</a> 安装ZooKeeper集群</h4> <p><code>Hadoop</code>高可用集群需要使用<code>ZooKeeper</code>集群做分布式协调；所以<strong>先安装ZooKeeper集群</strong></p> <ul><li>在<code>node01、node02、node03</code>上安装<code>ZooKeeper</code>集群</li></ul> <h4 id="node01安装hadoop"><a href="#node01安装hadoop" class="header-anchor">#</a> node01安装hadoop</h4> <p><strong>注意：</strong></p> <p>①3.1到3.8在<strong>node01</strong>上操作</p> <p>②<strong>此文档使用普通用户操作，如hadoop</strong></p> <p>③<strong>hadoop安装到用户主目录下，如/kkb/install</strong></p> <p><strong>请根据自己的实际情况修改</strong></p> <h5 id="_3-1-解压hadoop压缩包"><a href="#_3-1-解压hadoop压缩包" class="header-anchor">#</a> 3.1 解压hadoop压缩包</h5> <ul><li><p>hadoop压缩包hadoop-2.6.0-cdh5.14.2_after_compile.tar.gz上传到node01的/kkb/soft路径中</p></li> <li><p>解压hadoop压缩包到/kkb/install</p></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#解压hadoop压缩包到/kkb/install</span>
<span class="token punctuation">[</span>hadoop@node01 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">cd</span>
<span class="token punctuation">[</span>hadoop@node01 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">cd</span> /kkb/soft/
<span class="token punctuation">[</span>hadoop@node01 soft<span class="token punctuation">]</span>$ <span class="token function">tar</span> -xzvf hadoop-2.6.0-cdh5.14.2_after_compile.tar.gz -C /kkb/install/
</code></pre></div><h5 id="_3-2-修改hadoop-env-sh"><a href="#_3-2-修改hadoop-env-sh" class="header-anchor">#</a> 3.2 修改hadoop-env.sh</h5> <ul><li>进入hadoop配置文件路径$HADOOP_HOME/etc/hadoop</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>hadoop@node01 soft<span class="token punctuation">]</span>$ <span class="token builtin class-name">cd</span> /kkb/install/hadoop-2.6.0-cdh5.14.2/
<span class="token punctuation">[</span>hadoop@node01 hadoop-2.6.0-cdh5.14.2<span class="token punctuation">]</span>$ <span class="token builtin class-name">cd</span> etc/hadoop/
</code></pre></div><ul><li>修改hadoop-env.sh，修改JAVA_HOME值为jdk解压路径；保存退出</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/kkb/install/jdk1.8.0_141
</code></pre></div><blockquote><p>注意：JAVA_HOME值修改为<strong>自己jdk的实际目录</strong></p></blockquote> <h5 id="_3-3-修改core-site-xml"><a href="#_3-3-修改core-site-xml" class="header-anchor">#</a> 3.3 修改core-site.xml</h5> <blockquote><p><strong>注意：</strong></p> <p><strong>情况一：值/kkb/install/hadoop-2.6.0-cdh5.14.2/tmp根据实际情况修改</strong></p> <p><strong>情况二：值node01:2181,node02:2181,node03:2181根据实际情况修改，修改成安装了zookeeper的虚拟机的主机名</strong></p></blockquote> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 指定hdfs的nameservice id为ns1 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>fs.defaultFS<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>hdfs://ns1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 指定hadoop临时文件存储的基目录 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>hadoop.tmp.dir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>/kkb/install/hadoop-2.6.0-cdh5.14.2/tmp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 指定zookeeper地址，ZKFailoverController使用 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>ha.zookeeper.quorum<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node01:2181,node02:2181,node03:2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h5 id="_3-4-修改hdfs-site-xml"><a href="#_3-4-修改hdfs-site-xml" class="header-anchor">#</a> 3.4 修改hdfs-site.xml</h5> <blockquote><p><strong>注意：</strong></p> <p><strong>情况一：属性值qjournal://node01:8485;node02:8485;node03:8485/ns1中的主机名，修改成实际安装zookeeper的虚拟机的主机名</strong></p> <p><strong>情况二：属性值/kkb/install/hadoop-2.6.0-cdh5.14.2/journal中”/kkb/install/hadoop-2.6.0-cdh5.14.2”替换成实际hadoop文件夹的路径</strong></p> <p><strong>情况三：属性值/home/hadoop/.ssh/id_rsa中/home/hadoop根据实际情况替换</strong></p></blockquote> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!--指定hdfs的nameservice列表，多个之前逗号分隔；此处只有一个ns1，需要和core-site.xml中的保持一致 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.nameservices<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>ns1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- ns1下面有两个NameNode，分别是nn1，nn2 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.ha.namenodes.ns1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>nn1,nn2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- nn1的RPC通信地址 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.namenode.rpc-address.ns1.nn1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node01:8020<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- nn1的http通信地址,web访问地址 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.namenode.http-address.ns1.nn1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node01:50070<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- nn2的RPC通信地址 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.namenode.rpc-address.ns1.nn2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node02:8020<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- nn2的http通信地址,web访问地址 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.namenode.http-address.ns1.nn2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node02:50070<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 指定NameNode的元数据在JournalNode上的存放位置 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.namenode.shared.edits.dir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>qjournal://node01:8485;node02:8485;node03:8485/ns1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 指定JournalNode在本地磁盘存放数据的位置 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.journalnode.edits.dir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>/kkb/install/hadoop-2.6.0-cdh5.14.2/journal<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 开启NameNode失败自动切换 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.ha.automatic-failover.enabled<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 此类决定哪个namenode是active，切换active和standby --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.client.failover.proxy.provider.ns1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 配置隔离机制方法，多个机制用换行分割，即每个机制暂用一行--&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.ha.fencing.methods<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>
		sshfence
		shell(/bin/true)
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 使用sshfence隔离机制时需要ssh免密登陆到目标机器 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.ha.fencing.ssh.private-key-files<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>/home/hadoop/.ssh/id_rsa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 配置sshfence隔离机制超时时间 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.ha.fencing.ssh.connect-timeout<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>30000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h5 id="_3-5-修改mapred-site-xml"><a href="#_3-5-修改mapred-site-xml" class="header-anchor">#</a> 3.5 修改mapred-site.xml</h5> <ul><li>重命名文件</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>hadoop@node01 hadoop<span class="token punctuation">]</span>$ <span class="token function">mv</span> mapred-site.xml.template mapred-site.xml
</code></pre></div><ul><li>修改mapred-site.xml</li></ul> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 指定运行mr job的运行时框架为yarn --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>mapreduce.framework.name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>yarn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- MapReduce JobHistory Server IPC host:port --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>mapreduce.jobhistory.address<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node03:10020<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- MapReduce JobHistory Server Web UI host:port --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>mapreduce.jobhistory.webapp.address<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node03:19888<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h5 id="_3-6-修改yarn-site-xml"><a href="#_3-6-修改yarn-site-xml" class="header-anchor">#</a> 3.6 修改yarn-site.xml</h5> <blockquote><p><strong>注意：</strong></p> <p><strong>情况一：属性yarn.resourcemanager.hostname.rm1的值node04根据实际情况替换</strong></p> <p><strong>情况二：属性yarn.resourcemanager.hostname.rm2的值node05根据实际情况替换</strong></p> <p><strong>情况三：属性值node01:2181,node02:2181,node03:2181根据实际情况替换；替换成实际安装zookeeper的虚拟机的主机名</strong></p></blockquote> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 是否启用日志聚合.应用程序完成后,日志汇总收集每个容器的日志,这些日志移动到文件系统,例如HDFS. --&gt;</span>
	<span class="token comment">&lt;!-- 用户可以通过配置&quot;yarn.nodemanager.remote-app-log-dir&quot;、&quot;yarn.nodemanager.remote-app-log-dir-suffix&quot;来确定日志移动到的位置 --&gt;</span>
	<span class="token comment">&lt;!-- 用户可以通过应用程序时间服务器访问日志 --&gt;</span>
	<span class="token comment">&lt;!-- 启用日志聚合功能，应用程序完成后，收集各个节点的日志到一起便于查看 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.log-aggregation-enable<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 开启RM高可靠 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.ha.enabled<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 指定RM的cluster id为yrc，意为yarn cluster --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.cluster-id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>yrc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 指定RM的名字 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.ha.rm-ids<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>rm1,rm2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 指定第一个RM的地址 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.hostname.rm1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node04<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 指定第二个RM的地址 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.hostname.rm2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node05<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 配置第一台机器的resourceManager通信地址 --&gt;</span>
	<span class="token comment">&lt;!--客户端通过该地址向RM提交对应用程序操作--&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.address.rm1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node04:8032<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!--向RM调度资源地址--&gt;</span> 
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.scheduler.address.rm1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node04:8030<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!--NodeManager通过该地址交换信息--&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.resource-tracker.address.rm1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node04:8031<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!--管理员通过该地址向RM发送管理命令--&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.admin.address.rm1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node04:8033<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!--RM HTTP访问地址,查看集群信息--&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.webapp.address.rm1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node04:8088<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 配置第二台机器的resourceManager通信地址 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.address.rm2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node05:8032<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.scheduler.address.rm2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node05:8030<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.resource-tracker.address.rm2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node05:8031<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.admin.address.rm2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node05:8033<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.webapp.address.rm2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node05:8088<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--开启resourcemanager自动恢复功能--&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.recovery.enabled<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>	
    <span class="token comment">&lt;!--在node4上配置rm1,在node5上配置rm2,注意：一般都喜欢把配置好的文件远程复制到其它机器上，但这个在YARN的另一个机器上一定要修改，其他机器上不配置此项--&gt;</span>
	<span class="token comment">&lt;!--
    &lt;property&gt;       
		&lt;name&gt;yarn.resourcemanager.ha.id&lt;/name&gt;
		&lt;value&gt;rm1&lt;/value&gt;
	   &lt;description&gt;If we want to launch more than one RM in single node, we need this configuration&lt;/description&gt;
	&lt;/property&gt;
	--&gt;</span>
	<span class="token comment">&lt;!--用于持久存储的类。尝试开启--&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.store.class<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!-- 基于zookeeper的实现 --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop.yarn.server.resourcemanager.recovery.ZKRMStateStore<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 单个任务可申请最少内存，默认1024MB --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.scheduler.minimum-allocation-mb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>512<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!--多长时间聚合删除一次日志 此处--&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.log-aggregation.retain-seconds<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>2592000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--30 day--&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!--时间在几秒钟内保留用户日志。只适用于如果日志聚合是禁用的--&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.nodemanager.log.retain-seconds<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>604800<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--7 day--&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- 指定zk集群地址 --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.zk-address<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>node01:2181,node02:2181,node03:2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 逗号隔开的服务列表，列表名称应该只包含a-zA-Z0-9_,不能以数字开始--&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.nodemanager.aux-services<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>mapreduce_shuffle<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h5 id="_3-7-修改slaves"><a href="#_3-7-修改slaves" class="header-anchor">#</a> 3.7 修改slaves</h5> <blockquote><p>node01、node02、node03上运行了datanode、nodemanager，所以修改slaves内容<strong>替换</strong>为：</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>node01
node02
node03
</code></pre></div><h4 id="node01上分发hadoop文件夹"><a href="#node01上分发hadoop文件夹" class="header-anchor">#</a> node01上分发hadoop文件夹</h4> <blockquote><p>拷贝到<code>node02~node05</code></p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>hadoop@node01 hadoop<span class="token punctuation">]</span>$ <span class="token function">scp</span> -r /kkb/install/hadoop-2.6.0-cdh5.14.2/ node02:/kkb/install/
<span class="token punctuation">[</span>hadoop@node01 hadoop<span class="token punctuation">]</span>$ <span class="token function">scp</span> -r /kkb/install/hadoop-2.6.0-cdh5.14.2/ node03:/kkb/install/
<span class="token punctuation">[</span>hadoop@node01 hadoop<span class="token punctuation">]</span>$ <span class="token function">scp</span> -r /kkb/install/hadoop-2.6.0-cdh5.14.2/ node04:/kkb/install/
<span class="token punctuation">[</span>hadoop@node01 hadoop<span class="token punctuation">]</span>$ <span class="token function">scp</span> -r /kkb/install/hadoop-2.6.0-cdh5.14.2/ node05:/kkb/install/
</code></pre></div><h4 id="修改node04-05rm的yarn-site-xml"><a href="#修改node04-05rm的yarn-site-xml" class="header-anchor">#</a> 修改node04/05RM的yarn-site.xml</h4> <ul><li>在<strong>node04</strong>上，找到属性<code>yarn.resourcemanager.ha.id</code>去除注释①、②</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>hadoop@node04 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">cd</span> /kkb/install/hadoop-2.6.0-cdh5.14.2/etc/hadoop
<span class="token punctuation">[</span>hadoop@node04 hadoop<span class="token punctuation">]</span>$ <span class="token function">vim</span> yarn-site.xml 
</code></pre></div><p><img src="/assets/img/Image201909232016.8123d229.png" alt=""></p> <ul><li>在<strong>node05</strong>上
<ul><li>找到属性<code>yarn.resourcemanager.ha.id</code>去除注释<strong>①、②</strong></li> <li><strong>③</strong>修改成rm2</li></ul></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>hadoop@node05 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">cd</span> /kkb/install/hadoop-2.6.0-cdh5.14.2/etc/hadoop/
<span class="token punctuation">[</span>hadoop@node05 hadoop<span class="token punctuation">]</span>$ <span class="token function">vim</span> yarn-site.xml
</code></pre></div><p><img src="/assets/img/Image201909232022.62355b7d.png" alt=""></p> <ul><li>修改后，结果如下</li></ul> <p><img src="/assets/img/Image201909232024.fad2d722.png" alt=""></p> <h4 id="配置hadoop环境变量"><a href="#配置hadoop环境变量" class="header-anchor">#</a> 配置hadoop环境变量</h4> <ul><li><strong>node01到node05五个节点都配置环境变量</strong></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#将hadoop添加到环境变量中</span>
<span class="token function">vim</span> /etc/profile
</code></pre></div><ul><li>添加内容如下（注意：若HADOOP_HOME已经存在，则修改）：</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">HADOOP_HOME</span><span class="token operator">=</span>/kkb/install/hadoop-2.6.0-cdh5.14.2/
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$HADOOP_HOME</span>/bin:<span class="token variable">$HADOOP_HOME</span>/sbin
</code></pre></div><ul><li>编译文件，使新增环境变量生效</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">source</span> /etc/profile
</code></pre></div><h4 id="启动与初始化hadoop集群"><a href="#启动与初始化hadoop集群" class="header-anchor">#</a> 启动与初始化hadoop集群</h4> <blockquote><p>**注意：**严格按照下面的步骤 先检查各台hadoop环境变量是否设置好</p></blockquote> <h4 id="启动zookeeper集群"><a href="#启动zookeeper集群" class="header-anchor">#</a> 启动zookeeper集群</h4> <blockquote><p>注意：根据zookeeper实际安装情况，启动zookeeper</p></blockquote> <p>分别在node01、node02、node03上启动zookeeper</p> <div class="language-shell extra-class"><pre class="language-shell"><code>zkServer.sh start
</code></pre></div><p>#查看状态：一个为leader，另外两个为follower</p> <div class="language-shell extra-class"><pre class="language-shell"><code>zkServer.sh status
</code></pre></div><h4 id="启动hdfs"><a href="#启动hdfs" class="header-anchor">#</a> 启动HDFS</h4> <h5 id="_4-2-1-格式化zk"><a href="#_4-2-1-格式化zk" class="header-anchor">#</a> 4.2.1 格式化ZK</h5> <blockquote><p>在<strong>node01</strong>上执行即可</p> <ul><li><p>集群有两个namenode，分别在node01、node02上</p></li> <li><p>每个namenode对应一个zkfc进程；</p></li> <li><p>在主namenode node01上格式化zkfc</p></li></ul></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>hdfs zkfc -formatZK
</code></pre></div><h5 id="_4-2-2-启动journalnode"><a href="#_4-2-2-启动journalnode" class="header-anchor">#</a> 4.2.2 启动journalnode</h5> <ul><li>在<strong>node01</strong>上执行
<ul><li>会启动node01、node02、node03上的journalnode</li> <li>因为使用的是hadoop-daemon<strong>s</strong>.sh</li></ul></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>hadoop-daemons.sh start journalnode
</code></pre></div><ul><li>运行jps命令检验，node01、node02、node03上多了JournalNode进程</li></ul> <h5 id="_4-2-3-格式化hdfs"><a href="#_4-2-3-格式化hdfs" class="header-anchor">#</a> 4.2.3 格式化HDFS</h5> <ul><li>在node01上执行</li> <li>根据集群规划node01、node02上运行namenode；所以<strong>只在主namenode节点</strong>即node01上执行命令:
<ul><li>此命令慎用；只在集群搭建（初始化）时使用一次；</li> <li>一旦再次使用，会将HDFS上之前的数据格式化删除掉</li></ul></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>hdfs namenode -format
</code></pre></div><ul><li>下图表示格式化成功</li></ul> <p><img src="/assets/img/Image201909241056.77c99ae8.png" alt=""></p> <h5 id="_4-2-4-初始化元数据、启动主nn"><a href="#_4-2-4-初始化元数据、启动主nn" class="header-anchor">#</a> 4.2.4 初始化元数据、启动主NN</h5> <ul><li>node01上执行（主namenode）</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>hdfs namenode -initializeSharedEdits -force
<span class="token comment">#启动HDFS</span>
start-dfs.sh
</code></pre></div><h5 id="_4-2-5-同步元数据信息、启动从nn"><a href="#_4-2-5-同步元数据信息、启动从nn" class="header-anchor">#</a> 4.2.5 同步元数据信息、启动从NN</h5> <ul><li><strong>node02</strong>上执行（从namenode）</li> <li>同步元数据信息，并且设置node02上namenode为standBy状态</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>hdfs namenode -bootstrapStandby
hadoop-daemon.sh start namenode
</code></pre></div><h5 id="_4-2-5-jps查看进程"><a href="#_4-2-5-jps查看进程" class="header-anchor">#</a> 4.2.5 JPS查看进程</h5> <ul><li>node01上</li></ul> <p><img src="/assets/img/Image201909241118.e0d9549d.png" alt=""></p> <ul><li>node02上</li></ul> <p><img src="/assets/img/Image201909241119.14316d34.png" alt=""></p> <ul><li>node03上</li></ul> <p><img src="data:image/png;base64,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" alt=""></p> <h4 id="启动yarn"><a href="#启动yarn" class="header-anchor">#</a> 启动YARN</h4> <h5 id="_4-6-1-主resourcemanager"><a href="#_4-6-1-主resourcemanager" class="header-anchor">#</a> 4.6.1 <strong>主resourcemanager</strong></h5> <ul><li><strong>node04</strong>上执行（<strong>主resourcemanager</strong>）
<ul><li>把namenode和resourcemanager部署在不同节点，是因为性能问题，因为他们都要占用大量资源</li> <li>坑：在node04上启动yarn之前，先依次从node04 ssh远程连接到node01、node02、node03、node04、node05；因为初次ssh时，需要交互，输入yes，回车</li></ul></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>start-yarn.sh
</code></pre></div><h5 id="_4-6-2-从resourcemanager"><a href="#_4-6-2-从resourcemanager" class="header-anchor">#</a> 4.6.2 从resourcemanager</h5> <ul><li>在从resourcemanager即<strong>node05</strong>上启动rm</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>yarn-daemon.sh start resourcemanager
</code></pre></div><h5 id="_4-6-3-查看resourcemanager状态"><a href="#_4-6-3-查看resourcemanager状态" class="header-anchor">#</a> 4.6.3 查看resourceManager状态</h5> <ul><li>node04上，它的resourcemanager的Id是rm1</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> rmadmin -getServiceState rm1
</code></pre></div><ul><li>node05上，它的resourcemanager的Id是rm2</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> rmadmin -getServiceState rm2
</code></pre></div><h4 id="启动jobhistory"><a href="#启动jobhistory" class="header-anchor">#</a> 启动JobHistory</h4> <ul><li><strong>node03</strong>上执行</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>mr-jobhistory-daemon.sh start historyserver
</code></pre></div><h4 id="验证集群是否可用"><a href="#验证集群是否可用" class="header-anchor">#</a> 验证集群是否可用</h4> <h5 id="_5-1-验证hdfs-ha"><a href="#_5-1-验证hdfs-ha" class="header-anchor">#</a> 5.1 验证HDFS HA</h5> <h6 id="_5-1-1-访问web-ui"><a href="#_5-1-1-访问web-ui" class="header-anchor">#</a> 5.1.1 访问WEB UI</h6> <blockquote><p>node01、node02一主一备</p></blockquote> <div class="language-html extra-class"><pre class="language-html"><code>http://node01:50070
</code></pre></div><p><img src="/assets/img/Image201907271415.9aa2333e.png" alt=""></p> <div class="language- extra-class"><pre class="language-text"><code>http://node02:50070
</code></pre></div><p><img src="/assets/img/Image201907271416.d39d751e.png" alt=""></p> <h6 id="_5-1-2-模拟主备切换"><a href="#_5-1-2-模拟主备切换" class="header-anchor">#</a> 5.1.2 模拟主备切换</h6> <ul><li>在主namenode节点，运行</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>hadoop-daemon.sh stop namenode
</code></pre></div><ul><li><p>访问之前为&quot;备namenode&quot;的WEB UI；发现状态更新为active</p></li> <li><p>或者使用命令查看状态</p></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>hdfs haadmin -getServiceState nn2
</code></pre></div><p><img src="/assets/img/Image201907271417.f9c8445b.png" alt=""></p> <ul><li>启动刚才手动停掉的namenode</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>hadoop-daemon.sh start namenode
</code></pre></div><ul><li><p>访问它的WEB UI，发现状态更新为standby</p></li> <li><p>或者使用命令查看状态</p></li></ul> <div class="language- extra-class"><pre class="language-text"><code>hdfs haadmin -getServiceState nn1
</code></pre></div><p><img src="/assets/img/Image201907271419.88982e52.png" alt=""></p> <h5 id="_5-2-验证yarn-ha"><a href="#_5-2-验证yarn-ha" class="header-anchor">#</a> 5.2 验证Yarn HA</h5> <blockquote><p>node04、node05主备切换</p></blockquote> <h6 id="_5-2-1-访问web-ui"><a href="#_5-2-1-访问web-ui" class="header-anchor">#</a> 5.2.1 访问WEB UI</h6> <ul><li>node04浏览器访问</li></ul> <div class="language- extra-class"><pre class="language-text"><code>http://node04:8088/cluster/cluster
</code></pre></div><p><img src="/assets/img/Image201907271519.70816c15.png" alt=""></p> <ul><li>node05浏览器访问</li></ul> <div class="language- extra-class"><pre class="language-text"><code>http://node05:8088/cluster/cluster
</code></pre></div><p><img src="/assets/img/Image201907271520.9a2e5fb8.png" alt=""></p> <h6 id="_5-2-2-模拟主备切换"><a href="#_5-2-2-模拟主备切换" class="header-anchor">#</a> 5.2.2 模拟主备切换</h6> <ul><li>在主resourcemanager节点，运行</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>yarn-daemon.sh stop resourcemanager
</code></pre></div><ul><li><p>访问之前为&quot;备resourcemanager&quot;的WEB UI；发现状态更新为active</p></li> <li><p>或者命令查看状态</p></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> rmadmin -getServiceState rm2
</code></pre></div><p><img src="/assets/img/Image201907271524.9e1c8833.png" alt=""></p> <ul><li>启动刚才手动停掉的resourcemanager</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>yarn-daemon.sh start resourcemanager
</code></pre></div><ul><li><p>访问它的WEB UI，发现状态更新为standby</p></li> <li><p>或者命令查看状态</p></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> rmadmin -getServiceState rm1
</code></pre></div><p><img src="/assets/img/Image201907271526.a8bb9a39.png" alt=""></p> <h6 id="_5-2-3-运行mr示例"><a href="#_5-2-3-运行mr示例" class="header-anchor">#</a> 5.2.3 运行MR示例</h6> <ul><li>运行一下hadoop示例中的WordCount程序：</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>hadoop fs -put /kkb/install/hadoop-2.6.0-cdh5.14.2/LICENSE.txt /
hadoop jar /kkb/install/hadoop-2.6.0-cdh5.14.2/share/hadoop/mapreduce/hadoop-mapreduce-examples-2.6.0-cdh5.14.2.jar wordcount /LICENSE.txt /w0727
</code></pre></div><h4 id="集群常用命令"><a href="#集群常用命令" class="header-anchor">#</a> 集群常用命令</h4> <h5 id="关闭hadoop-ha集群"><a href="#关闭hadoop-ha集群" class="header-anchor">#</a> 关闭Hadoop HA集群</h5> <blockquote><p>正确指令执行顺序如下</p></blockquote> <ul><li>主namenode上运行</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>stop-dfs.sh
</code></pre></div><ul><li>主resoucemanager上运行</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>stop-yarn.sh
</code></pre></div><ul><li>从resoucemanager上运行</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>yarn-daemon.sh stop resourcemanager
</code></pre></div><ul><li>关闭zookeeper集群；每个zk服务器运行</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>zkServer.sh stop
</code></pre></div><h5 id="常用命令"><a href="#常用命令" class="header-anchor">#</a> 常用命令</h5> <ul><li>单独启动namenode</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>hadoop-daemon.sh start namenode
</code></pre></div><ul><li>单独启动datanode</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>hadoop-daemon.sh start datanode
</code></pre></div><ul><li>单独启动journalnode</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>hadoop-daemon.sh start journalnode
</code></pre></div><ul><li>启动zookeeper</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>./zkServer.sh start
</code></pre></div><ul><li>启动hdfs</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>start-dfs.sh
</code></pre></div><ul><li>启动yarn</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>start-yarn.sh
</code></pre></div><ul><li>单独启动resorucemanager</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>yarn-daemon.sh start resouremanger
</code></pre></div><ul><li>查看namenode状态（namenode1）</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>hdfs haadmin -getServiceState nn1
</code></pre></div><ul><li>查看resourcemanager状态（resourcemanager2）</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> rmadmin -getServiceState rm2
</code></pre></div><h2 id="zookeeper学习目标"><a href="#zookeeper学习目标" class="header-anchor">#</a> zookeeper学习目标</h2> <ol><li>学会<code>ZooKeeper</code>的基本使用：命令行、<code>Java</code>编程</li> <li>理解<code>ZooKeeper watcher</code>监听器工作原理：注册、监听事件、回调函数（考点）</li> <li>能独立描述出<code>ZooKeeper</code>选举过程（难点、考点）</li> <li>理解、并讲述客户端从<code>ZooKeeper</code>读写的过程（考点）</li></ol> <h2 id="zookeeper介绍"><a href="#zookeeper介绍" class="header-anchor">#</a> ZooKeeper介绍</h2> <ul><li><p><code>Zookeeper</code>是一个分布式协调框架，是<code>Google</code>的<code>Chubby</code>的一个开源实现版。</p></li> <li><p><code>ZooKeeper</code>是一个开源的<strong>主从架构</strong>的分布式框架，<code>leader</code>为主；<code>follower</code>为从，为其他的分布式框架<strong>提供协调服务（service）</strong>。</p></li> <li><p><code>Zookeeper</code> 作为一个分布式的服务框架</p> <ul><li>它提供类似于<code>linux</code>文件系统（有<strong>目录节点树</strong>）的简版文件系统来存储数据</li> <li><code>Zookeeper</code> 维护和<strong>监控</strong>存储的数据的<strong>状态变化</strong>，通过监控这些数据状态的变化，从而达到基于数据的集群管理</li> <li>主要用来解决分布式集群中应用系统的<strong>一致性</strong>问题</li></ul> <p><strong>hadoop生态圈：</strong></p></li></ul> <p><img src="/assets/img/Image201906091839.753a3802.png" alt=""></p> <p><img src="/assets/img/zkservice.3119bdf6.jpg" alt=""></p> <h2 id="为什么要用zookeeper"><a href="#为什么要用zookeeper" class="header-anchor">#</a> 为什么要用ZooKeeper</h2> <ul><li><p>分布式框架多个独立的程序协同工作比较复杂</p> <ul><li><strong>开发人员容易花较多的精力实现如何使多个程序协同工作的逻辑</strong></li> <li>导致没有时间更好的思考实现程序本身的逻辑</li> <li>或者开发人员对程序间的协同工作关注不够，造成协调问题</li> <li>且这个分布式框架中协同工作的逻辑是共性的需求</li></ul></li> <li><p>ZooKeeper简单易用，能够很好的解决分布式框架在运行中，出现的各种协调问题。</p> <ul><li>比如<strong>集群<code>master</code>主备切换、节点的上下线感知、统一命名服务、状态同步服务、集群管理、分布式应用配置管理</strong>等等</li></ul></li></ul> <h2 id="zkcli命令行操作zookeeper集群"><a href="#zkcli命令行操作zookeeper集群" class="header-anchor">#</a> zkCli命令行操作Zookeeper集群</h2> <h6 id="zookeeper脚本存放路径"><a href="#zookeeper脚本存放路径" class="header-anchor">#</a> zookeeper脚本存放路径</h6> <div class="language- extra-class"><pre class="language-text"><code>/kkb/install/zookeeper-3.4.5-cdh5.14.2/bin
</code></pre></div><h6 id="zookeeper启动与关闭"><a href="#zookeeper启动与关闭" class="header-anchor">#</a> zookeeper启动与关闭</h6> <p>特别注意，启动zk集群的时候每个节点都要执行启动命令，否则报错。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## 启动ZooKeeper集群；在ZooKeeper集群中的每个节点执行此命令</span>
<span class="token variable">${ZK_HOME}</span>/bin/zkServer.sh start
<span class="token comment">## 停止ZooKeeper集群（每个节点执行以下命令）</span>
<span class="token variable">${ZK_HOME}</span>/bin/zkServer.sh stop
<span class="token comment">## 查看集群状态（每个节点执行此命令）</span>
<span class="token variable">${ZK_HOME}</span>/bin/zkServer.sh status
</code></pre></div><h6 id="客户端连接zkserver服务器"><a href="#客户端连接zkserver服务器" class="header-anchor">#</a> 客户端连接zkServer服务器</h6> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## 使用ZooKeeper自带的脚本，连接ZooKeeper的服务器</span>
zkCli.sh -server node01:2181,node02:2181,node03:2181

<span class="token comment">## -server选项后指定参数node01:2181,node02:2181,node03:2181</span>
<span class="token comment">#客户端会随机的连接三个服务器中的一个</span>
</code></pre></div><h6 id="查看通信端口"><a href="#查看通信端口" class="header-anchor">#</a> 查看通信端口</h6> <p>查看<code>${ZK_HOME}/conf/zoo.cfg</code>配置文件：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vi</span> /kkb/install/zookeeper-3.4.5-cdh5.14.2/conf/zoo.cfg

<span class="token comment">## The number of milliseconds of each tick</span>
<span class="token assign-left variable">tickTime</span><span class="token operator">=</span><span class="token number">2000</span> <span class="token comment">#集群进行通信的基本时间单位，2000毫秒</span>

<span class="token comment">## The number of ticks that the initial </span>
<span class="token comment">## synchronization phase can take</span>
<span class="token assign-left variable">initLimit</span><span class="token operator">=</span><span class="token number">10</span>  <span class="token comment">#集在启动的时候初始化的最长时间： 10*2000毫秒</span>

<span class="token comment">## The number of ticks that can pass between </span>
<span class="token comment">## sending a request and getting an acknowledgement</span>
<span class="token assign-left variable">syncLimit</span><span class="token operator">=</span><span class="token number">5</span>  <span class="token comment">#主节点与从节点进行通信的时间</span>

<span class="token comment">## the directory where the snapshot is stored.</span>
<span class="token comment">## do not use /tmp for storage, /tmp here is just </span>
<span class="token comment">## example sakes.</span>
<span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/kkb/install/zookeeper-3.4.5-cdh5.14.2/zkdatas
<span class="token comment">#往zk集群读写数据的路径，每个zk服务器都有这个路径</span>

<span class="token comment">## the port at which the clients will connect</span>
<span class="token assign-left variable">clientPort</span><span class="token operator">=</span><span class="token number">2181</span>  <span class="token comment">#客户端与集群通信的端口</span>

<span class="token comment">## the maximum number of client connections.</span>
<span class="token comment">## increase this if you need to handle more clients</span>
<span class="token comment">#maxClientCnxns=60</span>
<span class="token comment">#</span>
<span class="token comment">## Be sure to read the maintenance section of the </span>
<span class="token comment">## administrator guide before turning on autopurge.</span>
<span class="token comment">#</span>
<span class="token comment">## http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span>
<span class="token comment">#</span>
<span class="token comment">## The number of snapshots to retain in dataDir</span>
autopurge.snapRetainCount<span class="token operator">=</span><span class="token number">3</span>  <span class="token comment">#快照默认保存多少个</span>
<span class="token comment">## Purge task interval in hours</span>
<span class="token comment">## Set to &quot;0&quot; to disable auto purge feature</span>
autopurge.purgeInterval<span class="token operator">=</span><span class="token number">1</span>  <span class="token comment">#每隔1小时清理以下快照</span>

server.1<span class="token operator">=</span>node01:2888:3888  
server.2<span class="token operator">=</span>node02:2888:3888 
server.3<span class="token operator">=</span>node03:2888:3888
<span class="token comment">#上面的1、2、3是服务器的id号，2888是zk集群内部各个服务器之间的通信端口，3888是用于选举的端口</span>
</code></pre></div><h6 id="查看支持的命令"><a href="#查看支持的命令" class="header-anchor">#</a> 查看支持的命令</h6> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>zk: node01:2181,node02:2181,node03:2181<span class="token punctuation">(</span>CLOSED<span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token builtin class-name">help</span>
ZooKeeper -server host:port cmd args
        <span class="token function">stat</span> path <span class="token punctuation">[</span>watch<span class="token punctuation">]</span>  <span class="token comment">#查看path节点状态（可设置watcher)</span>
        <span class="token builtin class-name">set</span> path data <span class="token punctuation">[</span>version<span class="token punctuation">]</span> <span class="token comment">#查看节点数据</span>
        <span class="token function">ls</span> path <span class="token punctuation">[</span>watch<span class="token punctuation">]</span> <span class="token comment">#查看节点有哪些子节点（可设置watcher）</span>
        delquota <span class="token punctuation">[</span>-n<span class="token operator">|</span>-b<span class="token punctuation">]</span> path
        ls2 path <span class="token punctuation">[</span>watch<span class="token punctuation">]</span> <span class="token comment">#查看节点有哪些子节点、状态、相当于ls+stat(可设置watcher)</span>
        setAcl path acl <span class="token comment">#设置访问控制列表</span>
        setquota -n<span class="token operator">|</span>-b val path
        <span class="token function">history</span>  <span class="token comment">#查看session中，输入过的命令</span>
        redo cmdno
        printwatches on<span class="token operator">|</span>off
        delete path <span class="token punctuation">[</span>version<span class="token punctuation">]</span> <span class="token comment">#删除节点</span>
        <span class="token function">sync</span> path
        listquota path
        rmr path  <span class="token comment">#删除节点</span>
        get path <span class="token punctuation">[</span>watch<span class="token punctuation">]</span> <span class="token comment">#获得节点各种数据（可设置watcher）</span>
        create <span class="token punctuation">[</span>-s<span class="token punctuation">]</span> <span class="token punctuation">[</span>-e<span class="token punctuation">]</span> path data acl <span class="token comment">#创建节点并设置数据</span>
        addauth scheme auth
        quit <span class="token comment">#退出命令行</span>
        getAcl path
        close <span class="token comment">#关闭session</span>
        connect host:port  <span class="token comment">#连接zookeeper集群服务器</span>
</code></pre></div><h6 id="常用命令-2"><a href="#常用命令-2" class="header-anchor">#</a> 常用命令</h6> <p>注意：<code>zk</code>集群的每个服务器的文件系统的内容都是一致的，比如说，往<code>node01</code>上的<code>zk</code>服务器的文件系统写入数据，那么<code>node02</code>和<code>node03</code>上的<code>zk</code>服务器的文件系统也会写入相同的数据。（原理后面会讲）</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#查看ZooKeeper根目录/下的文件列表</span>
<span class="token function">ls</span> /
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#创建节点，并指定数据</span>
create /kkb	krystal <span class="token comment">#创建节点的时候一定要指定数据</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#获得某节点的数据</span>
get /kkb

krystal
cZxid <span class="token operator">=</span> 0x300000007
ctime <span class="token operator">=</span> Tue Feb <span class="token number">18</span> 00:26:33 CST <span class="token number">2020</span>
mZxid <span class="token operator">=</span> 0x300000007
mtime <span class="token operator">=</span> Tue Feb <span class="token number">18</span> 00:26:33 CST <span class="token number">2020</span>
pZxid <span class="token operator">=</span> 0x300000007
cversion <span class="token operator">=</span> <span class="token number">0</span>
dataVersion <span class="token operator">=</span> <span class="token number">0</span>
aclVersion <span class="token operator">=</span> <span class="token number">0</span>
ephemeralOwner <span class="token operator">=</span> 0x0
dataLength <span class="token operator">=</span> <span class="token number">7</span>
numChildren <span class="token operator">=</span> <span class="token number">0</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#修改节点的数据</span>
<span class="token builtin class-name">set</span> /kkb kkb01

<span class="token comment">#删除节点</span>
delete /kkb
</code></pre></div><h2 id="java-api编程-重点"><a href="#java-api编程-重点" class="header-anchor">#</a> Java API编程（重点 ）</h2> <h3 id="原生api编程"><a href="#原生api编程" class="header-anchor">#</a> 原生API编程</h3> <p>比较复杂</p> <h3 id="curator编程"><a href="#curator编程" class="header-anchor">#</a> curator编程</h3> <p><code>Curator</code>对<code>ZooKeeper</code>的<code>api</code>做了封装，提供简单易用的<code>api</code>。它的风格是<code>Curator</code>链式编程，可以参考《使用<code>curator</code>做<code>zk</code>编程》。<a href="http://curator.apache.org/" target="_blank" rel="noopener noreferrer">Curator官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：http://curator.apache.org/</p> <h4 id="创建maven工程"><a href="#创建maven工程" class="header-anchor">#</a> 创建Maven工程</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>MyZookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.4.13<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.curator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>curator-recipes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.curator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>curator-framework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.testng<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>testng<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="案例1"><a href="#案例1" class="header-anchor">#</a> 案例1</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>jimmy<span class="token punctuation">.</span>day04</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">CuratorFramework</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">CuratorFrameworkFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>recipes<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">ChildData</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>recipes<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">TreeCache</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>recipes<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">TreeCacheEvent</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>recipes<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">TreeCacheListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>retry<span class="token punctuation">.</span></span><span class="token class-name">RetryNTimes</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">CreateMode</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">After</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Before</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CuratorClientDemo</span> <span class="token punctuation">{</span>
    <span class="token comment">//设置要连接的zookeeper的服务器</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ZK_ADDRESS <span class="token operator">=</span> <span class="token string">&quot;node01:2181,node02:2181,node03:2181&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//设置要操作zk节点ZNode</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ZK_PATH <span class="token operator">=</span> <span class="token string">&quot;/zk_test&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ZK_PATH01 <span class="token operator">=</span> <span class="token string">&quot;/beijing/goddess/anzhulababy&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token class-name">CuratorFramework</span> client <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Before</span>
    <span class="token comment">//初始化，建立连接，运行@Test方法之前就会执行这个方法</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//客户端会随机连接某个zk服务器，如果连接失败，就会重新尝试连接到另一个服务器</span>
        <span class="token comment">//设置重试连接策略，失败重试次数；10,每次休眠（重试间隔）5000毫秒</span>
        <span class="token class-name">RetryNTimes</span> retryPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RetryNTimes</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//获得客户端对象，参数1：指定连接的服务器集端口列表；参数2：重试策略</span>
        client <span class="token operator">=</span> <span class="token class-name">CuratorFrameworkFactory</span><span class="token punctuation">.</span><span class="token function">newClient</span><span class="token punctuation">(</span>ZK_ADDRESS<span class="token punctuation">,</span> retryPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动客户端，连接到zk集群</span>
        client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;zk client start successfully!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//运行@Test方法后才会执行该方法</span>
    <span class="token annotation punctuation">@After</span>
    <span class="token comment">//关闭连接</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;close session&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//运行@Before方法之后执行这个方法</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token comment">// 创建永久节点</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createPersistentZNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> zNodeData <span class="token operator">=</span> <span class="token string">&quot;火辣的&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">///a/b/c</span>
        client<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">creatingParentsIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>          <span class="token comment">//如果父目录不存在，则创建</span>
                <span class="token function">withMode</span><span class="token punctuation">(</span><span class="token class-name">CreateMode</span><span class="token punctuation">.</span>PERSISTENT<span class="token punctuation">)</span><span class="token punctuation">.</span>    <span class="token comment">//创建永久节点</span>
                <span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">&quot;/beijing/goddess/anzhulababy&quot;</span><span class="token punctuation">,</span> zNodeData<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//指定路径及节点数据</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token comment">// 创建临时节点</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createEphemeralZNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> zNodeData2 <span class="token operator">=</span> <span class="token string">&quot;流星雨&quot;</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">creatingParentsIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">withMode</span><span class="token punctuation">(</span><span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL<span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token comment">//ɪˈfemərəl</span>
                <span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">&quot;/beijing/star&quot;</span><span class="token punctuation">,</span> zNodeData2<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token comment">//查询znode数据</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryZNodeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 查询列表</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">print</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//查询节点数据</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> ZK_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">checkExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span>ZK_PATH<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//判断znode是否存在</span>
            <span class="token function">print</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span>ZK_PATH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果存在则获得znode的数据</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;节点不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">modifyZNodeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//修改前的数据</span>
        <span class="token function">print</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span>ZK_PATH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> data2 <span class="token operator">=</span> <span class="token string">&quot;welcome to jumanji&quot;</span><span class="token punctuation">;</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;set&quot;</span><span class="token punctuation">,</span> ZK_PATH<span class="token punctuation">,</span> data2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 修改节点数据</span>
        client<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span>ZK_PATH<span class="token punctuation">,</span> data2<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> ZK_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//修改后的数据</span>
        <span class="token function">print</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span>ZK_PATH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteZNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 删除节点</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;delete&quot;</span><span class="token punctuation">,</span> ZK_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span>ZK_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">print</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token comment">//监听ZNode</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">watchZNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token comment">//cache: TreeCache\PathChildrenCache\DataCache</span>
        <span class="token comment">//设置节点的cache缓存对象</span>
        <span class="token class-name">TreeCache</span> treeCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeCache</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token string">&quot;/zk_test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置监听器</span>
        treeCache<span class="token punctuation">.</span><span class="token function">getListenable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TreeCacheListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//处理过程：</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">childEvent</span><span class="token punctuation">(</span><span class="token class-name">CuratorFramework</span> client<span class="token punctuation">,</span> <span class="token class-name">TreeCacheEvent</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token class-name">ChildData</span> data <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">case</span> NODE_ADDED<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>添加了节点
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;NODE_ADDED : &quot;</span> <span class="token operator">+</span> data<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;  数据:&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">case</span> NODE_REMOVED<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>节点被删除了
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;NODE_REMOVED : &quot;</span> <span class="token operator">+</span> data<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;  数据:&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">case</span> NODE_UPDATED<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>数据被更新了
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;NODE_UPDATED : &quot;</span> <span class="token operator">+</span> data<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;  数据:&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">default</span><span class="token operator">:</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;data is null : &quot;</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//开始监听</span>
        treeCache<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//关闭cache</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;关闭treeCache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        treeCache<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">CuratorClientDemo</span> ccd<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">CuratorClientDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ccd<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ccd<span class="token punctuation">.</span><span class="token function">createPersistentZNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ccd<span class="token punctuation">.</span><span class="token function">createEphemeralZNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ccd<span class="token punctuation">.</span><span class="token function">queryZNodeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ccd<span class="token punctuation">.</span><span class="token function">modifyZNodeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ccd<span class="token punctuation">.</span><span class="token function">deleteZNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ccd<span class="token punctuation">.</span><span class="token function">watchZNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ccd<span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> cmds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> text <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;$ &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> cmd <span class="token operator">:</span> cmds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            text<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">Object</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>
                result <span class="token keyword">instanceof</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
                        <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> result<span class="token punctuation">)</span>
                        <span class="token operator">:</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>补充：</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Before</span> – 表示在任意使用<span class="token annotation punctuation">@Test</span>注解标注的<span class="token keyword">public</span> <span class="token keyword">void</span>方法执行之前执行
<span class="token annotation punctuation">@After</span> – 表示在任意使用<span class="token annotation punctuation">@Test</span>注解标注的<span class="token keyword">public</span> <span class="token keyword">void</span>方法执行之后执行
<span class="token annotation punctuation">@Test</span> – 使用该注解标注的<span class="token keyword">public</span> <span class="token keyword">void</span>方法会表示为一个测试方法
</code></pre></div><h4 id="案例2-另一中监听器"><a href="#案例2-另一中监听器" class="header-anchor">#</a> 案例2：另一中监听器</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>jimmy<span class="token punctuation">.</span>day04</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">CuratorFramework</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">CuratorFrameworkFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>recipes<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">PathChildrenCache</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>recipes<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">PathChildrenCacheEvent</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>recipes<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">PathChildrenCacheListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>retry<span class="token punctuation">.</span></span><span class="token class-name">RetryNTimes</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">ZKPaths</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CuratorWatcherDemo</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * Zookeeper info
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ZK_ADDRESS <span class="token operator">=</span> <span class="token string">&quot;note01:2181,node02:2181,node03:2181&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ZK_PATH <span class="token operator">=</span> <span class="token string">&quot;/zktest&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.Connect to zk</span>
        <span class="token class-name">CuratorFramework</span> client <span class="token operator">=</span> <span class="token class-name">CuratorFrameworkFactory</span><span class="token punctuation">.</span><span class="token function">newClient</span><span class="token punctuation">(</span>
                ZK_ADDRESS<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">RetryNTimes</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;zk client start successfully!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//path cache</span>
        <span class="token comment">///zktest/b/a</span>
        <span class="token class-name">PathChildrenCache</span> pathCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PathChildrenCache</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> ZK_PATH<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//只能监听ZK_PATH对应节点下一级目录的子节点的变化内容</span>
        <span class="token comment">// 即只能监听/ZK_PATH/node1的变化，而不能监听/ZK_PATH/node1/node2 的变化</span>
        
        <span class="token comment">//Listener for PathChildrenCache changes</span>
        <span class="token class-name">PathChildrenCacheListener</span> listener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PathChildrenCacheListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">childEvent</span><span class="token punctuation">(</span><span class="token class-name">CuratorFramework</span> client<span class="token punctuation">,</span> <span class="token class-name">PathChildrenCacheEvent</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> CHILD_ADDED<span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Node added: &quot;</span> <span class="token operator">+</span> <span class="token class-name">ZKPaths</span><span class="token punctuation">.</span><span class="token function">getNodeFromPath</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">case</span> CHILD_UPDATED<span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Node changed: &quot;</span> <span class="token operator">+</span> <span class="token class-name">ZKPaths</span><span class="token punctuation">.</span><span class="token function">getNodeFromPath</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">case</span> CHILD_REMOVED<span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Node removed: &quot;</span> <span class="token operator">+</span> <span class="token class-name">ZKPaths</span><span class="token punctuation">.</span><span class="token function">getNodeFromPath</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">default</span><span class="token operator">:</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
              java  <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">//添加监听器</span>
        pathCache<span class="token punctuation">.</span><span class="token function">getListenable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//开启缓存</span>
        pathCache<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token class-name">PathChildrenCache<span class="token punctuation">.</span>StartMode</span><span class="token punctuation">.</span>BUILD_INITIAL_CACHE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Register zk pathCache successfully!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//关闭缓存</span>
        pathCache<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//关闭zk连接</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="zookeeper基本概念和操作-todo"><a href="#zookeeper基本概念和操作-todo" class="header-anchor">#</a> Zookeeper基本概念和操作(TODO)</h2> <blockquote><p>分布式通信有几种方式</p> <p>1、直接通过网络连接的方式进行通信</p> <p>2、通过共享存储的方式，来进行通信或数据的传输</p> <p>ZooKeeper使用第二种方式，提供分布式协调服务</p></blockquote> <h2 id="zookeeper数据结构"><a href="#zookeeper数据结构" class="header-anchor">#</a> ZooKeeper数据结构</h2> <p><code>ZooKeeper</code>主要由以下三个部分实现</p> <ol><li>简版文件系统(<code>Znode</code>)：基于类似于文件系统的<strong>目录节点树</strong>方式的数据存储</li> <li>原语：可简单理解成ZooKeeper的基本的命令</li> <li>通知机制(<code>Watcher</code>)。</li></ol> <p><strong>watcher示意图：</strong></p> <p><img src="/assets/img/image-20200218003759092.0ae8a089.png" alt="image-20200218003759092"></p> <h2 id="zookeeper数据节点znode"><a href="#zookeeper数据节点znode" class="header-anchor">#</a> Zookeeper数据节点ZNode</h2> <p>在<code>Zookeeper</code>里，我们不把文件系统的目录称为目录，而是称为节点<code>ZNode</code>。</p> <p><strong><code>ZNode</code> 分为四类：</strong></p> <table><thead><tr><th></th> <th>持久节点</th> <th>临时节点</th></tr></thead> <tbody><tr><td>非有序节点</td> <td><code>create</code></td> <td><code>create -e</code></td></tr> <tr><td>有序节点</td> <td><code>create -s</code></td> <td><code>create -s -e</code></td></tr></tbody></table> <h4 id="持久节点"><a href="#持久节点" class="header-anchor">#</a> 持久节点</h4> <p>持久节点在会话结束之后，还会依然存在<code>zk</code>文件系统里。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## 创建持久节点/zk_test，并设置数据my_data</span>
create /zk_test my_data
<span class="token comment">## 持久节点，只有显示的调用命令，才能删除永久节点</span>
delete /zk_test
</code></pre></div><h4 id="临时节点"><a href="#临时节点" class="header-anchor">#</a> 临时节点</h4> <p>临时节点的生命周期跟客户端会话<code>session</code>绑定，<strong>一旦会话失效，临时节点被删除</strong>。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## client1上创建临时节点</span>
create -e /tmp tmpdata

<span class="token comment">## client2上查看client1创建的临时节点</span>
<span class="token function">ls</span> /

<span class="token comment">## client1断开连接</span>
close

<span class="token comment">## client2上观察现象，发现临时节点被自动删除</span>
<span class="token function">ls</span> /
</code></pre></div><h4 id="非有序节点"><a href="#非有序节点" class="header-anchor">#</a> 非有序节点</h4> <p>通过上面的方式创建的节点，<strong>默认都是非有序的</strong>。</p> <h4 id="有序节点"><a href="#有序节点" class="header-anchor">#</a> 有序节点</h4> <p><code>ZNode</code>也可以设置为有序节点，主要是为了避免多个客户端写入同名称的文件导致文件重名的情况。防止多个不同的客户端在同一目录下，创建同名<code>ZNode</code>，由于重名，导致创建失败。</p> <p><img src="/assets/img/image-20200218005827323.343e6553.png" alt="image-20200218005827323"></p> <p>一旦节点被标记上这个属性，那么在这个节点被创建时，<code>ZooKeeper</code> 就会自动在其节点后面追加上一个整型数字。这个整数是一个由父节点维护的自增数字。</p> <p>创建有序节点，使用<code>-s</code>选项：<code>create -s</code> ：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## 创建持久、有序节点</span>
create -s /test01 test01-data
<span class="token comment">## Created /test010000000009</span>
</code></pre></div><h2 id="会话-session"><a href="#会话-session" class="header-anchor">#</a> 会话（Session)</h2> <h4 id="什么是会话"><a href="#什么是会话" class="header-anchor">#</a> 什么是会话</h4> <ul><li><p>客户端要对<code>ZooKeeper</code>集群进行读写操作，得先与某一<code>ZooKeeper</code>服务器建立<strong>TCP长连接</strong>；<strong>此TCP长连接称为建立一个会话<code>Session</code>。</strong></p></li> <li><p>每个会话有超时时间：<code>SessionTimeout</code></p> <ul><li>当客户端与集群建立会话后，如果超过<code>SessionTimeout</code>时间，两者间没有通信，会话超时</li></ul></li></ul> <h4 id="会话的特点"><a href="#会话的特点" class="header-anchor">#</a> 会话的特点</h4> <ul><li>客户端打开一个<code>Session</code>中的请求以FIFO（先进先出）的顺序执行；
<ul><li>比如，客户端<code>client01</code>与集群建立会话后，先发出一个<code>create</code>请求，再发出一个<code>get</code>请求。那么在执行时，会先执行<code>create</code>，再执行<code>ge</code>t</li></ul></li> <li>若打开两个<code>Session</code>，无法保证<code>Session</code>间的请求按照<code>FIFO</code>策略执行；只能保证一个<code>session</code>中的请求的按照<code>FIFO</code>策略执行。</li></ul> <h4 id="会话的生命周期"><a href="#会话的生命周期" class="header-anchor">#</a> 会话的生命周期</h4> <p>会话的生命周期</p> <ul><li>未建立连接</li> <li>正在连接</li> <li>已连接</li> <li>关闭连接</li></ul> <p><img src="/assets/img/Image201905311514.5c9ad465.png" alt=""></p> <h2 id="请求"><a href="#请求" class="header-anchor">#</a> 请求</h2> <ul><li>读写请求
<ul><li>写请求：通过客户端向<code>ZooKeeper</code>集群中写数据</li> <li>读请求：通过客户端从<code>ZooKeeper</code>集群中读数据</li></ul></li></ul> <p><img src="/assets/img/zkservice.3119bdf6.jpg" alt="ZooKeeper官网架构图"></p> <h2 id="事务zxid"><a href="#事务zxid" class="header-anchor">#</a> 事务zxid</h2> <p>客户端的写请求，会对<code>ZooKeeper</code>中的数据做出更改；如增删改的操作。**每次写请求，都会生成一次事务。**每个事务有一个全局唯一的事务<code>ID</code>，用 <code>ZXID</code> 表示；全局自增</p> <h4 id="事务的特点-acid"><a href="#事务的特点-acid" class="header-anchor">#</a> 事务的特点：ACID</h4> <blockquote><ol><li>原子性（<code>Atomicity</code>）：事务是一个不可分割的工作单位，事务中的操作要么都发生，要么都不发生。</li> <li>一致性（<code>Consistency</code>）：一致性是指事务执行结束后，数据库的完整性约束没有被破坏，事务执行的前后都是合法的数据状态。</li> <li>隔离性（<code>Isolation</code>）：隔离性是多个用户并发访问数据库时，数据库为每一个用户开启的事务，不能被其他事务的操作数据所干扰，多个并发事务之间要相互隔离。</li> <li>持久性（<code>Durability</code>）：持久性是指一个事务一旦被提交，它对数据库中数据的改变就是永久性的，接下来即使数据库发生故障也不应该对其有任何影响。</li></ol> <p><strong>原子性示意图：</strong></p> <p><img src="/assets/img/image-20200218014020278.9b6f0647.png" alt="image-20200218014020278"></p> <p><strong>持久性的理解：</strong></p> <p>操作前A：800，B：200</p> <p>操作后A：600，B：400</p> <p>如果在操作前（事务还没有提交）服务器宕机或者断电，那么重启数据库以后，数据状态应该为</p> <p>A：800，B：200</p> <p>如果在操作后（事务已经提交）服务器宕机或者断电，那么重启数据库以后，数据状态应该为</p> <p>A：600，B：400</p></blockquote> <h4 id="zxid的结构"><a href="#zxid的结构" class="header-anchor">#</a> ZXID的结构：</h4> <ul><li>通常是一个64位的数字。由**epoch+counter（累加器）**组成</li> <li><code>epoch</code>、<code>counter</code>各32位</li></ul> <p><img src="/assets/img/Image201906140813.48a253d7.png" alt=""></p> <h2 id="watcher-监视与通知"><a href="#watcher-监视与通知" class="header-anchor">#</a> Watcher：监视与通知</h2> <h4 id="为什么要有watcher"><a href="#为什么要有watcher" class="header-anchor">#</a> 为什么要有Watcher？</h4> <p>首先思考一个问题：客户端如何获取<code>ZooKeeper</code>服务器上的<strong>最新数据</strong>？</p> <ul><li><p><strong>方式一</strong>：轮询</p> <p><code>ZooKeeper</code>以远程服务的方式，被客户端访问；客户端以轮询的方式获得<code>znode</code>数据，效率会比较低（代价比较大）</p></li></ul> <p><img src="/assets/img/Image201905291811.d8503bda.png" alt=""></p> <ul><li><p><strong>方式二</strong>：基于通知的机制</p> <p>客户端在<code>znode</code>上注册一个<code>Watcher</code>监视器，当<code>znode</code>上数据出现变化，<code>watcher</code>监测到此变化，通知客户端，然后客户端就可以获取最新数据。</p></li></ul> <p><img src="/assets/img/Image201905291818.f3e36e6c.png" alt=""></p> <p>可以看到，通过第二种<code>watcher</code>的方式，明显比第一种方法效率高。</p> <h4 id="什么是watcher"><a href="#什么是watcher" class="header-anchor">#</a> 什么是Watcher?</h4> <ul><li><strong>客户端在服务器端，注册的事件监听器</strong>；</li> <li><code>watcher</code>用于监听<code>znode</code>上的某些事件
<ul><li>比如<code>znode</code>数据修改、节点增删等；</li> <li>当监听到事件后，<code>watcher</code>会触发通知客户端</li></ul></li></ul> <h4 id="如何设置watcher"><a href="#如何设置watcher" class="header-anchor">#</a> 如何设置Watcher</h4> <blockquote><p>注意：<strong>Watcher是一个单次触发的操作,被触发过一次后就时效了</strong></p></blockquote> <ul><li>可以设置<code>watcher</code>的命令如下：</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">stat</span> path <span class="token punctuation">[</span>watch<span class="token punctuation">]</span>  <span class="token comment">#查看path节点状态（可设置watcher)</span>
<span class="token function">ls</span> path <span class="token punctuation">[</span>watch<span class="token punctuation">]</span> <span class="token comment">#查看节点有哪些子节点（可设置watcher）</span>
ls2 path <span class="token punctuation">[</span>watch<span class="token punctuation">]</span> <span class="token comment">#查看节点有哪些子节点、状态、相当于ls+stat(可设置watcher)</span>
get path <span class="token punctuation">[</span>watch<span class="token punctuation">]</span> <span class="token comment">#获得节点各种数据（可设置watcher）</span>
</code></pre></div><h5 id="示例1-使用ls-path-watch-设置监听器"><a href="#示例1-使用ls-path-watch-设置监听器" class="header-anchor">#</a> 示例1：使用ls path [watch]设置监听器</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#设置监测子节点有没有变化的监听器：</span>

<span class="token comment">#node01 上执行</span>
create /zk_test krystal <span class="token comment">#创建节点</span>
<span class="token function">ls</span> /zk_test <span class="token function">watch</span>  <span class="token comment">#设置监听器</span>

<span class="token comment">#node02 上执行</span>
create /zk_test/dir01 dir01-data

<span class="token comment">#观察node-01上变化</span>
<span class="token punctuation">[</span>zk: node-01:2181,node-02:2181,node-03:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">87</span><span class="token punctuation">]</span> 
WATCHER::

WatchedEvent state:SyncConnected type:NodeChildrenChanged path:/zk_test

<span class="token comment">#node02 上执行</span>
create /zk_test/dir02 dir01-data

<span class="token comment">#再观察node-01上变化，此时没有变化，因为监听器触发过后就失效了</span>
</code></pre></div><h5 id="示例2-使用get-path-watch-设置监听器"><a href="#示例2-使用get-path-watch-设置监听器" class="header-anchor">#</a> <strong>示例2</strong>：使用get path [watch]设置监听器</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#监控节点数据的变化的监听器；</span>
<span class="token comment">#node02上</span>
get /zk_test <span class="token function">watch</span>

<span class="token comment">#node03上</span>
<span class="token builtin class-name">set</span> /zk_test <span class="token string">&quot;junk01&quot;</span>
<span class="token comment">#观察node2上cli的输出，检测到变化</span>
</code></pre></div><h5 id="示例3-节点上下线监控"><a href="#示例3-节点上下线监控" class="header-anchor">#</a> <strong>示例3</strong>：节点上下线监控</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#在client1操作</span>
<span class="token comment">## 创建临时节点</span>

create -e /zk_tmp tmp-data
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## 在client2操作</span>
<span class="token comment">## 在/zk_tmp注册监听器</span>
<span class="token function">ls</span> /zk_tmp <span class="token function">watch</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#在client1操作</span>
<span class="token comment">## 模拟节点下线</span>
close
</code></pre></div><p>观察<code>client2</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>WATCHER::

WatchedEvent state:SyncConnected type:NodeDeleted path:/zk_tmp
</code></pre></div><p><strong>上下线感知原理：</strong></p> <ol><li>节点<code>1</code>（<code>client1</code>）创建临时节点</li> <li>节点2（<code>client2</code>）在临时节点，注册监听器<code>watcher</code></li> <li>当<code>client1</code>与zk集群断开连接，临时节点会被删除</li> <li><code>watcher</code>发送消息，通知<code>client2</code>，临时节点被删除的事件</li> <li>注意： 节点1时某分布式集群的节点，而临时节点是说zookeeper服务器文件系统的一个目录</li></ol> <p><strong>用到的zk特性：Watcher+临时节点</strong>。通过这种方式，<strong>检测和被检测系统不需要直接关联（如client1与client2）</strong>，而是通过ZK上的某个节点进行关联，大大减少了系统<strong>耦合</strong>。</p> <p><img src="/assets/img/image-20200218022634477.1c5b3520.png" alt="image-20200218022634477"></p> <h2 id="zookeeper工作原理"><a href="#zookeeper工作原理" class="header-anchor">#</a> ZooKeeper工作原理</h2> <ul><li><code>ZooKeeper</code>使用原子广播协议叫做<code>Zab(ZooKeeper Automic Broadcast)</code>协议</li> <li><code>Zab</code>协议有两种模式
<ul><li><strong>恢复模式（选主）</strong>：因为<code>ZooKeeper</code>也是主从架构；当<code>ZooKeeper</code>集群没有主的角色leader时，从众多服务器中选举<code>leader</code>时，处于此模式。</li> <li><strong>广播模式（同步）</strong>：当集群有了<code>leader</code>后，客户端向<code>ZooKeeper</code>集群读写数据时，集群处于此模式。</li></ul></li> <li>为了保证事务的顺序一致性，<code>ZooKeeper</code>采用了递增的事务<code>id</code>号（<code>zxid</code>）来标识事务，所有提议（<code>proposal</code>）都有<code>zxid</code></li></ul> <h2 id="hdfs-ha方案原理-重点"><a href="#hdfs-ha方案原理-重点" class="header-anchor">#</a> HDFS HA方案原理（重点）</h2> <h4 id="监听器的重要逻辑"><a href="#监听器的重要逻辑" class="header-anchor">#</a> 监听器的重要逻辑</h4> <ul><li><p>关于ZooKeeper监听器有三个重要的逻辑：</p> <ul><li><strong>注册</strong>：客户端向<code>ZooKeeper</code>集群注册监听器</li> <li><strong>监听事件</strong>：监听器负责监听特定的事件</li> <li><strong>回调函数</strong>：当监听器监听到事件的发生后，调用<strong>注册监听器时</strong>定义的回调函数。</li></ul></li></ul> <blockquote><p><strong>函数大致类型：</strong></p> <ul><li>主函数：相当于整个程序的引擎，调度各个函数按序执行</li> <li>回调函数：一个独立的功能函数，如写文件函数</li> <li>中间函数：一个介于主函数和回调函数之间的函数，登记回调函数，通知主函数，起到一个桥梁的作用</li></ul> <p><strong>回调函数</strong>就是一个通过<a href="https://baike.baidu.com/item/%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88/2674905" target="_blank" rel="noopener noreferrer">函数指针<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>调用的函数。如果你把函数的<a href="https://baike.baidu.com/item/%E6%8C%87%E9%92%88/2878304" target="_blank" rel="noopener noreferrer">指针<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（地址）作为<a href="https://baike.baidu.com/item/%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/9019335" target="_blank" rel="noopener noreferrer">参数传递<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>给另一个函数，当这个指针被用来调用其所指向的函数时，我们就说这是回调函数。回调函数不是由该函数的实现方直接调用，而是在特定的事件或条件发生时由另外的一方调用的，用于对该事件或条件进行响应。</p></blockquote> <h4 id="监听器逻辑的类比举例"><a href="#监听器逻辑的类比举例" class="header-anchor">#</a> 监听器逻辑的类比举例</h4> <ul><li><p>为了便于理解，举例：旅客住店无房可住的情况</p> <ul><li>一哥们去酒店办理入住，但是被告知目前无空房</li> <li>这哥们告诉客服：你给我记住了，帮我留意一下有没有空出的房间，如果有，及时通知我（<strong>类似注册监听器，监听特定事件</strong>）</li> <li>将近12点，有房客退房，有空闲的房间（<strong>事件</strong>）</li> <li>客服发现有空房（<strong>监听到事件</strong>）</li> <li>及时通知这哥们</li> <li>这哥们收到通知后，<strong>做一些事</strong>，比如马上从附近酒吧赶回酒店（<strong>调用回调函数</strong>）</li></ul> <p><img src="/assets/img/Image201910242342.59d1ddec.png" alt=""></p></li></ul> <h4 id="hdfs-ha原理-难点"><a href="#hdfs-ha原理-难点" class="header-anchor">#</a> HDFS HA原理（难点）</h4> <blockquote><p>关键逻辑：</p> <p>①监听器：<strong>注册、监听事件、回调函数</strong></p> <p>②共享存储：<strong>JournalNode</strong></p></blockquote> <ul><li><p>在<code>Hadoop 1.x</code>版本，<code>HDFS</code>集群的<code>NameNode</code>一直存在单点故障问题：</p> <ul><li>集群只存在一个<code>NameNode</code>节点，它维护了<code>HDFS</code>所有的元数据信息</li> <li>当该节点所在服务器宕机或者服务不可用，整个<code>HDFS</code>集群处于不可用状态</li></ul></li> <li><p><code>Hadoop 2.x</code>版本提出了高可用 (<code>High Availability</code>, <code>HA</code>) 解决方案</p></li></ul> <blockquote><p>HDFS HA方案，主要分两部分：</p> <p>①元数据同步</p> <p>②主备切换</p></blockquote> <h5 id="元数据同步原理"><a href="#元数据同步原理" class="header-anchor">#</a> 元数据同步原理</h5> <ul><li>在同一个<code>HDFS</code>集群，运行两个互为主备的<code>NameNode</code>节点。</li> <li>一台为主<code>Namenode</code>节点，处于<code>Active</code>状态，一台为备<code>NameNode</code>节点，处于<code>Standby</code>状态。</li> <li>其中只有<code>Active NameNode</code>对外提供读写服务，<code>Standby NameNode</code>会根据<code>Active NameNode</code>的状态变化，在必要时<strong>切换</strong>成<code>Active</code>状态。</li> <li><strong>JournalNode集群</strong> <ul><li>在主备切换过程中，新的<code>Active NameNode</code>必须确保与原<code>Active NamNode</code>元数据同步完成，才能对外提供服务</li> <li>所以用<code>JournalNode</code>集群作为共享存储系统；</li> <li>当客户端对<code>HDFS</code>做操作，会在<code>Active NameNode中edits.log</code>文件中作日志记录，同时日志记录也会写入<code>JournalNode</code>集群；负责存储<code>HDFS</code>新产生的元数据</li> <li>当有新数据写入<code>JournalNode</code>集群时，<code>Standby NameNode</code>能监听到此情况，将新数据同步过来</li> <li><code>Active NameNode</code>(写入)和<code>Standby NameNode(</code>读取)实现元数据同步</li> <li>另外，所有<code>datanode</code>会向两个主备<code>namenode</code>做<code>block report</code></li></ul></li></ul> <p><strong>元数据同步示意图：</strong></p> <p><img src="/assets/img/Image201905211519.44c8b9ac.png" alt=""></p> <h5 id="主备切换原理"><a href="#主备切换原理" class="header-anchor">#</a> 主备切换原理</h5> <p><img src="/assets/img/Image201909200732.2065aaa6.png" alt=""></p> <ul><li><p><strong>ZKFC涉及角色</strong></p> <ul><li>每个<code>NameNode</code>节点上各有一个<code>ZKFC</code>进程</li> <li><code>ZKFC</code>即<code>ZKFailoverController</code>，作为独立进程存在，负责控制<code>NameNode</code>的主备切换</li> <li><code>ZKFC</code>会监控<code>NameNode</code>的健康状况，当发现<code>Active NameNode</code>异常时，通过<code>Zookeeper</code>集群进行<code>namenode</code>主备选举，完成<code>Active</code>和<code>Standby</code>状态的切换
<ul><li><code>ZKFC</code>在启动时，同时会初始化<code>HealthMonitor</code>和<code>ActiveStandbyElector</code>服务</li> <li><code>ZKFC</code>同时会向<code>HealthMonitor</code>和<code>ActiveStandbyElector</code>注册相应的回调方法（如上图的①回调、②回调）</li> <li><strong>HealthMonitor</strong>定时调用<code>NameNode</code>的<code>HAServiceProtocol RPC</code>接口(monitorHealth和<code>getServiceStatus</code>)，监控<code>NameNode</code>的健康状态，并向<code>ZKFC</code>反馈</li> <li><strong>ActiveStandbyElector</strong>接收<code>ZKFC</code>的选举请求，通过<code>Zookeeper</code>自动完成<code>namenode</code>主备选举</li> <li>选举完成后回调<code>ZKFC</code>的主备切换方法对<code>NameNode</code>进行<code>Active</code>和<code>Standby</code>状态的切换</li></ul></li></ul></li> <li><p><strong>主备选举过程：</strong></p> <ul><li>//---------------------------启动<code>hadoop</code>和<code>zookeeper</code>集群，进行选举-----------------------//</li> <li>启动两个<code>NameNode</code>、<code>ZKFC</code>，此时不知道哪个是主<code>NameNode</code>、哪个备<code>NameNode</code>。</li> <li>两个<code>ZKFC</code>通过各自<code>ActiveStandbyElector</code>发起<code>NameNode</code>的主备选举，这个过程利用<code>Zookeeper</code>的写一致性和临时节点机制实现</li> <li>当发起一次<strong>主备</strong>选举时，<code>ActiveStandbyElector</code>会尝试在<code>Zookeeper</code>创建临时节点<code>/hadoop-ha/${dfs.nameservices}/ActiveStandbyElectorLock</code>，<code>Zookeeper</code>的写一致性保证最终只会有一个<code>ActiveStandbyElector</code>创建成功</li> <li><code>ActiveStandbyElector</code>从<code>ZooKeeper</code>获得选举结果</li> <li>创建成功的 <code>ActiveStandbyElector</code>回调<code>ZKFC</code>的回调方法②，把选举结果返回给<code>ZKFC</code>，<code>ZKFC</code>从而将对应的<code>NameNode</code>切换为<code>Active NameNode</code>状态</li> <li>而创建失败的<code>ActiveStandbyElector</code>也会回调ZKFC的回调方法②，将对应的<code>NameNode</code>切换为<code>Standby NameNode</code>状态</li> <li>不管是否选举成功，所有<code>ActiveStandbyElector</code>都会在<code>ActiveStandbyElectorLock</code>临时节点上注册一个<code>Watcher</code>监听器，来监听这个节点的状态变化事件</li> <li>//-------------------------------------<code>namenode</code>出现异常，进行主备切换---------------------//</li> <li>如果<code>Active NameNode</code>对应的<code>HealthMonitor</code>检测到<code>NameNode</code>状态异常时，调用回调函数1，通知对应的<code>ZKFC</code>。</li> <li><code>ZKFC</code>会调用 <code>ActiveStandbyElector</code> 方法，删除在<code>Zookeeper上</code>创建的临时节点<code>ActiveStandbyElectorLock</code>（或者<code>ActvieStandbyElector</code>与<code>ZooKeeper</code>的<code>session</code>断开，临时节点也会被删除，但有可能此时原<code>Active NameNode</code>仍然是<code>active</code>状态，会出现下面说得脑裂问题）</li> <li>此时，<code>Standby NameNode</code>的<code>ActiveStandbyElector</code>注册的<code>Watcher</code>就会监听到此节点的 <code>NodeDeleted</code>事件。</li> <li>收到这个事件后，此<code>standby NameNode</code>对应的<code>ActiveStandbyElector</code>再次发起主备选举，成功创建临时节点<code>ActiveStandbyElectorLock</code>，如果创建成功，则<code>Standby NameNode</code>被选举为<code>Active NameNode</code>（过程同上）</li></ul></li> <li><p><strong>如何防止脑裂</strong></p> <ul><li><p>脑裂</p> <p>在分布式系统中双主现象又称为脑裂，由于<code>Zookeeper</code>的“假死”、长时间的垃圾回收或其它原因都可能导致双<code>Active NameNode</code>现象，此时两个<code>NameNode</code>都可以对外提供服务，无法保证数据一致性</p></li> <li><p>隔离</p> <p>对于生产环境，这种情况的出现是毁灭性的，必须通过自带的**隔离（Fencing）**机制预防此类情况</p></li> <li><p>原理</p> <ul><li><p>//-----------------------------正常断开<code>Session</code>------------------------------------//</p></li> <li><p><code>ActiveStandbyElector</code>成功创建<code>ActiveStandbyElectorLock</code>临时节点后，会创建另一个<code>ActiveBreadCrumb</code>持久节点</p></li> <li><p><code>ActiveBreadCrumb</code>持久节点保存了<code>Active NameNode</code>的地址信息。</p></li> <li><p>当<code>Active NameNode</code>在正常的状态下断开<code>Zookeeper Session</code>，会一并删除临时节点<code>ActiveStandbyElectorLock</code>、持久节点<code>ActiveBreadCrumb</code></p></li> <li><p>//-----------------------------非正常断开<code>Session</code>------------------------------------//</p></li> <li><p>但是如果<code>ActiveStandbyElector</code>在异常的状态下关闭<code>Zookeeper Session</code>，那么<code>ActiveStandbyElectorLock</code>临时节点会被删掉，持久节点<code>ActiveBreadCrumb</code>会保留下来，<code>NameNode</code><strong>还处于active状态</strong>。或者由于<code>active NameNode</code>与<code>ZooKeeper</code>通信不畅导致，也会导致这种情况出现。</p></li> <li><p>此时<code>standby NameNode</code>监测到这种情况，成功创建临时节点，选举成功，当这个<code>NameNode</code>将由<code>standy</code>变成<code>active</code>状态之前，会发现上一个<code>Active NameNode</code>遗留下来的<code>ActiveBreadCrumb</code>节点，那么会回调<code>ZKFC</code>的方法对旧的<code>Active NameNode</code>进行<code>fencing</code>隔离</p></li> <li><p>//-------------------------------------进行隔离=====================//</p> <p>①首先<code>ZKFC</code>会尝试调用旧<code>Active NameNode</code>的<code>HAServiceProtocol RPC</code>接口的<code>transitionToStandby</code>方法，看能否将其状态切换为<code>Standby</code>。</p> <p>②如果<code>transitionToStandby</code>方法切换状态失败，那么就需要执行<code>Hadoop</code>自带的隔离措施，<code>Hadoop</code>目前主要提供两种隔离措施：
<code>sshfence：SSH to the Active NameNode and kill the process；</code> <code>shellfence：run an arbitrary shell command to fence the Active NameNode</code></p> <p>//=====================--成功<code>fencing</code>后---------------------------------//</p> <p>③只有成功地<code>fencing</code>之后，选主成功的<code>ActiveStandbyElector</code>才会回调<code>ZKFC</code>的<code>becomeActive</code>方法<code>transitionToActive</code>将对应的<code>NameNode</code>切换为<code>Active</code>，开始对外提供服务</p></li></ul></li></ul></li></ul> <h2 id="zookeeper之攘其外-重点"><a href="#zookeeper之攘其外-重点" class="header-anchor">#</a> ZooKeeper之攘其外（重点）</h2> <h4 id="zookeeper工作原理回顾"><a href="#zookeeper工作原理回顾" class="header-anchor">#</a> Zookeeper工作原理回顾</h4> <ul><li><code>ZooKeeper</code>使用原子广播协议<code>Zab(ZooKeeper Automic Broadcast)</code>，保证分布式一致性</li> <li>协议<code>Zab</code>协议有两种模式，它们分别是</li> <li>①<strong>恢复模式（选主）</strong>：因为<code>ZooKeeper</code>也是主从架构；当<code>ZooKeeper</code>集群没有主的角色<code>leader</code>时，从众多服务器中选举<code>leader</code>时，处于此模式；主要处理内部矛盾，我们称之为<strong>安其内</strong></li> <li>②<strong>广播模式（同步）</strong>：当集群有了<code>leader</code>后，客户端向<code>ZooKeeper</code>集群读写数据时，集群处于此模式；主要处理外部矛盾，我们称之为<strong>攘其外</strong></li> <li>事务</li> <li>为了保证事务的顺序一致性，<code>ZooKeeper</code>采用了递增的事务<code>id</code>号（<code>zxid</code>）来标识事务，所有提议（<code>proposal</code>）都有<code>zxid</code></li> <li>每次事务的提交，必须符合<code>quorum</code>ˈkwɔːrəm多数派</li></ul> <h4 id="zookeeper集群架构图"><a href="#zookeeper集群架构图" class="header-anchor">#</a> ZooKeeper集群架构图</h4> <ul><li><code>ZooKeeper</code>集群也是主从架构
<ul><li>主角色：<code>leader</code></li> <li>从角色：<code>follower</code>或<code>observer</code>；统称为<code>learner</code></li></ul></li></ul> <p><img src="/assets/img/zkservice-1581885316200.3119bdf6.jpg" alt=""></p> <ul><li>客户端与ZK集群交互，主要分两大类操作，读与写。</li></ul> <h4 id="读操作原理"><a href="#读操作原理" class="header-anchor">#</a> 读操作原理</h4> <p><img src="/assets/img/Image201910251149.0894c748.png" alt=""></p> <ul><li><p>常见的读取操作，如<code>ls /</code>查看目录；<code>get /zktest</code>查询<code>ZNode</code>数据</p></li> <li><p>读操作</p> <ul><li><p>客户端先与某个<code>ZK</code>服务器建立<code>Session</code></p></li> <li><p>然后，直接从此<code>ZK</code>服务器读取数据，并返回客户端即可</p></li> <li><p>关闭<code>Session</code></p></li></ul></li></ul> <h4 id="写操作原理"><a href="#写操作原理" class="header-anchor">#</a> 写操作原理</h4> <ul><li>写操作比较复杂，先举个生活中的例子：去银行存钱
<ul><li>银行柜台共有5个桂圆姐姐，编程从①到⑤，其中①②④⑤是<strong>下属follower</strong>，③是<strong>领导leader</strong></li> <li>有两个客户</li> <li>客户①找到桂圆①，说：昨天少给我存了1000万，现在需要给我加进去</li> <li>桂圆①说，对不起先生，我没有这么大的权限，请你稍等一下，我向领导<strong>leader</strong>③汇报一下</li> <li>领导③收到消息后，为了做出英明的决策，要征询下属的意见(<strong>proposal</strong>)①②④⑤</li> <li>只要有<strong>过半数quorum</strong>（5/2+1=3，包括<code>leader</code>自己）同意，则<code>leader</code>做出决定(<strong>commit</strong>)，同意此事</li> <li><code>leader</code>告知所有下属<code>follower</code>，你们都记下此事生效</li> <li>桂圆①答复客户①，说已经给您账号里加了1000万。</li></ul></li></ul> <p><strong>示意图如下：</strong></p> <p><img src="/assets/img/Image2019061212537.0f25f1ac.png" alt=""></p> <ul><li><p>客户端写操作</p> <ul><li>①客户端向<code>zk</code>集群写入数据，如<code>create /kkb</code>；与一个<code>follower</code>建立<code>Session</code>连接，从节点<code>follower01</code></li> <li>②<code>follower</code>将写请求转发给<code>leader</code></li> <li>③<code>leader</code>收到消息后，发出<strong>proposal提案</strong>（创建<code>/kkb</code>），每个<code>follower</code>先<strong>记录下</strong>要创建<code>/kkb</code></li> <li>④若超过<strong>半数quorum</strong>（包括<code>leader</code>自己）同意提案，则<code>leader</code>提交<strong>commit提案</strong>，<code>leader</code>本地创建<code>/kkb</code>节点<code>ZNode</code></li> <li>⑤<code>leader</code>通知所有<code>follower</code>，也就是<code>commit</code>提案；<code>follower</code>各自在本地创建<code>/kkb</code></li> <li>⑥<code>follower01</code>响应<code>client</code></li></ul> <p>注意：如果第一步直接就连接到了<code>leader</code>，则直接跳到第三步。</p></li></ul> <p><strong>示意图如下：</strong></p> <p><img src="/assets/img/Image201910251203.a826eb7c.png" alt=""></p> <p><img src="/assets/img/image-20200218065532250.d7957608.png" alt="image-20200218065532250"></p> <blockquote><p>补充：</p> <ul><li><p><code>zookeeper</code>集群有个特点，服务器的个数是奇数个：3、5、7...</p> <p>如果存活的服务器超过半数，那么zookeeper集群就可以正常对外服务</p></li> <li><p>假如有个<code>follower</code>因为网络不畅等问题，导致还没有写入某节点，如果这时候有客户端刚好连接上了这个<code>follower</code>，并访问该节点。那么此时就会调用<code>client.sync()</code>方法进行同步，客户端会等待<code>follower</code>与<code>leader</code>进行通信同步节点，同步完成后就可以提供服务了。</p></li></ul></blockquote> <h2 id="zookeeper之安其内-重点"><a href="#zookeeper之安其内-重点" class="header-anchor">#</a> ZooKeeper之安其内（重点）</h2> <ul><li><p><code>leader</code>很重要？</p></li> <li><p>如果没有<code>leader</code>怎么办？</p> <ul><li>开始选举新的<code>leader</code></li></ul></li> <li><p><strong>ZooKeeper服务器四种状态：</strong></p> <ul><li><p><code>looking</code>：服务器处于寻找<code>Leader</code>群首的状态</p></li> <li><p><code>leading</code>：服务器作为群首时的状态</p></li> <li><p><code>following</code>：服务器作为<code>follower</code>跟随者时的状态</p></li> <li><p><code>observing</code>：服务器作为观察者时的状态</p></li></ul></li> <li><p><code>leader</code>选举分<strong>两种情况</strong></p> <ul><li><p>全新集群<code>leader</code>选举</p></li> <li><p>非全新集群<code>leader</code>选举</p></li></ul></li></ul> <h4 id="全新集群leader选举"><a href="#全新集群leader选举" class="header-anchor">#</a> 全新集群leader选举</h4> <p><img src="/assets/img/Image201906130749.8c1c5a2c.png" alt=""></p> <ul><li><p>以3台机器组成的<code>ZooKeeper</code>集群为例</p></li> <li><p>选举前提：集群中过<strong>半数</strong>（多数派<code>quorum</code>）<code>Server</code>启动后，才能选举出<code>Leader</code>；</p> <ul><li>此处<code>quorum</code>数是多少？<code>3/2+1=2</code></li> <li>即<code>quorum</code>=集群服务器数除以2，再加1</li></ul></li> <li><p>理解<code>leader</code>选举前，先了解几个概念</p> <ul><li><p><code>obeserver</code>不参与选举，但能够响应<code>client</code>的读写请求。</p></li> <li><p>选举过程中，每个<code>server</code>需发出投票；投票信息<strong>vote信息</strong>结构为<code>(sid, zxid)</code>，<code>sid</code>是<code>serverid</code>,<code>zxid</code>是事务<code>id</code>。</p> <p>全新集群，<code>server1~3</code>初始投票信息分别为：</p> <p>​	server1 -&gt;  <strong>(1, 0)</strong>
​	​server2 -&gt;  <strong>(2, 0)</strong>
​	server3 -&gt;  <strong>(3, 0)</strong></p></li> <li><p><strong>leader选举公式</strong>：</p> <p>​	server1 vote信息 <code>(sid1,zxid1)</code></p> <p>​	server2 vote信息 <code>(sid2,zxid2)</code></p> <p>​	<strong>①zxid大的server胜出；</strong></p> <p>​	<strong>②若zxid相等，再根据判断sid判断，sid大的胜出</strong></p></li></ul></li> <li><p>选举<code>leader</code>流程：</p> <blockquote><p>假设按照ZK1、ZK2、ZK3的依次启动</p></blockquote> <ul><li><p>启动<code>ZK1</code>后，投票给自己，<code>vote</code>信息<code>(1,0)</code>，没有过半数，选举不出<code>leader</code></p></li> <li><p>再启动<code>ZK2</code>；<code>ZK1</code>和<code>ZK2</code>票投给自己及其他服务器；<code>ZK1</code>的投票为<code>(1, 0)</code>，<code>ZK2</code>的投票为<code>(2, 0)</code></p></li> <li><p>处理投票。每个<code>server</code>将收到的多个投票做处理</p> <ul><li>如<code>ZK1</code>上：<code>ZK1</code>投给自己的票<code>(1,0)</code>与<code>ZK2</code>传过来的票<code>(2,0)</code>比较；</li> <li>利用<strong>leader选举公式</strong>，因为<code>zxid</code>都为<code>0</code>，相等；所以判断<code>sid</code>最大值；2&gt;1；<code>(2,0)</code>胜出；<code>ZK1</code>更新自己的投票为<code>(2, 0)</code></li> <li><code>ZK2</code>也是如此逻辑，<code>ZK2</code>更新自己的投票为<code>(2,0)</code></li></ul></li> <li><p><strong>再次发起投票</strong></p> <ul><li><code>ZK1</code>、<code>ZK2</code>上的投票都是<code>(2,0)</code></li> <li>发起投票后，<code>ZK1</code>上有一个自己的票<code>(2,0</code>)和一票来自ZK2的票<code>(2,0)</code>，这两票都选<code>ZK2</code>为<code>leader</code></li> <li><code>ZK2</code>上有一个自己的票<code>(2,0)</code>和一票来自<code>ZK1</code>的票<code>(2,0)</code>，这两票都选<code>ZK2</code>为<code>leader</code></li> <li>统计投票。<code>server</code>统计投票信息，是否有半数<code>server</code>投同一个服务器为<code>leader</code>；
<ul><li><code>ZK2</code>当选2票；多数</li></ul></li> <li>改变服务器状态。确定<code>Leader</code>后，各服务器更新自己的状态
<ul><li>更改ZK2状态从<code>looking</code>到<code>leading</code>，为<code>Leader</code></li> <li>更改<code>ZK1</code>状态从<code>looking</code>到<code>following</code>，为<code>Follower</code></li></ul></li></ul></li> <li><p>当<code>ZK3</code>启动时，发现已有<code>Leader</code>，不再选举，直接从<code>LOOKING</code>改为<code>FOLLOWING</code></p></li></ul></li></ul> <h4 id="非全新集群leader选举"><a href="#非全新集群leader选举" class="header-anchor">#</a> 非全新集群leader选举</h4> <p><img src="/assets/img/Image201906131101.ab169a06.png" alt=""></p> <ul><li><code>follwer</code>隔一定时间就会向<code>leader</code>发送心跳，如果l<code>eader</code>挂掉以后，<code>follower</code>的心跳就收不到响应了，超过一定时间后，所有<code>follower</code>就开始重新选举。</li> <li>选举原理同上比较<code>zxid、sid</code></li> <li>不再赘述</li></ul> <h2 id="zab算法-难点考点"><a href="#zab算法-难点考点" class="header-anchor">#</a> ZAB算法（难点考点 ）</h2> <h4 id="仲裁quorum"><a href="#仲裁quorum" class="header-anchor">#</a> 仲裁quorum</h4> <ul><li><p>什么是仲裁<code>quorum</code>？</p> <ul><li>发起<code>proposal</code>时，只要多数派同意，即可生效</li></ul></li> <li><p>为什么要仲裁？</p> <ul><li>多数据派不需要所有的服务器都响应，<code>proposal</code>就能生效</li> <li>且能提高集群的响应速度</li></ul></li> <li><p><code>quorum</code>数如何选择？</p> <ul><li><strong>集群节点数 / 2 + 1</strong></li> <li>如3节点的集群：<code>quorum</code>数=<code>3/2+1=2</code></li></ul></li></ul> <h4 id="网络分区、脑裂"><a href="#网络分区、脑裂" class="header-anchor">#</a> 网络分区、脑裂</h4> <ul><li><p>网络分区：网络通信故障，集群被分成了2部分</p></li> <li><p>脑裂：</p> <ul><li>原<code>leader</code>处于一个分区；</li> <li>另外一个分区选举出新的<code>leader</code></li> <li>集群出现<code>2</code>个<code>leader</code></li></ul></li></ul> <h4 id="zab算法介绍"><a href="#zab算法介绍" class="header-anchor">#</a> ZAB算法介绍</h4> <p><code>ZAB</code>算法由<code>raft</code>算法发展而来，<code>PAXOS</code>算法 -&gt; <code>RAFT</code>算法 -&gt; <code>ZAB</code>算法，这三个算法都可以用来解决分布式领域一致性的问题。</p> <h4 id="zab与raft的区别"><a href="#zab与raft的区别" class="header-anchor">#</a> ZAB与RAFT的区别</h4> <p>ZAB与raft很相似，但是有以下区别：</p> <p>1、<code>zab</code>心跳从<code>follower</code>到<code>leader</code>；<code>raft</code>从<code>leader</code>到<code>follower</code></p> <p>2、<code>zab</code>任期叫<code>epoch</code>ˈ；<code>raft</code>叫<code>term</code>。  <code>epoch</code>---&gt;ˈiːpɒk</p> <h4 id="epoch"><a href="#epoch" class="header-anchor">#</a> epoch</h4> <p>一开始，<code>epoch</code>=1，第一任<code>leader</code>挂了之后，就会有第二任<code>leader</code>，此时<code>epoch</code>=2，这个就叫<code>epoch</code>,理解为纪元或者任期即可。</p> <p>查看当前<code>epoch</code>的值：</p> <ul><li><p>方式1：查看/kkb/install/zookeeper-3.4.5-cdh5.14.2/zkdatas/version-2/currentEpoch文件的内容</p></li> <li><p>方式2：通过某个事务来查看。</p> <p><img src="/assets/img/image-20200218064209321.33d9732a.png" alt="image-20200218064209321"></p></li></ul> <h4 id="raft算法"><a href="#raft算法" class="header-anchor">#</a> RAFT算法</h4> <p><a href="http://thesecretlivesofdata.com/raft/#replication" target="_blank" rel="noopener noreferrer">raft算法动图地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，<strong>以<code>RAFT</code>算法动图为例，分析ZAB算法</strong></p> <h5 id="动图帮助说明"><a href="#动图帮助说明" class="header-anchor">#</a> 动图帮助说明</h5> <img src="zookeeper.assets/image-20200219174111921.png" alt="image-20200219174111921" style="zoom:50%;"> <img src="zookeeper.assets/image-20200219174402918.png" alt="image-20200219174402918" style="zoom:50%;"> <img src="zookeeper.assets/image-20200219174549695.png" alt="image-20200219174549695" style="zoom:50%;"> <img src="zookeeper.assets/image-20200219174725526.png" alt="image-20200219174725526" style="zoom:50%;"> <h5 id="阶段一-leader-election"><a href="#阶段一-leader-election" class="header-anchor">#</a> 阶段一：leader election</h5> <div class="language- extra-class"><pre class="language-text"><code>1. //=====================--------选举过程=====================-------//
2. 在`RAFT`协议里有两个`timeout`，第一个`timeout`是`election timeout`，第二个是`heartbeat timeout`。
3. `election timeout`是`followe`r等待变成`candidate`的时长（超过这个时长，`follower`就变成`candidate`）。
4. `election timeout`是随机生成的，在150毫秒到300毫秒间，每个`follower`的`election timeout`都可能不同。
5. 事先过了`election timeout`的服务器会从`follower`变成`cnadidate`状态，并且开启新的一轮选举。比如说视频中的`Node A`。
6. `Node A` 会给自己投票。然后发送投票请求给其它的服务器（`Node B`、`Node C`)。
7. 如果收到投票请求的服务器还没有投过票，就会为该`candidate Node A`投票。（如果为其它`candidate`投过票了，就不会为该`NodeA` `candidate`投票了。）
8. 投票后的每个服务器都会重置自己的`election timeout`。
9. 一旦一个`candidate`得到了超过半数的投票，就会变成`leader`。
10. `leader`开始发送`Append Entries`信息给每个`follower`。
11. 这些`Append Entries`信息每隔`heartbeat timeout `时间就会发送一次。每个`follower`都会对这些信息进行响应，且会重置`heartbeat timeout`。
12. //=====================第一任`leader`挂了，重新选举=====================-//
13. `leader`的任期会一直持续下去，直到某一个`follower`超过`heartbeat timeout`时长依然没有接收到来自`leader`的心跳信息，该`follower`就会变成`candidate`。
14. 比如视频中的`NodeA`停掉了，`Node C`获得过半的投票数后变成了新一任`leader`。过半数投票产生`leader`的机制可以保证每次任期都只有一个`leader`。
15. //=====================-同一时间有两个`candidate`的情况=====================//、
16. 假如有四个服务器`Node ABCD`，两个`candidate`，即 `NodeB NodeC`同一时间竞选同一个任期的`leader`。两个`candidate`都会为自己投票，并向所有的`follower`发送投票请求。
17. 然后`NodeA`首先收到`NodeB candidate`的投票请求，而`NodeD`首先收到的是`NodeC candidate`的投票请求，那么这样的话，`candidateB`和`candidateC`都是拥有两票。票数相同，都没有过半，导致新一轮的`leader`的选举即将开始。
18. 新一轮选举，率先到达`electin timeout`的的`follower`（视频中的`NodeA NodeC`）同时变成了`candidate`。
19. 如此循环，直到只产生了一个`leader`。
</code></pre></div><h5 id="阶段二-log-replication-复制"><a href="#阶段二-log-replication-复制" class="header-anchor">#</a> 阶段二：Log Replication（复制）</h5> <ol><li>如果集群有一个<code>leader</code>后，那么以后集群内所有的改变，都要复制到集群的所有其它节点（服务器）。</li> <li>这个要通过集群的心跳，使用<code>Append Entries</code>信息来完成。</li> <li>//--------------------------------将某节点数据设置为5=====================------//</li> <li>一个客户端向<code>leader</code>发送了一个更改的请求。比如说<code>set...5</code>，设置某个节点的值为5。</li> <li>这个更改会被记录到<code>leader</code>的<code>log</code>日志文件里。</li> <li>这些更改会通过<code>leader</code>下一轮的心跳发送给所有的<code>follower</code>。<code>followers</code>收到心跳后，返回心跳给<code>leader</code>进行响应，告知<code>leader</code>已经把要进行的更改记录下来了。</li> <li>一旦超过半数的<code>follower</code>告知了<code>leader</code>，<code>leader</code>的对应节点的值就改成了<code>5</code>，那么一个<code>entry</code>会被提交 ?，同时会向<code>client</code>客户端响应：更改完成。</li> <li><code>follower</code>再一次收到<code>leader</code>心跳时，将节点值改为5，提交<code>log entry</code>。</li> <li>如果要将该节点的数据加<code>2</code>，步骤跟上述一样，最终集群的该节点的值都变为了<code>7</code>。</li> <li>//----------------------------------脑裂现象=====================-------------------------//</li> <li>假设集群有5个服务器。假如因为网络问题，<code>AB</code>服务器与<code>CDE</code>服务器之间不能通信了，集群分成了两部分。一开始<code>Node B</code>是<code>leader</code>。</li> <li>由于通信问题，<code>C</code>服务器超过<code>heartbeat timeout</code>时长没有收到l<code>eader</code>的心跳。C会变成<code>candidate</code>，经过<code>DE</code>投票过后，<code>Node C</code>也变成了<code>leader</code>。此时集群有两个<code>leader</code>，B和C。</li> <li>一个客户端向<code>NodeB leader</code>发送更改某节点值为<code>3</code>的请求。<code>leader</code>通过心跳告知向所有<code>follower</code>发起更改提议，因为没有收到超过集群半数的<code>follower</code>的响应。导致<code>leader NodeB</code>的<code>log entry</code>始终是<code>uncommited</code>的状态。</li> <li>另一个客户端向<code>NodeC leader</code>发送请求，更改刚才同一个节点的值为<code>8</code>的请求，<code>leader NodeC</code>通过心跳告知所有<code>follower</code>，超过半数响应，更改成功。<code>log entry</code>为<code>committed</code>状态，<code>leader</code> 响应客户端。</li> <li>//-------------------------------------网络修复好后=====================---------------//</li> <li><code>leader NodeB</code>看到更高任期的<code>leader</code>，进行让步，退让<code>leader</code>，变为<code>follower</code>。</li> <li><code>NodeB NodeA</code>将会回滚网络恢复前留下来的<code>uncommited entry</code>。然后匹配<code>leader</code>新的<code>log</code>。</li> <li>最后，我们的集群再次实现了一致性。</li></ol> <blockquote><p><strong>补充：</strong></p> <p>当<code>leader</code>收到一条<code>command</code>请求后，就把它加入自己的<code>log</code>中作为新的<code>entry</code>，然后给其他服务器发出<code>AppendEntries PRC</code>进行日志复制。一旦<code>entry</code>被<strong>安全的复制</strong>了，<code>leader</code>就可以把这条<code>entry</code>给<code>apply</code>到状态机了，并给客户端返回结果。如果<code>follower</code>响应慢或者宕机了，<code>leader</code>会一直发送<code>RPC</code>直到所有<code>follower</code>都存储了<code>entry</code>。</p></blockquote> <h2 id="zookeeper服务器个数"><a href="#zookeeper服务器个数" class="header-anchor">#</a> ZooKeeper服务器个数</h2> <ul><li>仲裁模式下，服务器个数最好为奇数个。<strong>why?</strong></li></ul> <p><img src="/assets/img/Image201906131311.9ce903e7.png" alt=""></p> <ul><li>5节点的比6节点的集群
<ul><li>成本更低，但是容灾能力一样</li> <li><code>quorum</code>小，响应快</li></ul></li></ul> <h4 id="_12-2-zookeeper状态同步"><a href="#_12-2-zookeeper状态同步" class="header-anchor">#</a> 12.2 ZooKeeper状态同步</h4> <p>完成<code>leader</code>选举后，<code>zk</code>就进入<code>ZooKeeper</code>之间状态同步过程</p> <ol><li><code>leader</code>构建<strong>NEWLEADER</strong>封包，包含<code>leader</code>中最大的<code>zxid</code>值；广播给其它<code>follower</code></li> <li><code>follower</code>收到后，如果自己的最大<code>zxid</code>小于leader的，则需要与<code>leader</code>状态同步；否则不需要</li> <li><code>leader</code>给需要同步的每个<code>follower</code>创建<strong>LearnerHandler</strong>线程，负责数据同步请求</li> <li><code>leader</code>主线程等待<code>LearnHandler</code>线程处理结果</li> <li>只有多数<code>follower</code>完成同步，<code>leader</code>才开始对外服务，响应写请求</li> <li><code>LearnerHandler</code>线程处理逻辑
<ol><li><code>LearnerHandler</code>接收<code>follower</code>发送过来的封包<strong>FOLLOWERINFO</strong>，包含此<code>follower</code>最大<code>zxid</code>（代称<code>f-max-zxid</code>）</li> <li>将<code>f-max-zxid</code>与<code>leader</code>最大<code>zxid</code>（代称<code>l-max-zxid</code>）进行比较</li> <li>若相等，说明当前<code>follower</code>是最新的</li> <li>另外，若在判断期间，看有没有新提交的<code>proposal</code> <ol><li>如果有，那么会发送<strong>DIFF</strong>封包将有差异的数据同步过去。同时将<code>follower</code>没有的数据逐个发送<strong>COMMIT</strong>封包给<code>follower</code>要求记录下来.</li> <li>如果<code>follower</code>数据<code>id</code>更大,那么会发送<code>TRUNC</code>封包告知截除（删除）多余数据.</li> <li>如果这一阶段内没有提交的提议值,直接发送<code>SNAP</code>封包将快照同步发送给<code>follower</code>.</li></ol></li> <li>以上消息完毕之后,<code>leader</code>发送<strong>UPTODATE</strong>封包告知<code>follower</code>当前数据就是最新的了</li> <li><code>leader</code>再次发送<strong>NEWLEADER</strong>封包宣称自己是<code>leader</code>,等待<code>follower</code>的响应，循环上述过程。</li></ol></li></ol> <p><img src="/assets/img/Image201906140856.5ac4420c.png" alt=""></p> <h2 id="分布式锁"><a href="#分布式锁" class="header-anchor">#</a> 分布式锁</h2> <h5 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h5> <p>之前我们学习过编程当中的锁的概念。怎么用<code>Zookeeper</code>实现分布式锁？</p> <p>看下图，有很三个<code>client</code>客户端，都要访问<code>data</code>，但是同一个时间只能允许一个客户端访问。</p> <ol><li>三个<code>client</code>都争抢访问<code>data</code>数据，三个客户端都发送<code>creat -s -e /locker/node_data</code>命令，尝试在<code>locker</code>节点下创建一个临时有序子节点。</li> <li>三个客户端都创建好节点之后，那么每个客户端都会对自己创建的节点进行判断，判断自己节点的的后缀编号是不是最小的，<strong>节点最小编号对应的客户端将获得先访问<code>data</code>的权限。加锁</strong>。</li> <li>另外两个客户端就会对比自己对应节点编号小的节点进行监听，比如<code>client2</code>监听<code>node_1,``clent3</code>监听<code>node_2</code>。</li> <li>当<code>client1</code>访问完数据后，会把流关闭掉，客户端关闭会话<code>session</code>，然后<code>node_1</code>节点就会被删除掉。</li> <li>此时<code>client2</code>监听到<code>node_1</code>被删除了，重新判断自己创建的临时节点<code>node_2</code>是否是列表中最小编号的。</li> <li>判断为是后，<code>client2</code>获得访问<code>data</code>权限，开始访问。</li> <li>如此循环即可，保证同一时间点只有一个客户端在访问<code>data</code>。</li></ol> <p><img src="/assets/img/image-20200219154004216.f82ffe9b.png" alt="image-20200219154004216"></p> <div class="language-shell extra-class"><pre class="language-shell"><code>create -s -e /locker/node_ ndata
</code></pre></div><h5 id="代码实现-todo-未消化"><a href="#代码实现-todo-未消化" class="header-anchor">#</a> 代码实现（TODO，未消化）</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>jimmy<span class="token punctuation">.</span>day05</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">BasicConfigurator</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span>data<span class="token punctuation">.</span></span><span class="token class-name">Stat</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CountDownLatch</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistributedLock</span> <span class="token keyword">implements</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
    <span class="token comment">//定义会话的超时时间</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> SESSION_TIME <span class="token operator">=</span> <span class="token number">30000</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> threadId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ZooKeeper</span> zk <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> selfPath<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> waitPath<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> LOG_PREFIX_OF_THREAD<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SESSION_TIMEOUT <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> GROUP_PATH <span class="token operator">=</span> <span class="token string">&quot;/disLocks&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> SUB_PATH <span class="token operator">=</span> <span class="token string">&quot;/disLocks/sub&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> CONNECTION_STRING <span class="token operator">=</span> <span class="token string">&quot;node01:2181,node02:2181,node03:2181&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> THREAD_NUM <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token comment">//确保连接zk成功；</span>
    <span class="token keyword">private</span> <span class="token class-name">CountDownLatch</span> connectedSemaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//确保所有线程运行结束；semaphore信号</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> threadSemaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>THREAD_NUM<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> LOG <span class="token operator">=</span> <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">DistributedLock</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//构造方法</span>
    <span class="token keyword">public</span> <span class="token class-name">DistributedLock</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>threadId <span class="token operator">=</span> id<span class="token punctuation">;</span>
        LOG_PREFIX_OF_THREAD <span class="token operator">=</span> <span class="token string">&quot;【第&quot;</span> <span class="token operator">+</span> threadId <span class="token operator">+</span> <span class="token string">&quot;个线程】&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//程序入口</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//多个线程中zk是否是同一个对象？</span>
        <span class="token class-name">BasicConfigurator</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> THREAD_NUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> threadId <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">DistributedLock</span> dc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DistributedLock</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//连接zookeeper集群</span>
                        dc<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span>CONNECTION_STRING<span class="token punctuation">,</span> SESSION_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;3、在createConnection中，线程等待结束，向下执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//GROUP_PATH不存在的话，由一个线程创建即可；</span>
                        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>threadSemaphore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            dc<span class="token punctuation">.</span><span class="token function">createPath</span><span class="token punctuation">(</span>GROUP_PATH<span class="token punctuation">,</span> <span class="token string">&quot;该节点由线程&quot;</span> <span class="token operator">+</span> threadId <span class="token operator">+</span> <span class="token string">&quot;创建&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">//获得锁</span>
                        dc<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;【第&quot;</span> <span class="token operator">+</span> threadId <span class="token operator">+</span> <span class="token string">&quot;个线程】 抛出的异常：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            threadSemaphore<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;所有线程运行结束!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取锁
     *
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">getLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">//创建临时有序节点</span>
        selfPath <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>SUB_PATH<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL_SEQUENTIAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>LOG_PREFIX_OF_THREAD <span class="token operator">+</span> <span class="token string">&quot;创建锁路径:&quot;</span> <span class="token operator">+</span> selfPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkMinPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//判断当前线程，创建的临时节点，时候是编号最小的；如果是，表示此线程可获得锁</span>
            <span class="token function">getLockSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 创建节点
     *
     * @param path 节点path
     * @param data 初始数据内容
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">createPath</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">String</span> data<span class="token punctuation">,</span> <span class="token keyword">boolean</span> needWatch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>zk<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> needWatch<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>LOG_PREFIX_OF_THREAD <span class="token operator">+</span> <span class="token string">&quot;节点创建成功, Path: &quot;</span>
                    <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zk<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span>
                    data<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span>
                    <span class="token class-name">CreateMode</span><span class="token punctuation">.</span>PERSISTENT<span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot;, content: &quot;</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 创建ZK连接
     *
     * @param connectString  ZK服务器地址列表
     * @param sessionTimeout Session超时时间
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token class-name">String</span> connectString<span class="token punctuation">,</span> <span class="token keyword">int</span> sessionTimeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        zk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span>connectString<span class="token punctuation">,</span> sessionTimeout<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;1、创建连接，并等待&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//CountDownLatch</span>
        connectedSemaphore<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;2、创建连接后，等待结束；理应执行3、&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取锁成功
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getLockSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>zk<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>selfPath<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>LOG_PREFIX_OF_THREAD <span class="token operator">+</span> <span class="token string">&quot;本节点已不在了...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>LOG_PREFIX_OF_THREAD <span class="token operator">+</span> <span class="token string">&quot;获取锁成功，赶紧干活！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>LOG_PREFIX_OF_THREAD <span class="token operator">+</span> <span class="token string">&quot;删除本节点：&quot;</span> <span class="token operator">+</span> selfPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//删除本节点</span>
        zk<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>selfPath<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//释放zk连接</span>
        <span class="token function">releaseConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//threadSemaphore数字递减；达到零后，让等待的线程继续执行</span>
        threadSemaphore<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 关闭ZK连接
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">releaseConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>zk <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>zk<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>LOG_PREFIX_OF_THREAD <span class="token operator">+</span> <span class="token string">&quot;释放连接&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 检查自己创建的临时节点是不是最小的节点
     *
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">checkMinPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">//获得所有子节点的路径</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> subNodes <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span>GROUP_PATH<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//对子节点列表做排序</span>
        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>subNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//获得当前线程创建的临时节点，在子节点列表中排第几？</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> subNodes<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>selfPath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>GROUP_PATH<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>LOG_PREFIX_OF_THREAD <span class="token operator">+</span> <span class="token string">&quot;本节点已不在了...&quot;</span> <span class="token operator">+</span> selfPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//当前线程创建的临时节点是最小的节点</span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>LOG_PREFIX_OF_THREAD <span class="token operator">+</span> <span class="token string">&quot;子节点中，我果然是老大&quot;</span> <span class="token operator">+</span> selfPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//获得锁</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token comment">//找到比自己编号小，紧邻的临时节点</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>waitPath <span class="token operator">=</span> GROUP_PATH <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> subNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>LOG_PREFIX_OF_THREAD <span class="token operator">+</span> <span class="token string">&quot;获取子节点中，排在我前面的&quot;</span> <span class="token operator">+</span> waitPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">//注册监听器</span>
                    zk<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span>waitPath<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//没有获得锁</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>zk<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>waitPath<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>LOG_PREFIX_OF_THREAD <span class="token operator">+</span> <span class="token string">&quot;子节点中，排在我前面的&quot;</span> <span class="token operator">+</span> waitPath <span class="token operator">+</span> <span class="token string">&quot;已失踪，幸福来得太突然?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//回调自己</span>
                        <span class="token keyword">return</span> <span class="token function">checkMinPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//回调函数</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Event<span class="token punctuation">.</span>KeeperState</span> keeperState <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Event<span class="token punctuation">.</span>EventType</span> eventType <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Event.KeeperState.SyncConnected =&gt;&gt; The client is in the connected state 客户端处于连接状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>SyncConnected</span> <span class="token operator">==</span> keeperState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Event<span class="token punctuation">.</span>EventType<span class="token punctuation">.</span>None</span> <span class="token operator">==</span> eventType<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//客户端连接上zkServer后，执行此分支</span>
                LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>LOG_PREFIX_OF_THREAD <span class="token operator">+</span> <span class="token string">&quot;成功连接上ZK服务器&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//connectedSemaphore数字递减；达到零后，让等待的线程继续执行</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;4、createConnection后，客户端成功连接zkServer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                connectedSemaphore<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;5、CountDownLatch: connectedSemaphore 递减为0；理应执行 -&gt; 2、创建连接后，等待结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Event<span class="token punctuation">.</span>EventType<span class="token punctuation">.</span>NodeDeleted</span> <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>waitPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>LOG_PREFIX_OF_THREAD <span class="token operator">+</span> <span class="token string">&quot;收到情报，排我前面的家伙已挂，我是不是可以出山了？&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkMinPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">getLockSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>Disconnected</span> <span class="token operator">==</span> keeperState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>LOG_PREFIX_OF_THREAD <span class="token operator">+</span> <span class="token string">&quot;与ZK服务器断开连接&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>AuthFailed</span> <span class="token operator">==</span> keeperState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>LOG_PREFIX_OF_THREAD <span class="token operator">+</span> <span class="token string">&quot;权限检查失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>Expired</span> <span class="token operator">==</span> keeperState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>LOG_PREFIX_OF_THREAD <span class="token operator">+</span> <span class="token string">&quot;会话失效&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="zookeeper应用场景"><a href="#zookeeper应用场景" class="header-anchor">#</a> ZooKeeper应用场景</h2> <ol><li><code>NameNode</code>使用<code>ZooKeeper</code>实现高可用.</li> <li><code>Yarn ResourceManager</code>使用<code>ZooKeeper</code>实现高可用.</li> <li>利用<code>ZooKeeper</code>对<code>HBase</code>集群做高可用配置</li> <li><code>kafka</code>使用<code>ZooKeeper</code> <ul><li>保存消息消费信息比如<code>offset</code>.</li> <li>用于检测崩溃</li> <li>主题<code>topic</code>发现</li> <li>保持主题的生产和消费状态</li></ul></li></ol> <p><strong>ZooKeeper应用场景图：</strong></p> <p><img src="/assets/img/20170221224856838.8d7cd4ce.png" alt=""></p> <h2 id="扩展阅读"><a href="#扩展阅读" class="header-anchor">#</a> 扩展阅读</h2> <p><a href="https://www.cnblogs.com/hadoop-dev/p/5946870.html" target="_blank" rel="noopener noreferrer">follower与leader状态同步<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://blog.csdn.net/u010670689/article/details/78054945" target="_blank" rel="noopener noreferrer">主备切换示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="访问控制acl"><a href="#访问控制acl" class="header-anchor">#</a> 访问控制ACL</h2> <ul><li>参考《访问控制ACL》</li></ul> <h2 id="题库-本堂课知识点-todo"><a href="#题库-本堂课知识点-todo" class="header-anchor">#</a> 题库 - 本堂课知识点（TODO）</h2> <ol><li>假设五台ZooKeeper服务器组成的全新集群，分别为zk1,zk2,zk3,zk4,zk5，sid分别为1、2、3、4、5，依次启动zk1,zk2,zk3,zk4,zk5。问哪台是leader，为什么这台是leader?</li> <li>同一个客户端同时发起多次请求操作时ZooKeeper内部是如何操作的？多个客户端同时发起多个请求时又是如何操作的？</li> <li>自己编写代码，完成zookeeper原生API下的增加节点、删除节点、修改节点等操作；其中一个自定义的方法要用到监听器</li> <li>使用curator API完成增加节点、删除节点、修改节点等操作；其中一个自定义的方法要用到监听器</li></ol> <h2 id="zookeeper总结"><a href="#zookeeper总结" class="header-anchor">#</a> Zookeeper总结</h2> <p><img src="/assets/img/Image201909181457.d701b554.png" alt=""></p> <p><img src="/assets/img/Image201909201440.c7f57827.png" alt=""></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MaLunan/press/edit/dev-mln/docs/zookeeper/zookeeper.md" target="_blank" rel="noopener noreferrer">在GitHub 上编辑此页！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">1/19/2021, 1:41:59 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fdd7a502.js" defer></script><script src="/assets/js/16.375b747e.js" defer></script><script src="/assets/js/15.be29bb6a.js" defer></script>
  </body>
</html>
