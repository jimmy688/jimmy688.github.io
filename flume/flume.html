<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>flume前言 | 个人博客 | JiiiiG</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="自是年少，韶华倾负">
    
    <link rel="preload" href="/assets/css/0.styles.420b7c1f.css" as="style"><link rel="preload" href="/assets/js/app.fdd7a502.js" as="script"><link rel="preload" href="/assets/js/16.375b747e.js" as="script"><link rel="preload" href="/assets/js/21.0c1e826b.js" as="script"><link rel="prefetch" href="/assets/js/10.bbd38b9e.js"><link rel="prefetch" href="/assets/js/11.f49fc7d3.js"><link rel="prefetch" href="/assets/js/12.c5d97aa1.js"><link rel="prefetch" href="/assets/js/13.426d0224.js"><link rel="prefetch" href="/assets/js/14.1f257a58.js"><link rel="prefetch" href="/assets/js/15.be29bb6a.js"><link rel="prefetch" href="/assets/js/17.d02cdd8b.js"><link rel="prefetch" href="/assets/js/18.5d2371a4.js"><link rel="prefetch" href="/assets/js/19.038919a3.js"><link rel="prefetch" href="/assets/js/2.d6257727.js"><link rel="prefetch" href="/assets/js/20.b3582e09.js"><link rel="prefetch" href="/assets/js/22.91bff1a5.js"><link rel="prefetch" href="/assets/js/23.faacea60.js"><link rel="prefetch" href="/assets/js/24.69816497.js"><link rel="prefetch" href="/assets/js/25.c9fcaa62.js"><link rel="prefetch" href="/assets/js/26.d28c3abe.js"><link rel="prefetch" href="/assets/js/27.1518da7d.js"><link rel="prefetch" href="/assets/js/28.748a5581.js"><link rel="prefetch" href="/assets/js/29.775019f1.js"><link rel="prefetch" href="/assets/js/3.141002a4.js"><link rel="prefetch" href="/assets/js/30.74e7c570.js"><link rel="prefetch" href="/assets/js/31.190b11f2.js"><link rel="prefetch" href="/assets/js/32.d8f4f116.js"><link rel="prefetch" href="/assets/js/33.c489bc81.js"><link rel="prefetch" href="/assets/js/34.db609d51.js"><link rel="prefetch" href="/assets/js/35.ad3402e6.js"><link rel="prefetch" href="/assets/js/36.45f11923.js"><link rel="prefetch" href="/assets/js/37.b47e0576.js"><link rel="prefetch" href="/assets/js/38.58b934a2.js"><link rel="prefetch" href="/assets/js/39.e4d6bcdf.js"><link rel="prefetch" href="/assets/js/4.e9b44388.js"><link rel="prefetch" href="/assets/js/40.555106bc.js"><link rel="prefetch" href="/assets/js/41.4387ceb1.js"><link rel="prefetch" href="/assets/js/42.9bd4aea0.js"><link rel="prefetch" href="/assets/js/43.587e7966.js"><link rel="prefetch" href="/assets/js/44.80285763.js"><link rel="prefetch" href="/assets/js/45.f978da77.js"><link rel="prefetch" href="/assets/js/46.d93e3f2e.js"><link rel="prefetch" href="/assets/js/47.c15bd2aa.js"><link rel="prefetch" href="/assets/js/48.cb55fa72.js"><link rel="prefetch" href="/assets/js/49.d0f4e454.js"><link rel="prefetch" href="/assets/js/5.b90b80cb.js"><link rel="prefetch" href="/assets/js/50.112e8260.js"><link rel="prefetch" href="/assets/js/51.a66bcd03.js"><link rel="prefetch" href="/assets/js/52.0c7cbfb1.js"><link rel="prefetch" href="/assets/js/53.67ef240b.js"><link rel="prefetch" href="/assets/js/54.2c2d082d.js"><link rel="prefetch" href="/assets/js/55.88f19a20.js"><link rel="prefetch" href="/assets/js/56.c726e920.js"><link rel="prefetch" href="/assets/js/57.eaee47c5.js"><link rel="prefetch" href="/assets/js/58.ac15a3ac.js"><link rel="prefetch" href="/assets/js/59.64bdc849.js"><link rel="prefetch" href="/assets/js/6.7eea74ff.js"><link rel="prefetch" href="/assets/js/7.a1370e98.js"><link rel="prefetch" href="/assets/js/8.2e898240.js"><link rel="prefetch" href="/assets/js/9.a2439994.js">
    <link rel="stylesheet" href="/assets/css/0.styles.420b7c1f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">个人博客 | JiiiiG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/linux/linux常用命令/01linux常用命令01.html" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/hadoop/01hadoop环境搭建/01搭建hadoop集群.html" class="nav-link">
  hadoop
</a></li><li class="dropdown-item"><!----> <a href="/hbase/hbase.html" class="nav-link">
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/flink/flink.html" class="nav-link">
  flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/flume/.html" class="nav-link">
  java
</a></li></ul></div></div> <a href="https://github.com/MaLunan/press" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/linux/linux常用命令/01linux常用命令01.html" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/hadoop/01hadoop环境搭建/01搭建hadoop集群.html" class="nav-link">
  hadoop
</a></li><li class="dropdown-item"><!----> <a href="/hbase/hbase.html" class="nav-link">
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/flink/flink.html" class="nav-link">
  flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/flume/.html" class="nav-link">
  java
</a></li></ul></div></div> <a href="https://github.com/MaLunan/press" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="flume前言"><a href="#flume前言" class="header-anchor">#</a> flume前言</h2> <p>在一个完整的离线大数据处理系统中，除了hdfs+mapreduce+hive组成分析系统的核心之外，还需要数据采集、结果数据导出、任务调度等不可或缺的辅助系统，而这些辅助工具在hadoop生态体系中都有便捷的开源框架，如图所示：</p> <p><img src="/assets/img/clip_image002.9de35c5d.jpg" alt="img"></p> <h2 id="flume概述"><a href="#flume概述" class="header-anchor">#</a> flume概述</h2> <p>Flume是一个分布式、可靠、和高可用的海量日志采集、聚合和传输的系统（搬运工）。</p> <p>Flume可以采集文件，socket数据包、文件、文件夹、kafka等各种形式源数据，又可以将采集到的数据(下沉sink)输出到HDFS、hbase、hive、kafka等众多外部存储系统中。</p> <p>一般的采集需求，通过对flume的简单配置即可实现</p> <p>Flume针对特殊场景也具备良好的自定义扩展能力</p> <p>因此，flume可以适用于大部分的日常数据采集场景</p> <h2 id="flume运行机制"><a href="#flume运行机制" class="header-anchor">#</a> flume运行机制</h2> <p>Flume分布式系统中最核心的角色是agent，flume采集系统就是由一个个agent所连接起来形成</p> <p>每一个agent相当于一个数据传递员，内部有三个组件：</p> <ol><li>Source：采集组件，用于跟数据源对接，以获取数据。</li> <li>Sink：下沉组件，用于往下一级agent传递数据或者往最终存储系统传递数据。</li> <li>Channel：传输通道组件，用于从source将数据传递到sink。</li></ol> <p><img src="/assets/img/clip_image004.f4842495.jpg" alt="img"></p> <h2 id="flume采集系统结构图"><a href="#flume采集系统结构图" class="header-anchor">#</a> Flume采集系统结构图</h2> <h4 id="简单结构"><a href="#简单结构" class="header-anchor">#</a> 简单结构</h4> <p>单个agent采集数据</p> <p><img src="/assets/img/clip_image006.79113b49.jpg" alt="img"></p> <h4 id="复杂结构"><a href="#复杂结构" class="header-anchor">#</a> 复杂结构</h4> <p>两个agent之间串联</p> <p><img src="/assets/img/clip_image008.8372c454.png" alt="img"></p> <p>多级agent之间串联</p> <p><img src="/assets/img/clip_image010.465d0aed.jpg" alt="img"></p> <p>多级channel</p> <p><img src="/assets/img/clip_image012.e6e18fac.png" alt="img"></p> <h2 id="flume的安装部署"><a href="#flume的安装部署" class="header-anchor">#</a> Flume的安装部署</h2> <p>Flume的安装非常简单，只需要解压即可，当然，前提是已有hadoop环境</p> <p>上传安装包到数据源所在节点上，这里我们在第三台机器node03来进行安装,哪里需要就哪安装,随安随用。</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/soft
rz
<span class="token function">tar</span> -zxvf flume-ng-1.6.0-cdh5.14.2.tar.gz -C /kkb/install/

<span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf

<span class="token function">cp</span> flume-env.sh.template flume-env.sh
<span class="token function">vim</span> flume-env.sh

<span class="token comment">#设置java环境变量</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/kkb/install/jdk1.8.0_141
</code></pre></div><p>查看flume的version</p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h2 id="event概述"><a href="#event概述" class="header-anchor">#</a> Event概述</h2> <p>flume的核心是把数据从数据源（source）中收集过来，再将收集到的数据送到指定的目的地（sink）。为了保证传输的过程一定成功，在送到目的地之前，会先缓存数据（channel），待数据真正到达目的地（sink）后，flume再删除自己的缓存数据。</p> <p>在整个数据的传输的过程中，流动的是event，即事务保证是在event级别进行的。那么什么是event呢？—–event将传输的数据进行封装，是flume传输数据的基本单位，如果是文本文件，通常是一行记录，event也是事务的基本单位。event从source，流向channel，再到sink，本身为一个<strong>字节数组</strong>，并可携带headers(头信息)信息。event代表着一个数据的最小完整单元，从外部数据源来，向外部的目的地去。</p> <p>一个完整的event包括：event headers、event body、event信息(即文本文件中的单行记录)</p> <p><img src="/assets/img/1295451-20181220094054936-1140552003.dd3487d8.png" alt="img"></p> <h2 id="flume帮助文档网址"><a href="#flume帮助文档网址" class="header-anchor">#</a> Flume帮助文档网址</h2> <p>Flume支持众多的source和sink类型，详细手册可参考官方文档：http://archive.cloudera.com/cdh5/cdh/5/flume-ng-1.6.0-cdh5.14.2/FlumeUserGuide.html</p> <p>中文文档查看网址：https://flume.liyifeng.org/</p> <p>查看文档时，特别注意，黑色加粗字体常表示为必须参数，如：</p> <p><img src="/assets/img/image-20200310153359898.8c9e3d06.png" alt="image-20200310153359898"></p> <h2 id="flume实战案例1-监听端口-todo"><a href="#flume实战案例1-监听端口-todo" class="header-anchor">#</a> Flume实战案例1：监听端口(TODO)</h2> <h4 id="案例需求"><a href="#案例需求" class="header-anchor">#</a> 案例需求</h4> <p>收集网络端口的数据，并将数据打印到linux的控制台上面</p> <p><img src="/assets/img/image-20200310105909015.3c4dff1f.png" alt="image-20200310105909015"></p> <h4 id="案例分析"><a href="#案例分析" class="header-anchor">#</a> 案例分析</h4> <p>source：监听网络端口</p> <p>channel:连接source以及sink</p> <p>sink:将数据打印到控制台</p> <h4 id="第一步-开发配置文件"><a href="#第一步-开发配置文件" class="header-anchor">#</a> 第一步：开发配置文件</h4> <p>根据数据采集的需求配置采集方案，描述在配置文件中(文件名可任意自定义)</p> <p>在flume的conf目录下新建一个配置文件（采集方案）</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span>  /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf/netcat-logger.conf

<span class="token comment">## 定义这个agent中各组件的名字,a1是当前agent的名称</span>
a1.sources <span class="token operator">=</span> r1
a1.sinks <span class="token operator">=</span> k1
a1.channels <span class="token operator">=</span> c1

<span class="token comment">## 描述和配置source组件：r1</span>
a1.sources.r1.type <span class="token operator">=</span> netcat
a1.sources.r1.bind <span class="token operator">=</span> <span class="token number">192.168</span>.52.103 <span class="token comment">#监听node03节点的端口</span>
a1.sources.r1.port <span class="token operator">=</span> <span class="token number">44444</span>

<span class="token comment">## 描述和配置sink组件：k1</span>
a1.sinks.k1.type <span class="token operator">=</span> logger

<span class="token comment">## 描述和配置channel组件，此处使用是内存缓存的方式</span>
a1.channels.c1.type <span class="token operator">=</span> memory
a1.channels.c1.capacity <span class="token operator">=</span> <span class="token number">1000</span>
a1.channels.c1.transactionCapacity <span class="token operator">=</span> <span class="token number">100</span>


<span class="token comment">## 描述和配置source channel  sink之间的连接关系</span>
a1.sources.r1.channels <span class="token operator">=</span> c1
a1.sinks.k1.channels <span class="token operator">=</span> c1
</code></pre></div><h4 id="第二步-启动配置文件"><a href="#第二步-启动配置文件" class="header-anchor">#</a> 第二步：启动配置文件</h4> <p>在相应的节点上启动flume agent</p> <p>前台启动：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/

<span class="token punctuation">[</span>hadoop@node03 apache-flume-1.6.0-cdh5.14.2-bin<span class="token punctuation">]</span>$ bin/flume-ng agent -c conf -f conf/netcat-logger.conf -n a1 -Dflume.root.logger<span class="token operator">=</span>INFO,console

-c conf   <span class="token comment">#指定flume自身的配置文件所在目录</span>
-f conf/netcat-logger.con  <span class="token comment">#指定我们所描述的采集方案</span>
-n a1  <span class="token comment">#指定我们这个agent的名字</span>
-Dflume.root.logger<span class="token operator">=</span>INFO,console <span class="token comment">#是前台启动的意思</span>
</code></pre></div><p>后台启动：</p> <p>查看jps，其中的Application就代表flume进程：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/

<span class="token punctuation">[</span>hadoop@node03 apache-flume-1.6.0-cdh5.14.2-bin<span class="token punctuation">]</span>$ <span class="token function">nohup</span> bin/flume-ng agent -c conf -f conf/netcat-logger.conf -n a1 <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>

<span class="token punctuation">[</span>hadoop@node03 apache-flume-1.6.0-cdh5.14.2-bin<span class="token punctuation">]</span>$ jps
<span class="token number">12738</span> Application
<span class="token number">7476</span> DataNode
<span class="token number">11398</span> QuorumPeerMain
<span class="token number">7596</span> NodeManager
<span class="token number">11485</span> HRegionServer
<span class="token number">12927</span> Jps
</code></pre></div><h4 id="第三步-安装telent准备测试"><a href="#第三步-安装telent准备测试" class="header-anchor">#</a> 第三步：安装telent准备测试</h4> <p>在node02机器上面安装telnet客户端，用于模拟数据的发送</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> yum -y <span class="token function">install</span> telnet
telnet node03 <span class="token number">44444</span>  <span class="token comment">## 使用telnet模拟数据发送</span>
</code></pre></div><blockquote><p>Telnet协议是<a href="https://baike.baidu.com/item/TCP%2FIP%E5%8D%8F%E8%AE%AE" target="_blank" rel="noopener noreferrer">TCP/IP协议<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>族中的一员，是Internet远程登录服务的标准协议和主要方式。它为用户提供了在本地计算机上完成远程<a href="https://baike.baidu.com/item/%E4%B8%BB%E6%9C%BA/455151" target="_blank" rel="noopener noreferrer">主机<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>工作的能力。在<a href="https://baike.baidu.com/item/%E7%BB%88%E7%AB%AF/1903878" target="_blank" rel="noopener noreferrer">终端<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>使用者的电脑上使用telnet程序，用它连接到<a href="https://baike.baidu.com/item/%E6%9C%8D%E5%8A%A1%E5%99%A8/100571" target="_blank" rel="noopener noreferrer">服务器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。<a href="https://baike.baidu.com/item/%E7%BB%88%E7%AB%AF/1903878" target="_blank" rel="noopener noreferrer">终端<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>使用者可以在telnet程序中输入命令，这些命令会在<a href="https://baike.baidu.com/item/%E6%9C%8D%E5%8A%A1%E5%99%A8/100571" target="_blank" rel="noopener noreferrer">服务器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>上运行，就像直接在服务器的控制台上输入一样。可以在本地就能控制<a href="https://baike.baidu.com/item/%E6%9C%8D%E5%8A%A1%E5%99%A8/100571" target="_blank" rel="noopener noreferrer">服务器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p></blockquote> <h2 id="flume实战案例2-采集目录的新文件内容"><a href="#flume实战案例2-采集目录的新文件内容" class="header-anchor">#</a> flume实战案例2：采集目录的新文件内容</h2> <h4 id="案例需求-2"><a href="#案例需求-2" class="header-anchor">#</a> 案例需求</h4> <p>采集需求：某服务器的某特定目录下，会不断产生新的文件，每当有新文件出现，就需要把文件采集到HDFS中去。</p> <p>需求的结构示意图：</p> <p><img src="/assets/img/clip_image016.263a205f.png" alt="img"></p> <h4 id="案例分析-2"><a href="#案例分析-2" class="header-anchor">#</a> 案例分析</h4> <p>根据需求，需要定义以下3大要素：</p> <blockquote><ol><li><p>数据源组件，即source ——监控文件目录 : spooldir</p> <p>spooldir特性：</p> <p>1、监视一个目录，只要目录中出现新文件，就会采集文件中的内容</p> <p>2、采集完成的文件，会被agent自动添加一个后缀：COMPLETED</p> <p>3、所监视的目录中不允许重复出现相同文件名的文件</p></li> <li><p>下沉组件，即sink——HDFS文件系统 : hdfs sink</p></li> <li><p>通道组件，即channel——可用file channel 也可以用内存channel</p></li></ol></blockquote> <p>文档查看思路指导(如何根据需求查看文档帮助):</p> <blockquote><ol><li>首先去Flume sources的子目录查找sources,因为我们的需求是监听文件目录,所以我们要找一个跟目录相关的source,最终找到了spooling directory source。http://flume.apache.org/FlumeUserGuide.html#spooling-directory-source</li> <li>然后去Flume sinks的子目录查找sinks,因为我们的需求是下沉到hdfs文件系统，所有我们要找一个跟hdfs相关的sinks，最终找到了HDFS sinks。http://flume.apache.org/FlumeUserGuide.html#hdfs-sink</li> <li>channels的话，不需要查看文档，直接使用我们上面一个案例的memory channels就可以了。</li></ol></blockquote> <p>怎么保证下沉到HDFS的文件的大小?如何避免在hdfs上产生小文件?有两种策略:</p> <blockquote><ol><li><p>基于时间的控制</p> <p>使用hdfs sink时，时间控制的代码如下，下面的代码表示每隔10分钟会创建一个文件夹(注意：不是日志数据文件）。比如本案例中的文件夹：hdfs://node01:8020/spooldir/files/%y-%m-%d/%H%M/。
新的数据文件的将会存放到这个新创建的文件夹。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>a1.sinks.k1.hdfs.round <span class="token operator">=</span> <span class="token boolean">true</span>
a1.sinks.k1.hdfs.roundValue <span class="token operator">=</span> <span class="token number">10</span>  <span class="token comment">#长度</span>
a1.sinks.k1.hdfs.roundUnit <span class="token operator">=</span> minute <span class="token comment">#时间单位</span>
</code></pre></div></li> <li><p>基于文件大小的控制</p> <p>使用hdfs sink时，使用文件大小控制策略的代码如下。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>hdfs.rollInterval <span class="token number">30</span>
<span class="token comment">#当前文件写入达到该值时间后触发滚动创建新文件（0表示不按照时间来分割文件），单位：秒</span>
hdfs.rollSize <span class="token number">1024</span>
<span class="token comment">#当前文件写入达到该大小后触发滚动创建新文件（0表示不根据文件大小来分割文件），单位：字节</span>
hdfs.rollCount <span class="token number">10</span>
<span class="token comment">#当前文件写入Event达到该数量后触发滚动创建新文件（0表示不根据 Event 数量来分割文件）</span>
hdfs.idleTimeout <span class="token number">0</span>
<span class="token comment">#关闭非活动文件的超时时间（0表示禁用自动关闭文件），单位：秒</span>
hdfs.batchSize <span class="token number">100</span>
<span class="token comment">#向 HDFS 写入内容时每次批量操作的 Event 数量</span>
</code></pre></div><ul><li>rollinterval代表hdfs sink间隔多长时间会将临时文件滚动生成最终目标文件。单位：s</li> <li>rollsize代表当临时文件达到该大小时滚动生成目标文件。单位：byte</li> <li>rollcount代表当events数据达到该数量的时候，将临时文件滚动生成目标文件。</li> <li>idleTimeout代表当目前被打开的临时文件在指定时间内，没有任何数据写入，则将临时文件关闭并重命名为目标文件（去掉.tmp后缀）</li> <li>batchsize代表批处理大小，number of events written to file before it is flushed to HDFS（写入当前文件的events数量达到bachsize时就刷新到hdfs创建文件，也可理解为每次往hdfs刷写多少event的数据）。</li> <li>.tmp临时文件和目标文件的区别是，临时文件可能会被陆续写入数据，而目标文件不会了，因此可通过控制临时文件滚动生成目标文件的条件来控制目标文件的大小。</li></ul></li></ol></blockquote> <h4 id="第一步-创建要监听的目录"><a href="#第一步-创建要监听的目录" class="header-anchor">#</a> 第一步：创建要监听的目录</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">mkdir</span> -p /kkb/install/dirfile
</code></pre></div><h4 id="第二步-开发flume配置文件"><a href="#第二步-开发flume配置文件" class="header-anchor">#</a> 第二步：开发flume配置文件</h4> <p>配置文件编写：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf
<span class="token function">vim</span> spooldir.conf
</code></pre></div><p>内容如下：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## Name the components on this agent</span>
a1.sources <span class="token operator">=</span> r1
a1.sinks <span class="token operator">=</span> k1
a1.channels <span class="token operator">=</span> c1

<span class="token comment">## Describe/configure the source</span>
<span class="token comment">#注意：不能往监控目中重复丢同名文件</span>
a1.sources.r1.type <span class="token operator">=</span> spooldir
a1.sources.r1.spoolDir <span class="token operator">=</span> /kkb/install/dirfile
a1.sources.r1.fileHeader <span class="token operator">=</span> <span class="token boolean">true</span>

<span class="token comment">## Describe the sink</span>
a1.sinks.k1.type <span class="token operator">=</span> hdfs
a1.sinks.k1.channel <span class="token operator">=</span> c1
a1.sinks.k1.hdfs.path <span class="token operator">=</span> hdfs://node01:8020/spooldir/files/%y-%m-%d/%H%M/
a1.sinks.k1.hdfs.filePrefix <span class="token operator">=</span> events-
<span class="token comment">#时间控制</span>
a1.sinks.k1.hdfs.round <span class="token operator">=</span> <span class="token boolean">true</span>
a1.sinks.k1.hdfs.roundValue <span class="token operator">=</span> <span class="token number">10</span>
a1.sinks.k1.hdfs.roundUnit <span class="token operator">=</span> minute
<span class="token comment">#文件控制，下面这种参数设置明显会生成较多小文件，需要加大参数才会避免这种情况</span>
a1.sinks.k1.hdfs.rollInterval <span class="token operator">=</span> <span class="token number">30</span>
a1.sinks.k1.hdfs.rollSize <span class="token operator">=</span> <span class="token number">20</span>
a1.sinks.k1.hdfs.rollCount <span class="token operator">=</span> <span class="token number">5</span>
a1.sinks.k1.hdfs.batchSize <span class="token operator">=</span> <span class="token number">1</span>
a1.sinks.k1.hdfs.useLocalTimeStamp <span class="token operator">=</span> <span class="token boolean">true</span>

<span class="token comment">#生成的文件类型，默认是Sequencefile，可用DataStream，即普通文本</span>
a1.sinks.k1.hdfs.fileType <span class="token operator">=</span> DataStream

<span class="token comment">## Use a channel which buffers events in memory</span>
a1.channels.c1.type <span class="token operator">=</span> memory
a1.channels.c1.capacity <span class="token operator">=</span> <span class="token number">1000</span>
a1.channels.c1.transactionCapacity <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment">## Bind the source and sink to the channel</span>
a1.sources.r1.channels <span class="token operator">=</span> c1
a1.sinks.k1.channel <span class="token operator">=</span> c1
</code></pre></div><p>hdfs sink部分参数解释：</p> <table><thead><tr><th style="text-align:left;">Name</th> <th style="text-align:left;">Default</th> <th style="text-align:left;">Description</th></tr></thead> <tbody><tr><td style="text-align:left;"><strong>channel</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><strong>type</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;">The component type name, needs to be <code>hdfs</code></td></tr> <tr><td style="text-align:left;"><strong>hdfs.path</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;">HDFS directory path (eg hdfs://namenode/flume/webdata/)</td></tr> <tr><td style="text-align:left;">hdfs.filePrefix</td> <td style="text-align:left;">FlumeData</td> <td style="text-align:left;">Name prefixed to files created by Flume in hdfs directory</td></tr></tbody></table> <p>Channel参数解释：</p> <table><thead><tr><th>Name</th> <th>Description</th></tr></thead> <tbody><tr><td>capacity</td> <td>默认该通道中最大的可以存储的event数量</td></tr> <tr><td>trasactionCapacity</td> <td>每次最大可以从source中拿到或者送到sink中的event数量</td></tr> <tr><td>keep-alive</td> <td>event添加到通道中或者移出的允许时间</td></tr></tbody></table> <h4 id="第三步-启动flume"><a href="#第三步-启动flume" class="header-anchor">#</a> 第三步：启动flume</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>hadoop@node03 apache-flume-1.6.0-cdh5.14.2-bin<span class="token punctuation">]</span>$ bin/flume-ng gent -c conf -f conf/spooldir.conf -n a1 <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
</code></pre></div><h4 id="第四步-在监听目录创建文件"><a href="#第四步-在监听目录创建文件" class="header-anchor">#</a> 第四步：在监听目录创建文件</h4> <p>特别注意文件不能重名，创建的文件如果重名，flume将会报错，并且一旦报错，flume将不能再使用，要重新开启agent实例。</p> <p>创建的文件的内容，自己随意写一点上去。</p> <p>创建完成，立马ls查看监听目录的文件。</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/dirfile
<span class="token punctuation">[</span>hadoop@node03 dirfile<span class="token punctuation">]</span>$ <span class="token function">vim</span> hello.txt
<span class="token punctuation">[</span>hadoop@node03 dirfile<span class="token punctuation">]</span>$ <span class="token function">ls</span>
hello.txt.COMPLETED
</code></pre></div><h4 id="第五步-结果分析"><a href="#第五步-结果分析" class="header-anchor">#</a> 第五步：结果分析</h4> <p>从第四步的代码块可以看出，在监听目录新建的文件会被立马添加一个后缀.COMPLETED，表示文件已经被采集到channel中。</p> <p>新建文件后的30s内，就在hdfs上出现了新的目录spooldir/files/20-03-11/0200,这个目录是通过flume配置文件的a1.sinks.k1.hdfs.path = hdfs://node01:8020/spooldir/files/%y-%m-%d/%H%M/来设置的的。这个目录下有一个.tmp的临时文件，存储着在监听目录新建的文件的数据。</p> <p><img src="/assets/img/image-20200310180102254.307e7414.png" alt="image-20200310180102254"></p> <p>在30s（a1.sinks.k1.hdfs.rollInterval = 30）后，.tmp后缀会被去掉，如下：</p> <p><img src="/assets/img/image-20200310180150955.99e348b0.png" alt="image-20200310180150955"></p> <h2 id="flume实战案例3-采集文件的追加数据"><a href="#flume实战案例3-采集文件的追加数据" class="header-anchor">#</a> flume实战案例3：采集文件的追加数据</h2> <h4 id="案例需求-3"><a href="#案例需求-3" class="header-anchor">#</a> 案例需求</h4> <p>比如业务系统使用log4j生成的日志，日志内容不断增加，需要把追加到日志文件中的数据实时采集到hdfs。</p> <p><img src="/assets/img/clip_image018.f44adfb6.png" alt="img"></p> <h4 id="需求分析"><a href="#需求分析" class="header-anchor">#</a> 需求分析</h4> <h6 id="确定source"><a href="#确定source" class="header-anchor">#</a> 确定source</h6> <p>对于文件的更新的追踪，可联想到linux的命令tail -f filename命令，这个命令会把 filename 文件里的最尾部的内容显示在屏幕上，并且不断刷新，只要 filename 更新就可以看到最新的文件内容。如下：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>hadoop@node03 dirfile<span class="token punctuation">]</span>$ <span class="token function">vim</span> testf.txt
hello,this is jimmy

<span class="token punctuation">[</span>hadoop@node03 dirfile<span class="token punctuation">]</span>$ <span class="token function">tail</span> -f testf.txt 
hello,this is jimmy <span class="token comment">#一开始还没有下面一行，执行了命令echo $(date) &gt;&gt; testf.txt后才显示了</span>
Thu Mar <span class="token number">12</span> 00:21:23 CST <span class="token number">2020</span>

<span class="token comment">#可以看到，执行tail -f命令后，显示文件内容的窗口会一直存在，而且会更新内容显示，直到ctrl+c终止。</span>
</code></pre></div><p>那么，flume正好也有一个sources，叫做exec source，功能为：Exec source runs a given Unix command on start-up and expects that process to continuously produce data on standard out (stderr is simply discarded, unless property logStdErr is set to true).</p> <p>大致意思是，exec source会在启动时指定一个给定的Unix命令。那么我们就使用该exec source试一下。</p> <p>exec source的必需参数如下：</p> <table><thead><tr><th style="text-align:left;">Property Name</th> <th style="text-align:left;">Default</th> <th style="text-align:left;">Description</th></tr></thead> <tbody><tr><td style="text-align:left;"><strong>channels</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><strong>type</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;">The component type name, needs to be exec</td></tr> <tr><td style="text-align:left;"><strong>command</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;">The command to execute</td></tr></tbody></table> <h6 id="确定sink"><a href="#确定sink" class="header-anchor">#</a> 确定sink</h6> <p>因为我们采集的数据还是放到hdfs上去，因此我们还是使用hdfs sink。</p> <h6 id="确定channel"><a href="#确定channel" class="header-anchor">#</a> 确定channel</h6> <p>使用memory sink即可</p> <h4 id="第一步-创建监听的文件夹"><a href="#第一步-创建监听的文件夹" class="header-anchor">#</a> 第一步：创建监听的文件夹</h4> <div class="language- extra-class"><pre class="language-text"><code>mkdir -p /kkb/install/taillogs/access_log
</code></pre></div><h4 id="第二步-写flume配置文件"><a href="#第二步-写flume配置文件" class="header-anchor">#</a> 第二步：写flume配置文件</h4> <p>node03开发配置文件：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf
<span class="token function">vim</span> tail-file.conf
</code></pre></div><p>配置文件内容如下：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#起名字</span>
agent1.sources <span class="token operator">=</span> source1
agent1.sinks <span class="token operator">=</span> sink1
agent1.channels <span class="token operator">=</span> channel1

<span class="token comment">#描述source</span>
agent1.sources.source1.type <span class="token operator">=</span> <span class="token builtin class-name">exec</span>
agent1.sources.source1.command <span class="token operator">=</span> <span class="token function">tail</span> -F /kkb/install/taillogs/access_log
agent1.sources.source1.channels <span class="token operator">=</span> channel1

<span class="token comment">#configure host for source</span>
<span class="token comment">#agent1.sources.source1.interceptors = i1</span>
<span class="token comment">#agent1.sources.source1.interceptors.i1.type = host</span>
<span class="token comment">#agent1.sources.source1.interceptors.i1.hostHeader = hostname</span>

<span class="token comment">## Describe sink1</span>
agent1.sinks.sink1.type <span class="token operator">=</span> hdfs

<span class="token comment">#a1.sinks.k1.channel = c1</span>
agent1.sinks.sink1.hdfs.path <span class="token operator">=</span> hdfs://node01:8020/weblog/flume-collection/%y-%m-%d/%H-%M
agent1.sinks.sink1.hdfs.filePrefix <span class="token operator">=</span> access_log
agent1.sinks.sink1.hdfs.maxOpenFiles <span class="token operator">=</span> <span class="token number">5000</span>
agent1.sinks.sink1.hdfs.batchSize<span class="token operator">=</span> <span class="token number">100</span>
agent1.sinks.sink1.hdfs.fileType <span class="token operator">=</span> DataStream
agent1.sinks.sink1.hdfs.writeFormat <span class="token operator">=</span>Text
agent1.sinks.sink1.hdfs.rollSize <span class="token operator">=</span> <span class="token number">102400</span>
agent1.sinks.sink1.hdfs.rollCount <span class="token operator">=</span> <span class="token number">1000000</span>
agent1.sinks.sink1.hdfs.rollInterval <span class="token operator">=</span> <span class="token number">60</span>
agent1.sinks.sink1.hdfs.round <span class="token operator">=</span> <span class="token boolean">true</span>
agent1.sinks.sink1.hdfs.roundValue <span class="token operator">=</span> <span class="token number">10</span>
agent1.sinks.sink1.hdfs.roundUnit <span class="token operator">=</span> minute
agent1.sinks.sink1.hdfs.useLocalTimeStamp <span class="token operator">=</span> <span class="token boolean">true</span>

<span class="token comment">## Use a channel which buffers events in memory</span>
agent1.channels.channel1.type <span class="token operator">=</span> memory
agent1.channels.channel1.keep-alive <span class="token operator">=</span> <span class="token number">120</span>
agent1.channels.channel1.capacity <span class="token operator">=</span> <span class="token number">500000</span>
agent1.channels.channel1.transactionCapacity <span class="token operator">=</span> <span class="token number">600</span>


<span class="token comment">## Bind the source and sink to the channel</span>
agent1.sources.source1.channels <span class="token operator">=</span> channel1
agent1.sinks.sink1.channel <span class="token operator">=</span> channel1
</code></pre></div><h4 id="第三步-启动flume-2"><a href="#第三步-启动flume-2" class="header-anchor">#</a> 第三步：启动flume</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin

<span class="token punctuation">[</span>hadoop@node03 apache-flume-1.6.0-cdh5.14.2-bin<span class="token punctuation">]</span>$ bin/flume-ng agent -c conf -f conf/tail-file.conf -n agent1 <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
</code></pre></div><h4 id="第四步-追加内容到监听文件"><a href="#第四步-追加内容到监听文件" class="header-anchor">#</a> 第四步：追加内容到监听文件</h4> <p>老师的做法：写脚本。</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#写脚本</span>
<span class="token punctuation">[</span>hadoop@node03 dirfile<span class="token punctuation">]</span>$ <span class="token function">vim</span> tail-file.sh

<span class="token comment">#!/bin/bash</span>
<span class="token keyword">while</span> <span class="token boolean">true</span>
<span class="token keyword">do</span>
<span class="token function">date</span> <span class="token operator">&gt;&gt;</span> /kkb/install/taillogs/access_log<span class="token punctuation">;</span>
<span class="token function">sleep</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
<span class="token keyword">done</span>

<span class="token comment">#运行脚本</span>
<span class="token punctuation">[</span>hadoop@node03 dirfile<span class="token punctuation">]</span>$ <span class="token function">bash</span> tail-file.sh  
</code></pre></div><p>我的做法：简单模仿追加数据</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>hadoop@node03 dirfile<span class="token punctuation">]</span>$ <span class="token function">date</span> <span class="token operator">&gt;&gt;</span> /kkb/install/taillogs/access_log
</code></pre></div><h4 id="第五步-查看效果"><a href="#第五步-查看效果" class="header-anchor">#</a> 第五步：查看效果</h4> <p>一旦往监听文件追加内容，则会不断生成.tmp临时文件，满足刷写数据到hdfs的条件时就会刷写channel的数据到.tmp临时文件，当满足.tmp文件转成目标文件的条件时就会去掉.tmp后缀形成目标文件，然后生成下一个新的.tmp文件，新的数据将会刷写到新临时文件。如此过程不断循环，直到停止追加数据。</p> <p>因此，.tmp文件并不一定是空的，可能为空，也可能不为空。</p> <p><img src="/assets/img/image-20200311170720929.6363fe26.png" alt="image-20200311170720929"></p> <h2 id="flume面试问题"><a href="#flume面试问题" class="header-anchor">#</a> flume面试问题</h2> <h4 id="问题1"><a href="#问题1" class="header-anchor">#</a> 问题1：</h4> <p>描述：在上面3个案例中，使用的channel都是memory channel,这个channel有个弊端，就是当flume宕机的时候，缓存在memory channel里面的数据会全部丢失。</p> <p>解决：实际工作当中一般使用file channel，比较可靠。</p> <h4 id="问题2"><a href="#问题2" class="header-anchor">#</a> 问题2：</h4> <p>描述：在实战案例2中，我们监听一个文件夹下面的所有文件的变化，案例中，文件夹下不能出现重名文件的，一旦出现，flume就会报错，而且该flume agent不会再工作。</p> <p>解决：flume的脆弱性使得我们需要监控flume是否报错。监控的方式有写脚本或者使用监控工具ganglia。</p> <h4 id="问题3"><a href="#问题3" class="header-anchor">#</a> 问题3：</h4> <p>描述：flume的采集数据的频率要怎么控制？也就是多长时间放一次数据到hdfs上面去？</p> <p>解决：两个方面，时间的滚动策略，以及文件大小的控制。可参考实战案例2中的案例分析。</p> <h4 id="问题4"><a href="#问题4" class="header-anchor">#</a> 问题4：</h4> <p>描述：假如我们监听的是一个日志文件，这个文件每天都会生成新的日志。那么怎么判断一天的日志收集完成？</p> <p>解决：比如说，今天正在刷写数据的日志文件命名为2020-02-17.log，而昨天的文件命名为2020-02-16.out，每天转点（晚上12点）后，.log文件就改成.out文件，然后新的.log文件，用来收集新的一天的数据（可类比去掉.tmp后缀）。这样可以保证一个文件只存放某一天的日志数据。</p> <h4 id="问题5"><a href="#问题5" class="header-anchor">#</a> 问题5：</h4> <p>描述：sink一般只使用文件大小的控制策略？</p> <p>解决：不是的，如果仅仅使用文件大小来控制，会有一个问题，两天的数据可能混到一个文件里面去了。</p> <h4 id="问题6"><a href="#问题6" class="header-anchor">#</a> 问题6：</h4> <p>描述：flume抛异常，重启之后，原来已经是complete但还没发到hdfs的数据，丢失了吗？</p> <p>解决：重启之后，channel会重新发送，只要channel里面的数据保存好了就不会丢失</p> <h4 id="问题7"><a href="#问题7" class="header-anchor">#</a> 问题7：</h4> <p>描述：在实战案例3中，如果flume挂掉了（可以认为ctrl+c关掉），然后重启flume时，会产生脏数据，脏数据跟重启flume之前的数据有重叠。</p> <p><img src="/assets/img/image-20200311175048826.df451982.png" alt="image-20200311175048826"></p> <p>脏数据内容如下，一共有10行数据：</p> <p><img src="/assets/img/image-20200311175226213.278fd57e.png" alt="image-20200311175226213"></p> <p>解决：产生脏数据的原因，是因为exec source没有实现断点续传（FTP）的功能。当我们flume重启时，就会执行指定的tail -f filename命令来采集数据，tail -f 默认一次显示末尾的10行数据，所以采集到了10行脏数据。为此，flume1.7当中特地新增加一个source叫做tail-dir source，专门用于解决断点续传的问题。</p> <p>注意：</p> <ul><li>我们安装的flume版本是1.6，但是因为我们的是CDH版，包含了apache1.7版本的特性，所以可以使用tail-dir source。</li> <li>断点续传功能就是：比如说我采集一个文件的内容，会不断记录我采集到第几行了，如果flume挂掉，重新开启flume采集的时候，就会从记录的那行开始采集，这样就不会漏采集或者多采集。</li> <li>实际工作当中监控文件或者文件夹都是使用tailDir Source</li></ul> <hr> <h2 id="flume实战案例4-实现断点续传"><a href="#flume实战案例4-实现断点续传" class="header-anchor">#</a> flume实战案例4：实现断点续传</h2> <p>不管是上面的spoolDIr还是execSource dir都有一个缺陷就是没法实现断点续传的功能，为此在flume1.7当中特地新增加一个source叫做taildir source，专门用于解决断点续传的问题。</p> <p>taildir source可以监控文件或者文件夹，允许我们使用正则表达式的方式来对我们的文件或者文件夹进行监听。</p> <p>taildir source的参数如下，绿色为必需参数：</p> <table><thead><tr><th style="text-align:left;">Property Name</th> <th style="text-align:left;">Default</th> <th style="text-align:left;">Description</th></tr></thead> <tbody><tr><td style="text-align:left;">channels</td> <td style="text-align:left;">–</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">type</td> <td style="text-align:left;">–</td> <td style="text-align:left;">The component type name, needs to be <code>TAILDIR</code>.</td></tr> <tr><td style="text-align:left;">filegroups</td> <td style="text-align:left;">–</td> <td style="text-align:left;">Space-separated list of file groups. Each file group indicates a set of files to be tailed.</td></tr> <tr><td style="text-align:left;">filegroups.<code>&lt;filegroupName&gt;</code></td> <td style="text-align:left;">–</td> <td style="text-align:left;">Absolute path of the file group. Regular expression (and not file system patterns) can be used for filename only.</td></tr> <tr><td style="text-align:left;">positionFile</td> <td style="text-align:left;">~/.flume/<code>&lt;br /&gt;</code>taildir_position.json</td> <td style="text-align:left;">用来设定一个记录每个文件的绝对路径和最近一次读取位置inode的文件，这个文件是JSON格式。</td></tr> <tr><td style="text-align:left;">maxBatchCount</td> <td style="text-align:left;">Long.MAX_VLUE</td> <td style="text-align:left;">控制从同一文件连续读取的批次数。 如果source读取多个文件，并且其中一个文件的写入速度很快，则它可能会阻止其他文件被处理，因为繁忙文件将被无休止地读取。 在这种情况下，请降低此值。</td></tr></tbody></table> <h4 id="案例需求-4"><a href="#案例需求-4" class="header-anchor">#</a> 案例需求：</h4> <p>使用taildir source监听某个目录下的多个文件，并且实现文件的断点续传功能</p> <h4 id="第一步-开发flume配置文件"><a href="#第一步-开发flume配置文件" class="header-anchor">#</a> 第一步：开发flume配置文件</h4> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf
vim tail-dir.conf
</code></pre></div><p>内容如下，部分配置解释如下：</p> <ul><li><p>a1.sources.r1.filegroups = f1表示文件的组，可以定义多个组，如a1.sources.r1.filegroups = f1 f2</p></li> <li><p>a1.sources.r1.filegroups.f1 = /kkb/install/dirfile/.*log.*  表示f1组，采集文件名包含log字符串的文件内容</p></li> <li><p>a1.sources.r1.positionFile = /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/taildir_position.json表示记录读取到哪一行数据等信息的保存路径</p></li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## Name the components on this agent</span>
a1.sources <span class="token operator">=</span> r1
a1.sinks <span class="token operator">=</span> k1
a1.channels <span class="token operator">=</span> c1

<span class="token comment">## Describe/configure the source</span>
a1.sources.r1.type <span class="token operator">=</span> TAILDIR
a1.sources.r1.positionFile <span class="token operator">=</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/taildir-position.json
a1.sources.r1.filegroups <span class="token operator">=</span> f1
a1.sources.r1.filegroups.f1 <span class="token operator">=</span> /kkb/install/dirfile/.*log.*
a1.sources.ri.maxBatchCount <span class="token operator">=</span> <span class="token number">1000</span>

<span class="token comment">## Describe the sink</span>
a1.sinks.k1.type <span class="token operator">=</span> hdfs
a1.sinks.k1.channel <span class="token operator">=</span> c1
a1.sinks.k1.hdfs.path <span class="token operator">=</span> hdfs://node01:8020/taildir/files/%y-%m-%d/%H%M/
a1.sinks.k1.hdfs.filePrefix <span class="token operator">=</span> events-
a1.sinks.k1.hdfs.round <span class="token operator">=</span> <span class="token boolean">true</span>
a1.sinks.k1.hdfs.roundValue <span class="token operator">=</span> <span class="token number">10</span>
a1.sinks.k1.hdfs.roundUnit <span class="token operator">=</span> minute
a1.sinks.k1.hdfs.rollInterval <span class="token operator">=</span> <span class="token number">3</span>
a1.sinks.k1.hdfs.rollSize <span class="token operator">=</span> <span class="token number">5000</span>
a1.sinks.k1.hdfs.rollCount <span class="token operator">=</span> <span class="token number">50000</span>
a1.sinks.k1.hdfs.batchSize <span class="token operator">=</span> <span class="token number">5000</span>
a1.sinks.k1.hdfs.useLocalTimeStamp <span class="token operator">=</span> <span class="token boolean">true</span>

<span class="token comment">#生成的文件类型，默认是Sequencefile，可用DataStream，则为普通文本</span>
a1.sinks.k1.hdfs.fileType <span class="token operator">=</span> DataStream

<span class="token comment">## Use a channel which buffers events in memory</span>
a1.channels.c1.type <span class="token operator">=</span> memory
a1.channels.c1.capacity <span class="token operator">=</span> <span class="token number">1000</span>
a1.channels.c1.transactionCapacity <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment">## Bind the source and sink to the channel</span>
a1.sources.r1.channels <span class="token operator">=</span> c1
a1.sinks.k1.channel <span class="token operator">=</span> c1 
</code></pre></div><h4 id="第二步-启动flume"><a href="#第二步-启动flume" class="header-anchor">#</a> 第二步：启动flume</h4> <p>node03执行以下命令启动flume</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin

bin/flume-ng agent -c conf -f conf/tail-dir.conf -n a1 -Dflume.root.logger<span class="token operator">=</span>INFO,console
</code></pre></div><h4 id="第三步-在监听目录创建文件并追加数据"><a href="#第三步-在监听目录创建文件并追加数据" class="header-anchor">#</a> 第三步：在监听目录创建文件并追加数据</h4> <p>node03执行以下命令创建文件到指定文件夹下</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">mkdir</span> /kkb/install/dirfile
<span class="token builtin class-name">echo</span> <span class="token string">&quot;testlog&quot;</span>  <span class="token operator">&gt;&gt;</span> /kkb/install/dirfile/file1.log
<span class="token builtin class-name">echo</span> <span class="token string">&quot;testlog2&quot;</span> <span class="token operator">&gt;&gt;</span> /kkb/install/dirfile/file1.log
<span class="token builtin class-name">echo</span> <span class="token string">&quot;testlog3&quot;</span> <span class="token operator">&gt;&gt;</span> /kkb/install/dirfile/file1.log
</code></pre></div><h2 id="flume实战案例5-两个agent级联"><a href="#flume实战案例5-两个agent级联" class="header-anchor">#</a> flume实战案例5：两个agent级联</h2> <h4 id="案例需求-5"><a href="#案例需求-5" class="header-anchor">#</a> 案例需求</h4> <p>看下图，如果要收集web服务器中产生的日志到hadoop集群中，则需要进行网络传输。请模拟网路传输采集某台非本地机器产生的数据。</p> <p><img src="/assets/img/image-20200311204635495.aac29993.png" alt="image-20200311204635495"></p> <h4 id="案例分析-3"><a href="#案例分析-3" class="header-anchor">#</a> 案例分析</h4> <p>我们可以把hadoop的某台机器比作web服务器，如node02。那么node02就需要安装flume。这样就有两台机器（node02,node03)安装了flume。使用node02的flume监听node02的某个</p> <p>确定node02的flume配置：</p> <ul><li>source---&gt;taildir source</li> <li>channel---&gt;memory channel</li> <li>sink---&gt;avro sink(要将数据从node02通过网络传输下沉到node03)</li></ul> <p>确定node03的flume配置：</p> <ul><li>source---&gt;avro source（node03要采集从node02传过来的数据）</li> <li>channel---&gt;memory channel</li> <li>sink--&gt;hdfs sink</li></ul> <p>avro source参数：</p> <table><thead><tr><th style="text-align:left;">Property Name</th> <th style="text-align:left;">Default</th> <th style="text-align:left;">Description</th></tr></thead> <tbody><tr><td style="text-align:left;"><strong>channels</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><strong>type</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;">The component type name, needs to be <code>avro</code></td></tr> <tr><td style="text-align:left;"><strong>bind</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;">hostname or IP address to listen on</td></tr> <tr><td style="text-align:left;"><strong>port</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;">Port ## to bind to</td></tr></tbody></table> <p>avro sink参数:</p> <table><thead><tr><th style="text-align:left;">Property Name</th> <th style="text-align:left;">Default</th> <th style="text-align:left;">Description</th></tr></thead> <tbody><tr><td style="text-align:left;"><strong>channel</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><strong>type</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;">The component type name, needs to be <code>avro</code>.</td></tr> <tr><td style="text-align:left;"><strong>hostname</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;">The hostname or IP address to bind to.</td></tr> <tr><td style="text-align:left;"><strong>port</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;">The port ## to listen on.</td></tr> <tr><td style="text-align:left;">batch-size</td> <td style="text-align:left;">100</td> <td style="text-align:left;">number of event to batch together for send.</td></tr></tbody></table> <p>注意事项：</p> <p>在该案例中，node02的flume的avor sink和node03的avro source要注意ip地址（hostname)的值，要统一填写node03的ip地址192.168.52.103，因为node03是接收方。而且端口也要一致。</p> <h4 id="第一步-node02安装flume"><a href="#第一步-node02安装flume" class="header-anchor">#</a> 第一步：node02安装flume</h4> <p>将node03机器上面的flume安装文件拷贝到node02机器上面去</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>hadoop@node02 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">cd</span> /kkb/install/
<span class="token punctuation">[</span>hadoop@node03 install<span class="token punctuation">]</span>$ <span class="token function">scp</span> -r  apache-flume-1.6.0-cdh5.14.2-bin/ node02:<span class="token environment constant">$PWD</span>
</code></pre></div><h4 id="第二步-node02开发flume配置文件"><a href="#第二步-node02开发flume配置文件" class="header-anchor">#</a> 第二步：node02开发flume配置文件</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf
<span class="token function">vim</span> node02_test1.conf
</code></pre></div><p>内容如下：</p> <p>注意事项：a1.sources.r1.positionFile = /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/avro-position.json中的avro-position.json的一定不要有下划线，命名有下划线的话很可能报错。</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## Name the components on this agent</span>
a1.sources <span class="token operator">=</span> r1
a1.sinks <span class="token operator">=</span> k1
a1.channels <span class="token operator">=</span> c1

<span class="token comment">## Describe/configure the source</span>
a1.sources.r1.type <span class="token operator">=</span> TAILDIR
a1.sources.r1.positionFile <span class="token operator">=</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/avro-position.json
a1.sources.r1.filegroups <span class="token operator">=</span> f1
a1.sources.r1.filegroups.f1 <span class="token operator">=</span> /kkb/install/avro-dirfile/.*log.*
a1.sources.ri.maxBatchCount <span class="token operator">=</span> <span class="token number">1000</span>

<span class="token comment">## Describe the sink</span>
<span class="token comment">#sink端的avro是一个数据发送者</span>
a1.sinks <span class="token operator">=</span> k1
a1.sinks.k1.type <span class="token operator">=</span> avro
a1.sinks.k1.channel <span class="token operator">=</span> c1
a1.sinks.k1.hostname <span class="token operator">=</span> <span class="token number">192.168</span>.52.103
a1.sinks.k1.port <span class="token operator">=</span> <span class="token number">4141</span>
a1.sinks.k1.batch-size <span class="token operator">=</span> <span class="token number">10</span>

<span class="token comment">## Use a channel which buffers events in memory</span>
a1.channels.c1.type <span class="token operator">=</span> memory
a1.channels.c1.capacity <span class="token operator">=</span> <span class="token number">1000</span>
a1.channels.c1.transactionCapacity <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment">## Bind the source and sink to the channel</span>
a1.sources.r1.channels <span class="token operator">=</span> c1
a1.sinks.k1.channel <span class="token operator">=</span> c1
</code></pre></div><h4 id="第四步-node03开发flume配置文件"><a href="#第四步-node03开发flume配置文件" class="header-anchor">#</a> 第四步：node03开发flume配置文件</h4> <p>在node03机器上开发flume的配置文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf
<span class="token function">vim</span> node03_test1.conf
</code></pre></div><p>内容如下：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## Name the components on this agent</span>
a1.sources <span class="token operator">=</span> r1
a1.sinks <span class="token operator">=</span> k1
a1.channels <span class="token operator">=</span> c1

<span class="token comment">## Describe/configure the source</span>
<span class="token comment">#source中的avro组件是一个接收者服务</span>
a1.sources.r1.type <span class="token operator">=</span> avro
a1.sources.r1.channels <span class="token operator">=</span> c1
a1.sources.r1.bind <span class="token operator">=</span> <span class="token number">192.168</span>.52.103
a1.sources.r1.port <span class="token operator">=</span> <span class="token number">4141</span>

<span class="token comment">## Describe the sink</span>
a1.sinks.k1.type <span class="token operator">=</span> hdfs
a1.sinks.k1.hdfs.path <span class="token operator">=</span> hdfs://node01:8020/avro/hdfs/%y-%m-%d/%H%M/
a1.sinks.k1.hdfs.filePrefix <span class="token operator">=</span> events-
a1.sinks.k1.hdfs.round <span class="token operator">=</span> <span class="token boolean">true</span>
a1.sinks.k1.hdfs.roundValue <span class="token operator">=</span> <span class="token number">10</span>
a1.sinks.k1.hdfs.roundUnit <span class="token operator">=</span> minute
a1.sinks.k1.hdfs.rollInterval <span class="token operator">=</span> <span class="token number">3</span>
a1.sinks.k1.hdfs.rollSize <span class="token operator">=</span> <span class="token number">20</span>
a1.sinks.k1.hdfs.rollCount <span class="token operator">=</span> <span class="token number">5</span>
a1.sinks.k1.hdfs.batchSize <span class="token operator">=</span> <span class="token number">1</span>
a1.sinks.k1.hdfs.useLocalTimeStamp <span class="token operator">=</span> <span class="token boolean">true</span>

<span class="token comment">#生成的文件类型，默认是Sequencefile，可用DataStream，则为普通文本</span>
a1.sinks.k1.hdfs.fileType <span class="token operator">=</span> DataStream

<span class="token comment">## Use a channel which buffers events in memory</span>
a1.channels.c1.type <span class="token operator">=</span> memory
a1.channels.c1.capacity <span class="token operator">=</span> <span class="token number">1000</span>
a1.channels.c1.transactionCapacity <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment">## Bind the source and sink to the channel</span>
a1.sources.r1.channels <span class="token operator">=</span> c1
a1.sinks.k1.channel <span class="token operator">=</span> c1
</code></pre></div><h4 id="第三步-node02创建监听目录"><a href="#第三步-node02创建监听目录" class="header-anchor">#</a> 第三步：node02创建监听目录</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>hadoop@node02 ~<span class="token punctuation">]</span>$ <span class="token function">mkdir</span> /kkb/install/avro-dirfile
</code></pre></div><h4 id="第四步-顺序启动node02-03的flume"><a href="#第四步-顺序启动node02-03的flume" class="header-anchor">#</a> 第四步：顺序启动node02/03的flume</h4> <p>node03机器启动flume进程（先启动）</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin
bin/flume-ng agent -c conf -f conf/node03_test1.conf -n a1 -Dflume.root.logger<span class="token operator">=</span>INFO,console 
</code></pre></div><p>node02机器启动flume进程（后启动）</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/
bin/flume-ng agent -c conf -f conf/node02_test1.conf -n a1 -Dflume.root.logger<span class="token operator">=</span>INFO,console 
</code></pre></div><h4 id="第五步-往node02监听目录写入文件"><a href="#第五步-往node02监听目录写入文件" class="header-anchor">#</a> 第五步：往node02监听目录写入文件</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>hadoop@node02 install<span class="token punctuation">]</span>$ <span class="token builtin class-name">cd</span> /kkb/install/avro-dirfile/

<span class="token punctuation">[</span>hadoop@node02 avro-dirfile<span class="token punctuation">]</span>$ <span class="token function">date</span> <span class="token operator">&gt;&gt;</span> krystal.log
<span class="token punctuation">[</span>hadoop@node02 avro-dirfile<span class="token punctuation">]</span>$ <span class="token function">date</span> <span class="token operator">&gt;&gt;</span> krystal.log
<span class="token punctuation">[</span>hadoop@node02 avro-dirfile<span class="token punctuation">]</span>$ <span class="token function">date</span> <span class="token operator">&gt;&gt;</span> krystal.log
</code></pre></div><h2 id="思考问题"><a href="#思考问题" class="header-anchor">#</a> 思考问题：</h2> <p>如果有很多服务器，产生的日志都由一个机器的flume收集，那么一旦这个机器的flume挂掉了，将会损失重大，而且可能造成负载不均衡，接下来，就讲如何解决这个问题。</p> <img src="flume.assets/image-20200311230906170.png" alt="image-20200311230906170" style="zoom:67%;"> <h2 id="flume实战案例6-高可用failover"><a href="#flume实战案例6-高可用failover" class="header-anchor">#</a> flume实战案例6：高可用failover</h2> <h4 id="案例需求-6"><a href="#案例需求-6" class="header-anchor">#</a> 案例需求</h4> <p>搭建一个高可用的Flume NG集群，如下，一开始，node01采集的数据发送到node02(node03)上去，一旦node02(node03)挂掉了以后，就往node03(node02)上发送数据。</p> <p><img src="/assets/img/image-20200312010453984.16f5a41a.png" alt="image-20200312010453984"></p> <h4 id="案例分析-4"><a href="#案例分析-4" class="header-anchor">#</a> 案例分析</h4> <p>角色分配：</p> <p>Flume的Agent和Collector分布如下表所示：</p> <table><thead><tr><th>名称</th> <th>HOST</th> <th>角色</th></tr></thead> <tbody><tr><td>Agent1</td> <td>node01</td> <td>Web  Server</td></tr> <tr><td>Collector1</td> <td>node02</td> <td>AgentMstr1</td></tr> <tr><td>Collector2</td> <td>node03</td> <td>AgentMstr2</td></tr></tbody></table> <p>Agent1数据分别流入到Collector1和Collector2，Flume NG本身提供了Failover机制，可以自动切换和恢复，从而实现高可用。</p> <p>node01:</p> <ul><li>source: taildir source</li> <li>channel:memory channel</li> <li>sink:avro sink</li></ul> <p>node02:</p> <ul><li>source: avro source</li> <li>channel:memory channel</li> <li>sink:hdfs sink</li></ul> <p>node03:</p> <ul><li>source: avro source</li> <li>channel:memory channel</li> <li>sink:hdfs sink</li></ul> <h4 id="第一步-node01安装flume"><a href="#第一步-node01安装flume" class="header-anchor">#</a> 第一步：node01安装flume</h4> <p>将node03或者node02的flume安装包拷贝到node01上去。</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>hadoop@node02 install<span class="token punctuation">]</span>$ <span class="token builtin class-name">cd</span> /kkb/install
<span class="token punctuation">[</span>hadoop@node02 install<span class="token punctuation">]</span>$ <span class="token function">scp</span> -r apache-flume-1.6.0-cdh5.14.2-bin/ node01:/kkb/install/
</code></pre></div><h4 id="第二步-node01开发flume配置文件"><a href="#第二步-node01开发flume配置文件" class="header-anchor">#</a> 第二步：node01开发flume配置文件</h4> <p>node01机器配置agent的配置文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf

<span class="token function">vim</span> agent.conf
</code></pre></div><p>内容如下：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#agent1 name</span>
agent1.channels <span class="token operator">=</span> c1
agent1.sources <span class="token operator">=</span> r1
agent1.sinks <span class="token operator">=</span> k1 k2

<span class="token comment">#set channel</span>
agent1.channels.c1.type <span class="token operator">=</span> memory
agent1.channels.c1.capacity <span class="token operator">=</span> <span class="token number">1000</span>
agent1.channels.c1.transactionCapacity <span class="token operator">=</span> <span class="token number">100</span>



<span class="token comment">#agent1.sources.r1.type = exec</span>
<span class="token comment">#agent1.sources.r1.command = tail -F /kkb/install/taillogs/access_log</span>
agent1.sources.r1.channels <span class="token operator">=</span> c1
agent1.sources.r1.type <span class="token operator">=</span> TAILDIR
agent1.sources.r1.positionFile <span class="token operator">=</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/failover-position.json
agent1.sources.r1.filegroups <span class="token operator">=</span> f1
agent1.sources.r1.filegroups.f1 <span class="token operator">=</span> /kkb/install/failover-dirfile/.*log.*
agent1.sources.ri.maxBatchCount <span class="token operator">=</span> <span class="token number">1000</span>

agent1.sources.r1.interceptors <span class="token operator">=</span> i1 i2
agent1.sources.r1.interceptors.i1.type <span class="token operator">=</span> static
agent1.sources.r1.interceptors.i1.key <span class="token operator">=</span> Type
agent1.sources.r1.interceptors.i1.value <span class="token operator">=</span> LOGIN
agent1.sources.r1.interceptors.i2.type <span class="token operator">=</span> timestamp

<span class="token comment">## set sink1</span>
agent1.sinks.k1.channel <span class="token operator">=</span> c1
agent1.sinks.k1.type <span class="token operator">=</span> avro
agent1.sinks.k1.hostname <span class="token operator">=</span> node02
agent1.sinks.k1.port <span class="token operator">=</span> <span class="token number">52020</span>

<span class="token comment">## set sink2</span>
agent1.sinks.k2.channel <span class="token operator">=</span> c1
agent1.sinks.k2.type <span class="token operator">=</span> avro
agent1.sinks.k2.hostname <span class="token operator">=</span> node03
agent1.sinks.k2.port <span class="token operator">=</span> <span class="token number">52020</span>

<span class="token comment">#set gruop</span>
agent1.sinkgroups <span class="token operator">=</span> g1
<span class="token comment">#set sink group</span>
agent1.sinkgroups.g1.sinks <span class="token operator">=</span> k1 k2

<span class="token comment">#set failover</span>
agent1.sinkgroups.g1.processor.type <span class="token operator">=</span> failover
agent1.sinkgroups.g1.processor.priority.k1 <span class="token operator">=</span> <span class="token number">10</span>
agent1.sinkgroups.g1.processor.priority.k2 <span class="token operator">=</span> <span class="token number">1</span>
agent1.sinkgroups.g1.processor.maxpenalty <span class="token operator">=</span> <span class="token number">1000</span>
</code></pre></div><p>部分参数解释如下：</p> <ul><li><p>agent1.sinks = k1 k2，node01的flume要设置两个sink,分别下沉数据到node02/node03</p></li> <li><p>interceptors是拦截器，后面会讲。</p></li> <li><p>agent1.sinkgroups.g1.sinks = k1 k2，设置名为g1的sinkgroup的sinks为k1,k2</p></li> <li><p>Flume Sink Processors---&gt;Sink groups allow users to group multiple sinks into one entity. Sink processors can be used to provide load balancing capabilities over all sinks inside the group or to achieve fail over from one sink to another in case of temporal failure. 这段话的意思是，sink groups允许我们将多个sink作为一个整体，而sink processors可以用于提供，对sink group内的所有sink进行负载均衡的功能，或者完成高可用的功能。</p></li> <li><p>flume sink processors的必需参数如下：</p> <table><thead><tr><th style="text-align:left;">Property Name</th> <th style="text-align:left;">Default</th> <th style="text-align:left;">Description</th></tr></thead> <tbody><tr><td style="text-align:left;"><strong>sinks</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;">Space-separated list of sinks that are participating in the group</td></tr> <tr><td style="text-align:left;"><strong>processor.type</strong></td> <td style="text-align:left;">default</td> <td style="text-align:left;">The component type name, needs to be default, failover or load_balance</td></tr></tbody></table></li> <li><p>default sink processor accepts only a single sink. User is not forced to create processor (sink group) for single sinks.</p></li> <li><p>代码块中的processor.type = failover表示使用failover sink机制，即高可用。</p></li> <li><p>failover sink参数如下：</p> <table><thead><tr><th style="text-align:left;">Property Name</th> <th style="text-align:left;">Default</th> <th style="text-align:left;">Description</th></tr></thead> <tbody><tr><td style="text-align:left;"><strong>sinks</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;">Space-separated list of sinks that are participating in the group</td></tr> <tr><td style="text-align:left;"><strong>processor.type</strong></td> <td style="text-align:left;">default</td> <td style="text-align:left;">The component type name, needs to be failover。</td></tr> <tr><td style="text-align:left;"><strong>processor.priority.</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;">Priority value. <code>&lt;sinkName&gt;</code> must be one of the sink instances associated with the current sink group A higher priority value Sink gets activated earlier. A larger absolute value indicates higher priority</td></tr> <tr><td style="text-align:left;">processor.maxpenalty</td> <td style="text-align:left;">30000</td> <td style="text-align:left;">The maximum backoff period for the failed Sink (in millis)</td></tr></tbody></table></li> <li><p>代码块中的processor.priority.k1用来设置某个sink的权重，在该案例中，node01的数据将会优先使用权重高的sink来进行下沉数据。而不同的sink对应不同的主机（node02/node03)。</p></li> <li><p>processors的使用方法的example</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#agent named a1</span>
a1.sinkgroups <span class="token operator">=</span> g1
a1.sinkgroups.g1.sinks <span class="token operator">=</span> k1 k2
a1.sinkgroups.g1.processor.type <span class="token operator">=</span> load_balance
</code></pre></div></li></ul> <h4 id="第三步-node02开发flume配置文件"><a href="#第三步-node02开发flume配置文件" class="header-anchor">#</a> 第三步：node02开发flume配置文件</h4> <p>node02机器修改配置文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf
<span class="token function">vim</span> collector.conf
</code></pre></div><p>内容如下：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#set Agent name</span>
a1.sources <span class="token operator">=</span> r1
a1.channels <span class="token operator">=</span> c1
a1.sinks <span class="token operator">=</span> k1

<span class="token comment">#set channel</span>
a1.channels.c1.type <span class="token operator">=</span> memory
a1.channels.c1.capacity <span class="token operator">=</span> <span class="token number">1000</span>
a1.channels.c1.transactionCapacity <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment">## other node,nna to nns</span>
a1.sources.r1.type <span class="token operator">=</span> avro
a1.sources.r1.bind <span class="token operator">=</span> node02
a1.sources.r1.port <span class="token operator">=</span> <span class="token number">52020</span>
a1.sources.r1.interceptors <span class="token operator">=</span> i1
a1.sources.r1.interceptors.i1.type <span class="token operator">=</span> static
a1.sources.r1.interceptors.i1.key <span class="token operator">=</span> Collector
a1.sources.r1.interceptors.i1.value <span class="token operator">=</span> node02
a1.sources.r1.channels <span class="token operator">=</span> c1

<span class="token comment">#set sink to hdfs</span>
a1.sinks.k1.type<span class="token operator">=</span>hdfs
a1.sinks.k1.hdfs.path<span class="token operator">=</span> hdfs://node01:8020/flume/failover/
a1.sinks.k1.hdfs.fileType<span class="token operator">=</span>DataStream
a1.sinks.k1.hdfs.writeFormat<span class="token operator">=</span>TEXT
a1.sinks.k1.hdfs.rollInterval<span class="token operator">=</span><span class="token number">10</span>
a1.sinks.k1.channel<span class="token operator">=</span>c1
a1.sinks.k1.hdfs.filePrefix<span class="token operator">=</span>%Y-%m-%d
</code></pre></div><h4 id="第四步-node03开发flume配置文件-2"><a href="#第四步-node03开发flume配置文件-2" class="header-anchor">#</a> 第四步：node03开发flume配置文件</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf
<span class="token function">vim</span> collector.conf
</code></pre></div><p>内容如下：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#set Agent name</span>
a1.sources <span class="token operator">=</span> r1
a1.channels <span class="token operator">=</span> c1
a1.sinks <span class="token operator">=</span> k1

<span class="token comment">#set channel</span>
a1.channels.c1.type <span class="token operator">=</span> memory
a1.channels.c1.capacity <span class="token operator">=</span> <span class="token number">1000</span>
a1.channels.c1.transactionCapacity <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment">## other node,nna to nns</span>
a1.sources.r1.type <span class="token operator">=</span> avro
a1.sources.r1.bind <span class="token operator">=</span> node03
a1.sources.r1.port <span class="token operator">=</span> <span class="token number">52020</span>
a1.sources.r1.interceptors <span class="token operator">=</span> i1
a1.sources.r1.interceptors.i1.type <span class="token operator">=</span> static
a1.sources.r1.interceptors.i1.key <span class="token operator">=</span> Collector
a1.sources.r1.interceptors.i1.value <span class="token operator">=</span> node03
a1.sources.r1.channels <span class="token operator">=</span> c1

<span class="token comment">#set sink to hdfs</span>
a1.sinks.k1.type<span class="token operator">=</span>hdfs
a1.sinks.k1.hdfs.path<span class="token operator">=</span> hdfs://node01:8020/flume/failover/
a1.sinks.k1.hdfs.fileType<span class="token operator">=</span>DataStream
a1.sinks.k1.hdfs.writeFormat<span class="token operator">=</span>TEXT
a1.sinks.k1.hdfs.rollInterval<span class="token operator">=</span><span class="token number">10</span>
a1.sinks.k1.channel<span class="token operator">=</span>c1
a1.sinks.k1.hdfs.filePrefix<span class="token operator">=</span>%Y-%m-%d
</code></pre></div><h4 id="第五步-node01创建监听目录"><a href="#第五步-node01创建监听目录" class="header-anchor">#</a> 第五步：node01创建监听目录</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>hadoop@node01 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">cd</span> /kkb/install/failover-dirfile/
</code></pre></div><h4 id="第六步-顺序启动flume"><a href="#第六步-顺序启动flume" class="header-anchor">#</a> 第六步：顺序启动flume</h4> <p>node03机器上面启动flume</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin

<span class="token punctuation">[</span>hadoop@node03 apache-flume-1.6.0-cdh5.14.2-bin<span class="token punctuation">]</span>$ bin/flume-ng agent -n a1 -c conf -f conf/collector.conf -Dflume.root.logger<span class="token operator">=</span>DEBUG,console
</code></pre></div><p>node02机器上面启动flume</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin

<span class="token punctuation">[</span>hadoop@node02 apache-flume-1.6.0-cdh5.14.2-bin<span class="token punctuation">]</span>$ bin/flume-ng agent -n a1 -c conf -f conf/collector.conf -Dflume.root.logger<span class="token operator">=</span>DEBUG,console
</code></pre></div><p>node01机器上面启动flume</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin

<span class="token punctuation">[</span>hadoop@node01 apache-flume-1.6.0-cdh5.14.2-bin<span class="token punctuation">]</span>$ bin/flume-ng agent -n agent1 -c conf -f conf/agent.conf -Dflume.root.logger<span class="token operator">=</span>DEBUG,console
</code></pre></div><h4 id="第七步-往监听目录写入数据"><a href="#第七步-往监听目录写入数据" class="header-anchor">#</a> 第七步：往监听目录写入数据</h4> <p>开发用于写入数据的脚本：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>hadoop@node01 ~<span class="token punctuation">]</span>$ <span class="token function">mkdir</span> /kkb/install/myShell  
<span class="token punctuation">[</span>hadoop@node01 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">cd</span> /kkb/install/myShell/
<span class="token punctuation">[</span>hadoop@node01 myShell<span class="token punctuation">]</span>$ <span class="token function">vim</span> add.sh

<span class="token comment">#!/bin/bash</span>
<span class="token keyword">while</span> <span class="token boolean">true</span>
<span class="token keyword">do</span>
<span class="token function">date</span> <span class="token operator">&gt;&gt;</span> /kkb/install/failover-dirfile/failtoverTest.log<span class="token punctuation">;</span>
<span class="token function">sleep</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
<span class="token keyword">done</span>
</code></pre></div><p>node01机器启动脚本</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sh</span> add.sh
</code></pre></div><p>注意：写入数据必须在开启flume之后，否则可能在启动node01上的flume时，会报小错。</p> <h4 id="第八步-failover测试-故障转移"><a href="#第八步-failover测试-故障转移" class="header-anchor">#</a> 第八步：Failover测试（故障转移）</h4> <p>下面我们来测试下Flume NG集群的高可用（故障转移）。</p> <p>场景如下：</p> <p>我们在Agent1节点上传文件，由于node02上的Collector1的权重比node03的Collector2大，所以 Collector1优先采集从node01的flume下沉过来的数据，并上传到hdfs存储系统。</p> <p>然后我们kill掉node02上的Collector1，此时将会由node03上的Collector2负责日志的采集上传工作，之后，我 们手动恢复Collector1节点的Flume服务，再次在Agent1上次文件，发现Collector1又恢复了优先级别的采集工作。</p> <h2 id="flume实战案例7-负载均衡load-balancer"><a href="#flume实战案例7-负载均衡load-balancer" class="header-anchor">#</a> flume实战案例7：负载均衡load balancer</h2> <p>负载均衡是用于解决一台机器(一个进程)无法解决所有请求而产生的一种算法。Load balancing Sink Processor 能够实现 load balance 功能，如下图Agent1 是一个路由节点，负责将 Channel 暂存的 Event 均衡到对应的多个 Sink组件上，而每个 Sink 组件分别连接到一个独立的 Agent 上，示例配置，如下所示：</p> <p><img src="/assets/img/clip_image026.a49a53ca.jpg" alt="img"></p> <h4 id="案例需求-7"><a href="#案例需求-7" class="header-anchor">#</a> 案例需求</h4> <p>实现负载均衡：</p> <p><img src="/assets/img/image-20200312161423777.03789e1b.png" alt="image-20200312161423777"></p> <h4 id="案例分析-5"><a href="#案例分析-5" class="header-anchor">#</a> 案例分析</h4> <p>三台机器规划如下：</p> <p>node01：采集数据，发送到node02和node03机器上去</p> <p>node02：接收node01的部分数据</p> <p>node03：接收node01的部分数据</p> <h4 id="第一步-node01开发flume配置文件"><a href="#第一步-node01开发flume配置文件" class="header-anchor">#</a> 第一步：node01开发flume配置文件</h4> <p>node01服务器配置：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf

<span class="token function">vim</span> load_banlancer_client.conf
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#agent name</span>
a1.channels <span class="token operator">=</span> c1
a1.sources <span class="token operator">=</span> r1
a1.sinks <span class="token operator">=</span> k1 k2

<span class="token comment">#set channel</span>
a1.channels.c1.type <span class="token operator">=</span> memory
a1.channels.c1.capacity <span class="token operator">=</span> <span class="token number">1000</span>
a1.channels.c1.transactionCapacity <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment">#set source</span>
a1.sources.r1.channels <span class="token operator">=</span> c1
a1.sources.r1.type <span class="token operator">=</span> TAILDIR
a1.sources.r1.positionFile <span class="token operator">=</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/loadbalancer-position.json
a1.sources.r1.filegroups <span class="token operator">=</span> f1
a1.sources.r1.filegroups.f1 <span class="token operator">=</span> /kkb/install/loadbalancer-dirfile/.*log.*
a1.sources.ri.maxBatchCount <span class="token operator">=</span> <span class="token number">1000</span>
<span class="token comment">#a1.sources.r1.type = exec</span>
<span class="token comment">#a1.sources.r1.command = tail -F /kkb/install/taillogs/access_log</span>

<span class="token comment">## set sink1</span>
a1.sinks.k1.channel <span class="token operator">=</span> c1
a1.sinks.k1.type <span class="token operator">=</span> avro
a1.sinks.k1.hostname <span class="token operator">=</span> node02
a1.sinks.k1.port <span class="token operator">=</span> <span class="token number">52020</span>

<span class="token comment">## set sink2</span>
a1.sinks.k2.channel <span class="token operator">=</span> c1
a1.sinks.k2.type <span class="token operator">=</span> avro
a1.sinks.k2.hostname <span class="token operator">=</span> node03
a1.sinks.k2.port <span class="token operator">=</span> <span class="token number">52020</span>

<span class="token comment">#set gruop</span>
a1.sinkgroups <span class="token operator">=</span> g1
<span class="token comment">#set sink group</span>
a1.sinkgroups.g1.sinks <span class="token operator">=</span> k1 k2

<span class="token comment">#set processor</span>
a1.sinkgroups.g1.processor.type <span class="token operator">=</span> load_balance
a1.sinkgroups.g1.processor.backoff <span class="token operator">=</span> <span class="token boolean">true</span>
a1.sinkgroups.g1.processor.selector <span class="token operator">=</span> round_robin
a1.sinkgroups.g1.processor.selector.maxTimeOut<span class="token operator">=</span><span class="token number">10000</span>
</code></pre></div><p>部分参数解释如下：</p> <ul><li><p>processor.type = load_balance表示使用Load balancing Sink Processor(负载均衡)</p></li> <li><p>Load balancing Sink Processor可设置的参数如下：</p> <table><thead><tr><th style="text-align:left;">Property Name</th> <th style="text-align:left;">Default</th> <th style="text-align:left;">Description</th></tr></thead> <tbody><tr><td style="text-align:left;"><strong>processor.sinks</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;">Space-separated list of sinks that are participating in the group</td></tr> <tr><td style="text-align:left;"><strong>processor.type</strong></td> <td style="text-align:left;">default</td> <td style="text-align:left;">The component type name, needs to be load_balance</td></tr> <tr><td style="text-align:left;">processor.backoff</td> <td style="text-align:left;">false</td> <td style="text-align:left;">Should failed sinks be backed off exponentially.<code>&lt;br /&gt;</code>失败的sink是否启用回退。</td></tr> <tr><td style="text-align:left;">processor.selector</td> <td style="text-align:left;">round_robin</td> <td style="text-align:left;">Selection mechanism. Must be either round_robin,random or FQCN of custom class that inherits from AbstractSinkSelector</td></tr> <tr><td style="text-align:left;">processor.selector.maxTimeOut</td> <td style="text-align:left;">30000</td> <td style="text-align:left;">Used by backoff selectors to limit exponential backoff (in milliseconds)</td></tr></tbody></table></li> <li><p>processor.selector表示选择机制，round_bin表示使用轮询方式（轮流使用node02,node03对应的sink)，random表示随机选择。</p></li></ul> <h4 id="第二步-node02开发flume配置文件-2"><a href="#第二步-node02开发flume配置文件-2" class="header-anchor">#</a> 第二步：node02开发flume配置文件</h4> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf

vim load_banlancer_server.conf
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## Name the components on this agent</span>
a1.sources <span class="token operator">=</span> r1
a1.sinks <span class="token operator">=</span> k1
a1.channels <span class="token operator">=</span> c1

<span class="token comment">## Describe/configure the source</span>
a1.sources.r1.type <span class="token operator">=</span> avro
a1.sources.r1.channels <span class="token operator">=</span> c1
a1.sources.r1.bind <span class="token operator">=</span> node02
a1.sources.r1.port <span class="token operator">=</span> <span class="token number">52020</span>

<span class="token comment">## Describe the sink</span>
a1.sinks.k1.type <span class="token operator">=</span> logger
 
<span class="token comment">## Use a channel which buffers events in memory</span>
a1.channels.c1.type <span class="token operator">=</span> memory
a1.channels.c1.capacity <span class="token operator">=</span> <span class="token number">1000</span>
a1.channels.c1.transactionCapacity <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment">## Bind the source and sink to the channel</span>
a1.sources.r1.channels <span class="token operator">=</span> c1
a1.sinks.k1.channel <span class="token operator">=</span> c1
</code></pre></div><p>部分参数解释如下：</p> <ul><li><p>a1.sinks.k1.type = logger，表示使用logger sink</p></li> <li><p>logger sink: Logs event at INFO level. Typically useful for testing/debugging purpose.翻译：在INFO级别记录logs evnet，logger sink对于测试/调试很有用处</p></li> <li><p>logger sink参数：</p> <table><thead><tr><th style="text-align:left;">Property Name</th> <th style="text-align:left;">Default</th> <th style="text-align:left;">Description</th></tr></thead> <tbody><tr><td style="text-align:left;"><strong>channel</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><strong>type</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;">The component type name, needs to be logger</td></tr> <tr><td style="text-align:left;">maxBytesToLog</td> <td style="text-align:left;">16</td> <td style="text-align:left;">Maximum number of bytes of the Event body to log</td></tr></tbody></table></li> <li><p>logger sink通常用于调试，它不会将采集的数据存放到文件系统中，而是输出到屏幕上（详情请看第六步）。</p></li> <li><p>logger sink默认将输出到屏幕的event body限制为16字节，从而避免屏幕充斥过多内容。如果要查看event的完整内容，则需要使用其它的sink。</p></li></ul> <h4 id="第三步-node03开发flume配置文件"><a href="#第三步-node03开发flume配置文件" class="header-anchor">#</a> 第三步：node03开发flume配置文件</h4> <p>node03服务器配置</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf

vim load_banlancer_server.conf
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## Name the components on this agent</span>
a1.sources <span class="token operator">=</span> r1
a1.sinks <span class="token operator">=</span> k1
a1.channels <span class="token operator">=</span> c1

<span class="token comment">## Describe/configure the source</span>
a1.sources.r1.type <span class="token operator">=</span> avro
a1.sources.r1.channels <span class="token operator">=</span> c1
a1.sources.r1.bind <span class="token operator">=</span> node03
a1.sources.r1.port <span class="token operator">=</span> <span class="token number">52020</span>

<span class="token comment">## Describe the sink</span>
a1.sinks.k1.type <span class="token operator">=</span> logger

<span class="token comment">## Use a channel which buffers events in memory</span>
a1.channels.c1.type <span class="token operator">=</span> memory
a1.channels.c1.capacity <span class="token operator">=</span> <span class="token number">1000</span>
a1.channels.c1.transactionCapacity <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment">## Bind the source and sink to the channel</span>
a1.sources.r1.channels <span class="token operator">=</span> c1
a1.sinks.k1.channel <span class="token operator">=</span> c1
</code></pre></div><h4 id="第四步-node01创建监听目录"><a href="#第四步-node01创建监听目录" class="header-anchor">#</a> 第四步：node01创建监听目录</h4> <div class="language- extra-class"><pre class="language-text"><code>mkdir /kkb/install/loadbalancer-dirfile 
</code></pre></div><h4 id="第五步-启动flume服务"><a href="#第五步-启动flume服务" class="header-anchor">#</a> 第五步：启动flume服务</h4> <p>启动node03的flume服务</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin

bin/flume-ng agent -n a1 -c conf -f conf/load_banlancer_server.conf -Dflume.root.logger=DEBUG,console
</code></pre></div><p>启动node02的flume服务</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin

bin/flume-ng agent -n a1 -c conf -f conf/load_banlancer_server.conf -Dflume.root.logger=DEBUG,console
</code></pre></div><p>启动node01的flume服务</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin

bin/flume-ng agent -n a1 -c conf -f conf/load_banlancer_client.conf -Dflume.root.logger=DEBUG,console
</code></pre></div><h4 id="第六步-往监听目录写入数据"><a href="#第六步-往监听目录写入数据" class="header-anchor">#</a> 第六步：往监听目录写入数据</h4> <p>因为使用logger sink的原因，从node01上采集的数据将不会被存放到hdfs等地方，但是会输出到屏幕中。</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>hadoop@node01 failover-dirfile<span class="token punctuation">]</span>$ <span class="token builtin class-name">cd</span> /kkb/install/loadbalancer-dirfile/
<span class="token punctuation">[</span>hadoop@node01 loadbalancer-dirfile<span class="token punctuation">]</span>$ <span class="token function">date</span> <span class="token operator">&gt;&gt;</span> LBTest.log
</code></pre></div><p>node02或者node03的屏幕会收到INFO级别信息：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token number">2020</span>-03-13 01:17:04,174 <span class="token punctuation">(</span>New I/O worker <span class="token comment">#1) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:387)] Avro source r1: Received avro event batch of 1 events.</span>
<span class="token number">2020</span>-03-13 01:17:07,060 <span class="token punctuation">(</span>SinkRunner-PollingRunner-DefaultSinkProcessor<span class="token punctuation">)</span> <span class="token punctuation">[</span>INFO - org.apache.flume.sink.LoggerSink.process<span class="token punctuation">(</span>LoggerSink.java:95<span class="token punctuation">)</span><span class="token punctuation">]</span> Event: <span class="token punctuation">{</span> headers:<span class="token punctuation">{</span><span class="token punctuation">}</span> body: <span class="token number">46</span> <span class="token number">72</span> <span class="token number">69</span> <span class="token number">20</span> 4D <span class="token number">61</span> <span class="token number">72</span> <span class="token number">20</span> <span class="token number">31</span> <span class="token number">33</span> <span class="token number">20</span> <span class="token number">30</span> <span class="token number">31</span> 3A <span class="token number">31</span> <span class="token number">37</span> Fri Mar <span class="token number">13</span> 01:17 <span class="token punctuation">}</span>
</code></pre></div><h4 id="注意事项"><a href="#注意事项" class="header-anchor">#</a> 注意事项</h4> <ol><li>使用负载均衡时，假设不使用logger sink的话，采集的数据不会全部存放到同一个文件中。比如从node01下沉到不同的机器（node02,node03)的数据，不会存放到一个文件，而是两个文件，node02/node03采集的数据分别对应一个文件。</li> <li>使用负载均衡时，日志数据的顺序会乱（因为存放到了不同文件）。</li> <li>使用负载均衡时，轮询机制并不是这条event使用node02采集，下一条event就一定会使用node03采集。而是每隔一段时间换node02采集，每隔一段时间又换node03来采集。</li> <li>在某台机器（比如node02)值班期间,node02宕机后，node01的flume就不会向node02发送数据了，转而向node03发送数据，因此使用load balancer负载均衡时，有着高可用的特性，避免丢失数据。</li> <li>zookeeper能不能使flume变聪明,及时发现宕机等情况，避免数据丢失？可以的。flume启动时向zk注册一个临时节点，flume宕机后，zk的临时节点就会消失，然后监听zk的flume节点有哪些，就往哪里发送数据</li> <li>一个文件或目录可以被多个flume agent监听。</li> <li>高可用和负载均衡不可同时使用</li></ol> <h2 id="flume实战案例8-静态拦截器使用"><a href="#flume实战案例8-静态拦截器使用" class="header-anchor">#</a> flume实战案例8：静态拦截器使用</h2> <h4 id="案例需求-8"><a href="#案例需求-8" class="header-anchor">#</a> 案例需求</h4> <p>A、B两台日志服务机器实时生产日志主要类型为access.log、nginx.log、web.log</p> <p>现在需要把A、B 机器中的access.log、nginx.log、web.log 采集汇总到C机器上然后统一收集到hdfs中。</p> <p>日志数据在hdfs中的存放目录要求为：</p> <ul><li><p>/source/logs/access/采集日期/**</p></li> <li><p>/source/logs/nginx/采集日期/**</p></li> <li><p>/source/logs/web/采集日期/**</p></li></ul> <p>从access.log采集的数据存放到路径：/source/logs/access/采集日期/</p> <p>从nginx.log采集的数据存放到路径：/source/logs/nginx/采集日期/</p> <p>从web.log采集的数据存放到路径：/source/logs/web/采集日期/</p> <img src="flume.assets/image-20200312230157343.png" alt="image-20200312230157343" style="zoom:67%;"> <h4 id="案例分析1"><a href="#案例分析1" class="header-anchor">#</a> 案例分析1</h4> <p>要存到采集的数据到对应的hdfs路径，那么怎么知道采集的数据来自哪个文件夹？是来自access.log还是nginx.log还是web.log?</p> <p>这时候就要用到拦截器了。首先来了解下拦截器。</p> <h4 id="深入了解拦截器"><a href="#深入了解拦截器" class="header-anchor">#</a> 深入了解拦截器</h4> <p>####### Flume Interceptors类型：</p> <ul><li><a href="http://flume.apache.org/FlumeUserGuide.html#timestamp-interceptor" target="_blank" rel="noopener noreferrer">Timestamp Interceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>时间戳拦截器</li> <li><a href="http://flume.apache.org/FlumeUserGuide.html#host-interceptor" target="_blank" rel="noopener noreferrer">Host Interceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>主机拦截器</li> <li><a href="http://flume.apache.org/FlumeUserGuide.html#static-interceptor" target="_blank" rel="noopener noreferrer">Static Interceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>静态拦截器</li> <li><a href="http://flume.apache.org/FlumeUserGuide.html#remove-header-interceptor" target="_blank" rel="noopener noreferrer">Remove Header Interceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://flume.apache.org/FlumeUserGuide.html#uuid-interceptor" target="_blank" rel="noopener noreferrer">UUID Interceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://flume.apache.org/FlumeUserGuide.html#morphline-interceptor" target="_blank" rel="noopener noreferrer">Morphline Interceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://flume.apache.org/FlumeUserGuide.html#search-and-replace-interceptor" target="_blank" rel="noopener noreferrer">Search and Replace Interceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://flume.apache.org/FlumeUserGuide.html#regex-filtering-interceptor" target="_blank" rel="noopener noreferrer">Regex Filtering Interceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://flume.apache.org/FlumeUserGuide.html#regex-extractor-interceptor" target="_blank" rel="noopener noreferrer">Regex Extractor Interceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>####### 我们来了解一下静态拦截器：</p> <p>静态拦截器功能：Static interceptor allows user to append a static header with static value to all events.为所有的event添加一个带有静态值的静态头部。</p> <p>静态拦截器的参数</p> <table><thead><tr><th style="text-align:left;">Property Name</th> <th style="text-align:left;">Default</th> <th style="text-align:left;">Description</th></tr></thead> <tbody><tr><td style="text-align:left;"><strong>type</strong></td> <td style="text-align:left;">–</td> <td style="text-align:left;">The component type name, has to be static</td></tr> <tr><td style="text-align:left;">preserveExisting</td> <td style="text-align:left;">true</td> <td style="text-align:left;">If configured header already exists, should it be preserved - true or false</td></tr> <tr><td style="text-align:left;">key</td> <td style="text-align:left;">key</td> <td style="text-align:left;">Name of header that should be created</td></tr> <tr><td style="text-align:left;">value</td> <td style="text-align:left;">value</td> <td style="text-align:left;">Static value that should be created</td></tr></tbody></table> <p>静态拦截器使用举例:Example for agent named a1:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>a1.sources <span class="token operator">=</span> r1
a1.channels <span class="token operator">=</span> c1
a1.sources.r1.channels <span class="token operator">=</span>  c1
a1.sources.r1.type <span class="token operator">=</span> <span class="token function">seq</span>
a1.sources.r1.interceptors <span class="token operator">=</span> i1
a1.sources.r1.interceptors.i1.type <span class="token operator">=</span> static
a1.sources.r1.interceptors.i1.key <span class="token operator">=</span> datacenter
a1.sources.r1.interceptors.i1.value <span class="token operator">=</span> NEW_YORK
</code></pre></div><p>在上面的example中，给source添加了拦截器。可以通过%{datacenter}获得值NEW_YORK。这样，每个event就会都有一个带有特定值value的header(key)，我们就可以判断采集的event来自哪个source，即哪个文件。</p> <p>在实际使用中，我们可以设定多个source，然后为每个source添加不同key,value的拦截器，我们就可以准确地将采集的数据存放到不同的目录中。</p> <h4 id="案例分析2"><a href="#案例分析2" class="header-anchor">#</a> 案例分析2</h4> <p>了解了拦截器后，我们就可以分配机器的角色了：</p> <img src="flume.assets/image-20200313092227112.png" alt="image-20200313092227112" style="zoom:67%;"> <h4 id="第一步-node01-02开发flume配置文件"><a href="#第一步-node01-02开发flume配置文件" class="header-anchor">#</a> 第一步：node01/02开发flume配置文件</h4> <p>node01与node02服务器开发同样的flume的配置文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf
<span class="token function">vim</span> intercepte1.conf
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## Name the components on this agent</span>
a1.sources <span class="token operator">=</span> r1 r2 r3
a1.sinks <span class="token operator">=</span> k1
a1.channels <span class="token operator">=</span> c1

<span class="token comment">## Describe source r1</span>
a1.sources.r1.type <span class="token operator">=</span> TAILDIR
a1.sources.r1.positionFile <span class="token operator">=</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/position1.json
a1.sources.r1.filegroups <span class="token operator">=</span> f1
a1.sources.r1.filegroups.f1 <span class="token operator">=</span> /kkb/install/logsFile/access.log
a1.sources.ri.maxBatchCount <span class="token operator">=</span> <span class="token number">1000</span>

a1.sources.r1.interceptors <span class="token operator">=</span> i1
a1.sources.r1.interceptors.i1.type <span class="token operator">=</span> static
a1.sources.r1.interceptors.i1.key <span class="token operator">=</span> <span class="token builtin class-name">type</span>
a1.sources.r1.interceptors.i1.value <span class="token operator">=</span> access

<span class="token comment">## Describe source r2</span>
a1.sources.r2.type <span class="token operator">=</span> TAILDIR
a1.sources.r2.positionFile <span class="token operator">=</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/position2.json
a1.sources.r2.filegroups <span class="token operator">=</span> f2
a1.sources.r2.filegroups.f2 <span class="token operator">=</span> /kkb/install/logsFile/nginx.log
a1.sources.r2.maxBatchCount <span class="token operator">=</span> <span class="token number">1000</span>

a1.sources.r2.interceptors <span class="token operator">=</span> i2
a1.sources.r2.interceptors.i2.type <span class="token operator">=</span> static
a1.sources.r2.interceptors.i2.key <span class="token operator">=</span> <span class="token builtin class-name">type</span>
a1.sources.r2.interceptors.i2.value <span class="token operator">=</span> nginx

<span class="token comment">## Describe source r3</span>
a1.sources.r3.type <span class="token operator">=</span> TAILDIR
a1.sources.r3.positionFile <span class="token operator">=</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/position3.json
a1.sources.r3.filegroups <span class="token operator">=</span> f3
a1.sources.r3.filegroups.f3 <span class="token operator">=</span> /kkb/install/logsFile/web.log
a1.sources.r3.maxBatchCount <span class="token operator">=</span> <span class="token number">1000</span>

a1.sources.r3.interceptors <span class="token operator">=</span> i3
a1.sources.r3.interceptors.i3.type <span class="token operator">=</span> static
a1.sources.r3.interceptors.i3.key <span class="token operator">=</span> <span class="token builtin class-name">type</span>
a1.sources.r3.interceptors.i3.value <span class="token operator">=</span> web

<span class="token comment">## Describe the sink</span>
a1.sinks.k1.type <span class="token operator">=</span> avro
a1.sinks.k1.hostname <span class="token operator">=</span> node03
a1.sinks.k1.port <span class="token operator">=</span> <span class="token number">41414</span>

<span class="token comment">## Use a channel which buffers events in memory</span>
a1.channels.c1.type <span class="token operator">=</span> memory
a1.channels.c1.capacity <span class="token operator">=</span> <span class="token number">20000</span>
a1.channels.c1.transactionCapacity <span class="token operator">=</span> <span class="token number">10000</span>

<span class="token comment">## Bind the source and sink to the channel</span>
a1.sources.r1.channels <span class="token operator">=</span> c1
a1.sources.r2.channels <span class="token operator">=</span> c1
a1.sources.r3.channels <span class="token operator">=</span> c1
a1.sinks.k1.channel <span class="token operator">=</span> c1
</code></pre></div><h4 id="第二步-node03开发flume配置文件"><a href="#第二步-node03开发flume配置文件" class="header-anchor">#</a> 第二步：node03开发flume配置文件</h4> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf

vim intercept2.conf
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>a1.sources <span class="token operator">=</span> r1
a1.sinks <span class="token operator">=</span> k1
a1.channels <span class="token operator">=</span> c1

<span class="token comment">#定义source</span>
a1.sources.r1.type <span class="token operator">=</span> avro
a1.sources.r1.bind <span class="token operator">=</span> <span class="token number">192.168</span>.52.103
a1.sources.r1.port <span class="token operator">=</span><span class="token number">41414</span>

<span class="token comment">#添加时间拦截器</span>
a1.sources.r1.interceptors <span class="token operator">=</span> i1
a1.sources.r1.interceptors.i1.type <span class="token operator">=</span> org.apache.flume.interceptor.TimestampInterceptor<span class="token variable">$Builder</span>

<span class="token comment">#定义channels</span>
a1.channels.c1.type <span class="token operator">=</span> memory
a1.channels.c1.capacity <span class="token operator">=</span> <span class="token number">20000</span>
a1.channels.c1.transactionCapacity <span class="token operator">=</span> <span class="token number">10000</span>

<span class="token comment">#定义sink</span>
a1.sinks.k1.type <span class="token operator">=</span> hdfs
a1.sinks.k1.hdfs.path<span class="token operator">=</span>hdfs://node01:8020/source/logs/%<span class="token punctuation">{</span>type<span class="token punctuation">}</span>/%Y%m%d
a1.sinks.k1.hdfs.filePrefix <span class="token operator">=</span>events
a1.sinks.k1.hdfs.fileType <span class="token operator">=</span> DataStream
a1.sinks.k1.hdfs.writeFormat <span class="token operator">=</span> Text
<span class="token comment">#时间类型</span>
a1.sinks.k1.hdfs.useLocalTimeStamp <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token comment">#生成的文件不按条数生成</span>
a1.sinks.k1.hdfs.rollCount <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">#生成的文件按时间生成</span>
a1.sinks.k1.hdfs.rollInterval <span class="token operator">=</span> <span class="token number">30</span>
<span class="token comment">#生成的文件按大小生成</span>
a1.sinks.k1.hdfs.rollSize <span class="token operator">=</span> <span class="token number">10485760</span>
<span class="token comment">#批量写入hdfs的个数</span>
a1.sinks.k1.hdfs.batchSize <span class="token operator">=</span> <span class="token number">10000</span>
<span class="token comment">#flume操作hdfs的线程数（包括新建，写入等）</span>
a1.sinks.k1.hdfs.threadsPoolSize<span class="token operator">=</span><span class="token number">10</span>
<span class="token comment">#操作hdfs超时时间</span>
a1.sinks.k1.hdfs.callTimeout<span class="token operator">=</span><span class="token number">30000</span>

<span class="token comment">#组装source、channel、sink</span>
a1.sources.r1.channels <span class="token operator">=</span> c1
a1.sinks.k1.channel <span class="token operator">=</span> c1
</code></pre></div><p>注意：hdfs://node01:8020/source/logs/%{type}/%Y%m%d，这是实现案例功能的关键理解点，%{type}获取不同的值，从而实现数据分类存放。</p> <h4 id="第三步-node01-02创建监听目录"><a href="#第三步-node01-02创建监听目录" class="header-anchor">#</a> 第三步：node01/02创建监听目录</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">mkdir</span> /kkb/install/logsFile
</code></pre></div><h4 id="第四步-顺序启动服务"><a href="#第四步-顺序启动服务" class="header-anchor">#</a> 第四步：顺序启动服务</h4> <p>node03启动flume实现数据收集</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin
bin/flume-ng agent -c conf -f conf/intercept2.conf -name a1 -Dflume.root.logger=DEBUG,console
</code></pre></div><p>node01与node02启动flume实现数据监控</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin
bin/flume-ng agent -c conf -f conf/intercepte1.conf -name a1 -Dflume.root.logger=DEBUG,console
</code></pre></div><h4 id="第五步-往监听目录写数据"><a href="#第五步-往监听目录写数据" class="header-anchor">#</a> 第五步：往监听目录写数据</h4> <p>在node01与node02上面开发shell脚本，模拟数据生成</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/shells
vim addLogData.sh 
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token shebang important">#!/bin/bash</span>

<span class="token keyword">while</span> <span class="token boolean">true</span>
<span class="token keyword">do</span> 
<span class="token function">hostname</span> <span class="token operator">&gt;&gt;</span> /kkb/install/logsFile/access.log<span class="token punctuation">;</span>
<span class="token function">hostname</span> <span class="token operator">&gt;&gt;</span> /kkb/install/logsFile/web.log<span class="token punctuation">;</span>
<span class="token function">hostname</span> <span class="token operator">&gt;&gt;</span> /kkb/install/logsFile/nginx.log<span class="token punctuation">;</span>
<span class="token function">sh</span>
<span class="token function">sleep</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
<span class="token keyword">done</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sh</span> addLogData.sh 
</code></pre></div><h2 id="flume实战案例9-自定义拦截器"><a href="#flume实战案例9-自定义拦截器" class="header-anchor">#</a> flume实战案例9：自定义拦截器</h2> <h4 id="案例需求-9"><a href="#案例需求-9" class="header-anchor">#</a> 案例需求：</h4> <p>在数据采集之后，通过flume的拦截器，实现不需要的数据过滤掉，并将指定的第一个字段进行加密，加密之后再往hdfs上面保存</p> <p><strong>原始数据文件user.txt</strong></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token number">13901007610</span>,male,30,sing,beijing
<span class="token number">18600000035</span>,male,40,dance,shanghai
<span class="token number">13366666659</span>,male,20,Swimming,wuhan
<span class="token number">13801179888</span>,female,18,dance,tianjin
<span class="token number">18511111114</span>,male,35,sing,beijing
<span class="token number">13718428888</span>,female,40,Foodie,shanghai
<span class="token number">13901057088</span>,male,50,Basketball,taiwan
<span class="token number">13671057777</span>,male,60,Bodybuilding,xianggang
</code></pre></div><p><strong>处理前后的数据对比：</strong></p> <p><img src="/assets/img/clip_image032.5bef2444.png" alt="img"></p> <h4 id="第一步-创建maven工程"><a href="#第一步-创建maven工程" class="header-anchor">#</a> 第一步：创建maven工程</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repositories</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>cloudera<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://repository.cloudera.com/artifactory/cloudera-repos/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repositories</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flume<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flume-ng-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.6.0-cdh5.14.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoding</span><span class="token punctuation">&gt;</span></span>
          <span class="token comment">&lt;!--  &lt;verbal&gt;true&lt;/verbal&gt;--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-shade-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>shade<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filters</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">&gt;</span></span>
                   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifact</span><span class="token punctuation">&gt;</span></span>*:*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifact</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>META-INF/*.SF<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>META-INF/*.DSA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>META-INF/*.RSA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filters</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transformers</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transformer</span> <span class="token attr-name">implementation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.apache.maven.plugins.shade.resource.ManifestResourceTransformer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mainClass</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mainClass</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transformer</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transformers</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span> 
</code></pre></div><h4 id="第二步-自定义flume的拦截器"><a href="#第二步-自定义flume的拦截器" class="header-anchor">#</a> 第二步：自定义flume的拦截器</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>jimmy<span class="token punctuation">.</span>day01</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>base<span class="token punctuation">.</span></span><span class="token class-name">Charsets</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span></span><span class="token class-name">Context</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span></span><span class="token class-name">Event</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span></span><span class="token class-name">Interceptor</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigInteger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">MessageDigest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">{</span>
    <span class="token comment">//指定需要加密的字段的index</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> encrypted_field_index<span class="token punctuation">;</span>
    <span class="token comment">//指定需要删除的字段的index</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> out_index<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">MyInterceptor</span><span class="token punctuation">(</span><span class="token class-name">String</span> encrypted_field_index<span class="token punctuation">,</span><span class="token class-name">String</span> out_index<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>encrypted_field_index<span class="token operator">=</span>encrypted_field_index<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>out_index<span class="token operator">=</span>out_index<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token comment">//定义单个event拦截逻辑:</span>

    <span class="token keyword">public</span> <span class="token class-name">Event</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//判断event是否为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取event的body,event.getBody()返回的是一个字节数组</span>
            <span class="token class-name">String</span> line <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Charsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//获取字段的数组</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//初始化处理后的newline为&quot;&quot;</span>
            <span class="token class-name">String</span> newline <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
            <span class="token comment">//循环遍历字段的数组，根据需求对某些字段进行处理</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> fields<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//13901007610,male,30,sing,beijing</span>
                <span class="token keyword">int</span> encryptedField <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>encrypted_field_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> outField <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>out_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> encryptedField<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    newline <span class="token operator">=</span> newline<span class="token operator">+</span><span class="token function">md5</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> outField<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    newline <span class="token operator">=</span> newline <span class="token operator">+</span> fields<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            newline<span class="token operator">=</span>newline<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>newline<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            event<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>newline<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">Charsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> event<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> event<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//定义批量event的拦截逻辑:</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> mylist<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Event</span> e<span class="token operator">:</span>events<span class="token punctuation">)</span><span class="token punctuation">{</span> 
            <span class="token comment">//特别注意上面的循环条件，写的是events，不是mylist,当初就因为这里不成功很多次。</span>
            <span class="token comment">//调用上面定义的单个event的拦截方法</span>
            <span class="token class-name">Event</span> e1<span class="token operator">=</span><span class="token function">intercept</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>e1<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                mylist<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>e1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mylist<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token comment">//定义一个Builder类，用于返回一个新的MyInterceptor对象</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyBuilder</span> <span class="token keyword">implements</span> <span class="token class-name">Interceptor<span class="token punctuation">.</span>Builder</span><span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> encrypted_field_index<span class="token punctuation">;</span>
        <span class="token comment">//指定需要删除的字段的index</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> out_index<span class="token punctuation">;</span>


        <span class="token keyword">public</span> <span class="token class-name">Interceptor</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyInterceptor</span><span class="token punctuation">(</span>encrypted_field_index<span class="token punctuation">,</span>out_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>encrypted_field_index<span class="token operator">=</span>context<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;encrypted_field_index&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>out_index<span class="token operator">=</span>context<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;out_index&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//定义md5加密算法</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token class-name">String</span> plainText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//定义一个字节数组</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> secretBytes <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 生成一个MD5加密计算摘要</span>
            <span class="token class-name">MessageDigest</span> md <span class="token operator">=</span> <span class="token class-name">MessageDigest</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;MD5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//对字符串进行加密</span>
            md<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>plainText<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//获得加密后的数据</span>
            secretBytes <span class="token operator">=</span> md<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchAlgorithmException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;没有md5这个算法！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//将加密后的数据转换为16进制数字</span>
        <span class="token class-name">String</span> md5code <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> secretBytes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 16进制数字</span>
        <span class="token comment">// 如果生成数字未满32位，需要前面补0</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">32</span> <span class="token operator">-</span> md5code<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            md5code <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span> <span class="token operator">+</span> md5code<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> md5code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h4 id="第三步-打包jar包"><a href="#第三步-打包jar包" class="header-anchor">#</a> 第三步：打包jar包</h4> <p>将我们的拦截器代码打成jar包放到flume的lib目录下</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>hadoop@node03 lib<span class="token punctuation">]</span>$ rz
rz waiting to receive.
Starting zmodem transfer.  Press Ctrl+C to cancel.
Transferring original-MyIntercept-1.0-SNAPSHOT.jar<span class="token punctuation">..</span>.
  <span class="token number">100</span>%       <span class="token number">4</span> KB       <span class="token number">4</span> KB/sec    00:00:01       <span class="token number">0</span> Errors 
</code></pre></div><h4 id="第四步-node03开发flume配置文件-3"><a href="#第四步-node03开发flume配置文件-3" class="header-anchor">#</a> 第四步：node03开发flume配置文件</h4> <p>node03开发flume的配置文件</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf

vim testIc.conf
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## Name the components on this agent</span>
a1.sources <span class="token operator">=</span> r1
a1.sinks <span class="token operator">=</span> k1
a1.channels <span class="token operator">=</span> c1

<span class="token comment">#配置source</span>
a1.sources.r1.type <span class="token operator">=</span> TAILDIR
a1.sources.r1.positionFile <span class="token operator">=</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/userP.json
a1.sources.r1.filegroups <span class="token operator">=</span> f1
a1.sources.r1.filegroups.f1 <span class="token operator">=</span> /kkb/install/flumeData/user.txt
a1.sources.ri.maxBatchCount <span class="token operator">=</span> <span class="token number">1000</span>

a1.sources.r1.channels <span class="token operator">=</span> c1
a1.sources.r1.interceptors <span class="token operator">=</span>i1
a1.sources.r1.interceptors.i1.type <span class="token operator">=</span>com.jimmy.day01.MyInterceptor<span class="token variable">$MyBuilder</span>
a1.sources.r1.interceptors.i1.encrypted_field_index<span class="token operator">=</span><span class="token number">0</span>
a1.sources.r1.interceptors.i1.out_index<span class="token operator">=</span><span class="token number">3</span>

<span class="token comment">#配置channel</span>
a1.channels.c1.type <span class="token operator">=</span> memory
a1.channels.c1.capacity <span class="token operator">=</span> <span class="token number">1000</span>
a1.channels.c1.transactionCapacity <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment">#配置sink</span>
a1.sinks.k1.type <span class="token operator">=</span> hdfs
a1.sinks.k1.channel <span class="token operator">=</span> c1
a1.sinks.k1.hdfs.path <span class="token operator">=</span> hdfs://node01:8020/CTM/%Y-%m-%d/%H%M
a1.sinks.k1.hdfs.filePrefix <span class="token operator">=</span> events-
a1.sinks.k1.hdfs.round <span class="token operator">=</span> <span class="token boolean">true</span>
a1.sinks.k1.hdfs.roundValue <span class="token operator">=</span> <span class="token number">10</span>
a1.sinks.k1.hdfs.roundUnit <span class="token operator">=</span> minute
a1.sinks.k1.hdfs.rollInterval <span class="token operator">=</span> <span class="token number">5</span>
a1.sinks.k1.hdfs.rollSize <span class="token operator">=</span> <span class="token number">50</span>
a1.sinks.k1.hdfs.rollCount <span class="token operator">=</span> <span class="token number">10</span>
a1.sinks.k1.hdfs.batchSize <span class="token operator">=</span> <span class="token number">100</span>
a1.sinks.k1.hdfs.useLocalTimeStamp <span class="token operator">=</span> <span class="token boolean">true</span>

<span class="token comment">#生成的文件类型，默认是Sequencefile，可用DataStream，则为普通文本</span>
a1.sinks.k1.hdfs.fileType <span class="token operator">=</span> DataStream
</code></pre></div><h4 id="第五步-创建监听目录"><a href="#第五步-创建监听目录" class="header-anchor">#</a> 第五步：创建监听目录</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">mkdir</span> /kkb/install/flumeData/
</code></pre></div><h4 id="第六步-启动flume"><a href="#第六步-启动flume" class="header-anchor">#</a> 第六步：启动flume</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin

bin/flume-ng agent -c conf -f conf/testIc.conf -name a1 -Dflume.root.logger<span class="token operator">=</span>DEBUG,console
</code></pre></div><h4 id="第七步-上传测试数据"><a href="#第七步-上传测试数据" class="header-anchor">#</a> 第七步：上传测试数据</h4> <p>测试数据如下</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/flumeData
<span class="token function">vim</span> user.txt
<span class="token number">13901007610</span>,male,30,sing,beijing
<span class="token number">18600000035</span>,male,40,dance,shanghai
<span class="token number">13366666659</span>,male,20,Swimming,wuhan
<span class="token number">13801179888</span>,female,18,dance,tianjin
<span class="token number">18511111114</span>,male,35,sing,beijing
<span class="token number">13718428888</span>,female,40,Foodie,shanghai
<span class="token number">13901057088</span>,male,50,Basketball,taiwan
<span class="token number">13671057777</span>,male,60,Bodybuilding,xianggang
</code></pre></div><p>查看hfds的数据，格式如下，手机号被加密了，而且第四列被删掉了。</p> <div class="language- extra-class"><pre class="language-text"><code>4333811059aa47e54a474f29e61665f7,male,30,beijing
</code></pre></div><h2 id="flume实战案例10-自定义source"><a href="#flume实战案例10-自定义source" class="header-anchor">#</a> flume实战案例10：自定义source</h2> <p>官方提供的source类型已经很多，但是有时候并不能满足实际开发当中的需求，此时我们就需要根据实际需求自定义某些source。如：实时监控MySQL，从MySQL中获取数据传输到HDFS或者其他存储框架，所以此时需要我们自己实现MySQLSource。</p> <p>官方也提供了自定义source的接口：</p> <p>官网说明：https://flume.apache.org/FlumeDeveloperGuide.html#source</p> <h4 id="案例需求-10"><a href="#案例需求-10" class="header-anchor">#</a> 案例需求：</h4> <p>自定义flume的source，实现从mysql数据库当中获取数据，并将数据打印到控制台上面来</p> <h4 id="案例分析-6"><a href="#案例分析-6" class="header-anchor">#</a> 案例分析：</h4> <p>思考问题：</p> <ol><li>每隔多长时间采集数据库表的数据一次？--&gt;自己定义</li> <li>全表采集，还是记录上一次采集位置，下次接着采集？--&gt;使用记录的方式</li></ol> <img src="flume.assets/image-20200314010004629.png" alt="image-20200314010004629" style="zoom:80%;"> <p>指导思想：</p> <ol><li>第一步：使用jdbc去查询mysql的数据库，查询meta表</li> <li>第二步：通过meta表获取到id的值</li> <li>第三步：通过id的值去查询student表</li> <li>第四步：将查询的数据放到channel里面去</li> <li>第五步：更新meta表</li></ol> <p>官网的自定义source example如下:</p> <p>从下面的example可知，自定义mysqlsource需要继承AbstractSource类并实现Configurable和PollableSource接口。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySource</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSource</span> <span class="token keyword">implements</span> <span class="token class-name">Configurable</span><span class="token punctuation">,</span> <span class="token class-name">PollableSource</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> myProp<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> myProp <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;myProp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;defaultValue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Process the myProp value (e.g. validation, convert to another type, ...)</span>

    <span class="token comment">// Store myProp for later retrieval by process() method</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>myProp <span class="token operator">=</span> myProp<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Initialize the connection to the external client</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> stop <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Disconnect from external client and do any additional cleanup</span>
    <span class="token comment">// (e.g. releasing resources or nulling-out field values) ..</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Status</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">EventDeliveryException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Status</span> status <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// This try clause includes whatever Channel/Event operations you want to do</span>

      <span class="token comment">// Receive new data</span>
      <span class="token class-name">Event</span> e <span class="token operator">=</span> <span class="token function">getSomeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Store the Event into this Source's associated Channel(s)</span>
      <span class="token function">getChannelProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">processEvent</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

      status <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>READY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Log exception, handle individual exceptions as needed</span>

      status <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>BACKOFF<span class="token punctuation">;</span>

      <span class="token comment">// re-throw all Errors</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">)</span>t<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      txn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> status<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="第一步-创建mysql数据库表"><a href="#第一步-创建mysql数据库表" class="header-anchor">#</a> 第一步：创建mysql数据库表</h4> <p>在node03启动mysql，密码是123456</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>hadoop@node03 ~<span class="token punctuation">]</span>$ mysql -u root -p
<span class="token comment">## 123456</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">--创建一个数据库</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> mysqlsource <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token punctuation">;</span>

<span class="token comment">--创建一个表，用户保存拉取目标表位置的信息</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mysqlsource<span class="token punctuation">.</span>flume_meta <span class="token punctuation">(</span>
    source_tab <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    currentIndex <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>source_tab<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token comment">--插入数据</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> mysqlsource<span class="token punctuation">.</span>flume_meta<span class="token punctuation">(</span>source_tab<span class="token punctuation">,</span>currentIndex<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'student'</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">--创建要拉取数据的表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mysqlsource<span class="token punctuation">.</span>student<span class="token punctuation">(</span>
    id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">5</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token comment">--向student表中添加测试数据</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> mysqlsource<span class="token punctuation">.</span>student<span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'zhangsan'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'lisi'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'wangwu'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'zhaoliu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mysqlsource<span class="token punctuation">.</span>student<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+----------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> zhangsan <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> lisi     <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> wangwu   <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> zhaoliu  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+</span>
</code></pre></div><h4 id="第二步-创建maven工程"><a href="#第二步-创建maven工程" class="header-anchor">#</a> 第二步：创建maven工程</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repositories</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>cloudera<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://repository.cloudera.com/artifactory/cloudera-repos/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repositories</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flume<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flume-ng-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.6.0-cdh5.14.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.38<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-lang3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoding</span><span class="token punctuation">&gt;</span></span>
                    <span class="token comment">&lt;!--  &lt;verbal&gt;true&lt;/verbal&gt;--&gt;</span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-shade-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>shade<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filters</span><span class="token punctuation">&gt;</span></span>
                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">&gt;</span></span>
                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifact</span><span class="token punctuation">&gt;</span></span>*:*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifact</span><span class="token punctuation">&gt;</span></span>
                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">&gt;</span></span>
                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>META-INF/*.SF<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>META-INF/*.DSA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>META-INF/*.RSA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">&gt;</span></span>
                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filters</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transformers</span><span class="token punctuation">&gt;</span></span>
                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transformer</span> <span class="token attr-name">implementation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.apache.maven.plugins.shade.resource.ManifestResourceTransformer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mainClass</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mainClass</span><span class="token punctuation">&gt;</span></span>
                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transformer</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transformers</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="第三步-添加配置文件"><a href="#第三步-添加配置文件" class="header-anchor">#</a> 第三步：添加配置文件</h4> <p>在我们工程的resources目录下，添加jdbc.properties</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">dbDriver</span><span class="token operator">=</span>com.mysql.jdbc.Driver
<span class="token assign-left variable">dbUrl</span><span class="token operator">=</span>jdbc:mysql://node03:3306/mysqlsource?useUnicode<span class="token operator">=</span>true<span class="token operator">&amp;</span><span class="token assign-left variable">characterEncoding</span><span class="token operator">=</span>utf-8
<span class="token assign-left variable">dbUser</span><span class="token operator">=</span>root
<span class="token assign-left variable">dbPassword</span><span class="token operator">=</span><span class="token number">123456</span>
</code></pre></div><img src="flume.assets/image-20200314000055952.png" alt="image-20200314000055952" style="zoom:67%;"> <p><img src="/assets/img/image-20200314000139384.445b828d.png" alt="image-20200314000139384"></p> <h4 id="第四步-定义查询mysql的工具类"><a href="#第四步-定义查询mysql的工具类" class="header-anchor">#</a> 第四步：定义查询mysql的工具类</h4> <p>这个工具类提供了很多的查询方式。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>jimmy<span class="token punctuation">.</span>day01</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span></span><span class="token class-name">Context</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">ParseException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryMysql</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> LOG <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">QueryMysql</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> runQueryDelay<span class="token punctuation">,</span>   <span class="token comment">//两次查询的时间间隔</span>
            startFrom<span class="token punctuation">,</span>            <span class="token comment">//开始id</span>
            currentIndex<span class="token punctuation">,</span>       <span class="token comment">//当前id</span>
            recordSixe <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token comment">//每次查询返回结果的条数</span>
            maxRow<span class="token punctuation">;</span>                <span class="token comment">//每次查询的最大条数</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> table<span class="token punctuation">,</span>          <span class="token comment">//要操作的表</span>
            columnsToSelect<span class="token punctuation">,</span>       <span class="token comment">//用户传入的查询的列</span>
            customQuery<span class="token punctuation">,</span>          <span class="token comment">//用户传入的查询语句</span>
            query<span class="token punctuation">,</span>                 <span class="token comment">//构建的查询语句</span>
            defaultCharsetResultSet<span class="token punctuation">;</span><span class="token comment">//编码集</span>

    <span class="token comment">//上下文，用来获取配置文件</span>
    <span class="token keyword">private</span> <span class="token class-name">Context</span> context<span class="token punctuation">;</span>

    <span class="token comment">//为定义的变量赋值（默认值），可在flume任务的配置文件中修改</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_QUERY_DELAY <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_START_VALUE <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_MAX_ROWS <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DEFAULT_COLUMNS_SELECT <span class="token operator">=</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DEFAULT_CHARSET_RESULTSET <span class="token operator">=</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">PreparedStatement</span> ps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> connectionURL<span class="token punctuation">,</span> connectionUserName<span class="token punctuation">,</span> connectionPassword<span class="token punctuation">;</span>

    <span class="token comment">//加载静态资源</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">Properties</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            p<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">QueryMysql</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc.properties&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            connectionURL <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;dbUrl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            connectionUserName <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;dbUser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            connectionPassword <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;dbPassword&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;dbDriver&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//获取JDBC连接</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token class-name">InitConnection</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token class-name">String</span> user<span class="token punctuation">,</span> <span class="token class-name">String</span> pw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pw<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SQLException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> conn<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//构造方法</span>
    <span class="token class-name">QueryMysql</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token comment">//初始化上下文</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>

        <span class="token comment">//有默认值参数：获取flume任务配置文件中的参数，读不到的采用默认值</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>columnsToSelect <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;columns.to.select&quot;</span><span class="token punctuation">,</span> DEFAULT_COLUMNS_SELECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>runQueryDelay <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token string">&quot;run.query.delay&quot;</span><span class="token punctuation">,</span> DEFAULT_QUERY_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>startFrom <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token string">&quot;start.from&quot;</span><span class="token punctuation">,</span> DEFAULT_START_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultCharsetResultSet <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;default.charset.resultset&quot;</span><span class="token punctuation">,</span> DEFAULT_CHARSET_RESULTSET<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//无默认值参数：获取flume任务配置文件中的参数</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>table <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;table&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>customQuery <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;custom.query&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        connectionURL <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;connection.url&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionUserName <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;connection.user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionPassword <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;connection.password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conn <span class="token operator">=</span> <span class="token class-name">InitConnection</span><span class="token punctuation">(</span>connectionURL<span class="token punctuation">,</span> connectionUserName<span class="token punctuation">,</span> connectionPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//校验相应的配置信息，如果没有默认值的参数也没赋值，抛出异常</span>
        <span class="token function">checkMandatoryProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取当前的id</span>
        currentIndex <span class="token operator">=</span> <span class="token function">getStatusDBIndex</span><span class="token punctuation">(</span>startFrom<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//构建查询语句</span>
        query <span class="token operator">=</span> <span class="token function">buildQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//校验相应的配置信息（表，查询语句以及数据库连接的参数）</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkMandatoryProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>table <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationException</span><span class="token punctuation">(</span><span class="token string">&quot;property table not set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionURL <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationException</span><span class="token punctuation">(</span><span class="token string">&quot;connection.url property not set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionUserName <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationException</span><span class="token punctuation">(</span><span class="token string">&quot;connection.user property not set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionPassword <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationException</span><span class="token punctuation">(</span><span class="token string">&quot;connection.password property not set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//构建sql语句</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">buildQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">//获取当前id</span>
        currentIndex <span class="token operator">=</span> <span class="token function">getStatusDBIndex</span><span class="token punctuation">(</span>startFrom<span class="token punctuation">)</span><span class="token punctuation">;</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>currentIndex <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>customQuery <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sql <span class="token operator">=</span> <span class="token string">&quot;SELECT &quot;</span> <span class="token operator">+</span> columnsToSelect <span class="token operator">+</span> <span class="token string">&quot; FROM &quot;</span> <span class="token operator">+</span> table<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            sql <span class="token operator">=</span> customQuery<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">StringBuilder</span> execSql <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//以id作为offset</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sql<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;where&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            execSql<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; where &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            execSql<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>currentIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> execSql<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> length <span class="token operator">=</span> execSql<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> execSql<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">-</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>currentIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> currentIndex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//执行查询</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//每次执行查询时都要重新生成sql，因为id不同</span>
            customQuery <span class="token operator">=</span> <span class="token function">buildQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//存放结果的集合</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ps <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//初始化PrepareStatement对象</span>
                ps <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>customQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">ResultSet</span> result <span class="token operator">=</span> ps<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span>customQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//存放一条数据的集合（多个列）</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> row <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//将返回结果放入集合</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> result<span class="token punctuation">.</span><span class="token function">getMetaData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getColumnCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    row<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                results<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;execSql:&quot;</span> <span class="token operator">+</span> customQuery <span class="token operator">+</span> <span class="token string">&quot;\nresultSize:&quot;</span> <span class="token operator">+</span> results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> results<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 重新连接</span>
            conn <span class="token operator">=</span> <span class="token class-name">InitConnection</span><span class="token punctuation">(</span>connectionURL<span class="token punctuation">,</span> connectionUserName<span class="token punctuation">,</span> connectionPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//将结果集转化为字符串，每一条数据是一个list集合，将每一个小的list集合转化为字符串</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllRows</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> queryResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> allRows <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>queryResult <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> queryResult<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> allRows<span class="token punctuation">;</span>
        <span class="token class-name">StringBuilder</span> row <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> rawRow <span class="token operator">:</span> queryResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> aRawRow <span class="token operator">:</span> rawRow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                value <span class="token operator">=</span> aRawRow<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    row<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    row<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>aRawRow<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            allRows<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>row<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            row <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> allRows<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//更新offset元数据状态，每次返回结果集后调用。必须记录每次查询的offset值，为程序中断续跑数据时使用，以id为offset</span>
    <span class="token keyword">void</span> <span class="token function">updateOffset2DB</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//以source_tab做为KEY，如果不存在则插入，存在则更新（每个源表对应一条记录）</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;insert into flume_meta(source_tab,currentIndex) VALUES('&quot;</span>
                <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>table
                <span class="token operator">+</span> <span class="token string">&quot;','&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>recordSixe <span class="token operator">+=</span> size<span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token string">&quot;') on DUPLICATE key update source_tab=values(source_tab),currentIndex=values(currentIndex)&quot;</span><span class="token punctuation">;</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;updateStatus Sql:&quot;</span> <span class="token operator">+</span> sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">execSql</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//执行sql语句</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">execSql</span><span class="token punctuation">(</span><span class="token class-name">String</span> sql<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            ps <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;exec::&quot;</span> <span class="token operator">+</span> sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ps<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//获取当前id的offset</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> <span class="token function">getStatusDBIndex</span><span class="token punctuation">(</span><span class="token keyword">int</span> startFrom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//从flume_meta表中查询出当前的id是多少</span>
        <span class="token class-name">String</span> dbIndex <span class="token operator">=</span> <span class="token function">queryOne</span><span class="token punctuation">(</span><span class="token string">&quot;select currentIndex from flume_meta where source_tab='&quot;</span> <span class="token operator">+</span> table <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dbIndex <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>dbIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果没有数据，则说明是第一次查询或者数据表中还没有存入数据，返回最初传入的值</span>
        <span class="token keyword">return</span> startFrom<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//查询一条数据的执行语句(当前id)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">queryOne</span><span class="token punctuation">(</span><span class="token class-name">String</span> sql<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ResultSet</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            ps <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> ps<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//关闭相关资源</span>
    <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            ps<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            conn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> <span class="token function">getCurrentIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> currentIndex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">setCurrentIndex</span><span class="token punctuation">(</span><span class="token keyword">int</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        currentIndex <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> <span class="token function">getRunQueryDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> runQueryDelay<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">String</span> <span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> query<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">String</span> <span class="token function">getConnectionURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> connectionURL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isCustomQuerySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>customQuery <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Context</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> context<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getConnectionUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> connectionUserName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getConnectionPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> connectionPassword<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">String</span> <span class="token function">getDefaultCharsetResultSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> defaultCharsetResultSet<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="第五步-自定义mysqlsource类"><a href="#第五步-自定义mysqlsource类" class="header-anchor">#</a> 第五步：自定义mysqlSource类</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>jimmy<span class="token punctuation">.</span>day01</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span></span><span class="token class-name">Context</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span></span><span class="token class-name">Event</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span></span><span class="token class-name">EventDeliveryException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span></span><span class="token class-name">PollableSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span><span class="token class-name">Configurable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>event<span class="token punctuation">.</span></span><span class="token class-name">SimpleEvent</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span><span class="token class-name">AbstractSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">ParseException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySqlSource</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSource</span> <span class="token keyword">implements</span> <span class="token class-name">Configurable</span><span class="token punctuation">,</span> <span class="token class-name">PollableSource</span> <span class="token punctuation">{</span>

    <span class="token comment">//打印日志</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> LOG <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">MySqlSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//定义sqlHelper</span>
    <span class="token keyword">private</span> <span class="token class-name">QueryMysql</span> sqlSourceHelper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getBackOffSleepIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getMaxBackOffSleepInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//初始化</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            sqlSourceHelper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryMysql</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 接受mysql表中的数据
     *
     * @return
     * @throws EventDeliveryException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PollableSource<span class="token punctuation">.</span>Status</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">EventDeliveryException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//查询数据表</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> sqlSourceHelper<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//存放event的集合</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> events <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//存放event头集合</span>
            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> header <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果有返回数据，则将数据封装为event</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> allRows <span class="token operator">=</span> sqlSourceHelper<span class="token punctuation">.</span><span class="token function">getAllRows</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Event</span> event <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> row <span class="token operator">:</span> allRows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    event<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>row<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    event<span class="token punctuation">.</span><span class="token function">setHeaders</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    events<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//将event写入channel</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getChannelProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">processEventBatch</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//更新数据表中的offset信息</span>
                sqlSourceHelper<span class="token punctuation">.</span><span class="token function">updateOffset2DB</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//等待时长</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>sqlSourceHelper<span class="token punctuation">.</span><span class="token function">getRunQueryDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>READY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error procesing row&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>BACKOFF<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Stopping sql source {} ...&quot;</span><span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//关闭资源</span>
            sqlSourceHelper<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="第六步-打包jar包"><a href="#第六步-打包jar包" class="header-anchor">#</a> 第六步：打包jar包</h4> <p>将我们开发的代码，打成jar包上传到flume的lib目录下</p> <h4 id="第七步-开发flume的配置文件"><a href="#第七步-开发flume的配置文件" class="header-anchor">#</a> 第七步：开发flume的配置文件</h4> <p>开发flume的配置文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf

<span class="token function">vim</span> mysqlsource.conf
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## Name the components on this agent</span>
a1.sources<span class="token operator">=</span>r1
a1.sinks<span class="token operator">=</span>k1
a1.channels<span class="token operator">=</span>c1

<span class="token comment">## Describe/configure the source</span>
a1.sources.r1.type<span class="token operator">=</span>com.kaikeba.source.MySqlSource
a1.sources.r1.connection.url<span class="token operator">=</span>jdbc:mysql://node03:3306/mysqlsource
a1.sources.r1.connection.user<span class="token operator">=</span>root
a1.sources.r1.connection.password<span class="token operator">=</span><span class="token number">123456</span>
a1.sources.r1.table<span class="token operator">=</span>student
a1.sources.r1.columns.to.select<span class="token operator">=</span>*
a1.sources.r1.start.from<span class="token operator">=</span><span class="token number">0</span>
a1.sources.r1.run.query.delay<span class="token operator">=</span><span class="token number">3000</span>

<span class="token comment">## Describe the channel</span>
a1.channels.c1.type<span class="token operator">=</span>memory
a1.channels.c1.capacity<span class="token operator">=</span><span class="token number">1000</span>
a1.channels.c1.transactionCapacity<span class="token operator">=</span><span class="token number">100</span>

<span class="token comment">## Describe the sink</span>
a1.sinks.k1.type<span class="token operator">=</span>logger

<span class="token comment">## Bind the source and sink to the channel</span>
a1.sources.r1.channels<span class="token operator">=</span>c1 
a1.sinks.k1.channel<span class="token operator">=</span>c1         
</code></pre></div><h4 id="第八步-启动flume"><a href="#第八步-启动flume" class="header-anchor">#</a> 第八步：启动flume</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin

bin/flume-ng agent -n a1 -c conf -f conf/mysqlsource.conf -Dflume.root.logger<span class="token operator">=</span>info,console
</code></pre></div><p>启动flume时，因为数据库表mysqlsource.student中一开始有4条数据，因此下一次采集数据的时候是使用selece * from student where id&gt;4来进行查询采集。</p> <p><img src="/assets/img/image-20200314004017869.c6309919.png" alt="image-20200314004017869"></p> <h4 id="第九步-再次为数据库表插入数据"><a href="#第九步-再次为数据库表插入数据" class="header-anchor">#</a> 第九步：再次为数据库表插入数据</h4> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">insert</span> <span class="token keyword">into</span> mysqlsource<span class="token punctuation">.</span>student <span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&quot;rose&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>再次插入一条数据是，id最大值变成了5,因此下一次采集数据的时候是使用selece * from student where id&gt;5来进行查询采集。</p> <p><img src="/assets/img/image-20200314004337737.3768b5b3.png" alt="image-20200314004337737"></p> <h4 id="第十步-查看meta表"><a href="#第十步-查看meta表" class="header-anchor">#</a> 第十步：查看meta表</h4> <p>启动flume时，就生成了flume_meta表，flume_meta表记录了上一次采集的位置。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>mysql<span class="token operator">&gt;</span> show tables<span class="token punctuation">;</span>
+-----------------------+
<span class="token operator">|</span> Tables_in_mysqlsource <span class="token operator">|</span>
+-----------------------+
<span class="token operator">|</span> flume_meta            <span class="token operator">|</span>
<span class="token operator">|</span> student               <span class="token operator">|</span>
+-----------------------+
<span class="token number">2</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from flume_meta<span class="token punctuation">;</span>
+------------+--------------+
<span class="token operator">|</span> source_tab <span class="token operator">|</span> currentIndex <span class="token operator">|</span>
+------------+--------------+
<span class="token operator">|</span> student    <span class="token operator">|</span> <span class="token number">5</span>            <span class="token operator">|</span>
+------------+--------------+
</code></pre></div><h4 id="注意"><a href="#注意" class="header-anchor">#</a> 注意</h4> <p>我们该案例采集数据库表的数据时，不是使用全表采集策略，而是使用记录上次采集的位置，然后下次接着该位置采集的策略，这个策略有个很大的弊端，就是：</p> <p>如果已经采集过的数据，被进行了修改，那么我们采集到文件系统的数据就有部分是不正确的，过时的。</p> <p>这时候我们就需要改用其它工具了，如sqoop，用sqoop可以很好的解决这个问题，sqoop是一个导入导出数据的工具。</p> <h2 id="flume面试题2"><a href="#flume面试题2" class="header-anchor">#</a> flume面试题2</h2> <ul><li>flume可不可以做到事务性？</li></ul> <p>可以的，在哪来做，在sink里面做，因为sink涉及到保存操作。</p> <p>怎么做，自定义sink来实现就行了</p> <p>flume自带的sink不可实现事务性</p> <ul><li>实际工作当中fluem的jvm的堆内存给了多大？</li></ul> <p>4 - 8G 左右</p> <ul><li>如何设置堆内存？</li></ul> <p>vim flume-env.sh</p> <p>export JAVA_OPTS=&quot;-Xms4096m -Xmx4096m -Dcom.sun.management.jmxremote&quot;</p> <h2 id="flume实战案例11-自定义sink-todo"><a href="#flume实战案例11-自定义sink-todo" class="header-anchor">#</a> flume实战案例11：自定义sink（TODO）</h2> <h4 id="案例需求-11"><a href="#案例需求-11" class="header-anchor">#</a> 案例需求</h4> <p>官方提供的sink类型已经很多，但是有时候并不能满足实际开发当中的需求，此时我们就需要根据实际需求自定义某些sink。如：需要把接受到的数据按照规则进行过滤之后写入到某张mysql表中，所以此时需要我们自己实现MySQLSink。</p> <p>官方也提供了自定义sink的接口：</p> <p>官网说明：https://flume.apache.org/FlumeDeveloperGuide.html#sink</p> <h4 id="案例分析-7"><a href="#案例分析-7" class="header-anchor">#</a> 案例分析</h4> <p>根据官方说明自定义MysqlSink需要继承AbstractSink类并实现Configurable</p> <p>指导思想：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>自定义sink   extends  <span class="token constant">AbstractSource</span>
将接受到的数据，通过自定义sink，写入到mysql表当中去
从channel里面获取数据，获取到了数据之后，写入到mysql里面去
第一步：从channel里面去获取数据
第二步：打开jdbc连接
第三步：保存数据
第四步：关闭连接
</code></pre></div><h4 id="第一步-创建mysql数据库表-2"><a href="#第一步-创建mysql数据库表-2" class="header-anchor">#</a> 第一步：创建mysql数据库表</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 创建一个数据库</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> mysqlsource <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token punctuation">;</span>
<span class="token keyword">USE</span> mysqlsource<span class="token punctuation">;</span>
<span class="token comment">-- 创建一个表，用户保存拉取目标表位置的信息</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mysqlsource<span class="token punctuation">.</span>flume2mysql <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    createTime <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    content <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre></div><h4 id="第二步-定义mysqlsink类"><a href="#第二步-定义mysqlsink类" class="header-anchor">#</a> 第二步：定义mysqlSink类</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>jimmy<span class="token punctuation">.</span>day01</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span><span class="token class-name">Configurable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flume<span class="token punctuation">.</span>sink<span class="token punctuation">.</span></span><span class="token class-name">AbstractSink</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">DriverManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">PreparedStatement</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 自定义MysqlSink
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MysqlSink</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSink</span> <span class="token keyword">implements</span> <span class="token class-name">Configurable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mysqlurl <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> tableName <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

    <span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Status</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Status</span> status <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// Start transaction</span>
        <span class="token class-name">Channel</span> ch <span class="token operator">=</span> <span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Transaction</span> txn <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">getTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        txn<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">Event</span> event <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                    <span class="token comment">//获取body中的数据</span>
                    <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//如果日志中有以下关键字的不需要保存，过滤掉</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;delete&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> body<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;drop&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> body<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;alert&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    status <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>BACKOFF<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>

                    <span class="token comment">//存入Mysql</span>
                    <span class="token class-name">SimpleDateFormat</span> df <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> createtime <span class="token operator">=</span> df<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">PreparedStatement</span> stmt <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">&quot;insert into &quot;</span> <span class="token operator">+</span> tableName <span class="token operator">+</span> <span class="token string">&quot; (createtime, content) values (?, ?)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    stmt<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> createtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    stmt<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    stmt<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    stmt<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    status <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>READY<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
           <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                    status <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>BACKOFF<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            txn<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span><span class="token punctuation">{</span>
            txn<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            t<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            status <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token punctuation">.</span>BACKOFF<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span><span class="token punctuation">{</span>
            txn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 获取配置文件中指定的参数
     * @param context
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mysqlurl <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;mysqlurl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        username <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        password <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tableName <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;tablename&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
              <span class="token comment">//初始化数据库连接</span>
            con <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>mysqlurl<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;finish start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span><span class="token punctuation">{</span>
            ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            con<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h4 id="第三步-打包jar包-2"><a href="#第三步-打包jar包-2" class="header-anchor">#</a> 第三步：打包jar包</h4> <p>将我们的代码打成jar包上传到flume的lib目录下</p> <h4 id="第四步-开发flume的配置文件"><a href="#第四步-开发flume的配置文件" class="header-anchor">#</a> 第四步：开发flume的配置文件</h4> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin/conf

vim mysqlsink.conf
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>a1.sources <span class="token operator">=</span> r1
a1.sinks <span class="token operator">=</span> k1
a1.channels <span class="token operator">=</span> c1
<span class="token comment">#配置source</span>
a1.sources.r1.type <span class="token operator">=</span> <span class="token builtin class-name">exec</span>
a1.sources.r1.command <span class="token operator">=</span> <span class="token function">tail</span> -F /kkb/install/flumeData/data.log
a1.sources.r1.channels <span class="token operator">=</span> c1

<span class="token comment">#配置channel</span>
a1.channels.c1.type <span class="token operator">=</span> memory
a1.channels.c1.capacity <span class="token operator">=</span> <span class="token number">1000</span>
a1.channels.c1.transactionCapacity <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment">#配置sink</span>
a1.sinks.k1.channel <span class="token operator">=</span> c1
a1.sinks.k1.type <span class="token operator">=</span> com.kaikeba.sink.MysqlSink
a1.sinks.k1.mysqlurl<span class="token operator">=</span>jdbc:mysql://node03:3306/mysqlsource?useSSL<span class="token operator">=</span>false
a1.sinks.k1.username<span class="token operator">=</span>root
a1.sinks.k1.password<span class="token operator">=</span><span class="token number">123456</span>
a1.sinks.k1.tablename<span class="token operator">=</span>flume2mysql
</code></pre></div><h4 id="第五步-启动flume"><a href="#第五步-启动flume" class="header-anchor">#</a> 第五步：启动flume</h4> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/apache-flume-1.6.0-cdh5.14.2-bin

bin/flume-ng agent -n a1 -c conf -f conf/mysqlsink.conf -Dflume.root.logger=info,console
</code></pre></div><h4 id="第六步-创建文件验证数据进入mysql"><a href="#第六步-创建文件验证数据进入mysql" class="header-anchor">#</a> 第六步：创建文件验证数据进入mysql</h4> <p>创建文件，验证数据进入mysql数据库</p> <div class="language- extra-class"><pre class="language-text"><code>mkdir -p /kkb/install/flumeData

echo &quot;helloworld&quot; &gt;&gt; /kkb/install/flumeData/data.log
</code></pre></div><h2 id="flume使用注意说明"><a href="#flume使用注意说明" class="header-anchor">#</a> flume使用注意说明</h2> <h4 id="注意启动脚本命名的书写"><a href="#注意启动脚本命名的书写" class="header-anchor">#</a> 注意启动脚本命名的书写</h4> <p>agent 的名称别写错了，后台执行加上 nohup ... &amp;</p> <h4 id="channel参数"><a href="#channel参数" class="header-anchor">#</a> channel参数</h4> <p>capacity：默认该通道中最大的可以存储的event数量</p> <p>trasactionCapacity：channel每次最大可以从source中拿到或者送到sink中的event数量</p> <p>注意：capacity &gt; trasactionCapacity</p> <h4 id="日志采集到hdfs配置说明1-sink端"><a href="#日志采集到hdfs配置说明1-sink端" class="header-anchor">#</a> 日志采集到HDFS配置说明1（sink端）</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#定义sink</span>
 a1.sinks.k1.type <span class="token operator">=</span> hdfs
 a1.sinks.k1.hdfs.path<span class="token operator">=</span>hdfs://node01:8020/source/logs/%<span class="token punctuation">{</span>type<span class="token punctuation">}</span>/%Y%m%d
 a1.sinks.k1.hdfs.filePrefix <span class="token operator">=</span>events
 a1.sinks.k1.hdfs.fileType <span class="token operator">=</span> DataStream
 a1.sinks.k1.hdfs.writeFormat <span class="token operator">=</span> Text
 <span class="token comment">#时间类型</span>
 a1.sinks.k1.hdfs.useLocalTimeStamp <span class="token operator">=</span> <span class="token boolean">true</span>
 <span class="token comment">#生成的文件不按条数生成</span>
 a1.sinks.k1.hdfs.rollCount <span class="token operator">=</span> <span class="token number">0</span>
 <span class="token comment">#生成的文件按时间生成</span>
 a1.sinks.k1.hdfs.rollInterval <span class="token operator">=</span> <span class="token number">0</span>
 <span class="token comment">#生成的文件按大小生成</span>
 a1.sinks.k1.hdfs.rollSize <span class="token operator">=</span> <span class="token number">10485760</span>
 <span class="token comment">#批量写入hdfs的个数</span>
 a1.sinks.k1.hdfs.batchSize <span class="token operator">=</span> <span class="token number">10000</span>
 <span class="token comment">#flume操作hdfs的线程数（包括新建，写入等）</span>
 a1.sinks.k1.hdfs.threadsPoolSize<span class="token operator">=</span><span class="token number">10</span>
 <span class="token comment">#操作hdfs超时时间</span>
 a1.sinks.k1.hdfs.callTimeout<span class="token operator">=</span><span class="token number">30000</span>
</code></pre></div><h4 id="日志采集到hdfs配置说明2-sink端"><a href="#日志采集到hdfs配置说明2-sink端" class="header-anchor">#</a> 日志采集到HDFS配置说明2（sink端）</h4> <table><thead><tr><th><strong>hdfs.round</strong></th> <th><strong>false</strong></th> <th><strong>Should the timestamp be rounded down (if true, affects all time based   escape sequences except %t)</strong></th></tr></thead> <tbody><tr><td>hdfs.roundValue</td> <td>1</td> <td>Rounded down to the highest multiple of this (in the  unit configured usinghdfs.roundUnit), less than current time.</td></tr> <tr><td>hdfs.roundUnit</td> <td>second</td> <td>The unit of the  round down value - second, minute or hour.</td></tr></tbody></table> <ul><li><p>round： 默认值：false 是否启用时间上的”舍弃”，这里的”舍弃”，类似于”四舍五入”</p></li> <li><p>roundValue：默认值：1 时间上进行“舍弃”的值；</p></li> <li><p>roundUnit： 默认值：seconds时间上进行”舍弃”的单位，包含：second,minute,hour</p></li></ul> <p><strong>案例一：</strong></p> <div class="language-ruby extra-class"><pre class="language-ruby"><code> a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token operator">/</span>flume<span class="token operator">/</span>events<span class="token operator">/</span><span class="token operator">%</span><span class="token constant">Y</span><span class="token operator">-</span><span class="token operator">%</span>m<span class="token operator">-</span><span class="token operator">%</span>d<span class="token operator">/</span><span class="token operator">%</span><span class="token constant">H</span><span class="token punctuation">:</span><span class="token operator">%</span><span class="token constant">M</span><span class="token operator">/</span><span class="token operator">%</span><span class="token constant">S</span>
 a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>round <span class="token operator">=</span> <span class="token boolean">true</span>
 a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>roundValue <span class="token operator">=</span> <span class="token number">10</span>
 a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>roundUnit <span class="token operator">=</span> minute
</code></pre></div><p>当时间为2015-10-16 17:38:59时候，hdfs.path依然会被解析为：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code> <span class="token operator">/</span>flume<span class="token operator">/</span>events<span class="token operator">/</span><span class="token number">2015</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">16</span><span class="token operator">/</span><span class="token number">17</span><span class="token punctuation">:</span><span class="token number">30</span><span class="token operator">/</span><span class="token number">00</span>
 <span class="token operator">/</span>flume<span class="token operator">/</span>events<span class="token operator">/</span><span class="token number">2015</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">16</span><span class="token operator">/</span><span class="token number">17</span><span class="token punctuation">:</span><span class="token number">40</span><span class="token operator">/</span><span class="token number">00</span>
 <span class="token operator">/</span>flume<span class="token operator">/</span>events<span class="token operator">/</span><span class="token number">2015</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">16</span><span class="token operator">/</span><span class="token number">17</span><span class="token punctuation">:</span><span class="token number">50</span><span class="token operator">/</span><span class="token number">00</span>
</code></pre></div><p>因为设置的是舍弃10分钟内的时间，因此，该目录每10分钟新生成一个。</p> <p><strong>案例二：</strong></p> <div class="language-ruby extra-class"><pre class="language-ruby"><code> a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token operator">/</span>flume<span class="token operator">/</span>events<span class="token operator">/</span><span class="token operator">%</span><span class="token constant">Y</span><span class="token operator">-</span><span class="token operator">%</span>m<span class="token operator">-</span><span class="token operator">%</span>d<span class="token operator">/</span><span class="token operator">%</span><span class="token constant">H</span><span class="token punctuation">:</span><span class="token operator">%</span><span class="token constant">M</span><span class="token operator">/</span><span class="token operator">%</span><span class="token constant">S</span>
 a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>round <span class="token operator">=</span> <span class="token boolean">true</span>
 a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>roundValue <span class="token operator">=</span> <span class="token number">10</span>
 a1<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span>k1<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>roundUnit <span class="token operator">=</span> second
</code></pre></div><p>现象：10秒为时间梯度生成对应的目录，目录下面包括很多小文件！！！格式如下：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code> <span class="token operator">/</span>flume<span class="token operator">/</span>events<span class="token operator">/</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span><span class="token operator">/</span><span class="token number">18</span><span class="token punctuation">:</span><span class="token number">45</span><span class="token operator">/</span><span class="token number">10</span>
 <span class="token operator">/</span>flume<span class="token operator">/</span>events<span class="token operator">/</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span><span class="token operator">/</span><span class="token number">18</span><span class="token punctuation">:</span><span class="token number">45</span><span class="token operator">/</span><span class="token number">20</span>
 <span class="token operator">/</span>flume<span class="token operator">/</span>events<span class="token operator">/</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span><span class="token operator">/</span><span class="token number">18</span><span class="token punctuation">:</span><span class="token number">45</span><span class="token operator">/</span><span class="token number">30</span>
 <span class="token operator">/</span>flume<span class="token operator">/</span>events<span class="token operator">/</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span><span class="token operator">/</span><span class="token number">18</span><span class="token punctuation">:</span><span class="token number">45</span><span class="token operator">/</span><span class="token number">40</span>
 <span class="token operator">/</span>flume<span class="token operator">/</span>events<span class="token operator">/</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span><span class="token operator">/</span><span class="token number">18</span><span class="token punctuation">:</span><span class="token number">45</span><span class="token operator">/</span><span class="token number">50</span>
 <span class="token operator">/</span>flume<span class="token operator">/</span>events<span class="token operator">/</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span><span class="token operator">/</span><span class="token number">18</span><span class="token punctuation">:</span><span class="token number">46</span><span class="token operator">/</span><span class="token number">10</span>
 <span class="token operator">/</span>flume<span class="token operator">/</span>events<span class="token operator">/</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span><span class="token operator">/</span><span class="token number">18</span><span class="token punctuation">:</span><span class="token number">46</span><span class="token operator">/</span><span class="token number">20</span>
 <span class="token operator">/</span>flume<span class="token operator">/</span>events<span class="token operator">/</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span><span class="token operator">/</span><span class="token number">18</span><span class="token punctuation">:</span><span class="token number">46</span><span class="token operator">/</span><span class="token number">30</span>
 <span class="token operator">/</span>flume<span class="token operator">/</span>events<span class="token operator">/</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span><span class="token operator">/</span><span class="token number">18</span><span class="token punctuation">:</span><span class="token number">46</span><span class="token operator">/</span><span class="token number">40</span>
 <span class="token operator">/</span>flume<span class="token operator">/</span>events<span class="token operator">/</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span><span class="token operator">/</span><span class="token number">18</span><span class="token punctuation">:</span><span class="token number">46</span><span class="token operator">/</span><span class="token number">50</span>
</code></pre></div><h4 id="实现数据的断点续传"><a href="#实现数据的断点续传" class="header-anchor">#</a> 实现数据的断点续传</h4> <p>断点续传：当一个flume挂掉之后重启的时候还是可以接着上一次的数据继续收集</p> <p>flume在1.7版本之前使用的监控一个文件（source exec）、监控一个目录（source spooldir）都无法直接实现，flume在1.7版本之后已经集成了该功能，其本质就是记录下每一次消费的位置，把消费信息的位置保存到文件中，后续程序挂掉了再重启的时候，可以接着上一次消费的数据位置继续拉取。</p> <p>example:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>a1.channels <span class="token operator">=</span> ch1
a1.sources <span class="token operator">=</span> s1
a1.sinks <span class="token operator">=</span> hdfs-sink1
 
 <span class="token comment">#channel</span>
 a1.channels.ch1.type <span class="token operator">=</span> memory
 a1.channels.ch1.capacity<span class="token operator">=</span><span class="token number">10000</span>
 a1.channels.ch1.transactionCapacity<span class="token operator">=</span><span class="token number">500</span>
 
 <span class="token comment">#source</span>
 a1.sources.s1.channels <span class="token operator">=</span> ch1
 <span class="token comment">#监控一个目录下的多个文件新增的内容</span>
 a1.sources.s1.type <span class="token operator">=</span> taildir
 
 <span class="token comment">#通过 json 格式存下每个文件消费的偏移量，避免从头消费</span>
 a1.sources.s1.positionFile <span class="token operator">=</span> /kkb/install/flumeData/index/taildir_position.json
 a1.sources.s1.filegroups <span class="token operator">=</span> f1 f2 f3 
 a1.sources.s1.filegroups.f1 <span class="token operator">=</span> /home/hadoop/taillogs/access.log
 a1.sources.s1.filegroups.f2 <span class="token operator">=</span> /home/hadoop/taillogs/nginx.log
 a1.sources.s1.filegroups.f3 <span class="token operator">=</span> /home/hadoop/taillogs/web.log
 a1.sources.s1.headers.f1.headerKey <span class="token operator">=</span> access
 a1.sources.s1.headers.f2.headerKey <span class="token operator">=</span> nginx
 a1.sources.s1.headers.f3.headerKey <span class="token operator">=</span> web
 a1.sources.s1.fileHeader <span class="token operator">=</span> <span class="token boolean">true</span>
 
 <span class="token comment">#sink</span>
 a1.sinks.hdfs-sink1.channel <span class="token operator">=</span> ch1
 a1.sinks.hdfs-sink1.type <span class="token operator">=</span> hdfs
 a1.sinks.hdfs-sink1.hdfs.path <span class="token operator">=</span>hdfs://node01:8020/demo/data/%<span class="token punctuation">{</span>headerKey<span class="token punctuation">}</span>
 a1.sinks.hdfs-sink1.hdfs.filePrefix <span class="token operator">=</span> event_data
 a1.sinks.hdfs-sink1.hdfs.fileSuffix <span class="token operator">=</span> .log
 a1.sinks.hdfs-sink1.hdfs.rollSize <span class="token operator">=</span> <span class="token number">1048576</span>
 a1.sinks.hdfs-sink1.hdfs.rollInterval <span class="token operator">=</span><span class="token number">20</span>
 a1.sinks.hdfs-sink1.hdfs.rollCount <span class="token operator">=</span> <span class="token number">10</span>
 a1.sinks.hdfs-sink1.hdfs.batchSize <span class="token operator">=</span> <span class="token number">1500</span>
 a1.sinks.hdfs-sink1.hdfs.round <span class="token operator">=</span> <span class="token boolean">true</span>
 a1.sinks.hdfs-sink1.hdfs.roundUnit <span class="token operator">=</span> minute
 a1.sinks.hdfs-sink1.hdfs.threadsPoolSize <span class="token operator">=</span> <span class="token number">25</span>
 a1.sinks.hdfs-sink1.hdfs.fileType <span class="token operator">=</span>DataStream
 a1.sinks.hdfs-sink1.hdfs.writeFormat <span class="token operator">=</span> Text
 a1.sinks.hdfs-sink1.hdfs.callTimeout <span class="token operator">=</span> <span class="token number">60000</span>
</code></pre></div><p>运行后生成的 taildir_position.json文件信息如下：</p> <div class="language-json extra-class"><pre class="language-json"><code> <span class="token punctuation">[</span>
 <span class="token punctuation">{</span><span class="token property">&quot;inode&quot;</span><span class="token operator">:</span><span class="token number">102626782</span><span class="token punctuation">,</span><span class="token property">&quot;pos&quot;</span><span class="token operator">:</span><span class="token number">123</span><span class="token punctuation">,</span><span class="token property">&quot;file&quot;</span><span class="token operator">:</span><span class="token string">&quot;/home/hadoop/taillogs/access.log&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;inode&quot;</span><span class="token operator">:</span><span class="token number">102626785</span><span class="token punctuation">,</span><span class="token property">&quot;pos&quot;</span><span class="token operator">:</span><span class="token number">123</span><span class="token punctuation">,</span><span class="token property">&quot;file&quot;</span><span class="token operator">:</span><span class="token string">&quot;/home/hadoop/taillogs/web.log&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;inode&quot;</span><span class="token operator">:</span><span class="token number">102626786</span><span class="token punctuation">,</span><span class="token property">&quot;pos&quot;</span><span class="token operator">:</span><span class="token number">123</span><span class="token punctuation">,</span><span class="token property">&quot;file&quot;</span><span class="token operator">:</span><span class="token string">&quot;/home/hadoop/taillogs/nginx.log&quot;</span><span class="token punctuation">}</span>
 <span class="token punctuation">]</span>
</code></pre></div><p>这里inode就是标记文件的，文件名称改变，这个iNode不会变，pos记录偏移量，file就是绝对路径</p> <h4 id="flume的header参数配置讲解"><a href="#flume的header参数配置讲解" class="header-anchor">#</a> flume的header参数配置讲解</h4> <p>o  vim test-header.conf</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">#配置信息test-header.conf</span>
 a1.channels<span class="token operator">=</span>c1
 a1.sources<span class="token operator">=</span>r1
 a1.sinks<span class="token operator">=</span>k1
 
 <span class="token comment">#source</span>
 a1.sources.r1.channels<span class="token operator">=</span>c1
 a1.sources.r1.type<span class="token operator">=</span> spooldir
 a1.sources.r1.spoolDir<span class="token operator">=</span> /home/hadoop/test
 a1.sources.r1.batchSize<span class="token operator">=</span> <span class="token number">100</span>
 a1.sources.r1.inputCharset<span class="token operator">=</span> UTF-8
 
 <span class="token comment">#是否添加一个key,来存储目录下文件的绝对路径</span>
 a1.sources.r1.fileHeader<span class="token operator">=</span> <span class="token boolean">true</span>
 <span class="token comment">#指定存储目录下文件的绝对路径的key</span>
 a1.sources.r1.fileHeaderKey<span class="token operator">=</span> mm
 <span class="token comment">#是否添加一个key，来存储目录下的文件名称</span>
 a1.sources.r1.basenameHeader<span class="token operator">=</span> <span class="token boolean">true</span>
 <span class="token comment">#指定存储目录下文件的名称的key</span>
 a1.sources.r1.basenameHeaderKey<span class="token operator">=</span> nn
 
 <span class="token comment">#channel</span>
 a1.channels.c1.type<span class="token operator">=</span> memory
 a1.channels.c1.capacity<span class="token operator">=</span><span class="token number">10000</span>
 a1.channels.c1.transactionCapacity<span class="token operator">=</span><span class="token number">500</span>
 
 <span class="token comment">#sink</span>
 a1.sinks.k1.type<span class="token operator">=</span>logger
 a1.sinks.k1.channel<span class="token operator">=</span>c1
</code></pre></div><p>准备数据文件，添加内容</p> <div class="language-sh extra-class"><pre class="language-sh"><code>/home/hadoop/test/abc.txt
/home/hadoop/test/def.txt
</code></pre></div><p>启动flume配置</p> <div class="language-sh extra-class"><pre class="language-sh"><code>bin/flume-ng agent -n a1 -c myconf -f myconf/test-header.conf -Dflume.root.logger<span class="token operator">=</span>info,console
</code></pre></div><p>查看控制台</p> <div class="language-sh extra-class"><pre class="language-sh"><code>Event: <span class="token punctuation">{</span> headers:<span class="token punctuation">{</span>mm<span class="token operator">=</span>/home/hadoop/test/abc.txt, <span class="token assign-left variable">nn</span><span class="token operator">=</span>abc.txt<span class="token punctuation">}</span> body: <span class="token number">68</span> <span class="token number">65</span> 6C 6C 6F <span class="token number">20</span> <span class="token number">73</span> <span class="token number">70</span> <span class="token number">61</span> <span class="token number">72</span> 6B        hello spark <span class="token punctuation">}</span>
 <span class="token number">19</span>/08/30 <span class="token number">19</span>:23:15 INFO sink.LoggerSink: Event: <span class="token punctuation">{</span> headers:<span class="token punctuation">{</span>mm<span class="token operator">=</span>/home/hadoop/test/abc.txt, <span class="token assign-left variable">nn</span><span class="token operator">=</span>abc.txt<span class="token punctuation">}</span> body: <span class="token number">68</span> <span class="token number">65</span> 6C 6C 6F <span class="token number">20</span> <span class="token number">68</span> <span class="token number">61</span> <span class="token number">64</span> 6F 6F <span class="token number">70</span>       hello hadoop <span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MaLunan/press/edit/dev-mln/docs/flume/flume.md" target="_blank" rel="noopener noreferrer">在GitHub 上编辑此页！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">1/19/2021, 1:41:59 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fdd7a502.js" defer></script><script src="/assets/js/16.375b747e.js" defer></script><script src="/assets/js/21.0c1e826b.js" defer></script>
  </body>
</html>
