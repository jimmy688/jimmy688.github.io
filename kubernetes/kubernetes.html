<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>kubernetes的介绍 | 个人博客 | JiiiiG</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="自是年少，韶华倾负">
    
    <link rel="preload" href="/assets/css/0.styles.420b7c1f.css" as="style"><link rel="preload" href="/assets/js/app.fdd7a502.js" as="script"><link rel="preload" href="/assets/js/16.375b747e.js" as="script"><link rel="preload" href="/assets/js/29.775019f1.js" as="script"><link rel="prefetch" href="/assets/js/10.bbd38b9e.js"><link rel="prefetch" href="/assets/js/11.f49fc7d3.js"><link rel="prefetch" href="/assets/js/12.c5d97aa1.js"><link rel="prefetch" href="/assets/js/13.426d0224.js"><link rel="prefetch" href="/assets/js/14.1f257a58.js"><link rel="prefetch" href="/assets/js/15.be29bb6a.js"><link rel="prefetch" href="/assets/js/17.d02cdd8b.js"><link rel="prefetch" href="/assets/js/18.5d2371a4.js"><link rel="prefetch" href="/assets/js/19.038919a3.js"><link rel="prefetch" href="/assets/js/2.d6257727.js"><link rel="prefetch" href="/assets/js/20.b3582e09.js"><link rel="prefetch" href="/assets/js/21.0c1e826b.js"><link rel="prefetch" href="/assets/js/22.91bff1a5.js"><link rel="prefetch" href="/assets/js/23.faacea60.js"><link rel="prefetch" href="/assets/js/24.69816497.js"><link rel="prefetch" href="/assets/js/25.c9fcaa62.js"><link rel="prefetch" href="/assets/js/26.d28c3abe.js"><link rel="prefetch" href="/assets/js/27.1518da7d.js"><link rel="prefetch" href="/assets/js/28.748a5581.js"><link rel="prefetch" href="/assets/js/3.141002a4.js"><link rel="prefetch" href="/assets/js/30.74e7c570.js"><link rel="prefetch" href="/assets/js/31.190b11f2.js"><link rel="prefetch" href="/assets/js/32.d8f4f116.js"><link rel="prefetch" href="/assets/js/33.c489bc81.js"><link rel="prefetch" href="/assets/js/34.db609d51.js"><link rel="prefetch" href="/assets/js/35.ad3402e6.js"><link rel="prefetch" href="/assets/js/36.45f11923.js"><link rel="prefetch" href="/assets/js/37.b47e0576.js"><link rel="prefetch" href="/assets/js/38.58b934a2.js"><link rel="prefetch" href="/assets/js/39.e4d6bcdf.js"><link rel="prefetch" href="/assets/js/4.e9b44388.js"><link rel="prefetch" href="/assets/js/40.555106bc.js"><link rel="prefetch" href="/assets/js/41.4387ceb1.js"><link rel="prefetch" href="/assets/js/42.9bd4aea0.js"><link rel="prefetch" href="/assets/js/43.587e7966.js"><link rel="prefetch" href="/assets/js/44.80285763.js"><link rel="prefetch" href="/assets/js/45.f978da77.js"><link rel="prefetch" href="/assets/js/46.d93e3f2e.js"><link rel="prefetch" href="/assets/js/47.c15bd2aa.js"><link rel="prefetch" href="/assets/js/48.cb55fa72.js"><link rel="prefetch" href="/assets/js/49.d0f4e454.js"><link rel="prefetch" href="/assets/js/5.b90b80cb.js"><link rel="prefetch" href="/assets/js/50.112e8260.js"><link rel="prefetch" href="/assets/js/51.a66bcd03.js"><link rel="prefetch" href="/assets/js/52.0c7cbfb1.js"><link rel="prefetch" href="/assets/js/53.67ef240b.js"><link rel="prefetch" href="/assets/js/54.2c2d082d.js"><link rel="prefetch" href="/assets/js/55.88f19a20.js"><link rel="prefetch" href="/assets/js/56.c726e920.js"><link rel="prefetch" href="/assets/js/57.eaee47c5.js"><link rel="prefetch" href="/assets/js/58.ac15a3ac.js"><link rel="prefetch" href="/assets/js/59.64bdc849.js"><link rel="prefetch" href="/assets/js/6.7eea74ff.js"><link rel="prefetch" href="/assets/js/7.a1370e98.js"><link rel="prefetch" href="/assets/js/8.2e898240.js"><link rel="prefetch" href="/assets/js/9.a2439994.js">
    <link rel="stylesheet" href="/assets/css/0.styles.420b7c1f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">个人博客 | JiiiiG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/linux/linux常用命令/01linux常用命令01.html" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/hadoop/01hadoop环境搭建/01搭建hadoop集群.html" class="nav-link">
  hadoop
</a></li><li class="dropdown-item"><!----> <a href="/hbase/hbase.html" class="nav-link">
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/flink/flink.html" class="nav-link">
  flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/kubernetes/.html" class="nav-link">
  java
</a></li></ul></div></div> <a href="https://github.com/MaLunan/press" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/linux/linux常用命令/01linux常用命令01.html" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/hadoop/01hadoop环境搭建/01搭建hadoop集群.html" class="nav-link">
  hadoop
</a></li><li class="dropdown-item"><!----> <a href="/hbase/hbase.html" class="nav-link">
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/flink/flink.html" class="nav-link">
  flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/kubernetes/.html" class="nav-link">
  java
</a></li></ul></div></div> <a href="https://github.com/MaLunan/press" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="kubernetes的介绍"><a href="#kubernetes的介绍" class="header-anchor">#</a> kubernetes的介绍</h2> <p>学习链接：</p> <ul><li>尚硅谷kubernetes教程：https://pan.baidu.com/s/1U6-AXHj5gsDsAHSXeoKnRg 提取码：tdpk</li> <li>https://jimmysong.io/kubernetes-handbook/concepts/</li> <li>https://www.kubernetes.org.cn/k8s</li> <li>https://kuboard.cn/learning/</li></ul> <p>Kubernetes是一个可以移植、可扩展的开源平台，使用 <a href="https://kuboard.cn/learning/k8s-intermediate/workload/wl-deployment/#deployment-%E6%A6%82%E8%BF%B0" target="_blank" rel="noopener noreferrer">声明式的配置<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 并依据配置信息自动地执行容器化应用程序的管理。在所有的<strong>容器编排工具</strong>中（类似的还有 docker swarm / mesos等），Kubernetes的生态系统更大、增长更快，<strong>有更多的支持、服务和工具</strong>可供用户选择。</p> <p>kubernetes起源于希腊，是领航员、舵手的意思。Google于2014年将Borg系统开源为Kubernetes。Kubernetes构建在Google <strong>Borg</strong> <a href="https://ai.google/research/pubs/pub43438" target="_blank" rel="noopener noreferrer">十五年运行大规模分布式系统的经验 (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>基础之上，并结合了开源社区最好的想法和实践。</p> <p><strong>部署应用程序的方式</strong></p> <p><img src="/assets/img/container_evolution.cb55fb19.cb55fb19.svg" alt="Kubernetes教程_部署方式演化"></p> <p>传统部署时代：企业直接将应用程序部署在物理机上。由于物理机上不能为应用程序定义资源使用边界，我们也就很难合理地分配计算资源</p> <p>虚拟化部署时代：用户可以在单台物理机的CPU上运行多个虚拟机（Virtual Machine）。</p> <ul><li>虚拟化技术使得应用程序被虚拟机相互分隔开，限制了应用程序之间的非法访问，进而提供了一定程度的安全性。</li> <li>虚拟化技术提高了物理机的资源利用率，可以更容易地安装或更新应用程序，降低了硬件成本，因此可以更好地规模化实施。</li></ul> <p>容器化部署时代：容器与虚拟机类似，但是降低了隔离层级，共享了操作系统。因此，容器可以认为是轻量级的。</p> <p><strong>容器流行的好处</strong></p> <ul><li><strong>敏捷地创建和部署应用程序</strong>：相较于创建虚拟机镜像，创建容器镜像更加容易和快速</li> <li><strong>分离开发和运维的关注点</strong>：在开发构建阶段就完成容器镜像的构建，构建好的镜像可以部署到多种基础设施上。</li> <li><strong>松耦合、分布式、弹性、无约束的微服务</strong>：应用程序被切分成更小的、独立的微服务，并可以动态部署和管理，而不是一个部署在专属机器上的庞大的单片应用程序</li> <li>等等....</li></ul> <p><strong>kubernetes的功能</strong></p> <p>Kubernetes可以处理应用程序的伸缩、failover、部署模式等多种需求。</p> <p>Kubernetes提供的特性有：</p> <ul><li><p><strong>服务发现和负载均衡</strong></p> <p>Kubernetes 可以通过 DNS 名称或 IP 地址暴露容器的访问方式。并且可以在同组容器内分发负载以实现负载均衡</p></li> <li><p><strong>存储编排</strong></p> <p>Kubernetes可以自动挂载指定的存储系统，例如 local stroage/nfs/云存储等</p></li> <li><p><strong>自动发布和回滚</strong></p> <p>您可以在 Kubernetes 中声明您期望应用程序容器应该达到的状态，Kubernetes将以合适的速率调整容器的实际状态，并逐步达到最终期望的结果。请参考 <a href="https://kuboard.cn/learning/k8s-intermediate/workload/wl-deployment/#deployment-%E6%A6%82%E8%BF%B0" target="_blank" rel="noopener noreferrer">声明式的配置<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><strong>自愈</strong></p> <p>Kubernetes提供如下自愈能力：</p> <ul><li>重启已经停机的容器</li> <li>替换、kill 那些不满足自定义健康检查条件的容器</li> <li>在容器就绪之前，避免调用者发现该容器</li></ul></li> <li><p><strong>密钥及配置管理</strong></p> <p>Kubernetes可以存储和管理敏感信息（例如，密码、OAuth token、ssh密钥等）。您可以更新容器应用程序的密钥、配置等信息，而无需：</p> <ul><li>重新构建容器的镜像</li> <li>在不合适的地方暴露密码信息</li></ul></li></ul> <p><strong>Kubernetes的边界</strong></p> <p>Kubernetes不是一个传统意义的、保罗万象的 PaaS（Platform as a Service）系统。Kubernetes在容器层面工作，而不是硬件层面，它提供了与 PaaS 平台相似的通用特性，例如：部署、伸缩、负载均衡、日志、监控等。然而，Kubernetes并不是一个单一整体，这些特性都是可选、可插拔的。Kubernetes提供用于搭建开发平台的基础模块，同时为用户提供了不同模块的选择性和多样性。</p> <p>Kubernetes：</p> <ul><li><p>不限制应用程序的类型。Kubernetes的目标是广泛支持不同类型的工作负载，包括：有状态、无状态、数据处理等类型的应用。只要应用可以在容器中运行，就能够非常好地在 Kubernetes 上运行</p></li> <li><p>不部署源码、不编译或构建应用程序。持续集成、分发、部署（CI/CD）的工作流极大程度上取决于组织的文化、偏好以及技术要求。Kubernetes可以作为部署平台参与到 CI/CD 流程，但是不涉及镜像构建和分发的过程</p> <blockquote><p>译者注：可选的有 Jenkins / Gitlab Runner / docker registry / harbour 等</p></blockquote></li> <li><p>不提供应用程序级别的服务，包括：中间件（例如，消息总线）、数据处理框架（例如，Spark）、数据库（例如，mysql）、缓存（例如，Redis），或者分布式存储（例如，Ceph）。此类组件可以在 Kubernetes 上运行，或者可以被运行在 Kubernetes 上的应用程序访问</p></li> <li><p>不限定日志、监控、报警的解决方案。Kubernetes 提供一些样例展示如何与日志、监控、报警等组件集成，同时提供收集、导出监控度量（metrics）的一套机制。您可以根据自己的需要选择日志、监控、报警组件</p> <blockquote><p>译者注：可选的有 ELK / Prometheus / Graphana / Pinpoint / Skywalking / Metrics Server 等</p></blockquote></li> <li><p>不提供或者限定配置语言（例如，jsonnet）。Kubernetes提供一组声明式的 API，您可以按照自己的方式定义部署信息。</p> <blockquote><p>译者注：可选的有 helm/kustomize/kubectl/kubernetes dashboard/kuboard/octant/k9s 等</p></blockquote></li> <li><p>不提供或限定任何机器的配置、维护、管理或自愈的系统。</p> <blockquote><p>译者注：在这个级别上，可选的组件有 puppet、ansible、open stack 等</p></blockquote></li> <li><p>此外，Kubernetes不是一个纯粹意义上的容器编排系统。事实上，Kubernetes 消除了容器编排的需求。容器编排的技术定义是<code>预定义流程的执行</code>（先做A、再做B、然后做C）。与此相对应，Kubernetes构建了一系列相互独立、可预排的控制过程，以持续不断地将系统从当前状态调整到声明的目标状态。如何从 A 达到 C，并不重要。集中化的控制也就不需要了。这个设计思想使得Kubernetes使用更简单、更强大、稳健、反脆弱和可扩展。</p></li></ul> <h2 id="kubernetes架构"><a href="#kubernetes架构" class="header-anchor">#</a> kubernetes架构</h2> <h3 id="borg简介"><a href="#borg简介" class="header-anchor">#</a> Borg简介</h3> <p>Borg是谷歌内部的大规模集群管理系统，负责对谷歌内部很多核心服务的调度和管理。Borg的目的是让用户能够不必操心资源管理的问题，让他们专注于自己的核心业务，并且做到跨多个数据中心的资源利用率最大化。</p> <p>Borg主要由BorgMaster、Borglet、borgcfg和Scheduler组成，如下图所示</p> <p><img src="/assets/img/borg.bb3ba0c7.png" alt="Borg架构"></p> <ul><li>BorgMaster是整个集群的大脑，负责维护整个集群的状态，并将数据持久化到Paxos存储中；</li> <li>Scheduer负责任务的调度，根据应用的特点将其调度到具体的机器上去；</li> <li>Borglet负责真正运行任务（在容器中）；</li> <li>borgcfg是Borg的命令行工具，用于跟Borg系统交互，一般通过一个配置文件来提交任务。</li></ul> <h3 id="kubernetes架构-2"><a href="#kubernetes架构-2" class="header-anchor">#</a> kubernetes架构</h3> <p>Kubernetes借鉴了Borg的设计理念，比如Pod、Service、Label和单Pod单IP等。Kubernetes的整体架构跟Borg非常像，如下图所示。</p> <p><img src="/assets/img/architecture.837055bc.png" alt="Kubernetes架构"></p> <p>Kubernetes主要由以下几个核心组件组成：</p> <ul><li>etcd保存了整个集群的状态；</li> <li>apiserver提供了资源操作的唯一入口，并提供认证、授权、访问控制、API注册和发现等机制；</li> <li>controller manager负责维护集群的状态，比如故障检测、自动扩展、滚动更新等；</li> <li>scheduler负责资源的调度，按照预定的调度策略将Pod调度到相应的机器上；</li> <li>kubelet负责维护容器的生命周期，同时也负责Volume（CSI）和网络（CNI）的管理；</li> <li>Container runtime负责镜像管理以及Pod和容器的真正运行（CRI）；</li> <li>kube-proxy负责为Service提供cluster内部的服务发现和负载均衡；</li></ul> <p>除了核心组件，还有一些推荐的插件，其中有的已经成为CNCF中的托管项目：</p> <ul><li>CoreDNS负责为整个集群提供DNS服务</li> <li>Ingress Controller为服务提供外网入口</li> <li>Prometheus提供资源监控</li> <li>Dashboard提供GUI</li> <li>Federation提供跨可用区的集群</li></ul> <p>下图清晰表明了Kubernetes的架构设计以及组件之间的通信协议。</p> <p><img src="/assets/img/image-20201117182651823.c2e94660.png" alt="image-20201117182651823"></p> <p>下面是更抽象的一个视图：</p> <p><img src="/assets/img/image-20201117185903668.5b19d0fa.png" alt="image-20201117185903668"></p> <p>Master架构</p> <p><img src="/assets/img/image-20201117185918518.48701ed7.png" alt="image-20201117185918518"></p> <p>Node架构</p> <p><img src="/assets/img/image-20201117190006428.fce10d13.png" alt="image-20201117190006428"></p> <h2 id="kubernetes组件"><a href="#kubernetes组件" class="header-anchor">#</a> kubernetes组件</h2> <h3 id="master组件"><a href="#master组件" class="header-anchor">#</a> <a href="https://kuboard.cn/learning/k8s-bg/component.html#master%E7%BB%84%E4%BB%B6" target="_blank" rel="noopener noreferrer">Master组件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <p>Master组件是集群的控制平台（control plane）：</p> <ul><li>master 组件负责集群中的全局决策（例如，调度）</li> <li>master 组件探测并响应集群事件（例如，当 Deployment 的实际 Pod 副本数未达到 <code>replicas</code> 字段的规定时，启动一个新的 Pod）</li></ul> <p>Master组件可以运行于集群中的任何机器上。但是，为了简洁性，通常在同一台机器上运行所有的 master 组件，且不在此机器上运行用户的容器。参考 <a href="https://kuboard.cn/install/install-kubernetes.html" target="_blank" rel="noopener noreferrer">安装Kubernetes高可用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h4 id="kube-apiserver"><a href="#kube-apiserver" class="header-anchor">#</a> <a href="https://kuboard.cn/learning/k8s-bg/component.html#kube-apiserver" target="_blank" rel="noopener noreferrer">kube-apiserver<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <p>此 master 组件提供 Kubernetes API。这是Kubernetes控制平台的前端（front-end），可以水平扩展（通过部署更多的实例以达到性能要求）。kubectl / kubernetes dashboard / kuboard 等Kubernetes管理工具就是通过 kubernetes API 实现对 Kubernetes 集群的管理。</p> <h4 id="etcd"><a href="#etcd" class="header-anchor">#</a> <a href="https://kuboard.cn/learning/k8s-bg/component.html#etcd" target="_blank" rel="noopener noreferrer">etcd<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <p>支持一致性和高可用的名值对存储组件，Kubernetes集群的所有配置信息都存储在 etcd 中。请确保您 <a href="https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster" target="_blank" rel="noopener noreferrer">备份 (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>了 etcd 的数据。关于 etcd 的更多信息，可参考 <a href="https://etcd.io/docs/" target="_blank" rel="noopener noreferrer">etcd 官方文档(opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="kube-scheduler"><a href="#kube-scheduler" class="header-anchor">#</a> <a href="https://kuboard.cn/learning/k8s-bg/component.html#kube-scheduler" target="_blank" rel="noopener noreferrer">kube-scheduler<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <p>此 master 组件监控所有新创建尚未分配到节点上的 Pod，并且自动选择为 Pod 选择一个合适的节点去运行。</p> <p>影响调度的因素有：</p> <ul><li>单个或多个 Pod 的资源需求</li> <li>硬件、软件、策略的限制</li> <li>亲和与反亲和（affinity and anti-affinity）的约定</li> <li>数据本地化要求</li> <li>工作负载间的相互作用</li></ul> <h4 id="kube-controller-manager"><a href="#kube-controller-manager" class="header-anchor">#</a> <a href="https://kuboard.cn/learning/k8s-bg/component.html#kube-controller-manager" target="_blank" rel="noopener noreferrer">kube-controller-manager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <p>此 master 组件运行了所有的控制器</p> <p>逻辑上来说，每一个控制器是一个独立的进程，但是为了降低复杂度，这些控制器都被合并运行在一个进程里。</p> <p>kube-controller-manager 中包含的控制器有：</p> <ul><li>节点控制器： 负责监听节点停机的事件并作出对应响应</li> <li>副本控制器： 负责为集群中每一个 副本控制器对象（Replication Controller Object）维护期望的 Pod 副本数</li> <li>端点（Endpoints）控制器：负责为端点对象（Endpoints Object，连接 Service 和 Pod）赋值</li> <li>Service Account &amp; Token控制器： 负责为新的名称空间创建 default Service Account 以及 API Access Token</li></ul> <h3 id="node-组件"><a href="#node-组件" class="header-anchor">#</a> <a href="https://kuboard.cn/learning/k8s-bg/component.html#node-%E7%BB%84%E4%BB%B6" target="_blank" rel="noopener noreferrer">Node 组件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <p>Node 组件运行在每一个节点上（包括 master 节点和 worker 节点），负责维护运行中的 Pod 并提供 Kubernetes 运行时环境。</p> <h4 id="kubelet"><a href="#kubelet" class="header-anchor">#</a> <a href="https://kuboard.cn/learning/k8s-bg/component.html#kubelet" target="_blank" rel="noopener noreferrer">kubelet<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <p>此组件是运行在每一个集群节点上的代理程序。它确保 Pod 中的容器处于运行状态。Kubelet 通过多种途径获得 PodSpec 定义，并确保 PodSpec 定义中所描述的容器处于运行和健康的状态。Kubelet不管理不是通过 Kubernetes 创建的容器。</p> <h4 id="kube-proxy"><a href="#kube-proxy" class="header-anchor">#</a> <a href="https://kuboard.cn/learning/k8s-bg/component.html#kube-proxy" target="_blank" rel="noopener noreferrer">kube-proxy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <p><a href="https://kuboard.cn/learning/k8s-intermediate/service/service-details.html#%E8%99%9A%E6%8B%9F-ip-%E5%92%8C%E6%9C%8D%E5%8A%A1%E4%BB%A3%E7%90%86" target="_blank" rel="noopener noreferrer">kube-proxy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是一个网络代理程序，运行在集群中的每一个节点上，是实现 Kubernetes Service 概念的重要部分。</p> <p>kube-proxy 在节点上维护网络规则。这些网络规则使得您可以在集群内、集群外正确地与 Pod 进行网络通信。如果操作系统中存在 packet filtering layer，kube-proxy 将使用这一特性（<a href="https://kuboard.cn/learning/k8s-intermediate/service/service-details.html#iptables-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener noreferrer">iptables代理模式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>），否则，kube-proxy将自行转发网络请求（<a href="https://kuboard.cn/learning/k8s-intermediate/service/service-details.html#user-space-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener noreferrer">User space代理模式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</p> <h4 id="容器引擎"><a href="#容器引擎" class="header-anchor">#</a> <a href="https://kuboard.cn/learning/k8s-bg/component.html#%E5%AE%B9%E5%99%A8%E5%BC%95%E6%93%8E" target="_blank" rel="noopener noreferrer">容器引擎<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <p>容器引擎负责运行容器。Kubernetes支持多种容器引擎：<a href="http://www.docker.com/" target="_blank" rel="noopener noreferrer">Docker (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://containerd.io/" target="_blank" rel="noopener noreferrer">containerd (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://cri-o.io/" target="_blank" rel="noopener noreferrer">cri-o (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://github.com/kubernetes-incubator/rktlet" target="_blank" rel="noopener noreferrer">rktlet (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>以及任何实现了 <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-node/container-runtime-interface.md" target="_blank" rel="noopener noreferrer">Kubernetes容器引擎接口 (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的容器引擎</p> <h3 id="addons"><a href="#addons" class="header-anchor">#</a> <a href="https://kuboard.cn/learning/k8s-bg/component.html#addons" target="_blank" rel="noopener noreferrer">Addons<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <p>addons叫做附加组件或者插件。</p> <p>Addons 使用 Kubernetes 资源（DaemonSet、Deployment等）实现集群的功能特性。由于他们提供集群级别的功能特性，addons使用到的Kubernetes资源都放置在 <code>kube-system</code> 名称空间下。</p> <p>下面描述了一些经常用到的 addons，参考 <a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" target="_blank" rel="noopener noreferrer">Addons (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>查看更多列表。</p> <h4 id="dns"><a href="#dns" class="header-anchor">#</a> <a href="https://kuboard.cn/learning/k8s-bg/component.html#dns" target="_blank" rel="noopener noreferrer">DNS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <p>除了 DNS Addon 以外，其他的 addon 都不是必须的，所有 Kubernetes 集群都应该有 <a href="https://kuboard.cn/learning/k8s-intermediate/service/dns.html" target="_blank" rel="noopener noreferrer">Cluster DNS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Cluster DNS 是一个 DNS 服务器，是对您已有环境中其他 DNS 服务器的一个补充，存放了 Kubernetes Service 的 DNS 记录。</p> <p>Kubernetes 启动容器时，自动将该 DNS 服务器加入到容器的 DNS 搜索列表中。</p> <blockquote><p>如果您参考 www.kuboard.cn 上提供的文档安装 Kubernetes，默认已经安装了 <a href="https://coredns.io/" target="_blank" rel="noopener noreferrer">Core DNS(opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h4 id="web-ui-dashboard"><a href="#web-ui-dashboard" class="header-anchor">#</a> <a href="https://kuboard.cn/learning/k8s-bg/component.html#web-ui-dashboard" target="_blank" rel="noopener noreferrer">Web UI（Dashboard）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <p><a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" target="_blank" rel="noopener noreferrer">Dashboard (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是一个Kubernetes集群的 Web 管理界面。用户可以通过该界面管理集群。</p> <h4 id="kuboard"><a href="#kuboard" class="header-anchor">#</a> <a href="https://kuboard.cn/learning/k8s-bg/component.html#kuboard" target="_blank" rel="noopener noreferrer">Kuboard<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <p><a href="https://kuboard.cn/install/install-dashboard.html" target="_blank" rel="noopener noreferrer">Kuboard<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是一款基于Kubernetes的微服务管理界面，相较于 Dashboard，Kuboard 强调：</p> <ul><li>无需手工编写 YAML 文件</li> <li>微服务参考架构</li> <li>上下文相关的监控</li> <li>场景化的设计
<ul><li>导出配置</li> <li>导入配置</li></ul></li></ul> <h4 id="containerresource-monitoring"><a href="#containerresource-monitoring" class="header-anchor">#</a> <a href="https://kuboard.cn/learning/k8s-bg/component.html#containerresource-monitoring" target="_blank" rel="noopener noreferrer">ContainerResource Monitoring<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <p><a href="https://kubernetes.io/docs/tasks/debug-application-cluster/resource-usage-monitoring/" target="_blank" rel="noopener noreferrer">Container Resource Monitoring (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>将容器的度量指标（metrics）记录在时间序列数据库中，并提供了 UI 界面查看这些数据</p> <h4 id="cluster-level-logging"><a href="#cluster-level-logging" class="header-anchor">#</a> <a href="https://kuboard.cn/learning/k8s-bg/component.html#cluster-level-logging" target="_blank" rel="noopener noreferrer">Cluster-level Logging<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <p><a href="https://kubernetes.io/docs/concepts/cluster-administration/logging/" target="_blank" rel="noopener noreferrer">Cluster-level logging (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>机制负责将容器的日志存储到一个统一存储中，并提供搜索浏览的界面</p> <h2 id="kubernetes安装"><a href="#kubernetes安装" class="header-anchor">#</a> kubernetes安装</h2> <h3 id="单节点安装"><a href="#单节点安装" class="header-anchor">#</a> 单节点安装</h3> <p>配置要求：</p> <ul><li>至少2台 <strong>2核4G</strong> 的服务器</li> <li><strong>Cent OS 7.6 / 7.7 / 7.8</strong></li></ul> <p><strong>安装后的软件版本为</strong></p> <ul><li>Kubernetes v1.19.x
<ul><li>calico 3.13.1</li> <li>nginx-ingress 1.5.5</li></ul></li> <li>Docker 19.03.11</li></ul> <p>安装前置条件：</p> <ul><li>任意节点 centos 版本为 7.6 / 7.7 或 7.8</li> <li>任意节点 CPU 内核数量大于等于 2，且内存大于等于 4G</li> <li>任意节点 hostname 不是 localhost，且不包含下划线、小数点、大写字母</li> <li>任意节点都有固定的内网 IP 地址</li> <li>任意节点都只有一个网卡，如果有特殊目的，我可以在完成 K8S 安装后再增加新的网卡</li> <li>任意节点上 Kubelet使用的 IP 地址 可互通（无需 NAT 映射即可相互访问），且没有防火墙、安全组隔离</li> <li>任意节点不会直接使用 docker run 或 docker-compose 运行容器</li></ul> <h4 id="下载centos镜像"><a href="#下载centos镜像" class="header-anchor">#</a> 下载centos镜像</h4> <p>centos iso文件下载链接：</p> <ul><li>https://mirrors.aliyun.com/centos/?spm=a2c6h.13651104.0.0.5f6612b2AyMJ5i</li> <li>http://vault.centos.org/</li> <li>https://vault.centos.org/7.7.1908/isos/x86_64/</li></ul> <h4 id="检查-centos-hostname"><a href="#检查-centos-hostname" class="header-anchor">#</a> 检查 centos / hostname</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## 在 master 节点和 worker 节点都要执行</span>
<span class="token function">cat</span> /etc/redhat-release

<span class="token comment">## 此处 hostname 的输出将会是该机器在 Kubernetes 集群中的节点名字</span>
<span class="token comment">## 不能使用 localhost 作为节点的名字</span>
<span class="token function">hostname</span>

<span class="token comment">## 请使用 lscpu 命令，核对 CPU 信息</span>
<span class="token comment">## Architecture: x86_64    本安装文档不支持 arm 架构</span>
<span class="token comment">## CPU(s):       2         CPU 内核数量不能低于 2</span>
lscpu
</code></pre></div><p>设置hostname:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## 修改 hostname</span>
hostnamectl set-hostname your-new-host-name
<span class="token comment">## 查看修改结果</span>
hostnamectl status
<span class="token comment">## 设置 hostname 解析</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;127.0.0.1   <span class="token variable"><span class="token variable">$(</span><span class="token function">hostname</span><span class="token variable">)</span></span>&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/hosts
</code></pre></div><p>修改cpu数量的方法：</p> <p><img src="/assets/img/image-20201221143718889.140231f4.png" alt="image-20201221143718889"></p> <h4 id="检查网络"><a href="#检查网络" class="header-anchor">#</a> 检查网络</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>root@demo-master-a-1 ~<span class="token punctuation">]</span>$ <span class="token function">ip</span> route show
default via <span class="token number">172.21</span>.0.1 dev eth0 
<span class="token number">169.254</span>.0.0/16 dev eth0 scope <span class="token function">link</span> metric <span class="token number">1002</span> 
<span class="token number">172.21</span>.0.0/20 dev eth0 proto kernel scope <span class="token function">link</span> src <span class="token number">172.21</span>.0.12 

<span class="token punctuation">[</span>root@demo-master-a-1 ~<span class="token punctuation">]</span>$ <span class="token function">ip</span> address
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever
<span class="token number">2</span>: eth0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="token number">1000</span>
    link/ether 00:16:3e:12:a4:1b brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">172.17</span>.216.80/20 brd <span class="token number">172.17</span>.223.255 scope global dynamic eth0
       valid_lft 305741654sec preferred_lft 305741654sec
</code></pre></div><p>kubelet使用的IP地址</p> <ul><li><code>ip route show</code> 命令中，可以知道机器的默认网卡，通常是 <code>eth0</code>，如 <em><strong>default via 172.21.0.23 dev eth0</strong></em></li> <li><code>ip address</code> 命令中，可显示默认网卡的 IP 地址，Kubernetes 将使用此 IP 地址与集群内的其他节点通信，如 <code>172.17.216.80</code></li> <li>所有节点上 Kubernetes 所使用的 IP 地址必须可以互通（无需 NAT 映射、无安全组或防火墙隔离）</li></ul> <p><strong>配置静态ip：</strong></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vi</span> /etc/sysconfig/network-scripts/ifcfg-ens33 
<span class="token assign-left variable">TYPE</span><span class="token operator">=</span><span class="token string">&quot;Ethernet&quot;</span>
<span class="token assign-left variable">PROXY_METHOD</span><span class="token operator">=</span><span class="token string">&quot;none&quot;</span>
<span class="token assign-left variable">BROWSER_ONLY</span><span class="token operator">=</span><span class="token string">&quot;no&quot;</span>
<span class="token assign-left variable">BOOTPROTO</span><span class="token operator">=</span><span class="token string">&quot;static&quot;</span>   <span class="token comment">#这里要修改成static</span>
<span class="token assign-left variable">DEFROUTE</span><span class="token operator">=</span><span class="token string">&quot;yes&quot;</span>
<span class="token assign-left variable">IPV4_FAILURE_FATAL</span><span class="token operator">=</span><span class="token string">&quot;no&quot;</span>
<span class="token assign-left variable">IPV6INIT</span><span class="token operator">=</span><span class="token string">&quot;yes&quot;</span>
<span class="token assign-left variable">IPV6_AUTOCONF</span><span class="token operator">=</span><span class="token string">&quot;yes&quot;</span>
<span class="token assign-left variable">IPV6_DEFROUTE</span><span class="token operator">=</span><span class="token string">&quot;yes&quot;</span>
<span class="token assign-left variable">IPV6_FAILURE_FATAL</span><span class="token operator">=</span><span class="token string">&quot;no&quot;</span>
<span class="token assign-left variable">IPV6_ADDR_GEN_MODE</span><span class="token operator">=</span><span class="token string">&quot;stable-privacy&quot;</span>
<span class="token assign-left variable">NAME</span><span class="token operator">=</span><span class="token string">&quot;ens33&quot;</span>
<span class="token assign-left variable">UUID</span><span class="token operator">=</span><span class="token string">&quot;0c00c122-c1b4-4677-ac88-94f992fe0346&quot;</span>
<span class="token assign-left variable">DEVICE</span><span class="token operator">=</span><span class="token string">&quot;ens33&quot;</span>
<span class="token assign-left variable">ONBOOT</span><span class="token operator">=</span><span class="token string">&quot;yes&quot;</span>

<span class="token assign-left variable">IPADDR</span><span class="token operator">=</span><span class="token string">&quot;192.168.72.137&quot;</span>
<span class="token assign-left variable">NETMASK</span><span class="token operator">=</span><span class="token string">&quot;255.255.255.0&quot;</span>
<span class="token assign-left variable">GATEWAY</span><span class="token operator">=</span><span class="token string">&quot;192.168.72.1&quot;</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>systemctl restart network
</code></pre></div><p><strong>关掉防火墙：</strong></p> <div class="language- extra-class"><pre class="language-text"><code>systemctl stop firewalld
systemctl disable firewalld
</code></pre></div><h4 id="安装docker及kubelet"><a href="#安装docker及kubelet" class="header-anchor">#</a> 安装docker及kubelet</h4> <p>可选择快速安装或者手动安装方式。</p> <h5 id="快速安装"><a href="#快速安装" class="header-anchor">#</a> 快速安装</h5> <p>使用 root 身份在所有节点执行如下代码，以安装软件：</p> <ul><li>docker</li> <li>nfs-utils</li> <li>kubectl / kubeadm / kubelet</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## 在 master 节点和 worker 节点都要执行</span>
<span class="token comment">## 最后一个参数 1.19.5 用于指定 kubenetes 版本，支持所有 1.19.x 版本的安装</span>
<span class="token comment">## 腾讯云 docker hub 镜像</span>
<span class="token comment">## export REGISTRY_MIRROR=&quot;https://mirror.ccs.tencentyun.com&quot;</span>
<span class="token comment">## DaoCloud 镜像</span>
<span class="token comment">## export REGISTRY_MIRROR=&quot;http://f1361db2.m.daocloud.io&quot;</span>
<span class="token comment">## 华为云镜像</span>
<span class="token comment">## export REGISTRY_MIRROR=&quot;https://05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com&quot;</span>
<span class="token comment">## 阿里云 docker hub 镜像</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">REGISTRY_MIRROR</span><span class="token operator">=</span>https://registry.cn-hangzhou.aliyuncs.com
<span class="token function">curl</span> -sSL https://kuboard.cn/install-script/v1.19.x/install_kubelet.sh <span class="token operator">|</span> <span class="token function">sh</span> -s <span class="token number">1.19</span>.5
</code></pre></div><p><strong>请将脚本最后的 1.19.5 替换成需要的版本号，</strong> 脚本中间的 v1.19.x 不要替换</p> <blockquote><p>docker hub 镜像请根据自己网络的情况任选一个</p> <ul><li>第四行为腾讯云 docker hub 镜像</li> <li>第六行为DaoCloud docker hub 镜像</li> <li>第八行为华为云 docker hub 镜像</li> <li>第十行为阿里云 docker hub 镜像</li></ul></blockquote> <h5 id="手动安装"><a href="#手动安装" class="header-anchor">#</a> 手动安装</h5> <p>手动执行以下代码，结果与快速安装相同。<em><strong>请将脚本第79行（已高亮）的 ${1} 替换成您需要的版本号，例如 1.19.5</strong></em></p> <blockquote><p>docker hub 镜像请根据自己网络的情况任选一个</p> <ul><li>第四行为腾讯云 docker hub 镜像</li> <li>第六行为DaoCloud docker hub 镜像</li> <li>第八行为阿里云 docker hub 镜像</li></ul></blockquote> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## 在 master 节点和 worker 节点都要执行</span>
<span class="token comment">## 最后一个参数 1.19.5 用于指定 kubenetes 版本，支持所有 1.19.x 版本的安装</span>
<span class="token comment">## 腾讯云 docker hub 镜像</span>
<span class="token comment">## export REGISTRY_MIRROR=&quot;https://mirror.ccs.tencentyun.com&quot;</span>
<span class="token comment">## DaoCloud 镜像</span>
<span class="token comment">## export REGISTRY_MIRROR=&quot;http://f1361db2.m.daocloud.io&quot;</span>
<span class="token comment">## 阿里云 docker hub 镜像</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">REGISTRY_MIRROR</span><span class="token operator">=</span>https://registry.cn-hangzhou.aliyuncs.com
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token shebang important">#!/bin/bash</span>

<span class="token comment">## 在 master 节点和 worker 节点都要执行</span>

<span class="token comment">## 安装 docker</span>
<span class="token comment">## 参考文档如下</span>
<span class="token comment">## https://docs.docker.com/install/linux/docker-ce/centos/ </span>
<span class="token comment">## https://docs.docker.com/install/linux/linux-postinstall/</span>

<span class="token comment">## 卸载旧版本</span>
yum remove -y docker <span class="token punctuation">\</span>
docker-client <span class="token punctuation">\</span>
docker-client-latest <span class="token punctuation">\</span>
docker-ce-cli <span class="token punctuation">\</span>
docker-common <span class="token punctuation">\</span>
docker-latest <span class="token punctuation">\</span>
docker-latest-logrotate <span class="token punctuation">\</span>
docker-logrotate <span class="token punctuation">\</span>
docker-selinux <span class="token punctuation">\</span>
docker-engine-selinux <span class="token punctuation">\</span>
docker-engine

<span class="token comment">## 设置 yum repository</span>
yum <span class="token function">install</span> -y yum-utils <span class="token punctuation">\</span>
device-mapper-persistent-data <span class="token punctuation">\</span>
lvm2
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

<span class="token comment">## 安装并启动 docker</span>
yum <span class="token function">install</span> -y docker-ce-19.03.11 docker-ce-cli-19.03.11 containerd.io-1.2.13

<span class="token function">mkdir</span> /etc/docker <span class="token operator">||</span> <span class="token boolean">true</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF
{
  &quot;registry-mirrors&quot;: [&quot;<span class="token variable">${REGISTRY_MIRROR}</span>&quot;],
  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],
  &quot;log-driver&quot;: &quot;json-file&quot;,
  &quot;log-opts&quot;: {
    &quot;max-size&quot;: &quot;100m&quot;
  },
  &quot;storage-driver&quot;: &quot;overlay2&quot;,
  &quot;storage-opts&quot;: [
    &quot;overlay2.override_kernel_check=true&quot;
  ]
}
EOF</span>

<span class="token function">mkdir</span> -p /etc/systemd/system/docker.service.d

<span class="token comment">## Restart Docker</span>
systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> docker
systemctl restart docker

<span class="token comment">## 安装 nfs-utils</span>
<span class="token comment">## 必须先安装 nfs-utils 才能挂载 nfs 网络存储</span>
yum <span class="token function">install</span> -y nfs-utils
yum <span class="token function">install</span> -y <span class="token function">wget</span>

<span class="token comment">## 关闭 防火墙</span>
systemctl stop firewalld
systemctl disable firewalld

<span class="token comment">## 关闭 SeLinux</span>
setenforce <span class="token number">0</span>
<span class="token function">sed</span> -i <span class="token string">&quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot;</span> /etc/selinux/config

<span class="token comment">## 关闭 swap</span>
swapoff -a
<span class="token function">yes</span> <span class="token operator">|</span> <span class="token function">cp</span> /etc/fstab /etc/fstab_bak
<span class="token function">cat</span> /etc/fstab_bak <span class="token operator">|</span><span class="token function">grep</span> -v swap <span class="token operator">&gt;</span> /etc/fstab

<span class="token comment">## 修改 /etc/sysctl.conf</span>
<span class="token comment">## 如果有配置，则修改</span>
<span class="token function">sed</span> -i <span class="token string">&quot;s#^net.ipv4.ip_forward.*#net.ipv4.ip_forward=1#g&quot;</span>  /etc/sysctl.conf
<span class="token function">sed</span> -i <span class="token string">&quot;s#^net.bridge.bridge-nf-call-ip6tables.*#net.bridge.bridge-nf-call-ip6tables=1#g&quot;</span>  /etc/sysctl.conf
<span class="token function">sed</span> -i <span class="token string">&quot;s#^net.bridge.bridge-nf-call-iptables.*#net.bridge.bridge-nf-call-iptables=1#g&quot;</span>  /etc/sysctl.conf
<span class="token function">sed</span> -i <span class="token string">&quot;s#^net.ipv6.conf.all.disable_ipv6.*#net.ipv6.conf.all.disable_ipv6=1#g&quot;</span>  /etc/sysctl.conf
<span class="token function">sed</span> -i <span class="token string">&quot;s#^net.ipv6.conf.default.disable_ipv6.*#net.ipv6.conf.default.disable_ipv6=1#g&quot;</span>  /etc/sysctl.conf
<span class="token function">sed</span> -i <span class="token string">&quot;s#^net.ipv6.conf.lo.disable_ipv6.*#net.ipv6.conf.lo.disable_ipv6=1#g&quot;</span>  /etc/sysctl.conf
<span class="token function">sed</span> -i <span class="token string">&quot;s#^net.ipv6.conf.all.forwarding.*#net.ipv6.conf.all.forwarding=1#g&quot;</span>  /etc/sysctl.conf
<span class="token comment">## 可能没有，追加</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;net.ipv4.ip_forward = 1&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
<span class="token builtin class-name">echo</span> <span class="token string">&quot;net.bridge.bridge-nf-call-ip6tables = 1&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
<span class="token builtin class-name">echo</span> <span class="token string">&quot;net.bridge.bridge-nf-call-iptables = 1&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
<span class="token builtin class-name">echo</span> <span class="token string">&quot;net.ipv6.conf.all.disable_ipv6 = 1&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
<span class="token builtin class-name">echo</span> <span class="token string">&quot;net.ipv6.conf.default.disable_ipv6 = 1&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
<span class="token builtin class-name">echo</span> <span class="token string">&quot;net.ipv6.conf.lo.disable_ipv6 = 1&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
<span class="token builtin class-name">echo</span> <span class="token string">&quot;net.ipv6.conf.all.forwarding = 1&quot;</span>  <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
<span class="token comment">## 执行命令以应用</span>
sysctl -p

<span class="token comment">## 配置K8S的yum源</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/yum.repos.d/kubernetes.repo</span>
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF</span>

<span class="token comment">## 卸载旧版本</span>
yum remove -y kubelet kubeadm kubectl

<span class="token comment">## 安装kubelet、kubeadm、kubectl</span>
<span class="token comment">## 将 ${1} 替换为 kubernetes 版本号，例如 1.19.0</span>
yum <span class="token function">install</span> -y kubelet-<span class="token variable">${1}</span> kubeadm-<span class="token variable">${1}</span> kubectl-<span class="token variable">${1}</span>

<span class="token comment">## 重启 docker，并启动 kubelet</span>
systemctl daemon-reload
systemctl restart docker
systemctl <span class="token builtin class-name">enable</span> kubelet <span class="token operator">&amp;&amp;</span> systemctl start kubelet

docker version

</code></pre></div><blockquote><p>WARNING</p> <p>如果此时执行 <code>systemctl status kubelet</code> 命令，将得到 kubelet 启动失败的错误提示，请忽略此错误，因为必须完成后续步骤中 kubeadm init 的操作，kubelet 才能正常启动</p></blockquote> <h4 id="初始化-master-节点"><a href="#初始化-master-节点" class="header-anchor">#</a> <a href="https://kuboard.cn/install/install-k8s.html#%E5%88%9D%E5%A7%8B%E5%8C%96-master-%E8%8A%82%E7%82%B9" target="_blank" rel="noopener noreferrer">初始化 master 节点<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <h5 id="快速初始化"><a href="#快速初始化" class="header-anchor">#</a> 快速初始化</h5> <p><strong>请将脚本最后的 1.19.5 替换成您需要的版本号，</strong> 脚本中间的 v1.19.x 不要替换</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## 只在 master 节点执行</span>
<span class="token comment">## 替换 x.x.x.x 为 master 节点实际 IP（请使用内网 IP）</span>
<span class="token comment">## export 命令只在当前 shell 会话中有效，开启新的 shell 窗口后，如果要继续安装过程，请重新执行此处的 export 命令</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MASTER_IP</span><span class="token operator">=</span>x.x.x.x
<span class="token comment">## 替换 apiserver.demo 为 您想要的 dnsName</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">APISERVER_NAME</span><span class="token operator">=</span>apiserver.demo
<span class="token comment">## Kubernetes 容器组所在的网段，该网段安装完成后，由 kubernetes 创建，事先并不存在于您的物理网络中</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">POD_SUBNET</span><span class="token operator">=</span><span class="token number">10.100</span>.0.1/16
<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${MASTER_IP}</span>    <span class="token variable">${APISERVER_NAME}</span>&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/hosts
<span class="token function">curl</span> -sSL https://kuboard.cn/install-script/v1.19.x/init_master.sh <span class="token operator">|</span> <span class="token function">sh</span> -s <span class="token number">1.19</span>.5

</code></pre></div><h5 id="手动初始化"><a href="#手动初始化" class="header-anchor">#</a> 手动初始化</h5> <p>手动执行以下代码，结果与快速初始化相同。<em><strong>请将脚本第21行（已高亮）的 ${1} 替换成您需要的版本号，例如 1.19.5</strong></em></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## 只在 master 节点执行</span>
<span class="token comment">## 替换 x.x.x.x 为 master 节点的内网IP</span>
<span class="token comment">## export 命令只在当前 shell 会话中有效，开启新的 shell 窗口后，如果要继续安装过程，请重新执行此处的 export 命令</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MASTER_IP</span><span class="token operator">=</span>x.x.x.x
<span class="token comment">## 替换 apiserver.demo 为 您想要的 dnsName</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">APISERVER_NAME</span><span class="token operator">=</span>apiserver.demo
<span class="token comment">## Kubernetes 容器组所在的网段，该网段安装完成后，由 kubernetes 创建，事先并不存在于您的物理网络中</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">POD_SUBNET</span><span class="token operator">=</span><span class="token number">10.100</span>.0.1/16
<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${MASTER_IP}</span>    <span class="token variable">${APISERVER_NAME}</span>&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/hosts
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token shebang important">#!/bin/bash</span>

<span class="token comment">## 只在 master 节点执行</span>

<span class="token comment">## 脚本出错时终止执行</span>
<span class="token builtin class-name">set</span> -e

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">${<span class="token operator">#</span>POD_SUBNET}</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span> <span class="token variable">${<span class="token operator">#</span>APISERVER_NAME}</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> -e <span class="token string">&quot;<span class="token entity" title="\033">\033</span>[31;1m请确保您已经设置了环境变量 POD_SUBNET 和 APISERVER_NAME <span class="token entity" title="\033">\033</span>[0m&quot;</span>
  <span class="token builtin class-name">echo</span> 当前POD_SUBNET<span class="token operator">=</span><span class="token variable">$POD_SUBNET</span>
  <span class="token builtin class-name">echo</span> 当前APISERVER_NAME<span class="token operator">=</span><span class="token variable">$APISERVER_NAME</span>
  <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">fi</span>


<span class="token comment">## 查看完整配置选项 https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2</span>
<span class="token function">rm</span> -f ./kubeadm-config.yaml
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> ./kubeadm-config.yaml</span>
apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
kubernetesVersion: 1.18.9
imageRepository: registry.aliyuncs.com/k8sxio
controlPlaneEndpoint: &quot;<span class="token variable">${APISERVER_NAME}</span>:6443&quot;
networking:
  serviceSubnet: &quot;10.96.0.0/16&quot;
  podSubnet: &quot;<span class="token variable">${POD_SUBNET}</span>&quot;
  dnsDomain: &quot;cluster.local&quot;
EOF</span>

<span class="token comment">## kubeadm init</span>
<span class="token comment">## 根据您服务器网速的情况，您需要等候 3 - 10 分钟</span>
kubeadm config images pull --config<span class="token operator">=</span>kubeadm-config.yaml
kubeadm init --config<span class="token operator">=</span>kubeadm-config.yaml --upload-certs

<span class="token comment">## 配置 kubectl</span>
<span class="token function">rm</span> -rf /root/.kube/
<span class="token function">mkdir</span> /root/.kube/
<span class="token function">cp</span> -i /etc/kubernetes/admin.conf /root/.kube/config

<span class="token comment">## 安装 calico 网络插件</span>
<span class="token comment">## 参考文档 https://docs.projectcalico.org/v3.13/getting-started/kubernetes/self-managed-onprem/onpremises</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;安装calico-3.13.1&quot;</span>
<span class="token function">rm</span> -f calico-3.13.1.yaml
<span class="token function">wget</span> https://kuboard.cn/install-script/calico/calico-3.13.1.yaml
kubectl apply -f calico-3.13.1.yaml

</code></pre></div><p><strong>如果master初始化出错：</strong></p> <blockquote><ul><li><p>请确保使用 root 用户执行初始化命令</p></li> <li><p>不能下载 kubernetes 的 docker 镜像</p> <ul><li><p>安装文档中，默认使用阿里云的 docker 镜像仓库，然而，有时候，该镜像会罢工</p></li> <li><p>如碰到不能下载 docker 镜像的情况，请尝试手工初始化，并修改手工初始化脚本里的第22行（文档中已高亮）为：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">imageRepository</span><span class="token punctuation">:</span> gcr.azk8s.cn/google<span class="token punctuation">-</span>containers
</code></pre></div></li></ul></li> <li><p>检查环境变量，执行如下命令</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">echo</span> <span class="token assign-left variable">MASTER_IP</span><span class="token operator">=</span><span class="token variable">${MASTER_IP}</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token assign-left variable">APISERVER_NAME</span><span class="token operator">=</span><span class="token variable">${APISERVER_NAME}</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token assign-left variable">POD_SUBNET</span><span class="token operator">=</span><span class="token variable">${POD_SUBNET}</span>
</code></pre></div><p>请验证如下几点：</p> <ul><li>环境变量 <em><strong>MASTER_IP</strong></em> 的值应该为 master 节点的 <strong>内网IP</strong>，如果不是，请重新 export</li> <li><strong>APISERVER_NAME</strong> 不能是 master 的 hostname</li> <li><strong>APISERVER_NAME</strong> 必须全为小写字母、数字、小数点，不能包含减号</li> <li><strong>POD_SUBNET</strong> 所使用的网段不能与 <em><strong>master节点/worker节点</strong></em> 所在的网段重叠。该字段的取值为一个 <a href="https://kuboard.cn/glossary/cidr.html" target="_blank" rel="noopener noreferrer">CIDR<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 值，如果您对 CIDR 这个概念还不熟悉，请仍然执行 export POD_SUBNET=10.100.0.1/16 命令，不做修改</li></ul></li> <li><p>重新初始化 master 节点前，请先执行 <code>kubeadm reset -f</code> 操作</p></li></ul></blockquote> <h5 id="检查-master-初始化结果"><a href="#检查-master-初始化结果" class="header-anchor">#</a> 检查 master 初始化结果</h5> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## 只在 master 节点执行</span>

<span class="token comment">## 执行如下命令，等待 3-10 分钟，直到所有的容器组处于 Running 状态</span>
<span class="token function">watch</span> kubectl get pod -n kube-system -o wide

<span class="token comment">## 查看 master 节点初始化结果</span>
kubectl get nodes -o wide

</code></pre></div><p>可能会出现pending或者Failed to pull image的问题，需要稍微等久一点，从下面的图可以看出花了21分钟才全部处于Running状态：</p> <p><img src="/assets/img/image-20201221184147517.4aa5a090.png" alt="image-20201221184147517"></p> <p><img src="/assets/img/image-20201221185235129.b2360861.png" alt="image-20201221185235129"></p> <p>出现错误的解决方法：</p> <blockquote><ul><li><p>ImagePullBackoff / Pending</p> <ul><li>如果 <code>kubectl get pod -n kube-system -o wide</code> 的输出结果中出现 ImagePullBackoff 或者长时间处于 Pending 的情况，请参考 <a href="https://kuboard.cn/learning/faq/image-pull-backoff.html" target="_blank" rel="noopener noreferrer">查看镜像抓取进度<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li> <li><p>ContainerCreating</p> <ul><li><p>如果<code>kubectl get pod -n kube-system -o wide</code>的输出结果中某个 Pod 长期处于 ContainerCreating、PodInitializing 或 Init:0/3 的状态，可以尝试：</p> <ul><li><p>查看该 Pod 的状态，例如：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl describe pod kube-flannel-ds-amd64-8l25c -n kube-system
</code></pre></div><p>如果输出结果中，最后一行显示的是 Pulling image，请耐心等待，或者参考</p> <p>查看镜像抓取进度</p> <div class="language- extra-class"><pre class="language-text"><code>Normal  Pulling    44s   kubelet, k8s-worker-02  Pulling image &quot;quay.io/coreos/flannel:v0.12.0-amd64&quot;
</code></pre></div></li> <li><p>将该 Pod 删除，系统会自动重建一个新的 Pod，例如：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl delete pod kube-flannel-ds-amd64-8l25c -n kube-system
</code></pre></div></li></ul></li></ul></li></ul></blockquote> <h4 id="初始化worker节点"><a href="#初始化worker节点" class="header-anchor">#</a> 初始化worker节点</h4> <p>针对所有worker节点执行：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## 只在 worker 节点执行</span>
<span class="token comment">## 替换 x.x.x.x 为 master 节点的内网 IP</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MASTER_IP</span><span class="token operator">=</span>x.x.x.x
<span class="token comment">## 替换 apiserver.demo 为初始化 master 节点时所使用的 APISERVER_NAME</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">APISERVER_NAME</span><span class="token operator">=</span>apiserver.demo
<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${MASTER_IP}</span>    <span class="token variable">${APISERVER_NAME}</span>&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/hosts

<span class="token comment">## 替换为 master 节点上 kubeadm token create 命令的输出</span>
kubeadm <span class="token function">join</span> apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303

</code></pre></div><p>把worker节点添加进来后，看下图，需要大概10分钟的时间去转为Ready状态，一开始为Not Ready状态。</p> <p><img src="/assets/img/image-20201221191719471.d3f2f3b6.png" alt="image-20201221191719471"></p> <p><strong>出错处理</strong></p> <blockquote><h4 id="常见错误原因"><a href="#常见错误原因" class="header-anchor">#</a> 常见错误原因</h4> <p>经常在群里提问为什么 join 不成功的情况大致有这几种：</p> <p><a href="https://kuboard.cn/install/install-k8s.html#worker-%E8%8A%82%E7%82%B9%E4%B8%8D%E8%83%BD%E8%AE%BF%E9%97%AE-apiserver" target="_blank" rel="noopener noreferrer">worker 节点不能访问 apiserver<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>在worker节点执行以下语句可验证worker节点是否能访问 apiserver</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> -ik https://apiserver.demo:6443
</code></pre></div><p>如果不能，请在 master 节点上验证</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> -ik https://localhost:6443
</code></pre></div><p>正常输出结果如下所示：</p> <div class="language- extra-class"><pre class="language-text"><code>HTTP/1.1 403 Forbidden
Cache-Control: no-cache, private
Content-Type: application/json
X-Content-Type-Options: nosniff
Date: Fri, 15 Nov 2019 04:34:40 GMT
Content-Length: 233

{
  &quot;kind&quot;: &quot;Status&quot;,
  &quot;apiVersion&quot;: &quot;v1&quot;,
  &quot;metadata&quot;: {
...
</code></pre></div><p>可能原因</p> <ul><li>如果 master 节点能够访问 apiserver、而 worker 节点不能，则请检查自己的网络设置
<ul><li>/etc/hosts 是否正确设置？</li> <li>是否有安全组或防火墙的限制？</li></ul></li></ul> <p><a href="https://kuboard.cn/install/install-k8s.html#worker-%E8%8A%82%E7%82%B9%E9%BB%98%E8%AE%A4%E7%BD%91%E5%8D%A1" target="_blank" rel="noopener noreferrer">worker 节点默认网卡<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>Kubelet使用的 IP 地址与 master 节点可互通（无需 NAT 映射），且没有防火墙、安全组隔离
<ul><li>如果你使用 vmware 或 virtualbox 创建虚拟机用于 K8S 学习，可以尝试 NAT 模式的网络，而不是桥接模式的网络</li></ul></li></ul> <p><a href="https://kuboard.cn/install/install-k8s.html#%E7%A7%BB%E9%99%A4worker%E8%8A%82%E7%82%B9%E5%B9%B6%E9%87%8D%E8%AF%95" target="_blank" rel="noopener noreferrer">移除worker节点并重试<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>WARNING</p> <p>正常情况下，您无需移除 worker 节点，如果添加到集群出错，您可以移除 worker 节点，再重新尝试添加</p> <p>在准备移除的 worker 节点上执行</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## 只在 worker 节点执行</span>
kubeadm reset -f
</code></pre></div><p>在 master 节点 demo-master-a-1 上执行</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## 只在 master 节点执行</span>
kubectl get nodes -o wide
</code></pre></div><p>如果列表中没有您要移除的节点，则忽略下一个步骤</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## 只在 master 节点执行</span>
kubectl delete node demo-worker-x-x  
</code></pre></div><p>TIP</p> <ul><li>将 demo-worker-x-x 替换为要移除的 worker 节点的名字</li> <li>worker 节点的名字可以通过在节点 demo-master-a-1 上执行 kubectl get nodes 命令获得</li></ul></blockquote> <h5 id="检查初始化结果"><a href="#检查初始化结果" class="header-anchor">#</a> 检查初始化结果</h5> <div class="language- extra-class"><pre class="language-text"><code>## 只在 master 节点执行
kubectl get nodes -o wide
</code></pre></div><p>结果格式如下：</p> <div class="language- extra-class"><pre class="language-text"><code>[root@node03 imagetars]## kubectl get nodes -o wide
NAME     STATUS   ROLES    AGE   VERSION   INTERNAL-IP       EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION           CONTAINER-RUNTIME
node01   Ready    master   63m   v1.19.5   192.168.116.101   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1062.el7.x86_64   docker://19.3.11
node02   Ready    &lt;none&gt;   22m   v1.19.5   192.168.116.102   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1062.el7.x86_64   docker://19.3.11
</code></pre></div><h4 id="安装ingress-controller"><a href="#安装ingress-controller" class="header-anchor">#</a> 安装Ingress Controller</h4> <p>快速初始化：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## 只在 master 节点执行</span>
kubectl apply -f https://kuboard.cn/install-script/v1.19.x/nginx-ingress.yaml
</code></pre></div><p>如果想使用其它的 Ingress Controller，卸载Ingress Controller的方式如下：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## 只在 master 节点执行</span>
kubectl delete -f https://kuboard.cn/install-script/v1.19.x/nginx-ingress.yaml
</code></pre></div><blockquote><p>如果打算将 Kubernetes 用于生产环境，请参考此文档 <a href="https://docs.nginx.com/nginx-ingress-controller/installation/installation-with-manifests/" target="_blank" rel="noopener noreferrer">Installing Ingress Controller (opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，完善 Ingress 的配置。</p></blockquote> <h3 id="高可用安装"><a href="#高可用安装" class="header-anchor">#</a> 高可用安装</h3> <h2 id="重启kubernetes集群"><a href="#重启kubernetes集群" class="header-anchor">#</a> 重启kubernetes集群</h2> <p>Kubernetes集群的设计目标是<strong>setup-and-run-forever</strong>，使用虚拟机学习，会出现反复重启集群所在虚拟机的情况。下面是重启后可能出现的问题的解释。</p> <p><a href="https://kuboard.cn/install/k8s-restart.html#worker%E8%8A%82%E7%82%B9%E4%B8%8D%E8%83%BD%E5%90%AF%E5%8A%A8" target="_blank" rel="noopener noreferrer">Worker节点不能启动<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Master 节点的 IP 地址变化，导致 worker 节点不能启动。请重装集群，并确保所有节点都有固定内网 IP 地址。</p> <p><a href="https://kuboard.cn/install/k8s-restart.html#%E8%AE%B8%E5%A4%9Apod%E4%B8%80%E7%9B%B4crash%E6%88%96%E4%B8%8D%E8%83%BD%E6%AD%A3%E5%B8%B8%E8%AE%BF%E9%97%AE" target="_blank" rel="noopener noreferrer">许多Pod一直Crash或不能正常访问<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl get pods --all-namespaces
</code></pre></div><p>重启后会发现许多 Pod 不在 Running 状态，此时，请使用如下命令删除这些状态不正常的 Pod。通常，您的 Pod 如果是使用 Deployment、StatefulSet 等控制器创建的，kubernetes 将创建新的 Pod 作为替代，重新启动的 Pod 通常能够正常工作。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl delete pod <span class="token operator">&lt;</span>pod-name<span class="token operator">&gt;</span> -n <span class="token operator">&lt;</span>pod-namespece<span class="token operator">&gt;</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MaLunan/press/edit/dev-mln/docs/kubernetes/kubernetes.md" target="_blank" rel="noopener noreferrer">在GitHub 上编辑此页！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">1/19/2021, 1:41:59 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fdd7a502.js" defer></script><script src="/assets/js/16.375b747e.js" defer></script><script src="/assets/js/29.775019f1.js" defer></script>
  </body>
</html>
