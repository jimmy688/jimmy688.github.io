<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Flink简介 | 个人博客 | JiiiiG</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="自是年少，韶华倾负">
    
    <link rel="preload" href="/assets/css/0.styles.420b7c1f.css" as="style"><link rel="preload" href="/assets/js/app.fdd7a502.js" as="script"><link rel="preload" href="/assets/js/16.375b747e.js" as="script"><link rel="preload" href="/assets/js/12.c5d97aa1.js" as="script"><link rel="prefetch" href="/assets/js/10.bbd38b9e.js"><link rel="prefetch" href="/assets/js/11.f49fc7d3.js"><link rel="prefetch" href="/assets/js/13.426d0224.js"><link rel="prefetch" href="/assets/js/14.1f257a58.js"><link rel="prefetch" href="/assets/js/15.be29bb6a.js"><link rel="prefetch" href="/assets/js/17.d02cdd8b.js"><link rel="prefetch" href="/assets/js/18.5d2371a4.js"><link rel="prefetch" href="/assets/js/19.038919a3.js"><link rel="prefetch" href="/assets/js/2.d6257727.js"><link rel="prefetch" href="/assets/js/20.b3582e09.js"><link rel="prefetch" href="/assets/js/21.0c1e826b.js"><link rel="prefetch" href="/assets/js/22.91bff1a5.js"><link rel="prefetch" href="/assets/js/23.faacea60.js"><link rel="prefetch" href="/assets/js/24.69816497.js"><link rel="prefetch" href="/assets/js/25.c9fcaa62.js"><link rel="prefetch" href="/assets/js/26.d28c3abe.js"><link rel="prefetch" href="/assets/js/27.1518da7d.js"><link rel="prefetch" href="/assets/js/28.748a5581.js"><link rel="prefetch" href="/assets/js/29.775019f1.js"><link rel="prefetch" href="/assets/js/3.141002a4.js"><link rel="prefetch" href="/assets/js/30.74e7c570.js"><link rel="prefetch" href="/assets/js/31.190b11f2.js"><link rel="prefetch" href="/assets/js/32.d8f4f116.js"><link rel="prefetch" href="/assets/js/33.c489bc81.js"><link rel="prefetch" href="/assets/js/34.db609d51.js"><link rel="prefetch" href="/assets/js/35.ad3402e6.js"><link rel="prefetch" href="/assets/js/36.45f11923.js"><link rel="prefetch" href="/assets/js/37.b47e0576.js"><link rel="prefetch" href="/assets/js/38.58b934a2.js"><link rel="prefetch" href="/assets/js/39.e4d6bcdf.js"><link rel="prefetch" href="/assets/js/4.e9b44388.js"><link rel="prefetch" href="/assets/js/40.555106bc.js"><link rel="prefetch" href="/assets/js/41.4387ceb1.js"><link rel="prefetch" href="/assets/js/42.9bd4aea0.js"><link rel="prefetch" href="/assets/js/43.587e7966.js"><link rel="prefetch" href="/assets/js/44.80285763.js"><link rel="prefetch" href="/assets/js/45.f978da77.js"><link rel="prefetch" href="/assets/js/46.d93e3f2e.js"><link rel="prefetch" href="/assets/js/47.c15bd2aa.js"><link rel="prefetch" href="/assets/js/48.cb55fa72.js"><link rel="prefetch" href="/assets/js/49.d0f4e454.js"><link rel="prefetch" href="/assets/js/5.b90b80cb.js"><link rel="prefetch" href="/assets/js/50.112e8260.js"><link rel="prefetch" href="/assets/js/51.a66bcd03.js"><link rel="prefetch" href="/assets/js/52.0c7cbfb1.js"><link rel="prefetch" href="/assets/js/53.67ef240b.js"><link rel="prefetch" href="/assets/js/54.2c2d082d.js"><link rel="prefetch" href="/assets/js/55.88f19a20.js"><link rel="prefetch" href="/assets/js/56.c726e920.js"><link rel="prefetch" href="/assets/js/57.eaee47c5.js"><link rel="prefetch" href="/assets/js/58.ac15a3ac.js"><link rel="prefetch" href="/assets/js/59.64bdc849.js"><link rel="prefetch" href="/assets/js/6.7eea74ff.js"><link rel="prefetch" href="/assets/js/7.a1370e98.js"><link rel="prefetch" href="/assets/js/8.2e898240.js"><link rel="prefetch" href="/assets/js/9.a2439994.js">
    <link rel="stylesheet" href="/assets/css/0.styles.420b7c1f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">个人博客 | JiiiiG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/linux/linux常用命令/01linux常用命令01.html" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/hadoop/01hadoop环境搭建/01搭建hadoop集群.html" class="nav-link">
  hadoop
</a></li><li class="dropdown-item"><!----> <a href="/hbase/hbase.html" class="nav-link">
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/flink/flink.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/flink/.html" class="nav-link">
  java
</a></li></ul></div></div> <a href="https://github.com/MaLunan/press" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/linux/linux常用命令/01linux常用命令01.html" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/hadoop/01hadoop环境搭建/01搭建hadoop集群.html" class="nav-link">
  hadoop
</a></li><li class="dropdown-item"><!----> <a href="/hbase/hbase.html" class="nav-link">
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/flink/flink.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/flink/.html" class="nav-link">
  java
</a></li></ul></div></div> <a href="https://github.com/MaLunan/press" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="flink简介"><a href="#flink简介" class="header-anchor">#</a> Flink简介</h2> <p>学习链接：<a href="https://github.com/flink-china/flink-training-course#18-flink-table-api-%E7%BC%96%E7%A8%8B" target="_blank" rel="noopener noreferrer">https://github.com/flink-china/flink-training-course#18-flink-table-api-%E7%BC%96%E7%A8%8B<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>学习链接2：https://ververica.cn/developers/special-issue/</p> <ul><li>Apache Flink® — Stateful Computations over Data dStreams</li> <li>Apache Flink 是一个分布式<strong>大数据处理引擎</strong>，可对<strong>有界数据流</strong>和<strong>无界数据流</strong>进行<strong>有状态</strong>的计算。Flink 能在所有常见集群环境中运行，并能以内存速度和任意规模进行计算</li> <li>官网地址：http://flink.apache.org</li></ul> <p><img src="/assets/img/flink.e32552e2.png" alt="flink"></p> <h5 id="_1-1-处理无界和有界数据"><a href="#_1-1-处理无界和有界数据" class="header-anchor">#</a> 1.1 处理无界和有界数据</h5> <p>任何类型的数据都可以形成一种事件流。信用卡交易、传感器测量、机器日志、网站或移动应用程序上的用户交互记录，所有这些数据都形成一种流。</p> <p>数据可以被作为==无界==或者==有界==流来处理。</p> <div class="language- extra-class"><pre class="language-text"><code>(1) 无界流 

有定义流的开始，但没有定义流的结束。它们会无休止地产生数据。无界流的数据必须持续处理，即数据被摄取后需要立刻处理。我们不能等到所有数据都到达再处理，因为输入是无限的，在任何时候输入都不会完成。处理无界数据通常要求以特定顺序摄取事件，例如事件发生的顺序，以便能够推断结果的完整性。

(2) 有界流 

==有定义流的开始，也有定义流的结束==。有界流可以在摄取所有数据后再进行计算。有界流所有数据可以被排序，所以并不需要有序摄取。有界流处理通常被称为批处理
</code></pre></div><p><img src="/assets/img/bounded-unbounded.d8ba1639.png" alt="bounded-unbounded"></p> <p><strong>Apache Flink 擅长处理无界和有界数据集</strong> 精确的时间控制和状态化使得 Flink 的运行时(runtime)能够运行任何处理无界流的应用。有界流则由一些专为固定大小数据集特殊设计的算法和数据结构进行内部处理，产生了出色的性能。</p> <p>通俗理解：<strong>处理无界流--》实时处理，处理有界流--》批处理，Flink既能实现实时处理也能实现批处理。</strong></p> <p>Flink的底层执行引擎是实时处理，为什么可以实现批处理？因为Flink把批处理看成实时处理的一个特例。</p> <h5 id="_1-2-部署应用到任意地方"><a href="#_1-2-部署应用到任意地方" class="header-anchor">#</a> 1.2 部署应用到任意地方</h5> <p>Apache Flink 是一个分布式系统，它需要计算资源来执行应用程序。Flink 集成了所有常见的集群资源管理器，例如 <a href="https://hadoop.apache.org/docs/stable/hadoop-yarn/hadoop-yarn-site/YARN.html" target="_blank" rel="noopener noreferrer">Hadoop YARN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、 <a href="https://mesos.apache.org/" target="_blank" rel="noopener noreferrer">Apache Mesos<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 和 <a href="https://kubernetes.io/" target="_blank" rel="noopener noreferrer">Kubernetes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，但同时也可以作为独立集群运行。</p> <div class="language- extra-class"><pre class="language-text"><code>	Flink 被设计为能够很好地工作在上述每个资源管理器中，这是通过资源管理器特定(resource-manager-specific)的部署模式实现的。Flink 可以采用与当前资源管理器相适应的方式进行交互。

	部署 Flink 应用程序时，Flink 会根据应用程序配置的并行性自动标识所需的资源，并从资源管理器请求这些资源。在发生故障的情况下，Flink 通过请求新资源来替换发生故障的容器。提交或控制应用程序的所有通信都是通过 REST 调用进行的，这可以简化 Flink 与各种环境中的集成
</code></pre></div><p>通俗理解：Flink跟spark一样，本质上都是一个计算框架或者计算逻辑，只需要给资源，就可以运行任务。</p> <h5 id="_1-3-运行任意规模应用"><a href="#_1-3-运行任意规模应用" class="header-anchor">#</a> 1.3 运行任意规模应用</h5> <p>Flink 旨在任意规模上运行有状态流式应用。因此，应用程序被并行化为可能数千个任务，这些任务分布在集群中并发执行。所以应用程序能够充分利用无尽的 CPU、内存、磁盘和网络 IO。而且 Flink 很容易维护非常大的应用程序状态。其异步和增量的检查点算法对处理延迟产生最小的影响，同时保证精确一次状态的一致性。</p> <div class="language- extra-class"><pre class="language-text"><code>Flink 用户报告了其生产环境中一些令人印象深刻的扩展性数字：
	每天处理数万亿的事件
	可以维护几TB大小的状态
	可以部署上千个节点的集群
</code></pre></div><h5 id="_1-4-利用内存性能"><a href="#_1-4-利用内存性能" class="header-anchor">#</a> 1.4 利用内存性能</h5> <p>有状态的 Flink 程序针对本地状态访问进行了优化。任务的==状态始终保留在内存中==，如果状态大小超过可用内存，则会保存在能高效访问的磁盘数据结构中。任务通过访问本地（通常在内存中）状态来进行所有的计算，从而==产生非常低的处理延迟==。Flink 通过定期和异步地对本地状态进行持久化存储来保证故障场景下精确一次的状态一致性。</p> <p><img src="/assets/img/local-state.c5cc889a.png" alt="local-state"></p> <h2 id="flink-的应用场景"><a href="#flink-的应用场景" class="header-anchor">#</a> Flink 的应用场景</h2> <div class="language- extra-class"><pre class="language-text"><code>  在实际生产的过程中，大量数据在不断地产生，例如金融交易数据、互联网订单数据、 GPS 定位数据、传感器信号、移动终端产生的数据、通信信号数据等，以及我们熟悉的网络 流量监控、服务器产生的日志数据，这些数据最大的共同点就是实时从不同的数据源中产生， 然后再传输到下游的分析系统。针对这些数据类型主要包括实时智能推荐、复杂事件处理、 实时欺诈检测、实时数仓与 ETL 类型、流数据分析类型、实时报表类型等实时业务场景，而 Flink 对于这些类型的场景都有着非常好的支持。
</code></pre></div><p>1、实时智能推荐</p> <div class="language- extra-class"><pre class="language-text"><code>	智能推荐会根据用户历史的购买行为，通过推荐算法训练模型，预测用户未来可能会购买的物品。对个人来说，推荐系统起着信息过滤的作用，对 Web/App 服务端来说，推荐系统起着满足用户个性化需求，提升用户满意度的作用。推荐系统本身也在飞速发展，除了算法 越来越完善，对时延的要求也越来越苛刻和实时化。利用 Flink 流计算帮助用户构建更加实 时的智能推荐系统，对用户行为指标进行实时计算，对模型进行实时更新，对用户指标进行 实时预测，并将预测的信息推送给 Wep/App 端，帮助用户获取想要的商品信息，另一方面也 帮助企业提升销售额，创造更大的商业价值。
</code></pre></div><p>2、复杂事件处理</p> <p>对于复杂事件处理，比较常见的案例主要集中于工业领域，例如对车载传感器、机械设 备等实时故障检测，这些业务类型通常数据量都非常大，且对数据处理的时效性要求非常高。 通过利用 Flink 提供的 CEP（复杂事件处理）进行事件模式的抽取，同时应用 Flink 的 Sql 进行事件数据的转换，在流式系统中构建实时规则引擎，一旦事件触发报警规则，便立即将 告警结果传输至下游通知系统，从而实现对设备故障快速预警监测，车辆状态监控等目的。</p> <p>3、实时欺诈检测</p> <p>在金融领域的业务中，常常出现各种类型的欺诈行为，例如信用卡欺诈、信贷申请欺诈等，而如何保证用户和公司的资金安全，是来近年来许多金融公司及银行共同面对的挑战。 随着不法分子欺诈手段的不断升级，传统的反欺诈手段已经不足以解决目前所面临的问题。 以往可能需要几个小时才能通过交易数据计算出用户的行为指标，然后通过规则判别出具有 欺诈行为嫌疑的用户，再进行案件调查处理，在这种情况下资金可能早已被不法分子转移， 从而给企业和用户造成大量的经济损失。而运用 Flink 流式计算技术能够在毫秒内就完成对 欺诈判断行为指标的计算，然后实时对交易流水进行规则判断或者模型预测，这样一旦检测 出交易中存在欺诈嫌疑，则直接对交易进行实时拦截，避免因为处理不及时而导致的经济损失。</p> <p>4、实时数仓与 ETL</p> <p>结合离线数仓，通过利用流计算诸多优势和 SQL 灵活的加工能力，对流式数据进行实时 清洗、归并、结构化处理，为离线数仓进行补充和优化。另一方面结合实时数据 ETL 处理能力，利用有状态流式计算技术，可以尽可能降低企业由于在离线数据计算过程中调度逻辑的 复杂度，高效快速地处理企业需要的统计结果，帮助企业更好地应用实时数据所分析出来的结果。</p> <p>5、流数据分析</p> <p>​	实时计算各类数据指标，并利用实时结果及时调整在线系统相关策略，在各类内容投放、 无线智能推送领域有大量的应用。流式计算技术将数据分析场景实时化，帮助企业做到实时化分析 Web 应用或者 App 应用的各项指标，包括 App 版本分布情况、Crash 检测和分布等， 同时提供多维度用户行为分析，支持日志自主分析，助力开发者实现基于大数据技术的精细 化运营、提升产品质量和体验、增强用户黏性。</p> <p>6、实时报表分析</p> <p>​	实时报表分析是近年来很多公司采用的报表统计方案之一，其中最主要的应用便是实时 大屏展示。利用流式计算实时得出的结果直接被推送到前端应用，实时显示出重要指标的变 换情况。最典型的案例便是淘宝的双十一活动，每年双十一购物节，除疯狂购物外，最引人 注目的就是天猫双十一大屏不停跳跃的成交总额。在整个计算链路中包括从天猫交易下单购 买到数据采集、数据计算、数据校验，最终落到双十一大屏上展现的全链路时间压缩在 5 秒以内，顶峰计算性能高达数三十万笔订单/秒，通过多条链路流计算备份确保万无一失。 而在其他行业，企业也在构建自己的实时报表系统，让企业能够依托于自身的业务数据，快速提取出更多的数据价值，从而更好地服务于企业运行过程中。</p> <h2 id="flink基本技术栈"><a href="#flink基本技术栈" class="header-anchor">#</a> Flink基本技术栈</h2> <p><img src="/assets/img/1563615522100.027191aa.png" alt="1563615522100"></p> <blockquote><p>在flink整个软件架构体系中。同样遵循着分层的架构设计理念，在降低系统耦合度的同时，也为上层用户构建flink应用提供了丰富且友好的接口。</p></blockquote> <ul><li>[ ] ==API &amp; libraries层==</li></ul> <div class="language- extra-class"><pre class="language-text"><code>作为分布式数据处理框架，fink同时提供了支撑流计算和批计算的接口，同时在此基础之上抽象出不同的应用类型的组件库。
如：基于流处理的CEP（复杂事件处理库）、SQL&amp;Table库、FlinkML(机器学习库)、Gelly(图处理库)

有流式处理API，批处理API。流式处理的支持事件处理，表操作。批处理的，支持机器学习，图计算，也支持表操作。
</code></pre></div><ul><li>[ ] ==Runtime核心层==</li></ul> <div class="language- extra-class"><pre class="language-text"><code>该层主要负责对上层的接口提供基础服务，也就是flink分布式计算的核心实现。flink底层的执行引擎。
</code></pre></div><ul><li>[ ] ==物理部署层==</li></ul> <div class="language- extra-class"><pre class="language-text"><code>该层主要涉及到flink的部署模式，目前flink支持多种部署模式：
本地 local
集群 standalone/yarn
云 GCE/EC2  谷歌云、亚马逊云
kubenetes
</code></pre></div><h2 id="flink基本架构"><a href="#flink基本架构" class="header-anchor">#</a> Flink基本架构</h2> <p><img src="/assets/img/flink运行原理.a141f4d8.png" alt="flink运行原理"></p> <p>Flink 整个系统主要由两个组件组成，分别为 JobManager 和 TaskManager，Flink 架构也遵循 Master-Slave 架构设计原则，JobManager 为 Master 节点，TaskManager 为 Worker（Slave）节点。所有组件之间的通信都是借助于Akka Framework，包括任务的状态以及 Checkpoint 触发等信息。</p> <p>Flink程序中的进程通信底层是Akka，它是基于scala语言开发的一个==轻量级的RPC通信框架==。</p> <p><strong>Client</strong></p> <div class="language- extra-class"><pre class="language-text"><code>	客户端负责将任务提交到集群，与 JobManager 构建 Akka 连接，然后将任务提交JobManager，通过和 JobManager 之间进行交互获取任务执行状态。客户端提交任务可以采用CLI 方式或者通过使用 Flink WebUI 提交，也可以在应用程序中指定 JobManager 的 RPC 网络端口构建 ExecutionEnvironment 提交 Flink 应用。
</code></pre></div><p><strong>JobManager</strong></p> <div class="language- extra-class"><pre class="language-text"><code>	JobManager 负责整个 Flink 集群任务的调度以及资源的管理，从客户端中获取提交的应用，然后根据集群中 TaskManager 上 TaskSlot 的使用情况，为提交的应用分配相应的 TaskSlot 资源并命令 TaskManager 启动从客户端中获取的应用。
	
	JobManager 相当于整个集群的 Master 节点，且整个集群有且只有一个活跃的 JobManager ，负责整个集群的任务管理和资源管理。
	
	JobManager 和 TaskManager 之间通过 Actor System 进行通信，获取任务执行的情况并通过 Actor System 将应用的任务执行情况发送给客户端。同时在任务执行的过程中，Flink JobManager 会触发 Checkpoint 操作，每个 TaskManager 节点 收到 Checkpoint 触发指令后，完成 Checkpoint 操作，所有的 Checkpoint 协调过程都是在 Fink JobManager 中完成。
	
	当任务完成后，Flink 会将任务执行的信息反馈给客户端，并且释放掉 TaskManager 中的资源以供下一次提交任务使用。
</code></pre></div><p><strong>TaskManager</strong></p> <div class="language- extra-class"><pre class="language-text"><code>	TaskManager 相当于整个集群的 Slave 节点，负责具体的任务执行和对应任务在每个节点上的资源申请和管理。客户端通过将编写好的 Flink 应用编译打包，提交到 JobManager，然后 JobManager 会根据已注册在 JobManager 中 TaskManager 的资源情况，将任务分配给有资源的 TaskManager节点，然后启动并运行任务。
	TaskManager 从 JobManager 接收需要部署的任务，然后使用 Slot 资源启动 Task，建立数据接入的网络连接，接收数据并开始数据处理。同时 TaskManager 之间的数据交互都是通过数据流的方式进行的。
	可以看出，Flink 的任务运行其实是采用多线程的方式，这和 MapReduce 多 JVM 进行的方式有很大的区别，Flink 能够极大提高 CPU 使用效率，在多个任务和 Task 之间通过 TaskSlot 方式共享系统资源，每个 TaskManager 中通过管理多个 TaskSlot 资源池进行对资源进行有效管理。
</code></pre></div><h2 id="flink的源码编译-了解"><a href="#flink的源码编译-了解" class="header-anchor">#</a> Flink的源码编译（了解）</h2> <p>我们可以对flink的源码进行编译，方便对我们各种hadoop的版本进行适配</p> <p>参见：https://blog.csdn.net/h335146502/article/details/96483310</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /kkb/soft
编译flink-shaded包
<span class="token function">wget</span>  https://github.com/apache/flink-shaded/archive/release-7.0.tar.gz
<span class="token function">tar</span> -zxvf flink-shaded-release-7.0.tar.gz -C /kkb/install/
<span class="token builtin class-name">cd</span> /kkb/install/flink-shaded-release-7.0/
mvn clean <span class="token function">install</span> -DskipTests -Dhadoop.version<span class="token operator">=</span><span class="token number">2.6</span>.0-cdh5.14.2

编译flink源码
<span class="token function">wget</span> http://archive.apache.org/dist/flink/flink-1.9.2/flink-1.9.2-src.tgz

<span class="token function">tar</span> -zxf flink-1.9.2-src.tgz -C /kkb/install/
<span class="token builtin class-name">cd</span> /kkb/install/flink-1.9.2/
mvn -T2C clean <span class="token function">install</span> -DskipTests -Dfast -Pinclude-hadoop -Pvendor-repos -Dhadoop.version<span class="token operator">=</span><span class="token number">2.6</span>.0-cdh5.14.2
</code></pre></div><h2 id="local模式安装-了解"><a href="#local模式安装-了解" class="header-anchor">#</a> Local模式安装（了解）</h2> <p>1、安装jdk，配置JAVA_HOME，建议使用jdk1.8以上</p> <p>2、安装包下载地址：</p> <p>https://mirrors.tuna.tsinghua.edu.cn/apache/flink/flink-1.9.2/flink-1.9.2-bin-scala_2.11.tgz</p> <p>3、直接上传安装包到服务器</p> <p>4、解压安装包并配置环境变量</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">tar</span> -zxf flink-1.9.2-bin-scala_2.11.tgz -C /kkb/install/

配置环境变量
<span class="token function">sudo</span> <span class="token function">vim</span> /etc/profile
<span class="token builtin class-name">export</span> <span class="token assign-left variable">FLINK_HOME</span><span class="token operator">=</span>/kkb/install/flink-1.9.2
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>:<span class="token variable">$FLINK_HOME</span>/bin:<span class="token environment constant">$PATH</span>
</code></pre></div><p>5、启动服务</p> <p>local模式，什么配置项都不需要配，直接启动服务器即可</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /kkb/install/flink-1.9.2
<span class="token comment">#启动flink</span>
bin/start-cluster.sh 
<span class="token comment">#停止flink</span>
bin/stop-cluster.sh 
</code></pre></div><p>6、Web页面浏览</p> <p>http://node01:8081</p> <h2 id="standalone模式安装"><a href="#standalone模式安装" class="header-anchor">#</a> Standalone模式安装</h2> <p>（1）集群规划</p> <table><thead><tr><th style="text-align:left;">主机名</th> <th style="text-align:right;">JobManager</th> <th style="text-align:center;">TaskManager</th></tr></thead> <tbody><tr><td style="text-align:left;">node01</td> <td style="text-align:right;">是</td> <td style="text-align:center;">是</td></tr> <tr><td style="text-align:left;">node02</td> <td style="text-align:right;">是</td> <td style="text-align:center;">是</td></tr> <tr><td style="text-align:left;">node03</td> <td style="text-align:right;"></td> <td style="text-align:center;">是</td></tr></tbody></table> <p>（2）依赖</p> <ul><li>jdk1.8以上，配置JAVA_HOME</li> <li>主机之间免密码</li></ul> <p>（3）安装步骤</p> <div class="language-shell extra-class"><pre class="language-shell"><code>node01修改以下配置文件

<span class="token punctuation">(</span>a<span class="token punctuation">)</span> 修改conf/flink-conf.yaml

<span class="token comment">#jobmanager地址</span>
jobmanager.rpc.address: node01
<span class="token comment">#使用zookeeper搭建高可用</span>
high-availability: zookeeper
<span class="token comment">##存储JobManager的元数据到HDFS</span>
high-availability.storageDir: hdfs://node01:8020/flink
high-availability.zookeeper.quorum: node01:2181,node02:2181,node03:2181


<span class="token punctuation">(</span>b<span class="token punctuation">)</span> 修改conf/slaves
node01
node02
node03

<span class="token punctuation">(</span>c<span class="token punctuation">)</span> 修改conf/masters
node01:8081
node02:8081


<span class="token punctuation">(</span>d<span class="token punctuation">)</span>上传flink-shaded-hadoop-2-uber-2.7.5-10.0.jar到flink的lib目录下
将flink-shaded-hadoop-2-uber-2.7.5-10.0.jar 这个jar包上传到flink的安装目录的lib下


<span class="token punctuation">(</span>e<span class="token punctuation">)</span> 拷贝到其他节点
<span class="token function">scp</span> -r /kkb/install/flink-1.9.2 node02:/kkb/install
<span class="token function">scp</span> -r /kkb/install/flink-1.9.2 node03:/kkb/install


<span class="token punctuation">(</span>f<span class="token punctuation">)</span>：node01<span class="token punctuation">(</span>JobMananger<span class="token punctuation">)</span>节点启动
<span class="token builtin class-name">cd</span> /kkb/install/flink-1.9.2
bin/start-cluster.sh

<span class="token comment">#jps</span>
<span class="token comment">#StandaloneSessionClusterEntrypoint--&gt;JobManager</span>
<span class="token comment">#TaskManagerRunner--&gt;TaskManager</span>

<span class="token punctuation">(</span>g<span class="token punctuation">)</span>：访问
http://node01:8081
http://node02:8081

<span class="token punctuation">(</span>h<span class="token punctuation">)</span>：关闭flink集群, 在主节点上执行
<span class="token builtin class-name">cd</span> /kkb/install/flink-1.9.2
bin/stop-cluster.sh
</code></pre></div><p>(4) StandAlone模式需要考虑的参数</p> <div class="language-sh extra-class"><pre class="language-sh"><code>jobmanager.heap.mb：     		jobmanager节点可用的内存大小
taskmanager.heap.mb：    		taskmanager节点可用的内存大小
taskmanager.numberOfTaskSlots：   每台taskmanager节点可用的cpu数量,TaskSlot可以理解为资源
parallelism.default：             默认情况下任务的并行度
taskmanager.tmp.dirs：            taskmanager的临时数据存储目录
</code></pre></div><ul><li>task slot是task manager上的计算资源。默认一个Taskmanager 只有一个slot,由参数taskmanager.numberOfTaskSlots控制，一般来说，taskmanager上的slot的数量跟该节点的cpu核数成正比，一个cpu核数对应一个task slot，它会处理一个task。</li></ul> <p>（5）可以给Flink配置环境变量：</p> <div class="language- extra-class"><pre class="language-text"><code>export FLINK_HOME=/kkb/install/flink-1.9.2
export PATH=:$FLINK_HOME/bin
</code></pre></div><h2 id="flink-on-yarn模式安装"><a href="#flink-on-yarn模式安装" class="header-anchor">#</a> Flink on Yarn模式安装</h2> <p><strong>==工作中可能不安装flink集群，会较多使用Flink on Yarn模式。==</strong></p> <ol><li>首先安装好Hadoop（yarn）</li> <li>上传一个flink的包到某一个节点，配置好hadoop的环境变量就可以了</li></ol> <p>flink on yarn有两种模式。</p> <h5 id="内存集中管理模式【yarn-session】"><a href="#内存集中管理模式【yarn-session】" class="header-anchor">#</a> 内存集中管理模式【Yarn Session】</h5> <p>在Yarn中初始化一个Flink集群，开辟指定的资源，之后我们提交的Flink Job都在这个Flink yarn-session中，也就是说不管提交多少个job，这些job都会共用开始时在yarn中申请的资源。==这个Flink集群会常驻在Yarn集群中，占用的资源不会释放==，除非手动停止。</p> <p><img src="/assets/img/yarn-session.1e107352.png" alt="1587522616288"></p> <h5 id="内存job管理模式【yarn-cluster-推荐使用】"><a href="#内存job管理模式【yarn-cluster-推荐使用】" class="header-anchor">#</a> 内存Job管理模式【yarn-cluster 推荐使用】</h5> <p>在Yarn中，每次提交job都会创建一个新的Flink集群，任务之间相互独立，互不影响并且方便管理。==任务执行完成之后创建的集群也会消失==。</p> <p><img src="/assets/img/yarn-cluster.adbfd1fc.png" alt="1587522665015"></p> <h5 id="yarn-session模式的任务提交"><a href="#yarn-session模式的任务提交" class="header-anchor">#</a> yarn-session模式的任务提交</h5> <p>【yarn-session.sh(开辟资源) + flink run(提交任务)】</p> <p>1、在flink目录启动yarn-session</p> <div class="language-shell extra-class"><pre class="language-shell"><code>bin/yarn-session.sh -n <span class="token number">2</span> -tm <span class="token number">1024</span> -s <span class="token number">1</span> -d

<span class="token comment">## -n 表示申请2个容器，</span>
<span class="token comment">## -s 表示每个容器启动多少个slot</span>
<span class="token comment">## -tm 表示每个TaskManager申请1024M内存</span>
<span class="token comment">## -d 表示以后台程序方式运行</span>
</code></pre></div><p>2、使用 flink 脚本提交任务</p> <div class="language-shell extra-class"><pre class="language-shell"><code>bin/flink run examples/batch/WordCount.jar <span class="token punctuation">\</span>
-input  hdfs://node01:8020/words.txt <span class="token punctuation">\</span>
-output hdfs://node01:8020/output/result.txt
</code></pre></div><p>3、停止任务</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> application -kill application_1587024622720_0001
</code></pre></div><p>yarn-session.sh 脚本参数</p> <div class="language-sh extra-class"><pre class="language-sh"><code>用法:  
 必选  
   -n,--container <span class="token operator">&lt;</span>arg<span class="token operator">&gt;</span>   分配多少个yarn容器 <span class="token punctuation">(</span><span class="token operator">=</span>taskmanager的数量<span class="token punctuation">)</span>  
 可选  
   -D <span class="token operator">&lt;</span>arg<span class="token operator">&gt;</span>                        动态属性  
   -d,--detached                   独立运行  
   -jm,--jobManagerMemory <span class="token operator">&lt;</span>arg<span class="token operator">&gt;</span>    JobManager的内存 <span class="token punctuation">[</span>in MB<span class="token punctuation">]</span>  
   -nm,--name                     在YARN上为一个自定义的应用设置一个名字  
   -q,--query                      显示yarn中可用的资源 <span class="token punctuation">(</span>内存, cpu核数<span class="token punctuation">)</span>  
   -qu,--queue <span class="token operator">&lt;</span>arg<span class="token operator">&gt;</span>               指定YARN队列.  
   -s,--slots <span class="token operator">&lt;</span>arg<span class="token operator">&gt;</span>                每个TaskManager使用的slots数量  
   -tm,--taskManagerMemory <span class="token operator">&lt;</span>arg<span class="token operator">&gt;</span>   每个TaskManager的内存 <span class="token punctuation">[</span>in MB<span class="token punctuation">]</span>  
   -z,--zookeeperNamespace <span class="token operator">&lt;</span>arg<span class="token operator">&gt;</span>   针对HA模式在zookeeper上创建NameSpace 
   -id,--applicationId <span class="token operator">&lt;</span>yarnAppId<span class="token operator">&gt;</span> YARN集群上的任务id，附着到一个后台运行的yarn    session中
</code></pre></div><h5 id="yarn-cluster模式的任务提交"><a href="#yarn-cluster模式的任务提交" class="header-anchor">#</a> yarn-cluster模式的任务提交</h5> <p>【flink run -m yarn-cluster (开辟资源+提交任务)】</p> <p>1、启动集群，执行任务</p> <div class="language-shell extra-class"><pre class="language-shell"><code>bin/flink run -m yarn-cluster -yn <span class="token number">2</span> -yjm <span class="token number">1024</span> -ytm <span class="token number">1024</span> <span class="token punctuation">\</span>
examples/batch/WordCount.jar <span class="token punctuation">\</span>
-input hdfs://node01:8020/words.txt <span class="token punctuation">\</span>
-output hdfs://node01:8020/output1

注意：client端必须要设置YARN_CONF_DIR或者HADOOP_CONF_DIR或者HADOOP_HOME环境变量，通过这个环境变量来读取YARN和HDFS的配置信息，否则启动会失败。
</code></pre></div><p>flink run  脚本参数</p> <div class="language-sh extra-class"><pre class="language-sh"><code>run <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> <span class="token operator">&lt;</span>jar-file<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>arguments<span class="token operator">&gt;</span>  
 <span class="token string">&quot;run&quot;</span> 操作参数:  
-c,--class <span class="token operator">&lt;</span>classname<span class="token operator">&gt;</span>  如果没有在jar包中指定入口类，则需要在这里通过这个参数指定  
-m,--jobmanager <span class="token operator">&lt;</span>host:port<span class="token operator">&gt;</span>  指定需要连接的jobmanager<span class="token punctuation">(</span>主节点<span class="token punctuation">)</span>地址，使用这个参数可以指定一个不同于配置文件中的jobmanager  
-p,--parallelism <span class="token operator">&lt;</span>parallelism<span class="token operator">&gt;</span>   指定程序的并行度。可以覆盖配置文件中的默认值。

默认查找当前yarn集群中已有的yarn-session信息中的jobmanager【/tmp/.yarn-properties-root】：
./bin/flink run ./examples/batch/WordCount.jar -input hdfs://hostname:port/hello.txt -output hdfs://hostname:port/result1

连接指定host和port的jobmanager：
./bin/flink run -m node01:1234 ./examples/batch/WordCount.jar -input hdfs://hostname:port/hello.txt -output hdfs://hostname:port/result1

启动一个新的yarn-session：
./bin/flink run -m yarn-cluster -yn <span class="token number">2</span> ./examples/batch/WordCount.jar -input hdfs://hostname:port/hello.txt -output hdfs://hostname:port/result1
注意：yarn session命令行的选项也可以使用./bin/flink 工具获得。它们都有一个y或者yarn的前缀
例如：./bin/flink run -m yarn-cluster -yn <span class="token number">2</span> ./examples/batch/WordCount.jar 

</code></pre></div><h5 id="flink-on-yarn集群部署"><a href="#flink-on-yarn集群部署" class="header-anchor">#</a> Flink on YARN集群部署</h5> <p>(1) flink on yarn运行原理</p> <p><img src="/assets/img/flink运行原理.a141f4d8.png" alt="flink运行原理"></p> <p><img src="/assets/img/FlinkOnYarn.6965b495.png" alt="FlinkOnYarn"></p> <p>其实==Flink on YARN部署很简单，就是只要部署好hadoop集群即可，我们只需要部署一个Flink客户端，然后从flink客户端提交Flink任务即可==。类似于spark on yarn模式。</p> <h2 id="flink入门案例演示"><a href="#flink入门案例演示" class="header-anchor">#</a> Flink入门案例演示</h2> <h5 id="案例1-实时需求分析"><a href="#案例1-实时需求分析" class="header-anchor">#</a> 案例1：实时需求分析</h5> <p>案例需求：实时统计每隔1秒统计最近2秒单词出现的次数</p> <h6 id="创建maven工程"><a href="#创建maven工程" class="header-anchor">#</a> 创建maven工程</h6> <div class="language-xml extra-class"><pre class="language-xml"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>flink.version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>flink.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scala.version</span><span class="token punctuation">&gt;</span></span>2.11.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scala.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-streaming-java_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-streaming-scala_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.scala-lang<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>scala-library<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.11.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sourceDirectory</span><span class="token punctuation">&gt;</span></span>src/main/scala<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sourceDirectory</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>testSourceDirectory</span><span class="token punctuation">&gt;</span></span>src/test/scala<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>testSourceDirectory</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.alchim31.maven<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>scala-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.2.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>testCompile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>args</span><span class="token punctuation">&gt;</span></span>
                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span><span class="token punctuation">&gt;</span></span>-dependencyfile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span><span class="token punctuation">&gt;</span></span>${project.build.directory}/.scala_dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>args</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-shade-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.4.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>shade<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filters</span><span class="token punctuation">&gt;</span></span>
                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">&gt;</span></span>
                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifact</span><span class="token punctuation">&gt;</span></span>*:*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifact</span><span class="token punctuation">&gt;</span></span>
                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">&gt;</span></span>
                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>META-INF/*.SF<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>META-INF/*.DSA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>META-INF/*.RSA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">&gt;</span></span>
                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filters</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transformers</span><span class="token punctuation">&gt;</span></span>
                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transformer</span> <span class="token attr-name">implementation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.apache.maven.plugins.shade.resource.ManifestResourceTransformer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mainClass</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mainClass</span><span class="token punctuation">&gt;</span></span>
                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transformer</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transformers</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
        
</code></pre></div><h6 id="实时代码开发-scala版本"><a href="#实时代码开发-scala版本" class="header-anchor">#</a> 实时代码开发（scala版本）</h6> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>

<span class="token keyword">object</span> FlinkStream <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//构建流处理的环境</span>
    <span class="token keyword">val</span> env<span class="token operator">:</span>StreamExecutionEnvironment<span class="token operator">=</span>StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token comment">//从socket获取数据</span>
    <span class="token keyword">val</span> sourceStream<span class="token operator">:</span>DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token operator">=</span>env<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//导入隐式转换的包，使用scala开发Flink程序时，这步是必要的</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token comment">//对数据进行处理</span>
    <span class="token keyword">val</span> result<span class="token operator">=</span>sourceStream
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//按照空格切分</span>
      <span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//每个单词计为1</span>
      <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//按照下标为0的单词进行分组,0表示元组的第一位(下标为0）</span>
      <span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">//按照下标为1累加相同单词出现的次数</span>

    result<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//开启任务</span>
    env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;FlinkStream&quot;</span><span class="token punctuation">)</span> <span class="token comment">//随便取个名字即可</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h6 id="本地运行"><a href="#本地运行" class="header-anchor">#</a> 本地运行</h6> <p>1、启动socket服务</p> <div class="language- extra-class"><pre class="language-text"><code>nc -lk 9999
</code></pre></div><p>2、启动flink程序</p> <p>3、发送 socket 数据</p> <p>发送第一次数据：</p> <div class="language-java extra-class"><pre class="language-java"><code>hadoop flink

<span class="token comment">//结果显示为：</span>
    <span class="token number">6</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>hadoop<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">//前面打印的数字表示处理task的线程的id编号，默认有8个线程</span>
	<span class="token number">5</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>flink<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>发送第二次数据：</p> <div class="language-java extra-class"><pre class="language-java"><code>hadoop flink spark

<span class="token comment">//结果显示为：</span>
	<span class="token number">1</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>spark<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token number">6</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>hadoop<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token number">5</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>flink<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><p>从两次发送数据后的输出结果可以看到，flink程序能够把之前的数据累加起来，如（hadoop,1) 变成了（hadoop,2),这个就是flink的定义中的有状态，中间结果被保存起来的。</p> <h6 id="集群运行"><a href="#集群运行" class="header-anchor">#</a> 集群运行</h6> <p>程序还可以打成jar包提交到yarn中运行</p> <p>1、打成jar包，并上传到任意一台服务器，本次以node02为例：</p> <div class="language-java extra-class"><pre class="language-java"><code>cd <span class="token operator">/</span>kkb<span class="token operator">/</span>soft
rz  
    <span class="token comment">//original-MyFlink-1.0-SNAPSHOT.jar</span>
</code></pre></div><p>2、开启netcat服务</p> <div class="language- extra-class"><pre class="language-text"><code>nc -lk 9999
</code></pre></div><p>3、运行jar包</p> <div class="language-sh extra-class"><pre class="language-sh"><code>//flink run -m yarn-cluster -yn <span class="token number">2</span> -yjm <span class="token number">1024</span> -ytm <span class="token number">1024</span> -c com.kaikeba.demo1.FlinkStream //original-flink_study-1.0-SNAPSHOT.jar 

<span class="token punctuation">[</span>hadoop@node02 soft<span class="token punctuation">]</span>$ flink run -m yarn-cluster -yn <span class="token number">2</span> -yjm <span class="token number">1024</span> -ytm <span class="token number">1024</span> -c com.Flink.demo.FlinkStream original-MyFlink-1.0-SNAPSHOT.jar
    
//记得配置好flink的环境变量
//运行jar包的时候，出了不少错，如下：
    <span class="token number">1</span>、-yjm <span class="token number">1024</span>  //给yjm分配的内存大小默认不能小于600M
    <span class="token number">2</span>、-ytm <span class="token number">1024</span>  //给ytm分配的内存大小默认不能小于600M
//运行jar包的时候，要耐心等待，很可能出现不停打印 - Deployment took <span class="token function">more</span> than <span class="token number">60</span> seconds. Please check <span class="token keyword">if</span> the requested resources are available <span class="token keyword">in</span> the YARN cluster的情况，多等会就行了
//出现Could not retrieve the execution result.等错误时，可以尝试重启一下netcat服务。nc -lk <span class="token number">999</span>
</code></pre></div><p>4、登录node01:8088查看yarn上运行的任务：</p> <p><img src="/assets/img/image-20200503170027139.99c9e36b.png" alt="image-20200503170027139"></p> <p>5、点击ApplicationMaster即可跳转到Flink界面：</p> <p><img src="/assets/img/image-20200503170346189.4aa51365.png" alt="image-20200503170346189"></p> <p><img src="/assets/img/image-20200503170211963.dc2d4a58.png" alt="image-20200503170211963"></p> <h6 id="实时代码开发-java版本"><a href="#实时代码开发-java版本" class="header-anchor">#</a> 实时代码开发（java版本）</h6> <p>代码开发</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo1</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">FlatMapFunction</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * java代码开发实时统计每隔1秒统计最近2秒单词出现的次数
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowWordCountJava</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token comment">//步骤一：获取流式处理环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//步骤二：获取socket数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sourceDstream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//步骤三：对数据进行处理</span>
        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WordCount</span><span class="token punctuation">&gt;</span></span> wordAndOneStream <span class="token operator">=</span> sourceDstream<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlatMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">WordCount</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">String</span> line<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WordCount</span><span class="token punctuation">&gt;</span></span> collector<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> words <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> word <span class="token operator">:</span> words<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    collector<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WordCount</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WordCount</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> wordAndOneStream
      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token string">&quot;word&quot;</span><span class="token punctuation">)</span>  <span class="token comment">//按照单词分组</span>
      <span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//每隔1s统计2s的数据</span>
      <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//按照count字段累加结果</span>

  <span class="token comment">//步骤四：结果打印</span>
  resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//步骤五：任务启动</span>
  env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">&quot;WindowWordCountJava&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WordCount</span><span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> word<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">long</span> count<span class="token punctuation">;</span>
        <span class="token comment">//记得要有这个空构建</span>
        <span class="token keyword">public</span> <span class="token class-name">WordCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token class-name">WordCount</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">,</span><span class="token keyword">long</span> count<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>word <span class="token operator">=</span> word<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;WordCount{&quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;word='&quot;</span> <span class="token operator">+</span> word <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                    <span class="token string">&quot;, count=&quot;</span> <span class="token operator">+</span> count <span class="token operator">+</span>
                    <span class="token string">'}'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>发送socket数据</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#在node01上执行命令，发送数据</span>
<span class="token function">nc</span> -lk <span class="token number">9999</span>
</code></pre></div><h5 id="案例2-离线需求分析"><a href="#案例2-离线需求分析" class="header-anchor">#</a> 案例2：离线需求分析</h5> <div class="language- extra-class"><pre class="language-text"><code>对文件进行单词计数，统计文件当中每个单词出现的次数。
</code></pre></div><h6 id="离线代码开发-scala"><a href="#离线代码开发-scala" class="header-anchor">#</a> 离线代码开发（scala）</h6> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo1</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span> DataSet<span class="token punctuation">,</span> ExecutionEnvironment<span class="token punctuation">}</span>

<span class="token comment">/**
  * scala开发flink的批处理程序
  */</span>
<span class="token keyword">object</span> FlinkFileCount <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

     <span class="token comment">//todo:1、构建Flink的批处理环境</span>
    <span class="token keyword">val</span> env<span class="token operator">:</span> ExecutionEnvironment <span class="token operator">=</span> ExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token comment">//todo:2、读取数据文件</span>
    <span class="token keyword">val</span> fileDataSet<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span>readTextFile<span class="token punctuation">(</span><span class="token string">&quot;e:\\words.txt&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;GBK&quot;</span><span class="token punctuation">)</span>

     <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">//todo: 3、对数据进行处理</span>
      <span class="token keyword">val</span> resultDataSet<span class="token operator">:</span> AggregateDataSet<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> fileDataSet
                                                <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                                <span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                                <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                                                <span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment">//todo: 4、打印结果</span>
        resultDataSet<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//todo: 5、保存结果到文件</span>
       resultDataSet<span class="token punctuation">.</span>writeAsText<span class="token punctuation">(</span><span class="token string">&quot;e:\\result&quot;</span><span class="token punctuation">)</span>

       env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;FlinkFileCount&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="flink并行度-slot-task"><a href="#flink并行度-slot-task" class="header-anchor">#</a> Flink并行度&amp;Slot&amp;Task</h2> <p>​	Flink的每个TaskManager为集群提供slot。==每个task slot代表了TaskManager的一个固定大小的资源子集==。 slot的数量通常与每个TaskManager节点的可用CPU内核数成比例。==一般情况下你的slot数是你每个节点的cpu的核数==。</p> <p><img src="/assets/img/1587211958715.51687216.png" alt="1587211958715"></p> <h4 id="并行度"><a href="#并行度" class="header-anchor">#</a> 并行度</h4> <p>一个Flink程序由多个任务组成(source、transformation和 sink)。 一个任务由多个并行的实例(线程)来执行， 一个任务的并行实例 (线程) 数目就被称为该任务的并行度。</p> <h4 id="并行度的设置"><a href="#并行度的设置" class="header-anchor">#</a> 并行度的设置</h4> <ul><li>一个任务的并行度设置可以从多个级别指定
<ul><li>Operator Level（算子级别）</li> <li>Execution Environment Level（执行环境级别）</li> <li>Client Level（客户端级别）</li> <li>System Level（系统级别）</li></ul></li> <li>这些并行度的优先级为
<ul><li>Operator Level &gt; Execution Environment Level &gt; Client Level &gt; System Level</li></ul></li></ul> <h6 id="_1、算子级别"><a href="#_1、算子级别" class="header-anchor">#</a> 1、算子级别</h6> <p>直接在算子后面设置即可，如下图，sum(1).setParallelism(5)--&gt;设定sum()算子的并行度为5。</p> <p>注意：keyBy等涉及宽依赖，会产生shuffle，这里说的算子不包括keyBy这些。</p> <img src="flink.assets/1574472860477.png" alt="1574472860477" style="zoom:150%;"> <h6 id="_2、执行环境级别"><a href="#_2、执行环境级别" class="header-anchor">#</a> 2、执行环境级别</h6> <img src="flink.assets/1574472880358.png" alt="1574472880358" style="zoom:150%;"> <h6 id="_3、客户端级别"><a href="#_3、客户端级别" class="header-anchor">#</a> 3、客户端级别</h6> <p>并行度可以在客户端将job提交到Flink时设定，对于CLI客户端，可以通过-p参数指定并行度</p> <div class="language-shell extra-class"><pre class="language-shell"><code>bin/flink run -p <span class="token number">10</span> examples/batch/WordCount.jar
</code></pre></div><h6 id="_4、系统级别"><a href="#_4、系统级别" class="header-anchor">#</a> 4、系统级别</h6> <p>在系统级可以通过设置flink-conf.yaml文件中的parallelism.default属性来指定所有执行环境的默认并行度</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">parallelism.default</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre></div><h4 id="并行度操作演示案例1"><a href="#并行度操作演示案例1" class="header-anchor">#</a> 并行度操作演示案例1</h4> <p>为了方便在本地测试观察任务并行度信息，可以在本地工程添加以下依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-runtime-web_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>注意：<strong>获取程序的执行环境的方式发生变化了，改为使用createLocalEnvironmentWithWebUI()来获取执行环境</strong>。</p> <div class="language-Scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamExecutionEnvironment

<span class="token comment">/**
  * 本地调试并行度
  */</span>
<span class="token keyword">object</span> TestParallelism <span class="token punctuation">{</span>
    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        
        <span class="token comment">//使用createLocalEnvironmentWithWebUI方法，构建本地流式处理环境</span>
     	<span class="token comment">//createLocalEnvironmentWithWebUI()可以让你创建一个基于本地运行的web界面</span>
        <span class="token keyword">val</span> env<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>createLocalEnvironmentWithWebUI<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//执行环境级别</span>
    	<span class="token comment">//environment.setParallelism(4)</span>
       
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
		
        <span class="token comment">//接受socket数据</span>
        <span class="token keyword">val</span> sourceStream <span class="token operator">=</span> env<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> countStream <span class="token operator">=</span> sourceStream
            <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        countStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
        env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>观察<strong>localhost:8081</strong>界面</p> <p><img src="/assets/img/image-20200504045731365.489727c5.png" alt="image-20200504045731365"></p> <p><img src="/assets/img/image-20200504052308274.fe37ee2d.png" alt="image-20200504052308274"></p> <p><img src="/assets/img/image-20200504052335480.2759345d.png" alt="image-20200504052335480"></p> <p>可以发现，没有手动设置并行度时，本次程序的运行一共有13个task，其中source为1个（默认为1个），FlatMap--&gt;Map为6个，aggregation--&gt;sink:print to Std:Out为6个，为6个的原因是因为我们的电脑是六核处理器，所以local运行模式时，默认使用6个。</p> <h4 id="并行度操作演示案例2"><a href="#并行度操作演示案例2" class="header-anchor">#</a> 并行度操作演示案例2</h4> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamExecutionEnvironment

<span class="token keyword">object</span> TestParallelism <span class="token punctuation">{</span>
    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> env<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>createLocalEnvironmentWithWebUI<span class="token punctuation">(</span><span class="token punctuation">)</span>
        env<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
        
        <span class="token keyword">val</span> sourceStream <span class="token operator">=</span> env<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> countStream <span class="token operator">=</span> sourceStream
            <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        countStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
        env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>观察<strong>localhost:8081</strong>界面</p> <p><img src="/assets/img/image-20200504054551718.657a4178.png" alt="image-20200504054551718"></p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA+MAAADhCAYAAACjpGRGAAAgAElEQVR4nO3df1DU973v8Vdvo0ZPC1YwUSO2gnavYsasKUjlVvSEs9a0UBOVEEnC1fbo3RiOpNEao0dGR+PxEBO8Bqm2JUMj1hI9WkhDpfQozGANZLqmQQkxkN5gjQmrFWLjKHW8f+wCu7DggvpZkOdjxhn47vfHe3eH9fP6fn7sl65fv35dAAAAAADAmP8R6AIAAAAAABhoCOMAAAAAABhGGAcAAAAAwDDCOAAAAAAAhhHGAQAAAAAwjDAOAAAAAIBhhHEAAAAAAAwjjAMAAAAAYBhhHAAAAAAAwwjjAAAAAAAYRhgHAAAAAMAwwjgAAAAAAIYRxgEAAAAAMIwwDgAAAACAYYRxAAAAAAAMI4wDAAAAAGAYYRwAAAAAAMMI4wAAAAAAGEYYBwAAAADAMMI4AAAAAACGEcYBAAAAADCMMA4AAAAAgGGEcQAAAAAADCOMAwAAAABgGGEcAAAAAADD7urNQf/9/251GQAGgn/+eqArAADAf+98IjVfDXQVAPqbafdKw+++8X69CuP2Yqn5Sm+OBDBQvRwf6AoAAOi5lEOBrgBAf1OzzL/9ehXGJWnhJMk6qrdHAxhIXjgS6AoAAOi99d+R7u51qxnAQPHXz6Xsd/zf/6Y+VkKG3szRAAaCq9cCXQEAADePdi+AG/nr5z3bnwXcAAAAAAAwjDAOAAAAAIBhhHEAAAAAAAwjjAMAAAAAYBhhHAAAAAAAwwjjAAAAAAAYRhgHAAAAAMAwwjgAAAAAAIYRxgEAAAAAMIwwDgAAAACAYYRxAAAAAAAMI4wDAAAAAGAYYRwAAAAAAMMI4wAAAAAAGEYYBwAAAADAMMI4AAAAAACGEcYBAAAAADCMMA4AAAAAgGGEcQAAAAAADCOMAwAAAABgGGEcAAAAAADDCOMAAAAAABhGGAcAAAAAwDDCOAAAAAAAhhHGAQAAAAAwjDAOAAAAAIBhhHEAAAAAAAwjjAMAAAAAYBhhHAAAAAAAwwjjAAAAAAAYRhgHAAAAAMAwwjgAAAAAAIYRxgEAAAAAMIwwDgAAAACAYYRxAAAAAAAMI4wDAAAAAGAYYRwAAAAAAMMI4wAAAAAAGEYYBwAAAADAMML4Ha75SJrsNouKawJdCQAAAPxWkyO7zaLdR5yBrgTAbXJXoAvo5JpTtW/uVNl/l8lRc0aSFDrJprnP7tCMbwS4tlvs8l9KdPRAvqqqjuuTC5JGRMgyZ7WWLY7T0EAX11t/O66yPfmq/FOJ6v8qSWMVPtOuJ9ct0KhA1wYAANBXOIu0e9FKOTo9kK5VJXaFm7r2nB16+Tmbj7Zns05si9Kuw4ZqAgagPhbGz6hq22PKLZVGz07U/P81UpL0xbnj+uJqgEu7xVpqcvTqiizV3xenWXNXa8YwSWrUuXNX1CL1rTB+tkwHfpWry1Hb9MTM0K73+7RIr61YqUpFKDp+tazBktSs89XNanHvcrkmX4UHihQyf5/iJxmoHQAAoC+LTtH8qWM9NkQouNcnO6Pqn+eo9FKclqTbFOTPIYf3y/G4TTPGdNh+tkQVh3tdCAA/9K0wXlei35c6FfavB/XCwskeDywJWEm3R7NqS7NUrwValrVZD/T+E9eMplMqPXxc1mnd79ZQkavKC5M1P+eg4iM8HljY/mPLueM6Wu5Q4vzbUikAAED/MilB8Qutt+hkjWoo2K/amTH+7T7TJmt5iSrfPaMZY8Z6PdRwPF/VI2yyTiqRo+IWlQfAS9+aMz40SMMkNTe196T6dKlOJ/LXKnOxRXabRc8vW6pf/8ahyx671OdbZLelqcpzmk2nuTcOFdsssm/K14nfrNTGZIvs+e7BQtecqn1jrbKWxbqvkarCqub2c/3tuEq3JevfbRbZkx9W9s+LdK61AGeJ9iy2KHPfqS6exxANGipJjfri792/JM3v5uvXGQ/reZtFdttDytyWoxMNV3zsl6s9P3Hvl/ywsl4r83o92lx2qHiFRfYVG1X9afvrWfXzpa7nb3tImdtyVd/k8TquyHK9Wltiu527NGxokKTP1NTUuT7JqapNFq3eUiJJKlxh8ZjL3s370E1tktTiPK6yHa2PW/TvK9aqtNrjfWp7z+vU0Hru5Ie153CdWtSs+jfat732m67eLwAAgMC7XFek4tb2py1WGzO2qqq1XViTI7stWYWSVL5Sq20W2TcVqbm7E45PUPQcqbawRA1eD5xS7e9PKWx+gqxf7nhQsxqO5GjPiodk99UOdrf57LYc1V86pbIt7vbp4qU6cKSOthbgoW+F8TE2xc8bq6aCVG3clKMTdT4+Pi47VLz2Ye0qOqPR83YoPXOH5k66Ikd2sl7Nd/TuD7x8o35/KUWr9tUqJ8UqXT2l0jU/UNbPjmtY1LNalpmn5Icj1HLVPVb+0yK9Zk9V2WWb5mfmKT0tQSpdqawdJd4feJeb9Q+fFxwiy+z1sowo0+s/TtWe3xxXs49h+OePrNSLqzaqelCC5m/O0/I1CxRcnaVdq9aqqjVI64oa3kjVi6u2qjYoTokZeUpPS9Hoa1d8vBZnVLXjGRV+mqAlL6zXlHvbX88DH0Qo/rk8pW+2a9zHW5W5PkcNV6XRM/OU/m8LJEmWlB1Kz8zT3Pu/6vNZhcxYoln3OVX6/MPanV+ihibPR78qS1KelqW47tTG/lue0jPzZPUcEtXxfbhBbZJ0+b0i1Q61KXFNntI3b9YU7deBH6/UsbPetTkPbVTxZZseS1st69A6VWxbqT3/uVaFF2L06HObNeveOlVm/6uK3/V1IwEAACDwPqnar/PjUvRYZp7SM55QSG2uclflqPaqpDE2pWeuV6wkPWjXssw8pSd9+wZTH0cqMt6u4LpfyOHRBmp5t0SldXGaFetrWGSdqovPaNS89UrPzNOyeWPVULBSWfuOd2h7OlS8LUtNMau1OGO9YkeeVOmWp/Rfx7u9PQAMKH1rmLqCNOXpg8qYlKN9u7K0y56l4AeWKPm51XrgXtce58tzVFgTqvj/2K3504ZIkixTYxR8LUq78nJ1Ys4ORXUzrdm3JUpcaG37sDp/JEsHTkjRa/K0eLZ7yM7UGD0gSbqi2rf+Q5VfW60X1i1RmCQpRqHNx7XulXxVP2HTjDE2PfFabfeXjEhRek6ESrPX6kB2qiqyx8q6fIee/MFkVx1Xj6tiV5Gaojdr07oFCnFfZ8q4IXrRvlUHSlMUlWKVzhap8GfHpfiXlP6ThLb9LLGuy7R/3F1Rff5K5ZaGKXH7ZkV5vZ4LtOyN1W3D5cO/XKejz2epsnqJ5k+LkeWSq5d62Lhpskzt5sUNjtNjO95SeP5GHchL04t5obLMz9CTP7Ip5MtDFPTNGIX/NV+SFBIRI0unOeMd3ocb1BY2bYiCZm/W0tntZ3A9nquGj5ulMe0zpRosS7QqOU6DJIUPbZTj+VxVNqdo009cr+2UrzTKsSJL1XV1SpzqOUUCAADgNspLlj3P4/fUfa5OCR/Ck/M8FlFrbX+WqaEhXZaICFmmNqtekv4pQuFTY/yaMz5oqk3xETk6UFqmf5lq01A162Rpjprm7JB1jFTd6Qir5v6nR31Tx+qLdx/S65WndG5xjLttLEmNsjzRPnXRMmWktDBNR6scSozpx4sVA7dQHwvjkhSkUbNXKz32h6o/8gsVvparXSsatWT7S4q616mGd8sk2WV1B/HWY8Kn2aTDJXI2SuppGJ85WaMHt/7SrE8+KJO0RDNix/rYuU71h53Sha160ba106NNTZI6LoDRla/FKH7dHxTbUKaKvI06kP2Imi7tU3qKVYP+4tCxC5J1Vow7YLtFWGWVVPjRGTXLqkEfn1K1pPh4m/d+HTQUrVVZaYOi1/xacye1vnatr6e0a+H+Tsecb/pc0pBO27v1lQhFLcvTA/MdqjqQpcIDacpsekmr2m4UdMPrffCztktnVF1RotrqMjV82qhzJ+okSU2XvYcaWCdFapD750FDXf81WWI9XtuRYxUuyXGZnnEAAGBQxwXcwkZ2ve/fHKoqL1P9ew590nhGte5vHmq5qYWOJ8s6L04HtrkXclOJKg6Ham5mnIbqc59HNNcUyVHpUO37dWo6d9z9DTodR2XaFO65hlDwZFlipYqKU3KmxXmEdmDg6oNh3G1wqMLnrFb6/RHK/t9rlfu7FEWlmvizvarLTZI0RIMG+3r8inRBUuxmZTxn67Ta5V29uM03NCxO8eveUtjP/1lZebk6Eb9DUX4e23K5UZI0aHD3oTn4vgiFqEjOs41q0di2YOr68LZr+X8tUUTHgwb7tQanT4NCrZqxLE+WcUu17pWVqng4QYlTenaOG9Z29ZSK1z6iQi1QcpJdU0aN1bgL+/XjtTl+nX/Y3Xf3rCAAAIBbzd8F3Jwleu2ZNNVa7Jr/fbuiRk3QsOoN2vBKyU2XEBKzQLFKU+W7dQq7lK/qiB8qceoQyUcYby5fqRc3/VFhjz+vuOQEhY4LUv3/fViv33CRt2Y1nZM0fqSG3XTFwJ2hb80Z/6BEx/7SYR7JPwW5Am/LFbUoVCETJksqU3W1Zw/mFX1cUyJpgUa7e6WD77VJKtHHH7fv13zulB9FhGrU5MmS3pDjT756SSMUliCpokwNfw/S0K94/xvUaZELX5yqPlym5mue24ZoWPA9kprVck3SmMmySnIcd+i8524Np1QrKcwSoSBJQeOsCpN07HjHeTregqbZtWRNgs7nJSurbW5963MtU/1fhnR6LkN93ozoWkP5fp275L1tWJDr7m7L1Z72OPtRW12ZCmsk67xnFRcbI0vEWLVcquvhdQAAAPq+5veKVHlBiktOV1RUjMLDQvXFhT/dmpMHxynq8VDVFq7VvgOnNGWerYuea6dqy4vUpCc0d3GCpky1atTXmtVU42tfh855ruFz9pRq66Tgb4717yvXgAGgb/WMX6vT60s3qHR2omZMGCl9cUa1R/NVLasSY60aJCnsoXTNKlqq4k1L1fx4iqK+IZ07kq/it0JlWZ7SNrc4ZLxVYSpRad5GhV5OULCzSEd/5d8HVthD6ZpVsFSlzz+s86npmjElSJc/KNPHY57W/NhQWeakK7woS7nPp8n51AKFjxiiy+fK5Ph7ghY/Otm1mvqqNH0y56DSkye39UJ7uly1VKv3xWnWrBiFDJOaPtyvqiN1Co5/SZYxkhSnGctj5MheqaxNZ5Q4x6qhlxw69sss1d6XouU297zmiAVKTPiFsgtStfFcunu/UzpZN1Zzf2TzumbI7M1aevaMMvOe0Z4xv9bi2WMVNtOu6II0j9czSC0X2o8PkqTgkbJIchzaqWNfsUr6tmb4mJjf0rBWL+7MVXT8AoUFu74fvqqoTJqULqt7aPzQYNcwrLJ9ORr9/SApOEUPfLOL9+FGtQ0eojBJ9cV7VDUiRkPPlanqD41+vccAAAD9yaChrg6OY2/lK+xqhP7xwX5VVN4jyfNbbkYq+EFJ5fkqPhykcEmWOXF+hN8hssz8ocJ+tVX1itOT9/uaqilJgzU0WJL269hvJqvlG1fU8NZ+VX9NrpGjXk6qMGutWn6QoJCrrjZsteL05JwYn21jYCDqWz3j37BpWeosBf2lUAd+tlUHio+rZUq6lu3e3T7POThOj2XtU3LsENX/Kk1Zq9JU+tFYxWX8Ust/4LHwVkSKlqxZoinN+7Vvw1pVNMYo+bkn/KsjOE6P7dqn5IQInStaqexVL6i46opCR7lWER/0TbueeXWzZo2rU9mWpcpa9ZwK/9CsURH3eJ+ny9XUQzVl3nrNimhWdf5WHfjZVp04FyHr8jy98Fz73OqwH+xWeka6LI37lbs2Vdm7itQybb1WZa3XlLbx8UGaklasVctTNKphj3LXpmrPvjK1jBrrY2GMIQp/dLUSJzlVuWWlimuuSKE2Ld6+W4lRV1SbnaasVan69SGHFOZx/JgEzV+eoNGf5uv1bTn6RL67zMNm7lBi1Eg1lLqe07HqK7Kk7lDGZrvC3ScbNC1Fy5PiNOiPWdq1s0xfdNf7fqPaIlK05LkUhTTmKHfVWpU1xCjxqbhuTggAANA/DY1JV3pqnAZVbVT2lo1yDF6i+fM6huaxivrRekWPb9DRbS+ouEH+B98Im2ZFS5qzwPvbbrwEacpTeUr89hBVZy/VaztLNChptWbd52vfJ/REWoycxWuVvSVLDfct0ZLdL2mGv2srAQPAl65fv369pwdZfirNCZfix9+OkgDcSa5ek9IOSy/HS49HBroaAAD8984nUkKBtP470n2+v9kVnThVtSlWueXpWlVi91j9Hbjz/fkzKfsdqWaZNNyP5an6Vs84AAAAAAADAGEcAAAAAADDCOMAAAAAABjWt1ZTBwAAANCPhSpqXa2iAl0G0A/QMw4AAAAAgGGEcQAAAAAADCOMAwAAAABgGGEcAAAAAADDCOMAAAAAABhGGAcAAAAAwDDCOAAAAAAAhhHGAQAAAAAwjDAOAAAAAIBhhHEAAAAAAAwjjAMAAAAAYBhhHAAAAAAAwwjjAAAAAAAYRhgHAAAAAMAwwjgAAAAAAIYRxgEAAAAAMIwwDgAAAACAYYRxAAAAAAAMI4zDS32+RXabRfZNRWqWJGeRdttc24prbuI8cqi4F+cBAAC4Wa+//ro++OCDQJeBPqW9bbr7iFOS1HwkzdV+teWo/ibOo5qcXpwHA9FdgS4ArZyq2hSr3HIfD6XuU06K1XhFt1TNcRW6f2w455QmhQa0HC/OIu1etFKOmS9p67oEBQW6HgAAcEsVFxeruLhYY8aM0fTp0xUdHa2vf/3rgS5r4Gpte/l4KHF7reZOMl7RLVX/pyz3T6d03imFB7rZW5Mj+4qsztvvhIzRz9Ez3h/kJXv0MPdTk2KU6P4xbFSgP5FaOVW1ySJ7F/8ZAACAO8vZs2d18OBBrVmzRuvWrVNhYaE+/fTTQJcFD4UrPHqY+6nwaenunyYrpK80e9En0TPeF3ncparPtygzT1J5iWqdCYrqt3/QVs0tqdXcQJfRxqFiW3Jbbz0A3E6ff/65/vGPfwS6DGDAunr1aqdt77//vt5//3398pe/lMVi0YMPPqgHH3xQQUHtY+QuXRok6SsGKx142nvC29tmjoo/qnl2Px6tOMmunBJ7oKto03zulOsHesL7HMJ4Hxc+LV3Ky5JUImejpEYfw0y8hle3f5BZ1+yTtSJZueXuD7qRvoYEpWtViV3hPa6sY5i1acneHV3fLPAYjtT+oetjaL77uehImlZvKXHXF6Patmu5ryPP59Lh2q1DcfwYdm5dU6H4s7GuGx4AcJucP39epaWlgS4DGLAaGhpu+Hjr3+i4ceP0rW99SyEhIboSMkVSjIEKIVllSZWUJ6n8jJySnK2dUp57ranQ0tnuRp9X+3KftCJZha3twhu2mXug07D67tvPzV7t2Nb9fHQEucNxW+fbzJe09f9I+9qu5T7ea5i597XbruVH0LaOCevhE8ftRhjv49rnnNgUOlJqfu9U553KV2r1JnX6cHFsSfYO3o1nfAzHzlKmTT0L5D7n+ZQod1Ga1F0g9z5J13PkvZxS6aYsj2uVKPenaXKUl3TYViTLugQFyamqA+7XrNvRBK6eekmqz/enXgDovREjRujRRx8NdBnAgPW73/2u28cnTpzY1jMeHBzctv3d84Olj293dXBxqLY1eM8cq1A5VfuRj722xGq3PAK5W+GKZK/f23qDPXXRZu6Wz/nWPW0/+zsis0T7Fnm2cbOUuemUrOUl3tfOj3EHb4cqtrgfyzuu+hRrt/U4tsTKvsX9C73kfQJhvC/KS5a9Y09t6hJXqJy9QzmzPba3fkD4DJ4d79p1GDLTFqqzVFtjV7ifi2XUH3YHcY+7i647eiVyvOdU1Gx/0niDnO4g7nWH0619fnyJwubXauk67yH7WlOhnNmhHttcd1CDFKqo+enKLc+SZtpk6bfD+gHcSTyHvQIwb/DgwZ22jR8/XtHR0Zo+fbpGjRrl87ivXrndlaFwhaVTSE2c72pfRq2rVZTH9tZ2n89h7B17vXvUZu6KRydPW3ht7VDqQfvZeUatYzO6XaCuXLLurdXSUI9Oq/IShW2v1dJJHts+OqNmWRUkq2LX2FS4pURKjekyiDvPlnTemJcsuwjkgUYY7we8/mi7WX2yk05/lLdinrRT51vvUpav1GrbSu8rnG2Q5M+nW/tQpLa7dD6HDqXL4n7uoWNsklxDfuLd4b19m4c+Nk8HAAD0DaNHj9b06dM1ffp0VlPvk7oYgu0Ha+y3vduQPWkzd6m988hXZ5nrG4L8OE3ot2WdKTnKPW4++OqZbutIClXIeEnlkma+pNhJHbZ5COp408GH8JRa5aS0/uYR6v3oTcftxWrqfVHqPuWU1Lb9a7975lCx1xySWuVsT+/yNN7zQpyq2uQ577pWOXtfUs/vhXl8KPny0Rm/V30PT6nV1jW29g3lK7Xalqaq/r2AJgAA6GO++93vKiMjQ9u2bVNSUhJBvA9J3F7r0e71GNFZk9MexN1t41WpXZ/H+9t6etZm7pJHj7Yvrk4of4Qqal2H+vOSA/Q95K5RpC6ur15D4NAz3p+0fSC03zX0OR/Gp9YQ7bHYWY2vOeQ3EqbQmWq7U9fVnBt//67b7ua13b10LVRn6XFdHnqwgBsAALjzPfXUU4EuAT3UeQVwj9GZN3JTbWYPoWMVJrnay13Osfa/Nd3WQ902D90VhkN6XlmbGy/g5lRV/h9lSWltE3sMveer1wKOMN4vZSnT1nEhCX+VKHeRRbm9vrbHnOxOw9R7sjJ7V0Pm3cPSz/W6wPZF7/r918EBAAAMcL7WUvLbzbSZJXnOye5YR086fboaMu8elt77zmmnaiv8WMDto85TSyUpcXtvvlEJtxLD1PuT0AQt9RxiM/MlbfV7yI1Vc72GpadrVa+Gqcs1J7u3x3art1+z5i18mvs1YQE3AACAfilo9g6vYd3WNRXdDlP3clNt5s519GqI+43ckhGcobLEuqd8drmAm3uuuRfXlNUuF5KDMV+6fv369Z4eZPmpNCdciu/0xgKAt6vXpLTD0svx0uORga4GAAD/vfOJlFAgrf+OdN9XA10NgL7uz59J2e9INcuk4XffeH96xgEAAAAAMIwwDgAAAACAYYRxAAAAAAAMI4wDAAAAAGAYYRwAAAAAAMMI4wAAAAAAGEYYBwAAAADAMMI4AAAAAACGEcYBAAAAADDsrkAXAAAA0GMfHtKi9QVem6Ke2alnZwzv8nEt3KC9j0zU6YOLlPGG5wNJ2rB3nib6vMZHWv7qs4od4bH9QoVeeaZR3/d1TJuLqtj+tLLHua7pyXX9qM7n1WkdWvSmRnbY3qle9/Nw1ZGtKs9TTF+unStiNbzLugAAfQVhHAAA9E+ewfNChV555mkdumev5k3w8XgHnsH99MFFyjgY2SE0X1TFbz9S0kKp8v2Lip3Rw3j74VFlj0tS0hsndfqRiZ1Ce9R0KbvstGIf6TrOu8J5hgoWbtDeve37nT54SKfVes4ubiQAAPo8hqkDAID+b0Ssvr9Q+uiziz0+dOL9SdLHn8nryAsnValozYqLll49qtM9POfp9wqUdP88RS4s0JvHfNQUFa2kNzJ06MOuznBRFdsz9NEzOzv1rE98hPANAHcCwjgAABjALqritwVK+p53D/rF9yulqEgNHxGp6OkFOtllaPbltE6+kaTICa6gX1V1Up3jeKTmbUxSwfpDvoP+hZOqfDtJ3+9pjzwAoN9gmDoAAOj/PjykjDeStGGvR3h9O1tPL8pu+zVpY/sQ9qpXn9aiV90PLNygvRPk4aJOVknRT7rOFRkVpaffO615E/zsj/7wpAoWRmqvJE2IVNLbb+rkhdgO88MlTZinDQt9DZGXdKFRVdNHavENL1agjEXtc+O95s0DAPo0wjgAAOifPMN2h3nVkvyeM37x2CtatD26fd8Pjypb0drpDs/D/2e0ol71Pfe7s9ae9r3u3ycqcmGV3uxi3vnERzYoadGbqojruJibv5gzDgD9FWEcAAD0T21h27XQ2aH7PRZv64HhMxZredVrbb3Xp98rkN6WV6+6JOnYrBv3Ol84qcq3paq3F8l7LfejOj3DV2ieqFnPSE+/XqHIFfe0bx4xUlFvN6pRYmV0ALhDEcYBAEA/N1HzNiZp0fpDiuxVL3GjGt+WRj4pueZ7+/jasQ8PadFvT+rijO6/Nuzi+5WqWtjx68xcX3N28sN5mujjZoHrZsDTeu3Yco1v3TgiUtHTuz4GAND/sYAbAADo/ybM04aFBco42NN1z6WLx95UwfRoRY6Qa753689e549U0tuVOnmh2zPpZFWVku7veDtguCKjolTwXle1DVfsk8ulV7M9etOHK/Z7SSpYv0ivdFiN3fXVZgCA/o6ecQAAcEdwzb/O0Cv37tSz96jTAm6tw9qlDgu4KUkb9sZquHu+d1TUTh+936653xllpxUbJ3VcOE1K0oaNUvbbSdqwonNtrnnnrrnh93R+WBoRq8XPVKrqVY9tE+Zp795IHVrkWat7vnvbbz7qYA45APQLX7p+/fr1nh5k+ak0J1yKH3/jfQEMbFevSWmHpZfjpccjA10NAAD+e+cTKaFAWv8d6b6vBroaAH3dnz+Tst+RapZJw+++8f4MUwcAAAAAwDDCOAAAAAAAhhHGAQAAAAAwjDAOAAAAAIBhhHEAAAAAAAwjjAMAAAAAYBhhHAAAAAAAwwjjAAAAAAAYRhgHAAAAAMAwwjgAAAAAAIYRxgEAAAAAMIwwDgAAAACAYYRxAAAAAAAMI4wDAAAAAGAYYRwAAAAAAMMI4wAAAAAAGEYYBwAAAADAMMI4AAAAAACGEcYBAAAAADCMMA4AAAAAgGGEcQAAAAAADCOMAwAAAABgGGEcAAAAAADDCOMAAAAAABhGGAcAAAAAwDDCOAAAAAAAhhHGAQAAAAAwjDAOAAAAAIBhhHEAAKi47VAAAAIbSURBVAAAAAwjjAMAAAAAYBhhHAAAAAAAwwjjAAAAAAAYRhgHAAAAAMAwwjgAAAAAAIYRxgEAAAAAMIwwDgAAAACAYYRxAAAAAAAMI4wDAAAAAGAYYRwAAAAAAMMI4wAAAAAAGEYYBwAAAADAMMI4AAAAAACGEcYBAAAAADCMMA4AAAAAgGGEcQAAAAAADCOMAwAAAABgGGEcAAAAAADDCOMAAAAAABhGGAcAAAAAwLC7envgsTOufwAAAMCd7BcnAl0BgDtRr8L49ybc6jIAAACAvufxyEBXAOBO9aXr169fD3QRAAAAAAAMJMwZBwAAAADAMMI4AAAAAACGEcYBAAAAADCMMA4AAAAAgGGEcQAAAAAADCOMAwAAAABgGGEcAAAAAADDCOMAAAAAABhGGAcAAAAAwDDCOAAAAAAAhhHGAQAAAAAwjDAOAAAAAIBhhHEAAAAAAAwjjAMAAAAAYBhhHAAAAAAAwwjjAAAAAAAYRhgHAAAAAMAwwjgAAAAAAIYRxgEAAAAAMIwwDgAAAACAYYRxAAAAAAAMI4wDAAAAAGAYYRwAAAAAAMMI4wAAAAAAGEYYBwAAAADAMMI4AAAAAACGEcYBAAAAADCMMA4AAAAAgGGEcQAAAAAADCOMAwAAAABgGGEcAAAAAADDCOMAAAAAABhGGAcAAAAAwDDCOAAAAAAAhhHGAQAAAAAwjDAOAAAAAIBh/x8hK7ZCYD4nhAAAAABJRU5ErkJggg==" alt="image-20200504054650656"></p> <p><img src="/assets/img/image-20200504054706102.0649d7d6.png" alt="image-20200504054706102"></p> <h2 id="datastream-的编程模型"><a href="#datastream-的编程模型" class="header-anchor">#</a> DataStream 的编程模型</h2> <p>DataStream 的编程模型包括四个部分：Environment、DataSource、Transformation、Sink</p> <p><img src="/assets/img/1587215224155.cfc13d2f.png" alt="1587215224155"></p> <h2 id="flink的datasource数据源"><a href="#flink的datasource数据源" class="header-anchor">#</a> Flink的DataSource数据源</h2> <h5 id="_1、基于文件"><a href="#_1、基于文件" class="header-anchor">#</a> 1、基于文件</h5> <div class="language- extra-class"><pre class="language-text"><code>readTextFile(path)
读取文本文件，文件遵循TextInputFormat读取规则，逐行读取并返回。
</code></pre></div><p>案例</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo6</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time

<span class="token keyword">object</span> StreamingSourceFromFile <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

   <span class="token comment">//构建流处理的环境</span>
      <span class="token keyword">val</span> env<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

     <span class="token comment">//从socket获取数据</span>
       <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span>readTextFile<span class="token punctuation">(</span><span class="token string">&quot;e:\\words.txt&quot;</span><span class="token punctuation">)</span>

     <span class="token comment">//导入隐式转换的包</span>
      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token comment">//对数据进行处理</span>

    <span class="token keyword">val</span> result<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream
                           <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//按照空格切分</span>
                           <span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//每个单词计为1</span>
                           <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>          <span class="token comment">//按照下标为0的单词进行分组</span>
                           <span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token comment">//按照下标为1累加相同单词出现的1</span>


    <span class="token comment">//保存结果</span>
    result<span class="token punctuation">.</span>writeAsText<span class="token punctuation">(</span><span class="token string">&quot;e:\\result&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">//开启任务</span>
     env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;FlinkStream&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h5 id="_2、基于socket"><a href="#_2、基于socket" class="header-anchor">#</a> 2、基于socket</h5> <div class="language- extra-class"><pre class="language-text"><code>socketTextStream
从socker中读取数据，元素可以通过一个分隔符切开。
</code></pre></div><p>案例</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo1</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">,</span> WindowedStream<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow

<span class="token comment">/**
  * 使用滑动窗口
  * 每隔1秒钟统计最近2秒钟的每个单词出现的次数
  */</span>
<span class="token keyword">object</span> FlinkStream <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">//构建流处理的环境</span>
      <span class="token keyword">val</span> env<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

     <span class="token comment">//从socket获取数据</span>
       <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

     <span class="token comment">//导入隐式转换的包</span>
      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token comment">//对数据进行处理</span>

    <span class="token keyword">val</span> result<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream
                     <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//按照空格切分</span>
                     <span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//每个单词计为1</span>
                    <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>          <span class="token comment">//按照下标为0的单词进行分组</span>
                    <span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token comment">//按照下标为1累加相同单词出现的1</span>


    <span class="token comment">//对数据进行打印</span>
    result<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//开启任务</span>
     env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;FlinkStream&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h5 id="_3、基于集合"><a href="#_3、基于集合" class="header-anchor">#</a> 3、基于集合</h5> <div class="language- extra-class"><pre class="language-text"><code>fromCollection(Collection)
通过collection集合创建一个数据流，集合中的所有元素必须是相同类型的。
</code></pre></div><p>案例</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo2</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>


<span class="token keyword">object</span> StreamingSourceFromCollection <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token comment">//导入隐式转换的包</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

     <span class="token comment">//准备数据源--数组</span>
     <span class="token keyword">val</span> array <span class="token operator">=</span> Array<span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;world spark&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;flink test&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;spark hive&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span>
     <span class="token keyword">val</span> fromArray<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>array<span class="token punctuation">)</span>

    <span class="token comment">//  val value: DataStream[String] = environment.fromElements(&quot;hello world&quot;)</span>
     <span class="token keyword">val</span> resultDataStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> fromArray
                                            <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                            <span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                            <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                                            <span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment">//打印</span>
    resultDataStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//启动</span>
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>


  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h5 id="_4、自定义输入"><a href="#_4、自定义输入" class="header-anchor">#</a> 4、自定义输入</h5> <div class="language- extra-class"><pre class="language-text"><code>addSource 
可以实现读取第三方数据源的数据
</code></pre></div><p>自定义<strong>单并行度数据源</strong></p> <ul><li>继承SourceFunction来自定义单并行度source</li></ul> <p>代码开发</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo2</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span>SourceFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>

<span class="token comment">/**
  * 自定义单并行度source
  *
  */</span>
<span class="token keyword">object</span> MySourceRun <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
      
    <span class="token keyword">val</span> getSource<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>addSource<span class="token punctuation">(</span><span class="token keyword">new</span> MySource<span class="token punctuation">)</span><span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
      
    <span class="token keyword">val</span> resultStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span> <span class="token operator">=</span> getSource<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x <span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
    resultStream<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
      
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//继承SourceFunction来自定义单并行度source</span>
<span class="token keyword">class</span> MySource <span class="token keyword">extends</span> SourceFunction<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">var</span> number <span class="token operator">=</span> <span class="token number">1L</span>
  <span class="token keyword">private</span> <span class="token keyword">var</span> isRunning <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> run<span class="token punctuation">(</span>sourceContext<span class="token operator">:</span> SourceFunction<span class="token punctuation">.</span>SourceContext<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>isRunning<span class="token punctuation">)</span><span class="token punctuation">{</span>
      number <span class="token operator">+=</span> <span class="token number">1</span>
      sourceContext<span class="token punctuation">.</span>collect<span class="token punctuation">(</span>number<span class="token punctuation">)</span>
      Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> cancel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    isRunning <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//运行结果为：</span>
<span class="token number">3</span>
<span class="token number">5</span>
<span class="token number">7</span>
<span class="token number">9</span>
<span class="token number">11</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>自定义<strong>多并行度数据源</strong></p> <ul><li>继承ParallelSourceFunction来自定义多并行度的source，然后将匿名内部类传入addSource()方法中。</li></ul> <p>代码开发</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo2</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span><span class="token punctuation">{</span>ParallelSourceFunction<span class="token punctuation">,</span> SourceFunction<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>

<span class="token comment">/**
  *
  * 多并行度的source
  */</span>
<span class="token keyword">object</span> MyMultipartSourceRun <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
     <span class="token comment">//构建流处理环境</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token comment">//添加source</span>
    <span class="token keyword">val</span> getSource<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>addSource<span class="token punctuation">(</span><span class="token keyword">new</span> MultipartSource<span class="token punctuation">)</span><span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment">//处理</span>
    <span class="token keyword">val</span> resultStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span> <span class="token operator">=</span> getSource<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x <span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
    resultStream<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//继承ParallelSourceFunction来自定义多并行度的source</span>
<span class="token keyword">class</span> MultipartSource  <span class="token keyword">extends</span> ParallelSourceFunction<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">var</span> number <span class="token operator">=</span> <span class="token number">1L</span>
  <span class="token keyword">private</span> <span class="token keyword">var</span> isRunning <span class="token operator">=</span> <span class="token boolean">true</span>


  <span class="token keyword">override</span> <span class="token keyword">def</span> run<span class="token punctuation">(</span>sourceContext<span class="token operator">:</span> SourceFunction<span class="token punctuation">.</span>SourceContext<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>isRunning<span class="token punctuation">)</span><span class="token punctuation">{</span>
      number <span class="token operator">+=</span><span class="token number">1</span>
      sourceContext<span class="token punctuation">.</span>collect<span class="token punctuation">(</span>number<span class="token punctuation">)</span>
      Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> cancel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    isRunning <span class="token operator">=</span> <span class="token boolean">false</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><p>此外系统内置提供了一批connectors，连接器会提供对应的source支持</p> <ul><li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/connectors/kafka.html" target="_blank" rel="noopener noreferrer">Apache Kafka<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (source/sink)  <strong>后面重点分析</strong></li> <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/connectors/cassandra.html" target="_blank" rel="noopener noreferrer">Apache Cassandra<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (sink)</li> <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/connectors/kinesis.html" target="_blank" rel="noopener noreferrer">Amazon Kinesis Streams<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (source/sink)</li> <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/connectors/elasticsearch.html" target="_blank" rel="noopener noreferrer">Elasticsearch<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (sink)</li> <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/connectors/filesystem_sink.html" target="_blank" rel="noopener noreferrer">Hadoop FileSystem<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (sink)</li> <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/connectors/rabbitmq.html" target="_blank" rel="noopener noreferrer">RabbitMQ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (source/sink)</li> <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/connectors/nifi.html" target="_blank" rel="noopener noreferrer">Apache NiFi<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (source/sink)</li> <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/connectors/twitter.html" target="_blank" rel="noopener noreferrer">Twitter Streaming API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (source)</li></ul> <h2 id="flink的sink数据目标"><a href="#flink的sink数据目标" class="header-anchor">#</a> Flink的Sink数据目标</h2> <ul><li>writeAsText()：将元素以字符串形式逐行写入，这些字符串通过调用每个元素的toString()方法来获取</li> <li>print() / printToErr()：打印每个元素的toString()方法的值到标准输出或者标准错误输出流中</li> <li>自定义输出addSink【kafka、redis】</li> <li>我们可以通过sink算子，将我们的数据发送到指定的地方去，例如kafka或者redis或者hbase等等，前面我们已经使用过将数据打印出来调用print()方法，接下来我们来实现自定义sink将我们的数据发送到redis里面去
<ul><li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/connectors/kafka.html" target="_blank" rel="noopener noreferrer">Apache Kafka<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (source/sink)</li> <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/connectors/cassandra.html" target="_blank" rel="noopener noreferrer">Apache Cassandra<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (sink)</li> <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/connectors/kinesis.html" target="_blank" rel="noopener noreferrer">Amazon Kinesis Streams<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (source/sink)</li> <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/connectors/elasticsearch.html" target="_blank" rel="noopener noreferrer">Elasticsearch<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (sink)</li> <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/connectors/filesystem_sink.html" target="_blank" rel="noopener noreferrer">Hadoop FileSystem<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (sink)</li> <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/connectors/rabbitmq.html" target="_blank" rel="noopener noreferrer">RabbitMQ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (source/sink)</li> <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/connectors/nifi.html" target="_blank" rel="noopener noreferrer">Apache NiFi<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (source/sink)</li> <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/connectors/twitter.html" target="_blank" rel="noopener noreferrer">Twitter Streaming API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (source)</li> <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/connectors/pubsub.html" target="_blank" rel="noopener noreferrer">Google PubSub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (source/sink)</li></ul></li></ul> <h4 id="案例-flink写数据到redis中"><a href="#案例-flink写数据到redis中" class="header-anchor">#</a> 案例：Flink写数据到redis中</h4> <p>导入flink整合redis的jar包</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.bahir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-connector-redis_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>修改配置文件redis.conf</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/redis-3.2.9
<span class="token function">vi</span>  redis.conf

	protected-mode <span class="token function">yes</span> ----<span class="token operator">&gt;</span> protected no
	<span class="token builtin class-name">bind</span> <span class="token number">127.0</span>.0.1 -----<span class="token operator">&gt;</span> <span class="token builtin class-name">bind</span> <span class="token number">127.0</span>.0.1 <span class="token number">192.168</span>.52.101
	
注意：启动redis时，指定一下redis.conf文件，如：
<span class="token punctuation">[</span>hadoop@node01 src<span class="token punctuation">]</span>$ ./redis-server /kkb/install/redis-3.2.9/redis.conf 
</code></pre></div><p>代码开发</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>redis<span class="token punctuation">.</span></span>RedisSink
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>common<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span>FlinkJedisPoolConfig
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>common<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token punctuation">{</span>RedisCommand<span class="token punctuation">,</span> RedisCommandDescription<span class="token punctuation">,</span> RedisMapper<span class="token punctuation">}</span>

<span class="token comment">/**
  * flink实时程序处理保存结果到redis中
  */</span>
<span class="token keyword">object</span> Stream2Redis <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取程序入口类</span>
    <span class="token keyword">val</span> executionEnvironment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token comment">//组织数据</span>
    <span class="token keyword">val</span> streamSource<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> executionEnvironment<span class="token punctuation">.</span>fromElements<span class="token punctuation">(</span><span class="token string">&quot;1 hadoop&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;2 spark&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;3 flink&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//将数据包装成为key,value对形式的tuple</span>
    <span class="token keyword">val</span> tupleValue<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamSource<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


    <span class="token keyword">val</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> FlinkJedisPoolConfig<span class="token punctuation">.</span>Builder

    <span class="token comment">//设置redis客户端参数</span>
    builder<span class="token punctuation">.</span>setHost<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">)</span>
    builder<span class="token punctuation">.</span>setPort<span class="token punctuation">(</span><span class="token number">6379</span><span class="token punctuation">)</span>
    builder<span class="token punctuation">.</span>setTimeout<span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
    builder<span class="token punctuation">.</span>setMaxTotal<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
    builder<span class="token punctuation">.</span>setMaxIdle<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    builder<span class="token punctuation">.</span>setMinIdle<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> config<span class="token operator">:</span> FlinkJedisPoolConfig <span class="token operator">=</span> builder<span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//获取redis  sink</span>
    <span class="token keyword">val</span> redisSink <span class="token operator">=</span> <span class="token keyword">new</span> RedisSink<span class="token punctuation">[</span>Tuple2<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span><span class="token keyword">new</span> MyRedisMapper<span class="token punctuation">)</span>

    <span class="token comment">//使用我们自定义的sink</span>
    tupleValue<span class="token punctuation">.</span>addSink<span class="token punctuation">(</span>redisSink<span class="token punctuation">)</span>

    <span class="token comment">//执行程序</span>
    executionEnvironment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;redisSink&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//定义一个RedisMapper类</span>
<span class="token keyword">class</span> MyRedisMapper  <span class="token keyword">extends</span> RedisMapper<span class="token punctuation">[</span>Tuple2<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">{</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> getCommandDescription<span class="token operator">:</span> RedisCommandDescription <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">//设置要执行的Redis命令是SET，SET是Redis的插入命令</span>
    <span class="token keyword">new</span> RedisCommandDescription<span class="token punctuation">(</span>RedisCommand<span class="token punctuation">.</span>SET<span class="token punctuation">)</span>


  <span class="token punctuation">}</span>
    <span class="token comment">//指定key</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> getKeyFromData<span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">.</span>_1

  <span class="token punctuation">}</span>

  <span class="token comment">//指定value</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> getValueFromData<span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">.</span>_2

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>启动redis，并执行程序，然后查看redis的key与value</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> keys *
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;2&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;1&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;3&quot;</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">&quot;jimmy&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get <span class="token number">2</span>
<span class="token string">&quot;spark&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get <span class="token number">1</span>
<span class="token string">&quot;hadoop&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get <span class="token number">3</span>
<span class="token string">&quot;flink&quot;</span>
</code></pre></div><h2 id="datastream-转换算子"><a href="#datastream-转换算子" class="header-anchor">#</a> DataStream 转换算子</h2> <p>通过<strong>从一个或多个 DataStream 生成新的 DataStream 的过程被称为 Transformation 操作</strong>。在转换过程中，每种操作类型被定义为不同的 Operator, Flink 程序能够将多个 Transformation 组成一个 DataFlow 的拓扑。</p> <p>DataStream 官网转换算子操作：</p> <p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.10/dev/stream/operators/index.html" target="_blank" rel="noopener noreferrer">https://ci.apache.org/projects/flink/flink-docs-release-1.10/dev/stream/operators/index.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h5 id="_1、map、filter"><a href="#_1、map、filter" class="header-anchor">#</a> 1、map、filter</h5> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>

<span class="token keyword">object</span> MapFilter <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span>  <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromElements<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span>x<span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> resultStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapStream<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
    resultStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h5 id="_2、flatmap、keyby、sum"><a href="#_2、flatmap、keyby、sum" class="header-anchor">#</a> 2、flatMap、keyBy、sum</h5> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time

<span class="token comment">/**
  * 使用滑动窗口
  * 每隔1秒钟统计最近2秒钟的每个单词出现的次数
  */</span>
<span class="token keyword">object</span> FlinkStream <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取程序入口类</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token comment">//从socket当中获取数据</span>
    <span class="token keyword">val</span> resultDataStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>


    <span class="token comment">//导入隐式转换的包</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_


    <span class="token comment">//对数据进行计算操作</span>
    <span class="token keyword">val</span> resultData<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> resultDataStream
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//按照空格进行切分</span>
      <span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//程序出现一次记做1</span>
      <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//按照下标为0的单词进行统计</span>
      <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//每隔一秒钟计算一次前两秒钟的单词出现的次数</span>
      <span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    resultData<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//执行程序</span>
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h5 id="_3、reduce"><a href="#_3、reduce" class="header-anchor">#</a> 3、reduce</h5> <p>reduce是将输入的 KeyedStream 流通过 传 入 的 用 户 自 定 义 的 ReduceFunction 滚 动 地 进 行 数 据 聚 合 处 理</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo3</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> KeyedStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>

<span class="token keyword">object</span> ReduceStream <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span>  <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment
      	<span class="token punctuation">.</span>fromElements<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  

    <span class="token keyword">val</span> keyByStream<span class="token operator">:</span> KeyedStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tuple<span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//按照第一位分组</span>

   <span class="token keyword">val</span> resultStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> keyByStream<span class="token punctuation">.</span>reduce<span class="token punctuation">(</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span>t2<span class="token punctuation">)</span><span class="token keyword">=&gt;</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span>_1<span class="token punctuation">,</span>t1<span class="token punctuation">.</span>_2<span class="token operator">+</span>t2<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">)</span>

    resultStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_4、union"><a href="#_4、union" class="header-anchor">#</a> 4、union</h5> <p>把2个流的数据进行合并，<strong>2个流的数据类型必须保持一致</strong></p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>

<span class="token comment">/**
  * union算子
  */</span>
<span class="token keyword">object</span> UnionStream <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token keyword">val</span> firstStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token string">&quot;hello spark&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hello flink&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> secondStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token string">&quot;hadoop spark&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hive flink&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//两个流合并成为一个流，必须保证两个流当中的数据类型是一致的</span>
    <span class="token keyword">val</span> resultStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> firstStream<span class="token punctuation">.</span>union<span class="token punctuation">(</span>secondStream<span class="token punctuation">)</span>

    resultStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*运行结果为：
6&gt; hadoop spark
2&gt; hello flink
1&gt; hello spark
1&gt; hive flink
*/</span>
</code></pre></div><h5 id="_5、connect"><a href="#_5、connect" class="header-anchor">#</a> 5、connect</h5> <p>和union类似，但是只能连接两个流，<strong>两个流的数据类型可以不同</strong></p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo3</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>co<span class="token punctuation">.</span></span>CoFlatMapFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>ConnectedStreams<span class="token punctuation">,</span> DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token comment">/**
  * 和union类似，但是只能连接两个流，两个流的数据类型可以不同，
  * 会对两个流中的数据应用不同的处理方法
  */</span>
<span class="token keyword">object</span> ConnectStream <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

    environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token keyword">val</span> firstStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;spark flink&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> secondStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">//调用connect方法连接多个DataStream</span>
    <span class="token keyword">val</span> connectStream<span class="token operator">:</span> ConnectedStreams<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> firstStream<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>secondStream<span class="token punctuation">)</span>

    <span class="token keyword">val</span> unionStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">]</span> <span class="token operator">=</span> connectStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x <span class="token operator">+</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">,</span>y <span class="token keyword">=&gt;</span> y<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
	
    <span class="token comment">//CoFlatMapFunction[String, Int, String]，前两个是输入类型，最后一个是返回类型</span>
    <span class="token keyword">val</span> coFlatMapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> connectStream<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span><span class="token keyword">new</span> CoFlatMapFunction<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token comment">//对第一个流中的数据操作</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> flatMap1<span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span>value<span class="token punctuation">.</span>toUpperCase<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
        <span class="token comment">//对第二个流中的数据操作</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> flatMap2<span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span> value <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    unionStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    coFlatMapStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*运行结果为：
2&gt; SPARK FLINK
5&gt; 8
3&gt; 4
4&gt; 6
2&gt; 2
1&gt; HELLO WORLD
5&gt; 8
3&gt; hello worldabc
4&gt; spark flinkabc
3&gt; 4
4&gt; 6
2&gt; 2
*/</span>
</code></pre></div><p>CoFlatMapFunction的源代码是：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Public</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CoFlatMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span>IN1<span class="token punctuation">,</span> IN2<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Function</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">flatMap1</span><span class="token punctuation">(</span><span class="token class-name">IN1</span> var1<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">&gt;</span></span> var2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">flatMap2</span><span class="token punctuation">(</span><span class="token class-name">IN2</span> var1<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span>OUT<span class="token punctuation">&gt;</span></span> var2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6、split、select"><a href="#_6、split、select" class="header-anchor">#</a> 6、split、select</h5> <p>根据规则把一个数据流切分为多个流</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo3</span>

<span class="token comment">/**
  *  根据规则把一个数据流切分为多个流
 应用场景：
  * 可能在实际工作中，源数据流中混合了多种类似的数据，多种类型的数据处理规则不一样，所以就可以在根据一定的规则，
  * 把一个数据流切分成多个数据流，这样每个数据流就可以使用不同的处理逻辑了
  */</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span></span><span class="token punctuation">{</span>lang<span class="token punctuation">,</span> util<span class="token punctuation">}</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>collector<span class="token punctuation">.</span>selector<span class="token punctuation">.</span></span>OutputSelector
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> SplitStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>

<span class="token keyword">object</span> SplitAndSelect <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

    environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
      <span class="token comment">//构建DataStream</span>
    <span class="token keyword">val</span> firstStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token string">&quot;hadoop hive&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;spark flink&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> selectStream<span class="token operator">:</span> SplitStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> firstStream<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token keyword">new</span> OutputSelector<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> select<span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> lang<span class="token punctuation">.</span>Iterable<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> list <span class="token operator">=</span> <span class="token keyword">new</span> util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//如果包含hello字符串</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>contains<span class="token punctuation">(</span><span class="token string">&quot;hadoop&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//存放到一个叫做first的stream里面去</span>
            list<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">&quot;first&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
          <span class="token comment">//否则存放到一个叫做second的stream里面去</span>
           list<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">&quot;second&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        list
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//获取first这个stream</span>
    selectStream<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">&quot;first&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*hadoop hive*/</span>
</code></pre></div><h5 id="_7、-重分区算子"><a href="#_7、-重分区算子" class="header-anchor">#</a> 7、 重分区算子</h5> <p>==重算子允许我们对数据进行重新分区，或者解决数据倾斜等问题==</p> <ul><li><p>Random Partitioning</p> <ul><li>随机分区
<ul><li>根据均匀分布随机分配元素（类似于random.nextInt(5)，0 - 5 在概率上是均匀的）</li> <li>dataStream.shuffle()</li></ul></li></ul></li> <li><p>Rebalancing</p> <ul><li>均匀分区
<ul><li>分区元素循环，每个分区创建相等的负载。数据发生倾斜的时候可以用于性能优化。</li> <li>对数据集进行再平衡，重分区，消除数据倾斜</li> <li>dataStream.rebalance()</li></ul></li></ul></li> <li><p>Rescaling：</p> <ul><li><p>跟rebalance有点类似，<strong>但不是全局的</strong>，这种方式仅发生在一个单一的节点，因此没有跨网络的数据传输。</p> <ul><li>dataStream.rescale()</li></ul></li></ul></li> <li><p>Custom partitioning：自定义分区</p> <ul><li>自定义分区需要实现Partitioner接口
<ul><li>dataStream.partitionCustom(partitioner, &quot;someKey&quot;)</li> <li>或者dataStream.partitionCustom(partitioner, 0);</li></ul></li></ul></li> <li><p>Broadcasting：广播变量，后面详细讲解</p></li></ul> <h6 id="_4-7-1-对filter之后的数据进行重新分区"><a href="#_4-7-1-对filter之后的数据进行重新分区" class="header-anchor">#</a> 4.7.1 对filter之后的数据进行重新分区</h6> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo4</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>RichMapFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>

<span class="token comment">/**
  *  对filter之后的数据进行重新分区
  */</span>
<span class="token keyword">object</span> FlinkPartition <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    
    <span class="token keyword">val</span> dataStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span><span class="token number">1</span> to <span class="token number">100</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> filterStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> dataStream<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token operator">&gt;</span><span class="token number">10</span><span class="token punctuation">)</span>
      <span class="token comment">//.shuffle  //随机的重新分发数据,上游的数据，随机的发送到下游的分区里面去</span>
      <span class="token comment">//.rescale</span>
      <span class="token punctuation">.</span>rebalance <span class="token comment">//对数据重新进行分区，涉及到shuffle的过程</span>

    <span class="token keyword">val</span> resultStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> filterStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token keyword">new</span> RichMapFunction<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> map<span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
         <span class="token comment">//获取任务id，以及value	</span>
        <span class="token punctuation">(</span>getRuntimeContext<span class="token punctuation">.</span>getIndexOfThisSubtask<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    resultStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>RichMapFunction是一个富函数，源代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Public</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">RichMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRichFunction</span> <span class="token keyword">implements</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RichMapFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">OUT</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">IN</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h6 id="_4-7-2-自定义分区策略"><a href="#_4-7-2-自定义分区策略" class="header-anchor">#</a> 4.7.2  自定义分区策略</h6> <p>如果以上的几种分区方式还没法满足我们的需求，我们还可以自定义分区策略来实现数据的分区</p> <p>需求</p> <ul><li>自定义分区策略，实现不同分区的数据发送到不同分区里面去进行处理，将包含hello的字符串发送到一个分区里面去，其他的发送到另外一个分区里面去</li></ul> <p>定义分区类</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>Partitioner

<span class="token keyword">class</span> Mypartitioner <span class="token keyword">extends</span> Partitioner<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> partition<span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> numPartitions<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    print<span class="token punctuation">(</span><span class="token string">&quot;分区个数为 &quot;</span><span class="token operator">+</span>numPartitions<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>contains<span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>定义分区class类</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>

<span class="token keyword">object</span> FlinkCustomerPartition <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span>  <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token comment">//获取dataStream</span>
    <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromElements<span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;spark flink&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hive hadoop&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> rePartition<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>partitionCustom<span class="token punctuation">(</span><span class="token keyword">new</span> MyPartitioner<span class="token punctuation">,</span>x <span class="token keyword">=&gt;</span> x <span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
    rePartition<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span><span class="token punctuation">{</span>
      println<span class="token punctuation">(</span><span class="token string">&quot;数据的key为&quot;</span> <span class="token operator">+</span>  x <span class="token operator">+</span> <span class="token string">&quot;线程为&quot;</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span>currentThread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getId<span class="token punctuation">)</span>
      x
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    rePartition<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Partitioner的源码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Partitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span><span class="token punctuation">,</span> <span class="token class-name">Function</span> <span class="token punctuation">{</span>

	<span class="token comment">/**
	 * Computes the partition for the given key.
	 *
	 * @param key The key.
	 * @param numPartitions The number of partitions to partition into.
	 * @return The partition index.
	 */</span>
	<span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> numPartitions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="dataset-转换算子"><a href="#dataset-转换算子" class="header-anchor">#</a> DataSet 转换算子</h2> <p>DataSet官网转换算子操作：</p> <p>https://ci.apache.org/projects/flink/flink-docs-release-1.10/dev/batch/index.html#dataset-transformations</p> <ul><li><p>Map</p> <ul><li>输入一个元素，然后返回一个元素，中间可以做一些清洗转换等操作</li></ul></li> <li><p>FlatMap</p> <ul><li>输入一个元素，可以返回零个，一个或者多个元素</li></ul></li> <li><p>MapPartition</p> <ul><li>类似map，一次处理一个分区的数据【如果在进行map处理的时候需要获取第三方资源链接，建议使用MapPartition】</li></ul></li> <li><p>Filter</p> <ul><li>过滤函数，对传入的数据进行判断，符合条件的数据会被留下</li></ul></li> <li><p>Reduce</p> <ul><li>对数据进行聚合操作，结合当前元素和上一次reduce返回的值进行聚合操作，然后返回一个新的值</li></ul></li> <li><p>Aggregate</p> <ul><li>sum、max、min等</li></ul></li> <li><p>Distinct</p> <ul><li>返回一个数据集中去重之后的元素，data.distinct()</li></ul></li> <li><p>Join</p> <ul><li>内连接</li></ul></li> <li><p>OuterJoin</p> <ul><li>外链接</li></ul></li> <li><p>Cross</p> <ul><li>获取两个数据集的笛卡尔积</li></ul></li> <li><p>Union</p> <ul><li>返回两个数据集的总和，数据类型需要一致</li></ul></li> <li><p>First-n</p> <ul><li>获取集合中的前N个元素</li></ul></li> <li><p>Sort Partition</p> <ul><li>在本地对数据集的所有分区进行排序，通过sortPartition()的链接调用来完成对多个字段的排序</li></ul></li></ul> <p><strong>注意：对DataSet进行操作时，不需要代码：env.execute()</strong></p> <h5 id="_5-1-mappartition"><a href="#_5-1-mappartition" class="header-anchor">#</a> 5.1 mapPartition</h5> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo7</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataSet<span class="token punctuation">,</span> ExecutionEnvironment<span class="token punctuation">}</span>

<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable<span class="token punctuation">.</span></span>ArrayBuffer

<span class="token keyword">object</span> MapPartitionDataSet <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> ExecutionEnvironment <span class="token operator">=</span> ExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token keyword">val</span> arrayBuffer <span class="token operator">=</span> <span class="token keyword">new</span> ArrayBuffer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    arrayBuffer<span class="token punctuation">.</span>+<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;hello world1&quot;</span><span class="token punctuation">)</span>
    arrayBuffer<span class="token punctuation">.</span>+<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;hello world2&quot;</span><span class="token punctuation">)</span>
    arrayBuffer<span class="token punctuation">.</span>+<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;hello world3&quot;</span><span class="token punctuation">)</span>
    arrayBuffer<span class="token punctuation">.</span>+<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;hello world4&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> collectionDataSet<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>arrayBuffer<span class="token punctuation">)</span>

    <span class="token keyword">val</span> resultPartition<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> collectionDataSet<span class="token punctuation">.</span>mapPartition<span class="token punctuation">(</span>eachPartition <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
      eachPartition<span class="token punctuation">.</span>map<span class="token punctuation">(</span>eachLine <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> returnValue <span class="token operator">=</span> eachLine <span class="token operator">+</span> <span class="token string">&quot; result&quot;</span>
        returnValue
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    resultPartition<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
hello world1result
hello world2result
hello world3result
hello world4result
*/</span>
</code></pre></div><h5 id="_5-2-distinct"><a href="#_5-2-distinct" class="header-anchor">#</a> 5.2 distinct</h5> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo7</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>ExecutionEnvironment

<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable<span class="token punctuation">.</span></span>ArrayBuffer

<span class="token keyword">object</span> DistinctDataSet <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token keyword">val</span> environment<span class="token operator">:</span> ExecutionEnvironment <span class="token operator">=</span> ExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token keyword">val</span> arrayBuffer <span class="token operator">=</span> <span class="token keyword">new</span> ArrayBuffer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    arrayBuffer<span class="token punctuation">.</span>+<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;hello world1&quot;</span><span class="token punctuation">)</span>
    arrayBuffer<span class="token punctuation">.</span>+<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;hello world2&quot;</span><span class="token punctuation">)</span>
    arrayBuffer<span class="token punctuation">.</span>+<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;hello world3&quot;</span><span class="token punctuation">)</span>
    arrayBuffer<span class="token punctuation">.</span>+<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;hello world4&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> collectionDataSet<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>arrayBuffer<span class="token punctuation">)</span>

    <span class="token keyword">val</span> dsDataSet<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> collectionDataSet<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>distinct<span class="token punctuation">(</span><span class="token punctuation">)</span>
    dsDataSet<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
world2
world1
world3
hello
world4
*/</span>
</code></pre></div><h5 id="_5-3-join"><a href="#_5-3-join" class="header-anchor">#</a> 5.3 join</h5> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo7</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>ExecutionEnvironment

<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable<span class="token punctuation">.</span></span>ArrayBuffer

<span class="token keyword">object</span> JoinDataSet <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token keyword">val</span> environment<span class="token operator">:</span> ExecutionEnvironment <span class="token operator">=</span> ExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token keyword">val</span> array1 <span class="token operator">=</span> ArrayBuffer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;王五&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> array2 <span class="token operator">=</span>ArrayBuffer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;18&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;35&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;42&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> firstDataStream<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>array1<span class="token punctuation">)</span>
    <span class="token keyword">val</span> secondDataStream<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>array2<span class="token punctuation">)</span>

    <span class="token keyword">val</span> joinResult<span class="token operator">:</span> UnfinishedJoinOperation<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> firstDataStream<span class="token punctuation">.</span>join<span class="token punctuation">(</span>secondDataStream<span class="token punctuation">)</span>

     <span class="token comment">//where指定左边流关联的字段 ，equalTo指定与右边流相同的字段</span>
    <span class="token keyword">val</span> resultDataSet<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> joinResult<span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>equalTo<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span>x<span class="token punctuation">.</span>_1<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> x<span class="token punctuation">.</span>_1<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> x<span class="token punctuation">.</span>_2<span class="token punctuation">.</span>_2<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    resultDataSet<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
(1,张三,18)
(2,李四,35)
(3,王五,42)
*/</span>
</code></pre></div><h5 id="_5-4-leftouterjoin、rightouterjoin"><a href="#_5-4-leftouterjoin、rightouterjoin" class="header-anchor">#</a> 5.4 leftOuterJoin、rightOuterJoin</h5> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo7</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>JoinFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>ExecutionEnvironment

<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable<span class="token punctuation">.</span></span>ArrayBuffer

<span class="token keyword">object</span> OutJoinDataSet <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token keyword">val</span> environment<span class="token operator">:</span> ExecutionEnvironment <span class="token operator">=</span> ExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token keyword">val</span> array1 <span class="token operator">=</span> ArrayBuffer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;王五&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">&quot;张飞&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> array2 <span class="token operator">=</span>ArrayBuffer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;18&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;35&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;42&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&quot;50&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> firstDataStream<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>array1<span class="token punctuation">)</span>
    <span class="token keyword">val</span> secondDataStream<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>array2<span class="token punctuation">)</span>

    <span class="token comment">//左外连接</span>
    <span class="token keyword">val</span> leftOuterJoin<span class="token operator">:</span> UnfinishedOuterJoinOperation<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> firstDataStream<span class="token punctuation">.</span>leftOuterJoin<span class="token punctuation">(</span>secondDataStream<span class="token punctuation">)</span>

    <span class="token comment">//where指定左边流关联的字段 ，equalTo指定与右边流相同的字段</span>
     <span class="token keyword">val</span> leftDataSet<span class="token operator">:</span> JoinFunctionAssigner<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> leftOuterJoin<span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>equalTo<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment">//对关联的数据进行函数操作</span>
    <span class="token keyword">val</span> leftResult<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> leftDataSet<span class="token punctuation">.</span>apply<span class="token punctuation">(</span><span class="token keyword">new</span> JoinFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> join<span class="token punctuation">(</span>left<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> right<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> result <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>right <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Tuple3<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> left<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> <span class="token string">&quot;null&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          Tuple3<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> left<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> right<span class="token punctuation">.</span>_2<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        result
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    leftResult<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token comment">//右外连接</span>
    <span class="token keyword">val</span> rightOuterJoin<span class="token operator">:</span> UnfinishedOuterJoinOperation<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> firstDataStream<span class="token punctuation">.</span>rightOuterJoin<span class="token punctuation">(</span>secondDataStream<span class="token punctuation">)</span>

    <span class="token comment">//where指定左边流关联的字段 ，equalTo指定与右边流相同的字段</span>
    <span class="token keyword">val</span> rightDataSet<span class="token operator">:</span> JoinFunctionAssigner<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> rightOuterJoin<span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>equalTo<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment">//对关联的数据进行函数操作</span>
    <span class="token keyword">val</span> rightResult<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> rightDataSet<span class="token punctuation">.</span>apply<span class="token punctuation">(</span><span class="token keyword">new</span> JoinFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> join<span class="token punctuation">(</span>left<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> right<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> result <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Tuple3<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>right<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> right<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> <span class="token string">&quot;null&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          Tuple3<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>right<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> right<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> left<span class="token punctuation">.</span>_2<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        result
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    rightResult<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
(1,张三,张三)
(4,张飞,null)
(2,李四,李四)
(3,王五,王五)
(1,张三,18)
(4,张飞,null)
(2,李四,35)
(3,王五,42)
*/</span>
</code></pre></div><h5 id="_5-5-cross"><a href="#_5-5-cross" class="header-anchor">#</a> 5.5 cross</h5> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo7</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>ExecutionEnvironment

<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable<span class="token punctuation">.</span></span>ArrayBuffer

<span class="token keyword">object</span> CrossJoinDataSet <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> ExecutionEnvironment <span class="token operator">=</span> ExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token keyword">val</span> array1 <span class="token operator">=</span> ArrayBuffer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;王五&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">&quot;张飞&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> array2 <span class="token operator">=</span>ArrayBuffer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;18&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;35&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;42&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&quot;50&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> firstDataStream<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>array1<span class="token punctuation">)</span>
    <span class="token keyword">val</span> secondDataStream<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>array2<span class="token punctuation">)</span>

    <span class="token comment">//cross笛卡尔积</span>
    <span class="token keyword">val</span> crossDataSet<span class="token operator">:</span> CrossDataSet<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> firstDataStream<span class="token punctuation">.</span>cross<span class="token punctuation">(</span>secondDataStream<span class="token punctuation">)</span>

     crossDataSet<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h5 id="_5-6-first-n-和-sortpartition"><a href="#_5-6-first-n-和-sortpartition" class="header-anchor">#</a> 5.6 first-n 和 sortPartition</h5> <p>first()用来获取前几个元素。</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo7</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>operators<span class="token punctuation">.</span></span>Order
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>ExecutionEnvironment

<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable<span class="token punctuation">.</span></span>ArrayBuffer

<span class="token keyword">object</span> TopNAndPartition <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token keyword">val</span> environment<span class="token operator">:</span> ExecutionEnvironment <span class="token operator">=</span> ExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

     <span class="token comment">//数组</span>
    <span class="token keyword">val</span> array <span class="token operator">=</span> ArrayBuffer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;王五&quot;</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;赵6&quot;</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> collectionDataSet<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>array<span class="token punctuation">)</span>

     <span class="token comment">//获取前3个元素</span>
    collectionDataSet<span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
      

    collectionDataSet
      <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//按照第一个字段进行分组</span>
      <span class="token punctuation">.</span>sortGroup<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>Order<span class="token punctuation">.</span>DESCENDING<span class="token punctuation">)</span>  <span class="token comment">//按照第三个字段进行排序</span>
      <span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">//获取每组的前一个元素</span>
      <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">/**
      * 不分组排序，针对所有元素进行排序，第一个元素降序，第三个元素升序
      */</span>
    collectionDataSet<span class="token punctuation">.</span>sortPartition<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>Order<span class="token punctuation">.</span>DESCENDING<span class="token punctuation">)</span><span class="token punctuation">.</span>sortPartition<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>Order<span class="token punctuation">.</span>ASCENDING<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>


  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h5 id="_5-7-partition分区算子"><a href="#_5-7-partition分区算子" class="header-anchor">#</a> 5.7 partition分区算子</h5> <p>这里主要涉及到2个分区算子：</p> <ol><li>partitionByHash</li> <li>partitionByRange</li></ol> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo7</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>ExecutionEnvironment

<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable<span class="token punctuation">.</span></span>ArrayBuffer

<span class="token keyword">object</span> PartitionDataSet <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token keyword">val</span> environment<span class="token operator">:</span> ExecutionEnvironment <span class="token operator">=</span> ExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_


    <span class="token keyword">val</span> array <span class="token operator">=</span> ArrayBuffer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> sourceDataSet<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>array<span class="token punctuation">)</span>

       <span class="token comment">//partitionByHash:按照指定的字段hashPartitioner分区</span>
     sourceDataSet<span class="token punctuation">.</span>partitionByHash<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mapPartition<span class="token punctuation">(</span>eachPartition <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
         eachPartition<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>t<span class="token keyword">=&gt;</span><span class="token punctuation">{</span>
 println<span class="token punctuation">(</span><span class="token string">&quot;当前线程ID为&quot;</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span>currentThread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getId <span class="token operator">+</span><span class="token string">&quot;=============&quot;</span><span class="token operator">+</span>t<span class="token punctuation">.</span>_1<span class="token punctuation">)</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span>

        eachPartition
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>


     <span class="token comment">//partitionByRange：按照指定的字段进行范围分区</span>
    sourceDataSet<span class="token punctuation">.</span>partitionByRange<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>_1<span class="token punctuation">)</span><span class="token punctuation">.</span>mapPartition<span class="token punctuation">(</span>eachPartition <span class="token keyword">=&gt;</span><span class="token punctuation">{</span>
      eachPartition<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>t<span class="token keyword">=&gt;</span><span class="token punctuation">{</span>
println<span class="token punctuation">(</span><span class="token string">&quot;当前线程ID为&quot;</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span>currentThread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getId <span class="token operator">+</span><span class="token string">&quot;=============&quot;</span><span class="token operator">+</span>t<span class="token punctuation">.</span>_1<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      eachPartition

    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>


  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="flink的dataset-connector介绍"><a href="#flink的dataset-connector介绍" class="header-anchor">#</a> Flink的dataSet  connector介绍</h2> <p>查看官网：https://ci.apache.org/projects/flink/flink-docs-release-1.10/dev/batch/connectors.html</p> <h4 id="文件系统connector"><a href="#文件系统connector" class="header-anchor">#</a> 文件系统connector</h4> <p>为了从文件系统读取数据，Flink内置了对以下文件系统的支持:</p> <table><thead><tr><th>文件系统</th> <th>Schema</th> <th>备注</th></tr></thead> <tbody><tr><td>HDFS</td> <td>hdfs://</td> <td>Hdfs文件系统</td></tr> <tr><td>S3</td> <td>s3://</td> <td>通过hadoop文件系统实现支持</td></tr> <tr><td>MapR</td> <td>maprfs://</td> <td>需要用户添加jar</td></tr> <tr><td>Alluxio</td> <td>alluxio://</td> <td>通过hadoop文件系统实现</td></tr></tbody></table> <p>注意：<strong>Flink允许用户使用实现org.apache.hadoop.fs.FileSystem接口的任何文件系统</strong>。例如S3、 Google Cloud Storage Connector for Hadoop、 Alluxio、 XtreemFS、 FTP等各种文件系统</p> <p><strong>Flink与Apache Hadoop MapReduce接口兼容</strong>，因此允许重用Hadoop MapReduce实现的代码：</p> <ol><li>使用Hadoop Writable data type</li> <li>==使用任何Hadoop InputFormat作为DataSource==(flink内置HadoopInputFormat)</li> <li>==使用任何Hadoop OutputFormat作为DataSink==(flink内置HadoopOutputFormat)</li> <li>使用Hadoop Mapper作为FlatMapFunction</li> <li>使用Hadoop Reducer作为GroupReduceFunction</li></ol> <h4 id="flink集成hbase之数据读取"><a href="#flink集成hbase之数据读取" class="header-anchor">#</a> Flink集成Hbase之数据读取</h4> <p>Flink也可以直接与hbase进行集成，将hbase作为Flink的source和sink等</p> <p>第一步：创建hbase表并插入数据</p> <div class="language-shell extra-class"><pre class="language-shell"><code>create <span class="token string">'hbasesource'</span>,<span class="token string">'f1'</span>
put <span class="token string">'hbasesource'</span>,<span class="token string">'0001'</span>,<span class="token string">'f1:name'</span>,<span class="token string">'zhangsan'</span>
put <span class="token string">'hbasesource'</span>,<span class="token string">'0001'</span>,<span class="token string">'f1:age'</span>,<span class="token string">'18'</span>
</code></pre></div><p>第二步：导入整合jar包</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repositories</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>cloudera<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://repository.cloudera.com/artifactory/cloudera-repos/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repositories</span><span class="token punctuation">&gt;</span></span>



<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-hadoop-compatibility_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-shaded-hadoop2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 暂时没有1.9.2这个版本 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.7.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-hbase_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hbase<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hbase-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.0-cdh5.14.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hbase<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hbase-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.0-cdh5.14.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><p>第三步：开发flink集成hbase读取hbase数据</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo8</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>addons<span class="token punctuation">.</span>hbase<span class="token punctuation">.</span></span>TableInputFormat
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>ExecutionEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span>Configuration
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hbase<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Cell<span class="token punctuation">,</span> HBaseConfiguration<span class="token punctuation">,</span> HConstants<span class="token punctuation">,</span> TableName<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hbase<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hbase<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Bytes
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple</span>

<span class="token comment">/**
  * flink从hbase表中读取数据
  */</span>
<span class="token keyword">object</span> FlinkReadHBase <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

        <span class="token comment">//获取批处理的环境</span>
       <span class="token keyword">val</span> env<span class="token operator">:</span> ExecutionEnvironment <span class="token operator">=</span> ExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

       <span class="token comment">//通过InputFormat添加数据源</span>
       <span class="token keyword">val</span> hbaseDataSet<span class="token operator">=</span>env<span class="token punctuation">.</span>createInput<span class="token punctuation">(</span><span class="token keyword">new</span> TableInputFormat<span class="token punctuation">[</span>tuple<span class="token punctuation">.</span>Tuple2<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token comment">//初始化配置方法</span>
        <span class="token keyword">override</span> <span class="token keyword">def</span> configure<span class="token punctuation">(</span>parameters<span class="token operator">:</span> Configuration<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          <span class="token keyword">val</span> conf <span class="token operator">=</span> HBaseConfiguration<span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          conf<span class="token punctuation">.</span>set<span class="token punctuation">(</span>HConstants<span class="token punctuation">.</span>ZOOKEEPER_QUORUM<span class="token punctuation">,</span> <span class="token string">&quot;node01,node02,node03&quot;</span><span class="token punctuation">)</span>
          conf<span class="token punctuation">.</span>set<span class="token punctuation">(</span>HConstants<span class="token punctuation">.</span>ZOOKEEPER_CLIENT_PORT<span class="token punctuation">,</span> <span class="token string">&quot;2181&quot;</span><span class="token punctuation">)</span>
          <span class="token keyword">val</span> conn<span class="token operator">:</span> Connection <span class="token operator">=</span> ConnectionFactory<span class="token punctuation">.</span>createConnection<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
          table <span class="token operator">=</span> classOf<span class="token punctuation">[</span>HTable<span class="token punctuation">]</span><span class="token punctuation">.</span>cast<span class="token punctuation">(</span>conn<span class="token punctuation">.</span>getTable<span class="token punctuation">(</span>TableName<span class="token punctuation">.</span>valueOf<span class="token punctuation">(</span><span class="token string">&quot;hbasesource&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          scan <span class="token operator">=</span> <span class="token keyword">new</span> Scan<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            addFamily<span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span><span class="token string">&quot;f1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">def</span> getTableName<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;hbasesource&quot;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">def</span> getScanner<span class="token operator">:</span> Scan <span class="token operator">=</span> <span class="token punctuation">{</span>
          scan
        <span class="token punctuation">}</span>

        <span class="token comment">//封装hbase表数据</span>
        <span class="token keyword">override</span> <span class="token keyword">def</span> mapResultToTuple<span class="token punctuation">(</span>result<span class="token operator">:</span> Result<span class="token punctuation">)</span><span class="token operator">:</span> tuple<span class="token punctuation">.</span>Tuple2<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">{</span>
          <span class="token comment">//获取rowkey</span>
          <span class="token keyword">val</span> rowkey<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> Bytes<span class="token punctuation">.</span>toString<span class="token punctuation">(</span>result<span class="token punctuation">.</span>getRow<span class="token punctuation">)</span>
          <span class="token keyword">val</span> rawCells<span class="token operator">:</span> Array<span class="token punctuation">[</span>Cell<span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">.</span>rawCells<span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">val</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> StringBuffer<span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>cell <span class="token keyword">&lt;-</span> rawCells<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> value <span class="token operator">=</span> Bytes<span class="token punctuation">.</span>toString<span class="token punctuation">(</span>cell<span class="token punctuation">.</span>getValueArray<span class="token punctuation">,</span> cell<span class="token punctuation">.</span>getValueOffset<span class="token punctuation">,</span> cell<span class="token punctuation">.</span>getValueLength<span class="token punctuation">)</span>
            sb<span class="token punctuation">.</span>append<span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">val</span> valueString <span class="token operator">=</span> sb<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>sb<span class="token punctuation">.</span>length<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> sb<span class="token punctuation">.</span>length<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toString
          <span class="token keyword">val</span> tuple2 <span class="token operator">=</span> <span class="token keyword">new</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Tuple2<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span>
          <span class="token comment">//给元素的下标赋值</span>
          tuple2<span class="token punctuation">.</span>setField<span class="token punctuation">(</span>rowkey<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
          tuple2<span class="token punctuation">.</span>setField<span class="token punctuation">(</span>valueString<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
          tuple2

        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    hbaseDataSet<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>


  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*运行结果为：
(0001,18,zhangsan)
*/</span>
</code></pre></div><h4 id="flink读取数据-然后写入hbase"><a href="#flink读取数据-然后写入hbase" class="header-anchor">#</a> Flink读取数据，然后写入hbase</h4> <p>Flink也可以集成Hbase实现将数据写入到Hbase里面去</p> <ol><li><p>第一种：实现OutputFormat接口</p></li> <li><p>第二种：继承RichSinkFunction重写父类方法</p></li></ol> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo8</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>OutputFormat
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>ExecutionEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span>Configuration
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hbase<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hbase<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Bytes
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hbase<span class="token punctuation">.</span></span><span class="token punctuation">{</span>HBaseConfiguration<span class="token punctuation">,</span> HConstants<span class="token punctuation">,</span> TableName<span class="token punctuation">}</span>

<span class="token comment">/**
  * flink写数据到hbase表中
  */</span>
<span class="token keyword">object</span> FlinkWriteHBase <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> ExecutionEnvironment <span class="token operator">=</span> ExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
     <span class="token comment">//准备数据</span>
    <span class="token keyword">val</span> sourceDataSet<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromElements<span class="token punctuation">(</span><span class="token string">&quot;0002,lisi,28&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;0003,wangwu,30&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//使用OutputFormat接口，写数据到hbase表中</span>
    sourceDataSet<span class="token punctuation">.</span>output<span class="token punctuation">(</span><span class="token keyword">new</span> HBaseOutputFormat<span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

  <span class="token comment">//定义OutputFormat接口</span>
  <span class="token keyword">class</span> HBaseOutputFormat <span class="token keyword">extends</span> OutputFormat<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
    <span class="token keyword">val</span> zkServer <span class="token operator">=</span> <span class="token string">&quot;node01,node02,node03&quot;</span>
    <span class="token keyword">val</span> port <span class="token operator">=</span> <span class="token string">&quot;2181&quot;</span>
    <span class="token keyword">var</span> conn<span class="token operator">:</span> Connection <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token keyword">override</span> <span class="token keyword">def</span> configure<span class="token punctuation">(</span>parameters<span class="token operator">:</span> Configuration<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> open<span class="token punctuation">(</span>taskNumber<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> numTasks<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> config<span class="token operator">:</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>Configuration <span class="token operator">=</span> HBaseConfiguration<span class="token punctuation">.</span>create
    config<span class="token punctuation">.</span>set<span class="token punctuation">(</span>HConstants<span class="token punctuation">.</span>ZOOKEEPER_QUORUM<span class="token punctuation">,</span> zkServer<span class="token punctuation">)</span>
    config<span class="token punctuation">.</span>set<span class="token punctuation">(</span>HConstants<span class="token punctuation">.</span>ZOOKEEPER_CLIENT_PORT<span class="token punctuation">,</span> port<span class="token punctuation">)</span>
    config<span class="token punctuation">.</span>setInt<span class="token punctuation">(</span>HConstants<span class="token punctuation">.</span>HBASE_CLIENT_OPERATION_TIMEOUT<span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">)</span>
    config<span class="token punctuation">.</span>setInt<span class="token punctuation">(</span>HConstants<span class="token punctuation">.</span>HBASE_CLIENT_SCANNER_TIMEOUT_PERIOD<span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">)</span>
    conn <span class="token operator">=</span> ConnectionFactory<span class="token punctuation">.</span>createConnection<span class="token punctuation">(</span>config<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//写数据的方法</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> writeRecord<span class="token punctuation">(</span>record<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token keyword">val</span> tableName<span class="token operator">:</span> TableName <span class="token operator">=</span> TableName<span class="token punctuation">.</span>valueOf<span class="token punctuation">(</span><span class="token string">&quot;hbasesource&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> cf1 <span class="token operator">=</span> <span class="token string">&quot;f1&quot;</span>
    <span class="token keyword">val</span> array<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> record<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> put<span class="token operator">:</span> Put <span class="token operator">=</span> <span class="token keyword">new</span> Put<span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    put<span class="token punctuation">.</span>addColumn<span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span>cf1<span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    put<span class="token punctuation">.</span>addColumn<span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span>cf1<span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span>toBytes<span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> puts <span class="token operator">=</span> <span class="token keyword">new</span> util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">[</span>Put<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    puts<span class="token punctuation">.</span>add<span class="token punctuation">(</span>put<span class="token punctuation">)</span>
    <span class="token comment">//设置缓存1m，当达到1m时数据会自动刷到hbase</span>
    <span class="token keyword">val</span> params<span class="token operator">:</span> BufferedMutatorParams <span class="token operator">=</span> <span class="token keyword">new</span> BufferedMutatorParams<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span>
    <span class="token comment">//设置缓存的大小</span>
    params<span class="token punctuation">.</span>writeBufferSize<span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> mutator<span class="token operator">:</span> BufferedMutator <span class="token operator">=</span> conn<span class="token punctuation">.</span>getBufferedMutator<span class="token punctuation">(</span>params<span class="token punctuation">)</span>
    mutator<span class="token punctuation">.</span>mutate<span class="token punctuation">(</span>puts<span class="token punctuation">)</span>
    mutator<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
    puts<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> conn<span class="token punctuation">)</span><span class="token punctuation">{</span>
      conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre></div><p>查看hbase：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:005:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> scan <span class="token string">'hbasesource'</span>
ROW                                     COLUMN+CELL                                                                                                        
 0001                                   <span class="token assign-left variable">column</span><span class="token operator">=</span>f1:age, <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token number">1588834045161</span>, <span class="token assign-left variable">value</span><span class="token operator">=</span><span class="token number">18</span>                                                                   
 0001                                   <span class="token assign-left variable">column</span><span class="token operator">=</span>f1:name, <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token number">1588834041347</span>, <span class="token assign-left variable">value</span><span class="token operator">=</span>zhangsan                                                            
 0002                                   <span class="token assign-left variable">column</span><span class="token operator">=</span>f1:age, <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token number">1588835998956</span>, <span class="token assign-left variable">value</span><span class="token operator">=</span><span class="token number">28</span>                                                                   
 0002                                   <span class="token assign-left variable">column</span><span class="token operator">=</span>f1:name, <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token number">1588835998956</span>, <span class="token assign-left variable">value</span><span class="token operator">=</span>lisi                                                                
 0003                                   <span class="token assign-left variable">column</span><span class="token operator">=</span>f1:age, <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token number">1588835998997</span>, <span class="token assign-left variable">value</span><span class="token operator">=</span><span class="token number">30</span>                                                                   
 0003                                   <span class="token assign-left variable">column</span><span class="token operator">=</span>f1:name, <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token number">1588835998997</span>, <span class="token assign-left variable">value</span><span class="token operator">=</span>wangwu                                                              
<span class="token number">3</span> row<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0.0230</span> seconds
</code></pre></div><h2 id="flink之广播变量"><a href="#flink之广播变量" class="header-anchor">#</a> Flink之广播变量</h2> <p>概念</p> <div class="language- extra-class"><pre class="language-text"><code>	广播变量允许编程人员在每台机器上保持一个只读的缓存变量，而不是传送变量的副本给tasks
广播变量创建后，它可以运行在集群中的任何function上，而不需要多次传递给集群节点。另外需要记住，不应该修改广播变量，这样才能确保每个节点获取到的值都是一致的
	一句话解释，可以理解为是一个公共的共享变量，我们可以把一个dataset 数据集广播出去，然后不同的task在节点上都能够获取到，这个数据在每个节点上只会存在一份。
	如果不使用broadcast，则在每个节点中的每个task中都需要拷贝一份dataset数据集，比较浪费内存(也就是一个节点中可能会存在多份dataset数据)。
</code></pre></div><p>用法</p> <div class="language-scala extra-class"><pre class="language-scala"><code>（<span class="token number">1</span>）：初始化数据
DataSet<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> toBroadcast <span class="token operator">=</span> env<span class="token punctuation">.</span>fromElements<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>

（<span class="token number">2</span>）：广播数据
<span class="token punctuation">.</span>withBroadcastSet<span class="token punctuation">(</span>toBroadcast<span class="token punctuation">,</span> <span class="token string">&quot;broadcastSetName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

（<span class="token number">3</span>）：获取数据
Collection<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> broadcastSet <span class="token operator">=</span> getRuntimeContext<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getBroadcastVariable<span class="token punctuation">(</span><span class="token string">&quot;broadcastSetName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

注意：
a：广播出去的变量存在于每个节点的内存中，所以这个数据集不能太大。因为广播出去的数据，会常驻内存，除非程序执行结束
b：广播变量在初始化广播出去以后不支持修改，这样才能保证每个节点的数据都是一致的。
</code></pre></div><p>案例</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo8</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>RichMapFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>ExecutionEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span>Configuration

<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable<span class="token punctuation">.</span></span>ArrayBuffer

<span class="token comment">/**
  * flink广播变量使用案例
  */</span>
<span class="token keyword">object</span> FlinkBroadCast <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> ExecutionEnvironment <span class="token operator">=</span> ExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

      <span class="token comment">//准备数据集</span>
    <span class="token keyword">val</span> userInfo <span class="token operator">=</span>ArrayBuffer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;zs&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">&quot;ww&quot;</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

     <span class="token comment">//加载数据集构建DataSet--需要广播的数据</span>
    <span class="token keyword">val</span> userDataSet<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span>

      <span class="token comment">//原始数据</span>
      <span class="token keyword">val</span> data <span class="token operator">=</span> environment<span class="token punctuation">.</span>fromElements<span class="token punctuation">(</span><span class="token string">&quot;zs&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;ww&quot;</span><span class="token punctuation">)</span>


     <span class="token comment">//在这里需要使用到RichMapFunction获取广播变量</span>
    <span class="token keyword">val</span> result <span class="token operator">=</span> data<span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token keyword">new</span> RichMapFunction<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>

        <span class="token comment">//定义一个list集合，用户接受open方法中获取到的广播变量</span>
        <span class="token keyword">var</span> listData<span class="token operator">:</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>

        <span class="token comment">//定义一个map集合，存储广播变量中的内容</span>
        <span class="token keyword">var</span> allMap  <span class="token operator">=</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

          <span class="token comment">//初始化方法  可以在open方法中获取广播变量数据</span>
        <span class="token keyword">override</span> <span class="token keyword">def</span> open<span class="token punctuation">(</span>parameters<span class="token operator">:</span> Configuration<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token comment">//获取广播变量(broadcastMapName)的值</span>
          listData<span class="token operator">=</span> getRuntimeContext<span class="token punctuation">.</span>getBroadcastVariable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;broadcastMapName&quot;</span><span class="token punctuation">)</span>
          <span class="token keyword">val</span> it <span class="token operator">=</span> listData<span class="token punctuation">.</span>iterator<span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span>hasNext<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">val</span> tuple <span class="token operator">=</span> it<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>
            allMap <span class="token operator">+=</span><span class="token punctuation">(</span>tuple<span class="token punctuation">.</span>_1 <span class="token operator">-&gt;</span> tuple<span class="token punctuation">.</span>_2<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

         <span class="token comment">//使用广播变量操作数据</span>
        <span class="token keyword">override</span> <span class="token keyword">def</span> map<span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          <span class="token keyword">val</span> age <span class="token operator">=</span> allMap<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span>
          name<span class="token operator">+</span><span class="token string">&quot;,&quot;</span><span class="token operator">+</span>age
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>withBroadcastSet<span class="token punctuation">(</span>userDataSet<span class="token punctuation">,</span><span class="token string">&quot;broadcastMapName&quot;</span><span class="token punctuation">)</span>


    result<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>RichMapFunction是一个富函数类，源代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Public</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">RichMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRichFunction</span> <span class="token keyword">implements</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span>IN<span class="token punctuation">,</span> OUT<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">OUT</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">IN</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="flink之counter-计数器-累加器"><a href="#flink之counter-计数器-累加器" class="header-anchor">#</a> Flink之Counter（计数器/累加器）</h2> <p>概念</p> <div class="language- extra-class"><pre class="language-text"><code>	Accumulator即累加器，与Mapreduce counter的应用场景差不多，都能很好地观察task在运行期间的数据变化，可以在Flink job任务中的算子函数中操作累加器，但是只能在任务执行结束之后才能获得累加器的最终结果。
	Counter是一个具体的累加器(Accumulator)实现IntCounter, LongCounter 和 DoubleCounter
</code></pre></div><p>用法</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>：创建累加器
<span class="token keyword">private</span> IntCounter numLines <span class="token operator">=</span> <span class="token keyword">new</span> IntCounter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>：注册累加器
getRuntimeContext<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>addAccumulator<span class="token punctuation">(</span><span class="token string">&quot;num-lines&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>numLines<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>：使用累加器
<span class="token keyword">this</span><span class="token punctuation">.</span>numLines<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>：获取累加器的结果
myJobExecutionResult<span class="token punctuation">.</span>getAccumulatorResult<span class="token punctuation">(</span><span class="token string">&quot;num-lines&quot;</span><span class="token punctuation">)</span>

</code></pre></div><p>案例</p> <p>需求：通过计数器来实现统计文件当中Exception关键字出现的次数</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo8</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>accumulators<span class="token punctuation">.</span></span><span class="token class-name">LongCounter</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">RichMapFunction</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token class-name">ExecutionEnvironment</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span>

<span class="token comment">/**
  * 通过计数器来实现统计文件当中Exception关键字出现的次数
  */</span>
object <span class="token class-name">FlinkCounterAndAccumulator</span> <span class="token punctuation">{</span>

  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    val env<span class="token operator">=</span><span class="token class-name">ExecutionEnvironment</span><span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">//统计tomcat日志当中exception关键字出现了多少次</span>
    val sourceDataSet<span class="token operator">:</span> <span class="token class-name">DataSet</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span><span class="token string">&quot;E:\\catalina.out&quot;</span><span class="token punctuation">)</span>

      sourceDataSet<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RichMapFunction</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
         <span class="token comment">//创建累加器</span>
        <span class="token keyword">var</span> counter<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LongCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      override def <span class="token keyword">open</span><span class="token punctuation">(</span>parameters<span class="token operator">:</span> <span class="token class-name">Configuration</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment">//注册累加器</span>
        getRuntimeContext<span class="token punctuation">.</span><span class="token function">addAccumulator</span><span class="token punctuation">(</span><span class="token string">&quot;my-accumulator&quot;</span><span class="token punctuation">,</span>counter<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

        <span class="token comment">//实现业务逻辑</span>
      override def <span class="token function">map</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;exception&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">//满足条件累加器加1</span>
          counter<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        value
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeAsText</span><span class="token punctuation">(</span><span class="token string">&quot;E:\\test&quot;</span><span class="token punctuation">)</span>

    val job<span class="token operator">=</span>env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//获取累加器，并打印累加器的值</span>
    val count<span class="token operator">=</span>job<span class="token punctuation">.</span>getAccumulatorResult<span class="token punctuation">[</span><span class="token class-name">Long</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;my-accumulator&quot;</span><span class="token punctuation">)</span>
	
	<span class="token comment">//打印</span>
    <span class="token function">println</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>


  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h2 id="分布式缓存"><a href="#分布式缓存" class="header-anchor">#</a> 分布式缓存</h2> <p>概念</p> <p>Flink提供了一个类似于hadoop分布式缓存，可以使用户在并行函数中很方便的读取本地文件。前面讲到的广播变量是将一些共享的数据<strong>放在TaskManager内存中</strong>，而Distribute cache是从外部加载一个文件/目录(例如hdfs)，然后分别<strong>复制到每一个TaskManager的本地磁盘中</strong>。</p> <p>用法</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>：使用Flink运行环境调用registerCachedFile注册一个分布式缓存
env<span class="token punctuation">.</span>registerCachedFile<span class="token punctuation">(</span><span class="token string">&quot;hdfs:///path/to/your/file&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hdfsFile&quot;</span><span class="token punctuation">)</span>  

<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">:</span> 获取分布式缓存
File myFile <span class="token operator">=</span> getRuntimeContext<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getDistributedCache<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getFile<span class="token punctuation">(</span><span class="token string">&quot;hdfsFile&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>案例</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo8</span>


<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>FileUtils
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>RichMapFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>ExecutionEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span>Configuration

<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Source

<span class="token comment">/**
  * flink的分布式缓存使用
  */</span>
<span class="token keyword">object</span> FlinkDistributedCache <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

      <span class="token keyword">val</span> env <span class="token operator">=</span> ExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

      <span class="token comment">//准备数据集</span>
      <span class="token keyword">val</span> scoreDataSet  <span class="token operator">=</span> env<span class="token punctuation">.</span>fromElements<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;语文&quot;</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;数学&quot;</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;英文&quot;</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token comment">//todo:1、注册分布式缓存文件</span>
      env<span class="token punctuation">.</span>registerCachedFile<span class="token punctuation">(</span><span class="token string">&quot;E:\\distribute_cache_student.txt&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;student&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">//对成绩数据集进行map转换，将（学生ID, 学科, 分数）转换为（学生姓名，学科，分数）</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> DataSet<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> scoreDataSet<span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token keyword">new</span> RichMapFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>

      <span class="token keyword">var</span> list<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> _

      <span class="token comment">//初始化方法</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> open<span class="token punctuation">(</span>parameters<span class="token operator">:</span> Configuration<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

        <span class="token comment">//获取分布式缓存的文件</span>
        <span class="token keyword">val</span> file <span class="token operator">=</span> getRuntimeContext<span class="token punctuation">.</span>getDistributedCache<span class="token punctuation">.</span>getFile<span class="token punctuation">(</span><span class="token string">&quot;student&quot;</span><span class="token punctuation">)</span>

        <span class="token comment">//获取文件的内容</span>
         <span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span>JavaConverters<span class="token punctuation">.</span>_
         <span class="token keyword">val</span> listData<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> FileUtils<span class="token punctuation">.</span>readLines<span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">.</span>asScala<span class="token punctuation">.</span>toList
        <span class="token comment">//将文本转换为元组（学生ID，学生姓名)</span>
        list <span class="token operator">=</span> listData<span class="token punctuation">.</span>map <span class="token punctuation">{</span>
          line <span class="token keyword">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">val</span> array <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span> array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span>


      <span class="token comment">//在map方法中使用分布式缓存数据进行转换</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> map<span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取学生id</span>
        <span class="token keyword">val</span> studentId<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> value<span class="token punctuation">.</span>_1
        <span class="token keyword">val</span> studentName<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> list<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> studentId <span class="token operator">==</span> x<span class="token punctuation">.</span>_1<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_2

        <span class="token comment">//封装结果返回</span>
        <span class="token comment">// 将成绩数据(学生ID，学科，成绩) -&gt; (学生姓名，学科，成绩)</span>
        <span class="token punctuation">(</span>studentName<span class="token punctuation">,</span> value<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> value<span class="token punctuation">.</span>_3<span class="token punctuation">)</span>

      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

     result<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="flink的task之间传输数据方式以及operator-chain"><a href="#flink的task之间传输数据方式以及operator-chain" class="header-anchor">#</a> Flink的task之间传输数据方式以及Operator Chain</h2> <p>Operator是算子的意思。</p> <h4 id="数据传输的方式"><a href="#数据传输的方式" class="header-anchor">#</a> 数据传输的方式</h4> <ul><li><p>forward strategy</p> <ul><li>转发策略</li></ul> <div class="language- extra-class"><pre class="language-text"><code>（1） 一个 task 的输出只发送给一个 task 作为输入
（2） 如果两个 task 都在一个 JVM 中的话，那么就可以避免网络开销
</code></pre></div></li></ul> <p><img src="/assets/img/1587367817075.e88547d6.png" alt="1587367817075"></p> <ul><li><p>key-based strategy</p> <ul><li>基于键的策略</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>（1）数据需要按照某个属性<span class="token punctuation">(</span>我们称为 key<span class="token punctuation">)</span>进行分组<span class="token punctuation">(</span>或者说分区<span class="token punctuation">)</span>
（2）相同key的数据需要传输给同一个task，在一个task中进行处理
</code></pre></div></li></ul> <p><img src="/assets/img/1587368188020.65f0c9d9.png" alt="1587368188020"></p> <ul><li><p>broadcast strategy</p> <ul><li>广播策略</li></ul> <div class="language- extra-class"><pre class="language-text"><code>（1）数据随机的从一个task中传输给下一个operator所有的subtask。因为这种策略涉及数据复制和网络通信，所以成本相当高。
</code></pre></div></li></ul> <p><img src="/assets/img/1587368455285.7ec0e85d.png" alt="1587368455285"></p> <ul><li><p>random strategy</p> <ul><li>随机策略</li></ul> <div class="language- extra-class"><pre class="language-text"><code>（1）数据随机的从一个task中传输给下一个operator所有的subtask
（2）保证数据能均匀的传输给所有的subtask,以便在任务之间均匀地分配负载
</code></pre></div></li></ul> <p><img src="/assets/img/1587368734607.5a62614f.png" alt="1587368734607"></p> <p>PS:</p> <p><strong>转发与随机策略是基于key-based策略的</strong>；转发策略和随机策略也可以看作是基于键的策略的变体，其中前者保存上游元组的键，而后者执行键的随机重新分配。</p> <h4 id="operator-chain"><a href="#operator-chain" class="header-anchor">#</a> Operator Chain</h4> <p>概念</p> <div class="language- extra-class"><pre class="language-text"><code>	operator chain是指将满足一定条件的operator链在一起，放在同一个task里面执行，是Flink任务优化的一种方式，在同一个task里面的operator的数据传输变成函数调用关系，它能减少线程之间的切换，减少消息的序列化/反序列化，减少数据在缓冲区的交换，减少了延迟的同时提高整体的吞吐量。
	
	常见的chain，例如：source-&gt;map-&gt;filter，这样的任务链可以chain在一起，那么其内部是如何决定是否能够chain在一起的呢？
</code></pre></div><p>Operator Chain的条件</p> <div class="language- extra-class"><pre class="language-text"><code>（1） 数据传输策略是 forward strategy
（2） 在同一个TaskManager中运行
</code></pre></div><p>在我们的单词技术统计程序当中，设置对应的并行度，便会发生operator chain这个动作了</p> <p><img src="/assets/img/1587380754504.d787f267.png" alt="1587380754504"></p> <p><img src="/assets/img/1587380798047.7d378bee.png" alt="1587380798047"></p> <p><img src="/assets/img/1587380857265.77966443.png" alt="1587380857265"></p> <p><img src="/assets/img/1587378064113.b657b5ee.png" alt="1587378064113"></p> <h2 id="flink的state"><a href="#flink的state" class="header-anchor">#</a> Flink的State</h2> <h5 id="_1-1-state概述"><a href="#_1-1-state概述" class="header-anchor">#</a> 1.1 state概述</h5> <p><strong>Apache Flink® — Stateful Computations over Data Streams</strong></p> <p>Flink 是一个默认就有状态的分析引擎，前面的WordCount 案例可以做到单词的数量的累加，其实是因为在内存中保证了每个单词的出现的次数，这些数据其实就是状态数据。但是如果一个 Task 在处理过程中挂掉了，那么它在内存中的状态都会丢失，所有的数据都需要重新计算。从容错和消息处理的语义（<strong>At -least-once 和 Exactly-once</strong>）上来说，Flink引入了State 和 CheckPoint。</p> <p>State一般指一个具体的 Task/Operator 的状态，<strong>State数据默认保存在 Java 的堆内存中</strong></p> <p>回顾单词计数的例子</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>demo1</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">,</span> WindowedStream<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow

<span class="token comment">/**
  * 使用滑动窗口
  * 每隔1秒钟统计最近2秒钟的每个单词出现的次数
  */</span>
<span class="token keyword">object</span> FlinkStream <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">//构建流处理的环境</span>
      <span class="token keyword">val</span> env<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

  <span class="token comment">//从socket获取数据</span>
<span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>
 <span class="token comment">//导入隐式转换的包</span>
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
 
 <span class="token comment">//对数据进行处理</span>
  <span class="token keyword">val</span> result<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream
                                <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//按照空格切分</span>
                                <span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//每个单词计为1</span>
                                <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>         <span class="token comment">//按照下标为0的单词进行分组</span>
                                <span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>          <span class="token comment">//按照下标为1累加相同单词出现的1</span>


    <span class="token comment">//对数据进行打印</span>
    result<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//开启任务</span>
     env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;FlinkStream&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><p>输入</p> <div class="language- extra-class"><pre class="language-text"><code>hadoop hadoop
hadoop
hive hadoop 
</code></pre></div><p>输出</p> <div class="language- extra-class"><pre class="language-text"><code>8&gt; (hadoop,1)
1&gt; (hive,1)
8&gt; (hadoop,2)
8&gt; (hadoop,3)
8&gt; (hadoop,4)
</code></pre></div><p><img src="/assets/img/state.8f1ff420.png" alt="1587390209212"></p> <h5 id="_1-2-stage类型"><a href="#_1-2-stage类型" class="header-anchor">#</a> 1.2 stage类型</h5> <p>Flink中有两种基本类型的State, <strong>Keyed State和Operator State</strong>，他们两种都可以以两种形式存在：</p> <ul><li>原始状态(raw state)
<ul><li>由算子自己管理数据结构，当触发Checkpoint操作过程中，Flink并不知道状态数据内部的数据结构，只是将数据转换成bytes数据存储在Checkpoints中，当从Checkpoints恢复任务时，算子自己再反序列化出状态的数据结构。</li></ul></li> <li>托管状态(managed state)
<ul><li>由<strong>Flink Runtime</strong>控制和管理状态数据，并将状态数据转换成为内存的Hash tables或 RocksDB的对象存储，然后将这些数据通过内部的接口持久化到checkpoints中，任务异常时可以通过这些状态数据恢复任务。</li> <li><strong>推荐使用ManagedState管理状态数据</strong>，ManagedState更好的支持状态数据的重平衡以及更加完善的内存管理</li></ul></li></ul> <h6 id="_1-2-1-operator-state-算子状态"><a href="#_1-2-1-operator-state-算子状态" class="header-anchor">#</a> 1.2.1  Operator State(算子状态)</h6> <ul><li>operator state是task级别的state，<strong>说白了就是每个task对应一个state</strong></li> <li>Kafka Connector source中的每个分区（task）都需要记录消费的topic的partition和offset等信息。</li> <li><strong>operator state 只有一种托管状态：ValueState</strong></li></ul> <p>![1587391007087](flink.assets/Operator State.png)</p> <h6 id="_1-2-2-keyed-state-键控状态"><a href="#_1-2-2-keyed-state-键控状态" class="header-anchor">#</a> 1.2.2 keyed State(键控状态)</h6> <p>Keyed State：顾名思义就是基于KeyedStream上的状态，这个状态是跟特定的Key 绑定的。KeyedStream流上的<strong>每一个Key，都对应一个State</strong>。Flink针对 Keyed State 提供了以下可以保存State的数据结构.</p> <p><strong>Keyed state托管状态有六种类型</strong>：</p> <p>1、==ValueState==</p> <p>保存一个可以更新和检索的值（如上所述，每个值都对应到当前的输入数据的key，因此算子接收到的每个key都可能对应一个值）。 这个值可以通过update(T) 进行更新，通过 T value() 进行检索</p> <p>2、==ListState==</p> <p>保存一个元素的列表。可以往这个列表中追加数据，并在当前的列表上进行检索。可以通过 add(T) 或者<code>addAll(List&lt;T&gt;</code>) 进行添加元素，通过<code>Iterable&lt;T&gt; get()</code> 获得整个列表。还可以通过 <code>update(List&lt;T&gt;</code>) 覆盖当前的列表	。</p> <p>3、==MapState==</p> <p>​	维护了一个映射列表。 你可以添加键值对到状态中，也可以获得 反映当前所有映射的迭代器。使用 put(UK，UV) 或者 putAll(<code>Map&lt;UK，UV&gt;</code>) 添加映射。 使用 get(UK) 检索特定 key。 使用 entries()，keys() 和 values() 分别检索映射、 键和值的可迭代视图。</p> <p>4、ReducingState</p> <p>保存一个单值，表示添加到状态的所有值的聚合。接口与ListState类似，但<strong>使用add(T) 增加元素，会使用提供的 ReduceFunction 进行聚合</strong>。</p> <p>5、AggregatingState</p> <p><code>AggregatingState&lt;IN, OUT&gt;</code>: 保留一个单值，表示添加到状态的所有值的聚合。和 ReducingState 相反的是, 聚合类型可能与 添加到状态的元素的类型不同。 接口与 ListState类似，<strong>但使用 add(IN) 添加的元素会用指定的 AggregateFunction 进行聚合</strong></p> <p>6、FoldingState</p> <p>保留一个单值，表示添加到状态的所有值的聚合。 与ReducingState 相反，聚合类型可能与添加到状态的元素类型不同。接口与 ListState 类似，但使用 add（T）添加的元素会用指定的 FoldFunction 折叠成聚合值。在Flink1.4中弃用，未来版本将被完全删除。</p> <p>![1587393629878](flink.assets/keyed State.png)</p> <h5 id="_1-3-keyed-state案例演示"><a href="#_1-3-keyed-state案例演示" class="header-anchor">#</a> 1.3 Keyed State案例演示</h5> <h6 id="_1-3-1-valuestate"><a href="#_1-3-1-valuestate" class="header-anchor">#</a> 1.3.1 ValueState</h6> <ul><li><p>作用</p> <ul><li>保存一个可以更新和检索的值</li></ul></li> <li><p>需求</p> <ul><li>使用valueState实现平均值求取</li></ul></li> <li><p>代码开发</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>keystate</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>RichFlatMapFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token punctuation">{</span>ValueState<span class="token punctuation">,</span> ValueStateDescriptor<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span>Configuration
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamExecutionEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token comment">/**
  * 使用valueState实现平均值求取
  */</span>
<span class="token keyword">object</span> ValueStateOperate <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

      env<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>List<span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">3d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">5d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">7d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">4d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">2d</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span>
        <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span><span class="token keyword">new</span> CountWindowAverage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> CountWindowAverage <span class="token keyword">extends</span> RichFlatMapFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token comment">//定义ValueState类型的变量</span>
  <span class="token comment">//Scala中必须要显式指定类成员默认值，如果你比较懒，可以用_让编译器自动帮你设置初始值</span>
  <span class="token keyword">private</span> <span class="token keyword">var</span> sum<span class="token operator">:</span> ValueState<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> _


  <span class="token keyword">override</span> <span class="token keyword">def</span> open<span class="token punctuation">(</span>parameters<span class="token operator">:</span> Configuration<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//初始化获取历史状态的值</span>
    sum <span class="token operator">=</span> getRuntimeContext<span class="token punctuation">.</span>getState<span class="token punctuation">(</span>
      <span class="token keyword">new</span> ValueStateDescriptor<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;average&quot;</span><span class="token punctuation">,</span> classOf<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> flatMap<span class="token punctuation">(</span>input<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// access the state value</span>
    <span class="token keyword">val</span> tmpCurrentSum <span class="token operator">=</span> sum<span class="token punctuation">.</span>value
    <span class="token comment">// If it hasn't been used before, it will be null</span>
    <span class="token keyword">val</span> currentSum <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tmpCurrentSum <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tmpCurrentSum
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">,</span> <span class="token number">0d</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// update the count</span>
    <span class="token keyword">val</span> newSum <span class="token operator">=</span> <span class="token punctuation">(</span>currentSum<span class="token punctuation">.</span>_1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> currentSum<span class="token punctuation">.</span>_2 <span class="token operator">+</span> input<span class="token punctuation">.</span>_2<span class="token punctuation">)</span>

    <span class="token comment">// update the state</span>
    sum<span class="token punctuation">.</span>update<span class="token punctuation">(</span>newSum<span class="token punctuation">)</span>

    <span class="token comment">// if the count reaches 2, emit the average and clear the state</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newSum<span class="token punctuation">.</span>_1 <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> newSum<span class="token punctuation">.</span>_2 <span class="token operator">/</span> newSum<span class="token punctuation">.</span>_1<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//将状态清除</span>
      <span class="token comment">//sum.clear()</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
<span class="token comment">/*运行结果：
5&gt; (1,4.0)
5&gt; (1,5.0)
5&gt; (1,4.75)
5&gt; (1,4.2)
*/</span>
</code></pre></div></li></ul> <h6 id="_1-3-2-liststate"><a href="#_1-3-2-liststate" class="header-anchor">#</a> 1.3.2 ListState</h6> <ul><li><p>作用</p> <ul><li>用于保存每个key的历史数据数据成为一个列表</li></ul></li> <li><p>需求</p> <ul><li>使用ListState求取数据平均值</li></ul></li> <li><p>代码开发</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>keystate</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collections

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>RichFlatMapFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token punctuation">{</span>ListState<span class="token punctuation">,</span> ListStateDescriptor<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span>Configuration
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamExecutionEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token comment">/**
  * 使用ListState实现平均值求取
  * ListState&lt;T&gt; ：这个状态为每一个 key 保存集合的值
  *      get() 获取状态值
  *      add() / addAll() 更新状态值，将数据放到状态中
  *      clear() 清除状态
  */</span>
<span class="token keyword">object</span> ListStateOperate <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    env<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>List<span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">3d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">5d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">7d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">,</span> <span class="token number">4d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">,</span> <span class="token number">2d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">,</span> <span class="token number">6d</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span><span class="token keyword">new</span> CountWindowAverageWithList<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token keyword">class</span> CountWindowAverageWithList <span class="token keyword">extends</span> RichFlatMapFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span><span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span><span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
  <span class="token comment">//定义我们历史所有的数据获取</span>
  <span class="token keyword">private</span> <span class="token keyword">var</span> elementsByKey<span class="token operator">:</span> ListState<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span><span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> _

  <span class="token keyword">override</span> <span class="token keyword">def</span> open<span class="token punctuation">(</span>parameters<span class="token operator">:</span> Configuration<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//初始化获取历史状态的值，每个key对应的所有历史值，都存储在list集合里面了</span>
    <span class="token keyword">val</span> listState <span class="token operator">=</span> <span class="token keyword">new</span> ListStateDescriptor<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span><span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;listState&quot;</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span><span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    elementsByKey <span class="token operator">=</span> getRuntimeContext<span class="token punctuation">.</span>getListState<span class="token punctuation">(</span>listState<span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> flatMap<span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取当前key的状态值</span>
   <span class="token keyword">val</span> currentState<span class="token operator">:</span> lang<span class="token punctuation">.</span>Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elementsByKey<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//如果初始状态为空，那么就进行初始化，构造一个空的集合出来，准备用于存储后续的数据</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>currentState <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      elementsByKey<span class="token punctuation">.</span>addAll<span class="token punctuation">(</span>Collections<span class="token punctuation">.</span>emptyList<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//添加元素</span>
    elementsByKey<span class="token punctuation">.</span>add<span class="token punctuation">(</span>element<span class="token punctuation">)</span>
    <span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span>JavaConverters<span class="token punctuation">.</span>_
    <span class="token keyword">val</span> allElements<span class="token operator">:</span> Iterator<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elementsByKey<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>iterator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>asScala
      
    <span class="token keyword">val</span> allElementList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> allElements<span class="token punctuation">.</span>toList
    <span class="token keyword">if</span><span class="token punctuation">(</span>allElementList<span class="token punctuation">.</span>size <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">0L</span>
      <span class="token keyword">var</span> sum <span class="token operator">=</span> <span class="token number">0d</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span> allElementList<span class="token punctuation">)</span><span class="token punctuation">{</span>
        count <span class="token operator">+=</span><span class="token number">1</span>
        sum <span class="token operator">+=</span> eachElement<span class="token punctuation">.</span>_2
      <span class="token punctuation">}</span>
      out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>_1<span class="token punctuation">,</span>sum<span class="token operator">/</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*运行结果为：
6&gt; (2,4.0)
5&gt; (1,5.0)
*/</span>
</code></pre></div></li></ul> <h6 id="_1-3-3-mapstate"><a href="#_1-3-3-mapstate" class="header-anchor">#</a> 1.3.3 MapState</h6> <ul><li><p>作用</p> <ul><li>用于将每个key对应的数据都保存成一个map集合</li></ul></li> <li><p>需求</p> <ul><li>使用MapState求取每个key对应的平均值</li></ul></li> <li><p>代码开发</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>keystate</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>UUID

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>RichFlatMapFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token punctuation">{</span>MapState<span class="token punctuation">,</span> MapStateDescriptor<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span>Configuration
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamExecutionEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token comment">/**
  * 使用MapState求取每个key对应的平均值
  */</span>
<span class="token keyword">object</span> MapStateOperate <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>


    <span class="token keyword">val</span> env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    env<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>List<span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">3d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">5d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">7d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">,</span> <span class="token number">4d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">,</span> <span class="token number">2d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">,</span> <span class="token number">6d</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span><span class="token keyword">new</span> CountWithAverageMapState<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> CountWithAverageMapState <span class="token keyword">extends</span> RichFlatMapFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span><span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span><span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">var</span> mapState<span class="token operator">:</span>MapState<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Double</span><span class="token punctuation">]</span> <span class="token operator">=</span> _

  <span class="token comment">//初始化获取mapState对象</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> open<span class="token punctuation">(</span>parameters<span class="token operator">:</span> Configuration<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> mapStateOperate <span class="token operator">=</span> <span class="token keyword">new</span> MapStateDescriptor<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Double</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;mapStateOperate&quot;</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token builtin">Double</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    mapState <span class="token operator">=</span> getRuntimeContext<span class="token punctuation">.</span>getMapState<span class="token punctuation">(</span>mapStateOperate<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> flatMap<span class="token punctuation">(</span>input<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//将相同的key对应的数据放到一个map集合当中去，就是这种对应  1 -&gt; List[Map,Map,Map]</span>
    <span class="token comment">//每次都构建一个map集合</span>
    mapState<span class="token punctuation">.</span>put<span class="token punctuation">(</span>UUID<span class="token punctuation">.</span>randomUUID<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toString<span class="token punctuation">,</span>input<span class="token punctuation">.</span>_2<span class="token punctuation">)</span>
    <span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span>JavaConverters<span class="token punctuation">.</span>_

    <span class="token comment">//获取map集合当中所有的value，我们每次将数据的value给放到map的value里面去</span>
    <span class="token keyword">val</span> listState<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">Double</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapState<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>iterator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>asScala<span class="token punctuation">.</span>toList
    <span class="token keyword">if</span><span class="token punctuation">(</span>listState<span class="token punctuation">.</span>size <span class="token operator">&gt;=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">0L</span>
      <span class="token keyword">var</span> sum <span class="token operator">=</span> <span class="token number">0d</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span>eachState <span class="token keyword">&lt;-</span> listState<span class="token punctuation">)</span><span class="token punctuation">{</span>
        count <span class="token operator">+=</span><span class="token number">1</span>
        sum <span class="token operator">+=</span> eachState
      <span class="token punctuation">}</span>
      println<span class="token punctuation">(</span><span class="token string">&quot;average&quot;</span><span class="token operator">+</span> sum<span class="token operator">/</span>count<span class="token punctuation">)</span>
      out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span>input<span class="token punctuation">.</span>_1<span class="token punctuation">,</span>sum<span class="token operator">/</span>count<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*运行结果为：
average5.0
average4.0
5&gt; (1,5.0)
6&gt; (2,4.0)
*/</span>
</code></pre></div></li></ul> <ul><li><p>补充</p> <blockquote><p>UUID（Universally Unique Identifier）：通用唯一识别码，是一种软件建构的标准。</p> <p><strong>UUID 目的是让分布式系统中的所有元素，都能有唯一的辨识信息</strong>，而不需要通过中央控制端来做辨识信息的指定。</p> <p>UUID是指在一台机器上生成的数字，它保证对在同一时空中的所有机器都是唯一的。</p></blockquote></li></ul> <h6 id="_1-3-4-reducingstate"><a href="#_1-3-4-reducingstate" class="header-anchor">#</a> 1.3.4 ReducingState</h6> <ul><li><p>作用</p> <ul><li>用于数据的聚合</li></ul></li> <li><p>需求</p> <ul><li>使用ReducingState求取每个key对应的平均值</li></ul></li> <li><p>代码开发</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>keystate</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token punctuation">{</span>ReduceFunction<span class="token punctuation">,</span> RichFlatMapFunction<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token punctuation">{</span>ReducingState<span class="token punctuation">,</span> ReducingStateDescriptor<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span>Configuration
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamExecutionEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token comment">/**
  * ReducingState&lt;T&gt; ：这个状态为每一个 key 保存一个聚合之后的值
  * get() 获取状态值
  * add()  更新状态值，将数据放到状态中
  * clear() 清除状态
  */</span>

<span class="token keyword">object</span> ReduceingStateOperate <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    env<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>List<span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">3d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">5d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">7d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">,</span> <span class="token number">4d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">,</span> <span class="token number">2d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">,</span> <span class="token number">6d</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span><span class="token keyword">new</span> CountWithReduceingAverageStage<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token keyword">class</span> CountWithReduceingAverageStage <span class="token keyword">extends</span> RichFlatMapFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span><span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span><span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">{</span>

   <span class="token comment">//定义ReducingState</span>
  <span class="token keyword">private</span> <span class="token keyword">var</span> reducingState<span class="token operator">:</span>ReducingState<span class="token punctuation">[</span><span class="token builtin">Double</span><span class="token punctuation">]</span> <span class="token operator">=</span> _

  <span class="token comment">//定义一个计数器</span>
   <span class="token keyword">var</span> counter<span class="token operator">=</span><span class="token number">0L</span>


  <span class="token keyword">override</span> <span class="token keyword">def</span> open<span class="token punctuation">(</span>parameters<span class="token operator">:</span> Configuration<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">val</span> reduceSum <span class="token operator">=</span> <span class="token keyword">new</span> ReducingStateDescriptor<span class="token punctuation">[</span><span class="token builtin">Double</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;reduceSum&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> ReduceFunction<span class="token punctuation">[</span> <span class="token builtin">Double</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> reduce<span class="token punctuation">(</span>value1<span class="token operator">:</span> <span class="token builtin">Double</span><span class="token punctuation">,</span> value2<span class="token operator">:</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Double</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        value1<span class="token operator">+</span> value2
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> classOf<span class="token punctuation">[</span><span class="token builtin">Double</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment">//初始化获取mapState对象</span>
    reducingState <span class="token operator">=</span> getRuntimeContext<span class="token punctuation">.</span>getReducingState<span class="token punctuation">[</span><span class="token builtin">Double</span><span class="token punctuation">]</span><span class="token punctuation">(</span>reduceSum<span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> flatMap<span class="token punctuation">(</span>input<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//计数器+1</span>
    counter<span class="token operator">+=</span><span class="token number">1</span>
    <span class="token comment">//添加数据到reducingState</span>
    reducingState<span class="token punctuation">.</span>add<span class="token punctuation">(</span>input<span class="token punctuation">.</span>_2<span class="token punctuation">)</span>

    out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span>input<span class="token punctuation">.</span>_1<span class="token punctuation">,</span>reducingState<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>counter<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
6&gt; (2,4.0)
5&gt; (1,3.0)
6&gt; (2,3.0)
5&gt; (1,4.0)
6&gt; (2,4.0)
5&gt; (1,5.0)
*/</span>
</code></pre></div></li></ul> <h6 id="_1-3-5-aggregatingstate"><a href="#_1-3-5-aggregatingstate" class="header-anchor">#</a> 1.3.5 AggregatingState</h6> <p>Aggregating  [ˈæɡrɪɡeɪtɪŋ]</p> <ul><li><p>作用</p> <ul><li>将相同key的数据进行聚合</li></ul></li> <li><p>需求</p> <ul><li>将相同key的数据聚合成为一个字符串</li></ul></li> <li><p>代码开发</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>keystate</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token punctuation">{</span>AggregateFunction<span class="token punctuation">,</span> RichFlatMapFunction<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token punctuation">{</span>AggregatingState<span class="token punctuation">,</span> AggregatingStateDescriptor<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span>Configuration
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamExecutionEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token comment">/**
  * 将相同key的数据聚合成为一个字符串
  */</span>
<span class="token keyword">object</span> AggregrageStateOperate <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

      <span class="token keyword">val</span> env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
      env<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>List<span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">3d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">5d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">7d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">,</span> <span class="token number">4d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">,</span> <span class="token number">2d</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">,</span> <span class="token number">6d</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span>
        <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span><span class="token keyword">new</span> AggregrageState<span class="token punctuation">)</span>
        <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

      env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
    *   (1L, 3d),
        (1L, 5d),
        (1L, 7d),   把相同key的value拼接字符串：Contains+and+3+and+5+and+7
    */</span>
  <span class="token keyword">class</span> AggregrageState <span class="token keyword">extends</span> RichFlatMapFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span><span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">{</span>

     <span class="token comment">//定义AggregatingState</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> aggregateTotal<span class="token operator">:</span>AggregatingState<span class="token punctuation">[</span><span class="token builtin">Double</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> _

    <span class="token keyword">override</span> <span class="token keyword">def</span> open<span class="token punctuation">(</span>parameters<span class="token operator">:</span> Configuration<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">/**
        * name: String,
        * aggFunction: AggregateFunction[IN, ACC, OUT],
        * stateType: Class[ACC]
        */</span>
      <span class="token keyword">val</span> aggregateStateDescriptor <span class="token operator">=</span> <span class="token keyword">new</span> AggregatingStateDescriptor<span class="token punctuation">[</span><span class="token builtin">Double</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;aggregateState&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> AggregateFunction<span class="token punctuation">[</span><span class="token builtin">Double</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
         <span class="token comment">//创建一个初始值</span>
        <span class="token keyword">override</span> <span class="token keyword">def</span> createAccumulator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;Contains&quot;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//对数据进行累加</span>
        <span class="token keyword">override</span> <span class="token keyword">def</span> add<span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">Double</span><span class="token punctuation">,</span> accumulator<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;Contains&quot;</span><span class="token punctuation">.</span>equals<span class="token punctuation">(</span>accumulator<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            accumulator <span class="token operator">+</span> value
          <span class="token punctuation">}</span>

          accumulator <span class="token operator">+</span> <span class="token string">&quot;and&quot;</span> <span class="token operator">+</span> value
        <span class="token punctuation">}</span>

         <span class="token comment">//获取累加的结果</span>
        <span class="token keyword">override</span> <span class="token keyword">def</span> getResult<span class="token punctuation">(</span>accumulator<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          accumulator
        <span class="token punctuation">}</span>

        <span class="token comment">//数据合并的规则</span>
        <span class="token keyword">override</span> <span class="token keyword">def</span> merge<span class="token punctuation">(</span>a<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          a <span class="token operator">+</span> <span class="token string">&quot;and&quot;</span> <span class="token operator">+</span> b
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> classOf<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      aggregateTotal <span class="token operator">=</span> getRuntimeContext<span class="token punctuation">.</span>getAggregatingState<span class="token punctuation">(</span>aggregateStateDescriptor<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">def</span> flatMap<span class="token punctuation">(</span>input<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

      aggregateTotal<span class="token punctuation">.</span>add<span class="token punctuation">(</span>input<span class="token punctuation">.</span>_2<span class="token punctuation">)</span>
      out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span>input<span class="token punctuation">.</span>_1<span class="token punctuation">,</span>aggregateTotal<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre></div></li></ul> <h5 id="_1-4-operator-state案例演示"><a href="#_1-4-operator-state案例演示" class="header-anchor">#</a> 1.4  Operator State案例演示</h5> <ul><li>需求
<ul><li>实现每两条数据进行输出打印一次，不用区分数据的key</li> <li>这里使用ListState实现</li></ul></li></ul> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>operatorstate</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>sink<span class="token punctuation">.</span></span>SinkFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>

<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable<span class="token punctuation">.</span></span>ListBuffer

<span class="token comment">/**
  * 实现每两条数据进行输出打印一次，不用区分数据的key
  */</span>
<span class="token keyword">object</span> OperatorListState <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>List<span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token string">&quot;spark&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">&quot;hadoop&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">&quot;hive&quot;</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">&quot;flume&quot;</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>

    sourceStream<span class="token punctuation">.</span>addSink<span class="token punctuation">(</span><span class="token keyword">new</span> OperateTaskState<span class="token punctuation">)</span><span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> OperateTaskState <span class="token keyword">extends</span> SinkFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
  <span class="token comment">//定义一个list 用于我们每两条数据打印一下</span>
  <span class="token keyword">private</span> <span class="token keyword">var</span> listBuffer<span class="token operator">:</span>ListBuffer<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> ListBuffer<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> invoke<span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token operator">:</span> SinkFunction<span class="token punctuation">.</span>Context<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    listBuffer<span class="token punctuation">.</span>+<span class="token operator">=</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>listBuffer<span class="token punctuation">.</span>size <span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       println<span class="token punctuation">(</span>listBuffer<span class="token punctuation">)</span>

      <span class="token comment">//清空state状态</span>
      listBuffer<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token comment">/*运行结果：
ListBuffer((spark,3), (hadoop,5))
ListBuffer((hive,7), (flume,9))
*/</span>
</code></pre></div><p>def invoke的作用： Writes the given value to the sink，源代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">IN</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

	<span class="token comment">/**
	 * Writes the given value to the sink. This function is called for every record.
	 *
	 * &lt;p&gt;You have to override this method when implementing a {@code SinkFunction}, this is a
	 * {@code default} method for backward compatibility with the old-style method only.
	 *
	 * @param value The input record.
	 * @param context Additional context about the input record.
	 *
	 * @throws Exception This method may throw exceptions. Throwing an exception will cause the operation
	 *                   to fail and may trigger recovery.
	 */</span>
</code></pre></div><h2 id="flink的状态管理之state-backend"><a href="#flink的状态管理之state-backend" class="header-anchor">#</a> Flink的状态管理之State Backend</h2> <p>默认情况下，state会保存在taskmanager的内存中，checkpoint会存储在JobManager的内存中。<strong>state 的存储和checkpoint的位置取决于State Backend的配置</strong>。</p> <p>==Flink一共提供了3种StateBackend==</p> <ul><li>MemoryStateBackend
<ul><li>基于内存存储</li></ul></li> <li>FsStateBackend
<ul><li>基于文件系统存储</li></ul></li> <li>RocksDBStateBackend
<ul><li>基于数据库存储</li></ul></li></ul> <p>可以通过  ==StreamExecutionEnvironment.setStateBackend(...)==来设置state存储的位置</p> <h5 id="_2-1-memorystatebackend"><a href="#_2-1-memorystatebackend" class="header-anchor">#</a> 2.1 MemoryStateBackend</h5> <p>将数据持久化状态存储到内存当中，state数据保存在java堆内存中，执行checkpoint的时候，会把state的快照数据保存到jobmanager的内存中。<strong>基于内存的state backend在生产环境下不建议使用</strong>。</p> <p><img src="/assets/img/MemoryStateBackend.660585af.png" alt="1587460628502"></p> <p>代码配置：</p> <div class="language-scala extra-class"><pre class="language-scala"><code>environment<span class="token punctuation">.</span>setStateBackend<span class="token punctuation">(</span><span class="token keyword">new</span> MemoryStateBackend<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="_2-2-fsstatebackend"><a href="#_2-2-fsstatebackend" class="header-anchor">#</a> 2.2  FsStateBackend</h5> <p>state数据保存在taskmanager的内存中，执行checkpoint的时候，会把state的快照数据保存到配置的文件系统中。可以使用hdfs等分布式文件系统.</p> <p><strong>FsStateBackend 适合场景：状态数据特别的多</strong>，还有长时间的window算子等，它很安全，因为基于hdfs，所以数据有备份很安全。</p> <p><img src="/assets/img/FSStateBackend.5a45234d.png" alt="1587460786994"></p> <p>代码配置：</p> <div class="language-scala extra-class"><pre class="language-scala"><code>environment<span class="token punctuation">.</span>setStateBackend<span class="token punctuation">(</span><span class="token keyword">new</span> FsStateBackend<span class="token punctuation">(</span><span class="token string">&quot;hdfs://node01:8020/flink/checkDir&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="_2-3-rocksdbstatebackend"><a href="#_2-3-rocksdbstatebackend" class="header-anchor">#</a> 2.3  RocksDBStateBackend</h5> <p>RocksDB介绍：</p> <p>RocksDB使用一套日志结构的数据库引擎，<strong>它是Flink中内置的第三方状态管理器</strong>,为了更好的性能，这套引擎是用C++编写的。 Key和value是任意大小的字节流。RocksDB跟上面的都略有不同，它会在本地文件系统中维护状态，state会直接写入本地rocksdb中。同时它需要配置一个远端的filesystem uri（一般是HDFS），<strong>在做checkpoint的时候，会把本地的数据直接复制到filesystem中</strong>。fail over的时候从filesystem中恢复到本地RocksDB克服了state受内存限制的缺点，同时又能够持久化到远端文件系统中，<strong>比较适合在生产中使用</strong>.</p> <p><img src="/assets/img/RocksDBStateBackend.a78e461b.png" alt="1587461111818"></p> <p>代码配置：导入jar包然后配置代码</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-statebackend-rocksdb_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>配置代码</p> <div class="language-scala extra-class"><pre class="language-scala"><code>environment<span class="token punctuation">.</span>setStateBackend<span class="token punctuation">(</span><span class="token keyword">new</span> RocksDBStateBackend<span class="token punctuation">(</span><span class="token string">&quot;hdfs://node01:8020/flink/checkDir&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="_2-4-修改state-backend的两种方式"><a href="#_2-4-修改state-backend的两种方式" class="header-anchor">#</a> 2.4  修改state-backend的两种方式</h5> <p>第一种：单任务调整</p> <ul><li>修改当前任务代码</li></ul> <div class="language-scala extra-class"><pre class="language-scala"><code>env<span class="token punctuation">.</span>setStateBackend<span class="token punctuation">(</span><span class="token keyword">new</span> FsStateBackend<span class="token punctuation">(</span><span class="token string">&quot;hdfs://node01:8020/flink/checkDir&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
或者<span class="token keyword">new</span> MemoryStateBackend<span class="token punctuation">(</span><span class="token punctuation">)</span>
或者<span class="token keyword">new</span> RocksDBStateBackend<span class="token punctuation">(</span>filebackend<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>【需要添加第三方依赖】
</code></pre></div><p>第二种：全局调整</p> <ul><li>修改flink-conf.yaml</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">state.backend</span><span class="token punctuation">:</span> filesystem
<span class="token key atrule">state.checkpoints.dir</span><span class="token punctuation">:</span> hdfs<span class="token punctuation">:</span>//node01<span class="token punctuation">:</span>8020/flink/checkDir
</code></pre></div><ul><li>注意：state.backend的值可以是下面几种</li></ul> <div class="language- extra-class"><pre class="language-text"><code>(1) jobmanager    表示使用 MemoryStateBackend
(2) filesystem    表示使用 FsStateBackend
(3) rocksdb       表示使用 RocksDBStateBackend
</code></pre></div><h2 id="flink的checkpoint保存数据实现容错"><a href="#flink的checkpoint保存数据实现容错" class="header-anchor">#</a> Flink的checkPoint保存数据实现容错</h2> <h5 id="_3-1-checkpoint的基本概念"><a href="#_3-1-checkpoint的基本概念" class="header-anchor">#</a> 3.1 checkPoint的基本概念</h5> <p><strong>为了保证state的容错性，Flink需要对state进行checkpoint。</strong></p> <p>Checkpoint是Flink实现容错机制最核心的功能，它能够<strong>根据配置周期性地基于Stream中各个Operator/task的状态来生成快照，从而将这些状态数据定期持久化存储下来</strong>，当Flink程序一旦意外崩溃时，重新运行程序时可以有选择地从这些快照进行恢复，从而修正因为故障带来的程序数据异常。</p> <h5 id="_3-2-checkpoint的前提"><a href="#_3-2-checkpoint的前提" class="header-anchor">#</a> 3.2  checkPoint的前提</h5> <ul><li>Flink的checkpoint机制可以与(stream和state)的持久化存储交互的前提
<ul><li><p>1、持久化的source，它需要支持在一定时间内重放事件。这种sources的典型例子是持久化的消息队列（比如Apache Kafka，RabbitMQ等）或文件系统（比如HDFS，S3，GFS等）</p></li> <li><p>2、用于state的持久化存储，例如分布式文件系统（比如HDFS，S3，GFS等）</p></li></ul></li></ul> <h5 id="_3-3-flink进行checkpoint步骤"><a href="#_3-3-flink进行checkpoint步骤" class="header-anchor">#</a> 3.3 Flink进行checkpoint步骤</h5> <ul><li>暂停新数据的输入</li> <li>等待流中on-the-fly的数据被处理干净，此时得到flink graph的一个snapshot</li> <li>将所有Task中的State拷贝到State Backend中，如HDFS。此动作由各个Task Manager完成</li> <li>各个Task Manager将Task State的位置上报给Job Manager，完成checkpoint</li> <li>恢复数据的输入</li></ul> <p>如上所述，这里才需要“暂停输入  +  排干on-the-fly  数据”的操作，这样才能拿到同一时刻下所有subtask的state</p> <h5 id="_3-4-配置checkpoint"><a href="#_3-4-配置checkpoint" class="header-anchor">#</a> 3.4  配置checkPoint</h5> <ul><li><p><strong>默认checkpoint功能是disabled的</strong>，想要使用的时候需要先启用</p></li> <li><p>checkpoint开启之后**，默认的checkPointMode是Exactly-once**</p></li> <li><p>checkpoint的checkPointMode有两种</p> <ul><li>Exactly-once:    数据处理且只被处理一次</li> <li>At-least-once：数据至少被处理一次</li></ul></li></ul> <p>Exactly-once对于大多数应用来说是最合适的。At-least-once可能用在某些延迟超低的应用程序（始终延迟为几毫秒）。</p> <p>要设置checkPoint，直接将下列内容粘贴到代码中即可。</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">//默认checkpoint功能是disabled的，想要使用的时候需要先启用</span>
<span class="token comment">// 每隔1000 ms进行启动一个检查点【设置checkpoint的周期】</span>
environment<span class="token punctuation">.</span>enableCheckpointing<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 高级选项：</span>
<span class="token comment">// 设置模式为exactly-once （这是默认值）</span>
environment<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setCheckpointingMode<span class="token punctuation">(</span>CheckpointingMode<span class="token punctuation">.</span>EXACTLY_ONCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 确保检查点之间有至少500 ms的间隔【checkpoint最小间隔】</span>
environment<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setMinPauseBetweenCheckpoints<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 检查点必须在一分钟内完成，或者被丢弃【checkpoint的超时时间】</span>
environment<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setCheckpointTimeout<span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 同一时间只允许进行一个检查点</span>
environment<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setMaxConcurrentCheckpoints<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 表示一旦Flink处理程序被cancel后，会保留Checkpoint数据，以便根据实际需要恢复到指定的Checkpoint【详细解释见备注】</span>

<span class="token comment">/**
  * ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION:表示一旦Flink处理程序被cancel后，会保留Checkpoint数据，以便根据实际需要恢复到指定的Checkpoint
  * ExternalizedCheckpointCleanup.DELETE_ON_CANCELLATION: 表示一旦Flink处理程序被cancel后，会删除Checkpoint数据，只有job执行失败的时候才会保存checkpoint
  */</span>
environment<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>enableExternalizedCheckpoints<span class="token punctuation">(</span>ExternalizedCheckpointCleanup<span class="token punctuation">.</span>RETAIN_ON_CANCELLATION<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h5 id="_3-5-重启策略概述"><a href="#_3-5-重启策略概述" class="header-anchor">#</a> 3.5  重启策略概述</h5> <ul><li>Flink支持不同的重启策略，以在故障发生时控制作业如何重启，集群在启动时会伴随一个默认的重启策略，在没有定义具体重启策略时会使用该默认策略。</li> <li>如果在工作提交时指定了一个重启策略，该策略会覆盖集群的默认策略，默认的重启策略可以通过 Flink 的配置文件 flink-conf.yaml 指定。配置参数 restart-strategy 定义了哪个策略被使用。</li> <li>常用的重启策略
<ul><li>（1）固定间隔 (Fixed delay)</li> <li>（2）失败率 (Failure rate)</li> <li>（3）无重启 (No restart)</li></ul></li> <li><strong>如果没有启用 checkpointing，则使用无重启 (no restart) 策略。</strong></li> <li>如果启用了 checkpointing，重启策略可以在==flink-conf.yaml==中配置，表示全局的配置。也可以在应用代码中动态指定，会覆盖全局配置
<ul><li>但没有配置重启策略，则使用固定间隔 (fixed-delay) 策略， 尝试重启次数默认值是：Integer.MAX_VALUE，。</li></ul></li></ul> <h5 id="_3-6-重启策略配置实现"><a href="#_3-6-重启策略配置实现" class="header-anchor">#</a> 3.6  重启策略配置实现</h5> <ul><li>固定间隔 (Fixed delay)</li></ul> <div class="language-scala extra-class"><pre class="language-scala"><code>第一种：全局配置 flink<span class="token operator">-</span>conf<span class="token punctuation">.</span>yaml
restart<span class="token operator">-</span>strategy<span class="token operator">:</span> fixed<span class="token operator">-</span>delay
restart<span class="token operator">-</span>strategy<span class="token punctuation">.</span>fixed<span class="token operator">-</span>delay<span class="token punctuation">.</span>attempts<span class="token operator">:</span> <span class="token number">3</span>    
restart<span class="token operator">-</span>strategy<span class="token punctuation">.</span>fixed<span class="token operator">-</span>delay<span class="token punctuation">.</span>delay<span class="token operator">:</span> <span class="token number">10</span> s

第二种：应用代码设置
	<span class="token comment">//重启次数、重启时间间隔</span>
environment<span class="token punctuation">.</span>setRestartStrategy<span class="token punctuation">(</span>RestartStrategies<span class="token punctuation">.</span>fixedDelayRestart<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre></div><ul><li>失败率 (Failure rate)</li></ul> <div class="language-scala extra-class"><pre class="language-scala"><code>第一种：全局配置 flink<span class="token operator">-</span>conf<span class="token punctuation">.</span>yaml
restart<span class="token operator">-</span>strategy<span class="token operator">:</span> failure<span class="token operator">-</span>rate
restart<span class="token operator">-</span>strategy<span class="token punctuation">.</span>failure<span class="token operator">-</span>rate<span class="token punctuation">.</span>max<span class="token operator">-</span>failures<span class="token operator">-</span>per<span class="token operator">-</span>interval<span class="token operator">:</span> <span class="token number">3</span>
restart<span class="token operator">-</span>strategy<span class="token punctuation">.</span>failure<span class="token operator">-</span>rate<span class="token punctuation">.</span>failure<span class="token operator">-</span>rate<span class="token operator">-</span>interval<span class="token operator">:</span> <span class="token number">5</span> min    <span class="token comment">//五分钟之内，不能超过3次重启失败</span>
restart<span class="token operator">-</span>strategy<span class="token punctuation">.</span>failure<span class="token operator">-</span>rate<span class="token punctuation">.</span>delay<span class="token operator">:</span> <span class="token number">10</span> s     <span class="token comment">//重启的时间间隔</span>

第二种：应用代码设置
environment<span class="token punctuation">.</span>setRestartStrategy<span class="token punctuation">(</span>RestartStrategies<span class="token punctuation">.</span>failureRateRestart<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre></div><ul><li>无重启 (No restart)</li></ul> <div class="language-scala extra-class"><pre class="language-scala"><code>第一种：全局配置 flink<span class="token operator">-</span>conf<span class="token punctuation">.</span>yaml
restart<span class="token operator">-</span>strategy<span class="token operator">:</span> none

第二种：应用代码设置
environment<span class="token punctuation">.</span>setRestartStrategy<span class="token punctuation">(</span>RestartStrategies<span class="token punctuation">.</span>noRestart<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre></div><h2 id="案例-对state进行checkpoint"><a href="#案例-对state进行checkpoint" class="header-anchor">#</a> 案例：对state进行checkPoint</h2> <p>如果使用RocksDBStateBackend   的话，要添加依赖flink-statebackend-rocksdb_2.11，但是这里使用的是FsStateBackend，所以不需要。</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>state<span class="token punctuation">.</span>filesystem<span class="token punctuation">.</span></span>FsStateBackend
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>CheckpointingMode
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span>CheckpointConfig<span class="token punctuation">.</span>ExternalizedCheckpointCleanup
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamExecutionEnvironment

<span class="token keyword">object</span> Demo16 <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> environment<span class="token operator">=</span>StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    environment<span class="token punctuation">.</span>setStateBackend<span class="token punctuation">(</span><span class="token keyword">new</span> FsStateBackend<span class="token punctuation">(</span><span class="token string">&quot;hdfs://node01:8020/stateStore&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//默认checkpoint功能是disabled的，想要使用的时候需要先启用</span>
    <span class="token comment">// 每隔3000 ms进行启动一个检查点【设置checkpoint的周期】</span>
    environment<span class="token punctuation">.</span>enableCheckpointing<span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 高级选项：</span>
    <span class="token comment">// 设置模式为exactly-once （这是默认值）</span>
    environment<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setCheckpointingMode<span class="token punctuation">(</span>CheckpointingMode<span class="token punctuation">.</span>EXACTLY_ONCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 确保检查点之间有至少500 ms的间隔【checkpoint最小间隔】</span>
    environment<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setMinPauseBetweenCheckpoints<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 检查点必须在一分钟内完成，或者被丢弃【checkpoint的超时时间】</span>
    environment<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setCheckpointTimeout<span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 同一时间只允许进行一个检查点</span>
    environment<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setMaxConcurrentCheckpoints<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 表示一旦Flink处理程序被cancel后，会保留Checkpoint数据，以便根据实际需要恢复到指定的Checkpoint【详细解释见备注】</span>

    <span class="token comment">/**
     * ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION:表示一旦Flink处理程序被cancel后，会保留Checkpoint数据，以便根据实际需要恢复到指定的Checkpoint
     * ExternalizedCheckpointCleanup.DELETE_ON_CANCELLATION: 表示一旦Flink处理程序被cancel后，会删除Checkpoint数据，只有job执行失败的时候才会保存checkpoint
     */</span>
    environment<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>enableExternalizedCheckpoints<span class="token punctuation">(</span>ExternalizedCheckpointCleanup<span class="token punctuation">.</span>RETAIN_ON_CANCELLATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">val</span> sourceStream<span class="token operator">=</span>environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> resultStream<span class="token operator">=</span>sourceStream
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    resultStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>启动netcat服务，nc -lk 9999</p> <p>启动flink程序，然后观看web界面：node01:50070，可以看到，/stateStore目录保存了state的数据，而且chk的版本会不断更新，只会保留一个版本（后面会学习保留多个历史版本的checkPoint)。根据代码的设定，每隔3s就会更新一次。</p> <p><img src="/assets/img/image-20200508010212878.c55ebeea.png" alt="image-20200508010212878"></p> <p>隔几秒后刷新页面：</p> <p><img src="/assets/img/image-20200508010237271.91cc5afd.png" alt="image-20200508010237271"></p> <p>state的元数据信息最终保存到了下面这里：</p> <p><img src="/assets/img/image-20200508011517620.02b8ca4f.png" alt="image-20200508011517620"></p> <h2 id="从checkpoint恢复数据以及checkpoint保存多个历史版本"><a href="#从checkpoint恢复数据以及checkpoint保存多个历史版本" class="header-anchor">#</a> 从checkPoint恢复数据以及checkPoint保存多个历史版本</h2> <h5 id="_4-1-保存多个历史版本"><a href="#_4-1-保存多个历史版本" class="header-anchor">#</a> 4.1  保存多个历史版本</h5> <ul><li><p><strong>默认情况下</strong>，如果设置了Checkpoint选项，则<strong>Flink只保留最近成功生成的1个Checkpoint</strong>，而当Flink程序失败时，可以从最近的这个Checkpoint来进行恢复。</p></li> <li><p>如果我们希望保留多个Checkpoint，并能够根据实际需要==选择其中一个进行恢复==，这样会更加灵活，比如，我们发现最近4个小时数据记录处理有问题，希望将整个状态还原到4小时之前</p></li> <li><p><strong>Flink可以支持保留多个Checkpoint</strong>，需要在Flink的配置文件conf/flink-conf.yaml中，添加如下配置，指定最多需要保存Checkpoint的个数</p></li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">state.checkpoints.num-retained</span><span class="token punctuation">:</span> <span class="token number">20</span>
</code></pre></div><p>这样设置以后就查看对应的Checkpoint在HDFS上存储的文件目录</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>hdfs dfs <span class="token punctuation">-</span>ls hdfs<span class="token punctuation">:</span>//node01<span class="token punctuation">:</span>8020/flink/checkpoints
</code></pre></div><p>如果希望回退到某个Checkpoint点，只需要指定对应的某个Checkpoint路径即可实现。</p> <p>如果保存多个版本，会出现下面的情景：</p> <p><img src="/assets/img/image-20200508014421740.d126b4b9.png" alt="image-20200508014421740"></p> <h5 id="_4-2-恢复历史某个版本数据"><a href="#_4-2-恢复历史某个版本数据" class="header-anchor">#</a> 4.2 恢复历史某个版本数据</h5> <p>如果Flink程序异常失败，或者最近一段时间内数据处理错误，我们<strong>可以将程序从某一个Checkpoint点进行恢复</strong></p> <div class="language-sh extra-class"><pre class="language-sh"><code>bin/flink run -s hdfs://node01:8020/flink/checkpoints/467e17d2cc343e6c56255d222bae3421/chk-56/_metadata flink-job.jar
</code></pre></div><p>程序正常运行后，还会按照Checkpoint配置进行运行，继续生成Checkpoint数据。</p> <h2 id="flink的savepoint保存数据"><a href="#flink的savepoint保存数据" class="header-anchor">#</a> Flink的savePoint保存数据</h2> <h5 id="_5-1-savepoint的介绍"><a href="#_5-1-savepoint的介绍" class="header-anchor">#</a> 5.1 savePoint的介绍</h5> <ul><li><p><strong>savePoint是检查点一种特殊实现，底层其实也是使用Checkpoints的机制</strong>。</p></li> <li><p>savePoint是用户以手工命令的方式触发checkpoint，并将结果持久化到指定的存储目录中</p></li> <li><p>作用</p> <ul><li>1、应用<strong>程序代码升级</strong> <ul><li>通过触发保存点并从该保存点处运行新版本，下游的应用程序并不会察觉到不同</li></ul></li> <li>2、<strong>Flink版本更新</strong> <ul><li>Flink 自身的更新也变得简单，因为可以针对正在运行的任务触发保存点，并从保存点处用新版本的 Flink 重启任务。</li></ul></li> <li>3、维护和迁移
<ul><li>使用保存点，可以轻松地“暂停和恢复”应用程序</li></ul></li></ul></li></ul> <h5 id="_5-2-savepoint的使用"><a href="#_5-2-savepoint的使用" class="header-anchor">#</a> 5.2 savePoint的使用</h5> <p>1：在flink-conf.yaml中配置Savepoint存储位置</p> <p>不是必须设置，但是设置后，后面创建指定Job的Savepoint时，可以不用在手动执行命令时指定Savepoint的位置</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">state.savepoints.dir</span><span class="token punctuation">:</span> hdfs<span class="token punctuation">:</span>//node01<span class="token punctuation">:</span>8020/flink/savepoints
</code></pre></div><p>2：触发一个savepoint</p> <ul><li><p>（1）手动触发savepoint（在flink程序运行的过程中，运行下列命令，手动触发savepoint，<strong>触发savepoint不会影响flink程序的运行</strong>，触发savepoint只是开启另外的一个线程来保存当前的状态）</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#【针对on standAlone模式】</span>
bin/flink savepoint jobId <span class="token punctuation">[</span>targetDirectory<span class="token punctuation">]</span> 

<span class="token comment">#【针对on yarn模式需要指定-yid参数】</span>
bin/flink savepoint jobId <span class="token punctuation">[</span>targetDirectory<span class="token punctuation">]</span> <span class="token punctuation">[</span>-yid yarnAppId<span class="token punctuation">]</span>

<span class="token comment">#jobId 				需要触发savepoint的jobId编号</span>
<span class="token comment">#targetDirectory     指定savepoint存储数据目录，如果在flink-conf.yaml中设置了，就不需要指定了</span>
<span class="token comment">#-yid                指定yarnAppId </span>
</code></pre></div></li> <li><p>（2）取消任务并手动触发savepoint</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">##【针对on standAlone模式】</span>
bin/flink cancel -s <span class="token punctuation">[</span>targetDirectory<span class="token punctuation">]</span> jobId 

<span class="token comment">##【针对on yarn模式需要指定-yid参数】</span>
bin/flink cancel -s <span class="token punctuation">[</span>targetDirectory<span class="token punctuation">]</span> jobId <span class="token punctuation">[</span>-yid yarnAppId<span class="token punctuation">]</span>
</code></pre></div></li></ul> <p>3：从指定的savepoint启动job</p> <div class="language-shell extra-class"><pre class="language-shell"><code>bin/flink run -s savepointPath <span class="token punctuation">[</span>runArgs<span class="token punctuation">]</span>
</code></pre></div><p>4、清除savepoint数据</p> <div class="language-shell extra-class"><pre class="language-shell"><code>bin/flink savepoint -d savepointPath
</code></pre></div><h2 id="flink流式处理集成kafka"><a href="#flink流式处理集成kafka" class="header-anchor">#</a> Flink流式处理集成kafka</h2> <ul><li><p>对于<strong>实时处理当中，我们实际工作当中的数据源一般都是使用kafka</strong>，所以我们一起来看看如何通过Flink来集成kafka</p></li> <li><p>Flink提供了一个特有的kafka connector去读写kafka topic的数据。flink消费kafka数据，并不是完全通过跟踪kafka消费组的offset来实现去保证exactly-once的语义，而是<strong>flink内部去跟踪offset和做checkpoint去实现exactly-once的语义</strong>，而且对于kafka的partition，Flink会<strong>启动对应的并行度</strong>去处理kafka当中的每个分区的数据</p></li> <li><p>Flink整合kafka官网介绍</p> <ul><li>https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/connectors/kafka.html</li></ul></li></ul> <h4 id="_6-1-导入pom依赖"><a href="#_6-1-导入pom依赖" class="header-anchor">#</a> 6.1 导入pom依赖</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.flink/flink-connector-kafka --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-connector-kafka_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-statebackend-rocksdb_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kafka-clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>slf4j-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.7.25<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>slf4j-log4j12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.7.25<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="案例1-将kafka作为flink的source来使用"><a href="#案例1-将kafka作为flink的source来使用" class="header-anchor">#</a> 案例1：将kafka作为flink的source来使用</h4> <ul><li>实际工作当中一般都是将kafka作为flink的source来使用</li></ul> <h6 id="_6-2-1-创建kafka的topic"><a href="#_6-2-1-创建kafka的topic" class="header-anchor">#</a> 6.2.1 创建kafka的topic</h6> <ul><li>安装好kafka集群，并启动kafka集群，然后在node01执行以下命令创建kafka的topic为test</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>kafka-topics.sh --create --partitions <span class="token number">3</span> --topic <span class="token builtin class-name">test</span> --replication-factor <span class="token number">1</span> --zookeeper node01:2181,node02:2181,node03:2181
</code></pre></div><h6 id="_6-2-2-代码实现"><a href="#_6-2-2-代码实现" class="header-anchor">#</a> 6.2.2 代码实现：</h6> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>kafka</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Properties

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span>RocksDBStateBackend
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>CheckpointingMode
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span>CheckpointConfig
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span></span>FlinkKafkaConsumer
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>util<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span>SimpleStringSchema

<span class="token comment">/**
  *  将kafka作为flink的source来使用
  */</span>
<span class="token keyword">object</span> FlinkKafkaSource <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token comment">//**隐式转换</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token comment">//checkpoint**配置</span>
    env<span class="token punctuation">.</span>enableCheckpointing<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setCheckpointingMode<span class="token punctuation">(</span>CheckpointingMode<span class="token punctuation">.</span>EXACTLY_ONCE<span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setMinPauseBetweenCheckpoints<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setCheckpointTimeout<span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setMaxConcurrentCheckpoints<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>enableExternalizedCheckpoints<span class="token punctuation">(</span>CheckpointConfig<span class="token punctuation">.</span>ExternalizedCheckpointCleanup<span class="token punctuation">.</span>RETAIN_ON_CANCELLATION<span class="token punctuation">)</span>
    <span class="token comment">//设置statebackend</span>
   env<span class="token punctuation">.</span>setStateBackend<span class="token punctuation">(</span><span class="token keyword">new</span> RocksDBStateBackend<span class="token punctuation">(</span><span class="token string">&quot;hdfs://node01:8020/flink_kafka_sink/checkpoints&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">val</span> topic <span class="token operator">=</span> <span class="token string">&quot;test&quot;</span>
    <span class="token keyword">val</span> prop <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span>
    prop<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;bootstrap.servers&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;node01:9092,node02:9092,node03:9092&quot;</span><span class="token punctuation">)</span>
    prop<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;con1&quot;</span><span class="token punctuation">)</span>
    prop<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;key.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    prop<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;value.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">val</span> kafkaConsumer <span class="token operator">=</span> <span class="token keyword">new</span> FlinkKafkaConsumer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span><span class="token keyword">new</span> SimpleStringSchema<span class="token punctuation">,</span>prop<span class="token punctuation">)</span>
      
    <span class="token comment">//把消息的偏移量通过checkpoint机制保存在HDFS上</span>
    kafkaConsumer<span class="token punctuation">.</span>setCommitOffsetsOnCheckpoints<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> kafkaSource<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span>addSource<span class="token punctuation">(</span>kafkaConsumer<span class="token punctuation">)</span>
    kafkaSource<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>


  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h6 id="_6-2-3-kafka生产数据"><a href="#_6-2-3-kafka生产数据" class="header-anchor">#</a> 6.2.3 kafka生产数据</h6> <p>启动flink程序，然后在node01执行以下命令，通过shell命令行来生产数据到kafka当中去</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kafka-console-producer.sh --broker-list node01:9092,node02:9092,node03:9092 --topic  <span class="token builtin class-name">test</span>
</code></pre></div><p>观察web：</p> <p><img src="/assets/img/image-20200508024048904.5ecc05c6.png" alt="image-20200508024048904"></p> <h4 id="案例2-将kafka作为flink的sink来使用"><a href="#案例2-将kafka作为flink的sink来使用" class="header-anchor">#</a> 案例2：将kafka作为flink的sink来使用</h4> <p>我们也可以将kafka作为flink的sink来使用，就是将flink处理完成之后的数据写入到kafka当中去</p> <h6 id="_6-3-1-socket发送数据"><a href="#_6-3-1-socket发送数据" class="header-anchor">#</a> 6.3.1 socket发送数据</h6> <p>node01执行以下命令，从socket当中发送数据</p> <div class="language- extra-class"><pre class="language-text"><code> nc -lk 9999
</code></pre></div><h6 id="_6-3-2-代码实现"><a href="#_6-3-2-代码实现" class="header-anchor">#</a> 6.3.2 代码实现</h6> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>kafka</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Properties

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span>RocksDBStateBackend
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>CheckpointingMode
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span>CheckpointConfig
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamExecutionEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span></span>FlinkKafkaProducer
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>internals<span class="token punctuation">.</span></span>KeyedSerializationSchemaWrapper
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>util<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span>SimpleStringSchema

<span class="token comment">/**
  * 将kafka作为flink的sink来使用
  */</span>
<span class="token keyword">object</span> FlinkKafkaSink <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token comment">//隐式转换</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
      
    <span class="token comment">//checkpoint配置</span>
    env<span class="token punctuation">.</span>enableCheckpointing<span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    env<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setCheckpointingMode<span class="token punctuation">(</span>CheckpointingMode<span class="token punctuation">.</span>EXACTLY_ONCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    env<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setMinPauseBetweenCheckpoints<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    env<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setCheckpointTimeout<span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    env<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setMaxConcurrentCheckpoints<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    env<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>enableExternalizedCheckpoints<span class="token punctuation">(</span>CheckpointConfig<span class="token punctuation">.</span>ExternalizedCheckpointCleanup<span class="token punctuation">.</span>RETAIN_ON_CANCELLATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置statebackend</span>
    env<span class="token punctuation">.</span>setStateBackend<span class="token punctuation">(</span><span class="token keyword">new</span> RocksDBStateBackend<span class="token punctuation">(</span><span class="token string">&quot;hdfs://node01:8020/flink_kafka_sink/checkpoints&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">val</span> socketStream <span class="token operator">=</span> env<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> topic <span class="token operator">=</span> <span class="token string">&quot;test&quot;</span>
    <span class="token keyword">val</span> prop <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span>
    prop<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;bootstrap.servers&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;node01:9092,node02:9092,node03:9092&quot;</span><span class="token punctuation">)</span>
    prop<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;kafka_group1&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//第一种解决方案，设置FlinkKafkaProducer里面的事务超时时间</span>
    <span class="token comment">//设置事务超时时间</span>
    prop<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;transaction.timeout.ms&quot;</span><span class="token punctuation">,</span><span class="token number">60000</span><span class="token operator">*</span><span class="token number">15</span><span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    <span class="token comment">//第二种解决方案，设置kafka的最大事务超时时间</span>
      
    <span class="token comment">//使用至少一次语义的形式</span>
    <span class="token comment">//FlinkKafkaProducer011&lt;String&gt; myProducer = new FlinkKafkaProducer&lt;&gt;(brokerList, topic, new SimpleStringSchema());</span>
    
      <span class="token comment">//使用支持仅一次语义的形式</span>
    <span class="token comment">/**
      * defaultTopic: String,
      * serializationSchema: KafkaSerializationSchema[IN],
      * producerConfig: Properties,
      * semantic: FlinkKafkaProducer.Semantic
      */</span>
    <span class="token keyword">val</span> kafkaSink <span class="token operator">=</span> <span class="token keyword">new</span> FlinkKafkaProducer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span><span class="token keyword">new</span> KeyedSerializationSchemaWrapper<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">new</span> SimpleStringSchema<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> prop<span class="token punctuation">,</span>FlinkKafkaProducer<span class="token punctuation">.</span>Semantic<span class="token punctuation">.</span>EXACTLY_ONCE<span class="token punctuation">)</span>
    socketStream<span class="token punctuation">.</span>addSink<span class="token punctuation">(</span>kafkaSink<span class="token punctuation">)</span>

    env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;StreamingFromCollectionScala&quot;</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h6 id="_6-3-3-启动kafka消费者"><a href="#_6-3-3-启动kafka消费者" class="header-anchor">#</a> 6.3.3 启动kafka消费者</h6> <p>1、启动netcat服务，nc -lk 9999</p> <p>2、运行flink程序</p> <p>3、node01执行以下命令启动kafka消费者，消费数据</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kafka-console-consumer.sh --bootstrap-server node01:9092,node02:9092,node03:9092 --topic <span class="token builtin class-name">test</span>
</code></pre></div><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZQAAABDCAYAAAC7ifODAAAPJklEQVR4nO2dPW/qSBfH/zzaT/BIlr8A2WIU+QOQwkIRBbnNrazIze1IZTlNOpd0abAoHkGXBiFXt7mhQFdZrwTStlbk4gbtbmvNh8hTjA1+g9hgEgjnJ61WlxyMZzyeM+dl5tT+/vvv1z///BN//fUX/vff/4IgCIIgtuG3Wq320fewFR29iwHLfr5w+zibBgAUPHY1tOHjxhph+N43qOh41VjsfoidoP5c9kEG30Ft5L39fbmFF0PC/Ue8D4dI6f784DnlCPhtr1eXW+hhitsTff+PhYbSgtVkaEtS+AnHxB3j6rNO3HILj9cq2mFzF9zH/XiE4abmygp6yjm+qDi+CVlW0Ltuwgyf76DbxR33cT/+iWHwSZ/x0SKjo1/jjkmoAwA4Fv4Tvo08zI9Afq8KpXOpwkSA2wKrp+ykJl70H/4znOm6xtJKYTfEYBkwYOKMUfPE5NJQdDxoBl7wCa2BnFVpXWIYGCZY304sfhqyAu2yiS/LlwkA/Pe60yzeCLXEqxStmDeh4NHIytQlhsE1x7M9XfNunQDp/pRbeDHU2LN+b2T0TAOmFP9MQp1pmJkyLjLP6tDkgf+UaW4p5BbuGADWRE/eKIie2cVMUxPKBBCD3lSb0DZ+n9iWRksoE7tv48pbzaRzb4RvLkddvUTnA++vehQ8hspk4Tq4sCzUrD5uXA5AgnndQmMpK0O7buKLxPHDdXDRdzD5oLvehUariTbC9vZdLODjxrJQ6/dx43+yxcKR02hdi8mbu7jpW6hZFmp9BxMOQFLx0JIPWh7YZKHILTxeAt9/Tje7AtbQuVRRB8cCEsxLZY2VEteAHBNnnJjYxArxvPyP59BQdDw0GeqRm8N38s02WUEvvSrlHPbTGLdefkckrx26izb0WfpewDkm/noXUzH5pH/3uaXjQWVLMzXdt5BbeFAlTBxruSoXlgmLrdD4+usX7c+d21ukP1uwmisXFrgPezzKuFqjyRW+g7NpNB4DDKc2IHUxYCosZYorT3x+a9u4jbX/GDmXJAAcPzwPc7RWfwgCDHeyPncZD3neCI4X/wndtd6IQ6aK2IoMjYlnZY9jc27g4WosC8uJKWhMI6vg0OQFGy2UM6ZiYHTxoiuxlVuRvhHWycId45vL11spymWoTHzcWMlVMgDMAw+3o+zEUBbWMjHTYhMagDrTcjSscA+YCRcHAEmCqV3ntqGRubaEtmrkB/sAdPTsvUAKv6NnJ62y8gDwVe9ipsYVg4S2ZuAxJt5QGOrw8T2aVxUdM03Cj2gl4vgAJLCcNhfvz/L3X7Y/hXxMmQCAxGAa3UR7gWhyBSbP2cXN8Fm4ss7kz2UOP3NhfX1R9teuMuNh9bzS3ggJbfUc1Swf3xMZPVNDGxx2fxf3u4zfwwVUxnAMPPzgACQW89YcmrxgvUIJpvjmuJhwMThmXROPrWKKJZqs7qcB5tMnTNYM6M65mCQmzj7jIAymKsVcHBYuXLHyrrNse375Lm76fTGpRiYegPyXUoGlihdj4Ubf6ePG9bHIuxVFxyDS+s7qNy6cUJ5pyUmwrHzY3jbjmDix+wnd/u1m5NIJVx/+c9jvMnpNhoU7LqC8S/Rn6fsv358zVQK4vzLJw+sn2yvayMIX5FdeGwOOBYC69LkUynw6hs2Bumrg5TpfKe9GufEwWz7flXzNsnDR7+PGfcbzHu5wn3R0A6bEYafib9uTt4iLJvfDl99oocy9Ka5sCxeOiwmX0FZDxaLIGxRLOCksJysP3Vx/vIKvDEB8lbwnJo6Fs5gpLZRcHh5uR9Nk5ksg7j+PpAtlaRNiOB3hzMkGb1cK1E64z6KYBZCcBMvKC3gqJhJgOAqV4nJFIQbEgocysiJiBbHfiH47j6L9Wfb+t+tPDjuVoTX3fsLmACQptuLd9NLEkDaN7WMkwK3dF0pFklCHhK8VWytlx4NI/U66tuZBgOGRubs6uokB42J876xMPHz3gSiW14kekaygZ4bvBST8Lh+qvKBQltfcm+LKm6IhK7CuNbQ1A+0mx+RpnHFTiUmBw/7pxb7vY6GquGvJO/ptt2F/CmuTCyVLtELOv5+oj+rhJDgvLR+RY6IiwC8OtKVwAKT/LqdcfIqeu8dHULQ/y99/uf6MFiQSTKMLM1cmXF0dbOxZwaOpJdKXfzw9w/HExNpomZipvIJMxgC3tgWnZWKmCvfna9PNzdIpT9HxsFpA3u9tDngr6626rFDWMmEyEYO8qmh+GY4cfO1qaEsqBoaKQfQH38EN1zLv5KHJAyWzvOaBJywW18dCCgemGV8hR9bJU1JjB1Pc+ziOrCFZRkc38WJ28doV/0VmekownDALX3jzCjkI8LKT/A4EInnidxmALDKhJv6u6bHl21uuP8silOqb8ODdVskdXUvEfuoSg6lpmMXH3dLS3515wAHuY+JzQFIxWxODI95CwpdwsFYbc/Nw1Xdg+6uBuvAdXIyCNe7aQ5MvuQ9laaFIEJk6KQslzzqJGP50ccfiVkq0amb4qgDDPbu9CqHoeNEY4Lu4H3tL11cjXNklCeCLeGdBovau+bMs42wn+SJEAyC6drh8Dyf3ttbFKwBwFxfPEto7udzLt7dcf0YUXXVG199spS3dgHtHrNhXO/9lNBQlmf3EfdwU2QFfCo7uaITvehcD1kRP9j7RxmMPV9Z7TCQc9/aTWL2rBh6D6qwUBB5uR14suxAiI3NDgPyQ5AtZKA2lhUezi5mhoS2JgO+Fnc7KigK9T/kDNLJSloG6ALdPYfBUM9/Yq/IeiMB0HT7u03GUN8hbpTQyH4UTGoQCzcgrYVYW52Fgsqz8BmQFXxIDIIDjc4Cdhxajh6soUM592OPIFSLcSa9dfQvLcvv7L9qfvzZcPw+R8QS0z3Oy6UL//su77Rz3cGVZiViRiFnaq4QQe3/JKlH2V9oHvj8inzzDXU721/Hh4arvYgExf2WTY6pDbMFAYWv1I+U3KpSlItFUoUhcBxdhem/WLSD8tJvOFBqOLNTiftsoeAoJphFmkcXHmiyj02q9k7KJXDQsEbRsKC1YoXmbzgCKUk3rajylWLjMZmp2eR/JtzUTvcRv6HgILaDJ06p/ysoLGAamngiiPV5nB4AInDIMIreHN8JZOIndBuLfy4ltS7/ztu0t1p/JBUkmUSQcO53YI1sGi5mGl+WkJqPTMoU/mLvoHoKlXBkKHk0dvUzfKMs9BrkZb3ti9XwNsRUh513vHJOuCaZhsohUzaJYVtBLZNLKYeAfQJ7n59Dk8cbGxgdNTESbNinthshAgWnAlEQWWVvVMlKTYPoOgVUP330NbQYRG4rfRriaA9Pw2m2uUgS9n7CbDKaUDgxz2K4PMz0JeiPcnJsYMAmmZsBMN9V3kqZzWfkIiWFgdFdBNCGccp94uOrLeDE0vJoybmKblxqyAksBrqY7zq6l27t9f7Y1A+3M0OGwvWmyzc45XjWGumrgVU3JjuPKOe/YCQBgGHRjfcurCm7vCYnB1Fii72eG+P9inTdhX3gjXMjCfVxnGmYs/cDSz+sI8Ea4gI6ZxmAaOvz+G2fCbUTGF1WFmTcH5maSHZr8GxbKiy+23J/tRZlECMtGpCYno6YL7sN2+u+2ahyO+riJBaDAw/0cth0ezyE+W4Wrw5TMxHd83GzISR+ObLEPI95UzjFx+7nWXVl5wMdNdDxCyMJ3cZFnZQRTnPUd2JzhzlglITxcnwMVuX7K3f+2/blu7OTsq/FGqPXdZP+88RvHi4ervhjTyX08ov/PKo/PvM18aotjbFLPS4yJJzhH+Azm3ijce8MwMLZxD4cEHu7d5LuyCPdY5S4cD00eQO2ff/55dV336OqhiOPr6XDIFXS09ukRPvOix9crOl6b/LAtKuKo2e/x9Xsn5X4ATrteBvG5WVe/oyiZ04oJolr2d9owQRAEcVIcrYUyHFnk1iFOC7IwiAPnaBUKkea9NnURBEHks8HlpeCxu+2mtgpQdLx2u7H9AgRBEMQhQzEUgiAIohJIoRAEQRCVQAqFIAiCqITCQXmqyZ6t/UIQBEGsKGShUE32bE12giAIIkkBhUI12bM12QmCIIg0hSwUqsmerslOEARBpCmgUI6oJjsAhDXKy8tHrK/J/r4FiQiCII6L6nfKyzI6l9e4k6Rk3CIruJea7Ku4R1l5giAIYheqVSgnU5OdIAiCSFPhPpRTqslOEARBpKlUoZxSTXaCIAgiSYUur1OryU4QBEHEqfTolZOryU4QBEEsOdqa8tVDNdkJgiB2gQ6HJAiCICqBFApBEARRCaRQCIIgiEqgmvJLqCY7QRDELmxQKB8cpFZ0vGoMC7cfOzjyMyGj07rEHUserb/gPn6MRyLLLeyDDL6zJkMtSUfvYsCKy78NJS4QBLEecnl9EB3dwEBlmfPO6hLLOeafIAji8CGX14eg4CsDRJ2WZCXLhizjHOG/vRFqccNCbuHFUAsfaDkcWWRFEATxbpBC+VA4/FRZ4XkQZMsqEwRBHAFUU37JvmvKy+iZBsyEi4th0M054mXb+MSamEt+HCrV3qLPN/+HKbZCEATVlM/j1GrKF3++ecjomRra4LD7pEwI4pQpYKEwmCqwcB18C8sAR/VN6kxBY5o8rfeX7+L7z1UtFMhCybTDmvK3KasgXlNerKLD7KfEhB6Jx2vEryyehqLjQWOoMw2Pirc68LGsfNheUVM+skhkEUBnYblgL306cVEC3NoWbsN272VFn4q55NehSVPu+abp6AZMia8O/CQI4mShmvJUU77E803S0U0MGBf9S8qEIE4eqil/8jXlt3u+rCXKAkwcO78EAEEQJwfVlC9zC0SIhC/hwxPVNsk8IQii6o2Nio4Xw8AdfNyP+6hZFmqWhYtcl1dUorcokZWwhjU15YvLF4Fqygs47m3hBqyrnzdZgSCIclBNeaopvyUervouFhAllkmpEARBNeWppvz2BNMweUISffzp4ksEQZTht1qtVtGlqKb8SeKNcAEdM43BNHT4/RGGZMURxElCNeUzUE35ssy9URgnYxgYOjoffUMEQXwItX///ff1jz/+oJrydHwIQRDETtDx9QRBEEQlkEIhCIIgKoEUCkEQBFEJVA9lCdWUJwiC2AWyUAiCIIhKIIVCEARBVAIpFIIgCKISSKEQBEEQlUAKhSAIgqgEUigEQRBEJfwfimzE+f2J/xUAAAAASUVORK5CYII=" alt="image-20200508025253485"></p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABUwAAABHCAYAAADcBw2qAAAdkUlEQVR4nO3dv27iyvvH8U9+OldwJMs3kJzCinwBpEDRioJss5UV0WyXaAvkNNtR0m0TRPEV6bZBEdU2Gwq0iiiSC7AiFxtuAPki8itsAgZDbPMnQN4v6ehok4kZD2MzPJ555uDbt28v//v3X2GdTF27VblG8m+7nZrOvM3WCO+nUHL1UBx3hkG/qaPe8B1rBAAAAAAAgJH/e+8KfAxDde776gZB7KeDwFej0yRY+mEF6hIsBQAAAAAA2CoHzDAFAAAAAAAAgNA/bxW4qNTVsmZ/Pl5GbOuu7qgsX5e1tm7WUMmF7IpeHItlzatCe762wQy/o4N2iunAZknPVUM/VnY9bPIaM3VR+qTvlqXDiRQSg8DX79u2roabrg9mLNs/gdR2/Vrf9foDHwjjTyyD/oNl0H+w415jdnwfXLk3A6ZYnYJdUu3UUtkYRaICdfu3OtvXG7NZ0t15UeXodAeBrx+3bd0sOl3T1rV9rM9FrTDguCGmrevzU7nR+9uq1/U98PXj9o9uhrvxHl9UqokPSA4NS59tU1f72lcBAMB+2Krxp6mLyrm+W4YOJUmBBv69vrY9Pa6k/hmPb9q6/nQq15rIpe/39eNPb3H7fCRZ2n/t7Un/2Tk5+s/n1/aXFATq3t/qzFtFg9J/gGWlDJgyO2M54c2kZUndzq0Oohtgwa7op1PVs/bwaVbCLLhDw1Kr6spqNqKZiqGCacuZ/rCQv6mazvLaOog9mBnNUlrE1l11tsyhYal1Huip0Zv/wbQ1bH2xJClQo3Orq4kP6oJp6lh71kd31XT/NEt6rhYnrh0A22/ds1+ZXYsPaqvGn0mbvho6tBw9uKZOksaGGeqf/fhzxqpWUS3LkLhXZGz/dbcn/WfnZGp/qWDHg4eSJMNQ2anq2Vw2PkD/WY/tHF/dtGtbUpdta5/l68OmTxtQKIXB0kazEXta9Oi19bUf6LD4SRfvWL/Vs3UX3WwH/Y5OajUd1Jq67AeSDLnnJRVey5pyzk/12Qj0u9/RSbOj7jvVehmF0qnKis632ddAvi5rNR00m7r0dy3QGMifeqr5OBzy5A8AAGyx7Rp/FkrnYTAh6OuyWdNBraaDZkfdQJJR1M+SuUT98xxfUrTh7EFtXL4RSJKlVsVecQvsmmztL2mt7Un/2TU5+s8wbM+TUXu+lpcOLXu2fAb0H2A1Vr4kv2BX9PN0nP9w4HeSp2XPmYLeuI/PbJt/7Gg5+4IgznRdFATq+vOXwKcrH49SP5Uq+lm0XqehdztTU+jNkn4WDXU7tdenMuHMUmviaXYw//hp23Pp803TniXVTsdT9BX4arzmtZwoFwUP5Xd01BtNhRvqpteQjLpaVlE1u6czL/z5VaOhq4nz30XHhiEp0G/P06NK418Mh7pZ2+zhBU9MUl9fSU8HLbXqdbVir5Xmqcwq6pPfbMoLaRAEevbvVe/NXjO5rvcs12Opop+xXLCBBkGg3/d/Es856/WbVdrrd7nj71r7L+izifmsovJ+Rwd/zHDJkkbtaOvOdVQ2lJgDK337Lz5nBf3kWQEZZe2f4Tmkb/9tVJj8vH6j/69n/JCUFz7hfpuQfyrt+5X9+Dn6W+r7ecbx0hKy32/XcD2+zvZf8HlpV/TiGGpMz3TcivsD48/0JlYezW1zU44Vjg0btxPLTYeezm7NsK9Ytgq98d9mq3/240uezhpTue2Gnq5uTX2uFnVomCpI9J9U7S/lb0/6z6yP2H+kR2/6vR/qxvP1vVjUYTCc05b0n/eQe/y2jviSNHdPi7fy8Gb9vpZW/vbJ9v10fePh+VY6w9QquXpw4pvFHFpO8hOMqiM3tgRGkmHIdc51nfBAojBzbEPlYjV58xNJF5XZusiI/ibhCUbW8pL0pVLXw2tnjurkVHU3UbxgWzqUr1+v300qenAM/R49ien4kgxZCeecvj2z1z9re4blJzqzJBmW3Go9dr7SKHgodZ9mO+DNU7jU6chMOOEd9hSET98+25s6L1PXrqOyAjWa01/Msl9fu16fcf+ML2s5NAyVi8c6niqf53rPdj1G94bpZSqGJfd4+es3qyzX73LH3832z+5Yd9WoPQ1L7idbFxXntX2nVw3kbf+kc16FPO2Tpf23kVVy45/XhiW36ibefzYxfshi/f05lK6/5bufpxkv5ZW1fdZ2PQ49/Y5mynxJPI6p61NLCnx1JoOlW3Z/mHdsxp9ZmfovCsjMLDQa9RXDkjNRnWz1z378N80N0GRD/4ks1Z70nw/Zf0xb1+dFHSpQ488yG/d83P6zTdYVX8or6/e1dcs6/tnUeHjaCmeYWnKL4RTur1F0ulBy9VA0Ep4wSH/9vn798cab4ZijvBZGwuYytmrFsGXGUfNoN+9YhxoVr4S5MKZyMb7O7LQc3dne+AlP1vLR+ZatyYi/+bphTvm0pILX0+Po6Yt/HwWQwsHyoN9MMasrQ3tmrn/29nwoGlLg63Ii6XPBrujBsSbONzxHK7qB/k06x2GggaRDw5T2KCfmY+9WDasqt1jVsxUoPmt49S4qVblGMDNLZST99TXUVaMWzbDIn+NjdfXJYdQ/Fb9epCj3qm3qaap8nus9/f1tIhdsrD1MFUxTjjn7hDB7fXK0T6rrd4nja0fbPw/LUtnv6KQ9lONW5VqOWvJ12WxLn+pqWdFDsKGWaP/Zc76o1NVaOjiSp32yfb5vH0tuMVC305z6vDbkfrJ1Nfl0ec3jh3GOqbT322zvV/bjT7ZRuv6W/X6eZryUV/b77fqux6Gu7n25845j2vpsSN1OfPy2XfeH5GMz/lzGxOfBq1GwIf6zfPVPe/z5Lj6FedCTAiXZ0X9W2570n73vP9MzBYO+Lpur2gTpo/Wf9ck8vlpbfCkytafF6DqZK+v3tYzytE+28c+mxsOzVjrDtNup6Wii8R9793PyAXm6avfiO4cPPdX7yUGm+BTxcaDnptfWUWc2OfvFsRXVpxGbmjvKGSpFnS5n+VAwlZN0qJt2lP/o9YlKeMMYBOMvFZ+NQL8npwsfJz/RCuuTrj2z1j9fewZqTO2Q9+j9CfOOGMbEE4mUN8lo2v3+GOqq0VQjCJ/SHMrQlzXNNr2ouGpZQfh+J36YZru+dr0+o/4fDn7iSwkeh0PdTP0s3/We5f42IfYkeajHoTezPDRvfdLKdv3mPf7utn8+vi6nloZ1O2H7hrPNx5Zp/+lzvmnXdLDKDeQytE+u9t8aCz6vrePYbODNjB9yWlt/DqXrb3nu52nGSyuQ+n67xuvRe5p7XuGXwokVR5uoT06MP9/i6WyUg29um3v65Uuj3H8XrxOzbF27UTvI0H+v/SRr/bMeP1nBrqhlhUuecz+YnfKR+0+69qT/LPKR+09YpqjvnxblL6X/7IL1xZeWq0/a72vrttT30zWPh6etcIZpfBC4SoumiM8aPSFJrs+j52tQLOowehMeM5cfSZiCrqH+BlLZiG4Q0783p5awRTeJZGnbM3v9s7XnKJpvyK3W5SaWSXq6tE3GuQUlaRD4+n3/pI43+eQyWMFObuFszU70hKfsVPVyupp8gyNWyZVrhTlxt+GDZT31mcjNk2jyCdGof/r6kWqWat7rPcv9zVO9f6py0ZDrVOWeBurOzQuTtz5p5bl+P1L75+Q/xe8VQV/1xPotc/9c12dqnvZZ3+d7tv6Wp7z01uf1uP03NX7IYgP9WdJ63+Ms46Ws72+W9tnE9ejpl++obE3Ptg1fe9D/E+vL23d/yHJsxp9vuWl39KXuqGwU1aoWx7nT/I4uA2fBd4DNHH80I+mtnHfZfNz+s+r2pP8sskf9Z2KmYMG0VTt3VLYc/SwNl2rXj9d/NjGeTGuD8aVUsn5fW7c819emxsOzVjrDNBPT1EXF1bNb10s9/C95GvGow6U+8OInJMOhnpcqv4RhoMHoaYsZ7kTX9WefaGWT/XyztWdW4UX9pg3mKZnMLSgpzHPhOHqY7HfTAZAlPA4DKfDV9QPJKOphZbv+GfocvXlv58BJe33tU33S2Mz1/thr6KTTj3aKNFQuRv3NrYyfwm6wPttj29r/Y6J95tnO8cPWvV9bcz8PbVv73Pzph0sXJ3Y4Dmc2xVcY7T7Gn2/zdNbsqOGPKzaI0rnMLn/NU/8sx48bBSu6nVUGu7LYr/6znvak/8y3X/1n5HHo6awRziiczoefHf3n/Xy073eb8V7jvRXOMM3ArujZsSS/rx+34zxYybkXhvLD/XRSGkXh5/zaNHW0VPk0RjeI0bGj8Hh0cZSdul6kcGe7J0PlpZ7wZD/fbO05kvYpy+j4i2fZvqYpWLvRrI5xrpqCbcd3hwvC5bWrFajebutXpa6Wdapr01vBbuSBfjTuw6d5xaruhnNmdWa6vraxPp7OauuaOrOO6z3Zo9fTmddT2Oc+RTskWmpVK9LrtbSp+mR5SvqR2n9TlnlKvR7b0z5Z+9uq++fk0/xtGD8k25r3a+WfL9NfqPK9v9naZ83X49DT76Ao17DkmD09DqO8eUE/ttnTxuqzNow/Uxl6ump7Ua74UV1K+hkFFCbvP7nqn/r4Y5PBipmdlzdmf/rPWtuT/jPH/vSfpGPNroDJ6UP1n/ceT05aZ3xpn2Qf/7zHePgdZpiGGx8dyteP6TxYb0iaxVaY+VF0wc/ZpTTctV5SEESJbbOWXyBK6D++QQzV8YOJHGmezjq+BpIU+GrcjpZqh9ORX+qVHE+S8tc/bXv+Xbjr66xRDr/yccJuwlH+jOcM7/tywjwvk7lqHr2ezhqNMPdLraaDxvq+qIRt8XYOl/Q8nTXD2Stlx03YQS7/9bWb9Rnl0LH0PdVu3Su83lMb6tFr6yjKcfu6xGAj9cl+/Waz6+0/T7Sb9Qpee73tvwp52mcPjD6vY33tHccPqb3n+7XC+/nMeGlVFt9vN3M9hps/SeGmYrKPVZbUvZ9Oz7ML94dFGH/mNdrkZHp106rqP+/4ksYbbfiddwx2SXvTf96hPek/0t70n0TZNk3Kiv6zCeuML+WR9fvauq1i/LO58fC7BEzDm4AV2xSnYJdUi+bKhzuwjd08hcvWD4vnup5ITnxRcfVQnP1SOypfdlxdx16jop/RDIjJgWvW8iFLrcnpv6atu/PZG0SYqNpSa7Qs22vrKArSXQ3Df78G7nJGxfOeb7r2HA38RwGxqWTVpqmLUik2Dfo1Obfl6Pn1ojR1UXLDfCZz8/3tKlt3bkXXM21jy4l2x1vpE6FhL0pOboTveeIS7/TX167XZ9yfq3qu2PFBT0L/zHe9Z2BX9FwpzfSHgj36wEuu/3rqk/36zWq323/yAzuqi2nrzq3KXclgdf3tP2brLloe/eIu2GQoY//cD/M/rwd+PPfRZsYPUmLfS5L7/Up5/Ezy3s/TjZdyyXi9b+x6HG3+ZB3r7tRSch6zTd4f1uPjjj9T3m9NW9elyc1bzGijTEkK1PgTr0zm+mc8vhSmAxttXJhFoeS+puB4XtEX7t3vP3nbk/6zCrvff8LPz4vJAK5p69qN8moG/pxVCR+v/2yXdOOrdcaX8sj6fS2/NO2TY/zzjuPhd1iSP0qIr3BTHGfiV9FsPFmOXuqnajSjXbe9P2qcWnKN6cSwgRp9X+70Tc5r6/LYVcuKksI68V9reie2rOVHDEutan2c5DgsPHUT8HTWNPVcdfTimrq87b3uBFYwbdVs6ay35E0j8/nmb8+yU1V5+vgK1PB68XPuHOvFsXRYrOqlOFX2dvLmYOo6MThhqVWfaNtgtZsnrZxhyXWsWNs/VMP/D/z7FSzHn+K1daKKHhxLbrUivznaYS7H9bXr9fHaOjHD5R2HlqMHa7qDTvXPvNd7BodWUa5VnD22JE33h3XXJ/P1m/34u9v+4yVa8f7p67IjtZwVzDJdd/vnkKl/7oukz+ugr6/TubM2NX6Y2/c083mX7/1Kf/z0lrifpxov5ZP3frve63HUVpbKxvRmT+9RnzVh/PkGU5+LRbnF2c7Z7SSNebLUP8fxo9nOM+c44nd0sMlAxk73H22gPek/C+16/5F0fFxUyynOtuWc8tnQf9Yj5fhqrfGlHLJ+X8ste/ukHf+813j4XTZ9umk3dTmRIFhBoG6nqYNGQ5f94PVn4+2QhrpqNGNJhRX4ulwQYLlpN3TS8TWYTGAcBOr2m4kXY9bykq/LZidMOhsZ+H2dJM0SHfZ01OyoEVj6Xh1vkvDz/Fha0dKgbPXP2559dYN4RuhB4KvRuZ39O6+tg2Y/3j5vvMbu8nTWDPv0IPbzsP2P1nTzf/TaOukHksK8HaN0Dtmvr92vz2OvoZNmZ6Z/htfA/cwT2uzXewZe+/VaifWH0Xmv5P6TTebrN6Ndbv+bdvxeOAj6umyuNk3Huts/kxz9c+f5ndnPI78zd5C0/vHD6O+SPzdiOcKWeL9SHT+jfPfzDOOlrHLfb9d/PY42f9Ibmz1t1f0hB8afCww9/ejH2yasy5yc71K2+uc5/gqsMq0B/WcB+s+bdr3/PD1N1V2BBn5/Nf1tT/vPNkg7vlprfCmHrN/X8srWPimvr3ccDx98+/bt5X///ju3wEWlrpa1qwnp18HWXd1ReWeT9CO76D1P++TLrujlNNjuGbEAAKwV4yVgr9gVvTiWup39D4hgDeg/wByMl7ZZyiX5s1Onx7uOA3sm+kDPzWvrgIEAAAAA9oIZbvyyd/sQYDPoPwB207ssyQcAAAAAbL9C6Vwtw19BXkV8RPQfALvqzRmmN+0a04LxsTBDFAAAAJAU5r472OL9x7Dd6D8AdtWbOUwBAAAAAAAA4KNIWJJv665e10t9vMv1RtkVvdTrei6Z7/HqAAAAAAAAAD4wcpgCAAAAAAAAQISAKQAAAAAAAABECJgCAAAAAAAAQOSftwoU7Ip+nlo6NMJ/D/yOvrY9PU4XNG1dfzrVZ8vQ4ehnQaDG/a2uvGGKYwfq9m91llw0sS4KAnX9W5310hx/Xnlbd3VHZfm6rLX1VKroZ9GKziFQt3Orszn1BwAAAAAAALBfFs4wtUquHpyJgKOkQ8vRz5kNmWzdVR25k8FSSTIMuc65rhP2byrMHNtQuVjVi2Ml1uWiMlsXGdHfVOyly0vSl0pdD6/B0qhOTlV3ycUBAAAAAAAA7JkFAVNLbtHQoN/RSa2mg1pNJ/1AknRo2SpMlf7r93XZbOogKnvQ7KgrSTL02Z4NsNaKYSRz0B/9TVOXfV+DpKrYFbUsQ1KgRmf8GiedqLzlxIOaWctH51u2AnU7E/Xxw9+UT0sz5wsAAAAAAABg/yycYdrt1HTUGy+/f+zdR0HQaZ6u2j3dDCeWrg891aMA67RC6VRlSfI7OnpdHj/UTa+to44/U/7i2Irq04gt73/02voavcZkUDNr+VCgRrMxsfx+qJt2FPQ1LDkJs2QBAAAAAAAA7JcFAVNfv7z1vOixEc4u7T6leQFTljG/Po9eNGvUMHScq/xIIH8mVelQfwNJMvQfAVMAAAAAAABg77256VNqpqmLT+f6bhjxvKGzBaOAZuoD679F5YdDPUsTeUezlgcAAAAAAACA0GoCpnZFz44l+X39uPVel+YXSq4eitPRy6H8QFLqoGk4y7M8r7xp6mip8mkE+jsz+xQAAAAAAADAvlmYwzQdU9enlg7l68d0HtM3HJmz69wLMz+KAqyy9CVht/qCHe1qHwR6ylV+AdPWZ0NKXq4PAAAAAAAAYN+sJGAaLoG39MUeRzsLdkm1aO39oRGPgt48hRs7HRbPdW2Oj3NRcfVQtGZeYVS+7Li6jr1GRT+jGazd+97r5lRZy4cstdyKLkbFTVt358UwuOo/6ebthgAAAAAAAACw41awJN/TL99R2ZLKTlUvzsSvgmjtveXopX6qRrOhq6Ek748ap5Zcw5Bbrcsd/4EafV/udNDUa+vy2FXLMuQ6VblO/NfyOzrzlig/YlhqVetqxQvrsr2m3a8AAAAAAAAAbJUVzDCVbtpNXYbr4ENBoG6nqYNGQ5f94PVn/muBoa4aTTVif+PrchRQTXyNhk46vgYTf6IgULff1EFCQDNrecnXZbOj7kT5gd/XSa3N7FIAAAAAAADggzj49u3by//+/fe96/GObN3VHZXl65LgKAAAAAAAAPChrWSGKQAAAAAAAADsAwKmAAAAAAAAABAhYAoAAAAAAAAAkX/euwLvz9NZLWkTKAAAAAAAAAAfTULA9J03QbIrenEsDfpNHfWGm371DTB1Ufqk75alQ2P800Hg6/dtW1dDvbbBDL+jg/bbwd2LSl0tK335t7ExFgAAAAAAAD4GluRv2EWlqlYxHiyVpEPD0mfbfJ9KAQAAAAAAAJDEkvwNs/XFkqRAjc6trrzxDNqCaepY0b+9tg4mJ4aaJT1XizpM+So37RqzQAEAAAAAAIAcCJi+i0C+F0838Dgc6vGdagMAAAAAAAAg9GbAtGBX9PN0vIR84Hf0te3NBvdMW9efTvXZMsYzIYNAjfv4TMr5xw7U7d/qbEHa0um6KAjU9W91NifXabry8fycT6WKfhat6BwCdTu3OptT/3RMXbtVubEl+JZa9bpasXJL5Aedk/M0OQ/s1PmmfX+TX5jcpgAAAAAAANgrC3OYWiVXD0483+ah5ehnaTrXpq27qiN3MlgqSYYh1znXdUJqzsLMsQ2Vi9XkzY4kXVRm6yIj+puKvXR5SfpSqevhNVga1cmp6i65+M5L//4mMXXtOiorUKNJsBQAAAAAAAD7YcEMU0tuURr0O/raC2ccFkquHoqGDi1bhV4vNgvxr9/Xrz+ebobRjEYzDKKWZeizbepqalZnrRhG6cazIKPd42MBy1HxilqWoencnwW7op+OpUPL0Z3t6czLWT4637I1OaPUDDdosqTyaUkFr5dzyfxQV42arqLzXsuMzKmcp6P3abFs7++0i0pVrhGo0WzoapkJuAAAAAAAAMAWWTjDtNup6ag3Xp792LtXN7Gkp6t2bxwslaShp3o/SCxdKJ2qLEl+Z2LJ+FA3vbaOOv5M+YtjK6pPI7a8/9Fr62v0GuXTkgo5y4fC4N94+f1QN+1OeL6GJWcPN7BP//7GXVRctawgbF+CpQAAAAAAANgjCwKmvn5583+7jGMjnP3YfUrzAqYsY359Hj1fA0kyDB3nKj8SyJ8J/g31N5AkQ//tXcA03/trlVy1LEPdTmNqhi4AAAAAAACw+97c9Ck109TFp3N9N4x43tDZglFAM/WB9d+i8sOhnqWJZfxZyyM9Q5+jN+/INCUxvRQAAAAAAAD7ZeGS/NTsip6rVX2Xrx+3TR3Uajqo1XSSuCR/KD95pf4co1mec5imjpYqn0agv8QGJQX60QjTFBwW93czLAAAAAAAAHxcKwiYmro+tXQoXz+m85i+IZylGFeY+dEowGrpS0KArmBHm0QFgZ5ylV/AtPXZkJKX639Uns6afQ0klR2XoCkAAAAAAAD2ykoCpuESeEtf7HG0s2CXVIuWbx8a8SjozVO4sdNh8VzX5vg4FxVXD0Vr5hVG5cuOq+vYa1T0M9oNvns/3tU9a/mQpZZb0cWouGnr7rwYBlf9p9XtaL8Phr1ocy4jbOO9y+8KAAAAAACAj2oFOUw9/fIdlS2p7FT14kz8KggkGZLl6KV+qkYz2lXd+6PGqSXXMORW63LHf6BG35c7HTT12ro8Djcbcp2qXCf+a/md+AZEWcuPGJZa1bpa8cK6bLO70QyvrRNV9OBYcqsV+c22bpiFCwAAAAAAgB23khymN+2mLicTkwaBup2mDhoNXY7ymAaB/NcCQ101mmrE/sbX5SigmvgaDZ10fA0m85MGgbr9pg4SAppZy0u+LpsddSfKD/y+TmptZpfO8ei1ozy1llrVii7eu0IAAAAAAADAkg6+ffv28r9//33verwjW3d1R2X5uiQ4CgAAAAAAAHxoK5lhCgAAAAAAAAD7gIApAAAAAAAAAEQImAIAAAAAAABA5J/pH7zU65kOcFCrrawy78PTWS1pEygAAAAAAAAAHw0zTAEAAAAAAAAgQsAUAAAAAAAAACIETAEAAAAAAAAgQsAUAAAAAAAAACIETAEAAAAAAAAgQsAUAAAAAAAAACIETAEAAAAAAAAgQsAUAAAAAAAAACL/D0lclpc8y8JZAAAAAElFTkSuQmCC" alt="image-20200508025311516"></p> <h2 id="flink当中的window窗口"><a href="#flink当中的window窗口" class="header-anchor">#</a> Flink当中的window窗口</h2> <ul><li>对于流式处理，如果我们需要求取总和，平均值，或者最大值，最小值等，是做不到的，因为数据一直在源源不断的产生，即数据是没有边界的，所以没法求最大值，最小值，平均值等，所以为了一些数值统计的功能，我们必须指定时间段，对某一段时间的数据求取一些数据值是可以做到的。或者对某一些数据求取数据值也是可以做到的</li> <li>所以，流上的聚合需要由 window 来划定范围，比如 “计算过去的5分钟” ，或者 “最后100个元素的和” 。</li> <li>window是一种可以把无限数据切割为有限数据块的手段
<ul><li>窗口可以是 <strong>时间驱动</strong>的 【Time Window】（比如：每30秒）</li> <li>或者 <strong>数据驱动</strong>的【Count Window】 （比如：每100个元素）</li></ul></li></ul> <p><img src="/assets/img/1584599129746.6110109c.png" alt="1584599129746"></p> <ul><li>窗口类型汇总：</li></ul> <p><img src="/assets/img/window.f4f2da41.png" alt="1587473202406"></p> <h5 id="_7-1-窗口的基本类型介绍"><a href="#_7-1-窗口的基本类型介绍" class="header-anchor">#</a> 7.1 窗口的基本类型介绍</h5> <ul><li><p>窗口通常被区分为不同的类型:</p> <ul><li><p>tumbling windows：滚动窗口 【没有重叠】</p> <ul><li>滚动窗口下<strong>窗口之间之间不重叠</strong>，且窗口长度是固定的</li></ul> <p>![](flink.assets/tumbling windows.png)</p></li> <li><p>sliding windows：滑动窗口 【<strong>有重叠</strong>】</p> <ul><li>滑动窗口以一个步长（Slide）不断向前滑动，窗口的长度固定</li></ul> <p>![1587473504462](flink.assets/sliding windows.png)</p></li> <li><p>session windows：会话窗口 ，<strong>一般没人用</strong></p> <ul><li>会话窗口根据Session gap切分不同的窗口，当一个窗口在大于Session gap的时间内没有接收到新数据时，窗口将关闭</li></ul> <p>![1587473534498](flink.assets/session windows.png)</p></li></ul></li></ul> <h5 id="_7-2-flink的窗口介绍"><a href="#_7-2-flink的窗口介绍" class="header-anchor">#</a> 7.2  Flink的窗口介绍</h5> <h6 id="_7-2-1-time-window窗口的应用"><a href="#_7-2-1-time-window窗口的应用" class="header-anchor">#</a> 7.2.1 Time Window窗口的应用</h6> <p>time window又分为滚动窗口和滑动窗口，这两种窗口调用方法都是一样的，都是调用timeWindow这个方法，如果传入==一个参数就是滚动窗口==，如果传入==两个参数就是滑动窗口==</p> <p>​     <img src="/assets/img/1584599265529.41d219ba.png" alt=""></p> <p>需求：每隔5s时间，统计最近10s出现的数据</p> <p>代码实现：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time

<span class="token keyword">object</span> TestTimeWindow <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token keyword">val</span> socketSource<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

    socketSource
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h6 id="_7-2-2-count-windos窗口的应用"><a href="#_7-2-2-count-windos窗口的应用" class="header-anchor">#</a> 7.2.2 Count Windos窗口的应用</h6> <ul><li><p>与timeWindow类型，CountWinodw也可以分为滚动窗口和滑动窗口，这两个窗口调用方法一样，都是调用countWindow，如果传入一个参数就是滚动窗口，如果传入两个参数就是滑动窗口</p> <p>​     <img src="/assets/img/1584599273870.60318042.png" alt="1584599273870"></p></li></ul> <p>需求：使用count Window 统计最近5条数的最大值</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>AggregateFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>

<span class="token comment">/**
  * 使用countWindow统计最近5条数据的最大值
  */</span>
<span class="token keyword">object</span> TestCountWindow <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token keyword">val</span> socketSource<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

    <span class="token comment">/**
      * 发送数据
      * spark 1
      * spark 2
      * spark 3
      * spark 4
      * hello 100
      * spark 5
      * hello 90
      * hello 80
      * hello 70
      * hello 60
      * hello 10
      */</span>
    socketSource<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>countWindow<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span><span class="token keyword">new</span> AggregateFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token builtin">Double</span><span class="token punctuation">]</span><span class="token punctuation">{</span>   <span class="token comment">//aggregate对window的数据进行处理</span>
          <span class="token keyword">var</span> initAccumulator <span class="token operator">:</span><span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">0</span>
          <span class="token keyword">override</span> <span class="token keyword">def</span> createAccumulator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            initAccumulator
          <span class="token punctuation">}</span>

          <span class="token keyword">override</span> <span class="token keyword">def</span> add<span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> accumulator<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>accumulator <span class="token operator">&gt;=</span> value<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">{</span>
              accumulator
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
              value<span class="token punctuation">.</span>_2
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">override</span> <span class="token keyword">def</span> getResult<span class="token punctuation">(</span>accumulator<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Double</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            accumulator

          <span class="token punctuation">}</span>

          <span class="token keyword">override</span> <span class="token keyword">def</span> merge<span class="token punctuation">(</span>a<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token operator">&gt;=</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>
              a
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
              b
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
当程序运行后，socket发送数据      
      * spark 1
      * spark 2
      * spark 3
      * spark 4
      * hello 100
 后，并不会立即触发统计操作，因为在keyBy分组(分区)后，还不够5条数据。如果再发一个spark应该就可以了。*/</span>
</code></pre></div><p>Flink 的<strong>AggregateFunction是一个基于中间计算结果状态进行增量计算的函数</strong>。由于是迭代计算方式，所以，在窗口处理过程中，不用缓存整个窗口的数据，所以效率执行比较高。</p> <p>由AggregateFunction定义可知，<strong>需要实现4个接口：</strong></p> <ol><li>ACC createAccumulator(); 迭代状态的初始值</li> <li>ACC add(IN value, ACC accumulator); 每一条输入数据，和迭代数据如何迭代</li> <li>ACC merge(ACC a, ACC b); 多个分区的迭代数据如何合并</li> <li>OUT getResult(ACC accumulator); 返回数据，对最终的迭代数据如何处理，并返回结果。</li></ol> <h6 id="_7-2-3-自定义window的应用-了解"><a href="#_7-2-3-自定义window的应用-了解" class="header-anchor">#</a> 7.2.3 自定义window的应用(了解)</h6> <ul><li><p>如果time window 和 countWindow 还不够用的话，我们还可以使用自定义window来实现数据的统计等功能。</p> <p><img src="/assets/img/1584599280754.0d36e793.png" alt="1584599280754"></p></li></ul> <h5 id="_7-3-window窗口数据的集合统计"><a href="#_7-3-window窗口数据的集合统计" class="header-anchor">#</a> 7.3 window窗口数据的集合统计</h5> <ul><li><p>前面我们可以通过aggregrate实现数据的聚合，对于求最大值，最小值，平均值等操作，我们也可以通过process方法来实现</p></li> <li><p>对于某一个window内的数值统计，我们可以增量的聚合统计或者全量的聚合统计</p></li></ul> <h6 id="_7-3-1-增量聚合统计"><a href="#_7-3-1-增量聚合统计" class="header-anchor">#</a> 7.3.1 增量聚合统计</h6> <ul><li><p>窗口当中每加入一条数据，就进行一次统计</p></li> <li><p>常用的聚合算子</p> <ul><li>reduce(reduceFunction)</li> <li>aggregate(aggregateFunction)</li> <li>sum()、min()、max()</li></ul> <p><img src="/assets/img/flink-window函数增量统计.631f9af7.png" alt="flink-window函数增量统计"></p></li> <li><p>需求</p> <ul><li>通过接收socket当中输入的数据，统计每5秒钟数据的累计的值</li></ul></li> <li><p>代码实现</p></li></ul> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>window</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time

<span class="token keyword">object</span> FlinkTimeCount <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

      <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
		
      <span class="token keyword">val</span> socketStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>
      <span class="token comment">/*使用socket发送数据: 
      		23
      		53
      		52
      		743
      	注意：5s很快的。
      	*/</span>
      socketStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span>reduce<span class="token punctuation">(</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span>c2<span class="token punctuation">)</span><span class="token keyword">=&gt;</span><span class="token punctuation">(</span>c1<span class="token punctuation">.</span>_1<span class="token punctuation">,</span>c1<span class="token punctuation">.</span>_2<span class="token operator">+</span>c2<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

      environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;FlinkTimeCount&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>


</code></pre></div><h6 id="_7-3-2-全量聚合统计"><a href="#_7-3-2-全量聚合统计" class="header-anchor">#</a> 7.3.2 全量聚合统计</h6> <ul><li><p><strong>等到窗口截止，或者窗口内的数据全部到齐，然后再进行统计</strong>，可以用于求窗口内的数据的最大值，或者最小值，平均值等</p></li> <li><p>等属于窗口的数据到齐，才开始进行聚合计算【可以实现对窗口内的数据进行排序等需求】</p> <ul><li>apply(windowFunction)</li> <li>process(processWindowFunction)</li> <li>processWindowFunction比windowFunction提供了更多的上下文信息。</li></ul></li> <li><p>需求</p> <ul><li>通过全量聚合统计，求取每3条数据的平均值</li></ul></li> <li><p>代码实现</p></li></ul> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>window</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>GlobalWindow
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token comment">/**
  * 求取每3条数据的平均值
  */</span>
<span class="token keyword">object</span> FlinkCountWindowAvg <span class="token punctuation">{</span>
  <span class="token comment">/**
    * 输入数据
    * 1
    * 2
    * 3
    * 4
    * 5
    * 6
    * @param args
    */</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token keyword">val</span> socketStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

    <span class="token comment">//统计一个窗口内的数据的平均值</span>
    socketStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>countWindow<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
                <span class="token comment">//通过process方法来统计窗口的平均值</span>
                <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> MyProcessWindowFunctionclass<span class="token punctuation">)</span>
                <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//必须调用execute方法，否则程序不会执行</span>
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;count avg&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**ProcessWindowFunction 需要跟四个参数
  * 输入参数类型，输出参数类型，聚合的key的类型，window的下界
  *
  */</span>
<span class="token keyword">class</span> MyProcessWindowFunctionclass <span class="token keyword">extends</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span> <span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token builtin">Double</span> <span class="token punctuation">,</span> Tuple <span class="token punctuation">,</span> GlobalWindow<span class="token punctuation">]</span><span class="token punctuation">{</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token builtin">Double</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> totalNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> countNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>data <span class="token keyword">&lt;-</span>  elements<span class="token punctuation">)</span><span class="token punctuation">{</span>
      totalNum <span class="token operator">+=</span><span class="token number">1</span>
      countNum <span class="token operator">+=</span> data<span class="token punctuation">.</span>_2
    <span class="token punctuation">}</span>
    out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span>countNum<span class="token operator">/</span>totalNum<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="flink中的time概念"><a href="#flink中的time概念" class="header-anchor">#</a> Flink中的Time概念</h2> <ul><li><p>对于流式数据处理，最大的特点是数据上具有时间的属性特征</p></li> <li><p>Flink根据<strong>时间产生的位置</strong>不同，可以将时间区分为三种时间概念</p> <ul><li>==Event Time==（事件生成时间）
<ul><li>事件产生的时间，它通常由事件中的时间戳描述</li></ul></li> <li>==Ingestion time==（事件接入时间）
<ul><li>事件进入Flink程序的时间</li></ul></li> <li>==Processing Time==（事件处理时间）
<ul><li>事件被处理时当前系统的时间</li></ul></li></ul></li></ul> <p><img src="/assets/img/time.cdf0a588.png" alt="1569394563906"></p> <ul><li>Flink在流处理程序中支持不同的时间概念。</li></ul> <h5 id="_1-1-eventtime"><a href="#_1-1-eventtime" class="header-anchor">#</a> 1.1 EventTime</h5> <ul><li>1、<strong>事件生成时的时间</strong>，在进入Flink之前就已经存在，可以从event的字段中抽取</li> <li>2、必须指定watermarks（水位线）的生成方式</li> <li>3、优势：确定性，乱序、延时、或者数据重放等情况，都能给出正确的结果</li> <li>4、弱点：处理无序事件时性能和延迟受到影响</li></ul> <h5 id="_1-2-ingesttime"><a href="#_1-2-ingesttime" class="header-anchor">#</a> 1.2 IngestTime</h5> <ul><li><p>1、<strong>事件进入flink的时间</strong>，即在source里获取的当前系统的时间，后续操作统一使用该时间。</p></li> <li><p>2、不需要指定watermarks的生成方式(自动生成)</p></li> <li><p>3、弱点：不能处理无序事件和延迟数据</p></li></ul> <h5 id="_1-3-processingtime"><a href="#_1-3-processingtime" class="header-anchor">#</a> 1.3 ProcessingTime</h5> <ul><li><p>1、<strong>执行操作的机器的当前系统时间(每个算子都不一样)</strong></p></li> <li><p>2、不需要流和机器之间的协调</p></li> <li><p>3、优势：最佳的性能和最低的延迟</p></li> <li><p>4、弱点：不确定性 ，容易受到各种因素影像(event产生的速度、到达flink的速度、在算子之间传输速度等)，压根就不管顺序和延迟</p></li></ul> <h5 id="_1-4-三种时间的综合比较"><a href="#_1-4-三种时间的综合比较" class="header-anchor">#</a> 1.4 三种时间的综合比较</h5> <ul><li><p>性能</p> <ul><li>ProcessingTime &gt; IngestTime &gt; EventTime</li></ul></li> <li><p>延迟</p> <ul><li>ProcessingTime &lt; IngestTime &lt; EventTime</li></ul></li> <li><p>确定性</p> <ul><li>EventTime &gt; IngestTime &gt; ProcessingTime</li></ul></li></ul> <h5 id="_1-5-设置-time-类型"><a href="#_1-5-设置-time-类型" class="header-anchor">#</a> 1.5 设置 Time 类型</h5> <ul><li><p>可以你的流处理程序是以哪一种时间为标志的。</p> <ul><li>在我们创建StreamExecutionEnvironment的时候可以设置Time类型，<strong>不设置Time类型，默认是ProcessingTime</strong>。</li> <li>如果设置Time类型为EventTime或者IngestTime，需要在创建StreamExecutionEnvironment中调用<strong>setStreamTimeCharacteristic()</strong> 方法指定。</li></ul> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

<span class="token comment">//不设置Time 类型，默认是processingTime。</span>
environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>ProcessingTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//指定流处理程序以IngestionTime为准</span>
<span class="token comment">//environment.setStreamTimeCharacteristic(TimeCharacteristic.IngestionTime);</span>

<span class="token comment">//指定流处理程序以EventTime为准</span>
<span class="token comment">//environment.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span>


</code></pre></div></li></ul> <h5 id="_1-6-processwindowfunction实现时间确定"><a href="#_1-6-processwindowfunction实现时间确定" class="header-anchor">#</a> 1.6 ProcessWindowFunction实现时间确定</h5> <ul><li><p>需求</p> <ul><li>通过process实现处理时间的确定，包括数据时间、window时间等</li></ul></li> <li><p>代码开发</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>time</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>FastDateFormat
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token comment">/**
  * 通过process实现处理时间的确定，包括数据时间，window时间等
  */</span>
<span class="token keyword">object</span> TimeWindowWordCount <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token keyword">val</span> socketSource<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>
     <span class="token comment">//对数据进行处理</span>
    socketSource<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> SumProcessFunction<span class="token punctuation">)</span>
                <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> SumProcessFunction <span class="token keyword">extends</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Tuple<span class="token punctuation">,</span>TimeWindow<span class="token punctuation">]</span><span class="token punctuation">{</span>

  <span class="token keyword">val</span> format<span class="token operator">:</span> FastDateFormat <span class="token operator">=</span> FastDateFormat<span class="token punctuation">.</span>getInstance<span class="token punctuation">(</span><span class="token string">&quot;HH:mm:ss&quot;</span><span class="token punctuation">)</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    println<span class="token punctuation">(</span><span class="token string">&quot;当前系统时间为：&quot;</span><span class="token operator">+</span>format<span class="token punctuation">.</span>format<span class="token punctuation">(</span>System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;window的处理时间为：&quot;</span><span class="token operator">+</span>format<span class="token punctuation">.</span>format<span class="token punctuation">(</span>context<span class="token punctuation">.</span>currentProcessingTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;window的开始时间为：&quot;</span><span class="token operator">+</span>format<span class="token punctuation">.</span>format<span class="token punctuation">(</span>context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart<span class="token punctuation">)</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;window的结束时间为：&quot;</span><span class="token operator">+</span>format<span class="token punctuation">.</span>format<span class="token punctuation">(</span>context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span> elements<span class="token punctuation">)</span><span class="token punctuation">{</span>
      sum <span class="token operator">+=</span> eachElement<span class="token punctuation">.</span>_2
    <span class="token punctuation">}</span>
    out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>getField<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div></li></ul> <ul><li><p>开启netcat服务，启动程序，socket随便发送一个数字,如12，idea内容输出如下：</p> <div class="language- extra-class"><pre class="language-text"><code>当前系统时间为：14:38:03
window的处理时间为：14:38:03
window的开始时间为：14:38:01
window的结束时间为：14:38:03
1&gt; (12,1)
当前系统时间为：14:38:04
window的处理时间为：14:38:04
window的开始时间为：14:38:02
window的结束时间为：14:38:04
1&gt; (12,1)
</code></pre></div></li></ul> <h2 id="watermark机制"><a href="#watermark机制" class="header-anchor">#</a> Watermark机制</h2> <h5 id="_2-1-watermark的概念"><a href="#_2-1-watermark的概念" class="header-anchor">#</a> 2.1 Watermark的概念</h5> <p>通常情况下由于网络或者系统等外部因素影响下，<strong>事件数据往往不能及时传输至FLink系统中</strong>，导致系统的不稳定而造成数据<strong>乱序到达或者延迟达到</strong>等问题，因此需要有一种机制能够控制数据处理的进度。</p> <p>具体来讲，在创建一个基于时间的window后，需要确定属于该window的数据元素是否已经全部到达，确定后才可以对window中的所有数据做计算处理（如汇总、分组），如果数据并没有全部到达，则继续<strong>等待该窗口的数据全部到达后再开始计算</strong>。</p> <p>但是对于但是对于late element，我们又<strong>不能无限期的等下去</strong>，必须要有个机制来<strong>保证一个特定的时间后，必须触发window去进行计算</strong>了。在这种情况下就需要用到水位线 (Watermark) 机制。</p> <h5 id="_2-2-watermark的作用"><a href="#_2-2-watermark的作用" class="header-anchor">#</a> 2.2 Watermark的作用</h5> <p>它能够衡量数据处理进度，保证事件数据全部到达Flink系统，即使数据乱序或者延迟到达，也能够像预期一样计算出正确和连续的结果。<strong>通常watermark是结合window来实现</strong>。</p> <h5 id="_2-3-watermark的原理"><a href="#_2-3-watermark的原理" class="header-anchor">#</a> 2.3 Watermark的原理</h5> <p>在 Flink 的窗口处理过程中，如果确定全部数据到达，就可以对 Window 的所有数据做窗口计算操作（如汇总、分组等），如果数据没有全部到达，则继续等待该窗口中的数据全部到达才开始处理。</p> <p>这种情况下就需要用到水位线（WaterMarks）机制，它能够衡量数据处理进度（表达数据到达的完整性），保证事件数据（全部）到达Flink系统，或者在乱序及延迟到达时，也能够像预期一样计算出正确并且连续的结果。<strong>当任何 Event 进入到 Flink 系统时，会根据当前最大事件时间产生 Watermarks 时间戳</strong>。</p> <p>那么 Flink 是怎么计算 Watermak 的值呢？</p> <ul><li>==Watermark = 进入 Flink 的最大的事件时间（maxEventTime）— 指定的延迟时间（t）==</li></ul> <p>==那么有 Watermark 的 Window 是怎么触发窗口函数的呢？==</p> <div class="language- extra-class"><pre class="language-text"><code>（1） watermark &gt;= window的结束时间
（2） 该窗口必须有数据   
  	注意：[window_start_time,window_end_time) 中有数据存在，这是前闭后开区间！！！也就是如果一条数据时间产生时间正好等于窗口的结束时间，它不会计算到该窗口中，会计算到下一个窗口中。
</code></pre></div><p>==注意==：Watermark 本质可以理解成一个延迟触发机制或者理解成一个时间戳。</p> <h5 id="_2-4-watermark-的使用存在三种情况"><a href="#_2-4-watermark-的使用存在三种情况" class="header-anchor">#</a> 2.4 Watermark 的使用存在三种情况</h5> <p>（1）有序的数据流中的watermark</p> <p>​	如果数据元素的事件时间是有序的，Watermark 时间戳会随着数据元素的事件时间按顺 序生成，此时水位线的变化和事件时间保持一致（因为既然是<strong>有序的时间，就不需要设置延迟了</strong>，那么t 就是 0。所以 <strong>watermark=maxtime-0 = maxtime</strong>），也就是理想状态下的水位线。当 Watermark 时间大于 Windows 结束时间就会触发对 Windows 的数据计算，以此类推， 下一个 Window 也是一样。</p> <img src="flink.assets/1584669877499.png" alt="1584669877499" style="zoom:150%;"> <p>（2）乱序的数据流watermark</p> <p>现实情况下数据元素往往并不是按照其产生顺序接入到 Flink 系统中进行处理，而频繁出现乱序或迟到的情况，这种情况就需要使用 Watermarks 来应对。比如下图，设置延迟时间 t 为 2</p> <img src="flink.assets/1584669886227.png" alt="1584669886227" style="zoom:150%;"> <p>（3）并行数据流中的 Watermark</p> <p>在多并行度的情况下，Watermark 会有一个对齐机制，这个对齐机制会<strong>取所有 Channel 中最小的 Watermark</strong>。</p> <p><img src="/assets/img/1587869656089.4b467015.png" alt="1587869656089"></p> <h5 id="_2-5-引入watermark和eventtime"><a href="#_2-5-引入watermark和eventtime" class="header-anchor">#</a> 2.5 引入watermark和eventtime</h5> <h6 id="_1、有序数据流中引入-watermark-和-eventtime"><a href="#_1、有序数据流中引入-watermark-和-eventtime" class="header-anchor">#</a> 1、有序数据流中引入 Watermark 和 EventTime</h6> <ul><li>对于有序的数据，代码比较简洁，主要需要从源 Event 中抽取 EventTime</li> <li>需求
<ul><li>对socket中有序（按照时间递增）的数据流，进行每5s处理一次</li></ul></li> <li>代码演示</li></ul> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token keyword">object</span> OrderedStreamWaterMark <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

      <span class="token comment">//todo:1.构建流式处理环境</span>
      <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
      environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:2.设置时间类型</span>
     environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

    <span class="token comment">//todo:3.获取数据源</span>
      <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:4. 数据处理</span>
      <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">//todo: 5.从源Event中抽取eventTime</span>
      <span class="token comment">//如果是有序的数据，可以直接使用assignAscendingTimestamps，设置把事件生成时间看成是watermark</span>
      <span class="token keyword">val</span> watermarkStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapStream<span class="token punctuation">.</span>assignAscendingTimestamps<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>_2<span class="token punctuation">)</span>


    <span class="token comment">//todo:6. 数据计算</span>
     watermarkStream<span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Tuple<span class="token punctuation">,</span>TimeWindow<span class="token punctuation">]</span> <span class="token punctuation">{</span>
                        <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

                          <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> key<span class="token punctuation">.</span>getField<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

                          <span class="token comment">//窗口的开始时间</span>
                          <span class="token keyword">val</span> startTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart
                          <span class="token comment">//窗口的结束时间</span>
                          <span class="token keyword">val</span> startEnd<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd

                          <span class="token comment">//获取当前的 watermark</span>
                          <span class="token keyword">val</span> watermark<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentWatermark

                          <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">0</span>
                          <span class="token keyword">val</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span>toList
                          <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span>  toList<span class="token punctuation">)</span><span class="token punctuation">{</span>
                            sum <span class="token operator">+=</span><span class="token number">1</span>
                          <span class="token punctuation">}</span>


                          println<span class="token punctuation">(</span><span class="token string">&quot;窗口的数据条数:&quot;</span><span class="token operator">+</span>sum<span class="token operator">+</span>
                            <span class="token string">&quot; |窗口的第一条数据：&quot;</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>head<span class="token operator">+</span>
                            <span class="token string">&quot; |窗口的最后一条数据：&quot;</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>last<span class="token operator">+</span>
                            <span class="token string">&quot; |窗口的开始时间： &quot;</span><span class="token operator">+</span> startTime<span class="token operator">+</span>
                            <span class="token string">&quot; |窗口的结束时间： &quot;</span><span class="token operator">+</span> startEnd<span class="token operator">+</span>
                            <span class="token string">&quot; |当前的watermark:&quot;</span><span class="token operator">+</span> watermark<span class="token punctuation">)</span>

                          out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span>

                        <span class="token punctuation">}</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>


    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>socket发送下列数据（第一位是数据，第二位是数据产生的时间event time的时间戳）：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756866000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756872000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756873000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756874000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756875000</span>
</code></pre></div><p>如果socket一次性发送所有数据，输出结果如下：</p> <div class="language-scala extra-class"><pre class="language-scala"><code>窗口的数据条数<span class="token operator">:</span><span class="token number">1</span> <span class="token operator">|</span>窗口的第一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的最后一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的开始时间： <span class="token number">1461756860000</span> <span class="token operator">|</span>窗口的结束时间： <span class="token number">1461756865000</span> <span class="token operator">|</span>当前的watermark<span class="token operator">:</span><span class="token number">1461756873999</span>
<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
窗口的数据条数<span class="token operator">:</span><span class="token number">1</span> <span class="token operator">|</span>窗口的第一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756866000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的最后一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756866000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的开始时间： <span class="token number">1461756865000</span> <span class="token operator">|</span>窗口的结束时间： <span class="token number">1461756870000</span> <span class="token operator">|</span>当前的watermark<span class="token operator">:</span><span class="token number">1461756873999</span>
<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
窗口的数据条数<span class="token operator">:</span><span class="token number">3</span> <span class="token operator">|</span>窗口的第一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756872000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的最后一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756874000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的开始时间： <span class="token number">1461756870000</span> <span class="token operator">|</span>窗口的结束时间： <span class="token number">1461756875000</span> <span class="token operator">|</span>当前的watermark<span class="token operator">:</span><span class="token number">1461756874999</span>
<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>

</code></pre></div><p>如果socket缓慢一条条地发送数据，输出结果如下，跟上面基本一样，只是触发计算的watermark的值发生了变化：</p> <div class="language-scala extra-class"><pre class="language-scala"><code>窗口的数据条数<span class="token operator">:</span><span class="token number">1</span> <span class="token operator">|</span>窗口的第一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的最后一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的开始时间： <span class="token number">1461756860000</span> <span class="token operator">|</span>窗口的结束时间： <span class="token number">1461756865000</span> <span class="token operator">|</span>当前的watermark<span class="token operator">:</span><span class="token number">1461756865999</span>
<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
窗口的数据条数<span class="token operator">:</span><span class="token number">1</span> <span class="token operator">|</span>窗口的第一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756866000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的最后一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756866000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的开始时间： <span class="token number">1461756865000</span> <span class="token operator">|</span>窗口的结束时间： <span class="token number">1461756870000</span> <span class="token operator">|</span>当前的watermark<span class="token operator">:</span><span class="token number">1461756871999</span>
<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
窗口的数据条数<span class="token operator">:</span><span class="token number">3</span> <span class="token operator">|</span>窗口的第一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756872000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的最后一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756874000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的开始时间： <span class="token number">1461756870000</span> <span class="token operator">|</span>窗口的结束时间： <span class="token number">1461756875000</span> <span class="token operator">|</span>当前的watermark<span class="token operator">:</span><span class="token number">1461756874999</span>
<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre></div><p>注意，<strong>在该案例中，设置了并行度为1</strong>，environment.setParallelism(1)，如果没有设置并行度为1，将不会由输出内容，因为在多并行度时，watermark会取所有channel（分区）中最小的watermark。而在本例中，所有的数据的key都是000001，被分配到同一个分区中，导致其它分区没有数据，从而最终watermark的值太小，不足以触发计算。</p> <h6 id="_2、乱序数据流中引入-watermark-和-eventtime"><a href="#_2、乱序数据流中引入-watermark-和-eventtime" class="header-anchor">#</a> 2、乱序数据流中引入 Watermark 和 EventTime</h6> <p>对于乱序数据流，有两种常见的引入方法：周期性和间断性</p> <p>(1)With Periodic（<strong>周期性的</strong>） Watermark  （重点）</p> <p>周期性地生成 Watermark 的生成，默认是 100ms。每隔 N 毫秒自动向流里注入一个 Watermark，时间间隔由 streamEnv.getConfig.setAutoWatermarkInterval()决定</p> <p>需求：对socket中无序数据流，进行每5s处理一次，数据中会有延迟</p> <p>代码演示:</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>watermark</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>AssignerWithPeriodicWatermarks
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span>Watermark
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector


<span class="token comment">//对无序的数据流周期性的添加水印</span>
<span class="token keyword">object</span> OutOfOrderStreamPeriodicWaterMark <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>


     <span class="token comment">//todo:1.构建流式处理环境</span>
      <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
      environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>


     <span class="token comment">//todo:2.设置时间类型</span>
     environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

    <span class="token comment">//todo:3.获取数据源</span>
      <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:4. 数据处理</span>
      <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>


    <span class="token comment">//todo:5. 添加水位线</span>
    mapStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span>
        <span class="token keyword">new</span> AssignerWithPeriodicWatermarks<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>

        <span class="token comment">//定义延迟时间长度</span>
        <span class="token comment">//表示在5秒以内的数据延时有效，超过5秒的数据被认定为迟到事件</span>

        <span class="token keyword">val</span> maxOutOfOrderness<span class="token operator">=</span><span class="token number">5000L</span>
        <span class="token comment">//历史最大事件时间</span>
        <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span><span class="token builtin">Long</span><span class="token operator">=</span>_

        <span class="token keyword">var</span> watermark<span class="token operator">:</span>Watermark<span class="token operator">=</span>_

         <span class="token comment">//周期性的生成水位线watermark</span>
        <span class="token keyword">override</span> <span class="token keyword">def</span> getCurrentWatermark<span class="token operator">:</span> Watermark <span class="token operator">=</span><span class="token punctuation">{</span>
          watermark <span class="token operator">=</span>  <span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>currentMaxTimestamp <span class="token operator">-</span>maxOutOfOrderness<span class="token punctuation">)</span>
          watermark
        <span class="token punctuation">}</span>

        <span class="token comment">//抽取事件时间</span>
        <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token comment">//获取事件时间</span>
            <span class="token keyword">val</span> currentElementEventTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>_2

            <span class="token comment">//对比当前事件时间和历史最大事件时间, 将较大值重新赋值给currentMaxTimestamp</span>
            currentMaxTimestamp<span class="token operator">=</span>Math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>currentMaxTimestamp<span class="token punctuation">,</span>currentElementEventTime<span class="token punctuation">)</span>
            println<span class="token punctuation">(</span><span class="token string">&quot;接受到的事件：&quot;</span><span class="token operator">+</span>element<span class="token operator">+</span><span class="token string">&quot; |事件时间： &quot;</span><span class="token operator">+</span>currentElementEventTime<span class="token punctuation">)</span>

            currentElementEventTime
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Tuple<span class="token punctuation">,</span>TimeWindow<span class="token punctuation">]</span> <span class="token punctuation">{</span>
            <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>


              <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> key<span class="token punctuation">.</span>getField<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

              <span class="token comment">//窗口的开始时间</span>
              <span class="token keyword">val</span> startTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart
              <span class="token comment">//窗口的结束时间</span>
              <span class="token keyword">val</span> startEnd<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd

              <span class="token comment">//获取当前的 watermark</span>
              <span class="token keyword">val</span> watermark<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentWatermark

              <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">0</span>
              <span class="token keyword">val</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span>toList
              <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span>  toList<span class="token punctuation">)</span><span class="token punctuation">{</span>
                sum <span class="token operator">+=</span><span class="token number">1</span>
              <span class="token punctuation">}</span>


              println<span class="token punctuation">(</span><span class="token string">&quot;窗口的数据条数:&quot;</span><span class="token operator">+</span>sum<span class="token operator">+</span>
                <span class="token string">&quot; |窗口的第一条数据：&quot;</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>head<span class="token operator">+</span>
                <span class="token string">&quot; |窗口的最后一条数据：&quot;</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>last<span class="token operator">+</span>
                <span class="token string">&quot; |窗口的开始时间： &quot;</span><span class="token operator">+</span>  startTime <span class="token operator">+</span>
                <span class="token string">&quot; |窗口的结束时间： &quot;</span><span class="token operator">+</span> startEnd<span class="token operator">+</span>
                <span class="token string">&quot; |当前的watermark:&quot;</span><span class="token operator">+</span>watermark<span class="token punctuation">)</span>

              out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>


    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>


<span class="token punctuation">}</span>


</code></pre></div><p>socket发送数据</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756872000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756873000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756874000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756875000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756871000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756866000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756880000</span>
</code></pre></div><p>输出结果：</p> <div class="language-scala extra-class"><pre class="language-scala"><code>窗口的数据条数<span class="token operator">:</span><span class="token number">1</span> <span class="token operator">|</span>窗口的第一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的最后一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的开始时间： <span class="token number">1461756860000</span> <span class="token operator">|</span>窗口的结束时间： <span class="token number">1461756865000</span> <span class="token operator">|</span>当前的watermark<span class="token operator">:</span><span class="token number">1461756867000</span>
<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
窗口的数据条数<span class="token operator">:</span><span class="token number">4</span> <span class="token operator">|</span>窗口的第一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756872000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的最后一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756871000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的开始时间： <span class="token number">1461756870000</span> <span class="token operator">|</span>窗口的结束时间： <span class="token number">1461756875000</span> <span class="token operator">|</span>当前的watermark<span class="token operator">:</span><span class="token number">1461756875000</span>
<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>
</code></pre></div><p>示意图：</p> <ol><li>62000进来，窗口坐标从60000开始，62000-5000=57000&lt;65000,没有触发计算</li> <li>72000进来，72000-5000=67000，触发60000-65000窗口的计算，该窗口包含一条数据。注意，72000进来后，65000-70000窗口被关闭了，后面如果有数据进入到该窗口时，不会被计算。</li> <li>73000进来，73000-5000=68000&lt;75000，没有触发计算。后面的74000，75000，71000，66000一次类推。</li> <li>80000进来，80000-5000=75000&gt;=75000,触发窗口70000-75000的计算，该窗口包含4条数据（不包括66000）。</li></ol> <img src="flink.assets/image-20200509011401960.png" alt="image-20200509011401960" style="zoom:67%;"> <p>(2)With Punctuated（<strong>间断性的</strong>） Watermark</p> <p>间断性的生成 Watermark 一般是基于某些事件触发 Watermark 的生成和发送。比如说只给用户id为000001的添加watermark，其他的用户就不添加</p> <p>需求：对socket中无序数据流，进行每5s处理一次，数据中会有延迟</p> <p>代码演示</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>watermark</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>FastDateFormat
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>MapFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token punctuation">{</span>AssignerWithPeriodicWatermarks<span class="token punctuation">,</span> AssignerWithPunctuatedWatermarks<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span>Watermark
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token comment">//对无序的数据流间断性的添加水印</span>
<span class="token keyword">object</span> OutOfOrderStreamPunctuatedWaterMark <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>


    <span class="token comment">//todo:1.构建流式处理环境</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>


    <span class="token comment">//todo:2.设置时间类型</span>
    environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

    <span class="token comment">//todo:3.获取数据源</span>
    <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:4. 数据处理</span>
    <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>


    <span class="token comment">//todo:5. 添加水位线</span>
    mapStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span>
      <span class="token keyword">new</span> AssignerWithPunctuatedWatermarks<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>

        <span class="token comment">//定义延迟时间长度</span>
        <span class="token comment">//表示在5秒以内的数据延时有效，超过5秒的数据被认定为迟到事件</span>
        <span class="token keyword">val</span> maxOutOfOrderness<span class="token operator">=</span><span class="token number">5000L</span>
        <span class="token comment">//历史最大事件时间</span>
        <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span><span class="token builtin">Long</span><span class="token operator">=</span>_

        <span class="token keyword">override</span> <span class="token keyword">def</span> checkAndGetNextWatermark<span class="token punctuation">(</span>lastElement<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> extractedTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> Watermark <span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token comment">//当用户id为000001生成watermark</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span>lastElement<span class="token punctuation">.</span>_1<span class="token punctuation">.</span>equals<span class="token punctuation">(</span><span class="token string">&quot;000001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

                  <span class="token keyword">val</span> watermark<span class="token operator">=</span>  <span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>currentMaxTimestamp<span class="token operator">-</span>maxOutOfOrderness<span class="token punctuation">)</span>

                  watermark
               <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                 <span class="token comment">//其他情况下不返回水位线</span>
                  <span class="token keyword">null</span>
               <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          <span class="token comment">//获取事件时间</span>
          <span class="token keyword">val</span> currentElementEventTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>_2

          <span class="token comment">//对比当前事件时间和历史最大事件时间, 将较大值重新赋值给currentMaxTimestamp</span>
          currentMaxTimestamp<span class="token operator">=</span>Math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>currentMaxTimestamp<span class="token punctuation">,</span>currentElementEventTime<span class="token punctuation">)</span>

          println<span class="token punctuation">(</span><span class="token string">&quot;接受到的事件：&quot;</span><span class="token operator">+</span>element<span class="token operator">+</span><span class="token string">&quot; |事件时间： &quot;</span><span class="token operator">+</span>currentElementEventTime <span class="token punctuation">)</span>

          currentElementEventTime

        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Tuple<span class="token punctuation">,</span>TimeWindow<span class="token punctuation">]</span> <span class="token punctuation">{</span>
          <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

            <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> key<span class="token punctuation">.</span>getField<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

            <span class="token comment">//窗口的开始时间</span>
            <span class="token keyword">val</span> startTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart
            <span class="token comment">//窗口的结束时间</span>
            <span class="token keyword">val</span> startEnd<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd

            <span class="token comment">//获取当前的 watermark</span>
            <span class="token keyword">val</span> watermark<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentWatermark

            <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">val</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span>toList
            <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span>  toList<span class="token punctuation">)</span><span class="token punctuation">{</span>
              sum <span class="token operator">+=</span><span class="token number">1</span>
            <span class="token punctuation">}</span>

            println<span class="token punctuation">(</span><span class="token string">&quot;窗口的数据条数:&quot;</span><span class="token operator">+</span>sum<span class="token operator">+</span>
              <span class="token string">&quot; |窗口的第一条数据：&quot;</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>head<span class="token operator">+</span>
              <span class="token string">&quot; |窗口的最后一条数据：&quot;</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>last<span class="token operator">+</span>
              <span class="token string">&quot; |窗口的开始时间： &quot;</span><span class="token operator">+</span>startTime <span class="token operator">+</span>
              <span class="token string">&quot; |窗口的结束时间： &quot;</span><span class="token operator">+</span>startEnd<span class="token operator">+</span>
              <span class="token string">&quot; |当前的watermark:&quot;</span><span class="token operator">+</span>watermark<span class="token punctuation">)</span>

            out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span>

          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>


    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>


  <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre></div><p>socket发送数据</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token number">000002</span><span class="token punctuation">,</span><span class="token number">1461756866000</span>
<span class="token number">000002</span><span class="token punctuation">,</span><span class="token number">1461756872000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756872000</span>
<span class="token number">000002</span><span class="token punctuation">,</span><span class="token number">1461756875000</span>     <span class="token comment">//不会触发计算</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756875000</span>     <span class="token comment">//触发计算</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756880000</span>     <span class="token comment">//触发计算，因为keyBy(0)分组的原因，000002和000001的数据会分开计算。</span>
</code></pre></div><p>输出结果：</p> <div class="language-scala extra-class"><pre class="language-scala"><code>窗口的数据条数<span class="token operator">:</span><span class="token number">1</span> <span class="token operator">|</span>窗口的第一条数据：<span class="token punctuation">(</span><span class="token number">000002</span><span class="token punctuation">,</span><span class="token number">1461756866000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的最后一条数据：<span class="token punctuation">(</span><span class="token number">000002</span><span class="token punctuation">,</span><span class="token number">1461756866000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的开始时间： <span class="token number">1461756865000</span> <span class="token operator">|</span>窗口的结束时间： <span class="token number">1461756870000</span> <span class="token operator">|</span>当前的watermark<span class="token operator">:</span><span class="token number">1461756870000</span>
<span class="token punctuation">(</span><span class="token number">000002</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
窗口的数据条数<span class="token operator">:</span><span class="token number">1</span> <span class="token operator">|</span>窗口的第一条数据：<span class="token punctuation">(</span><span class="token number">000002</span><span class="token punctuation">,</span><span class="token number">1461756872000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的最后一条数据：<span class="token punctuation">(</span><span class="token number">000002</span><span class="token punctuation">,</span><span class="token number">1461756872000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的开始时间： <span class="token number">1461756870000</span> <span class="token operator">|</span>窗口的结束时间： <span class="token number">1461756875000</span> <span class="token operator">|</span>当前的watermark<span class="token operator">:</span><span class="token number">1461756875000</span>
<span class="token punctuation">(</span><span class="token number">000002</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
窗口的数据条数<span class="token operator">:</span><span class="token number">1</span> <span class="token operator">|</span>窗口的第一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756872000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的最后一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756872000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的开始时间： <span class="token number">1461756870000</span> <span class="token operator">|</span>窗口的结束时间： <span class="token number">1461756875000</span> <span class="token operator">|</span>当前的watermark<span class="token operator">:</span><span class="token number">1461756875000</span>
<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><h6 id="_3、window-的allowedlateness处理延迟太大的数据"><a href="#_3、window-的allowedlateness处理延迟太大的数据" class="header-anchor">#</a> 3、Window 的allowedLateness处理延迟太大的数据</h6> <p>基于 Event-Time 的窗口处理流式数据，虽然提供了 Watermark 机制，却只能在<strong>一定程度上解决了数据乱序的问题</strong>。但在某些情况下<strong>数据可能延时会非常严重</strong>，即使通过 Watermark 机制也无法等到数据全部进入窗口再进行处理。</p> <p>Flink 中<strong>默认会将这些迟到的数据做丢弃处理</strong>，但是有些时候用户希望即使数据延迟到达的情况下，也能够正常按照流程处 理并输出结果，此时就需要使用 <strong>Allowed Lateness 机制</strong>来对迟到的数据进行额外的处理。</p> <p>迟到数据的处理机制</p> <ul><li><p>1、直接丢弃</p></li> <li><p>2、指定允许再次迟到的时间</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">//例如</span>
assignTimestampsAndWatermarks<span class="token punctuation">(</span><span class="token keyword">new</span> EventTimeExtractor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
                <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>allowedLateness<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 允许事件再迟到2秒</span>
                <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> SumProcessWindowFunction<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//注意：</span>
<span class="token comment">//（1）. 当我们设置允许迟到2秒的事件，第一次 window 触发的条件是 watermark &gt;= window_end_time</span>
<span class="token comment">//（2）. 第二次(或者多次)触发的条件是watermark &lt; window_end_time + allowedLateness</span>

</code></pre></div></li> <li><p>3、收集迟到太多的数据</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">//例如</span>
assignTimestampsAndWatermarks<span class="token punctuation">(</span><span class="token keyword">new</span> EventTimeExtractor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
                <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>allowedLateness<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//允许事件再迟到2秒</span>
                <span class="token punctuation">.</span>sideOutputLateData<span class="token punctuation">(</span>outputTag<span class="token punctuation">)</span>   <span class="token comment">//收集迟到太多的数据</span>
                <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> SumProcessWindowFunction<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <p>代码演示:指定允许再次迟到的时间，并收集迟到太多的数据。</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>watermark</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>FastDateFormat
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>MapFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span>Tuple
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>AssignerWithPeriodicWatermarks
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> OutputTag<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>ProcessWindowFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span>Watermark
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span>TimeWindow
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token comment">//运行数据再次延延迟一段时间，并且对延迟太多的数据进行收集</span>
<span class="token keyword">object</span> AllowedLatenessTest <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">//todo:1.构建流式处理环境</span>
      <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
      environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>


     <span class="token comment">//todo:2.设置时间类型</span>
     environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

    <span class="token comment">//todo:3.获取数据源</span>
      <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:4. 数据处理</span>
      <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">//定义一个侧输出流的标签，用于收集迟到太多的数据</span>
      <span class="token keyword">val</span> lateTag<span class="token operator">=</span><span class="token keyword">new</span> OutputTag<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;late&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:5.  数据计算--添加水位线</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span>
            <span class="token keyword">new</span> AssignerWithPeriodicWatermarks<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>

              <span class="token comment">//定义延迟时间长度</span>
              <span class="token comment">//表示在5秒以内的数据延时有效，超过5秒的数据被认定为迟到事件</span>
              <span class="token keyword">val</span> maxOutOfOrderness <span class="token operator">=</span> <span class="token number">5000L</span>
              <span class="token comment">//历史最大事件时间</span>
              <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> _


              <span class="token comment">//周期性的生成水位线watermark</span>
              <span class="token keyword">override</span> <span class="token keyword">def</span> getCurrentWatermark<span class="token operator">:</span> Watermark <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token keyword">val</span> watermark <span class="token operator">=</span> <span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>currentMaxTimestamp <span class="token operator">-</span> maxOutOfOrderness<span class="token punctuation">)</span>
                watermark
              <span class="token punctuation">}</span>

              <span class="token comment">//抽取事件时间</span>
              <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token comment">//获取事件时间</span>
                <span class="token keyword">val</span> currentElementEventTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>_2

                <span class="token comment">//对比当前事件时间和历史最大事件时间, 将较大值重新赋值给currentMaxTimestamp</span>
                currentMaxTimestamp <span class="token operator">=</span> Math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>currentMaxTimestamp<span class="token punctuation">,</span> currentElementEventTime<span class="token punctuation">)</span>

                println<span class="token punctuation">(</span><span class="token string">&quot;接受到的事件：&quot;</span> <span class="token operator">+</span> element <span class="token operator">+</span> <span class="token string">&quot; |事件时间： &quot;</span> <span class="token operator">+</span> currentElementEventTime <span class="token punctuation">)</span>

                currentElementEventTime
              <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span>allowedLateness<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//运行数据再次延迟2s</span>
              <span class="token punctuation">.</span>sideOutputLateData<span class="token punctuation">(</span>lateTag<span class="token punctuation">)</span>     <span class="token comment">//收集延迟大多的数据</span>
              <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> ProcessWindowFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tuple<span class="token punctuation">,</span> TimeWindow<span class="token punctuation">]</span> <span class="token punctuation">{</span>
                        <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>key<span class="token operator">:</span> Tuple<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

                          <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> key<span class="token punctuation">.</span>getField<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

                          <span class="token comment">//窗口的开始时间</span>
                          <span class="token keyword">val</span> startTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart
                          <span class="token comment">//窗口的结束时间</span>
                          <span class="token keyword">val</span> startEnd<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd

                          <span class="token comment">//获取当前的 watermark</span>
                          <span class="token keyword">val</span> watermark<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentWatermark

                          <span class="token keyword">var</span> sum<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">0</span>
                          <span class="token keyword">val</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span>toList

                          <span class="token keyword">for</span> <span class="token punctuation">(</span>eachElement <span class="token keyword">&lt;-</span> toList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            sum <span class="token operator">+=</span> <span class="token number">1</span>
                          <span class="token punctuation">}</span>


                          println<span class="token punctuation">(</span><span class="token string">&quot;窗口的数据条数:&quot;</span> <span class="token operator">+</span> sum <span class="token operator">+</span>
                            <span class="token string">&quot; |窗口的第一条数据：&quot;</span> <span class="token operator">+</span> toList<span class="token punctuation">.</span>head <span class="token operator">+</span>
                            <span class="token string">&quot; |窗口的最后一条数据：&quot;</span> <span class="token operator">+</span> toList<span class="token punctuation">.</span>last <span class="token operator">+</span>
                            <span class="token string">&quot; |窗口的开始时间： &quot;</span> <span class="token operator">+</span> startTime <span class="token operator">+</span>
                            <span class="token string">&quot; |窗口的结束时间： &quot;</span> <span class="token operator">+</span> startEnd <span class="token operator">+</span>
                            <span class="token string">&quot; |当前的watermark:&quot;</span> <span class="token operator">+</span> watermark<span class="token punctuation">)</span>

                          out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> sum<span class="token punctuation">)</span><span class="token punctuation">)</span>

              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">//打印延迟太多的数据   侧输出流:主要用于保存延迟太长的数据</span>
    result<span class="token punctuation">.</span>getSideOutput<span class="token punctuation">(</span>lateTag<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token string">&quot;late&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">//打印</span>
    result<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span>

    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><p>发送数据</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756866000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756868000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756869000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756870000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756871000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756872000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756863000</span>
</code></pre></div><p>输出结果：</p> <div class="language-scala extra-class"><pre class="language-scala"><code>接受到的事件：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span><span class="token punctuation">)</span> <span class="token operator">|</span>事件时间： <span class="token number">1461756862000</span>
接受到的事件：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756866000</span><span class="token punctuation">)</span> <span class="token operator">|</span>事件时间： <span class="token number">1461756866000</span>
接受到的事件：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756868000</span><span class="token punctuation">)</span> <span class="token operator">|</span>事件时间： <span class="token number">1461756868000</span>
接受到的事件：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756869000</span><span class="token punctuation">)</span> <span class="token operator">|</span>事件时间： <span class="token number">1461756869000</span>
接受到的事件：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756870000</span><span class="token punctuation">)</span> <span class="token operator">|</span>事件时间： <span class="token number">1461756870000</span>
窗口的数据条数<span class="token operator">:</span><span class="token number">1</span> <span class="token operator">|</span>窗口的第一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的最后一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的开始时间： <span class="token number">1461756860000</span> <span class="token operator">|</span>窗口的结束时间： <span class="token number">1461756865000</span> <span class="token operator">|</span>当前的watermark<span class="token operator">:</span><span class="token number">1461756865000</span>
ok<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
接受到的事件：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span><span class="token punctuation">)</span> <span class="token operator">|</span>事件时间： <span class="token number">1461756862000</span>    <span class="token comment">//第二次触发同一个窗口</span>
窗口的数据条数<span class="token operator">:</span><span class="token number">2</span> <span class="token operator">|</span>窗口的第一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的最后一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的开始时间： <span class="token number">1461756860000</span> <span class="token operator">|</span>窗口的结束时间： <span class="token number">1461756865000</span> <span class="token operator">|</span>当前的watermark<span class="token operator">:</span><span class="token number">1461756865000</span>
ok<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
接受到的事件：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756871000</span><span class="token punctuation">)</span> <span class="token operator">|</span>事件时间： <span class="token number">1461756871000</span>
接受到的事件：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756872000</span><span class="token punctuation">)</span> <span class="token operator">|</span>事件时间： <span class="token number">1461756872000</span>
接受到的事件：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span><span class="token punctuation">)</span> <span class="token operator">|</span>事件时间： <span class="token number">1461756862000</span>
late<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span><span class="token punctuation">)</span>
接受到的事件：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756863000</span><span class="token punctuation">)</span> <span class="token operator">|</span>事件时间： <span class="token number">1461756863000</span>
late<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756863000</span><span class="token punctuation">)</span>

Process finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token operator">-</span><span class="token number">1</span>
<span class="token comment">//第二次触发（多次触发条件）：watermark &lt; window_end_time + allowedLateness</span>
</code></pre></div><h6 id="_4、多并行度下的watermark"><a href="#_4、多并行度下的watermark" class="header-anchor">#</a> 4、多并行度下的WaterMark</h6> <p><img src="/assets/img/1587869656089.4b467015.png" alt="1587869656089"></p> <p>本地测试的过程中，如果<strong>不设置并行度的话，默认读取本机CPU数量设置并行度</strong>，可以手动设置并行度environment.setParallelism(1)，每一个线程都会有一个watermark.</p> <p><strong>多并行度的情况下,一个window可能会接受到多个不同线程waterMark</strong>。watermark对齐会取所有channel最小的watermark，以最小的watermark为准。</p> <p>案例演示：以周期性WaterMark为例，修改并行度为2</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>watermark</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">TimeCharacteristic</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarks</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span><span class="token class-name">DataStream</span><span class="token punctuation">,</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span><span class="token class-name">ProcessWindowFunction</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span><span class="token class-name">Watermark</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span><span class="token class-name">TimeWindow</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span>

<span class="token comment">/**
  * 得到并打印每隔 5 秒钟统计前 5秒内的相同的 key 的所有的事件
  * 测试多并行度下的watermark
  */</span>
object <span class="token class-name">WaterMarkWindowWithMultipart</span> <span class="token punctuation">{</span>

  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>


    <span class="token comment">//todo:1.构建流式处理环境</span>
    val environment<span class="token operator">:</span> <span class="token class-name">StreamExecutionEnvironment</span> <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    
    <span class="token comment">//设置并行度为2</span>
    environment<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>


    <span class="token comment">//todo:2.设置时间类型</span>
    environment<span class="token punctuation">.</span><span class="token function">setStreamTimeCharacteristic</span><span class="token punctuation">(</span><span class="token class-name">TimeCharacteristic<span class="token punctuation">.</span>EventTime</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:3.获取数据源</span>
    val sourceStream<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:4. 数据处理</span>
    val mapStream<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:5. 添加水位线</span>
    mapStream<span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">AssignerWithPeriodicWatermarks</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>

        <span class="token comment">//定义延迟时间长度</span>
        <span class="token comment">//表示在5秒以内的数据延时有效，超过5秒的数据被认定为迟到事件</span>

        val maxOutOfOrderness<span class="token operator">=</span><span class="token number">5000L</span>
        <span class="token comment">//历史最大事件时间</span>
        <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span><span class="token class-name">Long</span><span class="token operator">=</span>_


        <span class="token comment">//周期性的生成水位线watermark</span>
        override def getCurrentWatermark<span class="token operator">:</span> <span class="token class-name">Watermark</span> <span class="token operator">=</span><span class="token punctuation">{</span>
         val  watermark <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Watermark</span><span class="token punctuation">(</span>currentMaxTimestamp <span class="token operator">-</span>maxOutOfOrderness<span class="token punctuation">)</span>
          watermark
        <span class="token punctuation">}</span>

        <span class="token comment">//抽取事件时间</span>
        override def <span class="token function">extractTimestamp</span><span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span><span class="token punctuation">{</span>
          <span class="token comment">//获取事件时间</span>
          val currentElementEventTime<span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>_2

          <span class="token comment">//对比当前事件时间和历史最大事件时间, 将较大值重新赋值给currentMaxTimestamp</span>
          currentMaxTimestamp<span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>currentMaxTimestamp<span class="token punctuation">,</span>currentElementEventTime<span class="token punctuation">)</span>

          val id<span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span>currentThread<span class="token punctuation">.</span>getId
          <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;当前的线程id:&quot;</span><span class="token operator">+</span>id<span class="token operator">+</span><span class="token string">&quot; |接受到的事件：&quot;</span><span class="token operator">+</span>element<span class="token operator">+</span><span class="token string">&quot; |事件时间： &quot;</span><span class="token operator">+</span>currentElementEventTime<span class="token operator">+</span><span class="token string">&quot; |当前值的watermark:&quot;</span><span class="token operator">+</span><span class="token function">getCurrentWatermark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

          currentElementEventTime
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProcessWindowFunction</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Tuple</span><span class="token punctuation">,</span><span class="token class-name">TimeWindow</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
        override def <span class="token function">process</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token class-name">Tuple</span><span class="token punctuation">,</span> context<span class="token operator">:</span> <span class="token class-name">Context</span><span class="token punctuation">,</span> elements<span class="token operator">:</span> <span class="token class-name">Iterable</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> <span class="token class-name">Collector</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

          val value<span class="token operator">:</span> <span class="token class-name">String</span> <span class="token operator">=</span> key<span class="token punctuation">.</span>getField<span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

          <span class="token comment">//窗口的开始时间</span>
          val startTime<span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getStart
          <span class="token comment">//窗口的结束时间</span>
          val startEnd<span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>window<span class="token punctuation">.</span>getEnd

          <span class="token comment">//获取当前的 watermark</span>
          val watermark<span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>currentWatermark

          <span class="token keyword">var</span> sum<span class="token operator">:</span><span class="token class-name">Long</span> <span class="token operator">=</span> <span class="token number">0</span>
          val toList<span class="token operator">:</span> <span class="token class-name">List</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> elements<span class="token punctuation">.</span>toList
          <span class="token keyword">for</span><span class="token punctuation">(</span>eachElement <span class="token operator">&lt;</span><span class="token operator">-</span>  toList<span class="token punctuation">)</span><span class="token punctuation">{</span>
            sum <span class="token operator">+=</span><span class="token number">1</span>
          <span class="token punctuation">}</span>


          <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;窗口的数据条数:&quot;</span><span class="token operator">+</span>sum<span class="token operator">+</span>
            <span class="token string">&quot; |窗口的第一条数据：&quot;</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>head<span class="token operator">+</span>
            <span class="token string">&quot; |窗口的最后一条数据：&quot;</span><span class="token operator">+</span>toList<span class="token punctuation">.</span>last<span class="token operator">+</span>
            <span class="token string">&quot; |窗口的开始时间： &quot;</span><span class="token operator">+</span>  startTime <span class="token operator">+</span>
            <span class="token string">&quot; |窗口的结束时间： &quot;</span><span class="token operator">+</span> startEnd<span class="token operator">+</span>
            <span class="token string">&quot; |当前的watermark:&quot;</span><span class="token operator">+</span> watermark<span class="token punctuation">)</span>

          out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


    environment<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>输入数据</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756864000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756866000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756870000</span>
<span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756871000</span>
</code></pre></div><p>输出结果</p> <div class="language-java extra-class"><pre class="language-java"><code>当前的线程id<span class="token operator">:</span><span class="token number">65</span> <span class="token operator">|</span>接受到的事件：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span><span class="token punctuation">)</span> <span class="token operator">|</span>事件时间： <span class="token number">1461756862000</span> <span class="token operator">|</span>当前值的watermark<span class="token operator">:</span><span class="token number">1461756857000</span>
当前的线程id<span class="token operator">:</span><span class="token number">64</span> <span class="token operator">|</span>接受到的事件：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756864000</span><span class="token punctuation">)</span> <span class="token operator">|</span>事件时间： <span class="token number">1461756864000</span> <span class="token operator">|</span>当前值的watermark<span class="token operator">:</span><span class="token number">1461756859000</span>
当前的线程id<span class="token operator">:</span><span class="token number">65</span> <span class="token operator">|</span>接受到的事件：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756866000</span><span class="token punctuation">)</span> <span class="token operator">|</span>事件时间： <span class="token number">1461756866000</span> <span class="token operator">|</span>当前值的watermark<span class="token operator">:</span><span class="token number">1461756861000</span>
当前的线程id<span class="token operator">:</span><span class="token number">64</span> <span class="token operator">|</span>接受到的事件：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756870000</span><span class="token punctuation">)</span> <span class="token operator">|</span>事件时间： <span class="token number">1461756870000</span> <span class="token operator">|</span>当前值的watermark<span class="token operator">:</span><span class="token number">1461756865000</span>
当前的线程id<span class="token operator">:</span><span class="token number">65</span> <span class="token operator">|</span>接受到的事件：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756871000</span><span class="token punctuation">)</span> <span class="token operator">|</span>事件时间： <span class="token number">1461756871000</span> <span class="token operator">|</span>当前值的watermark<span class="token operator">:</span><span class="token number">1461756866000</span>
窗口的数据条数<span class="token operator">:</span><span class="token number">2</span> <span class="token operator">|</span>窗口的第一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756862000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的最后一条数据：<span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">1461756864000</span><span class="token punctuation">)</span> <span class="token operator">|</span>窗口的开始时间： <span class="token number">1461756860000</span> <span class="token operator">|</span>窗口的结束时间： <span class="token number">1461756865000</span> <span class="token operator">|</span>当前的watermark<span class="token operator">:</span><span class="token number">1461756865000</span>
<span class="token number">2</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">000001</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><p>结果分析</p> <p><img src="/assets/img/Flink的多并行度watermark分析.70b38311.png" alt="Flink的多并行度watermark分析"></p> <h2 id="flink的table和sql"><a href="#flink的table和sql" class="header-anchor">#</a> Flink的Table和SQL</h2> <h5 id="_3-1-table与sql基本介绍"><a href="#_3-1-table与sql基本介绍" class="header-anchor">#</a> 3.1 Table与SQL基本介绍</h5> <p>在Spark中有DataFrame这样的关系型编程接口，因其强大且灵活的表达能力，能够让用户通过非常丰富的接口对数据进行处理，有效降低了用户的使用成本。</p> <p><strong>Flink也提供了关系型编程接口 Table API 以及基于Table API 的 SQL API</strong>，让用户能够通过使用结构化编程接口高效地构建Flink应用。同时Table API 以及 SQL 能够统一处理批量和实时计算业务， 无须切换修改任何应用代码就能够基于同一套 API 编写流式应用和批量应用，从而<strong>达到真正意义的批流统一</strong>。</p> <ul><li>==Apache Flink 具有两个关系型API：Table API 和SQL，用于统一流和批处理==</li> <li>Table API 是用于 Scala 和 Java 语言的查询API，允许以非常直观的方式组合关系运算符的查询，例如 select，filter 和 join。Flink SQL 的支持是基于实现了SQL标准的 Apache Calcite。无论输入是批输入（DataSet）还是流输入（DataStream），任一接口中指定的查询都具有相同的语义并指定相同的结果。</li> <li>Table API和SQL接口彼此集成，Flink的DataStream和DataSet API亦是如此。我们可以轻松地在基于API构建的所有API和库之间切换。</li> <li>注意，到目前最新版本为止，==Table API和SQL还有很多功能正在开发中。 并非[Table API，SQL]和[stream，batch]输入的每种组合都支持所有操作==</li></ul> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAvEAAAEoCAYAAADR4a6bAAAXzUlEQVR4nO3df2zX9b3o8Re7TVNMYZXeyspwocJwxN6xidQoCezGZHQONafHLSc3avEM4fxhMWeX440xk4HhkOs4JqP+Y/VEy+5JlkWbkLGtnhuTAyfVS7VmuC5II9ZMRtWm0NN20nVM7h+cz9d++/PbCrI3PB6JiXz7/Xy/n37/+Hyfn/fn/Xl3Tn19/bnf/OY3AQAA/OX78pe/HEXvv/9+RETMmTMnrrpq3iXeJQAAYCIffTQY586di/7+/ijKHvz85/9rPPFE66XcLwAAYBIPP1wb/f29ERHxuUu8LwAAwAyJeAAASIyIBwCAxIh4AABIjIgHAIDEiHgAAEiMiAcAgMSIeAAASIyIBwCAxIh4AABIjIgHAIDEiHgAAEiMiAcAgMSIeAAASIyIBwCAxIh4AABIjIgHAIDEiHgAAEiMiAcAgMSIeAAASIyIBwCAxIh4AABIjIgHAIDEiHgAAEiMiAcAgMSIeAAASIyIBwCAxIh4AABIjIgHAIDEiHgAAEiMiAcAgMSIeAAASIyIBwCAxIh4AABIjIgHAIDEiHgAAEiMiAcAgMSIeAAASIyIBwCAxIh4AABIjIgHAIDEiHgAAEiMiAcAgMSIeAAASIyIBwCAxIh4AABIjIgHAIDEiHgAAEiMiAcAgMSIeAAASIyIBwCAxIh4AABIjIgHAIDEiHgAAEiMiAcAgMSIeAAASIyIBwCAxIh4AABIjIgHAIDEiHgAAEiMiAcAgMSIeAAASIyIBwCAxIh4AABIjIgHAIDEiHiAArW0NMbu3fUxNNQ/5fN6errjkUc2RFvb/s9ozwC40hRd6h0AuFhGRoZj377Ho729ddLn1NZujLq6hs9wr2avrW1/NDfvjG3bmmL58lXjft7T0x179zZEX19P3uM1NbVx330/iOLikrznbdjwQKxZc1fB75upr3+soO3G6urqiD17Nuf+XVVVHQ0NP47S0rK85w0N9Udj40PR3d2Ze6y8vDK2bm2MysqqvOfO9HcBuFyIeOCyVVxcEps27YpNm3ZFxPmIfO657RPG4F+6oaH+OHSoJSIiDh1qiSVLbshF+VijIzsL4n37Hs8L+UK1te2PAweeiR07XojKyqpciFdULJ7wRGIyLS2N8dprL+VeJ+J8gB861BK33/63ee/X3Lwz6usfi0ceac493tXVEdu33z3rEwiAy43pNAAJOHnyeHR3d0Z19a1x/PiRcaPtkyktLYu//uut0d7eGu+++9sZv+8HH/wuli5dGeXllRERsWjR0qiqqo7e3hMFv8bQUH8cO/Z6bNjwQN7JU2VlVV7Ad3V15AJ+bKgvX74qtm1riubmndHV1THj3wPgciPiAf5TW9v+2Lx5Ve6/yea0Dw31x+7d9bnnPfvsozEyMjzt63d1deS9fktLY8H71tn5StTU1MY99zwa8+eXxzvvvFnwtvPmLchF+Gz09p7I/X7ZyURFxeKI+GT+/1RhPTh4OgYG+qZ8j5GR4Th0qCVqampj9er1Ez5nyZIboqamNg4daino8wa4nIl4gIhchDY1dURTU8eko77d3Z3x3HPbo6Hhx9HU1BE7drwQx48fiQMHnpn29ffs2RzbtjVFU1NHPPnky3Hs2OsFhXxPT3e89tpLsWJFTSxY8IW4/vqb4tChlmlvsM0MDp6KiPMxP1Pf/Oa9ERHR2PhQPPvso7Fnz+aor39s3FSaqUbm5827OubPL48DB56Jnp7uCZ8zMjIcvb0nYsWKmkmn/BQXl8SKFTV5JxUAVyoRDxDnp2uMnsKRjfp2dr6S97zy8srYuPGHuZsxKyur4v77d8Rrr700aaAODfXHiy/ujdrajbn4LS0ti7Vr6+LYsdenjfF33nkz5s8vj5Ur10VExC23bIiBgb44efL4tL9XT093PPfc9li9ev2s7gPIRtG7uzujvb01qqqqc/sxWjYyP5HS0rLYuPGHERGxffvdE165yN5nqtfJ3mdgoC8GB0/P+HcBuJyIeIAxhob645/+aUu0t7fGqVPv5wXn/PnlMW/e1XnPz0a4sxHvsUbPZx+tkCAdGRmOo0fbY+3autyJQ3l5ZSxdunLcCUamuXlnbsrO9u13x4YND8xqBZ7sZtINGx6IpqaOeOqptqioWBy7dt2TO2HJTjAWLVo65WtVVlbF7t0HorZ2Y7S3t8aDD66Z0XQiAPJZnQYg8pdRrKqqji1b/veMI7O398SUK7aMXl5xtMHBU5OOkvf19cTx40eivb01b5nHiPMxf8stG8ZteyFWcBl99SB7rWy1n5aWxti7tyG2bHli3AnGdOrqGqKuriFaWhqjtfX5OHXq/bjvvh/kptxM9xn29p6Y8EQK4Eoj4oErXk9Pdxw48Exe/M5mzvVUU0EmW+d8Oq++eiCWLl0ZO3a8kDdXPFs68p133rwoy2Vm01vGXj2IiNiw4YE4der9+Md/vDeqqqrjb/7mH2b8+nV1DbFw4ZfiwIFnoq+vJ8rLK6OiYnEcPdoeq1evn3BefHZVoqJi8YyXygS43JhOA1zxBgdPRV9fT16EZzdajjXR9JfpppQsWrR0xivKRHyyNONEN3uWlpbN+AbXmRg9Mj5WcXFJrF1bFxExo1H4sUZ/3tlrTrUU5rvv/jba21tj7do6EQ9c8UQ8cMXL1j7P5piPjAzHT3/6o7y/GJrp6+uJX/zi2dxIfba2+VQxm93EOna1m66ujimn7Jw8eTwGBvriuuu+OuHPq6tvje7uzoJucJ2p7CRhohV6WloaY8+ezVFbu7GgddvP/1XVrXknG9mSkqPXoF++fFXU1z8We/ZsHre8Z1vb/klXxgG4EplOA1zxsj+ItGfP5mhtfT4iIrZu3Tvhc6uqquPrX//v8eCDa3KPFTIHPfv56HnxtbUbJ73hdKLIHWv0ycfFCNu6uoaorr513Fz+2tqN0dR0PtxH/3yy36eysiq+852/j1277sn7I1UTfW5r1twVK1eui8bGh8bdAxAx+ZSl5uad456/bVuT4AcuW3PWr19/rre3N8rKKuKJJ1ov9f4AwDgjI8Oxb9/j0d7eekFu3AVI0cMP10Z/f29UVFSYTgPAX77i4pK4774fRE1NbTQ374zdu+svyr0AAKkwnQaAJGRLXG7atOtS7wrAJWckHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxc9auXXtuaGgo5syZE1ddNe9S7w8AADCBjz4ajHPnzkVpaWkU/fnPf46IiHPnzsUf/jBwiXcNAACYyp/+9KcoKioqyj0w53P/5RLuDgAXyrmP/5z7f8d2gMtDdmwvLi6OopKSkhgcHIyryiri3idaL/GuAXAhNP3d6jj38ceO7QCXkZ88XBsf9fdGSUmJG1sBACA1Ih4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAEiPiAQAgMSIeAAASI+IBACAxIh4AABIj4gEAIDEiHgAAElN0qXeAS++ttv1xsHnnuMeX1dTGuvt+EEXFJbN+3aOHWuJbDT+OktKyGW9/uKUxft36fO7fX6vdGDfXNeT+fbqnO361tyG+cf+OWLR81az28S/N8FB//KrxoZhfsXjSz37s55K5Y1tT3udwuKUxTh57fdafP3Dlyo6vg309eY/PK6+Mb21tjKsrq2b1up/2e+FkV0f8fM/m3L+vqaqe1WsdbmmMoVPvz+g7LnvvdfWPxVfW3DXu59nx+8PuzrzHx+5j9rxF19+U950GMyXiiYiJD8yHWxrjnx9cM+kBazr/8cHvZrUvo0P2e0+15Q6wb7Xtj5NdHblQPTN4atwXTOrePXIwPuzujA+7O2PF2rpJT07Gfim81bY/fr5n87iQB/g0xh7/T3Z1xM+23z3rQZ7Zfi9EnP9OOv7aS/HdHS/kvqtO93TH0UMt8fXb/7bg1zk7MhxDp96f0XufHRmOo4daIiLi6KGWWLJy3aQnDqMHnM6ODMfBfY/HrxofMqDCBWc6DZO6ua4hvrvjhXjjwDNxsqvjM3vfUyePx5mBvrjx25vyviC+suauyzpQz44Mx++PtkfFkhtiXnllvNf5SsHbLlu9PpbV1MbRQy1xdmT4Iu4lcCVbtHxVfO+ptoiI6DjwzGf2vsND/XHy2Otx44YH8gabrq6smlHAz9ZgX098cPxIXFt9a3zY3RmnTh4vaLui4pK48dub4sxAX7x75OBF3kuuNEbimdLVlVWxdPX6OPzi3gkvB2aXDUePDI+9DNv8/dvyfj7VthERA70nptynbGTj7fbWiIjcpdU7tjXFNUtuiIP7Ho+IiIXX/bdo++mP8kaMxu7bRKNJ0z0nu6R6+9a90fX/fpnbj2z0ZfT0pJlc6s2+JL5x/44Y6D0RRw+1xPBQf0HbFhWXROmCL8x4dAlgpoqKS2LF2rr4+Z7NcW31reOm8Y2e7pddHZzue2GqbSMizgyejjMDfQXt31TH8LHTcd5uby3oqsIH77wZc+eXx9p7Ho3DLY3xXucrBQ8qzZ13dcydX17Qc2EmjMQzrWurb40zA31xZvB0RJyP6CP/+pP4VsOPY0tTR3zvqbaYX7E42n76ozg7MhxXV1bF/9h9IL5WuzGuqaqO+idfjr96pDlKSsum3TYiYn7F4hjs64k3fvHshKPKRcUlcdumXXHHtqaIOH+g39LUkXdAfbu9Nf7Q3xtbmjritk278gL+xg0P5N47IuLgvsdz7zM81B9drx6I7+54IbY0dUT9ky/HQO+JCUec/v1fdseN394UW5o6Yl39Y/Hr1ufj6c2r4j8++N2kv9tUul49EHPnl8eCRUtj4XVfndHITXZ5uHTBF2Z9DwNAoRYsWhrXVFXnDbq81bY/rq2+NbY0deSOi//23PY43dM95ffCdNtGfBLCbxx4JvfYRKY7zmdXEpbV1Maymtr43lNtue+IyQwP9cfRQy2x6PqbonTBF+KLK2ri+GsvTbkfo2UnIPMrFhf0fCiUiGdac+ctiIjzc9Ajzkf0zXUNuYNvNirzwfEj085RL2TbRctXxbr6x+Lt9tb45wfXxFtt+2e8z9dUVcfKb96b+/fZkeF44xfPxsKlK2PZ6vWTvndJaVncXNeQO6CXlJbFirV1cfLY6zE81J/3HqMv6y5ZuS6uqarOe9+i4pL44oqagj6X7FLxirV1UVJalrsC8vuj7QWdAHQceCY+OH4klt+yocBPCGD2iopLYn7F4rw57mOnPC5ZuS7mzi+PD955c9rXm27bktKy+MbGH0ZExM+23x0vP/vouGNjocf5mcqmeGbH15n8XsND/fFvz/8wFi5dGdcsuWFW7w+TEfF8atlNlYN9PbnQ/7TbfmXNXVH/5MtxTVV1HGzeGU9vXjWjefnzKxbnjaxkU1W+uKIm7/GxJyhjHW5pjIPNO/OuRIx+j0z2hbbo+pvypr8UOvKSza9csnJd7rFrq2+d9Ivnw+7OaP7+bfH05lXnP5tjr0fdo/9n1itGAFxIp3u6o2XXPfFhd+eMb2adbNvRo/nZIM/hlsbcz2d7nJ/Oe52vxNLV63PH15LSslh0/U2TDrJkV2Wf3rwqmr9/Wyy6/qZpR/thNsyJZ1rZgS87EI6d076u/rG4Y1tT3jzDycxk25LSsvirR5pz20y1tFehDjbvnHA5zYHeExPO27xjW1N8fuGX4o2LfAPXe52v5MJ8rK5XD4xbhmy2y6oBXAhnR4ZjoPdEfHFFTe6x0XPal9XUxp3/8Gz836f/V0GvN5Ntb65riJvrGnLbZEtFZqY7zs9EdpX0w+7OCZf2nWgVsbHLIcPFIuKZ1nudr8TCpStjXnllREQc+defRERE/ZMv5yKy0FHy2WxbUloWd/zPp+Pgvsfj90fbY9nq9bMe0ZhqCcbRl2K/u+OF3HtMd6Ptp3W6pzuOv/bShPuWralc6A2uAJ+FbIrJwuu+GhHnj+O/bn0+7zg2dgriZGa77c11DblBltFXLC/kUrvZfUmjv7MiPllgYSY3uMKFZjoNU8oOrivW1kVRcUnuBsqx01UKCd1Ps222+spszSuvjIVLV065bGM2sjT25tBPs65xIbJVDxYsWjruZzO9wRXgYhse6o/DL+7Nm2Iy0Hsi5pVX5q7YRhS+osyn2Xb0lMVCjvMzkS37O3aaZMQn9zzN5AZXuNBEPJM63NI47g8ITXSz5smujgkvXX5+4Zfy5pIXuu1bbfvz5jlGfDJaPXqu49x5C2JeeWXBJwEr1tbFr1ufz7tR9nRPd/z7v+yOsyPDuXmOo29ifatt/4SXUC+Uqb4kIj75Uir0BleAi+lkV0dunvfoKSPZiHx2s2d2Q+fYe3rGfi8Uuu3pnu745d6teSP02R9gyq4UF3Kcj/hkUGig98SUx9XRa8NPZOx+w2fNdBoi4vzB6mfb78577Gu1G2NL0/ipLsv+c9WU7PnLamrj9q1745d7t076vGwOdyHbfmXNXfFW2/54evMnlygn+ouyV1dWxY0bHsjNf8zWiZ/MouWrcvPvsxOHsesDr/zmvXHy2Ou5uelfq90Y6+ofu2hz4j9897fxdntrbrnMsbITn+xysRtXgc/S2Pnl2fKQYwcdxh6P55VXxjfu3xGHX9yb97yJvhcK2fbqyqq45Tt/Hy277smL+7H3SRVynI/IP9ZPtk786GV/JzJ6kCVbDQc+S3PWr19/rre3N64qq4h7n2i91PsDwAXQ9Her49zHHzu2A1xGfvJwbXzU3xsVFRWm0wAAQGpEPAAAJEbEAwBAYkQ8AAAkRsQDAEBiRDwAACRGxAMAQGJEPAAAJEbEAwBAYkQ8AAAkRsQDAEBiRDwAACRGxAMAQGJEPAAAJEbEAwBAYkQ8AAAkRsQDAEBiRDwAACRGxAMAQGJEPAAAJEbEAwBAYkQ8AAAkRsQDAEBiRDwAACRGxAMAQGJEPAAAJEbEAwBAYkQ8AAAkRsQDAEBiRDwAACRGxAMAQGJEPAAAJEbEAwBAYkQ8AAAkRsQDAEBiRDwAACRGxAMAQGJEPAAAJEbEAwBAYkQ8AAAkRsQDAEBiRDwAACRGxAMAQGJEPAAAJEbEAwBAYkQ8AAAkRsQDAEBiRDwAACRGxAMAQGJEPAAAJEbEAwBAYkQ8AAAkRsQDAEBiRDwAACRGxAMAQGJEPAAAJEbEAwBAYkQ8AAAkRsQDAEBiRDwAACRGxAMAQGJEPAAAJEbEAwBAYkQ8AAAkZs769evP9fb2xpzPfS7mzi+/1PsDwAXwUX9vRIRjO8Bl5MxAX5z7+OOoqKiIooULF0Zvb2+c+/jj3EEfgMuDYzvA5aesrCyK7rzzzvjjH/8Y/f39l3p/ALhAzpw5E2fPno2ioqKYO3fupd4dAC6QhQsXxp133hn/H9HtLFdtv5xhAAAAAElFTkSuQmCC" alt="1587954297942"></p> <h5 id="_3-2-为什么需要sql"><a href="#_3-2-为什么需要sql" class="header-anchor">#</a> 3.2 为什么需要SQL</h5> <ul><li><p>Table API 是一种关系型API，类 SQL 的API，用户可以像操作表一样地操作数据， 非常的直观和方便。</p></li> <li><p>SQL 作为一个&quot;人所皆知&quot;的语言，如果一个引擎提供 SQL，它将很容易被人们接受。这已经是业界很常见的现象了。</p></li> <li><p>Table &amp; SQL API 还有另一个职责，就是<strong>流处理和批处理统一的API层</strong>。</p></li> <li><p>无论那套api，底层的引擎core都是Runtime流处理引擎。</p> <p><img src="/assets/img/1587955069138.dbc9bf94.png" alt="1587955069138"></p></li></ul> <h5 id="_3-3-开发环境构建"><a href="#_3-3-开发环境构建" class="header-anchor">#</a> 3.3 开发环境构建</h5> <ul><li><p>在 Flink 1.9 中，Table 模块迎来了核心架构的升级，<strong>引入了阿里巴巴 Blink 团队贡献的诸多功能</strong>，取名叫： Blink Planner。</p></li> <li><p>在使用 Table API 和 SQL 开发 Flink 应用之前，通过添加 Maven 的依赖配置到项目中，在本地工程中引入相应的依赖库，库中包含了 Table API 和 SQL 接口。</p></li> <li><p>添加pom依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-table-planner_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-table-api-scala-bridge_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li></ul> <h5 id="_3-4-tableenvironment构建"><a href="#_3-4-tableenvironment构建" class="header-anchor">#</a> 3.4 TableEnvironment构建</h5> <p>和 DataStream API 一样，<strong>Table API 和 SQL 中具有相同的基本编程模型</strong>。首先需要构建对应的 TableEnviroment 创建关系型编程环境，才能够在程序中使用 Table API 和 SQL来编写应用程序，另外 <strong>Table API 和 SQL 接口可以在应用中同时使用</strong>，Flink SQL 基于 Apache Calcite 框架实现了 SQL 标准协议，是构建在 Table API 之上的更高级接口。</p> <p>首先需要在环境中创建 TableEnvironment 对象，TableEnvironment 中提供了注册内部表、执行 Flink SQL 语句、注册自定义函数等功能。根据应用类型的不同，TableEnvironment 创建方式也有所不同，但是<strong>都是通过调用 create()方法创建</strong>。</p> <p>方式1、流计算环境下创建 TableEnviroment</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">//初始化Flink的Streaming（流计算）上下文执行环境 </span>
<span class="token keyword">val</span> streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment 
<span class="token comment">//初始化Table API的上下文环境 </span>
<span class="token keyword">val</span> tableEvn <span class="token operator">=</span>StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">)</span>
</code></pre></div><p>方式2、在 Flink1.9 之后由于引入了 Blink Planner</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> bsSettings <span class="token operator">=</span> EnvironmentSettings<span class="token punctuation">.</span>newInstance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>useOldPlanner<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>inStreamingMode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token keyword">val</span> bsTableEnv <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">,</span> bsSettings<span class="token punctuation">)</span>
</code></pre></div><p>注意</p> <ul><li>Flink 社区完整保留原有 Flink Planner (Old Planner)，同时又引入了新的Blink Planner，用户可以自行选择使用 Old Planner 还是 Blink Planner。官方推荐暂时使用 Old Planner。</li></ul> <h5 id="_3-5-table-api"><a href="#_3-5-table-api" class="header-anchor">#</a> 3.5 Table API</h5> <p>在 Flink 中创建一张表有两种方法：</p> <ul><li>（1）从一个文件中导入表结构（Structure）（常用于批计算）（静态）</li> <li>（2）从 DataStream 或者 DataSet 转换成 Table （动态）</li></ul> <h6 id="_3-5-1-创建-table"><a href="#_3-5-1-创建-table" class="header-anchor">#</a> 3.5.1 创建 Table</h6> <p>Table API 中已经提供了 TableSource 从外部系统获取数据，例如常见的数据库、文件系统和 Kafka 消息队列等外部系统。</p> <p><strong>1、从文件中创建 Table（静态表）</strong></p> <p>需求：读取csv文件，文件内容参见课件当中的flinksql.csv文件，查询年龄大于18岁的人，并将结果写入到csv文件里面去，这里涉及到flink的connect的各种与其他外部系统的连接，参见https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/table/connect.html</p> <p>代码开发</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>table</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>typeinfo<span class="token punctuation">.</span></span>TypeInformation
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>core<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span>FileSystem<span class="token punctuation">.</span>WriteMode
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Table<span class="token punctuation">,</span> Types<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamTableEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>sinks<span class="token punctuation">.</span></span>CsvTableSink
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>sources<span class="token punctuation">.</span></span>CsvTableSource
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
<span class="token comment">/**
  * flink table加载csv文件
  */</span>
<span class="token keyword">object</span> TableCsvSource <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
     <span class="token comment">//todo:1、构建流处理环境</span>
      <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token comment">//todo:2、构建TableEnvironment</span>
    <span class="token keyword">val</span> tableEnvironment<span class="token operator">:</span> StreamTableEnvironment <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>environment<span class="token punctuation">)</span>


    <span class="token comment">//todo:3、构建csv数据源</span>
    <span class="token keyword">val</span> csvSource <span class="token operator">=</span> CsvTableSource<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>path<span class="token punctuation">(</span><span class="token string">&quot;E:\\flinksql.csv&quot;</span><span class="token punctuation">)</span>
                                   <span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>INT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                   <span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>STRING<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                   <span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>INT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                   <span class="token punctuation">.</span>fieldDelimiter<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span> <span class="token comment">//字段的分隔符</span>
                                   <span class="token punctuation">.</span>ignoreParseErrors<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//忽略解析错误</span>
                                   <span class="token punctuation">.</span>ignoreFirstLine<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//忽略第一行</span>
                                   <span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:4、注册表</span>
    tableEnvironment<span class="token punctuation">.</span>registerTableSource<span class="token punctuation">(</span><span class="token string">&quot;myUser&quot;</span><span class="token punctuation">,</span> csvSource<span class="token punctuation">)</span>

    <span class="token comment">//todo: 5、查询结果</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> Table <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>scan<span class="token punctuation">(</span><span class="token string">&quot;myUser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span><span class="token string">&quot;age&gt;25&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">&quot;id,name,age&quot;</span><span class="token punctuation">)</span>
    result<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//todo: 6、构建Sink，第3个参数为文件个数numFiles</span>
    <span class="token keyword">val</span> tableSink <span class="token operator">=</span> <span class="token keyword">new</span> CsvTableSink<span class="token punctuation">(</span><span class="token string">&quot;./out/tableSink.txt&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\t&quot;</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>WriteMode<span class="token punctuation">.</span>OVERWRITE<span class="token punctuation">)</span>

    <span class="token comment">//todo:7、注册sink,参数解释： (name,字段name,字段type, tablesink)</span>
    tableEnvironment<span class="token punctuation">.</span>registerTableSink<span class="token punctuation">(</span><span class="token string">&quot;csvOutputTable&quot;</span><span class="token punctuation">,</span>
                                        Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;f1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;f2&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;f3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        Array<span class="token punctuation">[</span>TypeInformation<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span>INT<span class="token punctuation">,</span>Types<span class="token punctuation">.</span>STRING<span class="token punctuation">,</span>Types<span class="token punctuation">.</span>INT<span class="token punctuation">)</span> <span class="token punctuation">,</span>
                                        tableSink<span class="token punctuation">)</span>

    <span class="token comment">//todo:8、写数据到sink</span>
    result<span class="token punctuation">.</span>insertInto<span class="token punctuation">(</span><span class="token string">&quot;csvOutputTable&quot;</span><span class="token punctuation">)</span>

    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;TableCsvSource&quot;</span><span class="token punctuation">)</span>   <span class="token comment">//TableCsvSource是object的名称</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><p>输出结果：</p> <div class="language- extra-class"><pre class="language-text"><code>root
 |-- id: INT
 |-- name: STRING
 |-- age: INT
</code></pre></div><p>查看sink产生的文件：</p> <p><img src="/assets/img/image-20200509161734040.ea45423c.png" alt="image-20200509161734040"></p> <p><strong>2、从DataStream中创建 Table（动态表）</strong></p> <p>需求：使用TableApi完成基于流数据的处理</p> <p>代码开发</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>table</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Table<span class="token punctuation">,</span> Types<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamTableEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>Row


<span class="token comment">/**
  * 使用TableApi完成基于流数据的处理
  */</span>
<span class="token keyword">object</span> TableFromDataStream <span class="token punctuation">{</span>

  <span class="token comment">//todo:定义样例类</span>
  <span class="token keyword">case</span> <span class="token keyword">class</span> User<span class="token punctuation">(</span>id<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>name<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span>


  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

     <span class="token comment">//todo:1、构建流处理环境</span>
        <span class="token keyword">val</span> streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    streamEnv<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:2、构建TableEnvironment</span>
        <span class="token keyword">val</span> tableEnvironment<span class="token operator">:</span> StreamTableEnvironment <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">)</span>
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">/**
      * 101,zhangsan,18
      * 102,lisi,28
      * 103,wangwu,25
      * 104,zhaoliu,30
      */</span>
     <span class="token comment">//todo:3、接受socket数据</span>
        <span class="token keyword">val</span> socketStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:4、对数据进行处理</span>
       <span class="token keyword">val</span> userStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>User<span class="token punctuation">]</span> <span class="token operator">=</span> socketStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>User<span class="token punctuation">(</span>x<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span>x<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:5、将流注册成一张表</span>
      tableEnvironment<span class="token punctuation">.</span>registerDataStream<span class="token punctuation">(</span><span class="token string">&quot;userTable&quot;</span><span class="token punctuation">,</span>userStream<span class="token punctuation">)</span>

    <span class="token comment">//todo:6、使用table 的api查询年龄大于20岁的人</span>
      <span class="token keyword">val</span> result<span class="token operator">:</span>Table <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>scan<span class="token punctuation">(</span><span class="token string">&quot;userTable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span><span class="token string">&quot;age &gt;20&quot;</span><span class="token punctuation">)</span>


    <span class="token comment">//todo：7、将table转化成流</span>
     tableEnvironment<span class="token punctuation">.</span>toAppendStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token comment">//todo:8、启动</span>
     tableEnvironment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;TableFromDataStream&quot;</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><p>发送数据</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">nc</span> -lk <span class="token number">9999</span>


<span class="token number">101</span>,zhangsan,18
<span class="token number">102</span>,lisi,28
<span class="token number">103</span>,wangwu,25
<span class="token number">104</span>,zhaoliu,30
</code></pre></div><p>DataStream转换成Table的逻辑：</p> <ul><li><p>构建StreamExecutionEnvironment和StreamTableEnvironment对象</p> <ul><li>StreamTableEnvironment.fromDataStream(dataStream: DataStream)</li> <li>StreamTableEnvironment.registerDataStream(dataStream: DataStream)</li></ul></li> <li><p>更多的table API操作详细见官网</p> <ul><li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.10/dev/table/tableApi.html" target="_blank" rel="noopener noreferrer">https://ci.apache.org/projects/flink/flink-docs-release-1.10/dev/table/tableApi.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p><img src="/assets/img/1588043744183.44224406.png" alt="1588043744183"></p></li></ul> <h6 id="_3-5-2-table中的window"><a href="#_3-5-2-table中的window" class="header-anchor">#</a> 3.5.2   Table中的window</h6> <p>Flink 支持 ProcessTime、EventTime 和 IngestionTime 三种时间概念，针对每种时间概念，Flink Table API 中使用 Schema 中单独的字段来表示时间属性，当时间字段被指定后，就可以在基于时间的操作算子中使用相应的时间属性。</p> <p>在 <strong>Table API 中通过使用.rowtime 来定义 EventTime 字段</strong>，在 ProcessTime 时间字段名后使用.proctime 后缀来指定 ProcessTime 时间属性</p> <p>需求：统计最近 5 秒钟，每个单词出现的次数</p> <p>代码开发</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>table</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>AssignerWithPeriodicWatermarks
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span>Watermark
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token punctuation">{</span>GroupWindowedTable<span class="token punctuation">,</span> Table<span class="token punctuation">,</span> Tumble<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamTableEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>Row

<span class="token comment">/**
  * 基于table的window窗口操作处理延迟数据
  */</span>
<span class="token keyword">object</span> TableWindowWaterMark <span class="token punctuation">{</span>

  <span class="token comment">//定义样例类</span>
  <span class="token keyword">case</span> <span class="token keyword">class</span> Message<span class="token punctuation">(</span>word<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>createTime<span class="token operator">:</span><span class="token builtin">Long</span><span class="token punctuation">)</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//todo:1、构建流处理环境</span>
     <span class="token keyword">val</span> streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    streamEnv<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">//指定EventTime为时间语义</span>
     streamEnv<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

   <span class="token comment">//todo: 2、构建StreamTableEnvironment</span>
      <span class="token keyword">val</span> tableEnvironment<span class="token operator">:</span> StreamTableEnvironment <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">)</span>

  <span class="token comment">//todo： 3、接受socket数据</span>
      <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

  <span class="token comment">//todo: 4、数据切分处理</span>
    <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>Message<span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>

   <span class="token comment">//todo: 5、添加watermark</span>
    <span class="token keyword">val</span> watermarksStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token operator">=</span> mapStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span><span class="token keyword">new</span> AssignerWithPeriodicWatermarks<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token punctuation">{</span>

      <span class="token comment">//定义延迟时长</span>
      <span class="token keyword">val</span> maxOutOfOrderness <span class="token operator">=</span> <span class="token number">5000L</span>
      <span class="token comment">//历史最大事件时间</span>
      <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> _

      <span class="token keyword">override</span> <span class="token keyword">def</span> getCurrentWatermark<span class="token operator">:</span> Watermark <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> watermark <span class="token operator">=</span> <span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>currentMaxTimestamp <span class="token operator">-</span> maxOutOfOrderness<span class="token punctuation">)</span>
        watermark
      <span class="token punctuation">}</span>

      <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> Message<span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

        <span class="token keyword">val</span> eventTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>createTime
        currentMaxTimestamp <span class="token operator">=</span> Math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> currentMaxTimestamp<span class="token punctuation">)</span>
        eventTime
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    
    <span class="token comment">//todo:6、构建Table , 设置时间属性</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
     <span class="token keyword">val</span> table<span class="token operator">:</span> Table <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>fromDataStream<span class="token punctuation">(</span>watermarksStream<span class="token punctuation">,</span><span class="token string">'word,'</span>createTime<span class="token punctuation">.</span>rowtime<span class="token punctuation">)</span>


    <span class="token comment">//todo:7、添加window</span>
        <span class="token comment">//滚动窗口第一种写法</span>
    <span class="token comment">//val windowedTable: GroupWindowedTable = table.window(Tumble.over(&quot;5.second&quot;).on(&quot;createTime&quot;).as(&quot;window&quot;))</span>

       <span class="token comment">//滚动窗口的第二种写法,  as 'window用于设置窗口的名称，随便取个名字就行</span>
   <span class="token keyword">val</span> windowedTable<span class="token operator">:</span> GroupWindowedTable <span class="token operator">=</span> table<span class="token punctuation">.</span>window<span class="token punctuation">(</span>Tumble over <span class="token number">5.</span>second on <span class="token string">'createTime as '</span>window<span class="token punctuation">)</span>

    <span class="token comment">//todo:8、对窗口数据进行处理</span>
                                          <span class="token comment">// 使用2个字段分组，窗口名称和单词</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> Table <span class="token operator">=</span> windowedTable<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">'window,'</span>word<span class="token punctuation">)</span>
                                              <span class="token comment">//单词、窗口的开始、结束e、聚合计算</span>
                                         <span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'word,'</span>window<span class="token punctuation">.</span>start<span class="token punctuation">,</span><span class="token string">'window.end,'</span>word<span class="token punctuation">.</span>count<span class="token punctuation">)</span>


     <span class="token comment">//todo:9、将table转换成DataStream</span>
     <span class="token keyword">val</span> resultStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Boolean</span><span class="token punctuation">,</span> Row<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>toRetractStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

     resultStream<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>_1 <span class="token operator">==</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

     tableEnvironment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;table&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>发送数据</p> <div class="language-scala extra-class"><pre class="language-scala"><code>hadoop<span class="token punctuation">,</span><span class="token number">1461756862000</span>
hadoop<span class="token punctuation">,</span><span class="token number">1461756866000</span>
hadoop<span class="token punctuation">,</span><span class="token number">1461756864000</span>
hadoop<span class="token punctuation">,</span><span class="token number">1461756870000</span>
hadoop<span class="token punctuation">,</span><span class="token number">1461756875000</span>
</code></pre></div><p>输出结果：</p> <div class="language-scala extra-class"><pre class="language-scala"><code>hadoop<span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">27</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">20.0</span><span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">27</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">25.0</span><span class="token punctuation">,</span><span class="token number">2</span>
hadoop<span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">27</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">25.0</span><span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">27</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">30.0</span><span class="token punctuation">,</span><span class="token number">1</span>
</code></pre></div><h5 id="_3-6-sql使用"><a href="#_3-6-sql使用" class="header-anchor">#</a> 3.6 SQL使用</h5> <p>SQL 作为 Flink 中提供的接口之一，占据着非常重要的地位，主要是因为 SQL 具有灵活和丰富的语法，能够应用于大部分的计算场景。</p> <p>Flink SQL 底层使用 Apache Calcite 框架， <strong>将标准的 Flink SQL 语句解析并转换成底层的算子处理逻辑</strong>，并在转换过程中基于语法规则层面进行性能优化，比如谓词下推等。另外用户在使用 SQL 编写 Flink 应用时，能够屏蔽底层技术细节，能够更加方便且高效地通过SQL语句来构建Flink应用。</p> <p>Flink SQL构建在Table API 之上，并含盖了大部分的 Table API 功能特性。<strong>同时 Flink SQL 可以和 Table API 混用</strong>，Flink 最终会在整体上将代码合并在同一套代码逻辑中</p> <h6 id="_3-6-1-sql操作"><a href="#_3-6-1-sql操作" class="header-anchor">#</a> 3.6.1 SQL操作</h6> <p>代码开发演示</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>table</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>Table
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamTableEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>Row

<span class="token keyword">object</span> FlinkSQLTest <span class="token punctuation">{</span>

  <span class="token comment">//todo:定义样例类</span>
  <span class="token keyword">case</span> <span class="token keyword">class</span> User<span class="token punctuation">(</span>id<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>name<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>age<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

     <span class="token comment">//todo:1、构建流处理环境</span>
        <span class="token keyword">val</span> streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    streamEnv<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:2、构建TableEnvironment</span>
        <span class="token keyword">val</span> tableEnvironment<span class="token operator">:</span> StreamTableEnvironment <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">)</span>
        <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">/**
      * 101,zhangsan,18
      * 102,lisi,20
      * 103,wangwu,25
      * 104,zhaoliu,15
      */</span>
     <span class="token comment">//todo:3、接受socket数据</span>
        <span class="token keyword">val</span> socketStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:4、对数据进行处理</span>
       <span class="token keyword">val</span> userStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>User<span class="token punctuation">]</span> <span class="token operator">=</span> socketStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>User<span class="token punctuation">(</span>x<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span>x<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span>

     <span class="token comment">//todo:5、将流注册成一张表</span>
      tableEnvironment<span class="token punctuation">.</span>registerDataStream<span class="token punctuation">(</span><span class="token string">&quot;userTable&quot;</span><span class="token punctuation">,</span>userStream<span class="token punctuation">)</span>

    <span class="token comment">//todo:6、使用table 的api查询年龄大于20岁的人</span>
      <span class="token keyword">val</span> result<span class="token operator">:</span>Table <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>sqlQuery<span class="token punctuation">(</span><span class="token string">&quot;select * from userTable where age&gt;20&quot;</span><span class="token punctuation">)</span>


    <span class="token comment">//todo：7、将table转化成流</span>
     tableEnvironment<span class="token punctuation">.</span>toAppendStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token comment">//todo:8、启动</span>
     tableEnvironment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;TableFromDataStream&quot;</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><p>发送数据：</p> <div class="language-scala extra-class"><pre class="language-scala"><code>nc <span class="token operator">-</span>lk <span class="token number">9999</span>


<span class="token number">101</span><span class="token punctuation">,</span>zhangsan<span class="token punctuation">,</span><span class="token number">18</span>
<span class="token number">102</span><span class="token punctuation">,</span>lisi<span class="token punctuation">,</span><span class="token number">28</span>
<span class="token number">103</span><span class="token punctuation">,</span>wangwu<span class="token punctuation">,</span><span class="token number">25</span>
<span class="token number">104</span><span class="token punctuation">,</span>zhaoliu<span class="token punctuation">,</span><span class="token number">30</span>
</code></pre></div><p>将Table转换成为DataStream的两种模式</p> <ul><li><p>第一种方式：AppendMode</p> <div class="language- extra-class"><pre class="language-text"><code>     将表附加到流数据，表当中只能有查询或者添加操作，如果有update或者delete操作，那么就会失败。
     只有在动态Table仅通过INSERT时才能使用此模式，即它仅附加，并且以前发出的结果永远不会更新。如果更新或删除操作使用追加模式会失败报错。
</code></pre></div></li> <li><p>第二种模式：RetraceMode</p> <div class="language- extra-class"><pre class="language-text"><code>     始终可以使用此模式。返回值是boolean类型。它用true或false来标记数据的插入和撤回，返回true代表数据插入，false代表数据的撤回。
</code></pre></div></li></ul> <h6 id="_3-6-2-sql中的window"><a href="#_3-6-2-sql中的window" class="header-anchor">#</a> 3.6.2 SQL中的window</h6> <p>Flink SQL 也支持三种窗口类型，分别为 Tumble Windows、HOP Windows 和 Session Windows，其中 HOP Windows 对应 Table API 中的 Sliding Window，同时每种窗口分别有相应的使用场景和方法。</p> <p>需求：统计最近 5 秒钟，每个单词出现的次数</p> <p>代码开发</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>table</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>AssignerWithPeriodicWatermarks
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span>Watermark
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamTableEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token punctuation">{</span>GroupWindowedTable<span class="token punctuation">,</span> Table<span class="token punctuation">,</span> Tumble<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>Row

<span class="token comment">/**
  * 基于SQL的window窗口操作处理延迟数据
  */</span>
<span class="token keyword">object</span> SQLWindowWaterMark <span class="token punctuation">{</span>

  <span class="token comment">//定义样例类</span>
  <span class="token keyword">case</span> <span class="token keyword">class</span> Message<span class="token punctuation">(</span>word<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>createTime<span class="token operator">:</span><span class="token builtin">Long</span><span class="token punctuation">)</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//todo:1、构建流处理环境</span>
     <span class="token keyword">val</span> streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    streamEnv<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

      <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">//指定EventTime为时间语义</span>
     streamEnv<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

   <span class="token comment">//todo: 2、构建StreamTableEnvironment</span>
      <span class="token keyword">val</span> tableEnvironment<span class="token operator">:</span> StreamTableEnvironment <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">)</span>

  <span class="token comment">//todo： 3、接受socket数据</span>
      <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

  <span class="token comment">//todo: 4、数据切分处理</span>
    <span class="token keyword">val</span> mapStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>Message<span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span><span class="token punctuation">)</span>

   <span class="token comment">//todo: 5、添加watermark</span>
    <span class="token keyword">val</span> watermarksStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token operator">=</span> mapStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span><span class="token keyword">new</span> AssignerWithPeriodicWatermarks<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token punctuation">{</span>

      <span class="token comment">//定义延迟时长</span>
      <span class="token keyword">val</span> maxOutOfOrderness <span class="token operator">=</span> <span class="token number">5000L</span>
      <span class="token comment">//历史最大事件时间</span>
      <span class="token keyword">var</span> currentMaxTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> _

      <span class="token keyword">override</span> <span class="token keyword">def</span> getCurrentWatermark<span class="token operator">:</span> Watermark <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> watermark <span class="token operator">=</span> <span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>currentMaxTimestamp <span class="token operator">-</span> maxOutOfOrderness<span class="token punctuation">)</span>
        watermark
      <span class="token punctuation">}</span>

      <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> Message<span class="token punctuation">,</span> previousElementTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

        <span class="token keyword">val</span> eventTime<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>createTime
        currentMaxTimestamp <span class="token operator">=</span> Math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> currentMaxTimestamp<span class="token punctuation">)</span>
        eventTime
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>



      <span class="token comment">//todo:6、注册DataStream成表 ，设置时间属性</span>
       <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
      tableEnvironment<span class="token punctuation">.</span>registerDataStream<span class="token punctuation">(</span><span class="token string">&quot;t_socket&quot;</span><span class="token punctuation">,</span>watermarksStream<span class="token punctuation">,</span><span class="token string">'word,'</span>createTime<span class="token punctuation">.</span>rowtime<span class="token punctuation">)</span>


    <span class="token comment">//todo:7、sql查询---添加window---滚动窗口----窗口长度5s</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> Table <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>sqlQuery<span class="token punctuation">(</span><span class="token string">&quot;select word,count(*) from t_socket group by tumble(createTime,interval '5' second),word&quot;</span><span class="token punctuation">)</span>


     <span class="token comment">//todo:8、将table转换成DataStream</span>
     <span class="token keyword">val</span> resultStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Boolean</span><span class="token punctuation">,</span> Row<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>toRetractStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

     resultStream<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>_1 <span class="token operator">==</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

     tableEnvironment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;table&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>发送数据</p> <div class="language-scala extra-class"><pre class="language-scala"><code>hadoop<span class="token punctuation">,</span><span class="token number">1461756862000</span>
hadoop<span class="token punctuation">,</span><span class="token number">1461756865000</span>
hadoop<span class="token punctuation">,</span><span class="token number">1461756863000</span>
hadoop<span class="token punctuation">,</span><span class="token number">1461756868000</span>
hadoop<span class="token punctuation">,</span><span class="token number">1461756870000</span>
hadoop<span class="token punctuation">,</span><span class="token number">1461756875000</span>
hadoop<span class="token punctuation">,</span><span class="token number">1461756880000</span>
</code></pre></div><p>更多的SQL操作详细见官网</p> <ul><li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.10/dev/table/sql/queries.html" target="_blank" rel="noopener noreferrer">https://ci.apache.org/projects/flink/flink-docs-release-1.10/dev/table/sql/queries.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p><img src="/assets/img/1588066607198.9604113b.png" alt="1588066607198"></p> <h2 id="_1-flink的复杂事物处理机制cep"><a href="#_1-flink的复杂事物处理机制cep" class="header-anchor">#</a> 1. Flink的复杂事物处理机制CEP</h2> <h5 id="_1-1-cep概念"><a href="#_1-1-cep概念" class="header-anchor">#</a> 1.1 CEP概念</h5> <p>CEP是<strong>Complex Event Processing</strong>三个单词的缩写，表示复杂事件处理，是一种基于流处理的技术，CEP是Flink专门为我们提供的一个基于复杂事件监测处理的库，<strong>CEP通过一个或多个由简单事件构成的事件流通过一定的规则匹配，然后输出用户想得到的数据，满足规则的复杂事件</strong>。</p> <p>说白一点，CEP就是用户自己指定了一些规则，然后将这些规则应用到不断产生的数据流中，最后进行一个规则的匹配。</p> <p>CEP复杂事件处理<strong>主要应用于防范网络欺诈、设备故障检测、风险规避和智能营销等领域</strong>。Flink 基于 DataStrem API 提供了 FlinkCEP 组件栈，专门用于对复杂事件的处理，帮助用户从流式数据中发掘有价值的信息。</p> <h5 id="_1-2-cep的主要特点"><a href="#_1-2-cep的主要特点" class="header-anchor">#</a> 1.2 CEP的主要特点</h5> <p>目标：从有序的简单事件流中发现一些高阶特征</p> <ul><li>输入：一个或多个由简单事件构成的事件流</li> <li>处理：<strong>识别简单事件之间的内在联系</strong>，多个符合一定规则的简单事件构成复杂事件</li> <li>输出：满足规则的复杂事件</li></ul> <p><img src="/assets/img/image-20200509183224027.f0a5cf35.png" alt="image-20200509183224027"></p> <h5 id="_1-3-pattern-api"><a href="#_1-3-pattern-api" class="header-anchor">#</a> 1.3 Pattern API</h5> <p>FlinkCEP 中提供了 Pattern API 用于对输入流数据的复杂事件规则定义，并从事件流中抽取事件结果。</p> <p>包含四个步骤</p> <ul><li>（1）输入事件流的创建</li> <li>（2）Pattern 的定义</li> <li>（3）Pattern 应用在事件流上检测</li> <li>（4）选取结果</li></ul> <h6 id="_1、输入事件流的创建"><a href="#_1、输入事件流的创建" class="header-anchor">#</a> 1、输入事件流的创建</h6> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">//获取数据输入流</span>
<span class="token keyword">val</span> input<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Event<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><h6 id="_2、pattern的定义"><a href="#_2、pattern的定义" class="header-anchor">#</a> 2、Pattern的定义</h6> <p>定义 Pattern 可以是单次执行模式，也可以是循环执行模式。<strong>单次执行模式一次只接受一个事件，循环执行模式可以接收一个或者多个事件</strong>。通常情况下，可以通过指定循环次数将单次执行模式变为循环执行模式。每种模式能够将多个条件组合应用到同一事件之上，<strong>条件组合可以通过 where 方法进行叠加</strong>。</p> <p>每个 Pattern 都是通过 begin 方法定义的</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> start <span class="token operator">=</span> Pattern<span class="token punctuation">.</span>begin<span class="token punctuation">[</span>Event<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;start_pattern&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>下一步通过 Pattern.where()方法在 Pattern 上指定 Condition，只有当 Condition 满足之后，当前的 Pattern 才会接受事件</p> <div class="language-scala extra-class"><pre class="language-scala"><code>start<span class="token punctuation">.</span>where<span class="token punctuation">(</span>_<span class="token punctuation">.</span>getID <span class="token operator">==</span> <span class="token string">&quot;9527&quot;</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><p>==1、设置循环次数==</p> <ul><li><p>对于已经创建好的 Pattern，可以指定循环次数，形成循环执行的 Pattern</p> <ul><li><p>times：可以通过 times 指定<strong>固定的循环执行次数</strong></p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">//指定循环触发4次 </span>
start<span class="token punctuation">.</span>times<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//可以执行触发次数范围,让循环执行次数在该范围之内 </span>
start<span class="token punctuation">.</span>times<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>optional：也可以通过 optional 关键字指定<strong>要么不触发，要么触发指定的次数</strong></p> <div class="language-scala extra-class"><pre class="language-scala"><code>start<span class="token punctuation">.</span>times<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>optional<span class="token punctuation">(</span><span class="token punctuation">)</span>
start<span class="token punctuation">.</span>times<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>optional<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>greedy：可以通过 greedy 将 Pattern 标记为<strong>贪婪模式</strong>，在 Pattern 匹配成功的前提下，会尽可能多次触发。</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">//触发2、3、4次,尽可能重复执行 </span>
start<span class="token punctuation">.</span>times<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>greedy<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//触发0、2、3、4次,尽可能重复执行 </span>
start<span class="token punctuation">.</span>times<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>optional<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>greedy<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>oneOrMore：可以通过 oneOrMore 方法指定<strong>触发一次或多次</strong></p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">// 触发一次或者多次 </span>
start<span class="token punctuation">.</span>oneOrMore<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//触发一次或者多次,尽可能重复执行 </span>
start<span class="token punctuation">.</span>oneOrMore<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>greedy<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment">// 触发0次或者多次 </span>
start<span class="token punctuation">.</span>oneOrMore<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>optional<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment">// 触发0次或者多次,尽可能重复执行 </span>
start<span class="token punctuation">.</span>oneOrMore<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>optional<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>greedy<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>timesOrMor：通过 timesOrMore 方法可以指定<strong>触发固定次数以上</strong>，例如执行两次以上</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">// 触发两次或者多次 </span>
start<span class="token punctuation">.</span>timesOrMore<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 触发两次或者多次,尽可能重复执行 </span>
start<span class="token punctuation">.</span>timesOrMore<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>greedy<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 不触发或者触发两次以上,尽可能重执行 </span>
start<span class="token punctuation">.</span>timesOrMore<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>optional<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>greedy<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li></ul></li></ul></li> <li><p>==2、定义条件==</p> <ul><li><p>每个模式都需要指定<strong>触发条件，作为事件进入到该模式是否接受的判断依据</strong>，当事件中的数值满足了条件时，便进行下一步操作。在 FlinkCFP 中通过 pattern.where()、 pattern.or()及pattern.until()方法来为 Pattern 指定条件，且 Pattern 条件有 Simple Conditions 及Combining Conditions 等类型</p> <ul><li><p>Simple Conditions（简单条件）</p> <ul><li><p>其主要根据事件中的字段信息进行判断，决定是否接受该事件。</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">// 把ID为9527的事件挑选出来</span>
start<span class="token punctuation">.</span>where<span class="token punctuation">(</span>_<span class="token punctuation">.</span>getID <span class="token operator">==</span> <span class="token string">&quot;9527&quot;</span><span class="token punctuation">)</span>
</code></pre></div></li></ul></li> <li><p>Combining Conditions（组合条件）</p> <ul><li><p>是将简单条件进行合并，通常情况下也可以使用 where 方法进行条件的组合，默认每个条件通过 AND 逻辑相连。如果需要使用 OR 逻辑，直接使用 or 方法连接条件即可</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">// 把ID为9527或者年龄大于30的事件挑选出来 </span>
<span class="token keyword">val</span> start <span class="token operator">=</span> Pattern<span class="token punctuation">.</span>begin<span class="token punctuation">[</span>Event<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;start_pattern&quot;</span><span class="token punctuation">)</span>
				 <span class="token punctuation">.</span>where<span class="token punctuation">(</span>_<span class="token punctuation">.</span>callType<span class="token operator">==</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>or<span class="token punctuation">(</span>_<span class="token punctuation">.</span>age <span class="token operator">&gt;</span><span class="token number">30</span><span class="token punctuation">)</span>
</code></pre></div></li></ul></li> <li><p>Stop condition （终止条件）</p> <ul><li><p>如果程序中使用了 oneOrMore 或者 oneOrMore().optional()方法，还可以指定停止条件，否则模式中的规则会一直循环下去，如下终止条件通过 until()方法指定</p> <div class="language-scala extra-class"><pre class="language-scala"><code>start<span class="token punctuation">.</span>oneOrMore<span class="token punctuation">.</span>until<span class="token punctuation">(</span>_<span class="token punctuation">.</span>getID <span class="token operator">==</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span>
</code></pre></div></li></ul></li></ul></li></ul></li> <li><p>==3、模式序列==</p> <ul><li><p>将相互独立的模式进行组合然后形成模式序列。模式序列基本的编写方式和独立模式一 致，各个模式之间通过邻近条件进行连接即可，其中有严格邻近、宽松邻近、非确定宽松邻近三种邻近连接条件。</p> <ul><li><p>严格邻近</p> <ul><li><p>严格邻近条件中，需要所有的事件都按照顺序满足模式条件，不允许忽略任意不满足的模式</p> <ul><li><strong>next</strong></li></ul> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">//示例</span>
begin<span class="token punctuation">(</span><span class="token string">&quot;first&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>_<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token string">&quot;second&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">)</span>
<span class="token comment">//当且仅当数据为a,b时，模式才会被命中。如果数据为a,c,b，由于a的后面跟了c，所以a会被直接丢弃，模式不会命中。</span>
</code></pre></div></li></ul></li> <li><p>宽松邻近</p> <ul><li><p>在宽松邻近条件下，会忽略没有成功匹配模式条件，并不会像严格邻近要求得那么高，可以简单理解为 OR 的逻辑关系</p> <ul><li><strong>followedBy</strong></li></ul> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">//示例</span>
begin<span class="token punctuation">(</span><span class="token string">&quot;first&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>_<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>followedBy<span class="token punctuation">(</span><span class="token string">&quot;second&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">)</span>
<span class="token comment">//当且仅当数据为a,b或者为a,c,b，，模式均被命中，中间的c会被忽略掉。</span>
</code></pre></div></li></ul></li> <li><p>非确定宽松邻近</p> <ul><li><p>和宽松邻近条件相比，非确定宽松邻近条件指在模式匹配过程中可以忽略已经匹配的条件</p> <ul><li><strong>followedByAny</strong></li></ul> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">//示例</span>
begin<span class="token punctuation">(</span><span class="token string">&quot;first&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>_<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>followedByAny<span class="token punctuation">(</span><span class="token string">&quot;second&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">)</span>
<span class="token comment">//当且仅当数据为a,c,b,b时，对于followedBy模式而言命中的为{a,b}，</span>
<span class="token comment">//对于followedByAny而言会有两次命中{a,b},{a,b}</span>
</code></pre></div></li></ul> <img src="flink.assets/image-20200510022432230.png" alt="image-20200510022432230" style="zoom:67%;"></li> <li><p>除以上模式序列外，还可以定义“不希望出现某种近邻关系”</p> <ul><li>notNext()
<ul><li>不想让某个事件严格紧邻前一个事件发生</li></ul></li> <li>notFollowedBy()
<ul><li>不想让某个事件在两个事件之间发生</li></ul></li></ul></li></ul></li> <li><p>注意</p> <ul><li><p>1、所有模式序列必须以 .begin() 开始</p></li> <li><p>2、模式序列不能以 .notFollowedBy() 结束</p></li> <li><p>3、“not” 类型的模式不能和optional关键字同时使用</p></li> <li><p>4、此外，还可以为模式指定时间约束，用来要求在多长时间内匹配有效</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">//指定模式在10秒内有效 </span>
pattern<span class="token punctuation">.</span>within<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></li></ul></li></ul></li></ul> <h6 id="_3、pattern检测"><a href="#_3、pattern检测" class="header-anchor">#</a> 3、Pattern检测</h6> <ul><li><p>调用**CEP.pattern()**方法，给定输入流和模式，就能得到一个PatternStream</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">//Pattern检测</span>
<span class="token keyword">val</span> patternStream <span class="token operator">=</span> CEP<span class="token punctuation">.</span>pattern<span class="token punctuation">[</span>Event<span class="token punctuation">]</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">,</span>pattern<span class="token punctuation">)</span>
</code></pre></div></li></ul> <h6 id="_4、选取结果"><a href="#_4、选取结果" class="header-anchor">#</a> 4、选取结果</h6> <ul><li><p>得到 PatternStream 类型的数据集后，接下来数据获取都基于 PatternStream 进行。该数据集中包含了所有的匹配事件。目前在 FlinkCEP 中提供 <strong>select</strong> 和 <strong>flatSelect</strong> 两种方法从 PatternStream 提取事件结果。</p></li> <li><p>1、通过 Select Funciton 抽取正常事件</p> <ul><li><p>可以通过在 PatternStream 的<strong>Select 方法中传入自定义 Select Funciton 完成对匹配事件的转换与输出</strong>。其中 Select Funciton 的输入参数为 Map[String, Iterable[IN]]，Map 中的 key 为模式序列中的 Pattern 名称，Value 为对应 Pattern 所接受的事件集合，格式为输入事件的数据类型。</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">def</span> selectFunction<span class="token punctuation">(</span>pattern <span class="token operator">:</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">[</span>IN<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> OUT <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取pattern中的start</span>
     Event <span class="token keyword">val</span> startEvent <span class="token operator">=</span> pattern<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;start_pattern&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">.</span>next
    <span class="token comment">//获取Pattern中middle</span>
    Event <span class="token keyword">val</span> middleEvent <span class="token operator">=</span> pattern<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;middle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">.</span>next 
    <span class="token comment">//返回结果 </span>
    OUT<span class="token punctuation">(</span>startEvent<span class="token punctuation">,</span> middleEvent<span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><p>2、通过 Flat Select Funciton 抽取正常事件</p> <ul><li><p>Flat Select Funciton 和 Select Function 相似，不过 Flat Select Funciton 在每次调用<strong>可以返回任意数量的结果</strong>。因为 Flat Select Funciton 使用 Collector 作为返回结果的容器，可以将需要输出的事件都放置在 Collector 中返回。</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">def</span> flatSelectFunction<span class="token punctuation">(</span>pattern <span class="token operator">:</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">[</span>IN<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>collector<span class="token operator">:</span>Collector<span class="token punctuation">[</span>OUT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取pattern中的start</span>
     Event <span class="token keyword">val</span> startEvent <span class="token operator">=</span> pattern<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;start_pattern&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">.</span>next
    <span class="token comment">//获取Pattern中middle</span>
    Event <span class="token keyword">val</span> middleEvent <span class="token operator">=</span> pattern<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;middle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">.</span>next 
    <span class="token comment">//并根据startEvent的Value数量进行返回</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> <span class="token number">0</span> to <span class="token namespace">startEvent<span class="token punctuation">.</span>getValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        collector<span class="token punctuation">.</span>collect<span class="token punctuation">(</span>OUT<span class="token punctuation">(</span>startEvent<span class="token punctuation">,</span> middleEvent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><p>3、通过 Select Funciton 抽取超时事件</p> <ul><li><p>如果模式中有 within(time)，那么就很有可能有超时的数据存在，通过 PatternStream，Select 方法分别获取超时事件和正常事件。首先需要创建 OutputTag 来标记超时事件，然后在 PatternStream.select 方法中使用 OutputTag，就可以将超时事件从 PatternStream中抽取出来。</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">// 通过CEP.pattern方法创建PatternStream </span>
<span class="token keyword">val</span> patternStream<span class="token operator">:</span> PatternStream<span class="token punctuation">[</span>Event<span class="token punctuation">]</span> <span class="token operator">=</span> CEP<span class="token punctuation">.</span>pattern<span class="token punctuation">(</span>input<span class="token punctuation">,</span> pattern<span class="token punctuation">)</span> 

<span class="token comment">//创建OutputTag,并命名为timeout-output </span>
<span class="token keyword">val</span> timeoutTag <span class="token operator">=</span> OutputTag<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;timeout-output&quot;</span><span class="token punctuation">)</span> 

<span class="token comment">//调用PatternStream select()并指定timeoutTag </span>
<span class="token keyword">val</span> result<span class="token operator">:</span> SingleOutputStreamOperator<span class="token punctuation">[</span>NormalEvent<span class="token punctuation">]</span> <span class="token operator">=</span> patternStream<span class="token punctuation">.</span>select<span class="token punctuation">(</span>timeoutTag<span class="token punctuation">)</span><span class="token punctuation">{</span> 
<span class="token comment">//超时事件获取 </span>
<span class="token punctuation">(</span>pattern<span class="token operator">:</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">[</span>Event<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> timestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span>
	TimeoutEvent<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//返回异常事件</span>
 <span class="token punctuation">}</span> 
 <span class="token punctuation">{</span> 
 <span class="token comment">//正常事件获取 </span>
 pattern<span class="token operator">:</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">[</span>Event<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">=&gt;</span>
 	NormalEvent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//返回正常事件 </span>
 <span class="token punctuation">}</span> 
 <span class="token comment">//调用getSideOutput方法,并指定timeoutTag将超时事件输出 </span>
 <span class="token keyword">val</span> timeoutResult<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>TimeoutEvent<span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">.</span>getSideOutput<span class="token punctuation">(</span>timeoutTag<span class="token punctuation">)</span>
</code></pre></div></li></ul></li></ul> <h2 id="_2-cep编程开发案例实战"><a href="#_2-cep编程开发案例实战" class="header-anchor">#</a> 2. CEP编程开发案例实战</h2> <ul><li><p>描述</p> <ul><li>在我们操作某些银行APP的时候，经常会发现，如果上一个操作与下一个操作IP变换了（例如上一个操作使用的流量操作，下一个操作我连接上了wifi去操作，IP就会变换），那么APP就要求我们重新进行登录，避免由于IP变换产生的风险操作</li></ul></li> <li><p>需求</p> <ul><li>用户上一个操作与下一个操作IP变换报警</li></ul></li> <li><p>数据格式如下</p> <ul><li>从socket当中输入数据源</li></ul> <div class="language- extra-class"><pre class="language-text"><code>192.168.52.100,zhubajie,https://icbc.com.cn/login.html,2020-02-12 12:23:45
192.168.54.172,tangseng,https://icbc.com.cn/login.html,2020-02-12 12:23:46
192.168.145.77,sunwukong,https://icbc.com.cn/login.html,2020-02-12 12:23:47
192.168.52.100,zhubajie,https://icbc.com.cn/transfer.html,2020-02-12 12:23:47
192.168.54.172,tangseng,https://icbc.com.cn/transfer.html,2020-02-12 12:23:48
192.168.145.77,sunwukong,https://icbc.com.cn/transfer.html,2020-02-12 12:23:49
192.168.145.77,sunwukong,https://icbc.com.cn/save.html,2020-02-12 12:23:52
192.168.52.100,zhubajie,https://icbc.com.cn/save.html,2020-02-12 12:23:53
192.168.54.172,tangseng,https://icbc.com.cn/save.html,2020-02-12 12:23:54
192.168.54.172,tangseng,https://icbc.com.cn/buy.html,2020-02-12 12:23:57
192.168.145.77,sunwukong,https://icbc.com.cn/buy.html,2020-02-12 12:23:58
192.168.52.100,zhubajie,https://icbc.com.cn/buy.html,2020-02-12 12:23:59
192.168.44.110,zhubajie,https://icbc.com.cn/pay.html,2020-02-12 12:24:03
192.168.38.135,tangseng,https://icbc.com.cn/pay.html,2020-02-12 12:24:04
192.168.89.189,sunwukong,https://icbc.com.cn/pay.html,2020-02-12 12:24:05
192.168.44.110,zhubajie,https://icbc.com.cn/login.html,2020-02-12 12:24:04
192.168.38.135,tangseng,https://icbc.com.cn/login.html,2020-02-12 12:24:08
192.168.89.189,sunwukong,https://icbc.com.cn/login.html,2020-02-12 12:24:07
192.168.38.135,tangseng,https://icbc.com.cn/pay.html,2020-02-12 12:24:10
192.168.44.110,zhubajie,https://icbc.com.cn/pay.html,2020-02-12 12:24:06
192.168.89.189,sunwukong,https://icbc.com.cn/pay.html,2020-02-12 12:24:09
192.168.38.135,tangseng,https://icbc.com.cn/pay.html,2020-02-12 12:24:13
192.168.44.110,zhubajie,https://icbc.com.cn/pay.html,2020-02-12 12:24:12
192.168.89.189,sunwukong,https://icbc.com.cn/pay.html,2020-02-12 12:24:15
</code></pre></div><ul><li>整理之后的格式如下：</li></ul> <div class="language- extra-class"><pre class="language-text"><code>192.168.145.77,sunwukong,https://icbc.com.cn/login.html,2020-02-12 12:23:47
192.168.145.77,sunwukong,https://icbc.com.cn/transfer.html,2020-02-12 12:23:49
192.168.145.77,sunwukong,https://icbc.com.cn/save.html,2020-02-12 12:23:52
192.168.145.77,sunwukong,https://icbc.com.cn/buy.html,2020-02-12 12:23:58
192.168.89.189,sunwukong,https://icbc.com.cn/pay.html,2020-02-12 12:24:05
192.168.89.189,sunwukong,https://icbc.com.cn/login.html,2020-02-12 12:24:07
192.168.89.189,sunwukong,https://icbc.com.cn/pay.html,2020-02-12 12:24:09
192.168.89.189,sunwukong,https://icbc.com.cn/pay.html,2020-02-12 12:24:15

192.168.52.100,zhubajie,https://icbc.com.cn/login.html,2020-02-12 12:23:45
192.168.52.100,zhubajie,https://icbc.com.cn/transfer.html,2020-02-12 12:23:47
192.168.52.100,zhubajie,https://icbc.com.cn/save.html,2020-02-12 12:23:53
192.168.52.100,zhubajie,https://icbc.com.cn/buy.html,2020-02-12 12:23:59
192.168.44.110,zhubajie,https://icbc.com.cn/pay.html,2020-02-12 12:24:03
192.168.44.110,zhubajie,https://icbc.com.cn/login.html,2020-02-12 12:24:04
192.168.44.110,zhubajie,https://icbc.com.cn/pay.html,2020-02-12 12:24:06
192.168.44.110,zhubajie,https://icbc.com.cn/pay.html,2020-02-12 12:24:12

192.168.54.172,tangseng,https://icbc.com.cn/login.html,2020-02-12 12:23:46
192.168.54.172,tangseng,https://icbc.com.cn/transfer.html,2020-02-12 12:23:48
192.168.54.172,tangseng,https://icbc.com.cn/save.html,2020-02-12 12:23:54
192.168.54.172,tangseng,https://icbc.com.cn/buy.html,2020-02-12 12:23:57
192.168.38.135,tangseng,https://icbc.com.cn/pay.html,2020-02-12 12:24:04
192.168.38.135,tangseng,https://icbc.com.cn/login.html,2020-02-12 12:24:08
192.168.38.135,tangseng,https://icbc.com.cn/pay.html,2020-02-12 12:24:10
192.168.38.135,tangseng,https://icbc.com.cn/pay.html,2020-02-12 12:24:13
</code></pre></div></li></ul> <h5 id="_2-1-使用state编程实现"><a href="#_2-1-使用state编程实现" class="header-anchor">#</a> 2.1 使用State编程实现</h5> <p>代码开发</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>cep</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collections

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token punctuation">{</span>ListState<span class="token punctuation">,</span> ListStateDescriptor<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span>Configuration
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>KeyedProcessFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collector

<span class="token comment">/**
  * 使用state编程进行代码实现进行ip检测
  */</span>

<span class="token keyword">case</span> <span class="token keyword">class</span> UserLogin<span class="token punctuation">(</span>ip<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>username<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>operateUrl<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>time<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span>

<span class="token keyword">object</span> CheckIPChangeWithState <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">//todo:1、接受socket数据源</span>
    <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:2、数据处理</span>
    sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">val</span> strings<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span>strings<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>UserLogin<span class="token punctuation">(</span>strings<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>strings<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>strings<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>strings<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>_1<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> LoginCheckProcessFunction<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;checkIpChange&quot;</span><span class="token punctuation">)</span>


  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//自定义KeyedProcessFunction类</span>
<span class="token keyword">class</span> LoginCheckProcessFunction <span class="token keyword">extends</span> KeyedProcessFunction<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span>UserLogin<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span>UserLogin<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">{</span>

   <span class="token comment">//定义ListState</span>
   <span class="token keyword">var</span> listState<span class="token operator">:</span>ListState<span class="token punctuation">[</span>UserLogin<span class="token punctuation">]</span><span class="token operator">=</span>_

  <span class="token keyword">override</span> <span class="token keyword">def</span> open<span class="token punctuation">(</span>parameters<span class="token operator">:</span> Configuration<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    listState <span class="token operator">=</span> getRuntimeContext<span class="token punctuation">.</span>getListState<span class="token punctuation">(</span><span class="token keyword">new</span> ListStateDescriptor<span class="token punctuation">[</span>UserLogin<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;changeIp&quot;</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span>UserLogin<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

  <span class="token comment">//解析用户访问信息</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> processElement<span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> UserLogin<span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token operator">:</span> KeyedProcessFunction<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> UserLogin<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> UserLogin<span class="token punctuation">)</span><span class="token punctuation">]</span>#Context<span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> UserLogin<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> logins <span class="token operator">=</span> <span class="token keyword">new</span> util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">[</span>UserLogin<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//添加到list集合</span>
     listState<span class="token punctuation">.</span>add<span class="token punctuation">(</span>value<span class="token punctuation">.</span>_2<span class="token punctuation">)</span>

    <span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span>JavaConverters<span class="token punctuation">.</span>_
    <span class="token keyword">val</span> toList<span class="token operator">:</span> List<span class="token punctuation">[</span>UserLogin<span class="token punctuation">]</span> <span class="token operator">=</span> listState<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>asScala<span class="token punctuation">.</span>toList
     <span class="token comment">//排序</span>
    <span class="token keyword">val</span> sortList<span class="token operator">:</span> List<span class="token punctuation">[</span>UserLogin<span class="token punctuation">]</span> <span class="token operator">=</span> toList<span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>time<span class="token punctuation">)</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>sortList<span class="token punctuation">.</span>size <span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">val</span> first<span class="token operator">:</span> UserLogin <span class="token operator">=</span> sortList<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> second<span class="token operator">:</span> UserLogin <span class="token operator">=</span> sortList<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>first<span class="token punctuation">.</span>ip<span class="token punctuation">.</span>equals<span class="token punctuation">(</span>second<span class="token punctuation">.</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        println<span class="token punctuation">(</span><span class="token string">&quot;小伙子你的IP变了，赶紧回去重新登录一下&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//移除第一个ip，保留第二个ip</span>
      logins<span class="token punctuation">.</span>removeAll<span class="token punctuation">(</span>Collections<span class="token punctuation">.</span>EMPTY_LIST<span class="token punctuation">)</span>
      logins<span class="token punctuation">.</span>add<span class="token punctuation">(</span>second<span class="token punctuation">)</span>
      listState<span class="token punctuation">.</span>update<span class="token punctuation">(</span>logins<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

     out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span>value<span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><p>socket发送数据，并观察输出结果：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token number">4</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>sunwukong<span class="token punctuation">,</span>UserLogin<span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.145</span><span class="token number">.77</span><span class="token punctuation">,</span>sunwukong<span class="token punctuation">,</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>icbc<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn<span class="token operator">/</span>login<span class="token punctuation">.</span>html<span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">4</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>sunwukong<span class="token punctuation">,</span>UserLogin<span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.145</span><span class="token number">.77</span><span class="token punctuation">,</span>sunwukong<span class="token punctuation">,</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>icbc<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn<span class="token operator">/</span>transfer<span class="token punctuation">.</span>html<span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">49</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">4</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>sunwukong<span class="token punctuation">,</span>UserLogin<span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.145</span><span class="token number">.77</span><span class="token punctuation">,</span>sunwukong<span class="token punctuation">,</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>icbc<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn<span class="token operator">/</span>save<span class="token punctuation">.</span>html<span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">4</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>sunwukong<span class="token punctuation">,</span>UserLogin<span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.145</span><span class="token number">.77</span><span class="token punctuation">,</span>sunwukong<span class="token punctuation">,</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>icbc<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn<span class="token operator">/</span>buy<span class="token punctuation">.</span>html<span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">58</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
小伙子你的IP变了，赶紧回去重新登录一下
<span class="token number">4</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>sunwukong<span class="token punctuation">,</span>UserLogin<span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.89</span><span class="token number">.189</span><span class="token punctuation">,</span>sunwukong<span class="token punctuation">,</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>icbc<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn<span class="token operator">/</span>pay<span class="token punctuation">.</span>html<span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">4</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>sunwukong<span class="token punctuation">,</span>UserLogin<span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.89</span><span class="token number">.189</span><span class="token punctuation">,</span>sunwukong<span class="token punctuation">,</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>icbc<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn<span class="token operator">/</span>login<span class="token punctuation">.</span>html<span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">07</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="_2-2-使用cep编程实现"><a href="#_2-2-使用cep编程实现" class="header-anchor">#</a> 2.2 使用CEP编程实现</h5> <p>导入cep依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-cep-scala_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>代码开发</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>cep</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span></span>PatternSelectFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span>pattern<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span></span>IterativeCondition
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>CEP<span class="token punctuation">,</span> PatternStream<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>pattern<span class="token punctuation">.</span></span>Pattern
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> KeyedStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time

<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable</span>

<span class="token comment">/**
  *使用 CEP 编程进行代码实现进行ip检测
  */</span>

<span class="token keyword">case</span> <span class="token keyword">class</span> UserLoginInfo<span class="token punctuation">(</span>ip<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>username<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>operateUrl<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>time<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span>
<span class="token keyword">object</span> CheckIPChangeWithCEP <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">//todo:1、接受socket数据源</span>
    <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:2、数据处理</span>
    <span class="token keyword">val</span> keyedStream<span class="token operator">:</span> KeyedStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> UserLoginInfo<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
                       <span class="token keyword">val</span> strings<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span>
                      <span class="token punctuation">(</span>strings<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UserLoginInfo<span class="token punctuation">(</span>strings<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strings<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strings<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strings<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span>


   <span class="token comment">//todo:3、定义Pattern,指定相关条件和模型序列</span>
    <span class="token keyword">val</span> pattern<span class="token operator">:</span> Pattern<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> UserLoginInfo<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> UserLoginInfo<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> Pattern<span class="token punctuation">.</span>begin<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> UserLoginInfo<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span>where<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>_2<span class="token punctuation">.</span>username <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token string">&quot;second&quot;</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token keyword">new</span> IterativeCondition<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> UserLoginInfo<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
            <span class="token keyword">override</span> <span class="token keyword">def</span> filter<span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> UserLoginInfo<span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token operator">:</span> IterativeCondition<span class="token punctuation">.</span>Context<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> UserLoginInfo<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
              <span class="token keyword">var</span> flag<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span>
              <span class="token comment">//获取满足前面条件的数据</span>
              <span class="token keyword">val</span> firstValues<span class="token operator">:</span> util<span class="token punctuation">.</span>Iterator<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> UserLoginInfo<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>getEventsForPattern<span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>iterator<span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token comment">//遍历</span>
              <span class="token keyword">while</span> <span class="token punctuation">(</span>firstValues<span class="token punctuation">.</span>hasNext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">val</span> tuple<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> UserLoginInfo<span class="token punctuation">)</span> <span class="token operator">=</span> firstValues<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//ip不相同</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tuple<span class="token punctuation">.</span>_2<span class="token punctuation">.</span>ip<span class="token punctuation">.</span>equals<span class="token punctuation">(</span>value<span class="token punctuation">.</span>_2<span class="token punctuation">.</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  flag <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>

              flag
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">//可以指定模式在一段时间内有效</span>
      <span class="token punctuation">.</span>within<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:4、模式检测，将模式应用到流中</span>
     <span class="token keyword">val</span> patternStream<span class="token operator">:</span> PatternStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> UserLoginInfo<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> CEP<span class="token punctuation">.</span>pattern<span class="token punctuation">(</span>keyedStream<span class="token punctuation">,</span>pattern<span class="token punctuation">)</span>


    <span class="token comment">//todo: 5、选取结果</span>
     patternStream<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token keyword">new</span> MyPatternSelectFunction<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token comment">//todo: 6、开启计算</span>
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment">//自定义PatternSelectFunction类</span>
<span class="token keyword">class</span> MyPatternSelectFunction <span class="token keyword">extends</span> PatternSelectFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span>UserLoginInfo<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span>UserLoginInfo<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> select<span class="token punctuation">(</span>map<span class="token operator">:</span> util<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> UserLoginInfo<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> UserLoginInfo<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取Pattern名称为start的事件</span>
         <span class="token keyword">val</span> startIterator<span class="token operator">=</span> map<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>iterator<span class="token punctuation">(</span><span class="token punctuation">)</span>

         <span class="token keyword">if</span><span class="token punctuation">(</span>startIterator<span class="token punctuation">.</span>hasNext<span class="token punctuation">)</span><span class="token punctuation">{</span>
            println<span class="token punctuation">(</span><span class="token string">&quot;满足start模式中的数据：&quot;</span><span class="token operator">+</span>startIterator<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">}</span>


        <span class="token comment">//获取Pattern名称为second的事件</span>
         <span class="token keyword">val</span> secondIterator <span class="token operator">=</span> map<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;second&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>iterator<span class="token punctuation">(</span><span class="token punctuation">)</span>


        <span class="token keyword">var</span> tuple<span class="token operator">:</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span>UserLoginInfo<span class="token punctuation">)</span><span class="token operator">=</span><span class="token keyword">null</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>secondIterator<span class="token punctuation">.</span>hasNext<span class="token punctuation">)</span><span class="token punctuation">{</span>
            tuple<span class="token operator">=</span>secondIterator<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>
            println<span class="token punctuation">(</span><span class="token string">&quot;满足second模式中的数据：&quot;</span><span class="token operator">+</span> tuple<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

    tuple
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><p>socket发送数据：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token number">192.168</span><span class="token number">.145</span><span class="token number">.77</span><span class="token punctuation">,</span>sunwukong<span class="token punctuation">,</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>icbc<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn<span class="token operator">/</span>login<span class="token punctuation">.</span>html<span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">47</span>
<span class="token number">192.168</span><span class="token number">.145</span><span class="token number">.77</span><span class="token punctuation">,</span>sunwukong<span class="token punctuation">,</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>icbc<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn<span class="token operator">/</span>transfer<span class="token punctuation">.</span>html<span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">49</span>
<span class="token number">192.168</span><span class="token number">.145</span><span class="token number">.77</span><span class="token punctuation">,</span>sunwukong<span class="token punctuation">,</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>icbc<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn<span class="token operator">/</span>save<span class="token punctuation">.</span>html<span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">52</span>
<span class="token number">192.168</span><span class="token number">.145</span><span class="token number">.77</span><span class="token punctuation">,</span>sunwukong<span class="token punctuation">,</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>icbc<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn<span class="token operator">/</span>buy<span class="token punctuation">.</span>html<span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">58</span>
<span class="token number">192.168</span><span class="token number">.89</span><span class="token number">.189</span><span class="token punctuation">,</span>sunwukong<span class="token punctuation">,</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>icbc<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn<span class="token operator">/</span>pay<span class="token punctuation">.</span>html<span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">05</span>
<span class="token number">192.168</span><span class="token number">.89</span><span class="token number">.189</span><span class="token punctuation">,</span>sunwukong<span class="token punctuation">,</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>icbc<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn<span class="token operator">/</span>login<span class="token punctuation">.</span>html<span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">07</span>
</code></pre></div><p>输出结果：</p> <div class="language-scala extra-class"><pre class="language-scala"><code>满足start模式中的数据：<span class="token punctuation">(</span>sunwukong<span class="token punctuation">,</span>UserLogin<span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.145</span><span class="token number">.77</span><span class="token punctuation">,</span>sunwukong<span class="token punctuation">,</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>icbc<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn<span class="token operator">/</span>buy<span class="token punctuation">.</span>html<span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">58</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
满足second模式中的数据：<span class="token punctuation">(</span>sunwukong<span class="token punctuation">,</span>UserLogin<span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.89</span><span class="token number">.189</span><span class="token punctuation">,</span>sunwukong<span class="token punctuation">,</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>icbc<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn<span class="token operator">/</span>pay<span class="token punctuation">.</span>html<span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">05</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_3-flink-cep综合案例实战1"><a href="#_3-flink-cep综合案例实战1" class="header-anchor">#</a> 3. Flink CEP综合案例实战1</h2> <p>场景介绍</p> <ul><li>现在工厂当中有大量的传感设备，用于检测机器当中的各种指标数据，例如温度，湿度，气压等，并实时上报数据到数据中心，现在<strong>需要检测，某一个传感器上报的温度数据是否发生异常</strong>。</li></ul> <p>异常的定义</p> <ul><li>三分钟时间内，出现三次及以上的温度高于40度就算作是异常温度，进行报警输出</li></ul> <p>收集数据如下：</p> <div class="language- extra-class"><pre class="language-text"><code>传感器设备mac地址，检测机器mac地址，温度，湿度，气压，数据产生时间

00-34-5E-5F-89-A4,00-01-6C-06-A6-29,38,0.52,1.1,2020-03-02 12:20:32
00-34-5E-5F-89-A4,00-01-6C-06-A6-29,47,0.48,1.1,2020-03-02 12:20:35
00-34-5E-5F-89-A4,00-01-6C-06-A6-29,50,0.48,1.1,2020-03-02 12:20:38
00-34-5E-5F-89-A4,00-01-6C-06-A6-29,31,0.48,1.1,2020-03-02 12:20:39
00-34-5E-5F-89-A4,00-01-6C-06-A6-29,52,0.48,1.1,2020-03-02 12:20:41
00-34-5E-5F-89-A4,00-01-6C-06-A6-29,53,0.48,1.1,2020-03-02 12:20:43
00-34-5E-5F-89-A4,00-01-6C-06-A6-29,55,0.48,1.1,2020-03-02 12:20:45
</code></pre></div><p>代码开发实现：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>cep</span>


<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>FastDateFormat
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span></span>PatternSelectFunction
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>pattern<span class="token punctuation">.</span></span>Pattern
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>CEP<span class="token punctuation">,</span> PatternStream<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> KeyedStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time

<span class="token comment">//定义温度信息pojo</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> DeviceDetail<span class="token punctuation">(</span>sensorMac<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>deviceMac<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>temperature<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>dampness<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>pressure<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>date<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span>

<span class="token comment">//报警的设备信息样例类</span>
<span class="token comment">//传感器设备mac地址，检测机器mac地址，温度</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> AlarmDevice<span class="token punctuation">(</span>sensorMac<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>deviceMac<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>temperature<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span>

<span class="token comment">/**
  * 基于FlinkCEP的设备温度检测
  */</span>
<span class="token keyword">object</span> FlinkTempeatureCEP <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">val</span> format<span class="token operator">:</span> FastDateFormat <span class="token operator">=</span> FastDateFormat<span class="token punctuation">.</span>getInstance<span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token comment">//指定时间类型</span>
    environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">//接受数据</span>
    <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> deviceStream<span class="token operator">:</span> KeyedStream<span class="token punctuation">[</span>DeviceDetail<span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> strings<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span>
        DeviceDetail<span class="token punctuation">(</span>strings<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strings<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strings<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strings<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strings<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strings<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>assignAscendingTimestamps<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span><span class="token punctuation">{</span>format<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>x<span class="token punctuation">.</span>date<span class="token punctuation">)</span><span class="token punctuation">.</span>getTime<span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>sensorMac<span class="token punctuation">)</span>


     <span class="token comment">//todo:定义Pattern,指定相关条件和模型序列</span>
    <span class="token keyword">val</span> pattern<span class="token operator">:</span> Pattern<span class="token punctuation">[</span>DeviceDetail<span class="token punctuation">,</span> DeviceDetail<span class="token punctuation">]</span> <span class="token operator">=</span> Pattern<span class="token punctuation">.</span>begin<span class="token punctuation">[</span>DeviceDetail<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span>where<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>temperature<span class="token punctuation">.</span>toInt <span class="token operator">&gt;=</span> <span class="token number">40</span><span class="token punctuation">)</span>                                               <span class="token punctuation">.</span>followedByAny<span class="token punctuation">(</span><span class="token string">&quot;follow&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span>where<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>temperature<span class="token punctuation">.</span>toInt <span class="token operator">&gt;=</span> <span class="token number">40</span><span class="token punctuation">)</span>                                             <span class="token punctuation">.</span>followedByAny<span class="token punctuation">(</span><span class="token string">&quot;follow&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span>where<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>temperature<span class="token punctuation">.</span>toInt <span class="token operator">&gt;=</span> <span class="token number">40</span><span class="token punctuation">)</span>                                             <span class="token punctuation">.</span>within<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>minutes<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:模式检测，将模式应用到流中</span>
    <span class="token keyword">val</span> patternResult<span class="token operator">:</span> PatternStream<span class="token punctuation">[</span>DeviceDetail<span class="token punctuation">]</span> <span class="token operator">=</span> CEP<span class="token punctuation">.</span>pattern<span class="token punctuation">(</span>deviceStream<span class="token punctuation">,</span>pattern<span class="token punctuation">)</span>

    <span class="token comment">//todo:选取结果</span>
    patternResult<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token keyword">new</span> MyPatternResultFunction<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//todo: 启动</span>
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;startTempeature&quot;</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//自定义PatternSelectFunction</span>
<span class="token keyword">class</span> MyPatternResultFunction <span class="token keyword">extends</span> PatternSelectFunction<span class="token punctuation">[</span>DeviceDetail<span class="token punctuation">,</span>AlarmDevice<span class="token punctuation">]</span><span class="token punctuation">{</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> select<span class="token punctuation">(</span>pattern<span class="token operator">:</span> util<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>DeviceDetail<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> AlarmDevice <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> startDetails<span class="token operator">:</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>DeviceDetail<span class="token punctuation">]</span> <span class="token operator">=</span> pattern<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> followDetails<span class="token operator">:</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>DeviceDetail<span class="token punctuation">]</span> <span class="token operator">=</span> pattern<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;follow&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> thirdDetails<span class="token operator">:</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>DeviceDetail<span class="token punctuation">]</span> <span class="token operator">=</span> pattern<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;third&quot;</span><span class="token punctuation">)</span>

   <span class="token keyword">val</span> startResult<span class="token operator">:</span> DeviceDetail <span class="token operator">=</span> startDetails<span class="token punctuation">.</span>iterator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> followResult<span class="token operator">:</span> DeviceDetail <span class="token operator">=</span> followDetails<span class="token punctuation">.</span>iterator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> thirdResult<span class="token operator">:</span> DeviceDetail <span class="token operator">=</span> thirdDetails<span class="token punctuation">.</span>iterator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>

    println<span class="token punctuation">(</span><span class="token string">&quot;第一条数据: &quot;</span><span class="token operator">+</span>startResult<span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;第二条数据: &quot;</span><span class="token operator">+</span>followResult<span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;第三条数据: &quot;</span><span class="token operator">+</span>thirdResult<span class="token punctuation">)</span>

    AlarmDevice<span class="token punctuation">(</span>thirdResult<span class="token punctuation">.</span>sensorMac<span class="token punctuation">,</span>thirdResult<span class="token punctuation">.</span>deviceMac<span class="token punctuation">,</span>thirdResult<span class="token punctuation">.</span>temperature<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>socket发送数据：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token number">0.52</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">32</span>
<span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">35</span>
<span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">38</span>
<span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">39</span>
<span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">52</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">41</span>
<span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">53</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">43</span>
<span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">46</span>
</code></pre></div><p>输出结果如下，发送倒数第二条的53度的数据时，输出了一组信息，发送最后一条53度的数据时，产生了3种组合的输出，这个就是followByAny的作用效果，可以忽略已经匹配的条件。</p> <p><strong>注意：发送最后一条31度的数据才能触发打印，说明CEP是前闭后开的。</strong></p> <div class="language-scala extra-class"><pre class="language-scala"><code>第一条数据<span class="token operator">:</span> DeviceDetail<span class="token punctuation">(</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">35</span><span class="token punctuation">)</span>
第二条数据<span class="token operator">:</span> <span class="token punctuation">[</span>DeviceDetail<span class="token punctuation">(</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">38</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
第三条数据<span class="token operator">:</span> DeviceDetail<span class="token punctuation">(</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">52</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">41</span><span class="token punctuation">)</span>
AlarmDevice<span class="token punctuation">(</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">52</span><span class="token punctuation">)</span>

第一条数据<span class="token operator">:</span> DeviceDetail<span class="token punctuation">(</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">35</span><span class="token punctuation">)</span>
第二条数据<span class="token operator">:</span> <span class="token punctuation">[</span>DeviceDetail<span class="token punctuation">(</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">38</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
第三条数据<span class="token operator">:</span> DeviceDetail<span class="token punctuation">(</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">53</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">43</span><span class="token punctuation">)</span>
AlarmDevice<span class="token punctuation">(</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">53</span><span class="token punctuation">)</span>
第一条数据<span class="token operator">:</span> DeviceDetail<span class="token punctuation">(</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">35</span><span class="token punctuation">)</span>
第二条数据<span class="token operator">:</span> <span class="token punctuation">[</span>DeviceDetail<span class="token punctuation">(</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">52</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">41</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
第三条数据<span class="token operator">:</span> DeviceDetail<span class="token punctuation">(</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">53</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">43</span><span class="token punctuation">)</span>
AlarmDevice<span class="token punctuation">(</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">53</span><span class="token punctuation">)</span>
第一条数据<span class="token operator">:</span> DeviceDetail<span class="token punctuation">(</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">38</span><span class="token punctuation">)</span>
第二条数据<span class="token operator">:</span> <span class="token punctuation">[</span>DeviceDetail<span class="token punctuation">(</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">52</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">41</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
第三条数据<span class="token operator">:</span> DeviceDetail<span class="token punctuation">(</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">53</span><span class="token punctuation">,</span><span class="token number">0.48</span><span class="token punctuation">,</span><span class="token number">1.1</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">43</span><span class="token punctuation">)</span>
AlarmDevice<span class="token punctuation">(</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">34</span><span class="token operator">-</span><span class="token number">5</span>E<span class="token operator">-</span><span class="token number">5F</span><span class="token operator">-</span><span class="token number">89</span><span class="token operator">-</span>A4<span class="token punctuation">,</span><span class="token number">00</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">6</span>C<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span>A6<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">53</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_4-flink-cep综合案例实战2"><a href="#_4-flink-cep综合案例实战2" class="header-anchor">#</a> 4. Flink CEP综合案例实战2</h2> <p>场景介绍</p> <ul><li>在我们的电商系统当中，经常会发现有些订单下单之后没有支付，就会有一个倒计时的时间值，提示你在15分钟之内完成支付，如果没有完成支付，那么该订单就会被取消，主要是因为拍下订单就会减库存，但是如果一直没有支付，那么就会造成库存没有了，别人购买的时候买不到，然后别人一直不支付，就会产生有些人买不到，有些人买到了不付款，最后导致商家一件产品都卖不出去</li></ul> <p>需求</p> <ul><li>创建订单之后15分钟之内一定要付款，否则就取消订单</li></ul> <p>订单数据格式如下:</p> <div class="language- extra-class"><pre class="language-text"><code>20160728001511050311389390,1,2016-07-28 00:15:11,295
20160801000227050311955990,1,2016-07-28 00:16:12,165
20160728001511050311389390,2,2016-07-28 00:18:11,295
20160801000227050311955990,2,2016-07-28 00:18:12,165
20160728001511050311389390,3,2016-07-29 08:06:11,295
20160801000227050311955990,4,2016-07-29 12:21:12,165
20160804114043050311618457,1,2016-07-30 00:16:15,132
20160804114043050311618457,2,2016-07-30 00:47:15,132
20160804114043050311618459,2,2016-08-01 00:49:15,132
</code></pre></div><p>类型字段说明：</p> <ul><li><p>订单编号</p></li> <li><p>订单状态</p> <ul><li>1.创建订单,等待支付</li> <li>2.支付订单完成</li> <li>3.取消订单，申请退款</li> <li>4.已发货</li> <li>5.确认收货，已经完成</li></ul></li> <li><p>订单创建时间</p></li> <li><p>订单金额</p></li></ul> <p><strong>规则：出现 1 创建订单标识之后，紧接着需要在15分钟之内出现 2 支付订单操作，中间允许有其他操作</strong></p> <p>代码开发实现</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>cep</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>FastDateFormat
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span></span><span class="token punctuation">{</span>PatternSelectFunction<span class="token punctuation">,</span> PatternTimeoutFunction<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>CEP<span class="token punctuation">,</span> PatternStream<span class="token punctuation">,</span> pattern<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>cep<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>pattern<span class="token punctuation">.</span></span>Pattern
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span>TimeCharacteristic
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span></span>BoundedOutOfOrdernessTimestampExtractor
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataStream<span class="token punctuation">,</span> KeyedStream<span class="token punctuation">,</span> OutputTag<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>Time


<span class="token comment">/**
  *  订单下单未支付检测
  */</span>

<span class="token keyword">case</span> <span class="token keyword">class</span> OrderDetail<span class="token punctuation">(</span>orderId<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>status<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>orderCreateTime<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>price <span class="token operator">:</span><span class="token builtin">Double</span><span class="token punctuation">)</span>

<span class="token keyword">object</span> OrderTimeOutCheckCEP <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">val</span> format<span class="token operator">:</span> FastDateFormat <span class="token operator">=</span> FastDateFormat<span class="token punctuation">.</span>getInstance<span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token keyword">val</span> environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    environment<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    <span class="token keyword">val</span> sourceStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> keyedStream<span class="token operator">:</span> KeyedStream<span class="token punctuation">[</span>OrderDetail<span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> strings<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span>
      OrderDetail<span class="token punctuation">(</span>strings<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strings<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strings<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strings<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toDouble<span class="token punctuation">)</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span><span class="token keyword">new</span> BoundedOutOfOrdernessTimestampExtractor<span class="token punctuation">[</span>OrderDetail<span class="token punctuation">]</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> OrderDetail<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        format<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>element<span class="token punctuation">.</span>orderCreateTime<span class="token punctuation">)</span><span class="token punctuation">.</span>getTime
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>orderId<span class="token punctuation">)</span>

     <span class="token comment">//定义Pattern模式，指定条件</span>
    <span class="token keyword">val</span> pattern<span class="token operator">:</span> Pattern<span class="token punctuation">[</span>OrderDetail<span class="token punctuation">,</span> OrderDetail<span class="token punctuation">]</span> <span class="token operator">=</span> Pattern<span class="token punctuation">.</span>begin<span class="token punctuation">[</span>OrderDetail<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span>
                                                            <span class="token punctuation">.</span>where<span class="token punctuation">(</span>order <span class="token keyword">=&gt;</span> order<span class="token punctuation">.</span>status<span class="token punctuation">.</span>equals<span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                                            <span class="token punctuation">.</span>followedBy<span class="token punctuation">(</span><span class="token string">&quot;second&quot;</span><span class="token punctuation">)</span>
                                                            <span class="token punctuation">.</span>where<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>status<span class="token punctuation">.</span>equals<span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                                            <span class="token punctuation">.</span>within<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>minutes<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


    <span class="token comment">// 4. 调用select方法，提取事件序列，超时的事件要做报警提示</span>
    <span class="token keyword">val</span> orderTimeoutOutputTag <span class="token operator">=</span> <span class="token keyword">new</span> OutputTag<span class="token punctuation">[</span>OrderDetail<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;orderTimeout&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> patternStream<span class="token operator">:</span> PatternStream<span class="token punctuation">[</span>OrderDetail<span class="token punctuation">]</span> <span class="token operator">=</span> CEP<span class="token punctuation">.</span>pattern<span class="token punctuation">(</span>keyedStream<span class="token punctuation">,</span>pattern<span class="token punctuation">)</span>
    <span class="token keyword">val</span> selectResultStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>OrderDetail<span class="token punctuation">]</span> <span class="token operator">=</span> patternStream
            <span class="token punctuation">.</span>select<span class="token punctuation">(</span>orderTimeoutOutputTag<span class="token punctuation">,</span> <span class="token keyword">new</span> OrderTimeoutPatternFunction<span class="token punctuation">,</span> <span class="token keyword">new</span> OrderPatternFunction<span class="token punctuation">)</span>

     selectResultStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//打印侧输出流数据 过了15分钟还没支付的数据</span>
    selectResultStream<span class="token punctuation">.</span>getSideOutput<span class="token punctuation">(</span>orderTimeoutOutputTag<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//订单超时检测</span>
<span class="token keyword">class</span> OrderTimeoutPatternFunction <span class="token keyword">extends</span> PatternTimeoutFunction<span class="token punctuation">[</span>OrderDetail<span class="token punctuation">,</span>OrderDetail<span class="token punctuation">]</span><span class="token punctuation">{</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> timeout<span class="token punctuation">(</span>pattern<span class="token operator">:</span> util<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>OrderDetail<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> l<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> OrderDetail <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> detail<span class="token operator">:</span> OrderDetail <span class="token operator">=</span> pattern<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>iterator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>
        println<span class="token punctuation">(</span><span class="token string">&quot;超时订单号为&quot;</span> <span class="token operator">+</span> detail<span class="token punctuation">)</span>
        detail
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> OrderPatternFunction <span class="token keyword">extends</span> PatternSelectFunction<span class="token punctuation">[</span>OrderDetail<span class="token punctuation">,</span>OrderDetail<span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> select<span class="token punctuation">(</span>pattern<span class="token operator">:</span> util<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>OrderDetail<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> OrderDetail <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> detail<span class="token operator">:</span> OrderDetail <span class="token operator">=</span> pattern<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;second&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>iterator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span>
        println<span class="token punctuation">(</span><span class="token string">&quot;支付成功的订单为&quot;</span> <span class="token operator">+</span> detail<span class="token punctuation">)</span>
        detail
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>socket发送数据：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token number">20160728001511050311389390</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">295</span>
<span class="token number">20160801000227050311955990</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">165</span>
<span class="token number">20160728001511050311389390</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">295</span>
<span class="token number">20160801000227050311955990</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">165</span>
<span class="token number">20160728001511050311389390</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">29</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">295</span>
<span class="token number">20160801000227050311955990</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">29</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">165</span>
<span class="token number">20160804114043050311618457</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">30</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">132</span>
<span class="token number">20160801000227050311955990</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">30</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">165</span>
<span class="token number">20160804114043050311618457</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">30</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">132</span>
</code></pre></div><p>输出结果：</p> <div class="language-scala extra-class"><pre class="language-scala"><code>支付成功的订单为OrderDetail<span class="token punctuation">(</span><span class="token number">20160728001511050311389390</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">295.0</span><span class="token punctuation">)</span>
OrderDetail<span class="token punctuation">(</span><span class="token number">20160728001511050311389390</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">295.0</span><span class="token punctuation">)</span>
支付成功的订单为OrderDetail<span class="token punctuation">(</span><span class="token number">20160801000227050311955990</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">165.0</span><span class="token punctuation">)</span>
OrderDetail<span class="token punctuation">(</span><span class="token number">20160801000227050311955990</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">165.0</span><span class="token punctuation">)</span>
超时订单号为OrderDetail<span class="token punctuation">(</span><span class="token number">20160804114043050311618457</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">30</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">132.0</span><span class="token punctuation">)</span>
OrderDetail<span class="token punctuation">(</span><span class="token number">20160804114043050311618457</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">30</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">132.0</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_5-实时etl"><a href="#_5-实时etl" class="header-anchor">#</a> 5. 实时ETL</h2> <h5 id="_5-1-需求背景"><a href="#_5-1-需求背景" class="header-anchor">#</a> 5.1 需求背景</h5> <ul><li><p>针对应用产生的日志数据进行清洗拆分</p> <p>•1、应用产生的<strong>日志数据是嵌套json格式，需要拆分打平</strong></p> <p>•2、针对日志数据中的<strong>国家字段进行大区转换</strong></p> <p>•3、把<strong>数据回写到Kafka</strong></p></li></ul> <h5 id="_5-2-数据准备"><a href="#_5-2-数据准备" class="header-anchor">#</a> 5.2 数据准备</h5> <ul><li><p>reids码表格式(元数据)：</p> <ul><li><p>启动redis服务</p> <div class="language-shell extra-class"><pre class="language-shell"><code>/kkb/install/redis-5.0.8/src/redis-server /kkb/install/redis-5.0.8/redis.conf
</code></pre></div></li></ul></li> <li><p>进入redis客户端</p> <div class="language- extra-class"><pre class="language-text"><code>/kkb/install/redis-5.0.8/src/redis-cli -h node01
</code></pre></div></li> <li><p>插入以下数据到redis当中去</p> <div class="language-sh extra-class"><pre class="language-sh"><code>          <span class="token comment">#大区    国家</span>
hset areas AREA_US US
hset areas AREA_CT TW,HK
hset areas AREA_AR PK,KW,SA
hset areas AREA_IN IN
<span class="token comment">## hset key field value</span>
</code></pre></div></li> <li><p>查询redis当中的数据</p> <div class="language- extra-class"><pre class="language-text"><code> HKEYS areas
 HGETALL areas
 
 127.0.0.1:6379&gt; Hkeys areas
1) &quot;AREA_US&quot;
2) &quot;AREA_CT&quot;
3) &quot;AREA_AR&quot;
4) &quot;AREA_IN&quot;
</code></pre></div></li> <li><p>node01执行以下命令，创建kafka的topic</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kafka-topics.sh --create --partitions <span class="token number">2</span> --topic data1 --replication-factor <span class="token number">2</span> --zookeeper node01:2181,node02:2181,node03:2181  <span class="token comment">#要事先启动kafka</span>
</code></pre></div></li></ul> <h5 id="_5-3-项目架构"><a href="#_5-3-项目架构" class="header-anchor">#</a> 5.3 项目架构</h5> <p><img src="/assets/img/image-20200512112853825.3385650a.png" alt="image-20200512112853825"></p> <h5 id="_5-4-方案实现"><a href="#_5-4-方案实现" class="header-anchor">#</a> 5.4 方案实现</h5> <ul><li>日志格式：</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>原始数据结构如下：
第一条数据：
<span class="token punctuation">{</span><span class="token string">&quot;dt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2019-11-19 20:33:41&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;countryCode&quot;</span><span class="token operator">:</span><span class="token string">&quot;KW&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;data&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;s2&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;score&quot;</span><span class="token operator">:</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token string">&quot;level&quot;</span><span class="token operator">:</span><span class="token string">&quot;A&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;s1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;score&quot;</span><span class="token operator">:</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token string">&quot;level&quot;</span><span class="token operator">:</span><span class="token string">&quot;D&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

第二条数据：
<span class="token punctuation">{</span><span class="token string">&quot;dt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2019-11-19 20:33:43&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;countryCode&quot;</span><span class="token operator">:</span><span class="token string">&quot;HK&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;data&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;s5&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;score&quot;</span><span class="token operator">:</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token string">&quot;level&quot;</span><span class="token operator">:</span><span class="token string">&quot;C&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;s2&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;score&quot;</span><span class="token operator">:</span><span class="token number">0.8</span><span class="token punctuation">,</span><span class="token string">&quot;level&quot;</span><span class="token operator">:</span><span class="token string">&quot;B&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

需要我们对数据做ETL处理，将数据拉平

<span class="token string">&quot;dt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2019-11-19 20:33:41&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;countryCode&quot;</span><span class="token operator">:</span><span class="token string">&quot;KW&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;s2&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;score&quot;</span><span class="token operator">:</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token string">&quot;level&quot;</span><span class="token operator">:</span><span class="token string">&quot;A&quot;</span>
<span class="token string">&quot;dt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2019-11-19 20:33:41&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;countryCode&quot;</span><span class="token operator">:</span><span class="token string">&quot;KW&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;s1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;score&quot;</span><span class="token operator">:</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token string">&quot;level&quot;</span><span class="token operator">:</span><span class="token string">&quot;D&quot;</span>

让后将countryCode第二步处理，替换成为大区ID

<span class="token string">&quot;dt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2019-11-19 20:33:41&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;countryCode&quot;</span><span class="token operator">:</span><span class="token string">&quot;AREA_CT&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;s2&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;score&quot;</span><span class="token operator">:</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token string">&quot;level&quot;</span><span class="token operator">:</span><span class="token string">&quot;A&quot;</span>
<span class="token string">&quot;dt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2019-11-19 20:33:41&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;countryCode&quot;</span><span class="token operator">:</span><span class="token string">&quot;AREA_CT&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;s1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;score&quot;</span><span class="token operator">:</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token string">&quot;level&quot;</span><span class="token operator">:</span><span class="token string">&quot;D&quot;</span>

使用redis将数据进行广播，然后通过分布式缓存，通过KW查询出对应的AREA_CT出来，进行替换即可，处理完成之后的数据继续写回到kafka里面去
</code></pre></div><h6 id="pom依赖"><a href="#pom依赖" class="header-anchor">#</a> pom依赖</h6> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-streaming-java_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-scala_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-streaming-scala_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.bahir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-connector-redis_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-statebackend-rocksdb_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-connector-kafka-0.11_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kafka-clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.11.0.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- 日志相关依赖 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>slf4j-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.7.25<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>slf4j-log4j12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.7.25<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- redis依赖 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- json依赖 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.44<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

            <span class="token comment">&lt;!--es依赖--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-connector-elasticsearch6_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>


    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>testExcludes</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>testExclude</span><span class="token punctuation">&gt;</span></span>/src/test/**<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>testExclude</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>testExcludes</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoding</span><span class="token punctuation">&gt;</span></span>utf-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoding</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.alchim31.maven<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>scala-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>compile-scala<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>add-source<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>test-compile-scala<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>test-compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>add-source<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>testCompile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scalaVersion</span><span class="token punctuation">&gt;</span></span>${scala.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scalaVersion</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-assembly-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>jar-with-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>make-assembly<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- this is used for inheritance merges --&gt;</span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- 指定在打包节点执行jar包合并操作 --&gt;</span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>single<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h6 id="kafka-producer代码开发"><a href="#kafka-producer代码开发" class="header-anchor">#</a> kafka producer代码开发</h6> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kkb<span class="token punctuation">.</span>producer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 模拟数据源
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MykafkaProducer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        <span class="token class-name">Properties</span> prop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//指定kafka broker地址</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;bootstrap.servers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;node01:9092,node02:9092,node03:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//指定key value的序列化方式</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;key.serializer&quot;</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;value.serializer&quot;</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//指定topic名称</span>
        <span class="token class-name">String</span> topic <span class="token operator">=</span> <span class="token string">&quot;data1&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">//创建producer链接</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//{&quot;dt&quot;:&quot;2018-01-01 10:11:11&quot;,&quot;countryCode&quot;:&quot;US&quot;,&quot;data&quot;:[{&quot;type&quot;:&quot;s1&quot;,&quot;score&quot;:0.3,&quot;level&quot;:&quot;A&quot;},{&quot;type&quot;:&quot;s2&quot;,&quot;score&quot;:0.2,&quot;level&quot;:&quot;B&quot;}]}</span>


        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;{\&quot;dt\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,\&quot;countryCode\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">getCountryCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,\&quot;data\&quot;:[{\&quot;type\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">getRandomType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,\&quot;score\&quot;:&quot;</span><span class="token operator">+</span><span class="token function">getRandomScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;,\&quot;level\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">getRandomLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;},{\&quot;type\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">getRandomType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,\&quot;score\&quot;:&quot;</span><span class="token operator">+</span><span class="token function">getRandomScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;,\&quot;level\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">getRandomLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;}]}&quot;</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//同步的方式，往Kafka里面生产数据</span>
           producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


           <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//关闭链接</span>
        <span class="token comment">//producer.close();</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getCountryCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> types <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;US&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;TW&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;HK&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;PK&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;KW&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;SA&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;IN&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> types<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getRandomType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> types <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;s1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;s2&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;s3&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;s4&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;s5&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> types<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">double</span> <span class="token function">getRandomScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> types <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> types<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getRandomLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> types <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;A&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;A+&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;B&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;C&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;D&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> types<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre></div><h6 id="redis-source代码开发"><a href="#redis-source代码开发" class="header-anchor">#</a> redis source代码开发</h6> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kkb<span class="token punctuation">.</span>source</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span><span class="token class-name">SourceFunction</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span><span class="token class-name">Jedis</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span></span><span class="token class-name">JedisConnectionException</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>

<span class="token comment">/**
 *
 * hset areas AREA_US US
 * hset areas AREA_CT TW,HK
 * hset areas AREA_AR PK,KW,SA
 * hset areas AREA_IN IN
 *
 * HashMap
 *
 * US，AREA_US
 * TW，AREA_CT
 * HK，AREA_CT
 * HashMap&lt;String,String&gt;----&gt;The type of the elements produced by this source.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KkbRedisSource</span> <span class="token keyword">implements</span> <span class="token class-name">SourceFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HashMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger<span class="token operator">=</span><span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">KkbRedisSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Jedis</span> jedis<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> isRunning<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SourceContext</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HashMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> cxt<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>isRunning<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">try</span><span class="token punctuation">{</span>
              map<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> areas <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">hgetAll</span><span class="token punctuation">(</span><span class="token string">&quot;areas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> entry<span class="token operator">:</span> areas<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                  <span class="token class-name">String</span> area <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token class-name">String</span> value <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> country<span class="token operator">:</span>fields<span class="token punctuation">)</span><span class="token punctuation">{</span>
                      <span class="token comment">//</span>
                      map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>country<span class="token punctuation">,</span>area<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>

              <span class="token punctuation">}</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
                  cxt<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JedisConnectionException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
              logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;redis连接异常&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span><span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
              logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;数据源异常&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isRunning<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>jedis <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h6 id="etl处理代码开发"><a href="#etl处理代码开发" class="header-anchor">#</a> ETL处理代码开发</h6> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kkb<span class="token punctuation">.</span>core</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONArray</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>kkb<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span><span class="token class-name">KkbRedisSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">SimpleStringSchema</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">CheckpointingMode</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStreamSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">CheckpointConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>co<span class="token punctuation">.</span></span><span class="token class-name">CoFlatMapFunction</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span></span><span class="token class-name">FlinkKafkaConsumer011</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span></span><span class="token class-name">FlinkKafkaProducer011</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>internals<span class="token punctuation">.</span></span><span class="token class-name">KeyedSerializationSchemaWrapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 数据清洗
 *
 *
 * 码表
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataClean</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//我们是从Kafka里面读取数据，所以这儿就是topic有多少个partition，那么就设置几个并行度。</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * flink整合kafka，将kafka的offset保存到了checkPoint里面去了
         */</span>
        env<span class="token punctuation">.</span><span class="token function">enableCheckpointing</span><span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCheckpointingMode</span><span class="token punctuation">(</span><span class="token class-name">CheckpointingMode</span><span class="token punctuation">.</span>EXACTLY_ONCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMinPauseBetweenCheckpoints</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaxConcurrentCheckpoints</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enableExternalizedCheckpoints</span><span class="token punctuation">(</span><span class="token class-name">CheckpointConfig<span class="token punctuation">.</span>ExternalizedCheckpointCleanup</span><span class="token punctuation">.</span>RETAIN_ON_CANCELLATION<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//第一步：从Kafka里面读取数据 消费者 数据源需要kafka</span>
        <span class="token comment">//topic的取名还是有讲究的，最好就是让人根据这个名字就能知道里面有什么数据。</span>
        <span class="token class-name">String</span> topic<span class="token operator">=</span><span class="token string">&quot;data1&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Properties</span> consumerProperties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumerProperties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;bootstrap.servers&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;node01:9092,node02:9092,node03:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumerProperties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;allTopic_consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumerProperties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;enable.auto.commit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumerProperties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;auto.offset.reset&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;earliest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * String topic, 主题
         * KafkaDeserializationSchema&lt;T&gt; deserializer,
         * Properties props
         */</span>
        <span class="token class-name">FlinkKafkaConsumer011</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlinkKafkaConsumer011</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                consumerProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//读取kafka中的数据</span>
        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> allData <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span>consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//读取redis数据，设置为广播变量</span>
        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HashMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mapData <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KkbRedisSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//实现把2个流连起来</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> etlData <span class="token operator">=</span> allData
                                                        <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>mapData<span class="token punctuation">)</span>
                                                        <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CoFlatMapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> allMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//里面处理的是kafka的数据</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flatMap1</span><span class="token punctuation">(</span><span class="token class-name">String</span> line<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> dt <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;dt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> countryCode <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;countryCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//可以根据countryCode获取大区的名字</span>
                <span class="token class-name">String</span> area <span class="token operator">=</span> allMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>countryCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">JSONArray</span> data <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getJSONArray</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">JSONObject</span> dataObject <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;大区：&quot;</span><span class="token operator">+</span>area<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    dataObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;dt&quot;</span><span class="token punctuation">,</span> dt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    dataObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;area&quot;</span><span class="token punctuation">,</span> area<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//下游获取到数据的时候，也就是一个json格式的数据</span>
                    out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>dataObject<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//里面处理的是redis里面的数据</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flatMap2</span><span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">,</span>
                                 <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> collector<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                allMap <span class="token operator">=</span> map<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//ETL -&gt; load kafka</span>
        etlData<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * String topicId,
         * SerializationSchema&lt;IN&gt; serializationSchema,
         * Properties producerConfig)
         */</span>
<span class="token comment">//        String outputTopic=&quot;allDataClean&quot;;</span>
<span class="token comment">//        Properties producerProperties = new Properties();</span>
<span class="token comment">//        producerProperties.put(&quot;bootstrap.servers&quot;,&quot;192.168.167.254:9092&quot;);</span>
<span class="token comment">//        FlinkKafkaProducer011&lt;String&gt; producer = new FlinkKafkaProducer011&lt;&gt;(outputTopic,</span>
<span class="token comment">//                new KeyedSerializationSchemaWrapper&lt;String&gt;(new SimpleStringSchema()),</span>
<span class="token comment">//                producerProperties);java</span>
<span class="token comment">//</span>
<span class="token comment">//        //搞一个Kafka的生产者</span>
<span class="token comment">//        etlData.addSink(producer);</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">&quot;DataClean&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>运行producer程序，然后运行ETL程序，部分输出结果如下：</p> <div class="language-scala extra-class"><pre class="language-scala"><code>大区：AREA_AR
大区：AREA_AR
<span class="token punctuation">{</span><span class="token string">&quot;dt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2020-05-12 14:17:09&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;area&quot;</span><span class="token operator">:</span><span class="token string">&quot;AREA_AR&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;score&quot;</span><span class="token operator">:</span><span class="token number">0.8</span><span class="token punctuation">,</span><span class="token string">&quot;level&quot;</span><span class="token operator">:</span><span class="token string">&quot;A&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;s3&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;dt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2020-05-12 14:17:09&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;area&quot;</span><span class="token operator">:</span><span class="token string">&quot;AREA_AR&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;score&quot;</span><span class="token operator">:</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token string">&quot;level&quot;</span><span class="token operator">:</span><span class="token string">&quot;B&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;s1&quot;</span><span class="token punctuation">}</span>
大区：AREA_US
大区：AREA_US
<span class="token punctuation">{</span><span class="token string">&quot;dt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2020-05-12 14:17:11&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;area&quot;</span><span class="token operator">:</span><span class="token string">&quot;AREA_US&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;score&quot;</span><span class="token operator">:</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token string">&quot;level&quot;</span><span class="token operator">:</span><span class="token string">&quot;A+&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;s2&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;dt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2020-05-12 14:17:11&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;area&quot;</span><span class="token operator">:</span><span class="token string">&quot;AREA_US&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;score&quot;</span><span class="token operator">:</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token string">&quot;level&quot;</span><span class="token operator">:</span><span class="token string">&quot;D&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;s4&quot;</span><span class="token punctuation">}</span>
</code></pre></div><p><strong>本次ETL flink案例，建议直接copy pom依赖来建立maven工程，否则容易出现依赖包版本的问题，从而导致程序运行失败。</strong></p> <h2 id="_6-实时报表"><a href="#_6-实时报表" class="header-anchor">#</a> 6  实时报表</h2> <h5 id="_6-1-需求背景"><a href="#_6-1-需求背景" class="header-anchor">#</a> 6.1 需求背景</h5> <p>主要针对直播/短视频平台审核指标的统计</p> <ul><li><p>1、统计不同大区每1 min内过审(上架)视频的数据量（单词的个数）</p> <ul><li>每分钟【1:事件时间 2:加上水位，这样的话，我们可以挽救一些数据。3:收集数据延迟过多的数据】的不同大区的【有效视频】的数量（单词计数）</li></ul></li> <li><p>2、统计不同大区每1 min内未过审(下架)的数据量</p></li></ul> <h5 id="_6-3-方案实现"><a href="#_6-3-方案实现" class="header-anchor">#</a> 6.3 方案实现</h5> <ul><li>1、统计的过去的一分钟的每个大区的有效视频数量</li> <li>2、统计的过去的一分钟的每个大区的,不同类型的有效视频数量</li></ul> <p>统计的过去一分钟的每个单词出现次数。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token punctuation">{</span><span class="token string">&quot;dt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2020-04-30 15:42:12&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;type4&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;username&quot;</span><span class="token operator">:</span><span class="token string">&quot;username1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;area&quot;</span><span class="token operator">:</span><span class="token string">&quot;AREA_CT&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;dt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2020-04-30 15:42:12&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;type1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;username&quot;</span><span class="token operator">:</span><span class="token string">&quot;username1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;area&quot;</span><span class="token operator">:</span><span class="token string">&quot;AREA_AR&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;dt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2020-04-30 15:42:13&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;type4&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;username&quot;</span><span class="token operator">:</span><span class="token string">&quot;username5&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;area&quot;</span><span class="token operator">:</span><span class="token string">&quot;AREA_US&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;dt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2020-04-30 15:42:13&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;type4&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;username&quot;</span><span class="token operator">:</span><span class="token string">&quot;username4&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;area&quot;</span><span class="token operator">:</span><span class="token string">&quot;AREA_AR&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;dt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2020-04-30 15:42:14&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;type3&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;username&quot;</span><span class="token operator">:</span><span class="token string">&quot;username5&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;area&quot;</span><span class="token operator">:</span><span class="token string">&quot;AREA_IN&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;dt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2020-04-30 15:42:14&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;type1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;username&quot;</span><span class="token operator">:</span><span class="token string">&quot;username5&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;area&quot;</span><span class="token operator">:</span><span class="token string">&quot;AREA_IN&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;dt&quot;</span><span class="token operator">:</span><span class="token string">&quot;2020-04-30 15:42:15&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;type4&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;username&quot;</span><span class="token operator">:</span><span class="token string">&quot;username1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;area&quot;</span><span class="token operator">:</span><span class="token string">&quot;AREA_CT&quot;</span><span class="token punctuation">}</span>
</code></pre></div><ul><li>node01执行以下命令创建kafka的topic</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>kafka-topics.sh --create --partitions <span class="token number">2</span> --topic data2 --replication-factor <span class="token number">2</span> --zookeeper node01:2181,node02:2181,node03:2181
</code></pre></div><h6 id="pom文件"><a href="#pom文件" class="header-anchor">#</a> pom文件：</h6> <div class="language-xml extra-class"><pre class="language-xml"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>flink.version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>flink.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scala.version</span><span class="token punctuation">&gt;</span></span>2.11.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scala.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-streaming-java_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-scala_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-streaming-scala_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.bahir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-connector-redis_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-statebackend-rocksdb_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-connector-kafka-0.11_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kafka-clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.11.0.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- 日志相关依赖 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>slf4j-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.7.25<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>slf4j-log4j12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.7.25<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- redis依赖 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- json依赖 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.44<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

            <span class="token comment">&lt;!--es依赖--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-connector-elasticsearch6_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>testExcludes</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>testExclude</span><span class="token punctuation">&gt;</span></span>/src/test/**<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>testExclude</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>testExcludes</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoding</span><span class="token punctuation">&gt;</span></span>utf-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoding</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.alchim31.maven<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>scala-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>compile-scala<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>add-source<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>test-compile-scala<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>test-compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>add-source<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>testCompile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scalaVersion</span><span class="token punctuation">&gt;</span></span>${scala.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scalaVersion</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-assembly-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>jar-with-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>make-assembly<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- this is used for inheritance merges --&gt;</span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!-- 指定在打包节点执行jar包合并操作 --&gt;</span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>single<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><h6 id="datareport-核心代码"><a href="#datareport-核心代码" class="header-anchor">#</a> DataReport 核心代码</h6> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kkb<span class="token punctuation">.</span>core</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>kkb<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span><span class="token class-name">MySumFuction</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>kkb<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span><span class="token class-name">MyWaterMark</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">MapFunction</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">SimpleStringSchema</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple3</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple4</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">RocksDBStateBackend</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">CheckpointingMode</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">TimeCharacteristic</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStreamSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">SingleOutputStreamOperator</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">CheckpointConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span></span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Time</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span></span><span class="token class-name">FlinkKafkaConsumer011</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span></span><span class="token class-name">FlinkKafkaProducer011</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>internals<span class="token punctuation">.</span></span><span class="token class-name">KeyedSerializationSchemaWrapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">OutputTag</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">ParseException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * ETL:对数据进行预处理
 * 报表：就是要计算一些指标
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataReport</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>


        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">enableCheckpointing</span><span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCheckpointingMode</span><span class="token punctuation">(</span><span class="token class-name">CheckpointingMode</span><span class="token punctuation">.</span>EXACTLY_ONCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMinPauseBetweenCheckpoints</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaxConcurrentCheckpoints</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enableExternalizedCheckpoints</span><span class="token punctuation">(</span>
                <span class="token class-name">CheckpointConfig<span class="token punctuation">.</span>ExternalizedCheckpointCleanup</span><span class="token punctuation">.</span>RETAIN_ON_CANCELLATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//env.setStateBackend(new RocksDBStateBackend(&quot;&quot;));</span>
        <span class="token comment">//设置time</span>
        env<span class="token punctuation">.</span><span class="token function">setStreamTimeCharacteristic</span><span class="token punctuation">(</span><span class="token class-name">TimeCharacteristic<span class="token punctuation">.</span>EventTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> topic<span class="token operator">=</span><span class="token string">&quot;data2&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Properties</span> consumerProperties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumerProperties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;bootstrap.servers&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;node01:9092,node02:9092,node03:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumerProperties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;auditLog_consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumerProperties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;enable.auto.commit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumerProperties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;auto.offset.reset&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;earliest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//读取Kafka里面对数据</span>
        <span class="token comment">//{&quot;dt&quot;:&quot;2019-11-24 21:19:47&quot;,&quot;type&quot;:&quot;child_unshelf&quot;,&quot;username&quot;:&quot;shenhe1&quot;,&quot;area&quot;:&quot;AREA_ID&quot;}</span>
        <span class="token class-name">FlinkKafkaConsumer011</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">FlinkKafkaConsumer011</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>consumerProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span>consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Logger</span> logger<span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">DataReport</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//对数据进行处理</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> preData <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/**
             * Long:time
             * String: type
             * String: area
             * @return
             * @throws Exception
             */</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Tuple3</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span> line<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> dt <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;dt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//按照这两个字段进行分组</span>
                <span class="token class-name">String</span> type <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> area <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;area&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">long</span> time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    time <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;时间解析失败，dt:&quot;</span> <span class="token operator">+</span> dt<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token class-name">Tuple3</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> type<span class="token punctuation">,</span> area<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         *过滤无效的数据  tuple3.f0指的是第一个字段time
         */</span>
        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> filterData <span class="token operator">=</span> preData<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>tuple3 <span class="token operator">-&gt;</span> tuple3<span class="token punctuation">.</span>f0 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">/**
         * 收集迟到太久的数据
         */</span>
        <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> outputTag<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;late-date&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 进行窗口的统计操作
         * 统计的过去的一分钟的每个大区的,不同类型的有效视频数量
         */</span>

        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple4</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resultData <span class="token operator">=</span> filterData<span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyWaterMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">//type   area</span>
                <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sideOutputLateData</span><span class="token punctuation">(</span>outputTag<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MySumFuction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * 收集到延迟太多的数据，业务里面要求写到Kafka
         */</span>

        <span class="token class-name">SingleOutputStreamOperator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sideOutput <span class="token operator">=</span>
                <span class="token comment">//java8</span>
                resultData<span class="token punctuation">.</span><span class="token function">getSideOutput</span><span class="token punctuation">(</span>outputTag<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> line<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        String outputTopic=&quot;lateData&quot;;</span>
<span class="token comment">//        Properties producerProperties = new Properties();</span>
<span class="token comment">//        producerProperties.put(&quot;bootstrap.servers&quot;,&quot;node01:9092&quot;);</span>
<span class="token comment">//        FlinkKafkaProducer011&lt;String&gt; producer = new FlinkKafkaProducer011&lt;&gt;(outputTopic,</span>
<span class="token comment">//                new KeyedSerializationSchemaWrapper&lt;String&gt;(new SimpleStringSchema()),</span>
<span class="token comment">//                producerProperties);</span>
<span class="token comment">//        sideOutput.addSink(producer);</span>

        resultData<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">&quot;DataReport&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h6 id="producerdatareport-生产消息"><a href="#producerdatareport-生产消息" class="header-anchor">#</a> ProducerDataReport 生产消息</h6> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kkb<span class="token punctuation">.</span>source</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span><span class="token punctuation">;</span>

<span class="token comment">/**
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerDataReport</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        <span class="token class-name">Properties</span> prop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//指定kafka broker地址</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;bootstrap.servers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;node01:9092,node02:9092,node03:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//指定key value的序列化方式</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;key.serializer&quot;</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        prop<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;value.serializer&quot;</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//指定topic名称</span>
        <span class="token class-name">String</span> topic <span class="token operator">=</span> <span class="token string">&quot;data2&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">//创建producer链接</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//{&quot;dt&quot;:&quot;2018-01-01 10:11:22&quot;,&quot;type&quot;:&quot;shelf&quot;,&quot;username&quot;:&quot;shenhe1&quot;,&quot;area&quot;:&quot;AREA_US&quot;}</span>

        <span class="token comment">//生产消息</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;{\&quot;dt\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,\&quot;type\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">getRandomType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,\&quot;username\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">getRandomUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,\&quot;area\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token function">getRandomArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;}&quot;</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//关闭链接</span>
        <span class="token comment">//producer.close();</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getRandomArea</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> types <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;AREA_US&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;AREA_CT&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;AREA_AR&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;AREA_IN&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;AREA_ID&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> types<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getRandomType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> types <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;type1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type2&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type3&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type4&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;type5&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> types<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getRandomUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> types <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;username1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;username2&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;username3&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;username4&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;username5&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> types<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre></div><h6 id="mywatermark-设置水位线"><a href="#mywatermark-设置水位线" class="header-anchor">#</a> MyWaterMark  设置水位线</h6> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kkb<span class="token punctuation">.</span>watermark</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple3</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">AssignerWithPeriodicWatermarks</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>watermark<span class="token punctuation">.</span></span><span class="token class-name">Watermark</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Nullable</span><span class="token punctuation">;</span>

<span class="token comment">/**
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyWaterMark</span>
        <span class="token keyword">implements</span> <span class="token class-name">AssignerWithPeriodicWatermarks</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">long</span> currentMaxTimestamp<span class="token operator">=</span><span class="token number">0L</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token keyword">long</span> maxOutputOfOrderness<span class="token operator">=</span><span class="token number">20000L</span><span class="token punctuation">;</span><span class="token comment">//允许乱序时间</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Watermark</span> <span class="token function">getCurrentWatermark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Watermark</span><span class="token punctuation">(</span>currentMaxTimestamp <span class="token operator">-</span> maxOutputOfOrderness<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractTimestamp</span><span class="token punctuation">(</span><span class="token class-name">Tuple3</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> element<span class="token punctuation">,</span> <span class="token keyword">long</span> l<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> timeStamp <span class="token operator">=</span> element<span class="token punctuation">.</span>f0<span class="token punctuation">;</span>
        currentMaxTimestamp<span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>timeStamp<span class="token punctuation">,</span>currentMaxTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> timeStamp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h6 id="mysumfunction"><a href="#mysumfunction" class="header-anchor">#</a> MySumFunction</h6> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kkb<span class="token punctuation">.</span>function</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple3</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple4</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span></span><span class="token class-name">WindowFunction</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span><span class="token class-name">TimeWindow</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * IN,输入的数据类型
 * OUT,输出的数据类型
 * KEY,在flink里面这儿其实就是分组的字段，大家永远看到的是一个tuple字段
 *  只不过，如果你的分组的字段是有一个，那么这个tuple里面就只会有一个字段
 *  如果说你的分组的字段有多个，那么这个里面就会有多个字段。
 * W extends Window
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySumFuction</span> <span class="token keyword">implements</span> <span class="token class-name">WindowFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
        <span class="token class-name">Tuple4</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span><span class="token class-name">Tuple</span><span class="token punctuation">,</span><span class="token class-name">TimeWindow</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Tuple</span> tuple<span class="token punctuation">,</span> <span class="token class-name">TimeWindow</span> timeWindow<span class="token punctuation">,</span>
                      <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> input<span class="token punctuation">,</span>
                      <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple4</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取分组字段信息</span>
        <span class="token class-name">String</span> type <span class="token operator">=</span> tuple<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> area <span class="token operator">=</span> tuple<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple3</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> time <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>timeWindow<span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">Tuple4</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">Tuple4</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> type<span class="token punctuation">,</span> area<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h6 id="部分输出结果"><a href="#部分输出结果" class="header-anchor">#</a> 部分输出结果</h6> <p>启动生产者生产消息程序，启动核心代码，查看输出结果：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span>type3<span class="token punctuation">,</span>AREA_CT<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token number">2</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span>type5<span class="token punctuation">,</span>AREA_CT<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">3</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span>type4<span class="token punctuation">,</span>AREA_IN<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token number">1</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span>type2<span class="token punctuation">,</span>AREA_ID<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">3</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span>type2<span class="token punctuation">,</span>AREA_AR<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token number">2</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span>type3<span class="token punctuation">,</span>AREA_AR<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token number">3</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span>type4<span class="token punctuation">,</span>AREA_ID<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">2</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">12</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">00</span><span class="token punctuation">,</span>type3<span class="token punctuation">,</span>AREA_ID<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MaLunan/press/edit/dev-mln/docs/flink/flink.md" target="_blank" rel="noopener noreferrer">在GitHub 上编辑此页！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">1/19/2021, 1:41:59 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fdd7a502.js" defer></script><script src="/assets/js/16.375b747e.js" defer></script><script src="/assets/js/12.c5d97aa1.js" defer></script>
  </body>
</html>
