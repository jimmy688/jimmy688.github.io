<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ELK日志协议栈 | 个人博客 | JiiiiG</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="自是年少，韶华倾负">
    
    <link rel="preload" href="/assets/css/0.styles.420b7c1f.css" as="style"><link rel="preload" href="/assets/js/app.fdd7a502.js" as="script"><link rel="preload" href="/assets/js/16.375b747e.js" as="script"><link rel="preload" href="/assets/js/25.c9fcaa62.js" as="script"><link rel="prefetch" href="/assets/js/10.bbd38b9e.js"><link rel="prefetch" href="/assets/js/11.f49fc7d3.js"><link rel="prefetch" href="/assets/js/12.c5d97aa1.js"><link rel="prefetch" href="/assets/js/13.426d0224.js"><link rel="prefetch" href="/assets/js/14.1f257a58.js"><link rel="prefetch" href="/assets/js/15.be29bb6a.js"><link rel="prefetch" href="/assets/js/17.d02cdd8b.js"><link rel="prefetch" href="/assets/js/18.5d2371a4.js"><link rel="prefetch" href="/assets/js/19.038919a3.js"><link rel="prefetch" href="/assets/js/2.d6257727.js"><link rel="prefetch" href="/assets/js/20.b3582e09.js"><link rel="prefetch" href="/assets/js/21.0c1e826b.js"><link rel="prefetch" href="/assets/js/22.91bff1a5.js"><link rel="prefetch" href="/assets/js/23.faacea60.js"><link rel="prefetch" href="/assets/js/24.69816497.js"><link rel="prefetch" href="/assets/js/26.d28c3abe.js"><link rel="prefetch" href="/assets/js/27.1518da7d.js"><link rel="prefetch" href="/assets/js/28.748a5581.js"><link rel="prefetch" href="/assets/js/29.775019f1.js"><link rel="prefetch" href="/assets/js/3.141002a4.js"><link rel="prefetch" href="/assets/js/30.74e7c570.js"><link rel="prefetch" href="/assets/js/31.190b11f2.js"><link rel="prefetch" href="/assets/js/32.d8f4f116.js"><link rel="prefetch" href="/assets/js/33.c489bc81.js"><link rel="prefetch" href="/assets/js/34.db609d51.js"><link rel="prefetch" href="/assets/js/35.ad3402e6.js"><link rel="prefetch" href="/assets/js/36.45f11923.js"><link rel="prefetch" href="/assets/js/37.b47e0576.js"><link rel="prefetch" href="/assets/js/38.58b934a2.js"><link rel="prefetch" href="/assets/js/39.e4d6bcdf.js"><link rel="prefetch" href="/assets/js/4.e9b44388.js"><link rel="prefetch" href="/assets/js/40.555106bc.js"><link rel="prefetch" href="/assets/js/41.4387ceb1.js"><link rel="prefetch" href="/assets/js/42.9bd4aea0.js"><link rel="prefetch" href="/assets/js/43.587e7966.js"><link rel="prefetch" href="/assets/js/44.80285763.js"><link rel="prefetch" href="/assets/js/45.f978da77.js"><link rel="prefetch" href="/assets/js/46.d93e3f2e.js"><link rel="prefetch" href="/assets/js/47.c15bd2aa.js"><link rel="prefetch" href="/assets/js/48.cb55fa72.js"><link rel="prefetch" href="/assets/js/49.d0f4e454.js"><link rel="prefetch" href="/assets/js/5.b90b80cb.js"><link rel="prefetch" href="/assets/js/50.112e8260.js"><link rel="prefetch" href="/assets/js/51.a66bcd03.js"><link rel="prefetch" href="/assets/js/52.0c7cbfb1.js"><link rel="prefetch" href="/assets/js/53.67ef240b.js"><link rel="prefetch" href="/assets/js/54.2c2d082d.js"><link rel="prefetch" href="/assets/js/55.88f19a20.js"><link rel="prefetch" href="/assets/js/56.c726e920.js"><link rel="prefetch" href="/assets/js/57.eaee47c5.js"><link rel="prefetch" href="/assets/js/58.ac15a3ac.js"><link rel="prefetch" href="/assets/js/59.64bdc849.js"><link rel="prefetch" href="/assets/js/6.7eea74ff.js"><link rel="prefetch" href="/assets/js/7.a1370e98.js"><link rel="prefetch" href="/assets/js/8.2e898240.js"><link rel="prefetch" href="/assets/js/9.a2439994.js">
    <link rel="stylesheet" href="/assets/css/0.styles.420b7c1f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">个人博客 | JiiiiG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/linux/linux常用命令/01linux常用命令01.html" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/hadoop/01hadoop环境搭建/01搭建hadoop集群.html" class="nav-link">
  hadoop
</a></li><li class="dropdown-item"><!----> <a href="/hbase/hbase.html" class="nav-link">
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/flink/flink.html" class="nav-link">
  flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/elk/.html" class="nav-link">
  java
</a></li></ul></div></div> <a href="https://github.com/MaLunan/press" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/linux/linux常用命令/01linux常用命令01.html" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/hadoop/01hadoop环境搭建/01搭建hadoop集群.html" class="nav-link">
  hadoop
</a></li><li class="dropdown-item"><!----> <a href="/hbase/hbase.html" class="nav-link">
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/flink/flink.html" class="nav-link">
  flink
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/elk/.html" class="nav-link">
  java
</a></li></ul></div></div> <a href="https://github.com/MaLunan/press" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="elk日志协议栈"><a href="#elk日志协议栈" class="header-anchor">#</a> ELK日志协议栈</h2> <h3 id="_1、elk的基本介绍"><a href="#_1、elk的基本介绍" class="header-anchor">#</a> 1、ELK的基本介绍</h3> <p>ELK是三个软件产品的首字母缩写，<strong>Elasticsearch，Logstash 和 Kibana</strong>。这三款软件都是开源软件，通常是配合使用，而且又先后归于 Elastic.co 公司名下，故被简称为 ELK 协议栈。</p> <p>Elasticsearch是个开源<strong>分布式搜索引擎</strong>，它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。</p> <p>Logstash是一个完全开源的工具，他可以<strong>对你的日志进行收集、过滤，并将其存储供以后使用</strong>（如，搜索）。</p> <p>Kibana 也是一个开源和免费的工具，它Kibana可以<strong>为 Logstash 和 ElasticSearch 提供的日志分析友好的 Web 界面</strong>，可以帮助您汇总、分析和搜索重要数据日志。</p> <p>ELK的实现介绍</p> <table><thead><tr><th>ElasticSearch</th> <th>Java</th> <th>实时的分布式搜索和分析引擎，他可以<strong>用于全文检索，结构化搜索以及分析</strong>，lucene。Solr</th></tr></thead> <tbody><tr><td>Logstash</td> <td>JRuby</td> <td>具有实时渠道能力的<strong>数据收集引擎</strong>，包含<strong>输入、过滤、输出</strong>模块，一般在过滤模块中做日志格式化的解析工作</td></tr> <tr><td>Kibana</td> <td>JavaScript</td> <td>为ElasticSerach提供分析平台和可视化的Web平台。他可以ElasticSerach的索引中查找，呼唤数据，并生成各种维度的表图</td></tr></tbody></table> <h3 id="_2、elk日志协议栈整体架构"><a href="#_2、elk日志协议栈整体架构" class="header-anchor">#</a> 2、ELK日志协议栈整体架构</h3> <p><img src="/assets/img/image-20200518225755832.3706a11f.png" alt="image-20200518225755832"></p> <h3 id="_3、elk的参考资料"><a href="#_3、elk的参考资料" class="header-anchor">#</a> 3、ELK的参考资料</h3> <p>ELK官网：https://www.elastic.co/</p> <p>ELK官网文档：https://www.elastic.co/guide/index.html</p> <p>ELK中文手册：https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html</p> <p>ELK中文社区：https://elasticsearch.cn/</p> <h2 id="elasticsearch功能学习"><a href="#elasticsearch功能学习" class="header-anchor">#</a> Elasticsearch功能学习</h2> <h3 id="_1、什么是elasticsearch"><a href="#_1、什么是elasticsearch" class="header-anchor">#</a> 1、什么是ElasticSearch</h3> <p>Elaticsearch，简称为<strong>es</strong>， es是一个开源的<strong>高扩展</strong>的分<strong>布式全文检索引擎</strong>，它可以<strong>近乎实时的存储、检索数据</strong>；本身扩展性很好，<strong>可以扩展到上百台服务器，处理PB级别的数据</strong>。es也使用Java开发并使用Lucene作为其核心来实现所有索引和搜索的功能，但是它的目的是通过简单的RESTful API来隐藏Lucene的复杂性，从而让全文搜索变得简单。</p> <h3 id="_2、elasticsearch使用案例"><a href="#_2、elasticsearch使用案例" class="header-anchor">#</a> 2、ElasticSearch使用案例</h3> <p>•      2013年初，GitHub抛弃了Solr，采取ElasticSearch 来做PB级的搜索。 “GitHub使用ElasticSearch搜索20TB的数据，包括13亿文件和1300亿行代码”</p> <p>•      维基百科：启动以elasticsearch为基础的核心搜索架构</p> <p>•      SoundCloud：“SoundCloud使用ElasticSearch为1.8亿用户提供即时而精准的音乐搜索服务”</p> <p>•      百度：百度目前广泛使用ElasticSearch作为文本数据分析，采集百度所有服务器上的各类指标数据及用户自定义数据，通过对各种数据进行多维分析展示，辅助定位分析实例异常或业务层面异常。目前覆盖百度内部20多个业务线（包括casio、云分析、网盟、预测、文库、直达号、钱包、风控等），单集群最大100台机器，200个ES节点，每天导入30TB+数据</p> <p>•      新浪使用ES 分析处理32亿条实时日志</p> <p>•      阿里使用ES 构建挖财自己的日志采集和分析体系</p> <h3 id="_3、elasticsearch的安装部署"><a href="#_3、elasticsearch的安装部署" class="header-anchor">#</a> 3、Elasticsearch的安装部署</h3> <h4 id="第一步-创建普通用户"><a href="#第一步-创建普通用户" class="header-anchor">#</a> 第一步：创建普通用户</h4> <p>注意：<strong>ES不能使用root用户来启动</strong>，必须使用<strong>普通用户</strong>来安装启动。这里我们使用hadoop用户来安装我们的es服务</p> <h4 id="第二步-下载并上传压缩包-然后解压"><a href="#第二步-下载并上传压缩包-然后解压" class="header-anchor">#</a> 第二步：下载并上传压缩包，然后解压</h4> <p>将es的安装包下载并上传到node01服务器的/kkb/soft</p> <p><strong>node01</strong>服务器使用es用户执行以下命令</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>hadoop@node01 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">cd</span> /kkb/soft/

<span class="token punctuation">[</span>hadoop@node01 soft<span class="token punctuation">]</span>$ <span class="token function">wget</span> https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.7.0.tar.gz

<span class="token punctuation">[</span>hadoop@node01 soft<span class="token punctuation">]</span>$ <span class="token function">tar</span> -zxf elasticsearch-6.7.0.tar.gz -C /kkb/install/
</code></pre></div><h4 id="第三步-修改配置文件"><a href="#第三步-修改配置文件" class="header-anchor">#</a> 第三步：修改配置文件</h4> <h5 id="修改elasticsearch-yml"><a href="#修改elasticsearch-yml" class="header-anchor">#</a> 修改elasticsearch.yml</h5> <p><strong>node01</strong>服务器使用hadoop用户来修改配置文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/elasticsearch-6.7.0/config/

<span class="token function">mkdir</span> -p /kkb/install/elasticsearch-6.7.0/logs/

<span class="token function">mkdir</span> -p /kkb/install/elasticsearch-6.7.0/datas

<span class="token function">vim</span> elasticsearch.yml
</code></pre></div><p>直接添加下列内容：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>cluster.name: myes

node.name: node01

path.data: /kkb/install/elasticsearch-6.7.0/datas

path.logs: /kkb/install/elasticsearch-6.7.0/logs

network.host: <span class="token number">192.168</span>.52.101

http.port: <span class="token number">9200</span>

discovery.zen.ping.unicast.hosts: <span class="token punctuation">[</span><span class="token string">&quot;node01&quot;</span>, <span class="token string">&quot;node02&quot;</span>, <span class="token string">&quot;node03&quot;</span><span class="token punctuation">]</span>

bootstrap.system_call_filter: <span class="token boolean">false</span>

bootstrap.memory_lock: <span class="token boolean">false</span>

http.cors.enabled: <span class="token boolean">true</span>

http.cors.allow-origin: <span class="token string">&quot;*&quot;</span>
</code></pre></div><h5 id="修改jvm-option"><a href="#修改jvm-option" class="header-anchor">#</a> 修改jvm.option</h5> <p>修改jvm.option配置文件，调整jvm堆内存大小</p> <p>node01使用es用户执行以下命令<strong>调整jvm堆内存大小</strong>，每个人根据自己服务器的内存大小来进行调整</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/elasticsearch-6.7.0/config

<span class="token function">vim</span> jvm.options 
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>-Xms2g

-Xmx2g
</code></pre></div><h4 id="第四步-将安装包分发到其他服务器上面"><a href="#第四步-将安装包分发到其他服务器上面" class="header-anchor">#</a> 第四步：将安装包分发到其他服务器上面</h4> <p>node01使用es用户将安装包分发到其他服务器上面去</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/

<span class="token function">scp</span> -r elasticsearch-6.7.0/ node02:<span class="token environment constant">$PWD</span>

<span class="token function">scp</span> -r elasticsearch-6.7.0/ node03:<span class="token environment constant">$PWD</span>
</code></pre></div><h4 id="第五步-node02与node03修改es配置文件"><a href="#第五步-node02与node03修改es配置文件" class="header-anchor">#</a> 第五步：node02与node03修改es配置文件</h4> <p>node02与node03也需要修改es配置文件</p> <p>node02使用hadoop用户执行以下命令修改es配置文件</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/elasticsearch-6.7.0/config/

vim elasticsearch.yml
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>cluster.name: myes

node.name: node02

path.data: /kkb/install/elasticsearch-6.7.0/datas

path.logs: /kkb/install/elasticsearch-6.7.0/logs

network.host: <span class="token number">192.168</span>.52.102

http.port: <span class="token number">9200</span>

discovery.zen.ping.unicast.hosts: <span class="token punctuation">[</span><span class="token string">&quot;node01&quot;</span>, <span class="token string">&quot;node02&quot;</span>, <span class="token string">&quot;node03&quot;</span><span class="token punctuation">]</span>

bootstrap.system_call_filter: <span class="token boolean">false</span>

bootstrap.memory_lock: <span class="token boolean">false</span>

http.cors.enabled: <span class="token boolean">true</span>

http.cors.allow-origin: <span class="token string">&quot;*&quot;</span>
</code></pre></div><p>node03使用hadoop</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/elasticsearch-6.7.0/config/ 

vim elasticsearch.yml
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>cluster.name: myes

node.name: node03

path.data: /kkb/install/elasticsearch-6.7.0/datas

path.logs: /kkb/install/elasticsearch-6.7.0/logs

network.host: <span class="token number">192.168</span>.52.103

http.port: <span class="token number">9200</span>

discovery.zen.ping.unicast.hosts: <span class="token punctuation">[</span><span class="token string">&quot;node01&quot;</span>, <span class="token string">&quot;node02&quot;</span>, <span class="token string">&quot;node03&quot;</span><span class="token punctuation">]</span>

bootstrap.system_call_filter: <span class="token boolean">false</span>

bootstrap.memory_lock: <span class="token boolean">false</span>

http.cors.enabled: <span class="token boolean">true</span>

http.cors.allow-origin: <span class="token string">&quot;*&quot;</span>
</code></pre></div><h4 id="第六步-修改系统配置-解决启动时候的问题"><a href="#第六步-修改系统配置-解决启动时候的问题" class="header-anchor">#</a> 第六步：修改系统配置，解决启动时候的问题</h4> <p>由于现在使用普通用户来安装es服务，且<strong>es服务对服务器的资源要求比较多，包括内存大小，线程数等</strong>。所以我们<strong>需要给普通用户解开资源的束缚</strong></p> <h5 id="解决启动问题一-普通用户打开文件的最大数限制"><a href="#解决启动问题一-普通用户打开文件的最大数限制" class="header-anchor">#</a> 解决启动问题一：普通用户打开文件的最大数限制</h5> <p>问题错误信息描述：</p> <div class="language- extra-class"><pre class="language-text"><code>max file descriptors [4096] for elasticsearch process likely too low, increase to at least [65536]
</code></pre></div><p>ES因为需要大量的创建索引文件，需要大量的打开系统的文件，所以我们需要解除linux系统当中打开文件最大数目的限制，不然ES启动就会抛错</p> <p>三台机器使用es用户执行以下命令解除打开文件数据的限制</p> <div class="language- extra-class"><pre class="language-text"><code>sudo vi /etc/security/limits.conf
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code> * soft nofile <span class="token number">65536</span>
 * hard nofile <span class="token number">131072</span>
 * soft nproc <span class="token number">2048</span>
 * hard nproc <span class="token number">4096</span>
</code></pre></div><h5 id="解决启动问题二-普通用户启动线程数限制"><a href="#解决启动问题二-普通用户启动线程数限制" class="header-anchor">#</a> 解决启动问题二：普通用户启动线程数限制</h5> <p>三台机器执行以下命令打开文件最大数</p> <div class="language- extra-class"><pre class="language-text"><code>sudo vi /etc/sysctl.conf
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>vm.max_map_count<span class="token operator">=</span><span class="token number">655360</span>

fs.file-max<span class="token operator">=</span><span class="token number">655360</span>
</code></pre></div><p>执行以下命令生效</p> <div class="language- extra-class"><pre class="language-text"><code>sudo sysctl -p
</code></pre></div><p>注意：以上两个问题修改完成之后，一定要重新连接linux生效。<strong>关闭secureCRT或者XShell工具，然后重新打开工具连接linux即可</strong></p> <p>重新连接之后执行以下命令，出现这个结果即可准备启动ES了</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>hadoop@node01 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">ulimit</span> -Hn
<span class="token number">131072</span>
<span class="token punctuation">[</span>hadoop@node01 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">ulimit</span> -Sn
<span class="token number">65536</span>
<span class="token punctuation">[</span>hadoop@node01 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">ulimit</span> -Hu
<span class="token number">4096</span>
<span class="token punctuation">[</span>hadoop@node01 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">ulimit</span> -Su
<span class="token number">4096</span>
</code></pre></div><h4 id="第七步-启动es服务"><a href="#第七步-启动es服务" class="header-anchor">#</a> 第七步：启动ES服务</h4> <p><strong>三台机器</strong>使用hadoop用户执行以下命令启动es服务</p> <div class="language- extra-class"><pre class="language-text"><code>nohup /kkb/install/elasticsearch-6.7.0/bin/elasticsearch 2&gt;&amp;1 &amp;
</code></pre></div><p>启动成功之后jps即可看到es的服务进程，并且<strong>访问页面</strong></p> <p>🌈http://node01:9200/?pretty</p> <img src="elk.assets/image-20200518232625435.png" alt="image-20200518232625435" style="zoom:67%;"> <p>能够看到es启动之后的一些信息</p> <p>注意：如果哪一台机器服务启动失败，那么就到哪一台机器的/kkb/install/elasticsearch-6.7.0/logs这个路径下面去查看错误日志</p> <h3 id="_4、安装elasticsearch-head插件"><a href="#_4、安装elasticsearch-head插件" class="header-anchor">#</a> 4、安装elasticsearch-head插件</h3> <p>由于es服务启动之后，<strong>访问界面比较丑陋</strong>，为了更好的查看索引库当中的信息，我们可以通过安装<strong>elasticsearch-head</strong>这个插件来实现，这个插件可以<strong>更方便快捷的看到es的管理界面</strong></p> <h4 id="_1-、node01机器安装nodejs"><a href="#_1-、node01机器安装nodejs" class="header-anchor">#</a> 1 、node01机器安装nodejs</h4> <p>Node.js是一个基于 Chrome V8 引擎的 JavaScript 运行环境。</p> <p><strong>Node.js是一个Javascript运行环境</strong>(runtime environment)，发布于2009年5月，由Ryan Dahl开发，实质是对Chrome V8引擎进行了封装。Node.js 不是一个 JavaScript 框架，不同于CakePHP、Django、Rails。Node.js 更不是浏览器端的库，不能与 jQuery、ExtJS 相提并论。Node.js 是一个让 JavaScript 运行在服务端的开发平台，它让 JavaScript 成为与PHP、Python、Perl、Ruby 等服务端语言平起平坐的脚本语言。</p> <p>安装步骤参考：https://www.cnblogs.com/kevingrace/p/8990169.html</p> <h5 id="第一步-下载安装包"><a href="#第一步-下载安装包" class="header-anchor">#</a> 第一步：下载安装包</h5> <p>node01机器执行以下命令下载安装包，然后进行解压</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/soft/wget https://npm.taobao.org/mirrors/node/v8.1.0/node-v8.1.0-linux-x64.tar.gz

<span class="token function">tar</span> -zxf node-v8.1.0-linux-x64.tar.gz -C /kkb/install/
</code></pre></div><h5 id="第二步-创建软连接"><a href="#第二步-创建软连接" class="header-anchor">#</a> 第二步：创建软连接</h5> <p>node01执行以下命令创建软连接</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">ln</span> -s /kkb/install/node-v8.1.0-linux-x64/lib/node_modules/npm/bin/npm-cli.js /usr/local/bin/npm

<span class="token function">sudo</span> <span class="token function">ln</span> -s /kkb/install/node-v8.1.0-linux-x64/bin/node /usr/local/bin/node
</code></pre></div><h5 id="第三步-修改环境变量"><a href="#第三步-修改环境变量" class="header-anchor">#</a> 第三步：修改环境变量</h5> <p>node01服务器添加环境变量</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">vim</span> /etc/profile
<span class="token builtin class-name">export</span> <span class="token assign-left variable">NODE_HOME</span><span class="token operator">=</span>/kkb/install/node-v8.1.0-linux-x64
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>:<span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$NODE_HOME</span>/bin
</code></pre></div><p>修改完环境变量使用source生效</p> <div class="language- extra-class"><pre class="language-text"><code>source /etc/profile
</code></pre></div><h5 id="第四步-验证安装成功"><a href="#第四步-验证安装成功" class="header-anchor">#</a> 第四步：验证安装成功</h5> <p>node01执行以下命令验证安装生效</p> <div class="language-sh extra-class"><pre class="language-sh"><code>node -v

<span class="token function">npm</span> -v
</code></pre></div><h4 id="_2-、node01机器安装elasticsearch-head插件"><a href="#_2-、node01机器安装elasticsearch-head插件" class="header-anchor">#</a> 2 、node01机器安装elasticsearch-head插件</h4> <p><strong>elasticsearch-head这个插件是es提供的一个用于图形化界面查看的一个插件工具</strong>，可以安装上这个插件之后，通过这个插件来实现我们通过浏览器查看es当中的数据</p> <p>安装elasticsearch-head这个插件这里提供两种方式进行安装，🌈第一种方式就是自己下载源码包进行编译，耗时比较长，网络较差的情况下，基本上不可能安装成功</p> <p>🌈第二种方式就是直接使用我已经编译好的安装包，进行修改配置即可</p> <h5 id="_1、第一种方式-网速慢-不推荐"><a href="#_1、第一种方式-网速慢-不推荐" class="header-anchor">#</a> 1、第一种方式：网速慢，不推荐</h5> <p>这里选择node01进行安装</p> <h6 id="第一步-在线安装必须依赖包"><a href="#第一步-在线安装必须依赖包" class="header-anchor">#</a> 第一步：在线安装必须依赖包</h6> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment">## 初始化目录</span>
<span class="token builtin class-name">cd</span> /kkb/install
<span class="token comment">## 安装GCC</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> -y gcc-c++ <span class="token function">make</span> <span class="token function">git</span>
</code></pre></div><h6 id="第二步-从git上面克隆编译包并进行安装"><a href="#第二步-从git上面克隆编译包并进行安装" class="header-anchor">#</a> 第二步：从git上面克隆编译包并进行安装</h6> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install
<span class="token function">git</span> clone https://github.com/mobz/elasticsearch-head.git
<span class="token comment">## 进入安装目录</span>
<span class="token builtin class-name">cd</span> /kkb/install/elasticsearch-head
<span class="token comment">## intall 才会有 node-modules</span>
<span class="token function">npm</span> <span class="token function">install</span>
</code></pre></div><p><img src="/assets/img/image-20200518233309385.1f075156.png" alt="image-20200518233309385"></p> <p>以下进度信息</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> WARN notice <span class="token punctuation">[</span>SECURITY<span class="token punctuation">]</span> lodash has the following vulnerability: <span class="token number">1</span> low. Go here <span class="token keyword">for</span> <span class="token function">more</span> details: 
<span class="token function">npm</span> WARN notice <span class="token punctuation">[</span>SECURITY<span class="token punctuation">]</span> debug has the following vulnerability: <span class="token number">1</span> low. Go here <span class="token keyword">for</span> <span class="token function">more</span> details: https://nodesecurity.io/advisories?search<span class="token operator">=</span>debug<span class="token operator">&amp;</span><span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token number">0.7</span>.4 - Run <span class="token variable"><span class="token variable">`</span><span class="token function">npm</span> i npm@latest -g<span class="token variable">`</span></span> to upgrade your <span class="token function">npm</span> version, and <span class="token keyword">then</span> <span class="token variable"><span class="token variable">`</span><span class="token function">npm</span> audit<span class="token variable">`</span></span> to get <span class="token function">more</span> info.
<span class="token function">npm</span> ERR<span class="token operator">!</span> Unexpected end of input at <span class="token number">1</span>:2096
<span class="token function">npm</span> ERR<span class="token operator">!</span> 7c1a1bc21c976bb49f3ea<span class="token string">&quot;,&quot;</span>tarball<span class="token string">&quot;:&quot;</span>https://registry.npmjs.org/safer-bu
<span class="token function">npm</span> ERR<span class="token operator">!</span>                                                                      ^
<span class="token function">npm</span> ERR<span class="token operator">!</span> A complete log of this run can be found in:
<span class="token function">npm</span> ERR<span class="token operator">!</span>     /kkb/soft/.npm/_logs/2018-11-27T14_35_39_453Z-debug.log
</code></pre></div><p><strong>以上错误可以不用管。</strong></p> <h6 id="第三步、node01机器修改gruntfile-js"><a href="#第三步、node01机器修改gruntfile-js" class="header-anchor">#</a> 第三步、node01机器修改Gruntfile.js</h6> <p>第一台机器修改Gruntfile.js这个文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/elasticsearch-head

<span class="token function">vim</span> Gruntfile.js
</code></pre></div><p>找到以下代码：</p> <p>添加一行： hostname: '192.168.52.100',</p> <div class="language-sh extra-class"><pre class="language-sh"><code>connect: <span class="token punctuation">{</span>
                        server: <span class="token punctuation">{</span>
                              options: <span class="token punctuation">{</span>
                                     hostname: <span class="token string">'192.168.52.100'</span>,
                                     port: <span class="token number">9100</span>,
                                     base: <span class="token string">'.'</span>,
                                     keepalive: travelue
                                <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

</code></pre></div><h6 id="第四步、node01机器修改app-js"><a href="#第四步、node01机器修改app-js" class="header-anchor">#</a> 第四步、node01机器修改app.js</h6> <p>第一台机器修改app.js</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/elasticsearch-head/_site

vim app.js 
</code></pre></div><p>更改前：http://localhost:9200</p> <p>更改后：http://node01:9200</p> <h5 id="_2、第二种方式-强烈推荐"><a href="#_2、第二种方式-强烈推荐" class="header-anchor">#</a> 2、第二种方式：强烈推荐</h5> <h6 id="第一步-上传压缩包到-kkb-soft路径下去"><a href="#第一步-上传压缩包到-kkb-soft路径下去" class="header-anchor">#</a> 第一步：上传压缩包到/kkb/soft路径下去</h6> <p>将我们的压缩包 <strong>elasticsearch-head-compile-after.tar.gz</strong> 上传到node01机器的/kkb/soft路径下面去</p> <h6 id="第二步-解压安装包"><a href="#第二步-解压安装包" class="header-anchor">#</a> 第二步：解压安装包</h6> <p>node01执行以下命令解压安装包</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/soft/

<span class="token function">tar</span> -zxvf elasticsearch-head-compile-after.tar.gz -C /kkb/install/
</code></pre></div><h6 id="第三步、node01机器修改gruntfile-js-2"><a href="#第三步、node01机器修改gruntfile-js-2" class="header-anchor">#</a> 第三步、node01机器修改Gruntfile.js</h6> <p>修改Gruntfile.js这个文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/elasticsearch-head

<span class="token function">vim</span> Gruntfile.js
</code></pre></div><p>找到以下代码：</p> <p>添加一行： hostname: '192.168.52.101',</p> <div class="language-sh extra-class"><pre class="language-sh"><code>connect: <span class="token punctuation">{</span>
             server: <span class="token punctuation">{</span>
                options: <span class="token punctuation">{</span>
                   hostname: <span class="token string">'192.168.52.101'</span>,
                    port: <span class="token number">9100</span>,
                   base: <span class="token string">'.'</span>,
                   keepalive: <span class="token boolean">true</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
</code></pre></div><h6 id="第四步、node01机器修改app-js-2"><a href="#第四步、node01机器修改app-js-2" class="header-anchor">#</a> 第四步、node01机器修改app.js</h6> <p>第一台机器修改app.js</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/elasticsearch-head/_site

<span class="token function">vim</span> app.js 
</code></pre></div><p>更改前：http://localhost:9200</p> <p>更改后：http://node01:9200</p> <h4 id="_3、node01机器启动head服务"><a href="#_3、node01机器启动head服务" class="header-anchor">#</a> 3、node01机器启动head服务</h4> <p>node01启动elasticsearch-head插件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/elasticsearch-head/node_modules/grunt/bin/
</code></pre></div><p>进程后台启动命令</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">nohup</span> ./grunt server <span class="token operator">&gt;</span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
</code></pre></div><p>如何停止：elasticsearch-head进程</p> <p>执行以下命令找到elasticsearch-head的插件进程，然后使用kill -9 杀死进程即可</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> yum <span class="token function">install</span> net-tools   

<span class="token function">netstat</span> -nltp <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">9100</span>

<span class="token function">kill</span> -9 <span class="token number">8328</span>
</code></pre></div><h4 id="_4、访问elasticsearch-head界面"><a href="#_4、访问elasticsearch-head界面" class="header-anchor">#</a> 4、访问elasticsearch-head界面</h4> <p>打开Google Chrome访问</p> <p>⛈http://192.168.52.101:9100/</p> <p><img src="/assets/img/image-20200518234253283.9844665e.png" alt="image-20200518234253283"></p> <h3 id="_5、node01服务器安装kibana"><a href="#_5、node01服务器安装kibana" class="header-anchor">#</a> 5、node01服务器安装Kibana</h3> <p>kibana的基本介绍</p> <p><strong>Kibana</strong>是一个开源的<strong>分析和可视化平台</strong>，<strong>设计用于和Elasticsearch一起工作。</strong></p> <p>你用Kibana来搜索，查看，并和存储在Elasticsearch索引中的数据进行交互。</p> <p>你可以<strong>轻松地执行高级数据分析，并且以各种图标、表格和地图的形式可视化数据。</strong></p> <p>Kibana使得理解大量数据变得很容易。它简单的、基于浏览器的界面使你<strong>能够快速创建和共享动态仪表板，实时显示Elasticsearch查询的变化。</strong></p> <p>接着使用我们的hadoop用户在node01服务器上面来实现我们的kibana的安装部署</p> <h4 id="第一步-下载资源上传服务器并解压"><a href="#第一步-下载资源上传服务器并解压" class="header-anchor">#</a> 第一步：下载资源上传服务器并解压</h4> <p><strong>node01</strong>服务器使用hadoop用户执行以下命令来下载安装包并解压</p> <p>cd /kkb/soft</p> <p>在线下载</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">wget</span> https://artifacts.elastic.co/downloads/kibana/kibana-6.7.0-linux-x86_64.tar.gz

<span class="token function">tar</span> -zxf kibana-6.7.0-linux-x86_64.tar.gz -C /kkb/install/
</code></pre></div><h4 id="第二步-修改配置文件"><a href="#第二步-修改配置文件" class="header-anchor">#</a> 第二步：修改配置文件</h4> <p>node01服务器使用es用户执行以下命令来修改配置文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/kibana-6.7.0-linux-x86_64/config/
<span class="token function">vi</span> kibana.yml
</code></pre></div><p>配置内容如下：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>server.host: <span class="token string">&quot;node01&quot;</span>
elasticsearch.hosts: <span class="token punctuation">[</span><span class="token string">&quot;http://node01:9200&quot;</span><span class="token punctuation">]</span>
</code></pre></div><h4 id="第三步-启动服务"><a href="#第三步-启动服务" class="header-anchor">#</a> 第三步：启动服务</h4> <p>node01服务器使用es用户执行以下命令启动kibana服务</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/kibana-6.7.0-linux-x86_64
<span class="token function">nohup</span> bin/kibana <span class="token operator">&gt;</span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
</code></pre></div><p>如何停止kibana进程：停止kibana服务进程</p> <p>查看进程号</p> <div class="language- extra-class"><pre class="language-text"><code>ps -ef | grep node
</code></pre></div><p>然后使用kill -9杀死进程即可</p> <h4 id="第四步-浏览器访问"><a href="#第四步-浏览器访问" class="header-anchor">#</a> 第四步：浏览器访问</h4> <p>浏览器地址访问kibana服务</p> <p>⛈http://node01:5601</p> <p><img src="/assets/img/image-20200518234828110.f9547cc3.png" alt="image-20200518234828110"></p> <h3 id="_6、es的核心概念"><a href="#_6、es的核心概念" class="header-anchor">#</a> 6、ES的核心概念</h3> <h4 id="_1、概述"><a href="#_1、概述" class="header-anchor">#</a> 1、概述</h4> <p>Elasticsearch是<strong>面向文档(document oriented)的</strong>，这意味着它<strong>可以存储整个对象或文档(document)</strong>。然而它不仅仅是存储，还会索引(index)每个文档的内容使之可以被搜索。在Elasticsearch中，你可以对文档（而非成行成列的数据）进行索引、搜索、排序、过滤。</p> <p>Elasticsearch比传统关系型数据库如下：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>Relational DB -<span class="token operator">&gt;</span> Databases -<span class="token operator">&gt;</span> Tables -<span class="token operator">&gt;</span> Rows -<span class="token operator">&gt;</span> Columns
Elasticsearch -<span class="token operator">&gt;</span> Indices  -<span class="token operator">&gt;</span> Types -<span class="token operator">&gt;</span> Documents -<span class="token operator">&gt;</span> Fields
</code></pre></div><p>==可以将ElasticSearch类比为传统关系型数据库来学习。==</p> <h4 id="_2、elasticsearch核心概念"><a href="#_2、elasticsearch核心概念" class="header-anchor">#</a> 2、Elasticsearch核心概念</h4> <h5 id="_1、索引-index"><a href="#_1、索引-index" class="header-anchor">#</a> 1、索引 index</h5> <p>一个索引就是一个<strong>拥有几分相似特征的文档的集合</strong>。比如说，你可以有一个客户数据的索引，另一个产品目录的索引，还有一个订单数据的索引。<strong>一个索引由一个名字来标识（必须全部是小写字母的）</strong>，并且当我们要对对应于这个索引中的文档进行索引、搜索、更新和删除的时候，都要使用到这个名字。在一个集群中，可以定义任意多的索引。</p> <h5 id="_2、类型-type"><a href="#_2、类型-type" class="header-anchor">#</a> 2、类型 type</h5> <p>在一个索引中，你可以定义一种或多种类型。<strong>一个类型是你的索引的一个逻辑上的分类/分区</strong>，其语义完全由你来定。<strong>通常，会为具有一组共同字段的文档定义一个类型</strong>。比如说，我们假设你运营一个博客平台并且将你所有的数据存储到一个索引中。在这个索引中，你可以为用户数据定义一个类型，为博客数据定义另一个类型，当然，也可以为评论数据定义另一个类型。</p> <h5 id="_3、字段field"><a href="#_3、字段field" class="header-anchor">#</a> 3、字段Field</h5> <p>相当于是数据表的字段，<strong>对文档数据根据不同属性进行的分类标识</strong></p> <h5 id="_4、映射-mapping"><a href="#_4、映射-mapping" class="header-anchor">#</a> 4、映射 mapping</h5> <p>mapping是处理数据的方式和规则方面做一些<strong>限制</strong>，如<strong>某个字段的数据类型、默认值、分析器、是否被索引等等</strong>，这些都是映射里面可以设置的，其它就是<strong>处理es里面数据的一些使用规则设置也叫做映射</strong>，按着最优规则处理数据对性能提高很大，因此才需要建立映射，并且==需要思考如何建立映射才能对性能更好。==</p> <h5 id="_5、文档-document"><a href="#_5、文档-document" class="header-anchor">#</a> 5、文档 document</h5> <p><strong>一个文档是一个可被索引的基础信息单元</strong>。比如，你可以拥有某一个客户的文档，某一个产品的一个文档，当然，也可以拥有某个订单的一个文档。<strong>==文档以JSON（Javascript Object Notation）格式来表示==</strong>，而JSON是一个到处存在的互联网数据交互格式。</p> <p>在<strong>一个index/type里面，你可以存储任意多的文档</strong>。注意，尽管一个文档，物理上存在于一个索引之中，<strong>==文档必须被索引/赋予一个索引的type。==</strong></p> <h5 id="_6、接近实时-nrt"><a href="#_6、接近实时-nrt" class="header-anchor">#</a> 6、接近实时 NRT</h5> <p>Elasticsearch是一个接近实时的搜索平台。这意味着，从索引一个文档直到这个文档能够被搜索到<strong>有一个轻微的延迟</strong>（通常是1秒以内）</p> <h5 id="_7、集群-cluster"><a href="#_7、集群-cluster" class="header-anchor">#</a> 7、集群 cluster</h5> <p>一个集群就是由一个或<strong>多个节点组织在一起，它们共同持有整个的数据，并一起提供索引和搜索功能</strong>。一个集群由一个唯一的名字标识，这个名字默认就是“elasticsearch”。这个名字是重要的，因为一个节点只能通过指定某个集群的名字，来加入这个集群.</p> <h5 id="_8、节点-node"><a href="#_8、节点-node" class="header-anchor">#</a> 8、节点 node</h5> <p>一个节点是集群中的一个服务器，作为集群的一部分，它存储数据，参与集群的索引和搜索功能。和集群类似，一个节点也是由一个名字来标识的，默认情况下，这个名字是一个随机的漫威漫画角色的名字，这个名字会在启动的时候赋予节点。这个名字对于管理工作来说挺重要的，因为在这个管理过程中，你会去确定网络中的哪些服务器对应于Elasticsearch集群中的哪些节点。</p> <p>一个节点可以通过配置集群名称的方式来加入一个指定的集群。<strong>默认情况下，每个节点都会被安排加入到一个叫做“elasticsearch”的集群中</strong>，这意味着，如果你在你的网络中启动了若干个节点，并假定它们能够相互发现彼此，它们将会自动地形成并加入到一个叫做“elasticsearch”的集群中。</p> <p>在一个集群里，只要你想，可以拥有任意多个节点。而且，如果当前你的网络中没有运行任何Elasticsearch节点，这时启动一个节点，会默认创建并加入一个叫做“elasticsearch”的集群。</p> <h5 id="_9、分片和复制-shards-replicas"><a href="#_9、分片和复制-shards-replicas" class="header-anchor">#</a> 9、分片和复制 shards&amp;replicas</h5> <p>一个索引可以存储超出单个结点硬件限制的大量数据。比如，一个具有10亿文档的索引占据1TB的磁盘空间，而任一节点都没有这样大的磁盘空间；或者单个节点处理搜索请求，响应太慢。为了解决这个问题，**Elasticsearch提供了将索引划分成多份的能力，这些份就叫做分片。当你创建一个索引的时候，你可以指定你想要的分片的数量。**每个分片本身也是一个功能完善并且独立的“索引”，这个“索引”可以被放置到集群中的任何节点上。</p> <p>分片很重要，主要有两方面的原因：</p> <p>1）允许你水平分割/扩展你的内容容量。</p> <p>2）允许你在分片（潜在地，位于多个节点上）之上进行分布式的、并行的操作，进而提高性能/吞吐量。</p> <p>至于一个分片怎样分布，它的文档怎样聚合回搜索请求，是完全由Elasticsearch管理的，对于作为用户的你来说，这些都是透明的。</p> <p>在一个网络/云的环境里，失败随时都可能发生，在<strong>某个分片/节点不知怎么的就处于离线状态</strong>，或者由于任何原因消失了，这种情况下，有一个<strong>故障转移机制</strong>是非常有用并且是强烈推荐的。为此目的，<strong>Elasticsearch允许你创建分片的一份或多份拷贝，这些拷贝叫做复制分片，或者直接叫复制。</strong></p> <p>复制之所以重要，有两个主要原因： 在分片/节点失败的情况下，提供了高可用性。因为这个原因，注意到复制分片从不与原/主要（original/primary）分片置于同一节点上是非常重要的。扩展你的搜索量/吞吐量，因为<strong>搜索可以在所有的复制分片上并行运行</strong>。总之，每个索引可以被分成多个分片。一个索引也可以被复制0次（意思是没有复制）或多次。一旦复制了，每个索引就有了<strong>主分片</strong>（作为复制源的原来的分片）和<strong>复制分片</strong>（主分片的拷贝）之别。分片和复制的数量可以在索引创建的时候指定。在索引创建之后，你可以在任何时候动态地改变复制的数量，但是你事后不能改变分片的数量。</p> <p><strong>默认情况下，Elasticsearch中的每个索引被分片5个主分片和1个复制</strong>，这意味着，如果你的集群中至少有两个节点，你的索引将会有5个主分片和另外5个复制分片（1个完全拷贝），这样的话<strong>每个索引总共就有10个分片。</strong></p> <h3 id="_7、管理索引"><a href="#_7、管理索引" class="header-anchor">#</a> 7、管理索引</h3> <p><strong>curl是利用URL语法在命令行方式下工作的开源文件传输工具</strong>，使用<strong>curl可以简单实现常见的get/post请求</strong>。简单的认为是可以在命令行下面访问url的一个工具。在**==centos的默认库里面是有curl工具的==**，如果没有请yum安装即可。</p> <p>curl</p> <ul><li>-X 指定http的请求方法 有HEAD GET POST PUT DELETE</li> <li>-d 指定要传输的数据</li> <li>-H 指定http请求头信息</li></ul> <h4 id="索引的基本操作-在kibana"><a href="#索引的基本操作-在kibana" class="header-anchor">#</a> 🌈索引的基本操作——在Kibana</h4> <div class="language-scala extra-class"><pre class="language-scala"><code>PUT <span class="token operator">/</span>blog01<span class="token operator">/</span><span class="token operator">?</span>pretty   <span class="token comment">//创建索引</span>

PUT <span class="token operator">/</span>blog01<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1</span><span class="token operator">/</span><span class="token operator">?</span>pretty
<span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;what is lucene&quot;</span><span class="token punctuation">}</span>     <span class="token comment">//插入文档</span>

GET <span class="token operator">/</span>blog01<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1</span><span class="token operator">/</span><span class="token operator">?</span>pretty      <span class="token comment">//查询文档</span>

PUT <span class="token operator">/</span>blog01<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1</span><span class="token operator">/</span><span class="token operator">?</span>pretty
<span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;title&quot;</span><span class="token operator">:</span><span class="token string">&quot;what is elasticSearch&quot;</span><span class="token punctuation">}</span>    <span class="token comment">//更新文档</span>

GET <span class="token operator">/</span>blog01<span class="token operator">/</span>article<span class="token operator">/</span>_search<span class="token operator">?</span>q<span class="token operator">=</span>title<span class="token operator">:</span>elasticSearch   <span class="token comment">//搜索文档</span>


DELETE <span class="token operator">/</span>blog01<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1</span><span class="token operator">?</span>pretty    <span class="token comment">//删除文档</span>

DELETE <span class="token operator">/</span>blog01<span class="token operator">/</span><span class="token operator">?</span>pretty    <span class="token comment">//删除索引</span>
</code></pre></div><p>创建索引演示：</p> <img src="elk.assets/image-20200519003747019.png" alt="image-20200519003747019" style="zoom:67%;"> <p>创建索引前，查看ES的web页面：</p> <img src="elk.assets/image-20200519004019341.png" alt="image-20200519004019341" style="zoom:67%;"> <p>创建索引后，查看web页面：</p> <img src="elk.assets/image-20200519004827466.png" alt="image-20200519004827466" style="zoom:67%;"> <p>插入数据后，查看数据：</p> <p><img src="/assets/img/image-20200519005641603.76c84a5c.png" alt="image-20200519005641603"></p> <h4 id="索引的基本操作-使用curl工具"><a href="#索引的基本操作-使用curl工具" class="header-anchor">#</a> 1️⃣  索引的基本操作——使用curl工具</h4> <h5 id="_1、创建索引"><a href="#_1、创建索引" class="header-anchor">#</a> 1、创建索引</h5> <p>在我们的<strong>liinux命令行</strong>当中执行以下语句:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> -XPUT http://node01:9200/blog01/?pretty
</code></pre></div><h5 id="_2、插入文档"><a href="#_2、插入文档" class="header-anchor">#</a> 2、插入文档</h5> <p>前面的命令使用 PUT 动词将一个文档添加到 /article(文档类型)，并为该文档分配 ID 为1。URL 路径显示为index/doctype/ID（索引/文档类型/ID）。</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> -XPUT http://node01:9200/blog01/article/1?pretty -d <span class="token string">'{&quot;id&quot;: &quot;1&quot;, &quot;title&quot;: &quot;What is lucene&quot;}'</span>
</code></pre></div><p>问题：Content-Type header [application/x-www-form-urlencoded] is not supported</p> <p>解决：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> -XPUT http://node01:9200/blog01/article/1?pretty -d <span class="token string">'{&quot;id&quot;: &quot;1&quot;, &quot;title&quot;: &quot;What is lucene&quot;}'</span> -H <span class="token string">&quot;Content-Type: application/json&quot;</span>
</code></pre></div><p>原因：</p> <p>此原因时由于ES增加了安全机制， 进行严格的内容类型检查，严格检查内容类型也可以作为防止跨站点请求伪造攻击的一层保护。 <a href="https://www.elastic.co/blog/strict-content-type-checking-for-elasticsearch-rest-requests" target="_blank" rel="noopener noreferrer">官网解释<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>http.content_type.required</p> <h5 id="_3、查询文档"><a href="#_3、查询文档" class="header-anchor">#</a> 3、查询文档</h5> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> -XGET http://node01:9200/blog01/article/1?pretty
</code></pre></div><p>问题：Content-Type header [application/x-www-form-urlencoded] is not supported</p> <p>解决：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> -XPUT http://node01:9200/blog01/article/1?pretty -d <span class="token string">'{&quot;id&quot;: &quot;1&quot;, &quot;title&quot;: &quot;What is lucene&quot;}'</span> -H <span class="token string">&quot;Content-Type: application/json&quot;</span>

<span class="token function">curl</span> -XGET http://node01:9200/blog01/article/1?pretty -H <span class="token string">&quot;Content-Type: application/json&quot;</span>
</code></pre></div><h5 id="_4、更新文档"><a href="#_4、更新文档" class="header-anchor">#</a> 4、更新文档</h5> <div class="language- extra-class"><pre class="language-text"><code>curl -XPUT http://node01:9200/blog01/article/1?pretty -d '{&quot;id&quot;: &quot;1&quot;, &quot;title&quot;: &quot; What is elasticsearch&quot;}'
</code></pre></div><p>问题：Content-Type header [application/x-www-form-urlencoded] is not supported</p> <p>解决：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> -XPUT http://node01:9200/blog01/article/1?pretty -d <span class="token string">'{&quot;id&quot;: &quot;1&quot;, &quot;title&quot;: &quot; What is elasticsearch&quot;}'</span> -H <span class="token string">&quot;Content-Type: application/json&quot;</span>
</code></pre></div><h5 id="_5、搜索文档"><a href="#_5、搜索文档" class="header-anchor">#</a> 5、搜索文档</h5> <div class="language- extra-class"><pre class="language-text"><code>curl -XGET &quot;http://node01:9200/blog01/article/_search?q=title:elasticsearch&quot; 
</code></pre></div><p>问题：Content-Type header [application/x-www-form-urlencoded] is not supported</p> <p>解决：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> -XGET <span class="token string">&quot;http://node01:9200/blog01/article/_search?q=title:'elasticsearch'&amp;pretty&quot;</span> -H <span class="token string">&quot;Content-Type: application/json&quot;</span>
</code></pre></div><h5 id="_6、删除文档"><a href="#_6、删除文档" class="header-anchor">#</a> 6、删除文档</h5> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> -XDELETE <span class="token string">&quot;http://node01:9200/blog01/article/1?pretty&quot;</span>
</code></pre></div><h5 id="_7、删除索引"><a href="#_7、删除索引" class="header-anchor">#</a> 7、删除索引</h5> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> -XDELETE http://node01:9200/blog01?pretty
</code></pre></div><h4 id="查询条件查询"><a href="#查询条件查询" class="header-anchor">#</a> 2️⃣  查询条件查询</h4> <p>在kibana提供的界面上进行操作。</p> <div class="language-json extra-class"><pre class="language-json"><code>POST /school/student/_bulk
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;liubei&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;age&quot;</span> <span class="token operator">:</span> <span class="token number">20</span> <span class="token punctuation">,</span> <span class="token property">&quot;sex&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boy&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;birth&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1996-01-02&quot;</span> <span class="token punctuation">,</span> <span class="token property">&quot;about&quot;</span><span class="token operator">:</span> <span class="token string">&quot;i like diaocan he girl&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;guanyu&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;age&quot;</span> <span class="token operator">:</span> <span class="token number">21</span> <span class="token punctuation">,</span> <span class="token property">&quot;sex&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boy&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;birth&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1995-01-02&quot;</span> <span class="token punctuation">,</span> <span class="token property">&quot;about&quot;</span><span class="token operator">:</span> <span class="token string">&quot;i like diaocan&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;zhangfei&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;age&quot;</span> <span class="token operator">:</span> <span class="token number">18</span> <span class="token punctuation">,</span> <span class="token property">&quot;sex&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boy&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;birth&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1998-01-02&quot;</span> <span class="token punctuation">,</span> <span class="token property">&quot;about&quot;</span><span class="token operator">:</span> <span class="token string">&quot;i like travel&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;diaocan&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;age&quot;</span> <span class="token operator">:</span> <span class="token number">20</span> <span class="token punctuation">,</span> <span class="token property">&quot;sex&quot;</span><span class="token operator">:</span> <span class="token string">&quot;girl&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;birth&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1996-01-02&quot;</span> <span class="token punctuation">,</span> <span class="token property">&quot;about&quot;</span><span class="token operator">:</span> <span class="token string">&quot;i like travel and sport&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;panjinlian&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;age&quot;</span> <span class="token operator">:</span> <span class="token number">25</span> <span class="token punctuation">,</span> <span class="token property">&quot;sex&quot;</span><span class="token operator">:</span> <span class="token string">&quot;girl&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;birth&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1991-01-02&quot;</span> <span class="token punctuation">,</span> <span class="token property">&quot;about&quot;</span><span class="token operator">:</span> <span class="token string">&quot;i like travel and wusong&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;caocao&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;age&quot;</span> <span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">,</span> <span class="token property">&quot;sex&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boy&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;birth&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1988-01-02&quot;</span> <span class="token punctuation">,</span> <span class="token property">&quot;about&quot;</span><span class="token operator">:</span> <span class="token string">&quot;i like xiaoqiao&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token number">7</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;zhaoyun&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;age&quot;</span> <span class="token operator">:</span> <span class="token number">31</span> <span class="token punctuation">,</span> <span class="token property">&quot;sex&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boy&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;birth&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1997-01-02&quot;</span> <span class="token punctuation">,</span> <span class="token property">&quot;about&quot;</span><span class="token operator">:</span> <span class="token string">&quot;i like travel and music&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;xiaoqiao&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;age&quot;</span> <span class="token operator">:</span> <span class="token number">18</span> <span class="token punctuation">,</span> <span class="token property">&quot;sex&quot;</span><span class="token operator">:</span> <span class="token string">&quot;girl&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;birth&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1998-01-02&quot;</span> <span class="token punctuation">,</span> <span class="token property">&quot;about&quot;</span><span class="token operator">:</span> <span class="token string">&quot;i like caocao&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token number">9</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;daqiao&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;age&quot;</span> <span class="token operator">:</span> <span class="token number">20</span> <span class="token punctuation">,</span> <span class="token property">&quot;sex&quot;</span><span class="token operator">:</span> <span class="token string">&quot;girl&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;birth&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1996-01-02&quot;</span> <span class="token punctuation">,</span> <span class="token property">&quot;about&quot;</span><span class="token operator">:</span> <span class="token string">&quot;i like travel and history&quot;</span> <span class="token punctuation">}</span>
</code></pre></div><p><img src="/assets/img/image-20200519023804763.2290c9a4.png" alt="image-20200519023804763"></p> <h5 id="_1、使用match-all做查询"><a href="#_1、使用match-all做查询" class="header-anchor">#</a> 1、使用match_all做查询</h5> <div class="language-json extra-class"><pre class="language-json"><code>GET /school/student/_search?pretty
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>问题：通过match_all匹配后，会把所有的数据检索出来，但是往往真正的业务需求并非要找全部的数据，而是检索出自己想要的；并且<strong>对于es集群来说，直接检索全部的数据，很容易造成GC现象</strong>。所以，我们要学会如何进行高效的检索数据</p> <h5 id="_2、通过关键字段进行查询"><a href="#_2、通过关键字段进行查询" class="header-anchor">#</a> 2、通过关键字段进行查询</h5> <div class="language-json extra-class"><pre class="language-json"><code>GET /school/student/_search?pretty
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
         <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;about&quot;</span><span class="token operator">:</span> <span class="token string">&quot;travel&quot;</span><span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果此时想查询<strong>喜欢旅游的，并且不能是男孩的</strong>，怎么办？</p> <p>【这种方式是错误的，因为<strong>一个match下，不能出现多个字段值</strong>[match] query doesn't support multiple fields】，<strong>需要使用复合查询</strong></p> <p><img src="/assets/img/image-20200519010107289.cff44d98.png" alt="image-20200519010107289"></p> <h5 id="_3、bool的复合查询"><a href="#_3、bool的复合查询" class="header-anchor">#</a> 3、bool的复合查询</h5> <p>当出现多个查询语句组合的时候，可以用bool来包含。bool合并聚包含：must，must_not或者should， should表示or的意思</p> <p>例子：查询非男性中喜欢旅行的人</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /school/student/_search?pretty
<span class="token punctuation">{</span>
<span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;about&quot;</span><span class="token operator">:</span> <span class="token string">&quot;travel&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;must_not&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;sex&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boy&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_4、bool的复合查询中的should"><a href="#_4、bool的复合查询中的should" class="header-anchor">#</a> 4、bool的复合查询中的should</h5> <p>should表示可有可无的（如果should<strong>匹配到了就展示，否则就不展示</strong>）</p> <p>例子：</p> <p>查询喜欢旅行的，如果<strong>有男性的则显示，否则不显示</strong></p> <div class="language-json extra-class"><pre class="language-json"><code>GET /school/student/_search?pretty
<span class="token punctuation">{</span>
<span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;about&quot;</span><span class="token operator">:</span> <span class="token string">&quot;travel&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;should&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;sex&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boy&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>   <span class="token comment">//好像没啥用，有没有should，效果都一样         </span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_5、term匹配"><a href="#_5、term匹配" class="header-anchor">#</a> 5、term匹配</h5> <p>使用term进行精确匹配（比如数字，日期，布尔值或 not_analyzed的字符串(未经分析的文本数据类型)）</p> <p>语法</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span> <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;date&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2018-04-01&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;sex&quot;</span><span class="token operator">:</span> “boy” <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;about&quot;</span><span class="token operator">:</span> <span class="token string">&quot;trivel&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><p>例子：</p> <p>查询喜欢旅行的</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /school/student/_search?pretty
<span class="token punctuation">{</span>
<span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;sex&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boy&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>         
     <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6、使用terms匹配多个值"><a href="#_6、使用terms匹配多个值" class="header-anchor">#</a> 6、使用terms匹配多个值</h5> <div class="language-json extra-class"><pre class="language-json"><code>GET /school/student/_search?pretty
<span class="token punctuation">{</span>
<span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;about&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;travel&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;history&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span>          
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>term主要是用于精确的过滤比如说：”我爱你”</p> <p>在match下面匹配可以为包含：我、爱、你、我爱等等的解析器</p> <p>在term语法下面就精准匹配到：”我爱你”</p> <h5 id="_7、range过滤"><a href="#_7、range过滤" class="header-anchor">#</a> 7、Range过滤</h5> <p>Range过滤允许我们按照指定的范围查找一些数据：操作范围：<strong>gt::大于，gae::大于等于,lt::小于，lte::小于等于</strong></p> <p>例子：</p> <p>查找出大于20岁，小于等于25岁的学生</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /school/student/_search?pretty
<span class="token punctuation">{</span>
<span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;gt&quot;</span><span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token property">&quot;lte&quot;</span><span class="token operator">:</span><span class="token number">25</span><span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_8、exists和-missing过滤"><a href="#_8、exists和-missing过滤" class="header-anchor">#</a> 8、exists和 missing过滤</h5> <p>exists和missing过滤可以找到文档中<strong>是否包含某个字段或者是没有某个字段</strong></p> <p>例子：</p> <p>查找字段中包含age的文档</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /school/student/_search?pretty
<span class="token punctuation">{</span>
<span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token property">&quot;exists&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;age&quot;</span>  
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_9、bool的多条件过滤"><a href="#_9、bool的多条件过滤" class="header-anchor">#</a> 9、bool的多条件过滤</h5> <p>用bool也可以像之前match一样来过滤多行条件：</p> <div class="language- extra-class"><pre class="language-text"><code>must [] 多个查询条件的完全匹配,相当于 and 。
must_not [] 多个查询条件的相反匹配，相当于 not 。
should [] 至少有一个查询条件匹配, 相当于 or
</code></pre></div><p>例子：</p> <p>过滤出about字段包含travel并且年龄大于20岁小于30岁的同学</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /school/student/_search?pretty
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;about&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;travel&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;gte&quot;</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
            <span class="token property">&quot;lte&quot;</span><span class="token operator">:</span> <span class="token number">30</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_10、查询与过滤条件合并"><a href="#_10、查询与过滤条件合并" class="header-anchor">#</a> 10、查询与过滤条件合并</h5> <p>通常复杂的查询语句，我们也要配合过滤语句来实现缓存，用filter语句就可以来实现</p> <p>例子：</p> <p>查询出喜欢旅行的，并且年龄是20岁的文档</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /school/student/_search?pretty
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
     <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;about&quot;</span><span class="token operator">:</span> <span class="token string">&quot;travel&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>     
     <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;term&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="定义字段类型mappings"><a href="#定义字段类型mappings" class="header-anchor">#</a> 3️⃣  定义字段类型mappings</h4> <p>在es当中，每个字段都会有默认的类型，根据我们第一次插入数据进去，es会自动帮我们推断字段的类型，当然我们也可以通过设置mappings来提前自定义我们字段的类型</p> <h5 id="_1、使用mappings来提前定义字段类型"><a href="#_1、使用mappings来提前定义字段类型" class="header-anchor">#</a> 1、使用mappings来提前定义字段类型</h5> <p><strong>使用<strong><strong>mapping</strong></strong>的映射管理，提前指定字段的类型，防止后续的程序问题；</strong></p> <div class="language-json extra-class"><pre class="language-json"><code>DELETE  document
PUT document
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;article&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;title&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">,</span> 
        <span class="token property">&quot;author&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">,</span> 
        <span class="token property">&quot;titleScore&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;double&quot;</span><span class="token punctuation">}</span> 
        
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
get document/article/_mapping
</code></pre></div><h5 id="_2、基本命令"><a href="#_2、基本命令" class="header-anchor">#</a> 2、基本命令</h5> <div class="language-json extra-class"><pre class="language-json"><code>DELETE school
PUT school
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;logs&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;messages&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>添加索引：school，文档类型类logs，索引字段为message ，字段的类型为text</p> <p>GET /school/_mapping/logs</p> <p>继续添加字段</p> <div class="language-json extra-class"><pre class="language-json"><code>POST /school/_mapping/logs
<span class="token punctuation">{</span>
  <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;number&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET /school/_mapping/logs
</code></pre></div><h5 id="_3、获取映射字段"><a href="#_3、获取映射字段" class="header-anchor">#</a> 3、获取映射字段</h5> <p>语法：</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /school/_mapping/logs/field/number
</code></pre></div><h4 id="管理索引库分片数以及副本数settings"><a href="#管理索引库分片数以及副本数settings" class="header-anchor">#</a> 4️⃣  管理索引库分片数以及副本数settings</h4> <p><strong>所谓的settings****就是用来修改索引分片和副本数的；</strong></p> <p>比如有的重要索引，副本数很少甚至没有副本，那么我们可以通过setting来添加副本数</p> <div class="language-json extra-class"><pre class="language-json"><code>DELETE document
PUT document
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;article&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;title&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">,</span> 
        <span class="token property">&quot;author&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">,</span> 
        <span class="token property">&quot;titleScore&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;double&quot;</span><span class="token punctuation">}</span> 
        
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET /document/_settings
</code></pre></div><p><img src="/assets/img/image-20200519010439609.e3299764.png" alt="image-20200519010439609"></p> <p>可以看到当前的副本数是1，那么为了提高容错性，我们可以把副本数改成2：</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT /document/_settings
<span class="token punctuation">{</span>
  <span class="token property">&quot;number_of_replicas&quot;</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>副本可以改，分片不能改</strong></p> <div class="language-json extra-class"><pre class="language-json"><code>PUT /document/_settings
<span class="token punctuation">{</span>
  <span class="token property">&quot;number_of_shards&quot;</span><span class="token operator">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_8、分页解决方案"><a href="#_8、分页解决方案" class="header-anchor">#</a> 8、分页解决方案</h3> <h4 id="_1、导入数据"><a href="#_1、导入数据" class="header-anchor">#</a> 1、导入数据</h4> <div class="language-json extra-class"><pre class="language-json"><code>DELETE us
POST /_bulk
<span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;us&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tweet&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;email&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;john@smith.com&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;John Smith&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;username&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;@john&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;us&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tweet&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;email&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;mary@jones.com&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Mary Jones&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;username&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;@mary&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;us&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tweet&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2014-09-13&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Mary Jones&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;tweet&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Elasticsearch means full text search has never been so easy&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;user_id&quot;</span> <span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;us&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tweet&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2014-09-14&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;John Smith&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;tweet&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;@mary it is not just text, it does everything&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;user_id&quot;</span> <span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;us&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tweet&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2014-09-15&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Mary Jones&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;tweet&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;However did I manage before Elasticsearch?&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;user_id&quot;</span> <span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;us&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tweet&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2014-09-16&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;John Smith&quot;</span><span class="token punctuation">,</span>  <span class="token property">&quot;tweet&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;The Elasticsearch API is really easy to use&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;user_id&quot;</span> <span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;us&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tweet&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;7&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2014-09-17&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Mary Jones&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;tweet&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;The Query DSL is really powerful and flexible&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;user_id&quot;</span> <span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;us&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tweet&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;8&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2014-09-18&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;John Smith&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;user_id&quot;</span> <span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;us&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tweet&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;9&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2014-09-19&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Mary Jones&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;tweet&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Geo-location aggregations are really cool&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;user_id&quot;</span> <span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;us&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tweet&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2014-09-20&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;John Smith&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;tweet&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Elasticsearch surely is one of the hottest new NoSQL products&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;user_id&quot;</span> <span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;us&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tweet&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;11&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2014-09-21&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Mary Jones&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;tweet&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Elasticsearch is built for the cloud, easy to scale&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;user_id&quot;</span> <span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;us&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tweet&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;12&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2014-09-22&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;John Smith&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;tweet&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Elasticsearch and I have left the honeymoon stage, and I still love her.&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;user_id&quot;</span> <span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;us&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tweet&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;13&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2014-09-23&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Mary Jones&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;tweet&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;So yes, I am an Elasticsearch fanboy&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;user_id&quot;</span> <span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;create&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;us&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tweet&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;14&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;date&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2014-09-24&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;John Smith&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;tweet&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;How many more cheesy tweets do I have to write?&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;user_id&quot;</span> <span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
</code></pre></div><h4 id="_2、size-from浅分页"><a href="#_2、size-from浅分页" class="header-anchor">#</a> 2、size+from浅分页</h4> <p>按照一般的查询流程来说，如果我想查询前10条数据：</p> <p>•      1 客户端请求发给某个节点</p> <p>•      2 节点转发给个个分片，查询每个分片上的前10条</p> <p>•      3 结果返回给节点，整合数据，提取前10条</p> <p>•      4 返回给请求客户端</p> <p><strong>from****定义了目标数据的偏移值，<strong><strong>size</strong></strong>定义当前返回的事件数目</strong></p> <div class="language-json extra-class"><pre class="language-json"><code>GET /us/_search?pretty
<span class="token punctuation">{</span>
  <span class="token property">&quot;from&quot;</span> <span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token property">&quot;size&quot;</span> <span class="token operator">:</span> <span class="token number">5</span>
<span class="token punctuation">}</span>

GET /us/_search?pretty
<span class="token punctuation">{</span>
  <span class="token property">&quot;from&quot;</span> <span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">,</span> <span class="token property">&quot;size&quot;</span> <span class="token operator">:</span> <span class="token number">5</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这种浅分页只适合少量数据，因为随from增大，查询的时间就会越大，而且数据量越大，查询的效率指数下降</p> <p>优点：from+size在数据量不大的情况下，效率比较高</p> <p>缺点：在数据量非常大的情况下，from+size分页会把全部记录加载到内存中，这样做不但运行速递特别慢，而且容易让es出现内存不足而挂掉</p> <h4 id="_3、scroll深分页"><a href="#_3、scroll深分页" class="header-anchor">#</a> 3、scroll深分页</h4> <p>对于上面介绍的浅分页，当Elasticsearch响应请求时，它必须确定docs的顺序，排列响应结果。</p> <p>如果请求的页数较少（假设每页20个docs）, Elasticsearch不会有什么问题，但是如果页数较大时，比如请求第20页，Elasticsearch不得不取出第1页到第20页的所有docs，再去除第1页到第19页的docs，得到第20页的docs。</p> <p>解决的方式就是使用scroll，**scroll<strong><strong>就是维护了当前索引段的一份快照信息</strong></strong>--**<strong>缓存</strong>（这个快照信息是你执行这个scroll查询时的快照）。</p> <p>可以把 scroll 分为初始化和遍历两步： 1、初始化时将所有符合搜索条件的搜索结果缓存起来，可以想象成快照； 2、遍历时，从这个快照里取数据；</p> <p>初始化</p> <div class="language-json extra-class"><pre class="language-json"><code>GET us/_search?scroll=3m
<span class="token punctuation">{</span> 
<span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span>
</code></pre></div><p>初始化的时候就像是普通的search一样</p> <p>其中的scroll=3m代表当前查询的数据缓存3分钟</p> <p>Size：3 代表当前查询3条数据</p> <p>遍历</p> <p>在遍历时候，拿到上一次遍历中的<em>scroll</em>id，然后带scroll参数，重复上一次的遍历步骤，知道返回的数据为空，就表示遍历完成</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /_search/scroll
<span class="token punctuation">{</span>
  <span class="token property">&quot;scroll&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1m&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scroll_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAAPXFk0xN1BmSnlVUldhYThEdWVzZ19xbkEAAAAAAAAAIxZuQWVJU0VSZ1JzcVZtMGVYZ3RDaFlBAAAAAAAAA9oWTVZOdHJ2cXBSOU9wN3c1dk5vcWd4QQAAAAAAAAPYFk0xN1BmSnlVUldhYThEdWVzZ19xbkEAAAAAAAAAIhZuQWVJU0VSZ1JzcVZtMGVYZ3RDaFlB&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>【注意】：每次都要传参数scroll，刷新搜索结果的缓存时间，另外不需要指定index和type（<strong>不要把缓存的时时间设置太长，占用内存</strong>）</p> <p><strong>对比</strong></p> <p>浅分页，每次查询都会去索引库（本地文件夹）中查询pageNum*page条数据，然后截取掉前面的数据，留下最后的数据。 这样的操作在每个分片上都会执行，最后会将多个分片的数据合并到一起，再次排序，截取需要的。</p> <p>深分页，可以一次性将所有满足查询条件的数据，都放到内存中。分页的时候，在内存中查询。相对浅分页，就可以避免多次读取磁盘。</p> <h3 id="_9、es的中文分词器ik"><a href="#_9、es的中文分词器ik" class="header-anchor">#</a> 9、ES的中文分词器IK</h3> <p>ES默认对英文文本的分词器支持较好，但和lucene一样，如果需要对中文进行全文检索，那么需要使用中文分词器，同lucene一样，在使用中文全文检索前，需要集成IK分词器。那么我们接下来就来安装IK分词器，以实现中文的分词</p> <h4 id="第一步-三台机器安装ik分词器"><a href="#第一步-三台机器安装ik分词器" class="header-anchor">#</a> 第一步：三台机器安装IK分词器</h4> <p>将安装包上传到node01机器的/home/es路径下</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/soft
<span class="token function">wget</span> https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.7.0/elasticsearch-analysis-ik-6.7.0.zip
<span class="token comment">## 将ik分词器的插件，解压到对应路径下 </span>
<span class="token builtin class-name">cd</span> /kkb/soft
<span class="token function">mkdir</span> -p /kkb/install/elasticsearch-6.7.0/plugins/analysis-ik
<span class="token function">unzip</span> elasticsearch-analysis-ik-6.7.0.zip  -d /kkb/install/elasticsearch-6.7.0/plugins/analysis-ik/
</code></pre></div><p>将安装包分发到其他机器上</p> <p>node01机器执行以下命令进行安装包的分发</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/elasticsearch-6.7.0/plugins 
<span class="token function">scp</span> -r analysis-ik/ node02:<span class="token environment constant">$PWD</span> 
<span class="token function">scp</span> -r analysis-ik/ node03:<span class="token environment constant">$PWD</span>
</code></pre></div><p>三台机器都配置完成，配置完成之后，需要重启服务。</p> <p>三台机器重启es服务</p> <p>三台机器执行以下命令停止es服务并重启es服务</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">ps</span> -ef<span class="token operator">|</span><span class="token function">grep</span> elasticsearch <span class="token operator">|</span> <span class="token function">grep</span> bootstrap <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$2</span>}'</span> <span class="token operator">|</span><span class="token function">xargs</span> <span class="token function">kill</span> -9

<span class="token function">nohup</span> /kkb/install/elasticsearch-6.7.0/bin/elasticsearch <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
</code></pre></div><h4 id="第二步、创建索引库并配置ik分词器"><a href="#第二步、创建索引库并配置ik分词器" class="header-anchor">#</a> 第二步、创建索引库并配置IK分词器</h4> <div class="language-json extra-class"><pre class="language-json"><code>delete iktest
PUT /iktest?pretty
<span class="token punctuation">{</span>
    <span class="token property">&quot;settings&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;analysis&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;analyzer&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;ik&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;tokenizer&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;mappings&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;article&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;dynamic&quot;</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token property">&quot;properties&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;subject&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;analyzer&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明：在创建索引库的时候，我们指定分词方式为ik_max_word，会对我们的中文进行最细粒度的切分</p> <h4 id="第三步、查看分词效果"><a href="#第三步、查看分词效果" class="header-anchor">#</a> 第三步、查看分词效果</h4> <p>在kibana当中执行以下查询，并验证分词效果</p> <div class="language-json extra-class"><pre class="language-json"><code>GET _analyze?pretty
  <span class="token punctuation">{</span>
    <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;text&quot;</span><span class="token operator">:</span> <span class="token string">&quot;特朗普是美国总统&quot;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="第四步、插入测试数据"><a href="#第四步、插入测试数据" class="header-anchor">#</a> 第四步、插入测试数据</h4> <div class="language-json extra-class"><pre class="language-json"><code>POST /iktest/article/_bulk?pretty
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;subject&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;＂闺蜜＂崔顺实被韩检方传唤 韩总统府促彻查真相&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;subject&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;韩举行＂护国训练＂ 青瓦台:决不许国家安全出问题&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;3&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;subject&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;媒体称FBI已经取得搜查令 检视希拉里电邮&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;4&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;subject&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;村上春树获安徒生奖 演讲中谈及欧洲排外问题&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;5&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;subject&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;希拉里团队炮轰FBI 参院民主党领袖批其”违法”&quot;</span> <span class="token punctuation">}</span>
</code></pre></div><p>查看分词器</p> <p>对&quot;希拉里和韩国&quot;进行分词查询</p> <p>ikmaxword分词后的效果：希|拉|里|希拉里|和|韩国</p> <div class="language-json extra-class"><pre class="language-json"><code>POST /iktest/article/_search?pretty
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;subject&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;希拉里和韩国&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;highlight&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;pre_tags&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&lt;font color=red&gt;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;post_tags&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&lt;/font&gt;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;fields&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;subject&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="第五步、配置热词更新"><a href="#第五步、配置热词更新" class="header-anchor">#</a> 第五步、配置热词更新</h4> <p>查看分词效果</p> <div class="language-json extra-class"><pre class="language-json"><code>GET _analyze?pretty
  <span class="token punctuation">{</span>
    <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;text&quot;</span><span class="token operator">:</span> <span class="token string">&quot;小老弟，你怎么肥事，老铁你来了！！！&quot;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>我们会发现，随着时间的推移和发展，有些网络热词我们并不能进行分词，因为网络热词并没有定义在我们的词库里面，这就需要我们经常能够实时的更新我们的网络热词，我们可以通过tomcat来实现远程词库来解决这个问题。</p> <h5 id="_1、node03配置tomcat"><a href="#_1、node03配置tomcat" class="header-anchor">#</a> 1、node03配置Tomcat</h5> <p>使用hadoop用户来进行配置tomcat，此处我们将tomcat装在node03机器上面即可，将我们的tomcat安装包上传到node03服务器的/kkb/soft路径下，然后进行解压</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/soft/

tar -zxf apache-tomcat-8.5.34.tar.gz -C /kkb/install/
</code></pre></div><p>tomcat当中添加配置hot.dic</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/apache-tomcat-8.5.34/webapps/ROOT

vi hot.dic 
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>老铁
肥事
</code></pre></div><p>启动tomcat</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/apache-tomcat-8.5.34/

bin/startup.sh
</code></pre></div><p>浏览器访问以验证tomcat是否安装成功</p> <p>wget http://node03:8080/hot.dic</p> <p>如果能够访问到，则证明tomcat安装成功</p> <h5 id="_2、-三台机器修改配置文件"><a href="#_2、-三台机器修改配置文件" class="header-anchor">#</a> 2、 三台机器修改配置文件</h5> <p>三台机器都要修改es的配置文件（使用es用户来进行修改即可）</p> <p>第一台机器node01修改es的配置</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/elasticsearch-6.7.0/plugins/analysis-ik/config

vim IKAnalyzer.cfg.xml
</code></pre></div><div class="language-xml extra-class"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">properties</span> <span class="token name">SYSTEM</span> <span class="token string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>comment</span><span class="token punctuation">&gt;</span></span>IK Analyzer 扩展配置<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>comment</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ext_dict<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
         <span class="token comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ext_stopwords<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>remote_ext_dict<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>http://node03:8080/hot.dic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span>
        <span class="token comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>修改完成之后拷贝到node02与node03机器上面去</p> <p>node01执行以下命令进行拷贝</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/elasticsearch-6.7.0/plugins/analysis-ik/config 

<span class="token function">scp</span> IKAnalyzer.cfg.xml node02:<span class="token environment constant">$PWD</span> 

<span class="token function">scp</span> IKAnalyzer.cfg.xml node03:<span class="token environment constant">$PWD</span> 
</code></pre></div><h5 id="_3、三台机器重新启动es"><a href="#_3、三台机器重新启动es" class="header-anchor">#</a> 3、三台机器重新启动es</h5> <p>三台机器重新启动es服务，三台机器先使用kill -9杀死es的服务，然后再执行以下命令进行重启</p> <div class="language- extra-class"><pre class="language-text"><code>ps -ef|grep elasticsearch | grep bootstrap | awk '{print $2}' |xargs kill -9

nohup /kkb/install/elasticsearch-6.7.0/bin/elasticsearch 2&gt;&amp;1 &amp;
</code></pre></div><p>在kibana当中执行以下命令，查看我们的分词过程</p> <div class="language-json extra-class"><pre class="language-json"><code> GET _analyze?pretty
  <span class="token punctuation">{</span>
    <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;text&quot;</span><span class="token operator">:</span> <span class="token string">&quot;小老弟，你怎么肥事，老铁你来了&quot;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="_10、elasticsearch的javaapi操作"><a href="#_10、elasticsearch的javaapi操作" class="header-anchor">#</a> 10、Elasticsearch的JavaAPI操作</h3> <h4 id="_1-创建maven工程-并添加jar包坐标依赖"><a href="#_1-创建maven工程-并添加jar包坐标依赖" class="header-anchor">#</a> 1：创建maven工程，并添加jar包坐标依赖</h4> <p>创建maven工程，并导入以下jar包坐标依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.elasticsearch.client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>transport<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>6.7.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.logging.log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>log4j-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.9.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.junit.jupiter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit-jupiter-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.3.0-M1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba/fastjson --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.47<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><h4 id="_2-添加索引文件操作"><a href="#_2-添加索引文件操作" class="header-anchor">#</a> 2：添加索引文件操作</h4> <h5 id="_1、创建client"><a href="#_1、创建client" class="header-anchor">#</a> 1、创建Client</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">TransportClient</span> client<span class="token punctuation">;</span>
<span class="token annotation punctuation">@BeforeEach</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Settings</span> settings <span class="token operator">=</span> <span class="token class-name">Settings</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;cluster.name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;myes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PreBuiltTransportClient</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTransportAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransportAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">9300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTransportAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransportAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token string">&quot;node02&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">9300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_2、自己拼装json创建索引保存到myindex1索引库下面的article当中去"><a href="#_2、自己拼装json创建索引保存到myindex1索引库下面的article当中去" class="header-anchor">#</a> 2、自己拼装json创建索引保存到myindex1索引库下面的article当中去</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 插入json格式的索引数据
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token string">&quot;{&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;\&quot;user\&quot;:\&quot;kimchy\&quot;,&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;\&quot;postDate\&quot;:\&quot;2013-01-30\&quot;,&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;\&quot;message\&quot;:\&quot;travelying out Elasticsearch\&quot;&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;}&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">IndexResponse</span> indexResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;myindex1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;article&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_3、使用map创建索引"><a href="#_3、使用map创建索引" class="header-anchor">#</a> 3、使用map创建索引</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">index2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> jsonMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jsonMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jsonMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;sex&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jsonMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;18&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jsonMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bj&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IndexResponse</span> indexResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;myindex1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;article&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>jsonMap<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_4、xcontentbuilder实现创建索引"><a href="#_4、xcontentbuilder实现创建索引" class="header-anchor">#</a> 4、XcontentBuilder实现创建索引</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 通过XContentBuilder来实现索引的创建
 * @throws IOException
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">index3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">IndexResponse</span> indexResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;myindex1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;article&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">XContentFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">jsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;lisi&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;18&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;sex&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bj&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h5 id="_5、将对象转换为json格式字符串进行创建索引"><a href="#_5、将对象转换为json格式字符串进行创建索引" class="header-anchor">#</a> 5、将对象转换为json格式字符串进行创建索引</h5> <p>定义person对象</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name <span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> sex<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>
    <span class="token keyword">private</span>  <span class="token class-name">String</span> say<span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Integer</span> age<span class="token punctuation">,</span> <span class="token class-name">Integer</span> sex<span class="token punctuation">,</span> <span class="token class-name">String</span> address<span class="token punctuation">,</span> <span class="token class-name">String</span> phone<span class="token punctuation">,</span> <span class="token class-name">String</span> email<span class="token punctuation">,</span><span class="token class-name">String</span> say<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sex <span class="token operator">=</span> sex<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> address<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>phone <span class="token operator">=</span> phone<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>email <span class="token operator">=</span> email<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>say <span class="token operator">=</span> say<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> say<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSay</span><span class="token punctuation">(</span><span class="token class-name">String</span> say<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>say <span class="token operator">=</span> say<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSex</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> sex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sex <span class="token operator">=</span> sex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> address<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token class-name">String</span> address<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> address<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> phone<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPhone</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>phone <span class="token operator">=</span> phone<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> email<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEmail</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>email <span class="token operator">=</span> email<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>插入索引数据</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 将java对象转换为json格式字符串进行创建索引
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">objToIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    person<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    person<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    person<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;张三丰&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    person<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;武当山&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    person<span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span><span class="token string">&quot;zhangsanfeng@163.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    person<span class="token punctuation">.</span><span class="token function">setPhone</span><span class="token punctuation">(</span><span class="token string">&quot;18588888888&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    person<span class="token punctuation">.</span><span class="token function">setSex</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;myindex1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;article&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;32&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span><span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6、批量创建索引"><a href="#_6、批量创建索引" class="header-anchor">#</a> 6、批量创建索引</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 批量创建索引
 * @throws IOException
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">index4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">BulkRequestBuilder</span> bulk <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareBulk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bulk<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;myindex1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;article&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">XContentFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">jsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;wangwu&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;18&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;sex&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bj&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bulk<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;news&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;article&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">XContentFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">jsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;zhaoliu&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;18&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;sex&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bj&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BulkResponse</span> bulkResponse <span class="token operator">=</span> bulk<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bulkResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3、查询索引"><a href="#_3、查询索引" class="header-anchor">#</a> 3、查询索引</h4> <h5 id="_1、初始化一批数据到索引库中准备查询"><a href="#_1、初始化一批数据到索引库中准备查询" class="header-anchor">#</a> 1、初始化一批数据到索引库中准备查询</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 初始化一批数据到索引库当中去准备做查询使用
 * 注意这里初始化的时候，需要给我们的数据设置分词属性
 * @throws Exception
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createIndexBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Settings</span> settings <span class="token operator">=</span> <span class="token class-name">Settings</span>
            <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;cluster.name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;myes&quot;</span><span class="token punctuation">)</span> <span class="token comment">//节点名称， 在es配置的时候设置</span>
            <span class="token comment">//自动发现我们其他的es的服务器</span>
            <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;client.transport.sniff&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建客户端</span>
    <span class="token class-name">TransportClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PreBuiltTransportClient</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addTransportAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransportAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//以本机作为节点</span>
    <span class="token comment">//创建映射</span>
    <span class="token class-name">XContentBuilder</span> mapping <span class="token operator">=</span> <span class="token class-name">XContentFactory</span><span class="token punctuation">.</span><span class="token function">jsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;properties&quot;</span><span class="token punctuation">)</span>
            <span class="token comment">//      .startObject(&quot;m_id&quot;).field(&quot;type&quot;,&quot;keyword&quot;).endObject()</span>
            <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;integer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;analyzer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;integer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;sex&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;analyzer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;analyzer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;say&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;analyzer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//pois：索引名   cxyword：类型名（可以自己定义）</span>
    <span class="token class-name">PutMappingRequest</span> putmap <span class="token operator">=</span> <span class="token class-name">Requests</span><span class="token punctuation">.</span><span class="token function">putMappingRequest</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>mapping<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建索引</span>
    client<span class="token punctuation">.</span><span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prepareCreate</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">actionGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//为索引添加映射</span>
    client<span class="token punctuation">.</span><span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putMapping</span><span class="token punctuation">(</span>putmap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">actionGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token class-name">BulkRequestBuilder</span> bulkRequestBuilder <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareBulk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Person</span> lujunyi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;玉麒麟卢俊义&quot;</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;水泊梁山&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;17666666666&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;lujunyi@163.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hello world今天天气还不错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Person</span> wuyong <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;智多星吴用&quot;</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;水泊梁山&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;17666666666&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;wuyong@163.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;行走四方，抱打不平&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Person</span> gongsunsheng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">&quot;入云龙公孙胜&quot;</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;水泊梁山&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;17666666666&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;gongsunsheng@163.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;走一个&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Person</span> guansheng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">&quot;大刀关胜&quot;</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;水泊梁山&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;17666666666&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;wusong@163.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;我的大刀已经饥渴难耐&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Person</span> linchong <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">&quot;豹子头林冲&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;水泊梁山&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;17666666666&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;linchong@163.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;梁山好汉&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Person</span> qinming <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">&quot;霹雳火秦明&quot;</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;水泊梁山&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;17666666666&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;qinming@163.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;不太了解&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Person</span> huyanzhuo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">&quot;双鞭呼延灼&quot;</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;水泊梁山&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;17666666666&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;huyanzhuo@163.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;不是很熟悉&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Person</span> huarong <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">&quot;小李广花荣&quot;</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;水泊梁山&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;17666666666&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;huarong@163.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;打酱油的&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Person</span> chaijin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">&quot;小旋风柴进&quot;</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;水泊梁山&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;17666666666&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;chaijin@163.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;吓唬人的&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Person</span> zhisheng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token string">&quot;花和尚鲁智深&quot;</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;水泊梁山&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;17666666666&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;luzhisheng@163.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;倒拔杨垂柳&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Person</span> wusong <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token string">&quot;行者武松&quot;</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;水泊梁山&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;17666666666&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;wusong@163.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;二营长。。。。。。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    bulkRequestBuilder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>lujunyi<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    bulkRequestBuilder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>wuyong<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    bulkRequestBuilder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>gongsunsheng<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    bulkRequestBuilder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>guansheng<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    bulkRequestBuilder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>linchong<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    bulkRequestBuilder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;6&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>qinming<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    bulkRequestBuilder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;7&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>huyanzhuo<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    bulkRequestBuilder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;8&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>huarong<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    bulkRequestBuilder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;9&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>chaijin<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    bulkRequestBuilder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>zhisheng<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    bulkRequestBuilder<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;11&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>wusong<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    bulkRequestBuilder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h5 id="_2、通过数据id使用prepareget来查询索引"><a href="#_2、通过数据id使用prepareget来查询索引" class="header-anchor">#</a> 2、通过数据id使用prepareGet来查询索引</h5> <p>通过id来进行查询索引</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 通过id来进行精确查询
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">query1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">GetResponse</span> documentFields <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareGet</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;11&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> index <span class="token operator">=</span> documentFields<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> type <span class="token operator">=</span> documentFields<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> id <span class="token operator">=</span> documentFields<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> source <span class="token operator">=</span> documentFields<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> source<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h5 id="_3、查询索引库当中的所有数据"><a href="#_3、查询索引库当中的所有数据" class="header-anchor">#</a> 3、查询索引库当中的所有数据</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 查询所有数据
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> client
            <span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MatchAllQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h5 id="_4、rangequery范围值查询"><a href="#_4、rangequery范围值查询" class="header-anchor">#</a> 4、RangeQuery范围值查询</h5> <p>查找索引库当中年龄为18到28的所有人</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 查找年龄18到28的人,包含18和28
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span>  <span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RangeQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits1 <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> documentFields <span class="token operator">:</span> hits1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>documentFields<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_5、termquery词条查询"><a href="#_5、termquery词条查询" class="header-anchor">#</a> 5、termQuery词条查询</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 词条查询
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TermQueryBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;say&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;熟悉&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits1 <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> documentFields <span class="token operator">:</span> hits1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>documentFields<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h5 id="_6、fuzzyquery模糊查询"><a href="#_6、fuzzyquery模糊查询" class="header-anchor">#</a> 6、fuzzyQuery模糊查询</h5> <p>模糊查询可以自动帮我们纠正写错误的英文单词，最大纠正次数两次</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * fuzzyQuery表示英文单词的最大可纠正次数，最大可以自动纠正两次
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fuzzyQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">fuzzyQuery</span><span class="token punctuation">(</span><span class="token string">&quot;say&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;helOL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fuzziness</span><span class="token punctuation">(</span><span class="token class-name">Fuzziness</span><span class="token punctuation">.</span>TWO<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits1 <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> documentFields <span class="token operator">:</span> hits1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>documentFields<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h5 id="_7、wildcardquery通配符查询"><a href="#_7、wildcardquery通配符查询" class="header-anchor">#</a> 7、wildCardQuery通配符查询</h5> <p>*：匹配任意多个字符</p> <p>？：仅匹配一个字符</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 模糊匹配查询有两种匹配符，分别是&quot; * &quot; 以及 &quot; ? &quot;， 用&quot; * &quot;来匹配任何字符，包括空字符串。用&quot; ? &quot;来匹配任意的单个字符
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wildCardQueryTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">wildcardQuery</span><span class="token punctuation">(</span><span class="token string">&quot;say&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hel*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits1 <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> documentFields <span class="token operator">:</span> hits1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>documentFields<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h5 id="_8、boolquery-多条件组合查询"><a href="#_8、boolquery-多条件组合查询" class="header-anchor">#</a> 8、boolQuery 多条件组合查询</h5> <p>使用boolQuery实现多条件组合查询</p> <p>查询年龄是18到28范围内且性别是男性的，或者id范围在10到13范围内的</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 多条件组合查询 boolQuery
 * 查询年龄是18到28范围内且性别是男性的，或者id范围在10到13范围内的
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">boolQueryTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">RangeQueryBuilder</span> age <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TermQueryBuilder</span> sex <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;sex&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RangeQueryBuilder</span> id <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;9&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token string">&quot;15&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setQuery</span><span class="token punctuation">(</span>
                    <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>sex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits1 <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> documentFields <span class="token operator">:</span> hits1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>documentFields<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h5 id="_9、分页与高亮查询"><a href="#_9、分页与高亮查询" class="header-anchor">#</a> 9、分页与高亮查询</h5> <h6 id="_1、分页查询"><a href="#_1、分页查询" class="header-anchor">#</a> 1、分页查询</h6> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/*分页查询
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getPageIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span>  pageSize <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> pageNum <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> startNum <span class="token operator">=</span> <span class="token punctuation">(</span>pageNum<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addSort</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span>ASC<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setFrom</span><span class="token punctuation">(</span>startNum<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setSize</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits1 <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> documentFields <span class="token operator">:</span> hits1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>documentFields<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h6 id="_2、高亮查询"><a href="#_2、高亮查询" class="header-anchor">#</a> 2、高亮查询</h6> <p>在进行关键字搜索时，搜索出的内容中的关键字会显示不同的颜色，称之为高亮</p> <p>百度搜索关键字&quot;周星驰&quot;</p> <p><img src="/assets/img/image-20200519011440548.b2cdd5d3.png" alt="image-20200519011440548"></p> <p>京东商城搜索&quot;笔记本&quot;</p> <p><img src="/assets/img/image-20200519011449668.ece6d192.png" alt="image-20200519011449668"></p> <h6 id="_3、高亮显示的html分析"><a href="#_3、高亮显示的html分析" class="header-anchor">#</a> 3、高亮显示的html分析</h6> <p>通过开发者工具查看高亮数据的html代码实现：</p> <p><img src="/assets/img/image-20200519011503099.dbbe779b.png" alt="image-20200519011503099"></p> <p>ElasticSearch可以对查询出的内容中关键字部分进行标签和样式的设置，但是你需要告诉ElasticSearch使用什么标签对高亮关键字进行包裹</p> <h6 id="_4、高亮显示代码实现"><a href="#_4、高亮显示代码实现" class="header-anchor">#</a> 4、高亮显示代码实现</h6> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 高亮查询
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span>  <span class="token keyword">void</span>  <span class="token function">highLight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//设置我们的查询高亮字段</span>
    <span class="token class-name">SearchRequestBuilder</span> searchRequestBuilder <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;say&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//设置我们字段高亮的前缀与后缀</span>
    <span class="token class-name">HighlightBuilder</span> highlightBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    highlightBuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;say&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;font style='color:red'&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/font&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//通过高亮来进行我们的数据查询</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> searchRequestBuilder<span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span>highlightBuilder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;查询出来一共&quot;</span><span class="token operator">+</span> hits<span class="token punctuation">.</span>totalHits<span class="token operator">+</span><span class="token string">&quot;条数据&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//打印没有高亮显示的数据</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;=========================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//打印我们经过高亮显示之后的数据</span>
       <span class="token class-name">Text</span><span class="token punctuation">[</span><span class="token punctuation">]</span> says <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;say&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Text</span> say <span class="token operator">:</span> says<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>say<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

     <span class="token comment">/*   Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();
        System.out.println(highlightFields);*/</span>
    <span class="token punctuation">}</span>
    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="_4、更新索引"><a href="#_4、更新索引" class="header-anchor">#</a> 4、更新索引</h4> <p>根据系统给数据生成的id来进行更新索引</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 更新索引
 * 根据数据id来进行更新索引
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Person</span> guansheng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">&quot;宋江&quot;</span><span class="token punctuation">,</span> <span class="token number">88</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;水泊梁山&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;17666666666&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;wusong@kkb.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;及时雨宋江&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">prepareUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIndex</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setDoc</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>guansheng<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="_5、删除索引"><a href="#_5、删除索引" class="header-anchor">#</a> 5、删除索引</h4> <h5 id="_1、按照id进行删除"><a href="#_1、按照id进行删除" class="header-anchor">#</a> 1、按照id进行删除</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 按照id进行删除数据
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">DeleteResponse</span> deleteResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareDelete</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mysearch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;14&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h5 id="_2、按照查询条件来进行删除"><a href="#_2、按照查询条件来进行删除" class="header-anchor">#</a> 2、按照查询条件来进行删除</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/*
按照条件进行删除
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span>  <span class="token function">deleteByQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token class-name">BulkByScrollResponse</span> bulkByScrollResponse <span class="token operator">=</span> <span class="token class-name">DeleteByQueryAction</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">newRequestBuilder</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> deleted <span class="token operator">=</span> bulkByScrollResponse<span class="token punctuation">.</span><span class="token function">getDeleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>deleted<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre></div><h5 id="_3、删除整个索引库"><a href="#_3、删除整个索引库" class="header-anchor">#</a> 3、删除整个索引库</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 删除索引
 * 删除整个索引库
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span>  <span class="token keyword">void</span>  <span class="token function">deleteIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">DeleteIndexResponse</span> indexsearch <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prepareDelete</span><span class="token punctuation">(</span><span class="token string">&quot;indexsearch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">actionGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_11、es的高级javaapi操作"><a href="#_11、es的高级javaapi操作" class="header-anchor">#</a> 11、es的高级javaAPI操作</h3> <p>现有结构化数据内容如下：</p> <table><thead><tr><th>name</th> <th>age</th> <th>salary</th> <th>team</th> <th>position</th></tr></thead> <tbody><tr><td>张云雷</td> <td>26</td> <td>2000</td> <td>war</td> <td>pf</td></tr> <tr><td>特斯拉</td> <td>20</td> <td>500</td> <td>tim</td> <td>sf</td></tr> <tr><td>于谦</td> <td>25</td> <td>2000</td> <td>cav</td> <td>pg</td></tr> <tr><td>爱迪生</td> <td>40</td> <td>1000</td> <td>tim</td> <td>pf</td></tr> <tr><td>爱因斯坦</td> <td>21</td> <td>300</td> <td>tim</td> <td>sg</td></tr> <tr><td>郭德纲</td> <td>33</td> <td>3000</td> <td>cav</td> <td>sf</td></tr> <tr><td>牛顿</td> <td>21</td> <td>500</td> <td>tim</td> <td>c</td></tr> <tr><td>岳云鹏</td> <td>29</td> <td>1000</td> <td>war</td> <td>pg</td></tr></tbody></table> <p>初始化一批数据到es索引库当中去</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
     * 批量添加数据
     * @throws IOException
     * @throws ExecutionException
     * @throws InterruptedException
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addIndexDatas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取settings</span>
        <span class="token comment">//配置es集群的名字</span>
        <span class="token class-name">Settings</span> settings <span class="token operator">=</span> <span class="token class-name">Settings</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;cluster.name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;myes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取客户端</span>
        <span class="token class-name">TransportAddress</span> transportAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransportAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token string">&quot;node01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TransportAddress</span> transportAddress2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransportAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token string">&quot;node02&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TransportAddress</span> transportAddress3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransportAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token string">&quot;node03&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取client客户端</span>
        <span class="token class-name">TransportClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PreBuiltTransportClient</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTransportAddress</span><span class="token punctuation">(</span>transportAddress<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTransportAddress</span><span class="token punctuation">(</span>transportAddress2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTransportAddress</span><span class="token punctuation">(</span>transportAddress3<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * 创建索引
         * */</span>
        client<span class="token punctuation">.</span><span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prepareCreate</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//构建json的数据格式，创建映射</span>
        <span class="token class-name">XContentBuilder</span> mappingBuilder <span class="token operator">=</span> <span class="token class-name">XContentFactory</span><span class="token punctuation">.</span><span class="token function">jsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;properties&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;fielddata&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;integer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;salary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;integer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;team&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;fielddata&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">&quot;position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;fielddata&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PutMappingRequest</span> request <span class="token operator">=</span> <span class="token class-name">Requests</span><span class="token punctuation">.</span><span class="token function">putMappingRequest</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>mappingBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putMapping</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//批量添加数据开始</span>

        <span class="token class-name">BulkRequestBuilder</span> bulkRequest <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareBulk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// either use client#prepare, or use Requests## to directly build index/delete requests</span>
        bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token function">jsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;郭德纲&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;salary&quot;</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;team&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;cav&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;position&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;sf&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token function">jsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;于谦&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;salary&quot;</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;team&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;cav&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;position&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;pg&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token function">jsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;岳云鹏&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;salary&quot;</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;team&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;war&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;position&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;pg&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token function">jsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;孙越&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;salary&quot;</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;team&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;war&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;position&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;sg&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token function">jsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;张云雷&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;salary&quot;</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;team&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;war&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;position&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;pf&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;6&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token function">jsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;爱迪生&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;salary&quot;</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;team&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;tim&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;position&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;pf&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;7&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token function">jsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;牛顿&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;salary&quot;</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;team&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;tim&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;position&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token function">jsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;爱因斯坦&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;salary&quot;</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;team&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;tim&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;position&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;sg&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">prepareIndex</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;player&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;8&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token function">jsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;特斯拉&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;salary&quot;</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;team&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;tim&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;position&quot;</span> <span class="token punctuation">,</span> <span class="token string">&quot;sf&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">BulkResponse</span> bulkResponse <span class="token operator">=</span> bulkRequest<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre></div><h4 id="需求一-统计每个球队当中球员的数量"><a href="#需求一-统计每个球队当中球员的数量" class="header-anchor">#</a> 需求一：统计每个球队当中球员的数量</h4> <p>sql语句实现</p> <div class="language- extra-class"><pre class="language-text"><code>select team, count(*) as player_count from player group by team;
</code></pre></div><p>使用javaAPI实现</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">groupAndCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1：构建查询提交</span>
    <span class="token class-name">SearchRequestBuilder</span> builder <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2：指定聚合条件</span>
    <span class="token class-name">TermsAggregationBuilder</span> team <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;player_count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;team&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3:将聚合条件放入查询条件中</span>
    builder<span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span>team<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//4:执行action，返回searchResponse</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Aggregations</span> aggregations <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Aggregation</span> aggregation <span class="token operator">:</span> aggregations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringTerms</span> stringTerms <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringTerms</span><span class="token punctuation">)</span> aggregation<span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StringTerms<span class="token punctuation">.</span>Bucket</span><span class="token punctuation">&gt;</span></span> buckets <span class="token operator">=</span> stringTerms<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StringTerms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bucket<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bucket<span class="token punctuation">.</span><span class="token function">getDocCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="需求二-统计每个球队中每个位置的球员数量"><a href="#需求二-统计每个球队中每个位置的球员数量" class="header-anchor">#</a> 需求二：统计每个球队中每个位置的球员数量</h4> <p>sql语句实现</p> <div class="language- extra-class"><pre class="language-text"><code>select team, position, count(*) as pos_count from player group by team, position;
</code></pre></div><p>java代码实现</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 统计每个球队中每个位置的球员数量
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">teamAndPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">SearchRequestBuilder</span> builder <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TermsAggregationBuilder</span> team <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;player_count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;team&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TermsAggregationBuilder</span> position <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;posititon_count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    team<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span>team<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Aggregations</span> aggregations <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Aggregation</span> aggregation <span class="token operator">:</span> aggregations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// System.out.println(aggregation.toString());</span>
        <span class="token class-name">StringTerms</span> stringTerms <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringTerms</span><span class="token punctuation">)</span> aggregation<span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StringTerms<span class="token punctuation">.</span>Bucket</span><span class="token punctuation">&gt;</span></span> buckets <span class="token operator">=</span> stringTerms<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StringTerms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> docCount <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getDocCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> key <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;当前队伍名称为&quot;</span> <span class="token operator">+</span>  key <span class="token operator">+</span> <span class="token string">&quot;该队伍下有&quot;</span><span class="token operator">+</span>docCount <span class="token operator">+</span> <span class="token string">&quot;个球员&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Aggregation</span> posititon_count <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;posititon_count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> posititon_count<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">StringTerms</span> positionTrem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringTerms</span><span class="token punctuation">)</span> posititon_count<span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StringTerms<span class="token punctuation">.</span>Bucket</span><span class="token punctuation">&gt;</span></span> buckets1 <span class="token operator">=</span> positionTrem<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StringTerms<span class="token punctuation">.</span>Bucket</span> bucket1 <span class="token operator">:</span> buckets1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Object</span> key1 <span class="token operator">=</span> bucket1<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">long</span> docCount1 <span class="token operator">=</span> bucket1<span class="token punctuation">.</span><span class="token function">getDocCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;该队伍下面的位置为&quot;</span> <span class="token operator">+</span>  key1<span class="token operator">+</span><span class="token string">&quot;该位置下有&quot;</span> <span class="token operator">+</span>  docCount1 <span class="token operator">+</span><span class="token string">&quot;人&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="需求三-分组求各种值"><a href="#需求三-分组求各种值" class="header-anchor">#</a> 需求三：分组求各种值</h4> <p>计算每个球队年龄最大值</p> <div class="language- extra-class"><pre class="language-text"><code>select team, max(age) as max_age from player group by team;
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 计算每个球队年龄最大值
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">groupAndMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">SearchRequestBuilder</span> builder <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TermsAggregationBuilder</span> team <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;team_group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;team&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">MaxAggregationBuilder</span> age <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token string">&quot;max_age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    team<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span>team<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Aggregations</span> aggregations <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Aggregation</span> aggregation <span class="token operator">:</span> aggregations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringTerms</span> stringTerms <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringTerms</span><span class="token punctuation">)</span> aggregation<span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StringTerms<span class="token punctuation">.</span>Bucket</span><span class="token punctuation">&gt;</span></span> buckets <span class="token operator">=</span> stringTerms<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StringTerms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Aggregation</span> max_age <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;max_age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>max_age<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="需求四-统计每个球队年龄最小值"><a href="#需求四-统计每个球队年龄最小值" class="header-anchor">#</a> 需求四：统计每个球队年龄最小值</h4> <p>计算每个球队年龄最大/最小/总/平均的球员年龄</p> <div class="language- extra-class"><pre class="language-text"><code>select team, min(age) as min_age from player group by team;
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 统计每个球队中年龄最小值
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span>  <span class="token keyword">void</span>  <span class="token function">teamMinAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token class-name">SearchRequestBuilder</span> builder <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">TermsAggregationBuilder</span> team <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;team_count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;team&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">MinAggregationBuilder</span> age <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token string">&quot;min_age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">TermsAggregationBuilder</span> termAggregation <span class="token operator">=</span> team<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span>termAggregation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Aggregations</span> aggregations <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Aggregation</span> aggregation <span class="token operator">:</span> aggregations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>aggregation<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">StringTerms</span> stringTerms <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringTerms</span><span class="token punctuation">)</span> aggregation<span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StringTerms<span class="token punctuation">.</span>Bucket</span><span class="token punctuation">&gt;</span></span> buckets <span class="token operator">=</span> stringTerms<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StringTerms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Aggregations</span> aggregations1 <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Aggregation</span> aggregation1 <span class="token operator">:</span> aggregations1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>aggregation1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="需求五-分组求平均值"><a href="#需求五-分组求平均值" class="header-anchor">#</a> 需求五：分组求平均值</h4> <p>计算每个球队年龄最大/最小/总/平均的球员年龄</p> <div class="language- extra-class"><pre class="language-text"><code>select team, avg(age) as max_age from player group by team;
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 计算每个球队的年龄平均值
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">avgTeamAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">SearchRequestBuilder</span> builder <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">TermsAggregationBuilder</span> team_field <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;player_count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;team&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">AvgAggregationBuilder</span> age_avg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">&quot;age_avg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    team_field<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>age_avg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span>team_field<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Aggregations</span> aggregations <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Aggregation</span> aggregation <span class="token operator">:</span> aggregations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>aggregation<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StringTerms</span> stringTerms <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringTerms</span><span class="token punctuation">)</span> aggregation<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h4 id="需求六-分组求和"><a href="#需求六-分组求和" class="header-anchor">#</a> 需求六：分组求和</h4> <p>计算每个球队球员的平均年龄，同时又要计算总年薪</p> <div class="language- extra-class"><pre class="language-text"><code>select team, avg(age)as avg_age, sum(salary) as total_salary from player group by team;
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 统计每个球队当中的球员平均年龄，以及队员总年薪
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">avgAndSum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">SearchRequestBuilder</span> builder <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">TermsAggregationBuilder</span> team_group <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;team_group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;team&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">AvgAggregationBuilder</span> avg_age <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">&quot;avg_age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SumAggregationBuilder</span> sumMoney <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">&quot;sum_money&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;salary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token class-name">TermsAggregationBuilder</span> termsAggregationBuilder <span class="token operator">=</span> team_group<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>avg_age<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>sumMoney<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span>termsAggregationBuilder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Aggregations</span> aggregations <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Aggregation</span> aggregation <span class="token operator">:</span> aggregations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>aggregation<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre></div><h4 id="需求七-聚合排序"><a href="#需求七-聚合排序" class="header-anchor">#</a> 需求七：聚合排序</h4> <p>计算每个球队总年薪，并按照总年薪倒序排列</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 计算每个球队总年薪，并按照年薪进行排序
 *     select team, sum(salary) as total_salary from player group by team order by total_salary desc;
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">orderBySum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">SearchRequestBuilder</span> builder <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;player&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TermsAggregationBuilder</span> teamGroup <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;team_group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;team&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">BucketOrder</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SumAggregationBuilder</span> sumSalary <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">&quot;sum_salary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;salary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TermsAggregationBuilder</span> termsAggregationBuilder <span class="token operator">=</span> teamGroup<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>sumSalary<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span>termsAggregationBuilder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Aggregation</span><span class="token punctuation">&gt;</span></span> stringAggregationMap <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stringAggregationMap<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Aggregations</span> aggregations <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Aggregation</span> aggregation <span class="token operator">:</span> aggregations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>aggregation<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_12、es当中的地理位置搜索"><a href="#_12、es当中的地理位置搜索" class="header-anchor">#</a> 12、ES当中的地理位置搜索</h3> <p>ES不仅可以对我们的数据进行聚合操作，还可以针对我们的地理位置经纬度进行搜索，可以通过ES搜索我们附近的人等等各种基于地理位置的需求</p> <p>经纬度在线解析网站</p> <p>http://www.gpsspg.com/maps.htm</p> <h4 id="第一步-创建索引库并添加数据"><a href="#第一步-创建索引库并添加数据" class="header-anchor">#</a> 第一步：创建索引库并添加数据</h4> <p>直接在kibana当中通过以下操作创建索引库，并添加一条数据</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT platform_foreign_website
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
     <span class="token property">&quot;store&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
      <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
         <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;storeName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;location&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;geo_point&quot;</span>
          <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>添加数据</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token number">40.0488115498</span><span class="token punctuation">,</span><span class="token number">116.4320345091</span>
PUT /platform_foreign_website/store/<span class="token number">40</span>?pretty
<span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;40&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;storeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;北京市北京市朝阳区清河营东路2号院&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;longitude&quot;</span><span class="token operator">:</span><span class="token number">116.4320345091</span><span class="token punctuation">,</span><span class="token property">&quot;latitude&quot;</span><span class="token operator">:</span><span class="token number">40.0488115498</span><span class="token punctuation">,</span><span class="token property">&quot;isdelete&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;location&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;lat&quot;</span><span class="token operator">:</span><span class="token number">40.0488115498</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lon&quot;</span><span class="token operator">:</span><span class="token number">116.4320345091</span>
  
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">40.0461174292</span><span class="token punctuation">,</span><span class="token number">116.4360685514</span>
PUT /platform_foreign_website/store/<span class="token number">41</span>?pretty
<span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;40&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;storeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;北京市北京市朝阳区北苑东路&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;longitude&quot;</span><span class="token operator">:</span><span class="token number">116.4360685514</span><span class="token punctuation">,</span><span class="token property">&quot;latitude&quot;</span><span class="token operator">:</span><span class="token number">40.0461174292</span><span class="token punctuation">,</span><span class="token property">&quot;isdelete&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;location&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;lat&quot;</span><span class="token operator">:</span><span class="token number">40.0461174292</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lon&quot;</span><span class="token operator">:</span><span class="token number">116.4360685514</span>
  
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">40.0519526142</span><span class="token punctuation">,</span><span class="token number">116.4178513254</span>
PUT /platform_foreign_website/store/<span class="token number">42</span>?pretty
<span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;42&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;storeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;北京市北京市朝阳区立通路&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;longitude&quot;</span><span class="token operator">:</span><span class="token number">116.4178513254</span><span class="token punctuation">,</span><span class="token property">&quot;latitude&quot;</span><span class="token operator">:</span><span class="token number">40.0519526142</span><span class="token punctuation">,</span><span class="token property">&quot;isdelete&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">&quot;location&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;lat&quot;</span><span class="token operator">:</span><span class="token number">40.0519526142</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lon&quot;</span><span class="token operator">:</span><span class="token number">116.4178513254</span>
  
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">40.0503813013</span><span class="token punctuation">,</span><span class="token number">116.4562592119</span>
PUT /platform_foreign_website/store/<span class="token number">43</span>?pretty
<span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;43&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;storeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;北京市北京市朝阳区来广营北路&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;longitude&quot;</span><span class="token operator">:</span><span class="token number">116.4562592119</span><span class="token punctuation">,</span><span class="token property">&quot;latitude&quot;</span><span class="token operator">:</span><span class="token number">40.0503813013</span><span class="token punctuation">,</span><span class="token property">&quot;isdelete&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;location&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;lat&quot;</span><span class="token operator">:</span><span class="token number">40.0503813013</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lon&quot;</span><span class="token operator">:</span><span class="token number">116.4562592119</span>
  
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">40.0385828363</span><span class="token punctuation">,</span><span class="token number">116.4465266673</span>
PUT /platform_foreign_website/store/<span class="token number">44</span>?pretty
<span class="token punctuation">{</span><span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;44&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;storeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;北京市北京市朝阳区顺白路&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;longitude&quot;</span><span class="token operator">:</span><span class="token number">116.4465266673</span><span class="token punctuation">,</span><span class="token property">&quot;latitude&quot;</span><span class="token operator">:</span><span class="token number">40.0385828363</span><span class="token punctuation">,</span><span class="token property">&quot;isdelete&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;location&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;lat&quot;</span><span class="token operator">:</span><span class="token number">40.0385828363</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lon&quot;</span><span class="token operator">:</span><span class="token number">116.4465266673</span>
  
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>查询所有的数据</p> <div class="language-json extra-class"><pre class="language-json"><code>GET /platform_foreign_website/store/_search?pretty
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="第二步-添加以下jar包坐标依赖"><a href="#第二步-添加以下jar包坐标依赖" class="header-anchor">#</a> 第二步：添加以下jar包坐标依赖</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.locationtech.spatial4j/spatial4j --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.locationtech.spatial4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spatial4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.vividsolutions<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jts<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.13<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>xerces<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>xercesImpl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><p>这里说了 geo_distance（找出与指定位置在给定距离内的点） 和 geo_polygon（找出落在多边形中的点）两种方法，elasticsearch其实还有另外两种 方法 geo_bounding_box（找出落在指定矩形框中的坐标点） 和 geo_distance_range（找出与指定点距离在给定最小距离和最大距离之间的点），因为需求没有涉及到暂时没有调研，以后会慢慢晚上</p> <h4 id="第三步-使用javaapi来实现基于地理位置的搜索"><a href="#第三步-使用javaapi来实现基于地理位置的搜索" class="header-anchor">#</a> 第三步：使用javaAPI来实现基于地理位置的搜索</h4> <p>http://www.gpsspg.com/maps.htm</p> <p>经纬度在线解析</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>search<span class="token punctuation">.</span></span><span class="token class-name">SearchResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span>transport<span class="token punctuation">.</span></span><span class="token class-name">TransportClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>common<span class="token punctuation">.</span>geo<span class="token punctuation">.</span></span><span class="token class-name">GeoPoint</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>common<span class="token punctuation">.</span>settings<span class="token punctuation">.</span></span><span class="token class-name">Settings</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>common<span class="token punctuation">.</span>transport<span class="token punctuation">.</span></span><span class="token class-name">TransportAddress</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>common<span class="token punctuation">.</span>unit<span class="token punctuation">.</span></span><span class="token class-name">DistanceUnit</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>index<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span></span><span class="token class-name">SearchHit</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>transport<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">PreBuiltTransportClient</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">InetAddress</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">UnknownHostException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ESOperate</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Settings</span> settings <span class="token operator">=</span> <span class="token class-name">Settings</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;cluster.name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;myes&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TransportClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PreBuiltTransportClient</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addTransportAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransportAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token string">&quot;node03&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * 找出落在指定矩形框当中的坐标点
         *
         40.0519526142,116.4178513254

         40.0385828363,116.4465266673
         */</span>
        <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;platform_foreign_website&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;store&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">geoBoundingBoxQuery</span><span class="token punctuation">(</span><span class="token string">&quot;location&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setCorners</span><span class="token punctuation">(</span><span class="token number">40.0519526142</span><span class="token punctuation">,</span> <span class="token number">116.4178513254</span><span class="token punctuation">,</span> <span class="token number">40.0385828363</span><span class="token punctuation">,</span> <span class="token number">116.4465266673</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SearchHit</span> searchHit <span class="token operator">:</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>searchHit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**|
         * 找出坐落在多边形当中的坐标点
         *
         * 40.0519526142,116.4178513254
         *
         *          40.0519526142,116.4178513254
         *
         *          40.0385828363,116.4465266673
         *
         *
         */</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GeoPoint</span><span class="token punctuation">&gt;</span></span> points <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GeoPoint</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        points<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GeoPoint</span><span class="token punctuation">(</span><span class="token number">40.0519526142</span><span class="token punctuation">,</span> <span class="token number">116.4178513254</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        points<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GeoPoint</span><span class="token punctuation">(</span><span class="token number">40.0519526142</span><span class="token punctuation">,</span> <span class="token number">116.4178513254</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        points<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GeoPoint</span><span class="token punctuation">(</span><span class="token number">40.0385828363</span><span class="token punctuation">,</span> <span class="token number">116.4465266673</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;platform_foreign_website&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;store&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">geoPolygonQuery</span><span class="token punctuation">(</span><span class="token string">&quot;location&quot;</span><span class="token punctuation">,</span> points<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SearchHit</span> searchHit <span class="token operator">:</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>searchHit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;==================================================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * 以当前的点为中心，搜索落在半径范围内200公里的经纬度坐标点
         *40.0488115498,116.4320345091
         */</span>
        searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">prepareSearch</span><span class="token punctuation">(</span><span class="token string">&quot;platform_foreign_website&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTypes</span><span class="token punctuation">(</span><span class="token string">&quot;store&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">geoDistanceQuery</span><span class="token punctuation">(</span><span class="token string">&quot;location&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">point</span><span class="token punctuation">(</span><span class="token number">40.0488115498</span><span class="token punctuation">,</span> <span class="token number">116.4320345091</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">distance</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">DistanceUnit</span><span class="token punctuation">.</span>KILOMETERS<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SearchHit</span> searchHit <span class="token operator">:</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>searchHit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_13、elasticsearch-的sql插件使用"><a href="#_13、elasticsearch-的sql插件使用" class="header-anchor">#</a> 13、elasticsearch 的sql插件使用</h3> <p>对于这些复杂的查询，es使用javaAPI都可以实现，但是相较于sql语句来说，我们更加熟悉sql语句，所以es也提供了sql语句的开发，让我们通过sql语句即可实现ES的查询，接下来我们就来安装并学习sql的插件的使用方法吧！</p> <p>在es版本6.3之前都不支持sql语句的开发，如果需要使用sql语句来开发es的数据查询，那么我们需要手动的自己安装插件，插件下载地址如下，</p> <p><a href="https://github.com/NLPchina/elasticsearch-sql/%E3%80%81" target="_blank" rel="noopener noreferrer">https://github.com/NLPchina/elasticsearch-sql/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>但是在6.3版本之后，es自带就安装了sql的插件，我们可以直接通过sql语句的方式实现es当中的数据查询</p> <p>对于sql语句的使用，es给我们提供了三种方式，接下来我们分别看看三种方式如何实现es数据的查询</p> <h4 id="第一种方式-通过rest风格实现数据的查询"><a href="#第一种方式-通过rest风格实现数据的查询" class="header-anchor">#</a> 第一种方式：通过rest风格实现数据的查询</h4> <h5 id="第一步-使用rest方式向索引库当中添加数据"><a href="#第一步-使用rest方式向索引库当中添加数据" class="header-anchor">#</a> 第一步：使用rest方式向索引库当中添加数据</h5> <p>使用kibana向索引库当中添加数据</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT /library/book/_bulk?refresh
<span class="token punctuation">{</span><span class="token property">&quot;index&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Leviathan Wakes&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Leviathan Wakes&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;James S.A. Corey&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;release_date&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2011-06-02&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;page_count&quot;</span><span class="token operator">:</span> <span class="token number">561</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;index&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Hyperion&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Hyperion&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Dan Simmons&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;release_date&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1989-05-26&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;page_count&quot;</span><span class="token operator">:</span> <span class="token number">482</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;index&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Dune&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Dune&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Frank Herbert&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;release_date&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1965-06-01&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;page_count&quot;</span><span class="token operator">:</span> <span class="token number">604</span><span class="token punctuation">}</span>
</code></pre></div><h5 id="第二步-使用rest风格方式查询数据"><a href="#第二步-使用rest风格方式查询数据" class="header-anchor">#</a> 第二步：使用rest风格方式查询数据</h5> <div class="language-json extra-class"><pre class="language-json"><code>curl -X POST <span class="token string">&quot;node01:9200/_xpack/sql?format=txt&quot;</span> -H 'Content-Type<span class="token operator">:</span> application/json' -d'
<span class="token punctuation">{</span>
    <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SELECT * FROM library WHERE release_date &lt; \u00272000-01-01\u0027&quot;</span>
<span class="token punctuation">}</span>'
</code></pre></div><h4 id="第二种方式-使用sql脚本的方式进入sql客户端进行查询"><a href="#第二种方式-使用sql脚本的方式进入sql客户端进行查询" class="header-anchor">#</a> 第二种方式：使用sql脚本的方式进入sql客户端进行查询</h4> <p>我们也可以使用sql脚本的方式，进入sql客户端，通过sql语句的方式实现数据的查询</p> <h5 id="第一步-node01进入sql脚本客户端"><a href="#第一步-node01进入sql脚本客户端" class="header-anchor">#</a> 第一步：node01进入sql脚本客户端</h5> <p>node01执行以下命令进入sql脚本客户端</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/elasticsearch-6.7.0

bin/elasticsearch-sql-cli node01:9200
</code></pre></div><h5 id="第二步-执行sql语句"><a href="#第二步-执行sql语句" class="header-anchor">#</a> 第二步：执行sql语句</h5> <div class="language- extra-class"><pre class="language-text"><code>sql&gt; select * from library;
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code>     author     <span class="token operator">|</span>     name      <span class="token operator">|</span>  page_count   <span class="token operator">|</span>      release_date      
<span class="token comment">----------------+---------------+---------------+------------------------</span>
Dan Simmons     <span class="token operator">|</span>Hyperion       <span class="token operator">|</span><span class="token number">482</span>            <span class="token operator">|</span><span class="token number">1989</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">26</span>T00:<span class="token number">00</span>:<span class="token number">00.000</span>Z
James S<span class="token punctuation">.</span>A<span class="token punctuation">.</span> Corey<span class="token operator">|</span>Leviathan Wakes<span class="token operator">|</span><span class="token number">561</span>            <span class="token operator">|</span><span class="token number">2011</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">02</span>T00:<span class="token number">00</span>:<span class="token number">00.000</span>Z
Frank Herbert   <span class="token operator">|</span>Dune           <span class="token operator">|</span><span class="token number">604</span>            <span class="token operator">|</span><span class="token number">1965</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">01</span>T00:<span class="token number">00</span>:<span class="token number">00.000</span>Z
</code></pre></div><h4 id="第三种方式-通过jdbc连接的方式"><a href="#第三种方式-通过jdbc连接的方式" class="header-anchor">#</a> 第三种方式：通过jdbc连接的方式</h4> <p>当然了，我们也可以通过jdbc连接的方式，通过java代码来实现ES当中数据的查询操作</p> <p>官网介绍操作连接</p> <p>https://www.elastic.co/guide/en/elasticsearch/reference/6.7/sql-jdbc.html</p> <p>使用javaAPI访问数据库当中的数据，会产生一个错误，参见这篇文章</p> <p>https://www.cnblogs.com/hts-technology/p/9282421.html</p> <h5 id="第一步-导入jar包"><a href="#第一步-导入jar包" class="header-anchor">#</a> 第一步：导入jar包</h5> <p>在我们的maven依赖中添加以下坐标，导入es-sql的jar包</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repositories</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>elastic.co<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://artifacts.elastic.co/maven<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repositories</span><span class="token punctuation">&gt;</span></span>

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.elasticsearch.plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>x-pack-sql-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>6.7.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><h5 id="第二步-开发java代码-实现查询"><a href="#第二步-开发java代码-实现查询" class="header-anchor">#</a> 第二步：开发java代码，实现查询</h5> <p>通过java代码，使用jdbc连接es服务器，然后查询数据</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">esJdbc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token class-name">EsDataSource</span> dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EsDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> address <span class="token operator">=</span> <span class="token string">&quot;jdbc:es://http://node01:9200&quot;</span> <span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Properties</span> connectionProperties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setProperties</span><span class="token punctuation">(</span>connectionProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Statement</span> statement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token string">&quot;select * from library&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span> string <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> string1 <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> anInt <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> string2 <span class="token operator">=</span> resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>string <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span>  string1 <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span>  anInt <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> string2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre></div><h3 id="_14、es集群生产调优"><a href="#_14、es集群生产调优" class="header-anchor">#</a> 14、ES集群生产调优</h3> <h4 id="_1、服务器硬件以及内存调优"><a href="#_1、服务器硬件以及内存调优" class="header-anchor">#</a> 1、服务器硬件以及内存调优</h4> <h5 id="_1、调整交换区的swap大小"><a href="#_1、调整交换区的swap大小" class="header-anchor">#</a> 1、调整交换区的swap大小</h5> <p>关闭系统的交换区，禁用linux的虚拟内存，尽量让我们的ES禁用虚拟内存，因为如果使用虚拟内存，就会将内存当中过多的数据缓存到磁盘上面去，可以简单理解为就是拿了一块磁盘出来当做内存使用，这样当然性能就会急剧下降，所以在实际工作当中我们一般的都会尽量关闭linux的交换区的内存空间</p> <p>关闭交换区的空间大小</p> <div class="language-sh extra-class"><pre class="language-sh"><code>swapoff -a
</code></pre></div><p>如果不能完全禁用swap交换区的空间大小，我们可以调整设置，尽量减少swap的空间，通过调整交换区内存空间大小，来调整我们的交换比例</p> <p>swappiness参数值可设置范围在0到100之间。 低参数值会让内核尽量少用交换，更高参数值会使内核更多的去使用交换空间。默认值为60</p> <div class="language- extra-class"><pre class="language-text"><code>vim /etc/sysctl.conf

vm.swappiness=1
</code></pre></div><p>如果没法更改我们的swap的参数值，那么我们也可以在es当中配置，禁止JVM堆内存当中的数据交换到磁盘当中去</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/elasticsearch-6.7.0/config/

vim elasticsearch.yml
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>bootstrap.memory_lock:true
</code></pre></div><h5 id="_2、调整普通用户打开文件数以及线程数的限制"><a href="#_2、调整普通用户打开文件数以及线程数的限制" class="header-anchor">#</a> 2、调整普通用户打开文件数以及线程数的限制</h5> <h6 id="普通用户打开文件的最大数限制"><a href="#普通用户打开文件的最大数限制" class="header-anchor">#</a> 普通用户打开文件的最大数限制</h6> <p>ES因为需要大量的创建索引文件，需要大量的打开系统的文件，所以我们需要解除linux系统当中打开文件最大数目的限制，不然ES启动就会抛错</p> <p>三台机器使用es用户执行以下命令解除打开文件数据的限制</p> <div class="language- extra-class"><pre class="language-text"><code>sudo vi /etc/security/limits.conf
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>* soft nofile <span class="token number">65536</span>
* hard nofile <span class="token number">131072</span>
* soft nproc <span class="token number">2048</span>
* hard nproc <span class="token number">4096</span>
</code></pre></div><h6 id="普通用户启动线程数限制"><a href="#普通用户启动线程数限制" class="header-anchor">#</a> 普通用户启动线程数限制</h6> <p>三台机器执行以下命令打开文件最大数</p> <div class="language- extra-class"><pre class="language-text"><code>sudo vi /etc/sysctl.conf
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>vm.max_map_count=655360

fs.file-max=655360
</code></pre></div><p>执行以下命令生效</p> <div class="language- extra-class"><pre class="language-text"><code>sudo sysctl -p
</code></pre></div><p>注意：以上两个问题修改完成之后，一定要重新连接linux生效。关闭secureCRT或者XShell工具，然后重新打开工具连接linux即可</p> <h5 id="_3、调整es的jvm堆内存大小"><a href="#_3、调整es的jvm堆内存大小" class="header-anchor">#</a> 3、调整ES的JVM堆内存大小</h5> <p>官方建议ES的堆内存大小不要超过32GB，超过32GB之后，反而会造成大量的内存的浪费，所以我们在ES当中，JVM堆内存大小，尽量调整成小于32GB，其中堆内存大小与系统内存大小，尽量五五分，例如一台服务器64GB，那么我们可以给ES堆内存大小设置为32GB，剩下的32GB留作OS cache ，当做系统内存留给lucene来使用（因为ES底层也是基于lucene的）</p> <p>调整堆内存大小的官方建议</p> <p>https://www.elastic.co/guide/cn/elasticsearch/guide/current/heap-sizing.html</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/elasticsearch-6.7.0/config
vim jvm.options
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>-Xms32g
-Xmx32g
</code></pre></div><h4 id="_2、es的参数调优"><a href="#_2、es的参数调优" class="header-anchor">#</a> 2、ES的参数调优</h4> <h5 id="_1、es集群自动发现机制"><a href="#_1、es集群自动发现机制" class="header-anchor">#</a> 1、ES集群自动发现机制</h5> <p>配置ES集群的自动发现机制</p> <div class="language- extra-class"><pre class="language-text"><code>discovery.zen.ping.unicast.hosts: [&quot;node01&quot;, &quot;node02&quot;, &quot;node03&quot;]
</code></pre></div><p>配置在每轮ping操作中等待DNS主机名查找的超时时间。需要指定<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/common-options.html#time-units" target="_blank" rel="noopener noreferrer">时间单位<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，默认为5秒。</p> <div class="language- extra-class"><pre class="language-text"><code>discovery.zen.ping.unicast.resolve_timeout:30
</code></pre></div><h5 id="_2、集群的主节点选举"><a href="#_2、集群的主节点选举" class="header-anchor">#</a> 2、集群的主节点选举</h5> <p>ES集群当中的节点角色介绍</p> <h6 id="master"><a href="#master" class="header-anchor">#</a> Master</h6> <p>主要负责集群中索引的创建、删除以及数据的Rebalance等操作。Master不负责数据的索引和检索，所以负载较轻。当Master节点失联或者挂掉的时候，ES集群会自动从其他Master节点选举出一个Leader。为了防止脑裂，常常设置参数为discovery.zen.minimum_master_nodes=N/2+1，其中N为集群中Master节点的个数。建议集群中Master节点的个数为奇数个，如3个或者5个。</p> <p>设置为Master节点的方式如下：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>node.master: <span class="token boolean">true</span>  <span class="token comment">#设置为主节点</span>

node.data: <span class="token boolean">false</span>  <span class="token comment">#不是数据节点</span>

node.ingest: <span class="token boolean">false</span>  <span class="token comment">#不是ingest 节点</span>

search.remote.connect: <span class="token boolean">false</span>  <span class="token comment">#禁用跨集群查询</span>
</code></pre></div><h6 id="data-node"><a href="#data-node" class="header-anchor">#</a> Data Node</h6> <p>主要负责集群中数据的索引和检索，一般压力比较大。建议和Master节点分开，避免因为Data Node节点出问题影响到Master节点。</p> <p>设置一个节点为Data Node节点的方式如下：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>node.master: <span class="token boolean">false</span>    <span class="token comment">#不是主节点</span>
node.data: <span class="token boolean">true</span>       <span class="token comment">#作为数据二级店</span>
node.ingest: <span class="token boolean">false</span>    <span class="token comment">## 不是ingest节点</span>
search.remote.connect: <span class="token boolean">false</span>   <span class="token comment">#禁用跨群查询</span>
</code></pre></div><h6 id="coordinating-node"><a href="#coordinating-node" class="header-anchor">#</a> Coordinating Node</h6> <p>协作节点，主要用于协作处理集群当中的一些事情</p> <div class="language-sh extra-class"><pre class="language-sh"><code>node.master: <span class="token boolean">false</span>    <span class="token comment">#不是主节点</span>
node.data: <span class="token boolean">true</span>       <span class="token comment">#作为数据二级店</span>
node.ingest: <span class="token boolean">false</span>    <span class="token comment">## 不是ingest节点</span>
search.remote.connect: <span class="token boolean">false</span>   <span class="token comment">#禁用跨集群查询</span>
</code></pre></div><h6 id="ingest-node"><a href="#ingest-node" class="header-anchor">#</a> Ingest Node</h6> <p>Ingest node专门对索引的文档做预处理，实际中不常用，除非文档在索引之前有大量的预处理工作需要做。Ingest node设置如下：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>node.master: <span class="token boolean">false</span> node.master: <span class="token boolean">false</span>         
node.master: <span class="token boolean">false</span> 
node.data: <span class="token boolean">false</span>
node.ingest: <span class="token boolean">true</span>
search.remote.connect: <span class="token boolean">false</span>
</code></pre></div><p>以上节点当中最重要的就是Master Node，这个节点关系着我们集群的生死存放，我们可以通过设置多个master node作为我们集群当中的主节点，其中多个master node会通过选举机制实现选择一个master node作为active，其他的作为standBy，如果master active状态的主节点宕机，es会从其他的standBy状态的主节点当中重新选择一个新的作为active状态的节点</p> <p>控制节点加入某个集群或者开始选举的响应时间(默认3s)</p> <p>discovery.zen.ping_timeout:3</p> <p>在网络缓慢时，3秒时间可能不够，这种情况下，需要慎重增加超时时间，增加超时时间会减慢选举进程</p> <p>一旦节点决定加入一个存在的集群，它会发出一个加入请求给主节点，这个请求的超时时间由<code>discovery.zen.join_time</code>控制，默认是 ping 超时时间(<code>discovery.zen.ping_timeout</code>)的20倍</p> <p>当主节点停止或者出现问题，集群中的节点会重新 ping 并选举一个新节点。有时一个节点也许会错误的认为主节点已死，所以这种 ping 操作也可以作为部分网络故障的保护性措施。在这种情况下，节点将只从其他节点监听有关当前活动主节点的信息。</p> <p>如果<code>discovery.zen.master_election.ignore_non_master_pings</code>设置为<code>true</code>时（默认值为<code>false</code>），<code>node.master</code>为<code>false</code>的节点不参加主节点的选举，同时选票也不包含这种节点。</p> <p>通过设置<code>node.master</code>为<code>false</code>，可以将节点设置为非备选主节点，永远没有机会成为主节点。</p> <p><code>discovery.zen.minimum_master_nodes</code>设置了最少有多少个备选主节点参加选举，同时也设置了一个主节点需要控制最少多少个备选主节点才能继续保持主节点身份。如果控制的备选主节点少于<code>discovery.zen.minimum_master_nodes</code>个，那么当前主节点下台，重新开始选举。</p> <p><code>discovery.zen.minimum_master_nodes</code>必须设置一个恰当的备选主节点值(<code>quonum</code>，一般设置 为备选主节点数/2+1)，尽量避免只有两个备选主节点，因为两个备选主节点<code>quonum</code>应该为2，那么如果一个节点出现问题，另一个节点的同意人数最多只能为1，永远也不能选举出新的主节点，这时就发生了脑裂现象。</p> <h5 id="_3、集群的故障检测"><a href="#_3、集群的故障检测" class="header-anchor">#</a> 3、集群的故障检测</h5> <p>有两个故障检测进程在集群的生命周期中一直运行。一个是主节点的，ping集群中所有的其他节点，检查他们是否活着。另一种是每个节点都ping主节点，确认主节点是否仍在运行或者是否需要重新启动选举程序。</p> <p>使用<code>discovery.zen.fd</code>前缀设置来控制故障检测过程，配置如下</p> <table><thead><tr><th><strong>配置</strong></th> <th><strong>描述</strong></th> <th></th></tr></thead> <tbody><tr><td>discovery.zen.fd.ping_interval</td> <td>节点多久ping一次，默认1s</td> <td></td></tr> <tr><td>discovery.zen.fd.ping_timeout</td> <td>等待响应时间，默认30s</td> <td></td></tr> <tr><td>discovery.zen.fd.ping_retries</td> <td>失败或超时后重试的次数，默认3</td> <td></td></tr></tbody></table> <h5 id="_4、集群状态更新"><a href="#_4、集群状态更新" class="header-anchor">#</a> 4、集群状态更新</h5> <p>主节点是唯一一个能够更新集群状态的节点。主节点一次处理一个群集状态更新，应用所需的更改并将更新的群集状态发布到群集中的所有其他节点。当其他节点接收到状态时，先确认收到消息，但是不应用最新状态。如果主节点在规定时间（<code>discovery.zen.commit_timeout</code> ，默认30s）内没有收到大多数节点(<code>discovery.zen.minimum_master_nodes</code>)的确认，集群状态更新不被通过。</p> <p>一旦足够的节点响应了更新的消息，新的集群状态(cluster state)被提交并且会发送一条消息给所有的节点。这些节点开始在内部应用新的集群状态。在继续处理队列中的下一个更新之前，主节点等待所有节点响应，直到超时(<code>discovery.zen.publish_timeout</code>，默认设置为30秒)。上述两个超时设置都可以通过<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-update-settings.html" target="_blank" rel="noopener noreferrer">集群更新设置api<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>动态更改。</p> <h5 id="_5、no-master-block机制"><a href="#_5、no-master-block机制" class="header-anchor">#</a> 5、no Master block机制</h5> <p>对于一个可以正常充分运作的集群来说，必须拥有一个活着的主节点和正常数量(discovery.zen.minimum_master_nodes个)活跃的备选主节点。discovery.zen.no_master_block设置了没有主节点时限制的操作。它又两个可选参数</p> <p>all：所有操作均不可做，读写、包括集群状态的读写api，例如获得索引配置(index settings)，putMapping，和集群状态(cluster state)api</p> <p>write：默认为write，写操作被拒绝执行，基于最后一次已知的正常的集群状态可读，这也许会读取到已过时的数据。</p> <p>discovery.zen.no_master_block，对于节点相关的基本api，这个参数是无效的，如集群统计信息(cluster stats)，节点信息(node info)，节点统计信息(node stats)。对这些api的请求不会被阻止，并且可以在任何可用节点上运行。</p> <h5 id="_6、增加-refresh-时间间隔"><a href="#_6、增加-refresh-时间间隔" class="header-anchor">#</a> 6、增加 Refresh 时间间隔</h5> <p>为了提高索引性能，Elasticsearch 在写入数据时候，采用延迟写入的策略，即数据先写到内存中，当超过默认 1 秒 （index.refresh_interval）会进行一次写入操作，就是将内存中 segment 数据刷新到操作系统中，此时我们才能将数据搜索出来，所以这就是为什么 Elasticsearch 提供的是<strong>近实时</strong>搜索功能，而不是实时搜索功能。</p> <p>当然像我们的内部系统对数据延迟要求不高的话，我们可以通过延长 refresh 时间间隔，可以有效的减少 segment 合并压力，提供索引速度。在做全链路跟踪的过程中，我们就将 index.refresh_interval 设置为 30s，减少 refresh 次数。</p> <p>同时，在进行全量索引时，可以将 refresh 次数临时关闭，即 index.refresh_interval 设置为 -1，数据导入成功后再打开到正常模式，比如 30s。</p> <h5 id="_7、综合调优概览"><a href="#_7、综合调优概览" class="header-anchor">#</a> 7、综合调优概览</h5> <p>ES调优综合参数设置概览：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>index.merge.scheduler.max_thread_count:1 <span class="token comment">## 索引 merge ***线程数 </span>

indices.memory.index_buffer_size:30%   <span class="token comment">## 内存</span>

index.translog.durability:async <span class="token comment">## 这个可以异步写硬盘，增大写的速度 </span>

index.translog.sync_interval:120s <span class="token comment">#translog 间隔时间 </span>

discovery.zen.ping_timeout:120s <span class="token comment">## 心跳超时时间 </span>

discovery.zen.fd.ping_interval:120s   <span class="token comment">## 节点检测时间</span>

discovery.zen.fd.ping_timeout:120s   <span class="token comment">#ping 超时时间</span>

discovery.zen.fd.ping_retries:6   <span class="token comment">## 心跳重试次数</span>

thread_pool.bulk.size:20 <span class="token comment">## 写入线程个数 由于我们查询线程都是在代码里设定好的，我这里只调节了写入的线程数</span>

thread_pool.bulk.queue_size:1000 <span class="token comment">## 写入线程队列大小 </span>

index.refresh_interval:300s <span class="token comment">#index 刷新间隔复制代码</span>
</code></pre></div><h2 id="logstash日志数据采集"><a href="#logstash日志数据采集" class="header-anchor">#</a> LogStash日志数据采集</h2> <h3 id="_1、logstash介绍及安装"><a href="#_1、logstash介绍及安装" class="header-anchor">#</a> 1、LogStash介绍及安装</h3> <p>官网：</p> <p>https://www.elastic.co/guide/en/logstash/current/index.html</p> <h4 id="_1-1、介绍"><a href="#_1-1、介绍" class="header-anchor">#</a> 1.1、介绍</h4> <p>logstash就是一个具备实时数据传输能力的管道，负责将数据信息从管道的输入端传输到管道的输出端；与此同时这根管道还可以让你根据自己的需求在中间加上滤网，Logstash提供里很多功能强大的滤网以满足你的各种应用场景。是一个input | filter | output 的数据流。</p> <h4 id="_1-2-、node01机器安装logstash"><a href="#_1-2-、node01机器安装logstash" class="header-anchor">#</a> 1.2 、node01机器安装LogStash</h4> <p>下载logstache并上传到第一台服务器的/home/es路径下，然后进行解压</p> <p>下载安装包---可以直接将已经下载好的安装包上传到/home/es路径下即可</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/soft 
<span class="token function">wget</span> https://artifacts.elastic.co/downloads/logstash/logstash-6.7.0.tar.gz
<span class="token comment">## 解压</span>
<span class="token function">tar</span> -zxf logstash-6.7.0.tar.gz -C /kkb/install/
</code></pre></div><h4 id="_1-3、input插件"><a href="#_1-3、input插件" class="header-anchor">#</a> 1.3、Input插件</h4> <h5 id="_1-3-1-stdin标准输入和stdout标准输出"><a href="#_1-3-1-stdin标准输入和stdout标准输出" class="header-anchor">#</a> 1.3.1 stdin标准输入和stdout标准输出</h5> <p>使用标准的输入与输出组件，实现将我们的数据从控制台输入，从控制台输出</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/logstash-6.7.0/
bin/logstash -e <span class="token string">'input{stdin{}}output{stdout{codec=&gt;rubydebug}}'</span>
</code></pre></div><p><img src="/assets/img/image-20200519012821127.7d67b52a.png" alt="image-20200519012821127"></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
      <span class="token string">&quot;@version&quot;</span> =&gt; <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;host&quot;</span> =&gt; <span class="token string">&quot;node01&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;@timestamp&quot;</span> =&gt; <span class="token number">2018</span><span class="token number">-10</span>-13T08<span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">13</span>.126Z<span class="token punctuation">,</span>
       <span class="token string">&quot;message&quot;</span> =&gt; <span class="token string">&quot;hello&quot;</span>
<span class="token punctuation">}</span>

</code></pre></div><h5 id="_1-3-2-监控日志文件变化"><a href="#_1-3-2-监控日志文件变化" class="header-anchor">#</a> 1.3.2 监控日志文件变化</h5> <p>Logstash 使用一个名叫 <em>FileWatch</em> 的 Ruby Gem 库来监听文件变化。这个库支持 glob 展开文件路径，而且会记录一个叫 <em>.sincedb</em> 的数据库文件来跟踪被监听的日志文件的当前读取位置。所以，不要担心 logstash 会漏过你的数据。</p> <h6 id="编写脚本"><a href="#编写脚本" class="header-anchor">#</a> 编写脚本</h6> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/logstash-6.7.0/config

vim monitor_file.conf
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>input<span class="token punctuation">{</span>
    file<span class="token punctuation">{</span>
        path =&gt; <span class="token string">&quot;/kkb/install/datas/tomcat.log&quot;</span>
        type =&gt; <span class="token string">&quot;log&quot;</span>
        start_position =&gt; <span class="token string">&quot;beginning&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
output<span class="token punctuation">{</span>
        stdout<span class="token punctuation">{</span>
        codec=&gt;rubydebug
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h6 id="检查配置文件是否可用"><a href="#检查配置文件是否可用" class="header-anchor">#</a> 检查配置文件是否可用</h6> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/logstash-6.7.0/
bin/logstash -f /kkb/install/logstash-6.7.0/config/monitor_file.conf -t
</code></pre></div><p>成功会出现一下信息：</p> <div class="language- extra-class"><pre class="language-text"><code> Config Validation Result: OK. Exiting Logstash
</code></pre></div><h6 id="启动服务"><a href="#启动服务" class="header-anchor">#</a> 启动服务</h6> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/logstash-6.7.0

bin/logstash -f /kkb/install/logstash-6.7.0/config/monitor_file.conf
</code></pre></div><h6 id="发送数据"><a href="#发送数据" class="header-anchor">#</a> 发送数据</h6> <p>新开xshell窗口通过以下命令发送数据</p> <div class="language- extra-class"><pre class="language-text"><code>mkdir -p /kkb/install/datas

echo &quot;hello logstash&quot; &gt;&gt; /kkb/install/datas/tomcat.log
</code></pre></div><h6 id="其它参数说明"><a href="#其它参数说明" class="header-anchor">#</a> 其它参数说明</h6> <div class="language-scala extra-class"><pre class="language-scala"><code>Path<span class="token keyword">=&gt;</span>表示监控的文件路径
Type<span class="token keyword">=&gt;</span>给类型打标记，用来区分不同的文件类型。
Start_postion<span class="token keyword">=&gt;</span>从哪里开始记录文件，默认是从结尾开始标记，要是你从头导入一个文件就把改成”beginning”<span class="token punctuation">.</span>
discover_interval<span class="token keyword">=&gt;</span>多久去监听path下是否有文件，默认是<span class="token number">15</span>s
exclude<span class="token keyword">=&gt;</span>排除什么文件
close_older<span class="token keyword">=&gt;</span>一个已经监听中的文件，如果超过这个值的时间内没有更新内容，就关闭监听它的文件句柄。默认是<span class="token number">3600</span>秒，即一个小时。
sincedb_path<span class="token keyword">=&gt;</span>监控库存放位置<span class="token punctuation">(</span>默认的读取文件信息记录在哪个文件中<span class="token punctuation">)</span>。默认在：<span class="token operator">/</span>data<span class="token operator">/</span>plugins<span class="token operator">/</span>inputs<span class="token operator">/</span>file。
sincedb_write_interval<span class="token keyword">=&gt;</span> logstash 每隔多久写一次 sincedb 文件，默认是 <span class="token number">15</span> 秒。
stat_interval<span class="token keyword">=&gt;</span>logstash 每隔多久检查一次被监听文件状态（是否有更新），默认是 <span class="token number">1</span> 秒。
</code></pre></div><h5 id="_1-3-3、jdbc插件"><a href="#_1-3-3、jdbc插件" class="header-anchor">#</a> 1.3.3、jdbc插件</h5> <p>jdbc插件允许我们采集某张数据库表当中的数据到我们的logstashe当中来</p> <h6 id="第一步-编写脚本"><a href="#第一步-编写脚本" class="header-anchor">#</a> 第一步：编写脚本</h6> <p>开发脚本配置文件</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/logstash-6.7.0/config

vim jdbc.conf
</code></pre></div><div class="language-scala extra-class"><pre class="language-scala"><code>input <span class="token punctuation">{</span>
  jdbc <span class="token punctuation">{</span>
    jdbc_driver_library <span class="token keyword">=&gt;</span> <span class="token string">&quot;/kkb/install/mysql-connector-java-5.1.38.jar&quot;</span>
    jdbc_driver_class <span class="token keyword">=&gt;</span> <span class="token string">&quot;com.mysql.jdbc.Driver&quot;</span>
    jdbc_connection_string <span class="token keyword">=&gt;</span> <span class="token string">&quot;jdbc:mysql://192.168.31.82:3306/mydb&quot;</span>
    jdbc_user <span class="token keyword">=&gt;</span> <span class="token string">&quot;root&quot;</span>
    jdbc_password <span class="token keyword">=&gt;</span> <span class="token string">&quot;123456&quot;</span>

    use_column_value <span class="token keyword">=&gt;</span> <span class="token boolean">true</span>
    tracking_column <span class="token keyword">=&gt;</span> <span class="token string">&quot;tno&quot;</span>
  ##  parameters <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span> <span class="token string">&quot;favorite_artist&quot;</span> <span class="token keyword">=&gt;</span> <span class="token string">&quot;Beethoven&quot;</span> <span class="token punctuation">}</span>
    schedule <span class="token keyword">=&gt;</span> <span class="token string">&quot;* * * * *&quot;</span>
    statement <span class="token keyword">=&gt;</span> <span class="token string">&quot;SELECT * from courses where tno &gt; :sql_last_value ;&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



output<span class="token punctuation">{</span>
        stdout<span class="token punctuation">{</span>
        codec<span class="token keyword">=&gt;</span>rubydebug
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h6 id="第二步-上传mysql连接驱动包到指定路劲"><a href="#第二步-上传mysql连接驱动包到指定路劲" class="header-anchor">#</a> 第二步：上传mysql连接驱动包到指定路劲</h6> <p>将我们mysql的连接驱动包上传到我们指定的/kkb/install/路径下</p> <h6 id="第三步-检查配置文件是否可用"><a href="#第三步-检查配置文件是否可用" class="header-anchor">#</a> 第三步：检查配置文件是否可用</h6> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/logstash-6.7.0/

bin/logstash -f /kkb/install/logstash-6.7.0/config/jdbc.conf -t
</code></pre></div><p>通过之后</p> <div class="language- extra-class"><pre class="language-text"><code> Config Validation Result: OK. Exiting Logstash
</code></pre></div><h6 id="第四步-启动服务"><a href="#第四步-启动服务" class="header-anchor">#</a> 第四步：启动服务</h6> <p>通过以下命令启动logstash</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/logstash-6.7.0

bin/logstash -f /kkb/install/logstash-6.7.0/config/jdbc.conf
</code></pre></div><h6 id="第五步-数据库当中添加数据"><a href="#第五步-数据库当中添加数据" class="header-anchor">#</a> 第五步：数据库当中添加数据</h6> <p>在我们的数据库当中手动随便插入数据，发现我们的logstash可以进行收集</p> <h5 id="_1-3-4-systlog插件"><a href="#_1-3-4-systlog插件" class="header-anchor">#</a> 1.3.4 systlog插件</h5> <p><strong>syslog****机制负责记录内核和应用程序产生的日志信息，管理员可以通过查看日志记录，来掌握系统状况</strong></p> <p>默认系统已经安装了rsyslog.直接启动即可</p> <h6 id="编写脚本-2"><a href="#编写脚本-2" class="header-anchor">#</a> 编写脚本</h6> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/logstash-6.7.0/config

vim syslog.conf
</code></pre></div><div class="language-scala extra-class"><pre class="language-scala"><code>input<span class="token punctuation">{</span>
    tcp<span class="token punctuation">{</span>
        port<span class="token keyword">=&gt;</span> <span class="token number">6789</span>
        <span class="token keyword">type</span><span class="token keyword">=&gt;</span> syslog
    <span class="token punctuation">}</span>
    udp<span class="token punctuation">{</span>
        port<span class="token keyword">=&gt;</span> <span class="token number">6789</span>
        <span class="token keyword">type</span><span class="token keyword">=&gt;</span> syslog
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

filter<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token keyword">type</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;syslog&quot;</span> <span class="token punctuation">{</span>
        grok <span class="token punctuation">{</span>
                <span class="token keyword">match</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span> <span class="token string">&quot;message&quot;</span> <span class="token keyword">=&gt;</span> <span class="token string">&quot;%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}(?:\[%{POSINT:syslog_pid}\])?: %{GREEDYDATA:syslog_message}&quot;</span> <span class="token punctuation">}</span>
                add_field <span class="token keyword">=&gt;</span> <span class="token punctuation">[</span> <span class="token string">&quot;received_at&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;%{@timestamp}&quot;</span> <span class="token punctuation">]</span>
                add_field <span class="token keyword">=&gt;</span> <span class="token punctuation">[</span> <span class="token string">&quot;received_from&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;%{host}&quot;</span> <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
       date <span class="token punctuation">{</span>
             <span class="token keyword">match</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">[</span> <span class="token string">&quot;syslog_timestamp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;MMM  d HH:mm:ss&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;MMM dd HH:mm:ss&quot;</span> <span class="token punctuation">]</span>
           <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

output<span class="token punctuation">{</span>
    stdout<span class="token punctuation">{</span>
        codec<span class="token keyword">=&gt;</span> rubydebug
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h6 id="检查配置文件是否可用-2"><a href="#检查配置文件是否可用-2" class="header-anchor">#</a> 检查配置文件是否可用</h6> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/logstash-6.7.0

bin/logstash -f /kkb/install/logstash-6.7.0/config/syslog.conf -t
</code></pre></div><h6 id="启动服务-2"><a href="#启动服务-2" class="header-anchor">#</a> 启动服务</h6> <p>执行以下命令启动logstash服务</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/logstash-6.7.0

bin/logstash -f /kkb/install/logstash-6.7.0/config/syslog.conf
</code></pre></div><h6 id="发送数据-2"><a href="#发送数据-2" class="header-anchor">#</a> 发送数据</h6> <p>修改系统日志配置文件</p> <div class="language- extra-class"><pre class="language-text"><code>sudo vim /etc/rsyslog.conf
</code></pre></div><p>添加一行以下配置</p> <div class="language-sh extra-class"><pre class="language-sh"><code>*.* @@node01:6789
</code></pre></div><p><img src="/assets/img/image-20200519013251939.76fb56b6.png" alt="image-20200519013251939"></p> <p>重启系统日志服务</p> <div class="language- extra-class"><pre class="language-text"><code>sudo systemctl restart rsyslog
</code></pre></div><h6 id="其它参数说明-2"><a href="#其它参数说明-2" class="header-anchor">#</a> 其它参数说明</h6> <p>在logstash中的grok是正则表达式，用来解析当前数据</p> <p>原始数据其实是：</p> <div class="language-scala extra-class"><pre class="language-scala"><code>Dec <span class="token number">23</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">43</span> louis postfix<span class="token operator">/</span>smtpd<span class="token punctuation">[</span><span class="token number">31499</span><span class="token punctuation">]</span><span class="token operator">:</span> connect from unknown<span class="token punctuation">[</span><span class="token number">95.75</span><span class="token number">.93</span><span class="token number">.154</span><span class="token punctuation">]</span>
Jun <span class="token number">05</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> louis named<span class="token punctuation">[</span><span class="token number">16000</span><span class="token punctuation">]</span><span class="token operator">:</span> client <span class="token number">199.48</span><span class="token number">.164</span><span class="token number">.7</span>#<span class="token number">64817</span><span class="token operator">:</span> query <span class="token punctuation">(</span>cache<span class="token punctuation">)</span> <span class="token string">'amsterdamboothuren.com/MX/IN'</span> denied
Jun <span class="token number">05</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">00</span> louis CRON<span class="token punctuation">[</span><span class="token number">620</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">(</span>www<span class="token operator">-</span>data<span class="token punctuation">)</span> CMD <span class="token punctuation">(</span>php <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>cacti<span class="token operator">/</span>site<span class="token operator">/</span>poller<span class="token punctuation">.</span>php <span class="token operator">&gt;</span><span class="token operator">/</span>dev<span class="token operator">/</span><span class="token keyword">null</span> <span class="token number">2</span><span class="token operator">&gt;</span><span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>cacti<span class="token operator">/</span>poller<span class="token operator">-</span>error<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
Jun <span class="token number">05</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">06</span> louis rsyslogd<span class="token operator">:</span> <span class="token punctuation">[</span>origin software<span class="token operator">=</span><span class="token string">&quot;rsyslogd&quot;</span> swVersion<span class="token operator">=</span><span class="token string">&quot;4.2.0&quot;</span> x<span class="token operator">-</span>pid<span class="token operator">=</span><span class="token string">&quot;2253&quot;</span> x<span class="token operator">-</span>info<span class="token operator">=</span><span class="token string">&quot;http://www.rsyslog.com&quot;</span><span class="token punctuation">]</span> rsyslogd was HUPed<span class="token punctuation">,</span> <span class="token keyword">type</span> <span class="token string">'lightweight'</span><span class="token punctuation">.</span>
</code></pre></div><h4 id="_1-4、filter插件"><a href="#_1-4、filter插件" class="header-anchor">#</a> 1.4、filter插件</h4> <p>Logstash之所以强悍的主要原因是filter插件；通过过滤器的各种组合可以得到我们想要的结构化数据。</p> <p>1、grok正则表达式</p> <p>grok正则表达式是logstash非常重要的一个环节；可以通过grok非常方便的将数据拆分和索引</p> <p>语法格式：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">(</span>?<span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>pattern<span class="token punctuation">)</span>  

？<span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>表示要取出里面的值，pattern就是正则表达式 
</code></pre></div><h5 id="_1、收集控制台输入数据-采集日期时间出来"><a href="#_1、收集控制台输入数据-采集日期时间出来" class="header-anchor">#</a> 1、收集控制台输入数据，采集日期时间出来</h5> <h6 id="第一步-开发配置文件"><a href="#第一步-开发配置文件" class="header-anchor">#</a> 第一步：开发配置文件</h6> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/logstash-6.7.0/config/

vim filter.conf
</code></pre></div><div class="language-scala extra-class"><pre class="language-scala"><code>input <span class="token punctuation">{</span>stdin<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span> filter <span class="token punctuation">{</span>
        grok <span class="token punctuation">{</span>
                <span class="token keyword">match</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
<span class="token string">&quot;message&quot;</span> <span class="token keyword">=&gt;</span> <span class="token string">&quot;(?&lt;date&gt;\d+\.\d+)\s+&quot;</span>
                <span class="token punctuation">}</span>       
        <span class="token punctuation">}</span>       
<span class="token punctuation">}</span>       
output <span class="token punctuation">{</span>stdout<span class="token punctuation">{</span>codec <span class="token keyword">=&gt;</span> rubydebug<span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><h6 id="第二步-启动logstash服务"><a href="#第二步-启动logstash服务" class="header-anchor">#</a> 第二步：启动logstash服务</h6> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/logstash-6.7.0/

bin/logstash -f /kkb/install/logstash-6.7.0/config/filter.conf
</code></pre></div><h6 id="第三步-控制台输入文字"><a href="#第三步-控制台输入文字" class="header-anchor">#</a> 第三步：控制台输入文字</h6> <p>5.20 今天天气还不错</p> <p><img src="/assets/img/image-20200519013431525.8c7ee17c.png" alt="image-20200519013431525"></p> <h5 id="_2、使用grok收集nginx日志数据"><a href="#_2、使用grok收集nginx日志数据" class="header-anchor">#</a> 2、使用grok收集nginx日志数据</h5> <p>nginx一般打印出来的日志格式如下</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token number">36.157</span><span class="token number">.150</span><span class="token number">.1</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">05</span><span class="token operator">/</span>Nov<span class="token operator">/</span><span class="token number">2018</span><span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">:</span><span class="token number">59</span><span class="token punctuation">:</span><span class="token number">28</span> <span class="token operator">+</span><span class="token number">0800</span><span class="token punctuation">]</span> <span class="token string">&quot;GET /phpmyadmin_8c1019c9c0de7a0f/js/get_scripts.js.php?scripts%5B%5D=jquery/jquery-1.11.1.min.js&amp;scripts%5B%5D=sprintf.js&amp;scripts%5B%5D=ajax.js&amp;scripts%5B%5D=keyhandler.js&amp;scripts%5B%5D=jquery/jquery-ui-1.11.2.min.js&amp;scripts%5B%5D=jquery/jquery.cookie.js&amp;scripts%5B%5D=jquery/jquery.mousewheel.js&amp;scripts%5B%5D=jquery/jquery.event.drag-2.2.js&amp;scripts%5B%5D=jquery/jquery-ui-timepicker-addon.js&amp;scripts%5B%5D=jquery/jquery.ba-hashchange-1.3.js HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">139613</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36&quot;</span>
</code></pre></div><p>这种日志是非格式化的，通常，我们获取到日志后，还要使用mapreduce 或者spark 做一下清洗操作，</p> <p>就是将非格式化日志编程格式化日志；</p> <p>在清洗的时候，如果日志的数据量比较大，那么也是需要花费一定的时间的；</p> <p>所以可以使用logstash 的grok 功能，将nginx 的非格式化数据采集成格式化数据：</p> <h6 id="第一步-安装grok插件"><a href="#第一步-安装grok插件" class="header-anchor">#</a> 第一步：安装grok插件</h6> <p>####### 第一种方式安装：在线安装（墙裂不推荐）</p> <p>在线安装grok插件</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/logstash-6.7.0/

vim Gemfile
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>#source 'https://rubygems.org'    ## 将这个镜像源注释掉
source https://gems.ruby-china.com/  ## 配置成中国的这个镜像源
</code></pre></div><p>准备在线安装</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/logstash-6.7.0/

bin/logstash-plugin install logstash-filter-grok 
</code></pre></div><p>####### 第二种安装方式，直接使用我已经下载好的安装包进行本地安装（墙裂推荐使用）</p> <p>上传我们的压缩包logstash-filter-grok-4.0.4.zip上传到/kkb/install/logstash-6.7.0 这个路径下面</p> <p>然后准备执行本地安装</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/logstash-6.7.0/
bin/logstash-plugin <span class="token function">install</span> file:///kkb/install/logstash-6.7.0/logstash-filter-grok-4.0.4.zip
</code></pre></div><p>安装成功之后查看logstash的插件列表</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/logstash-6.7.0/

bin/logstash-plugin list
</code></pre></div><h6 id="第二步-开发logstash的配置文件"><a href="#第二步-开发logstash的配置文件" class="header-anchor">#</a> 第二步：开发logstash的配置文件</h6> <p>定义logstash的配置文件如下，我们从控制台输入nginx的日志数据，然后经过filter的过滤，将我们的日志文件转换成为标准的数据格式</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/logstash-6.7.0/config

vim monitor_nginx.conf
</code></pre></div><div class="language-scala extra-class"><pre class="language-scala"><code>input <span class="token punctuation">{</span>stdin<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
filter <span class="token punctuation">{</span>
grok <span class="token punctuation">{</span>
<span class="token keyword">match</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
<span class="token string">&quot;message&quot;</span> <span class="token keyword">=&gt;</span> <span class="token string">&quot;%{IPORHOST:clientip} \- \- \[%{HTTPDATE:time_local}\] \&quot;(?:%{WORD:method} %{NOTSPACE:request}(?:HTTP/%{NUMBER:httpversion})?|%{DATA:rawrequest})\&quot; %{NUMBER:status} %{NUMBER:body_bytes_sent} %{QS:http_referer} %{QS:agent}&quot;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
output <span class="token punctuation">{</span>stdout<span class="token punctuation">{</span>codec <span class="token keyword">=&gt;</span> rubydebug<span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><h6 id="第三步-启动logstash"><a href="#第三步-启动logstash" class="header-anchor">#</a> 第三步：启动logstash</h6> <p>执行以下命令启动logstash</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/logstash-6.7.0

bin/logstash -f /kkb/install/logstash-6.7.0/config/monitor_nginx.conf
</code></pre></div><h6 id="第四步-从控制台输入nginx日志文件数据"><a href="#第四步-从控制台输入nginx日志文件数据" class="header-anchor">#</a> 第四步：从控制台输入nginx日志文件数据</h6> <p>输入第一条数据</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token number">36.157</span><span class="token number">.150</span><span class="token number">.1</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">05</span><span class="token operator">/</span>Nov<span class="token operator">/</span><span class="token number">2018</span><span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">:</span><span class="token number">59</span><span class="token punctuation">:</span><span class="token number">27</span> <span class="token operator">+</span><span class="token number">0800</span><span class="token punctuation">]</span> <span class="token string">&quot;GET /phpmyadmin_8c1019c9c0de7a0f/js/messages.php?lang=zh_CN&amp;db=&amp;collation_connection=utf8_unicode_ci&amp;token=6a44d72481633c90bffcfd42f11e25a1 HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">8131</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36&quot;</span>
</code></pre></div><p>输入第二条数据</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token number">36.157</span><span class="token number">.150</span><span class="token number">.1</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">05</span><span class="token operator">/</span>Nov<span class="token operator">/</span><span class="token number">2018</span><span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">:</span><span class="token number">59</span><span class="token punctuation">:</span><span class="token number">28</span> <span class="token operator">+</span><span class="token number">0800</span><span class="token punctuation">]</span> <span class="token string">&quot;GET /phpmyadmin_8c1019c9c0de7a0f/js/get_scripts.js.php?scripts%5B%5D=jquery/jquery-1.11.1.min.js&amp;scripts%5B%5D=sprintf.js&amp;scripts%5B%5D=ajax.js&amp;scripts%5B%5D=keyhandler.js&amp;scripts%5B%5D=jquery/jquery-ui-1.11.2.min.js&amp;scripts%5B%5D=jquery/jquery.cookie.js&amp;scripts%5B%5D=jquery/jquery.mousewheel.js&amp;scripts%5B%5D=jquery/jquery.event.drag-2.2.js&amp;scripts%5B%5D=jquery/jquery-ui-timepicker-addon.js&amp;scripts%5B%5D=jquery/jquery.ba-hashchange-1.3.js HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">139613</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36&quot;</span>
</code></pre></div><h4 id="_1-5、-output插件"><a href="#_1-5、-output插件" class="header-anchor">#</a> 1.5、 Output插件</h4> <h5 id="_1-4-1-标准输出到控制台"><a href="#_1-4-1-标准输出到控制台" class="header-anchor">#</a> 1.4.1 标准输出到控制台</h5> <p>将我们收集的数据直接打印到控制台</p> <div class="language-scala extra-class"><pre class="language-scala"><code>output <span class="token punctuation">{</span>
    stdout <span class="token punctuation">{</span>
        codec <span class="token keyword">=&gt;</span> rubydebug
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>bin/logstash -e <span class="token string">'input{stdin{}}output{stdout{codec=&gt;rubydebug}}'</span>
<span class="token punctuation">[</span>es@node01 logstash<span class="token punctuation">]</span>$ bin/logstash -e <span class="token string">'input{stdin{}}output{stdout{codec=&gt;rubydebug}}'</span>
hello
</code></pre></div><h5 id="_1-4-2-将采集数据保存到file文件中"><a href="#_1-4-2-将采集数据保存到file文件中" class="header-anchor">#</a> 1.4.2 将采集数据保存到file文件中</h5> <p>logstash也可以将收集到的数据写入到文件当中去永久保存，接下来我们来看看logstash如何配置以实现将数据写入到文件当中</p> <h6 id="第一步-开发logstash的配置文件"><a href="#第一步-开发logstash的配置文件" class="header-anchor">#</a> 第一步：开发logstash的配置文件</h6> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/logstash-6.7.0/config
<span class="token function">vim</span> output_file.conf
</code></pre></div><div class="language-scala extra-class"><pre class="language-scala"><code>input <span class="token punctuation">{</span>stdin<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
output <span class="token punctuation">{</span>
    file <span class="token punctuation">{</span>
        path <span class="token keyword">=&gt;</span> <span class="token string">&quot;/kkb/install/datas/%{+YYYY-MM-dd}-%{host}.txt&quot;</span>
        codec <span class="token keyword">=&gt;</span> line <span class="token punctuation">{</span>
            format <span class="token keyword">=&gt;</span> <span class="token string">&quot;%{message}&quot;</span>
        <span class="token punctuation">}</span>
        flush_interval <span class="token keyword">=&gt;</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h6 id="第二步-检测配置文件并启动logstash服务"><a href="#第二步-检测配置文件并启动logstash服务" class="header-anchor">#</a> 第二步：检测配置文件并启动logstash服务</h6> <p><code>cd /kkb/install/logstash-6.7.0</code></p> <p>检测配置文件是否正确</p> <p><code>bin/logstash -f config/output_file.conf -t</code></p> <p>启动服务，然后从控制台输入一些数据</p> <p><code>bin/logstash -f config/output_file.conf</code></p> <p>查看文件写入的内容</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/datas	

more 2018-11-08-node01.hadoop.com.txt
</code></pre></div><p><img src="/assets/img/image-20200519014141486.33991fe3.png" alt="image-20200519014141486"></p> <h5 id="_1-4-3-将采集数据保存到elasticsearch"><a href="#_1-4-3-将采集数据保存到elasticsearch" class="header-anchor">#</a> 1.4.3 将采集数据保存到elasticsearch</h5> <h6 id="第一步-开发logstash的配置文件-2"><a href="#第一步-开发logstash的配置文件-2" class="header-anchor">#</a> 第一步：开发logstash的配置文件</h6> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb/install/logstash-6.7.0/config
<span class="token function">vim</span> output_es.conf
</code></pre></div><div class="language-scala extra-class"><pre class="language-scala"><code>input <span class="token punctuation">{</span>stdin<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
output <span class="token punctuation">{</span>
    elasticsearch <span class="token punctuation">{</span>
        hosts <span class="token keyword">=&gt;</span> <span class="token punctuation">[</span><span class="token string">&quot;node01:9200&quot;</span><span class="token punctuation">]</span>
        index <span class="token keyword">=&gt;</span> <span class="token string">&quot;logstash-%{+YYYY.MM.dd}&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个index是保存到elasticsearch上的索引名称，如何命名特别重要，因为我们很可能后续根据某些需求做查询，所以最好带时间，因为我们在中间加上type，就代表不同的业务，这样我们在查询当天数据的时候，就可以根据类型+时间做范围查询</p> <h6 id="第二步-检测配置文件并启动logstash"><a href="#第二步-检测配置文件并启动logstash" class="header-anchor">#</a> 第二步：检测配置文件并启动logstash</h6> <p>检测配置文件是否正确</p> <div class="language- extra-class"><pre class="language-text"><code>cd /kkb/install/logstash-6.7.0

bin/logstash -f config/output_es.conf -t 
</code></pre></div><p>启动logstash</p> <div class="language- extra-class"><pre class="language-text"><code>bin/logstash -f config/output_es.conf
</code></pre></div><h6 id="第三步-es当中查看数据"><a href="#第三步-es当中查看数据" class="header-anchor">#</a> 第三步：es当中查看数据</h6> <p>访问</p> <p>http://node01:9100/</p> <p>查看es当中的数据</p> <p><img src="/assets/img/image-20200519014246460.fa049755.png" alt="image-20200519014246460"></p> <p>注意：</p> <p>更多的input，filter，output组件参见以下链接</p> <p>https://www.elastic.co/guide/en/logstash/current/index.html</p> <h2 id="kibana报表展示"><a href="#kibana报表展示" class="header-anchor">#</a> kibana报表展示</h2> <p>官网对于kibana的基本简介</p> <p>https://www.elastic.co/guide/cn/kibana/current/index.html</p> <p>kibana是一个强大的报表展示工具，可以通过kibana自定义我们的数据报表展示，实现我们的数据的各种图表查看</p> <p>我们可以通过官网提供的数据集来实现我们的数据的报表展示</p> <h3 id="第一步-下载数据集"><a href="#第一步-下载数据集" class="header-anchor">#</a> 第一步：下载数据集</h3> <p>下载账户数据集</p> <p>https://download.elastic.co/demos/kibana/gettingstarted/accounts.zip</p> <p>下载日志数据集</p> <p>https://download.elastic.co/demos/kibana/gettingstarted/logs.jsonl.gz</p> <h3 id="第二步-上传我们的数据集并解压"><a href="#第二步-上传我们的数据集并解压" class="header-anchor">#</a> 第二步：上传我们的数据集并解压</h3> <p>将我们以上下载的数据集全部上传到node01服务器的/kkb路径下</p> <h3 id="第三步-创建对应的索引库"><a href="#第三步-创建对应的索引库" class="header-anchor">#</a> 第三步：创建对应的索引库</h3> <p>创建我们的索引库，然后加载数据</p> <h4 id="第一个索引库-日志数据集数据索引库"><a href="#第一个索引库-日志数据集数据索引库" class="header-anchor">#</a> 第一个索引库：日志数据集数据索引库</h4> <p>创建第一个索引库，将我们第一个索引库日志数据也创建好</p> <p>我们这里实际上按照日期，创建了三个索引库，都是用于加载我们的日志数据</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT /logstash<span class="token number">-2015.05</span>.<span class="token number">18</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;log&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;geo&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;coordinates&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;geo_point&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
PUT /logstash<span class="token number">-2015.05</span>.<span class="token number">19</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;log&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;geo&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;coordinates&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;geo_point&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
PUT /logstash<span class="token number">-2015.05</span>.<span class="token number">20</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;log&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;geo&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;coordinates&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;geo_point&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="第四步-加载示例数据到我们的索引库当中来"><a href="#第四步-加载示例数据到我们的索引库当中来" class="header-anchor">#</a> 第四步：加载示例数据到我们的索引库当中来</h3> <p>直接在node01的/kkb路径下执行以下命令来加载我们的示例数据到索引库当中来</p> <p>node01机器上面执行以下命令</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /kkb
<span class="token function">curl</span> -H <span class="token string">'Content-Type: application/x-ndjson'</span> -XPOST <span class="token string">'node01:9200/bank/account/_bulk?pretty'</span> --data-binary @accounts.json
<span class="token function">curl</span> -H <span class="token string">'Content-Type: application/x-ndjson'</span> -XPOST <span class="token string">'node01:9200/_bulk?pretty'</span> --data-binary @logs.json
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MaLunan/press/edit/dev-mln/docs/elk/elk.md" target="_blank" rel="noopener noreferrer">在GitHub 上编辑此页！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">1/19/2021, 1:41:59 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fdd7a502.js" defer></script><script src="/assets/js/16.375b747e.js" defer></script><script src="/assets/js/25.c9fcaa62.js" defer></script>
  </body>
</html>
